<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fitness Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for the Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            transition: all 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        .view-container {
            min-height: calc(100vh - 4rem); /* Ensure full height on mobile */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <!-- Dynamic Message Box (for alerts/confirmations) -->
        <div id="message-box" class="fixed top-4 right-4 z-50 p-4 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-lg shadow-xl font-medium hidden transition-opacity duration-300 ease-in-out opacity-0">
            <p id="message-text"></p>
        </div>
        
        <!-- --- 1. DASHBOARD VIEW (MAIN) --- -->
        <div id="view-dashboard" class="view-container space-y-8">
             <header class="bg-white p-6 rounded-2xl shadow-xl transition-all hover:shadow-2xl">
                <h1 class="text-4xl font-black text-gray-900 mb-2">Fitness Dashboard</h1>
                <div class="md:flex md:space-x-8">
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">User:</span> <span id="user-name">Alex Johnson</span>
                    </p>
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">Goal:</span> <span id="user-goal">Build Strength & Endurance</span>
                    </p>
                </div>
            </header>

            <!-- Action Buttons / Navigation -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                
                <button onclick="showView('gym-config')" class="bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.02]">
                    üèãÔ∏è Configure Gym
                    <p id="current-gym-status" class="mt-1 text-sm opacity-80 italic"></p>
                </button>
                
                <button onclick="showView('plan-workout')" class="bg-green-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-[1.02]">
                    üí™ Plan Workout
                </button>
                
                <button onclick="showView('meal-log')" class="bg-yellow-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.02]">
                    ü•ó Log Meal
                </button>
                
                <button id="view-history-btn" class="bg-gray-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02]">
                    üìä View History
                </button>
            </div>
        </div>

        <!-- --- 2. GYM CONFIGURATION VIEW --- -->
        <div id="view-gym-config" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-indigo-700">‚öôÔ∏è Gym Setup Configuration</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="gym-setup-form" class="space-y-6">
                <div class="space-y-2">
                    <label for="gym-name" class="block text-sm font-medium text-gray-700">Gym Profile Name</label>
                    <input type="text" id="gym-name" value="My Home Gym" required
                           class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Weights -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Weights</h3>
                        <div id="weights-options" class="space-y-1 text-sm"></div>
                    </div>
                    <!-- Cardio -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Cardio</h3>
                        <div id="cardio-options" class="space-y-1 text-sm"></div>
                    </div>
                    <!-- Floor Space -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Floor Space</h3>
                        <div id="floor-options" class="space-y-1 text-sm"></div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg">
                    Save Gym Equipment
                </button>
            </form>
        </div>
        
        <!-- --- 3. MEAL LOG VIEW --- -->
        <div id="view-meal-log" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-yellow-600">ü•ó Log a Meal</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="add-meal-form" class="space-y-4">
                <input type="text" placeholder="Meal Name (e.g., Chicken & Rice)" required
                       class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500">
                <textarea placeholder="Nutritional Details / Ingredients" rows="4"
                          class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                <button type="submit" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 shadow-lg">
                    Log Meal
                </button>
            </form>
        </div>
        
        <!-- --- 4. WORKOUT PLANNING VIEW --- -->
        <div id="view-plan-workout" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-green-600">üí™ Select Training Focus</h2>
                <div class="space-x-2">
                    <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200">
                        &larr; Return to Dashboard
                    </button>
                </div>
            </div>
            
            <form id="workout-planning-form" class="space-y-4">
                <div>
                    <label for="workout-focus" class="block text-sm font-medium text-gray-700">What are you training?</label>
                    <select id="workout-focus"
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <!-- Options added by JS -->
                    </select>
                </div>

                <!-- Checkboxes: Specific Muscles (Hidden by default) -->
                <div id="muscle-checkboxes" class="hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Select Target Muscles:</p>
                    <div id="muscle-options" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <button type="submit" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                    Start Workout &rarr;
                </button>
            </form>
        </div>

        <!-- --- 5. ACTIVE WORKOUT TRACKING VIEW --- -->
        <div id="view-track-workout" class="view-container p-6 bg-white rounded-2xl shadow-2xl border-2 border-green-500 space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-extrabold text-green-700">Active Workout: <span id="active-workout-title"></span></h2>
                <div class="space-x-2">
                    <button id="open-equipment-modal-btn" class="text-sm py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">
                        üõ†Ô∏è Equipment
                    </button>
                    <button onclick="saveWorkout(); showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200">
                        &larr; Finish & Dashboard
                    </button>
                </div>
            </div>
            
            <form id="add-exercise-form" class="space-y-4 p-4 bg-green-50 rounded-xl">
                <h3 class="text-xl font-bold text-green-800">Add Exercise</h3>
                
                <!-- Exercise Dropdown -->
                <div>
                    <label for="exercise-select" class="block text-sm font-medium text-gray-700">Choose Exercise (Filtered by Equipment & Focus)</label>
                    <select id="exercise-select" required
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <option value="">-- Select an Exercise --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <!-- Sets Input -->
                    <div>
                        <label for="sets-input" class="block text-sm font-medium text-gray-700">Sets</label>
                        <input type="number" id="sets-input" value="3" min="1" max="10" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                    <!-- Reps Input (Initial/Target) -->
                    <div>
                        <label for="target-reps-input" class="block text-sm font-medium text-gray-700">Target Reps</label>
                        <input type="number" id="target-reps-input" value="10" min="1" max="50" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <button type="button" id="start-sets-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                    Configure Sets
                </button>
            </form>

            <!-- Dynamic Sets and Reps Tracking -->
            <div id="sets-tracking-container" class="space-y-6">
                <!-- Sets will be rendered here -->
            </div>
            
            <!-- Summary of Logged Exercises -->
            <div id="logged-exercises-summary" class="mt-8 space-y-4">
                <h3 class="text-xl font-bold text-green-800 border-t pt-4">Logged Exercises</h3>
                <!-- List of finished exercises in the current session -->
            </div>
            
            <button id="finish-workout-btn" class="mt-8 w-full py-4 bg-indigo-600 text-white font-extrabold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-2xl">
                Finish & Save Workout
            </button>
        </div>

        <!-- --- MODALS --- -->

        <!-- Exercise History Modal -->
        <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700">Exercise History (Best Lifts)</h2>
                    <button id="close-history-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
                </div>
                <div id="history-content" class="p-6 overflow-y-auto custom-scroll space-y-4 flex-grow">
                    <p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>
                </div>
            </div>
        </div>
        
        <!-- Equipment Adjustment Modal (Mid-Workout) -->
        <div id="equipment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-blue-100">
                    <h2 class="text-2xl font-bold text-blue-700">Adjust Available Equipment</h2>
                    <button id="close-equipment-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto custom-scroll flex-grow">
                    <form id="active-gym-setup-form" class="space-y-6">
                        <p class="text-gray-600 mb-4">Temporarily adjust what equipment is available right now. This will update your exercise selection.</p>
                        <div class="grid md:grid-cols-3 gap-6">
                            <!-- Weights -->
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2">Weights</h3>
                                <div id="active-weights-options" class="space-y-1 text-sm"></div>
                            </div>
                            <!-- Cardio -->
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2">Cardio</h3>
                                <div id="active-cardio-options" class="space-y-1 text-sm"></div>
                            </div>
                            <!-- Floor Space -->
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2">Floor Space</h3>
                                <div id="active-floor-options" class="space-y-1 text-sm"></div>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-150 shadow-lg">
                            Apply Changes & Close
                        </button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE AND DATA ---
        let state = {
            currentView: 'dashboard',
            userName: "Alex Johnson",
            goal: "Build Strength & Endurance",
            gymName: "My Home Gym",
            gymSetup: { weights: ["dumbbell", "bench", "barbell"], cardio: ["treadmill"], floor: ["TRX"] }, // Initialize with some equipment
            exerciseHistory: {},
            currentWorkout: null,
            workoutLog: [],
            previousView: 'dashboard', // For "Back" button functionality
        };

        const EQUIPMENT_MAP = {
            weights: ["bench", "barbell", "dumbbell", "pinstack machines", "weighted machines", "cables"],
            cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
            floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball"],
        };

        const FOCUS_OPTIONS = [
            "Full Body", "Upper Body", "Lower Body", "Press", "Pull", "Squat", "Hinge", "Specific Muscles"
        ];
        
        const MUSCLE_GROUPS = [
            "biceps", "triceps", "shoulders", "quads", "hamstrings", "abs", "chest", "lats", "upper back", "glutes", "calves"
        ];
        
        // --- EXPANDED EXERCISE LIBRARY (Truncated for brevity, but includes the comprehensive list from previous turn) ---
        const EXERCISE_LIBRARY = [
            // --- FULL BODY FOCUS ---
            { name: "Barbell Clean & Press", equipment: ["barbell"], focus: ["Full Body", "Press", "shoulders", "quads", "glutes"] },
            { name: "Dumbbell Thrusters", equipment: ["dumbbell"], focus: ["Full Body", "Squat", "Press", "shoulders", "quads"] },
            { name: "Sandbag Get-Ups", equipment: ["sandbag", "floor"], focus: ["Full Body", "abs", "shoulders"] },
            { name: "Medicine Ball Slams", equipment: ["medicine ball", "floor", "slam ball"], focus: ["Full Body", "abs"] },

            // --- UPPER BODY / PRESS FOCUS ---
            { name: "Barbell Bench Press", equipment: ["bench", "barbell"], focus: ["Upper Body", "Press", "chest", "triceps", "shoulders"] },
            { name: "Dumbbell Overhead Press", equipment: ["dumbbell"], focus: ["Upper Body", "Press", "shoulders", "triceps"] },
            { name: "Machine Chest Press", equipment: ["weighted machines", "pinstack machines"], focus: ["Upper Body", "Press", "chest", "triceps"] },
            { name: "Cable Crossover (High)", equipment: ["cables"], focus: ["Upper Body", "Press", "chest"] },
            { name: "Dumbbell Incline Press", equipment: ["bench", "dumbbell"], focus: ["Upper Body", "Press", "chest", "shoulders"] },
            { name: "Pinstack Shoulder Press", equipment: ["pinstack machines"], focus: ["Press", "shoulders", "triceps"] },

            // --- UPPER BODY / PULL FOCUS ---
            { name: "Barbell Bent-Over Row", equipment: ["barbell"], focus: ["Upper Body", "Pull", "lats", "upper back", "biceps"] },
            { name: "Dumbbell Single-Arm Row", equipment: ["dumbbell", "bench"], focus: ["Upper Body", "Pull", "lats", "upper back"] },
            { name: "Cable Face Pulls", equipment: ["cables"], focus: ["Upper Body", "Pull", "upper back", "shoulders"] },
            { name: "Lat Pulldown (Machine)", equipment: ["pinstack machines"], focus: ["Upper Body", "Pull", "lats", "biceps"] },
            { name: "TRX Inverted Row", equipment: ["TRX", "floor"], focus: ["Upper Body", "Pull", "upper back", "biceps"] },
            { name: "Seated Cable Row", equipment: ["cables"], focus: ["Pull", "upper back", "lats", "biceps"] },

            // --- LOWER BODY / SQUAT FOCUS ---
            { name: "Barbell Back Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes", "hamstrings", "calves"] },
            { name: "Dumbbell Goblet Squat", equipment: ["dumbbell", "floor"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Leg Extension (Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Squat", "quads"] },
            { name: "Leg Press (Machine)", equipment: ["weighted machines"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Dumbbell Bulgarian Split Squat", equipment: ["dumbbell", "bench"], focus: ["Lower Body", "Squat", "quads", "glutes"] },

            // --- LOWER BODY / HINGE FOCUS ---
            { name: "Barbell Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes", "Full Body", "lats"] },
            { name: "Dumbbell Romanian Deadlift", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
            { name: "Cable Pull-Through", equipment: ["cables"], focus: ["Lower Body", "Hinge", "glutes", "hamstrings"] },
            { name: "Leg Curl (Machine)", equipment: ["pinstack machines", "weighted machines"], focus: ["Lower Body", "Hinge", "hamstrings"] },
            { name: "Glute-Ham Raise (Floor)", equipment: ["floor"], focus: ["Hinge", "hamstrings", "glutes"] },

            // --- SPECIFIC MUSCLES ---
            { name: "Dumbbell Hammer Curl", equipment: ["dumbbell"], focus: ["biceps"] },
            { name: "Barbell Bicep Curl", equipment: ["barbell"], focus: ["biceps"] },
            { name: "Cable Rope Tricep Pushdown", equipment: ["cables"], focus: ["triceps"] },
            { name: "Dumbbell Skullcrushers", equipment: ["dumbbell", "bench"], focus: ["triceps"] },
            { name: "Dumbbell Lateral Raise", equipment: ["dumbbell"], focus: ["shoulders"] },
            { name: "Cable Rear Delt Fly", equipment: ["cables"], focus: ["shoulders", "upper back"] },
            { name: "Machine Hip Abduction", equipment: ["weighted machines"], focus: ["glutes"] },
            { name: "Hanging Leg Raise", equipment: ["floor"], focus: ["abs"] },
            { name: "Weighted Machine Crunch", equipment: ["weighted machines"], focus: ["abs"] },
            { name: "Dumbbell Calf Raise", equipment: ["dumbbell"], focus: ["calves"] },
            { name: "Hyperextension (Floor)", equipment: ["floor"], focus: ["hamstrings", "glutes"] },

            // --- CARDIO FOCUS ---
            { name: "Treadmill 5K Run", equipment: ["treadmill"], focus: ["Cardio", "Full Body"] },
            { name: "Rower 2000m Sprint", equipment: ["rower"], focus: ["Cardio", "Full Body"] },
            { name: "Assault Bike Interval", equipment: ["assault bike"], focus: ["Cardio", "Full Body"] },
            { name: "Cross Trainer Endurance", equipment: ["cross trainer"], focus: ["Cardio", "Full Body"] },
            { name: "Ski Erg 10 Minute Challenge", equipment: ["ski erg"], focus: ["Cardio", "Full Body", "Upper Body", "Pull"] },
            { name: "Step Machine Climb", equipment: ["step machine"], focus: ["Cardio", "Lower Body"] },
        ];
        // --- END EXERCISE LIBRARY ---


        // --- DOM ELEMENTS (Global) ---
        const views = ['dashboard', 'gym-config', 'meal-log', 'plan-workout', 'track-workout'];
        const viewElements = views.reduce((acc, id) => {
            acc[id] = document.getElementById(`view-${id}`);
            return acc;
        }, {});
        
        const gymSetupForm = document.getElementById('gym-setup-form');
        const currentGymStatus = document.getElementById('current-gym-status');
        
        const workoutPlanningForm = document.getElementById('workout-planning-form');
        const workoutFocusSelect = document.getElementById('workout-focus');
        const muscleCheckboxesDiv = document.getElementById('muscle-checkboxes');
        const muscleOptionsDiv = document.getElementById('muscle-options');
        
        const activeWorkoutTitle = document.getElementById('active-workout-title');
        const exerciseSelect = document.getElementById('exercise-select');
        const setsInput = document.getElementById('sets-input');
        const targetRepsInput = document.getElementById('target-reps-input');
        const setsTrackingContainer = document.getElementById('sets-tracking-container');
        const loggedExercisesSummary = document.getElementById('logged-exercises-summary');
        
        const historyModal = document.getElementById('history-modal');
        const historyContent = document.getElementById('history-content');
        
        const equipmentModal = document.getElementById('equipment-modal');
        const activeGymSetupForm = document.getElementById('active-gym-setup-form');
        
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');


        // --- UTILITY & NAVIGATION FUNCTIONS ---
        
        /** Manages the visibility of the application views. */
        function showView(viewName, updateHistory = true) {
            // Guard clause if user tries to navigate away from an active, unsaved exercise
            if (state.currentWorkout && state.currentWorkout.currentExercise && viewName !== 'track-workout') {
                if (!confirmExit()) return;
            }
            
            // Set the previous view only if not navigating between track/plan view
            if (updateHistory && state.currentView !== viewName) {
                state.previousView = state.currentView;
            }

            views.forEach(id => {
                viewElements[id].classList.add('hidden');
                viewElements[id].classList.remove('flex'); // Remove flex utility for consistency
            });

            if (viewElements[viewName]) {
                viewElements[viewName].classList.remove('hidden');
                // Use block or flex depending on the view layout needs
                viewElements[viewName].classList.add('block'); 
                state.currentView = viewName;
            }
            
            // Special setup needed when entering certain views
            if (viewName === 'gym-config') {
                renderGymSetupCheckboxes(document.getElementById('weights-options'), document.getElementById('cardio-options'), document.getElementById('floor-options'));
                // Pre-populate values for the gym config name
                document.getElementById('gym-name').value = state.gymName;
            } else if (viewName === 'plan-workout') {
                // Ensure exercises are rendered based on current focus
                renderExerciseDropdown();
            } else if (viewName === 'track-workout') {
                // Pre-populate equipment modal with current state
                renderActiveEquipmentModal();
                updateLoggedExercisesSummary();
            }

            updateDashboardStatus();
        }

        /** Prompts user if they try to exit an active exercise without saving. */
        function confirmExit() {
             // Since alert/confirm are forbidden, we rely on the internal message box and state logic.
             // For this application, we'll temporarily allow navigation and clear the exercise if not saved.
             // In a real app, a modal confirmation would be required.
             state.currentWorkout.currentExercise = null;
             return true;
        }

        /** Shows a temporary message in the custom box. */
        function showMessage(message, type = 'success', duration = 3000) {
            let bgColor, borderColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-500';
                textColor = 'text-green-800';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-500';
                textColor = 'text-red-800';
            } else if (type === 'info') {
                bgColor = 'bg-blue-100';
                borderColor = 'border-blue-500';
                textColor = 'text-blue-800';
            }

            messageBox.className = `fixed top-4 right-4 z-50 p-4 ${bgColor} ${textColor} border-l-4 ${borderColor} rounded-lg shadow-xl font-medium transition-opacity duration-300 ease-in-out opacity-0`;
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('opacity-100'), 10);

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        /** Formats a number to 1 decimal place if it has a decimal, otherwise an integer. */
        function formatWeight(w) {
            return Number.isInteger(w) ? w : w.toFixed(1);
        }

        /** Calculates volume (Sets * Reps * Weight) */
        function calculateVolume(setsData) {
            return setsData.reduce((total, set) => total + (set.reps * set.weight), 0);
        }
        
        /** Updates the status text on the main dashboard */
        function updateDashboardStatus() {
             const totalEquipment = state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length;
             currentGymStatus.textContent = `${state.gymName} | ${totalEquipment} items available.`;
        }


        // --- RENDER & LOGIC FUNCTIONS ---

        /** Renders the Gym Setup Checkboxes for a given container */
        function renderGymSetupCheckboxes(weightsContainer, cardioContainer, floorContainer, useActiveState = false) {
            const currentSetup = useActiveState ? state.gymSetup : state.gymSetup; // Currently they refer to the same state
            
            const createCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = (useActiveState ? 'active-' : '') + item.replace(/\s/g, '-');
                    const checked = currentSetup[category].includes(item) ? 'checked' : '';
                    return `
                        <div class="flex items-center">
                            <input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked}
                                class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label>
                        </div>
                    `;
                }).join('');
            };

            createCheckboxes(weightsContainer, 'weights');
            createCheckboxes(cardioContainer, 'cardio');
            createCheckboxes(floorContainer, 'floor');
        }

        /** Renders the muscle selection checkboxes for Workout Planning */
        function renderMuscleCheckboxes() {
            muscleOptionsDiv.innerHTML = MUSCLE_GROUPS.map(muscle => `
                <div class="flex items-center">
                    <input id="muscle-${muscle}" type="checkbox" name="muscle" value="${muscle}"
                           class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label for="muscle-${muscle}" class="ml-2 text-gray-600 capitalize text-sm">${muscle}</label>
                </div>
            `).join('');
        }

        /** Renders the Workout Focus Dropdown */
        function renderWorkoutFocus() {
            workoutFocusSelect.innerHTML = FOCUS_OPTIONS.map(focus => `
                <option value="${focus.toLowerCase().replace(/\s/g, '-')}">${focus}</option>
            `).join('');
            workoutFocusSelect.value = ''; // Default to nothing selected
            workoutFocusSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Choose Focus --</option>');
        }

        /** Filters and renders available exercises based on gym and focus */
        function renderExerciseDropdown() {
            const selectedFocus = workoutFocusSelect.value;
            const selectedMuscles = Array.from(document.querySelectorAll('#muscle-options input:checked')).map(cb => cb.value);
            const availableEquipment = [...state.gymSetup.weights, ...state.gymSetup.cardio, ...state.gymSetup.floor];

            let filteredExercises = EXERCISE_LIBRARY.filter(exercise => {
                // Check if the exercise can be done with the available equipment
                const equipmentMatch = exercise.equipment.some(item => availableEquipment.includes(item));
                
                // Check if the focus matches
                let focusMatch = false;
                const normalizedFocus = exercise.focus.map(f => f.toLowerCase().replace(/\s/g, '-'));

                if (selectedFocus === 'specific-muscles' && selectedMuscles.length > 0) {
                    focusMatch = selectedMuscles.some(muscle => normalizedFocus.includes(muscle));
                } else if (selectedFocus) {
                    focusMatch = normalizedFocus.includes(selectedFocus);
                } else {
                    focusMatch = true;
                }

                return equipmentMatch && focusMatch;
            });

            exerciseSelect.innerHTML = filteredExercises.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('');
            exerciseSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Select an Exercise --</option>');
            
            if (filteredExercises.length === 0 && selectedFocus) {
                showMessage("No exercises match your current gym setup and focus!", 'error', 5000);
            }
        }

        /** Renders the interactive sets/reps/weight input fields */
        function renderSetsTracking() {
            const exerciseName = exerciseSelect.value;
            const numSets = parseInt(setsInput.value);
            const targetReps = parseInt(targetRepsInput.value);

            if (!exerciseName || isNaN(numSets) || isNaN(targetReps)) {
                showMessage("Please select an exercise and enter valid sets/reps.", 'error');
                return;
            }

            // Initialize the current exercise data structure
            state.currentWorkout.currentExercise = {
                name: exerciseName,
                setsData: Array.from({ length: numSets }, (_, i) => ({
                    set: i + 1,
                    reps: targetReps,
                    weight: 0.0 // Start at 0.0
                }))
            };
            
            // Get best weight history for display
            const bestWeight = state.exerciseHistory[exerciseName]?.bestWeight || 0;

            setsTrackingContainer.innerHTML = state.currentWorkout.currentExercise.setsData.map((set, index) => {
                const setNumber = index + 1;
                return `
                    <div class="set-row p-4 border border-gray-200 rounded-xl bg-gray-50 grid grid-cols-1 md:grid-cols-4 gap-4 items-center" data-set-index="${index}">
                        <h4 class="font-bold text-lg text-green-700">Set ${setNumber}</h4>
                        
                        <!-- Reps Control -->
                        <div class="flex items-center space-x-2">
                            <label class="font-medium text-gray-700 w-16">Reps:</label>
                            <button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-2 rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold" data-delta="-1" data-field="reps">-</button>
                            <input type="number" value="${set.reps}" min="1" class="set-input-field w-12 text-center border-b-2 border-gray-400" data-field="reps">
                            <button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-2 rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold" data-delta="1" data-field="reps">+</button>
                        </div>

                        <!-- Weight Control -->
                        <div class="flex items-center space-x-2">
                            <label class="font-medium text-gray-700 w-16">Weight (kg):</label>
                            <button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-2 rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold" data-delta="-2.5" data-field="weight">-</button>
                            <input type="number" step="0.5" value="${formatWeight(set.weight)}" class="set-input-field w-16 text-center border-b-2 border-gray-400" data-field="weight">
                            <button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-2 rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold" data-delta="2.5" data-field="weight">+</button>
                        </div>
                        
                        <!-- Best Lift Display -->
                        <div class="text-sm text-gray-500 italic md:text-right">
                            PB: ${formatWeight(bestWeight)}kg
                        </div>
                    </div>
                `;
            }).join('');
            
            setsTrackingContainer.insertAdjacentHTML('beforeend', `
                <button type="button" id="save-exercise-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                    Log Exercise: ${exerciseName}
                </button>
            `);
            
            document.getElementById('save-exercise-btn').addEventListener('click', saveExercise);
            document.querySelectorAll('.rep-change').forEach(btn => {
                btn.addEventListener('click', handleSetRepWeightChange);
            });
            document.querySelectorAll('.set-input-field').forEach(input => {
                input.addEventListener('change', handleSetInputUpdate);
            });
        }
        
        /** Renders the list of exercises already logged in the current workout */
        function updateLoggedExercisesSummary() {
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {
                loggedExercisesSummary.innerHTML = '<p class="text-gray-500 italic">No exercises logged yet in this session.</p>';
                return;
            }

            const items = state.currentWorkout.exercises.map(ex => {
                const totalVolume = calculateVolume(ex.setsData);
                const maxWeight = ex.setsData.reduce((max, s) => Math.max(max, s.weight), 0);
                
                return `
                    <div class="p-3 border-l-4 border-green-400 bg-gray-50 rounded-lg">
                        <p class="font-semibold text-gray-800">${ex.name}</p>
                        <p class="text-sm text-gray-600">Sets: ${ex.setsData.length} | Max: ${formatWeight(maxWeight)}kg | Vol: ${formatWeight(totalVolume)}kg</p>
                    </div>
                `;
            }).join('');
            
            loggedExercisesSummary.innerHTML = `
                <h3 class="text-xl font-bold text-green-800 border-t pt-4">Logged Exercises (${state.currentWorkout.exercises.length})</h3>
                <div class="space-y-2">${items}</div>
            `;
        }

        /** Sets up the equipment modal with the current equipment state */
        function renderActiveEquipmentModal() {
            // Re-render the checklists in the modal, checking the currently selected items
            const w = document.getElementById('active-weights-options');
            const c = document.getElementById('active-cardio-options');
            const f = document.getElementById('active-floor-options');
            
            // Helper function to create checkboxes in the modal based on current state
            const createModalCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = 'active-' + item.replace(/\s/g, '-');
                    const checked = state.gymSetup[category].includes(item) ? 'checked' : '';
                    return `
                        <div class="flex items-center">
                            <input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked}
                                class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label>
                        </div>
                    `;
                }).join('');
            };

            createModalCheckboxes(w, 'weights');
            createModalCheckboxes(c, 'cardio');
            createModalCheckboxes(f, 'floor');
        }

        // --- HANDLERS ---

        /** 1. Handles Gym Setup Submission (Both main and active modal) */
        function handleGymSetupSave(e) {
            e.preventDefault();
            const form = e.currentTarget;
            const formData = new FormData(form);
            
            const isModal = form.id === 'active-gym-setup-form';

            if (!isModal) {
                 // Save Name only if it's the main gym config form
                state.gymName = formData.get('gym-name') || "Custom Gym";
            }
            
            state.gymSetup.weights = formData.getAll('weights');
            state.gymSetup.cardio = formData.getAll('cardio');
            state.gymSetup.floor = formData.getAll('floor');

            if (isModal) {
                equipmentModal.classList.add('hidden');
                // Since equipment changed, re-render the available exercises mid-workout
                renderExerciseDropdown();
                showMessage(`Equipment updated! Exercise list refreshed.`, 'info');
            } else {
                showMessage("Gym setup saved successfully!", 'success');
                showView('dashboard');
            }
        }
        
        /** 2. Toggles muscle checkboxes based on focus selection and updates exercise list */
        function handleFocusChange() {
            const isSpecific = workoutFocusSelect.value === 'specific-muscles';
            muscleCheckboxesDiv.classList.toggle('hidden', !isSpecific);
            renderExerciseDropdown();
        }

        /** 3. Handles Workout Planning Submission (Start Workout) */
        function handleStartWorkout(e) {
            e.preventDefault();
            
            const focus = workoutFocusSelect.value;
            if (!focus) {
                showMessage("Please select a training focus before starting.", 'error');
                return;
            }

            // Create new workout session
            state.currentWorkout = {
                title: focus.replace(/-/g, ' ').toUpperCase(),
                date: new Date().toISOString(),
                exercises: []
            };

            // Transition UI to active workout view
            activeWorkoutTitle.textContent = state.currentWorkout.title;
            updateLoggedExercisesSummary();
            showView('track-workout');
            
            // Pre-populate exercise list based on chosen focus
            renderExerciseDropdown();
            showMessage(`Workout started: ${state.currentWorkout.title}`, 'info', 4000);
        }

        /** 4. Handles button click to adjust sets/reps/weight */
        function handleSetRepWeightChange(e) {
            const button = e.currentTarget;
            const delta = parseFloat(button.getAttribute('data-delta'));
            const field = button.getAttribute('data-field');
            const row = button.closest('.set-row');
            const index = parseInt(row.getAttribute('data-set-index'));
            
            const inputField = row.querySelector(`.set-input-field[data-field="${field}"]`);
            let currentValue = parseFloat(inputField.value);
            
            let newValue = currentValue + delta;
            
            if (field === 'reps') {
                newValue = Math.max(1, Math.round(newValue));
            } else if (field === 'weight') {
                newValue = Math.max(0.0, newValue);
            }
            
            inputField.value = formatWeight(newValue);
            handleSetInputUpdate({ currentTarget: inputField });
        }
        
        /** 5. Handles direct input field change (for sets/reps/weight) */
        function handleSetInputUpdate(e) {
            const inputField = e.currentTarget;
            const row = inputField.closest('.set-row');
            const index = parseInt(row.getAttribute('data-set-index'));
            const field = inputField.getAttribute('data-field');
            const value = parseFloat(inputField.value);
            
            if (state.currentWorkout?.currentExercise && !isNaN(value)) {
                state.currentWorkout.currentExercise.setsData[index][field] = value;
            }
        }

        /** 6. Saves the currently configured exercise to the workout log */
        function saveExercise() {
            if (!state.currentWorkout || !state.currentWorkout.currentExercise) {
                showMessage("Error: No active exercise to save.", 'error');
                return;
            }
            
            const exercise = state.currentWorkout.currentExercise;
            const volume = calculateVolume(exercise.setsData);
            
            // Find the best weight lifted in this exercise (for 1 or more reps)
            const maxWeight = exercise.setsData
                .filter(s => s.reps > 0)
                .reduce((max, s) => Math.max(max, s.weight), 0);
            
            // Update the history (Best Lift tracking)
            if (!state.exerciseHistory[exercise.name] || maxWeight > state.exerciseHistory[exercise.name].bestWeight) {
                state.exerciseHistory[exercise.name] = {
                    bestWeight: maxWeight,
                    bestReps: exercise.setsData.find(s => s.weight === maxWeight)?.reps || 0,
                    lastDate: new Date().toLocaleDateString(),
                };
                showMessage(`New PB for ${exercise.name}: ${formatWeight(maxWeight)}kg!`, 'success');
            }

            // Save the exercise to the current workout
            state.currentWorkout.exercises.push({
                ...exercise,
                volume: volume,
            });
            
            // Clear the active exercise view
            setsTrackingContainer.innerHTML = '';
            exerciseSelect.value = '';
            setsInput.value = 3;
            targetRepsInput.value = 10;
            state.currentWorkout.currentExercise = null;
            
            updateLoggedExercisesSummary();
            showMessage(`${exercise.name} logged successfully! Total volume: ${formatWeight(volume)}kg.`, 'success');
        }

        /** 7. Saves the entire workout session */
        function saveWorkout() {
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {
                showMessage("The workout is empty. No session saved.", 'error');
                // Reset session state anyway to clean up
                state.currentWorkout = null;
                return;
            }
            
            const totalVolume = state.currentWorkout.exercises.reduce((total, ex) => total + ex.volume, 0);

            // Log the finished workout
            state.workoutLog.push({
                ...state.currentWorkout,
                totalVolume: totalVolume,
                duration: '45 min (simulated)',
            });
            
            // Reset UI
            state.currentWorkout = null;
            
            showMessage(`Workout finished! Total volume lifted: ${formatWeight(totalVolume)}kg. Great job!`, 'success', 6000);
        }

        /** 8. Renders and shows the history modal */
        function renderHistory() {
            historyContent.innerHTML = '';
            const historyKeys = Object.keys(state.exerciseHistory).sort();
            
            if (historyKeys.length === 0) {
                historyContent.innerHTML = '<p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>';
                return;
            }

            const items = historyKeys.map(name => {
                const item = state.exerciseHistory[name];
                return `
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm">
                        <h4 class="text-xl font-bold text-gray-800">${name}</h4>
                        <p class="text-gray-600 mt-1">
                            <span class="font-semibold">Best Weight:</span> ${formatWeight(item.bestWeight)}kg (for ${item.bestReps} reps)
                        </p>
                        <p class="text-xs text-gray-400">
                            Last PB Achieved: ${item.lastDate}
                        </p>
                    </div>
                `;
            }).join('');

            historyContent.innerHTML = `<div class="space-y-4">${items}</div>`;
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        function initApp() {
            // Load user info (currently hardcoded)
            document.getElementById('user-name').textContent = state.userName;
            document.getElementById('user-goal').textContent = state.goal;

            // Render initial controls
            renderMuscleCheckboxes();
            renderWorkoutFocus();
            updateDashboardStatus();
            
            // Setup default view
            showView('dashboard', false); // Do not update history on init

            // Event Listeners for forms
            gymSetupForm.addEventListener('submit', handleGymSetupSave);
            activeGymSetupForm.addEventListener('submit', handleGymSetupSave); // Active modal save handler
            workoutFocusSelect.addEventListener('change', handleFocusChange);
            workoutPlanningForm.addEventListener('submit', handleStartWorkout);
            
            // Active Workout Listeners
            document.getElementById('start-sets-btn').addEventListener('click', renderSetsTracking);
            document.getElementById('finish-workout-btn').addEventListener('click', () => {
                saveWorkout();
                showView('dashboard');
            });

            // Navigation Listeners
            document.getElementById('view-history-btn').addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
            });
            document.getElementById('close-history-btn').addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });

            // Equipment Modal Listeners
            document.getElementById('open-equipment-modal-btn').addEventListener('click', () => {
                renderActiveEquipmentModal();
                equipmentModal.classList.remove('hidden');
            });
            document.getElementById('close-equipment-modal-btn').addEventListener('click', () => {
                equipmentModal.classList.add('hidden');
            });

            // Meal Logging (Simple implementation)
            document.getElementById('add-meal-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const mealName = e.target.querySelector('input[type="text"]').value;
                showMessage(`Meal "${mealName}" logged!`, 'success');
                e.target.reset();
                showView('dashboard');
            });
            
            // Re-render exercise list when muscles are checked/unchecked
            muscleOptionsDiv.addEventListener('change', () => {
                 if (workoutFocusSelect.value === 'specific-muscles') {
                    renderExerciseDropdown();
                 }
            });
        }

        // Run initialization when the page is ready
        window.onload = initApp;

    </script>
</body>
</html>

            } @else {
                <!-- Login View -->
                @if (view() === 'login') {
                    <div class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 text-center">Login to VFit</h2>
                        <form (submit)="handleLogin($event)" class="space-y-4">
                            <input type="email" placeholder="Email (dummy)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-vfit-primary focus:border-vfit-primary">
                            <input type="password" placeholder="Password (dummy)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-vfit-primary focus:border-vfit-primary">
                            <button type="submit" class="w-full py-3 bg-vfit-primary text-white font-semibold rounded-lg shadow-md hover:bg-vfit-accent transition duration-300">
                                Sign In
                            </button>
                        </form>
                        <p class="text-center text-sm text-gray-600">
                            Don't have an account? 
                            <span (click)="setView('register')" class="text-vfit-primary font-medium cursor-pointer hover:underline">Register here</span>
                        </p>
                    </div>
                }

                <!-- Register View -->
                @if (view() === 'register') {
                    <div class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 text-center">Join VFit</h2>
                        <form (submit)="handleRegister($event)" class="space-y-4">
                            <input type="text" placeholder="Username (dummy)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-vfit-primary focus:border-vfit-primary">
                            <input type="email" placeholder="Email (dummy)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-vfit-primary focus:border-vfit-primary">
                            <input type="password" placeholder="Password (dummy)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-vfit-primary focus:border-vfit-primary">
                            <button type="submit" class="w-full py-3 bg-vfit-primary text-white font-semibold rounded-lg shadow-md hover:bg-vfit-accent transition duration-300">
                                Create Account
                            </button>
                        </form>
                        <p class="text-center text-sm text-gray-600">
                            Already have an account? 
                            <span (click)="setView('login')" class="text-vfit-primary font-medium cursor-pointer hover:underline">Sign In</span>
                        </p>
                    </div>
                }

                <!-- Dashboard View (Protected) -->
                @if (view() === 'dashboard') {
                    <div class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 text-center">VFit Dashboard</h2>
                        
                        <!-- User Status -->
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                            <p class="text-sm font-semibold text-indigo-700">Welcome back, {{ username() }}!</p>
                            <p class="text-xs text-indigo-600">Your User ID: <span class="break-all">{{ userId() }}</span></p>
                        </div>
                        
                        <!-- Main Dashboard Content Placeholder -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-dashed text-center space-y-3">
                            <p class="text-xl font-medium text-gray-700">Your Activity Summary</p>
                            <p class="text-gray-500">This is where your personalized fitness metrics and workout logs would appear.</p>
                        </div>

                        <!-- Action Button -->
                        <button (click)="logout()" class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Logout
                        </button>
                    </div>
                }
            }
        </div>
    </main>
  `,
  styles: [`
    .text-vfit-primary { color: #C05621; }
    .bg-vfit-primary { background-color: #C05621; }
    .hover\\:bg-vfit-accent:hover { background-color: #f97316; }
    .focus\\:border-vfit-primary:focus { border-color: #C05621; }
    .focus\\:ring-vfit-primary:focus { --tw-ring-color: #C05621; }
  `],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class App implements OnInit {
  // State Signals
  view = signal<View>('login');
  user = signal<User | null>(null);
  dbReady = signal(false);
  auth!: Auth;
  firestore!: Firestore;

  // Computed Properties
  userId = computed(() => this.user()?.uid || 'Not Authenticated');
  username = computed(() => this.user() ? `User-${this.user()!.uid.substring(0, 4)}` : 'Guest');

  constructor() {
    // Effect to handle navigation based on authentication status
    effect(() => {
      const currentUser = this.user();
      if (this.dbReady()) {
        if (currentUser) {
          // If authenticated, go to dashboard
          this.view.set('dashboard');
        } else {
          // If not authenticated, go to login
          this.view.set('login');
        }
      }
    });

    // Set Firestore log level for debugging
    setLogLevel('debug');
  }

  ngOnInit() {
    this.initializeFirebase();
  }

  async initializeFirebase() {
    try {
      // --- GITHUB PAGES/STATIC HOST FALLBACK LOGIC ---
      // Provide placeholder values if the global variables are not defined (e.g., when running on GitHub Pages)
      const DUMMY_FIREBASE_CONFIG = '{"apiKey": "AIzaSy_DUMMY_KEY", "projectId": "vfit-gh-pages-mock", "appId": "1:234567:web"}';
      
      // Access globals safely via 'window as any' and provide fallbacks
      const firebaseConfigStr = typeof (window as any).__firebase_config !== 'undefined'
        ? (window as any).__firebase_config
        : DUMMY_FIREBASE_CONFIG;

      const initialAuthToken = typeof (window as any).__initial_auth_token !== 'undefined'
        ? (window as any).__initial_auth_token
        : null;
      // --- END FALLBACK LOGIC ---

      const firebaseConfig = JSON.parse(firebaseConfigStr);
      const app = initializeApp(firebaseConfig);
      this.auth = getAuth(app);
      this.firestore = getFirestore(app);

      // 1. Initial Authentication Check
      await new Promise<void>(resolve => {
        const unsubscribe = onAuthStateChanged(this.auth, async (user) => {
          this.user.set(user);
          this.dbReady.set(true);
          unsubscribe();
          resolve();
        });
      });

      // 2. Sign In if initial auth token is present (from Canvas or mock)
      if (initialAuthToken && !this.user()) {
        await signInWithCustomToken(this.auth, initialAuthToken);
      } else if (!this.user()) {
        // Fallback to anonymous sign-in if no custom token is provided
        await signInAnonymously(this.auth);
      }

      // 3. Set up persistent listener
      onAuthStateChanged(this.auth, (user) => {
        this.user.set(user);
      });

    } catch (error) {
      console.error('Firebase initialization failed:', error);
      // Ensure dbReady is set to true even on failure so the UI can render
      this.dbReady.set(true); 
    }
  }

  setView(newView: View) {
    // Only allow navigation if the user is authorized for the target view
    if (newView === 'dashboard' && !this.user()) {
      // Prevent unauthorized access to the dashboard
      return;
    }
    this.view.set(newView);
  }

  // --- Authentication Handlers (Dummy) ---

  async handleLogin(event: Event) {
    event.preventDefault();
    console.log('Attempting login...');
    // TEMPORARY: Since we can't use email/password auth in this environment, 
    // this action is just a placeholder and will rely on the initial auth setup.
    if (this.user()) {
        this.setView('dashboard');
    } else {
        console.error('Login failed (simulated). Check console logs for details.');
    }
  }

  async handleRegister(event: Event) {
    event.preventDefault();
    console.log('Attempting registration...');
    // TEMPORARY: For demonstration, we simply navigate to the login page.
    this.setView('login');
  }

  async logout() {
    try {
      await this.auth.signOut();
      console.log('User logged out successfully.');
    } catch (error) {
      console.error('Logout failed:', error);
    }
  }
}

                        <p class="text-center text-sm text-gray-600">
                            Already have an account? 
                            <span (click)="setView('login')" class="text-vfit-primary font-medium cursor-pointer hover:underline">Sign In</span>
                        </p>
                    </div>
                }

                <!-- Dashboard View (Protected) -->
                @if (view() === 'dashboard') {
                    <div class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 text-center">VFit Dashboard</h2>
                        
                        <!-- User Status -->
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                            <p class="text-sm font-semibold text-indigo-700">Welcome back, {{ username() }}!</p>
                            <p class="text-xs text-indigo-600">Your User ID: <span class="break-all">{{ userId() }}</span></p>
                        </div>
                        
                        <!-- Main Dashboard Content Placeholder -->
                        <div class="bg-gray-50 p-6 rounded-lg border border-dashed text-center space-y-3">
                            <p class="text-xl font-medium text-gray-700">Your Activity Summary</p>
                            <p class="text-gray-500">This is where your personalized fitness metrics and workout logs would appear.</p>
                        </div>

                        <!-- Action Button -->
                        <button (click)="logout()" class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Logout
                        </button>
                    </div>
                }
            }
        </div>
    </main>
  `,
  styles: [`
    .text-vfit-primary { color: #C05621; }
    .bg-vfit-primary { background-color: #C05621; }
    .hover\\:bg-vfit-accent:hover { background-color: #f97316; }
    .focus\\:border-vfit-primary:focus { border-color: #C05621; }
    .focus\\:ring-vfit-primary:focus { --tw-ring-color: #C05621; }
  `],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class App implements OnInit {
  // State Signals
  view = signal<View>('login');
  user = signal<User | null>(null);
  dbReady = signal(false);
  auth!: Auth;
  firestore!: Firestore;

  // Computed Properties
  userId = computed(() => this.user()?.uid || 'Not Authenticated');
  username = computed(() => this.user() ? `User-${this.user()!.uid.substring(0, 4)}` : 'Guest');

  constructor() {
    // Effect to handle navigation based on authentication status
    effect(() => {
      const currentUser = this.user();
      if (this.dbReady()) {
        if (currentUser) {
          // If authenticated, go to dashboard
          this.view.set('dashboard');
        } else {
          // If not authenticated, go to login
          this.view.set('login');
        }
      }
    });

    // Set Firestore log level for debugging
    setLogLevel('debug');
  }

  ngOnInit() {
    this.initializeFirebase();
  }

  async initializeFirebase() {
    try {
      // --- GITHUB PAGES/STATIC HOST FALLBACK LOGIC ---
      // Provide placeholder values if the global variables are not defined (e.g., when running on GitHub Pages)
      const DUMMY_FIREBASE_CONFIG = '{"apiKey": "AIzaSy_DUMMY_KEY", "projectId": "vfit-gh-pages-mock", "appId": "1:234567:web"}';
      
      // Access globals safely via 'window as any' and provide fallbacks
      const firebaseConfigStr = typeof (window as any).__firebase_config !== 'undefined'
        ? (window as any).__firebase_config
        : DUMMY_FIREBASE_CONFIG;

      const initialAuthToken = typeof (window as any).__initial_auth_token !== 'undefined'
        ? (window as any).__initial_auth_token
        : null;
      // --- END FALLBACK LOGIC ---

      const firebaseConfig = JSON.parse(firebaseConfigStr);
      const app = initializeApp(firebaseConfig);
      this.auth = getAuth(app);
      this.firestore = getFirestore(app);

      // 1. Initial Authentication Check
      await new Promise<void>(resolve => {
        const unsubscribe = onAuthStateChanged(this.auth, async (user) => {
          this.user.set(user);
          this.dbReady.set(true);
          unsubscribe();
          resolve();
        });
      });

      // 2. Sign In if initial auth token is present (from Canvas or mock)
      if (initialAuthToken && !this.user()) {
        await signInWithCustomToken(this.auth, initialAuthToken);
      } else if (!this.user()) {
        // Fallback to anonymous sign-in if no custom token is provided
        await signInAnonymously(this.auth);
      }

      // 3. Set up persistent listener
      onAuthStateChanged(this.auth, (user) => {
        this.user.set(user);
      });

    } catch (error) {
      console.error('Firebase initialization failed:', error);
      // Ensure dbReady is set to true even on failure so the UI can render
      this.dbReady.set(true); 
    }
  }

  setView(newView: View) {
    // Only allow navigation if the user is authorized for the target view
    if (newView === 'dashboard' && !this.user()) {
      // Prevent unauthorized access to the dashboard
      return;
    }
    this.view.set(newView);
  }

  // --- Authentication Handlers (Dummy) ---

  async handleLogin(event: Event) {
    event.preventDefault();
    console.log('Attempting login...');
    // TEMPORARY: Since we can't use email/password auth in this environment, 
    // this action is just a placeholder and will rely on the initial auth setup.
    if (this.user()) {
        this.setView('dashboard');
    } else {
        console.error('Login failed (simulated). Check console logs for details.');
    }
  }

  async handleRegister(event: Event) {
    event.preventDefault();
    console.log('Attempting registration...');
    // TEMPORARY: For demonstration, we simply navigate to the login page.
    this.setView('login');
  }

  async logout() {
    try {
      await this.auth.signOut();
      console.log('User logged out successfully.');
    } catch (error) {
      console.error('Logout failed:', error);
    }
  }
}

        }
        ::-webkit-scrollbar-thumb {
            background-color: #C05621;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Load Firebase CDN imports (ES Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, setLogLevel, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase modules to the global scope for the Babel script to use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
            getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, setLogLevel, onSnapshot, orderBy
        };
    </script>

    <!-- The React Application Code -->
    <script type="text/babel">
        // Global variables provided by the Canvas environment (simulated or left for runtime injection)
        // For local testing on GitHub Pages, you might need to define these mock values:
        const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'vfit-gh-pages-12345';
        const __firebase_config = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{"apiKey": "AIzaSy...", "projectId": "vfit-project", "appId": "1:234567..."}';
        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null; 

        // Use a wrapper function to ensure all Firebase globals are available before running the app
        window.runVFitApp = () => {
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
                   getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, setLogLevel, onSnapshot } = window.firebase;

            const { useState, useEffect, useCallback, useReducer } = React;

            // Define the available routes/views
            /** @typedef {'login' | 'register' | 'dashboard' | 'gym-setup' | 'start-workout' | 'active-workout' | 'history'} View */

            // --- GLOBAL CONSTANTS ---
            const VFIT_PRIMARY = '#C05621'; // Dark Orange
            const VFIT_DARK_BG = '#1f2937'; // Dark Grey
            const VFIT_ACCENT = '#f97316'; // Lighter Orange

            const workoutSplits = ['Full Body', 'Upper Body', 'Lower Body', 'Press', 'Pull', 'Squat', 'Hinge', 'Specific Muscles'];
            const muscleGroups = ['Biceps', 'Triceps', 'Shoulders', 'Quads', 'Hamstrings', 'Abs', 'Chest', 'Lats', 'Upper Back', 'Glutes', 'Calves'];

            const gymEquipment = {
                weights: [
                    { key: 'bench', name: 'Bench', icon: 'ü™ë' },
                    { key: 'barbell', name: 'Barbell', icon: 'üèãÔ∏è' },
                    { key: 'dumbbell', name: 'Dumbbell', icon: 'üí™' },
                    { key: 'pinstack', name: 'Pin Stack Machines', icon: '‚öôÔ∏è' },
                    { key: 'weighted_machines', name: 'Weighted Machines', icon: 'üß±' },
                    { key: 'cables', name: 'Cables', icon: 'üîó' },
                ],
                cardio: [
                    { key: 'treadmill', name: 'Treadmill', icon: 'üèÉ' },
                    { key: 'bike', name: 'Bike', icon: 'üö¥' },
                    { key: 'rower', name: 'Rower', icon: 'üõ∂' },
                    { key: 'cross_trainer', name: 'Cross Trainer', icon: 'üö∂' },
                    { key: 'assault_bike', name: 'Assault Bike', icon: 'üî•' },
                    { key: 'ski_erg', name: 'Ski Erg', icon: '‚õ∑Ô∏è' },
                    { key: 'step_machine', name: 'Step Machine', icon: 'ü™ú' },
                ],
                floorSpace: [
                    { key: 'trx', name: 'TRX', icon: 'üéóÔ∏è' },
                    { key: 'ropes', name: 'Ropes', icon: '‚û∞' },
                    { key: 'sandbag', name: 'Sandbag', icon: 'üçö' },
                    { key: 'medicine_ball', name: 'Medicine Ball', icon: 'üèÄ' },
                    { key: 'slam_ball', name: 'Slam Ball', icon: 'üèê' },
                ],
            };

            // --- EXERCISE CATALOG & MAPPING ---
            const EXERCISE_CATALOG = [
                // Compounds & Bench/Barbell movements
                { name: 'Barbell Squat', primary: ['Quads', 'Glutes'], equipment: ['barbell'] },
                { name: 'Bench Press', primary: ['Chest', 'Triceps', 'Shoulders'], equipment: ['barbell', 'bench'] },
                { name: 'Deadlift', primary: ['Hamstrings', 'Glutes', 'Upper Back'], equipment: ['barbell'] },
                { name: 'Overhead Press', primary: ['Shoulders', 'Triceps'], equipment: ['barbell'] },
                { name: 'Barbell Row', primary: ['Lats', 'Upper Back'], equipment: ['barbell'] },
                
                // Dumbbell movements
                { name: 'Dumbbell Curl', primary: ['Biceps'], equipment: ['dumbbell'] },
                { name: 'Incline Dumbbell Press', primary: ['Chest', 'Shoulders'], equipment: ['dumbbell', 'bench'] },
                { name: 'Lateral Raise (Dumbbell)', primary: ['Shoulders'], equipment: ['dumbbell'] },
                { name: 'Bulgarian Split Squat', primary: ['Quads', 'Glutes'], equipment: ['dumbbell', 'bench'] },

                // Cable/Machine movements
                { name: 'Triceps Pushdown', primary: ['Triceps'], equipment: ['cables'] },
                { name: 'Leg Extension', primary: ['Quads'], equipment: ['weighted_machines', 'pinstack'] },
                { name: 'Leg Curl', primary: ['Hamstrings'], equipment: ['weighted_machines', 'pinstack'] },
                { name: 'Cable Fly', primary: ['Chest'], equipment: ['cables'] },
                { name: 'Face Pull', primary: ['Shoulders', 'Upper Back'], equipment: ['cables'] },
                { name: 'Lat Pulldown', primary: ['Lats'], equipment: ['weighted_machines', 'pinstack', 'cables'] },

                // Bodyweight/Other
                { name: 'Ab Rollout', primary: ['Abs'], equipment: ['floorSpace'] },
                { name: 'Push-ups', primary: ['Chest', 'Triceps'], equipment: ['floorSpace'] },
                { name: 'Pull-ups/Chin-ups', primary: ['Lats', 'Biceps'], equipment: ['floorSpace'] },
            ];

            const SPLIT_MUSCLE_MAPPING = {
                'Full Body': ['Chest', 'Lats', 'Upper Back', 'Quads', 'Hamstrings', 'Glutes', 'Shoulders', 'Biceps', 'Triceps', 'Abs'],
                'Upper Body': ['Chest', 'Lats', 'Upper Back', 'Shoulders', 'Biceps', 'Triceps'],
                'Lower Body': ['Quads', 'Hamstrings', 'Glutes', 'Calves'],
                'Press': ['Chest', 'Shoulders', 'Triceps'],
                'Pull': ['Lats', 'Upper Back', 'Biceps'],
                'Squat': ['Quads', 'Glutes'],
                'Hinge': ['Hamstrings', 'Glutes', 'Upper Back'],
                // 'Specific Muscles' will use workoutConfig.muscleSelection directly
            };
            // --- END CONSTANTS ---


            // --- FIREBASE INITIALIZATION ---
            let auth;
            let db;

            const VFitApp = () => {
                // --- APP STATE ---
                /** @type {[View, Function]} */
                const [view, setView] = useState('login');
                const [user, setUser] = useState(null);
                const [dbReady, setDbReady] = useState(false);
                const [error, setError] = useState(null);
                
                // User Data State
                const [gymProfile, setGymProfile] = useState({});
                const [bestLifts, setBestLifts] = useState({}); // {exerciseId: {weight: 100, reps: 5}}
                const [userProfile, setUserProfile] = useState({ name: 'Fit User', goal: 'Strength Gain' });
                const [workoutHistory, setWorkoutHistory] = useState([]);
                const [mealHistory, setMealHistory] = useState([]); // Placeholder for meal history

                // Workout State (used across Start/Active views)
                const [workoutConfig, setWorkoutConfig] = useState({
                    split: workoutSplits[0],
                    muscleSelection: [],
                    sessionName: '',
                });
                const [activeWorkout, setActiveWorkout] = useState([]);

                // Computed values
                const userId = user ? user.uid : null;
                const isAuthenticated = !!user;

                // --- FIREBASE INTEGRATION & LIFECYCLE ---

                // 1. Initialization and Auth Listener
                useEffect(() => {
                    setLogLevel('debug');

                    const initializeFirebase = async () => {
                        try {
                            if (auth && db) { setDbReady(true); return; }

                            const firebaseConfig = JSON.parse(
                                typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'
                            );
                            
                            const app = initializeApp(firebaseConfig);
                            auth = getAuth(app);
                            db = getFirestore(app);

                            // Auth Listener: Triggers state updates
                            const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                                setUser(currentUser);
                                setDbReady(true);
                            });
                            
                            // Initial Sign-in
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }

                            return () => unsubscribe();
                        } catch (err) {
                            console.error('Firebase initialization failed:', err);
                            setError('Failed to initialize application.');
                            setDbReady(true);
                        }
                    };

                    initializeFirebase();
                }, []);

                // 2. View Synchronization & Data Fetching
                useEffect(() => {
                    if (!dbReady) return;
                    
                    if (isAuthenticated && userId) {
                        setView('dashboard');
                        fetchUserData(userId);
                    } else {
                        setView('login');
                    }
                }, [isAuthenticated, dbReady, userId]);

                // 3. Real-time History Listener
                useEffect(() => {
                    if (!db || !userId) return;

                    const workoutColRef = collection(db, getWorkoutHistoryCollectionPath());
                    // Note: For history, sorting by date is ideal, but Firestore's orderBy() requires an index.
                    // We will fetch and sort in memory to avoid index requirements in this single-file app.
                    const unsubscribeWorkout = onSnapshot(workoutColRef, (snapshot) => {
                        const historyList = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            historyList.push({ id: doc.id, ...data });
                        });
                        // Sort by date descending (newest first) in memory
                        historyList.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                        setWorkoutHistory(historyList);
                    }, (err) => {
                        console.error("Error listening to workout history:", err);
                        setError("Failed to load workout history.");
                    });

                    // Placeholder for Meal History Listener
                    // const mealColRef = collection(db, getMealHistoryCollectionPath());
                    // const unsubscribeMeal = onSnapshot(mealColRef, (snapshot) => { ... });

                    return () => {
                        unsubscribeWorkout();
                        // unsubscribeMeal();
                    };

                }, [db, userId]);

                // --- DATA HANDLING ---

                const getPrivateDocPath = (docId) => `artifacts/${__app_id}/users/${userId}/config/${docId}`;
                const getBestLiftsCollectionPath = () => `artifacts/${__app_id}/users/${userId}/bestLifts`;
                const getWorkoutHistoryCollectionPath = () => `artifacts/${__app_id}/users/${userId}/workoutHistory`;
                // const getMealHistoryCollectionPath = () => `artifacts/${__app_id}/users/${userId}/mealHistory`; // Placeholder path

                const fetchUserData = async (uid) => {
                    if (!db || !uid) return;

                    // Fetch Gym Profile
                    const gymRef = doc(db, getPrivateDocPath('gymProfile'));
                    const gymSnap = await getDoc(gymRef);
                    if (gymSnap.exists()) {
                        setGymProfile(gymSnap.data());
                    }

                    // Fetch User Profile (Name/Goal)
                    const userRef = doc(db, getPrivateDocPath('userProfile'));
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        setUserProfile({ ...userProfile, ...userSnap.data() });
                    }
                    
                    // Fetch Best Lifts (Simplification: fetch all for now, in a real app, query is better)
                    const bestLiftsSnap = await getDocs(collection(db, getBestLiftsCollectionPath()));
                    const lifts = {};
                    bestLiftsSnap.forEach(d => {
                        lifts[d.id] = d.data();
                    });
                    setBestLifts(lifts);
                };
                
                // --- NAVIGATION & AUTH HELPERS ---

                /** @param {View} newView */
                const navigate = (newView) => {
                    if (newView === 'dashboard' && !isAuthenticated) return;
                    setView(newView);
                };

                const handleLogout = async () => {
                    try {
                        await signOut(auth);
                        console.log('User logged out successfully.');
                        setGymProfile({});
                        setUserProfile({ name: 'Fit User', goal: 'Strength Gain' });
                        navigate('login'); // Navigation back to login
                    } catch (err) {
                        console.error('Logout failed:', err);
                        setError('Logout failed. Please try again.');
                    }
                };
                
                // --- UI COMPONENTS ---

                const LoadingSpinner = () => (
                    <div className="text-center py-10">
                        <p className="text-xl font-semibold text-gray-700 mb-4">Initializing Application...</p>
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 mx-auto" style={{ borderBottomColor: VFIT_PRIMARY }}></div>
                    </div>
                );
                
                // --- VIEW 1: AUTH ---

                const LoginView = () => (
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-gray-800 text-center">Login to VFit</h2>
                        <form onSubmit={(e) => { e.preventDefault(); if (isAuthenticated) navigate('dashboard'); }} className="space-y-4">
                            <input type="email" placeholder="Email (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                            <input type="password" placeholder="Password (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                            <button type="submit" 
                                    style={{ backgroundColor: VFIT_PRIMARY }}
                                    className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-300">
                                Sign In
                            </button>
                        </form>
                        <p className="text-center text-sm text-gray-600">
                            Don't have an account? 
                            <span onClick={() => navigate('register')} style={{ color: VFIT_PRIMARY }} className="font-medium cursor-pointer hover:underline">Register here</span>
                        </p>
                    </div>
                );

                const RegisterView = () => (
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-gray-800 text-center">Join VFit</h2>
                        <form onSubmit={(e) => { e.preventDefault(); navigate('login'); }} className="space-y-4">
                            <input type="text" placeholder="Username (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                            <input type="email" placeholder="Email (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                            <input type="password" placeholder="Password (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                            <button type="submit" 
                                    style={{ backgroundColor: VFIT_PRIMARY }}
                                    className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300">
                                Create Account
                            </button>
                        </form>
                        <p className="text-center text-sm text-gray-600">
                            Already have an account? 
                            <span onClick={() => navigate('login')} style={{ color: VFIT_PRIMARY }} className="font-medium cursor-pointer hover:underline">Sign In</span>
                        </p>
                    </div>
                );
                
                // --- VIEW 2: GYM SETUP ---
                
                const GymSetupView = () => {
                    const [tempProfile, setTempProfile] = useState(gymProfile.equipment || {});
                    const [isSaving, setIsSaving] = useState(false);

                    const handleCheckboxChange = (category, key, checked) => {
                        setTempProfile(prev => ({
                            ...prev,
                            [category]: {
                                ...(prev[category] || {}),
                                [key]: checked,
                            }
                        }));
                    };

                    const saveGymProfile = async () => {
                        if (!userId || isSaving) return;
                        setIsSaving(true);
                        try {
                            const gymRef = doc(db, getPrivateDocPath('gymProfile'));
                            await setDoc(gymRef, { equipment: tempProfile, updateDate: new Date() });
                            setGymProfile({ equipment: tempProfile }); // Update local state
                            navigate('dashboard');
                        } catch (err) {
                            console.error("Failed to save gym profile:", err);
                            setError("Failed to save gym profile.");
                        } finally {
                            setIsSaving(false);
                        }
                    };

                    return (
                        <div className="space-y-6">
                            <h2 className="text-3xl font-bold text-gray-800 text-center mb-6">Set Up Your Training</h2>
                            <div className="text-sm text-gray-600 text-center">
                                Select the equipment available at your gym. This helps customize your workout suggestions.
                            </div>

                            {Object.entries(gymEquipment).map(([category, items]) => (
                                <div key={category} className="p-4 border rounded-xl bg-gray-50 shadow-sm">
                                    <h3 className="text-xl font-semibold capitalize mb-3" style={{ color: VFIT_PRIMARY }}>
                                        {category.replace(/([A-Z])/g, ' $1')}
                                    </h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {items.map(item => (
                                            <div key={item.key} className="flex items-center">
                                                <input
                                                    type="checkbox"
                                                    id={item.key}
                                                    checked={tempProfile[category]?.[item.key] || false}
                                                    onChange={(e) => handleCheckboxChange(category, item.key, e.target.checked)}
                                                    className="h-4 w-4 rounded border-gray-300"
                                                    style={{ color: VFIT_PRIMARY, borderColor: VFIT_PRIMARY }}
                                                />
                                                <label htmlFor={item.key} className="ml-2 text-sm font-medium text-gray-700 cursor-pointer">
                                                    {item.icon} {item.name}
                                                </label>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            
                            <button 
                                onClick={saveGymProfile}
                                disabled={isSaving}
                                style={{ backgroundColor: VFIT_PRIMARY }}
                                className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300 disabled:opacity-50">
                                {isSaving ? 'Saving...' : 'Save Gym Profile'}
                            </button>
                        </div>
                    );
                };

                // --- VIEW 3: DASHBOARD ---

                const DashboardView = () => {
                    
                    const [logType, setLogType] = useState('workout'); // 'workout' or 'meal'
                    // No longer need isAdding state

                    const handleAddLog = (e) => {
                        e.preventDefault();
                        if (logType === 'workout') {
                            navigate('start-workout');
                        } else {
                            // Meal logging implementation would go here
                            console.log('Meal logging feature placeholder!');
                        }
                    };

                    const renderLogForm = () => (
                        <form onSubmit={handleAddLog} className="space-y-4">
                            <div className="flex space-x-4">
                                <button 
                                    type="button" 
                                    onClick={() => setLogType('workout')}
                                    className={`flex-1 py-2 rounded-lg font-semibold transition ${logType === 'workout' ? 'text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    style={{ backgroundColor: logType === 'workout' ? VFIT_PRIMARY : '' }}
                                >
                                    Add Workout
                                </button>
                                <button 
                                    type="button" 
                                    onClick={() => setLogType('meal')}
                                    className={`flex-1 py-2 rounded-lg font-semibold transition ${logType === 'meal' ? 'text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    style={{ backgroundColor: logType === 'meal' ? VFIT_PRIMARY : '' }}
                                >
                                    Add Meal
                                </button>
                            </div>

                            <div className="bg-white p-4 rounded-xl shadow border border-gray-200">
                                {logType === 'workout' ? (
                                    <div>
                                        <p className="text-gray-700 font-semibold mb-2">Log a new training session.</p>
                                        <button 
                                            type="submit" 
                                            style={{ backgroundColor: VFIT_PRIMARY }}
                                            className="w-full py-2 text-white font-semibold rounded-lg hover:opacity-90 transition">
                                            START WORKOUT
                                        </button>
                                    </div>
                                ) : (
                                    <div>
                                        <input type="text" placeholder="Meal Name" className="w-full p-2 border border-gray-300 rounded-lg mb-2" />
                                        <input type="text" placeholder="Calories (kcal)" className="w-full p-2 border border-gray-300 rounded-lg mb-2" />
                                        <button 
                                            type="submit" 
                                            className="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                                            LOG MEAL
                                        </button>
                                    </div>
                                )}
                            </div>
                        </form>
                    );

                    return (
                        <div className="space-y-6">
                            <h2 className="text-3xl font-bold text-gray-800 text-center">Dashboard</h2>

                            {/* Profile Overview */}
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-blue-100 p-4 rounded-xl border-l-4 border-blue-500">
                                    <p className="text-sm font-medium text-gray-500">Name</p>
                                    <p className="text-xl font-bold text-gray-800">{userProfile.name}</p>
                                </div>
                                <div className="bg-purple-100 p-4 rounded-xl border-l-4 border-purple-500">
                                    <p className="text-sm font-medium text-gray-500">Goal</p>
                                    <p className="text-xl font-bold text-gray-800">{userProfile.goal}</p>
                                </div>
                            </div>

                            {/* Gym Setup Status */}
                            <div className="p-4 rounded-xl border-2 border-dashed border-gray-300 text-center cursor-pointer hover:bg-gray-50 transition"
                                onClick={() => navigate('gym-setup')}>
                                <p className="text-lg font-semibold" style={{ color: VFIT_PRIMARY }}>
                                    {Object.keys(gymProfile.equipment || {}).length > 0 ? 'Gym Profile Set Up' : 'Set Up Your Gym Profile'}
                                </p>
                                <p className="text-sm text-gray-500">
                                    {Object.keys(gymProfile.equipment || {}).length > 0 ? 'Click to Review/Edit' : 'Define your available equipment.'}
                                </p>
                            </div>

                            {/* Log Activity */}
                            {renderLogForm()}

                            {/* History Button */}
                            <button onClick={() => navigate('history')} 
                                    className="w-full py-3 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 transition duration-300">
                                View Activity History
                            </button>

                            {/* Logout Button */}
                            <button onClick={handleLogout} className="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                                Logout ({userId ? userId.substring(0, 4) : '...' })
                            </button>
                        </div>
                    );
                };
                
                // --- VIEW 4: START WORKOUT CONFIG ---

                const StartWorkoutView = () => {
                    // Move state management for the form locally to prevent parent re-renders on every keystroke.
                    const [localSessionName, setLocalSessionName] = useState(workoutConfig.sessionName);
                    const [localSplit, setLocalSplit] = useState(workoutConfig.split);
                    const [localMuscleSelection, setLocalMuscleSelection] = useState(workoutConfig.muscleSelection);
                    
                    // Effect to initialize local state if parent workoutConfig changes (e.g., if navigated to dashboard and back)
                    useEffect(() => {
                        setLocalSessionName(workoutConfig.sessionName);
                        setLocalSplit(workoutConfig.split);
                        setLocalMuscleSelection(workoutConfig.muscleSelection);
                    }, [workoutConfig]);


                    const handleConfigChange = (e) => {
                        const { name, value } = e.target;
                        if (name === 'sessionName') {
                            // Update local state, no parent re-render
                            setLocalSessionName(value);
                        } else if (name === 'split') {
                            // Update local state for split
                            setLocalSplit(value);
                            // Reset muscle selection if we switch away from Specific Muscles
                            if (value !== 'Specific Muscles') {
                                setLocalMuscleSelection([]);
                            }
                        }
                    };

                    const handleMuscleToggle = (muscle) => {
                        // Update local state for muscle selection
                        setLocalMuscleSelection(prev => {
                            return prev.includes(muscle)
                                ? prev.filter(m => m !== muscle)
                                : [...prev, muscle];
                        });
                    };
                    
                    const startSession = (e) => {
                        e.preventDefault();
                        // 1. Validation using local state
                        if (localSplit === 'Specific Muscles' && localMuscleSelection.length === 0) {
                            setError('Please select at least one muscle group.');
                            return;
                        }
                        if (!localSessionName) {
                            setError('Please enter a session name.');
                            return;
                        }
                        setError(null);
                        
                        // 2. Update parent state ONCE on successful submission
                        setWorkoutConfig({
                            split: localSplit,
                            muscleSelection: localMuscleSelection,
                            sessionName: localSessionName,
                        });

                        setActiveWorkout([]); // Reset active workout exercises
                        navigate('active-workout');
                    };

                    return (
                        <div className="space-y-6">
                            <h2 className="text-3xl font-bold text-gray-800 text-center">Start Training Session</h2>
                            <button onClick={() => navigate('dashboard')} className="text-sm text-gray-500 hover:text-gray-700 flex items-center mb-4">
                                &#8592; Back to Dashboard
                            </button>

                            <form onSubmit={startSession} className="space-y-4 p-4 border rounded-xl shadow-sm bg-white">
                                {/* Session Name */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Session Name</label>
                                    <input 
                                        type="text" 
                                        name="sessionName"
                                        // Use local state
                                        value={localSessionName}
                                        onChange={handleConfigChange}
                                        placeholder="e.g., Heavy Lower Body Day" 
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                                </div>

                                {/* Workout Split */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Workout Split/Focus</label>
                                    <select 
                                        name="split"
                                        // Use local state
                                        value={localSplit}
                                        onChange={handleConfigChange}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }}>
                                        <option value="">-- Select Split --</option>
                                        {workoutSplits.map(split => <option key={split} value={split}>{split}</option>)}
                                    </select>
                                </div>

                                {/* Muscle Checkboxes (Conditional) */}
                                {localSplit === 'Specific Muscles' && (
                                    <div className="p-3 bg-gray-50 rounded-lg">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Select Muscle Groups:</label>
                                        <div className="grid grid-cols-3 gap-2 text-sm">
                                            {muscleGroups.map(muscle => (
                                                <div key={muscle} className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        id={`muscle-${muscle}`}
                                                        // Use local state
                                                        checked={localMuscleSelection.includes(muscle)}
                                                        onChange={() => handleMuscleToggle(muscle)}
                                                        className="h-4 w-4 rounded border-gray-300"
                                                        style={{ color: VFIT_PRIMARY, borderColor: VFIT_PRIMARY }}
                                                    />
                                                    <label htmlFor={`muscle-${muscle}`} className="ml-1 text-gray-600 text-xs cursor-pointer">
                                                        {muscle}
                                                    </label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Error Message */}
                                {error && <div className="text-red-600 text-sm">{error}</div>}

                                <button 
                                    type="submit" 
                                    style={{ backgroundColor: VFIT_PRIMARY }}
                                    className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300">
                                    START WORKOUT
                                </button>
                            </form>
                        </div>
                    );
                };

                // --- VIEW 5: ACTIVE WORKOUT ---
                
                const ActiveWorkoutView = () => {
                    const [exerciseName, setExerciseName] = useState('');
                    const [sets, setSets] = useState(3);
                    const [weight, setWeight] = useState(0);
                    const [reps, setReps] = useState(8);
                    const [isSaving, setIsSaving] = useState(false);
                    const [isEquipmentModalOpen, setIsEquipmentModalOpen] = useState(false);
                    
                    // State for temporary session-specific equipment override
                    // Initializing with existing profile, defaults to {} if profile is empty
                    const [tempEquipmentOverride, setTempEquipmentOverride] = useState(gymProfile.equipment || {});

                    // Initializing with existing best lift for the currently selected exercise
                    useEffect(() => {
                        const currentBest = bestLifts[exerciseName] || { weight: 0, reps: 0 };
                        setWeight(currentBest.weight || 0);
                        setReps(currentBest.reps || 8);
                    }, [exerciseName, bestLifts]);

                    // Initialize tempEquipmentOverride when gymProfile loads or changes
                    useEffect(() => {
                        setTempEquipmentOverride(gymProfile.equipment || {});
                    }, [gymProfile]);


                    // Determine available exercises based on config (focus) and equipment
                    const getSuggestedExercises = useCallback(() => {
                        const targetSplit = workoutConfig.split;
                        const currentAvailableEquipment = tempEquipmentOverride; 
                        
                        // Determine target muscles based on the selected split or specific muscle selection
                        const targetMuscles = targetSplit === 'Specific Muscles' 
                            ? workoutConfig.muscleSelection 
                            : SPLIT_MUSCLE_MAPPING[targetSplit] || []; // Uses the refined SPLIT_MUSCLE_MAPPING
                            
                        if (targetMuscles.length === 0) return [];

                        return EXERCISE_CATALOG
                            .filter(ex => 
                                // 1. Filter by Muscle Target: Exercise primary muscle must intersect with the target muscle list
                                ex.primary.some(muscle => targetMuscles.includes(muscle))
                            )
                            .filter(ex => 
                                // 2. Filter by Available Equipment: All required equipment for the exercise must be available
                                ex.equipment.every(requiredKey => 
                                    // Check if the required key exists and is checked in any equipment category (weights, cardio, floorSpace)
                                    Object.values(currentAvailableEquipment).some(category => category?.[requiredKey])
                                )
                            )
                            .map(ex => ex.name); 
                    }, [workoutConfig, tempEquipmentOverride]); // Dependencies ensure re-calculation on config or equipment change
                    
                    // Cache the suggested exercises
                    const suggestedExercises = getSuggestedExercises();
                    const currentBestLift = bestLifts[exerciseName] || { weight: 0, reps: 0 };
                    
                    // If the selected exercise is no longer in the suggested list, reset it
                    useEffect(() => {
                        if (exerciseName && !suggestedExercises.includes(exerciseName)) {
                            setExerciseName('');
                        }
                    }, [suggestedExercises, exerciseName]);
                    
                    // Add a new exercise to the active workout log
                    const addExercise = (e) => {
                        e.preventDefault();
                        if (!exerciseName || sets <= 0 || reps <= 0) return;
                        
                        const newExercise = {
                            id: Date.now(),
                            name: exerciseName,
                            setLogs: Array.from({ length: sets }, () => ({
                                reps: reps,
                                weight: weight,
                            })),
                            totalVolume: 0,
                        };
                        
                        // Calculate total volume for the newly added exercise
                        newExercise.totalVolume = newExercise.setLogs.reduce((sum, log) => sum + (log.reps * log.weight), 0);

                        setActiveWorkout(prev => [...prev, newExercise]);
                        
                        // Reset form for next exercise (keep weight/reps from previous set)
                        setExerciseName('');
                        setSets(3);
                        // weight/reps are kept to make logging similar lifts easier
                    };
                    
                    // Update reps/weight for an individual set log
                    const updateSetLog = (exerciseId, setIndex, field, value) => {
                        setActiveWorkout(prev => prev.map(ex => {
                            if (ex.id === exerciseId) {
                                const newSetLogs = ex.setLogs.map((set, i) => 
                                    i === setIndex ? { ...set, [field]: value } : set
                                );
                                // Recalculate total volume
                                const newTotalVolume = newSetLogs.reduce((sum, log) => sum + (log.reps * log.weight), 0);
                                return { ...ex, setLogs: newSetLogs, totalVolume: newTotalVolume };
                            }
                            return ex;
                        }));
                    };

                    const saveWorkout = async () => {
                        if (!userId || activeWorkout.length === 0 || isSaving) return;
                        setIsSaving(true);
                        
                        try {
                            // 1. Save Workout History
                            const historyColRef = collection(db, getWorkoutHistoryCollectionPath());
                            await addDoc(historyColRef, {
                                userId: userId,
                                sessionName: workoutConfig.sessionName || 'Untitled Session',
                                split: workoutConfig.split,
                                date: new Date().toISOString(),
                                exercises: activeWorkout,
                                totalSessionVolume: activeWorkout.reduce((sum, ex) => sum + ex.totalVolume, 0),
                            });
                            
                            // 2. Update Best Lifts (based on highest weight or highest volume at equal weight)
                            for (const ex of activeWorkout) {
                                // Find the best single set in the current session based on PR logic (Volume first, then Weight)
                                let sessionBestSet = { weight: 0, reps: 0, volume: 0 };
                                
                                for (const set of ex.setLogs) {
                                    const volume = set.reps * set.weight;
                                    
                                    // Primary check: Highest Volume
                                    if (volume > sessionBestSet.volume) {
                                        sessionBestSet = { weight: set.weight, reps: set.reps, volume: volume };
                                    } else if (volume === sessionBestSet.volume && set.weight > sessionBestSet.weight) {
                                        // Volume Tie-breaker: Prefer set with higher weight
                                        sessionBestSet = { weight: set.weight, reps: set.reps, volume: volume };
                                    }
                                }

                                const currentBest = bestLifts[ex.name] || { weight: 0, reps: 0 };
                                const currentBestVolume = currentBest.weight * currentBest.reps;
                                
                                // Only update if the session best set is better than the current overall best
                                if (sessionBestSet.volume > currentBestVolume) {
                                    const bestLiftRef = doc(db, getBestLiftsCollectionPath(), ex.name);
                                    await setDoc(bestLiftRef, { 
                                        weight: sessionBestSet.weight, 
                                        reps: sessionBestSet.reps,
                                        volume: sessionBestSet.volume,
                                        date: new Date().toISOString()
                                    });
                                    // Update local state
                                    setBestLifts(prev => ({ 
                                        ...prev, 
                                        [ex.name]: { 
                                            weight: sessionBestSet.weight, 
                                            reps: sessionBestSet.reps, 
                                            volume: sessionBestSet.volume 
                                        } 
                                    }));
                                }
                            }

                            console.log('Workout saved successfully! Total Volume: ' + activeWorkout.reduce((sum, ex) => sum + ex.totalVolume, 0) + ' kg');
                            
                            // Reset and navigate
                            setActiveWorkout([]);
                            setWorkoutConfig({ split: workoutSplits[0], muscleSelection: [], sessionName: '' });
                            navigate('dashboard');
                            
                        } catch (err) {
                            console.error("Failed to save workout:", err);
                            setError("Failed to save workout data.");
                        } finally {
                            setIsSaving(false);
                        }
                    };

                    return (
                        <div className="space-y-6">
                            
                            {/* Navigation Buttons */}
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => navigate('start-workout')} className="text-sm px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center">
                                    &#8592; Back to Config
                                </button>
                                <button onClick={() => navigate('dashboard')} className="text-sm px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 text-gray-700">
                                    Go to Dashboard
                                </button>
                            </div>

                            <h2 className="text-3xl font-bold text-gray-800 text-center">{workoutConfig.sessionName || 'Active Workout'}</h2>
                            <div className="text-sm text-gray-500 text-center">Focus: {workoutConfig.split}</div>
                            
                            {/* Current Workout Summary */}
                            <div className="p-4 bg-gray-100 rounded-xl shadow-inner space-y-3">
                                <p className="font-bold text-lg text-gray-800">Exercises Logged: {activeWorkout.length}</p>
                                <p className="text-sm text-gray-600">Total Volume: {activeWorkout.reduce((sum, ex) => sum + ex.totalVolume, 0)} kg</p>
                            </div>

                            {/* Log New Exercise Form */}
                            <form onSubmit={addExercise} className="p-4 border border-gray-300 rounded-xl shadow-md space-y-3 relative">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="text-xl font-semibold" style={{ color: VFIT_PRIMARY }}>Add Exercise</h3>
                                    {/* Equipment Adjuster Button */}
                                    <button 
                                        type="button" 
                                        onClick={() => setIsEquipmentModalOpen(true)}
                                        className="text-sm px-3 py-1 rounded-full text-white font-medium hover:bg-opacity-90 transition"
                                        style={{ backgroundColor: VFIT_ACCENT }}>
                                        Edit Equipment
                                    </button>
                                </div>
                                
                                {/* Exercise Dropdown */}
                                <div>
                                    <select 
                                        value={exerciseName}
                                        onChange={(e) => setExerciseName(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }}>
                                        <option value="">-- Select Exercise --</option>
                                        {suggestedExercises.length === 0 ? (
                                            <option disabled>No exercises found for this focus or equipment.</option>
                                        ) : (
                                            suggestedExercises.map(ex => <option key={ex} value={ex}>{ex}</option>)
                                        )}
                                    </select>
                                </div>

                                {/* Sets, Reps, Weight Inputs */}
                                <div className="grid grid-cols-3 gap-2">
                                    <CounterInput label="Sets" value={sets} setValue={setSets} min={1} />
                                    <CounterInput label="Reps" value={reps} setValue={setReps} min={1} />
                                    <CounterInput label="Weight (kg)" value={weight} setValue={setWeight} min={0} bestLift={currentBestLift} />
                                </div>

                                <button 
                                    type="submit" 
                                    className="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition"
                                    disabled={suggestedExercises.length === 0 || !exerciseName}>
                                    ADD TO WORKOUT
                                </button>
                                {suggestedExercises.length === 0 && (
                                    <p className="text-red-500 text-xs mt-2 text-center">No exercises available. Adjust focus or equipment.</p>
                                )}
                            </form>

                            {/* Logged Exercises */}
                            <div className="space-y-4">
                                {activeWorkout.map((ex, exIndex) => (
                                    <div key={ex.id} className="p-3 bg-white rounded-lg shadow border border-gray-200">
                                        <h4 className="font-bold text-lg text-gray-800">{ex.name} (Volume: {ex.totalVolume} kg)</h4>
                                        <div className="mt-2 space-y-2">
                                            {ex.setLogs.map((set, setIndex) => (
                                                <SetLogEditor
                                                    key={setIndex}
                                                    setIndex={setIndex}
                                                    setLog={set}
                                                    updateLog={(field, value) => updateSetLog(ex.id, setIndex, field, value)}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Finish Workout Button */}
                            <button 
                                onClick={saveWorkout}
                                disabled={activeWorkout.length === 0 || isSaving}
                                style={{ backgroundColor: activeWorkout.length > 0 ? VFIT_ACCENT : 'gray' }}
                                className="w-full py-3 text-white font-extrabold rounded-lg shadow-xl hover:opacity-90 transition disabled:opacity-50">
                                {isSaving ? 'Saving Workout...' : 'FINISH & SAVE WORKOUT'}
                            </button>
                            
                            {/* Equipment Modal */}
                            <GymEquipmentModal 
                                isOpen={isEquipmentModalOpen} 
                                onClose={() => setIsEquipmentModalOpen(false)}
                                initialEquipment={tempEquipmentOverride}
                                onSave={setTempEquipmentOverride}
                            />
                        </div>
                    );
                };
                
                // --- VIEW 6: HISTORY ---

                const HistoryView = () => {
                    const [activeTab, setActiveTab] = useState('workouts');
                    
                    // Helper to format date
                    const formatDate = (isoString) => {
                        const date = new Date(isoString);
                        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    };
                    
                    // Find the best set (PR) in a given list of set logs for an exercise
                    const getExercisePR = (setLogs) => {
                        let volumePR = { weight: 0, reps: 0, volume: 0 };
                        let weightPR = { weight: 0, reps: 0 }; 

                        for (const set of setLogs) {
                            const volume = set.weight * set.reps;
                            
                            // 1. Volume PR Calculation (Primary metric)
                            if (volume > volumePR.volume) {
                                volumePR = { weight: set.weight, reps: set.reps, volume: volume };
                            } else if (volume === volumePR.volume && set.weight > volumePR.weight) {
                                // Volume Tie-breaker: Prefer set with higher weight
                                volumePR = { weight: set.weight, reps: set.reps, volume: volume };
                            }

                            // 2. Max Weight PR Calculation
                            if (set.weight > weightPR.weight) {
                                weightPR = { weight: set.weight, reps: set.reps };
                            } else if (set.weight === weightPR.weight && set.reps > weightPR.reps) {
                                // Max Weight Tie-breaker: Same weight, higher reps is better for the 1RM estimation
                                weightPR = { weight: set.weight, reps: set.reps };
                            }
                        }
                        return { volumePR, weightPR };
                    };

                    const WorkoutHistoryTab = () => (
                        <div className="space-y-4 pt-4">
                            {workoutHistory.length === 0 ? (
                                <div className="p-4 bg-blue-100 rounded-lg text-blue-700 text-center">
                                    No workouts logged yet. Start a session from the Dashboard!
                                </div>
                            ) : (
                                workoutHistory.map(workout => (
                                    <div key={workout.id} className="p-4 bg-white rounded-xl shadow border border-gray-200">
                                        <div className="flex justify-between items-start mb-2 border-b pb-2">
                                            <h3 className="text-xl font-bold" style={{ color: VFIT_PRIMARY }}>
                                                {workout.sessionName}
                                            </h3>
                                            <div className="text-right">
                                                <p className="text-sm font-medium text-gray-500">{formatDate(workout.date)}</p>
                                                <p className="text-xs text-gray-400">Split: {workout.split}</p>
                                            </div>
                                        </div>
                                        
                                        <p className="text-sm font-semibold text-gray-700 mb-3">Total Volume: {workout.totalSessionVolume} kg</p>

                                        <div className="space-y-2">
                                            {workout.exercises.map((ex, exIndex) => {
                                                const { volumePR, weightPR } = getExercisePR(ex.setLogs);
                                                
                                                // Check if the Max Volume set and the Max Weight set are the exact same
                                                const isSameSet = volumePR.weight === weightPR.weight && volumePR.reps === weightPR.reps;
                                                
                                                return (
                                                    <div key={exIndex} className="p-2 bg-gray-50 rounded-lg">
                                                        <h4 className="text-md font-semibold text-gray-800">{ex.name}</h4>
                                                        
                                                        {/* Max Volume PR Display */}
                                                        <div className="mt-1 text-xs flex justify-between items-center text-gray-600">
                                                            <span className="font-bold text-gray-700">Max Volume:</span>
                                                            <span className="text-green-600 font-medium">
                                                                {volumePR.weight} kg x {volumePR.reps} reps
                                                            </span>
                                                        </div>

                                                        {/* Max Weight PR Display (Only if it's a different set) */}
                                                        {!isSameSet && (
                                                            <div className="mt-0.5 text-xs flex justify-between items-center text-gray-600">
                                                                <span className="font-bold text-gray-700">Max Weight:</span>
                                                                <span className="text-blue-600 font-medium">
                                                                    {weightPR.weight} kg ({weightPR.reps} reps)
                                                                </span>
                                                            </div>
                                                        )}

                                                        {/* Detailed Sets - collapsed by default for brevity */}
                                                        <details className="mt-1 text-xs">
                                                            <summary className="cursor-pointer text-gray-500 hover:text-gray-700">View All Sets ({ex.setLogs.length})</summary>
                                                            <ul className="list-disc pl-5 mt-1 space-y-0.5">
                                                                {ex.setLogs.map((set, setIndex) => (
                                                                    <li key={setIndex} className="text-gray-500">
                                                                        Set {setIndex + 1}: {set.weight} kg x {set.reps} reps (Volume: {set.weight * set.reps} kg)
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </details>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    );

                    const MealHistoryTab = () => (
                        <div className="space-y-4 pt-4">
                            <div className="p-4 bg-yellow-100 rounded-lg text-yellow-700 text-center">
                                Meal logging feature is not yet fully implemented.
                            </div>
                            {/* Placeholder for meal history list */}
                            {mealHistory.length === 0 ? (
                                <div className="p-4 bg-gray-100 rounded-lg text-gray-500 text-center">
                                    No meals logged.
                                </div>
                            ) : (
                                // Meal list rendering here...
                                <div>Meal log goes here</div>
                            )}
                        </div>
                    );

                    return (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => navigate('dashboard')} className="text-sm px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center">
                                    &#8592; Back to Dashboard
                                </button>
                                <h2 className="text-3xl font-bold text-gray-800">History</h2>
                                <div></div> {/* Spacer */}
                            </div>
                            

                            {/* Tab Navigation */}
                            <div className="flex border-b border-gray-300">
                                <button 
                                    onClick={() => setActiveTab('workouts')}
                                    className={`py-2 px-4 font-semibold ${activeTab === 'workouts' ? 'border-b-2 text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                    style={{ borderBottomColor: activeTab === 'workouts' ? VFIT_PRIMARY : 'transparent' }}>
                                    Workout Logs
                                </button>
                                <button 
                                    onClick={() => setActiveTab('meals')}
                                    className={`py-2 px-4 font-semibold ${activeTab === 'meals' ? 'border-b-2 text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                    style={{ borderBottomColor: activeTab === 'meals' ? VFIT_PRIMARY : 'transparent' }}>
                                    Meal Logs
                                </button>
                            </div>

                            {/* Tab Content */}
                            {activeTab === 'workouts' ? <WorkoutHistoryTab /> : <MealHistoryTab />}

                        </div>
                    );
                };

                // --- SUB-COMPONENTS (shared) ---
                
                // Quick Equipment Adjuster Modal
                const GymEquipmentModal = ({ isOpen, onClose, initialEquipment, onSave }) => {
                    const [tempProfile, setTempProfile] = useState(initialEquipment);

                    useEffect(() => {
                        // Reset temp profile when modal opens with new initial data
                        if (isOpen) {
                            setTempProfile(initialEquipment);
                        }
                    }, [isOpen, initialEquipment]);

                    const handleCheckboxChange = (category, key, checked) => {
                        setTempProfile(prev => ({
                            ...prev,
                            [category]: {
                                ...(prev[category] || {}),
                                [key]: checked,
                            }
                        }));
                    };

                    const handleSave = () => {
                        onSave(tempProfile);
                        onClose();
                    };

                    if (!isOpen) return null;

                    return (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                                <h3 className="text-2xl font-bold" style={{ color: VFIT_PRIMARY }}>
                                    Quick Equipment Adjuster
                                </h3>
                                <p className="text-sm text-gray-600">
                                    These changes only affect the suggested exercises for the current session.
                                </p>

                                {Object.entries(gymEquipment).map(([category, items]) => (
                                    <div key={category} className="p-3 border rounded-lg bg-gray-50">
                                        <h4 className="font-semibold capitalize mb-2">{category.replace(/([A-Z])/g, ' $1')}</h4>
                                        <div className="grid grid-cols-2 gap-2 text-sm">
                                            {items.map(item => (
                                                <div key={item.key} className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        id={`modal-${item.key}`}
                                                        checked={tempProfile[category]?.[item.key] || false}
                                                        onChange={(e) => handleCheckboxChange(category, item.key, e.target.checked)}
                                                        className="h-4 w-4 rounded border-gray-300"
                                                        style={{ color: VFIT_ACCENT, borderColor: VFIT_ACCENT }}
                                                    />
                                                    <label htmlFor={`modal-${item.key}`} className="ml-2 text-gray-700 cursor-pointer">
                                                        {item.icon} {item.name}
                                                    </label>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}

                                <button 
                                    onClick={handleSave}
                                    style={{ backgroundColor: VFIT_PRIMARY }}
                                    className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300">
                                    Apply Changes
                                </button>
                                <button 
                                    onClick={onClose}
                                    className="w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-300">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    );
                };

                const CounterInput = ({ label, value, setValue, min = 0, bestLift = null }) => (
                    <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">{label}
                            {bestLift && label.includes('Weight') && bestLift.weight > 0 && 
                                <span className="ml-1 text-xs text-green-500 font-normal"> (PR: {bestLift.weight}kg x {bestLift.reps}r)</span>
                            }
                        </label>
                        <div className="flex items-center space-x-1">
                            <button type="button" onClick={() => setValue(Math.max(min, value - 1))} className="p-1 bg-gray-200 rounded-lg hover:bg-gray-300 w-8">-</button>
                            <input 
                                type="number" 
                                value={value} 
                                onChange={(e) => setValue(Math.max(min, Number(e.target.value)))} 
                                className="w-full text-center p-1 border rounded-lg"
                            />
                            <button type="button" onClick={() => setValue(value + 1)} className="p-1 bg-gray-200 rounded-lg hover:bg-gray-300 w-8">+</button>
                        </div>
                    </div>
                );
                
                const SetLogEditor = ({ setIndex, setLog, updateLog }) => (
                    <div className="flex items-center space-x-2 bg-gray-50 p-2 rounded-md">
                        <span className="font-medium w-8 text-center text-gray-600">Set {setIndex + 1}</span>
                        
                        <div className="flex-1 flex items-center space-x-1">
                            <CounterInput label="Reps" value={setLog.reps} setValue={(val) => updateLog('reps', val)} min={1} />
                        </div>
                        
                        <div className="flex-1 flex items-center space-x-1">
                            <CounterInput label="Weight" value={setLog.weight} setValue={(val) => updateLog('weight', val)} min={0} />
                        </div>
                    </div>
                );

                // --- MAIN RENDERER ---

                const renderView = () => {
                    switch (view) {
                        case 'login':
                            return <LoginView />;
                        case 'register':
                            return <RegisterView />;
                        case 'gym-setup':
                            return <GymSetupView />;
                        case 'start-workout':
                            return <StartWorkoutView />;
                        case 'active-workout':
                            return <ActiveWorkoutView />;
                        case 'history':
                            return <HistoryView />;
                        case 'dashboard':
                        default:
                            return <DashboardView />;
                    }
                };

                return (
                    <div className="min-h-screen bg-gray-100">
                        {/* Sticky Header: Dark Grey BG, Dark Orange VFit Text */}
                        <header className="fixed top-0 left-0 right-0 w-full h-16 shadow-xl z-50 flex items-center justify-center" style={{ backgroundColor: VFIT_DARK_BG }}>
                            <h1 
                                style={{ color: VFIT_PRIMARY }}
                                className="text-3xl font-extrabold tracking-widest uppercase cursor-pointer" 
                                onClick={() => navigate('dashboard')}>
                                VFit
                            </h1>
                        </header>

                        <main className="pt-16 min-h-screen flex items-start justify-center p-4 sm:p-6 lg:p-8">
                            <div className="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 sm:p-8">

                                {/* Global Error Display */}
                                {error && (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
                                        {error}
                                        <button onClick={() => setError(null)} className="ml-4 font-bold float-right">X</button>
                                    </div>
                                )}

                                {/* Content Router */}
                                {!dbReady ? <LoadingSpinner /> : renderView()}
                            </div>
                        </main>
                    </div>
                );
            };

            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<VFitApp />);
        };
        
        // Wait for the Firebase script (type="module") to execute and populate window.firebase
        window.onload = () => {
            // Check for the presence of the global firebase object before running the app
            if (window.firebase) {
                window.runVFitApp();
            } else {
                console.error("Firebase modules not loaded. Cannot run VFitApp.");
                document.getElementById('root').innerHTML = '<div class="text-center p-10 text-red-600">Error: Firebase modules failed to load.</div>';
            }
        };

    </script>
</body>
</html>

    ],
    floorSpace: [
        { key: 'trx', name: 'TRX', icon: 'üéóÔ∏è' },
        { key: 'ropes', name: 'Ropes', icon: '‚û∞' },
        { key: 'sandbag', name: 'Sandbag', icon: 'üçö' },
        { key: 'medicine_ball', name: 'Medicine Ball', icon: 'üèÄ' },
        { key: 'slam_ball', name: 'Slam Ball', icon: 'üèê' },
    ],
};

// --- EXERCISE CATALOG & MAPPING ---
const EXERCISE_CATALOG = [
    // Compounds & Bench/Barbell movements
    { name: 'Barbell Squat', primary: ['Quads', 'Glutes'], equipment: ['barbell'] },
    { name: 'Bench Press', primary: ['Chest', 'Triceps', 'Shoulders'], equipment: ['barbell', 'bench'] },
    { name: 'Deadlift', primary: ['Hamstrings', 'Glutes', 'Upper Back'], equipment: ['barbell'] },
    { name: 'Overhead Press', primary: ['Shoulders', 'Triceps'], equipment: ['barbell'] },
    { name: 'Barbell Row', primary: ['Lats', 'Upper Back'], equipment: ['barbell'] },
    
    // Dumbbell movements
    { name: 'Dumbbell Curl', primary: ['Biceps'], equipment: ['dumbbell'] },
    { name: 'Incline Dumbbell Press', primary: ['Chest', 'Shoulders'], equipment: ['dumbbell', 'bench'] },
    { name: 'Lateral Raise (Dumbbell)', primary: ['Shoulders'], equipment: ['dumbbell'] },
    { name: 'Bulgarian Split Squat', primary: ['Quads', 'Glutes'], equipment: ['dumbbell', 'bench'] },

    // Cable/Machine movements
    { name: 'Triceps Pushdown', primary: ['Triceps'], equipment: ['cables'] },
    { name: 'Leg Extension', primary: ['Quads'], equipment: ['weighted_machines', 'pinstack'] },
    { name: 'Leg Curl', primary: ['Hamstrings'], equipment: ['weighted_machines', 'pinstack'] },
    { name: 'Cable Fly', primary: ['Chest'], equipment: ['cables'] },
    { name: 'Face Pull', primary: ['Shoulders', 'Upper Back'], equipment: ['cables'] },
    { name: 'Lat Pulldown', primary: ['Lats'], equipment: ['weighted_machines', 'pinstack', 'cables'] },

    // Bodyweight/Other
    { name: 'Ab Rollout', primary: ['Abs'], equipment: ['floorSpace'] },
    { name: 'Push-ups', primary: ['Chest', 'Triceps'], equipment: ['floorSpace'] },
    { name: 'Pull-ups/Chin-ups', primary: ['Lats', 'Biceps'], equipment: ['floorSpace'] },
];

const SPLIT_MUSCLE_MAPPING = {
    'Full Body': ['Chest', 'Lats', 'Upper Back', 'Quads', 'Hamstrings', 'Glutes', 'Shoulders', 'Biceps', 'Triceps', 'Abs'],
    'Upper Body': ['Chest', 'Lats', 'Upper Back', 'Shoulders', 'Biceps', 'Triceps'],
    'Lower Body': ['Quads', 'Hamstrings', 'Glutes', 'Calves'],
    'Press': ['Chest', 'Shoulders', 'Triceps'],
    'Pull': ['Lats', 'Upper Back', 'Biceps'],
    'Squat': ['Quads', 'Glutes'],
    'Hinge': ['Hamstrings', 'Glutes', 'Upper Back'],
    // 'Specific Muscles' will use workoutConfig.muscleSelection directly
};
// --- END CONSTANTS ---


// --- FIREBASE INITIALIZATION ---
let auth;
let db;

const VFitApp = () => {
    // --- APP STATE ---
    /** @type {[View, Function]} */
    const [view, setView] = useState('login');
    const [user, setUser] = useState(null);
    const [dbReady, setDbReady] = useState(false);
    const [error, setError] = useState(null);
    
    // User Data State
    const [gymProfile, setGymProfile] = useState({});
    const [bestLifts, setBestLifts] = useState({}); // {exerciseId: {weight: 100, reps: 5}}
    const [userProfile, setUserProfile] = useState({ name: 'Fit User', goal: 'Strength Gain' });
    const [workoutHistory, setWorkoutHistory] = useState([]);
    const [mealHistory, setMealHistory] = useState([]); // Placeholder for meal history

    // Workout State (used across Start/Active views)
    const [workoutConfig, setWorkoutConfig] = useState({
        split: workoutSplits[0],
        muscleSelection: [],
        sessionName: '',
    });
    const [activeWorkout, setActiveWorkout] = useState([]);

    // Computed values
    const userId = user ? user.uid : null;
    const isAuthenticated = !!user;

    // --- FIREBASE INTEGRATION & LIFECYCLE ---

    // 1. Initialization and Auth Listener
    useEffect(() => {
        setLogLevel('debug');

        const initializeFirebase = async () => {
            try {
                if (auth && db) { setDbReady(true); return; }

                const firebaseConfig = JSON.parse(
                    typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'
                );
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Auth Listener: Triggers state updates
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    setDbReady(true);
                });
                
                // Initial Sign-in
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }

                return () => unsubscribe();
            } catch (err) {
                console.error('Firebase initialization failed:', err);
                setError('Failed to initialize application.');
                setDbReady(true);
            }
        };

        initializeFirebase();
    }, []);

    // 2. View Synchronization & Data Fetching
    useEffect(() => {
        if (!dbReady) return;
        
        if (isAuthenticated && userId) {
            setView('dashboard');
            fetchUserData(userId);
        } else {
            setView('login');
        }
    }, [isAuthenticated, dbReady, userId]);

    // 3. Real-time History Listener
    useEffect(() => {
        if (!db || !userId) return;

        const workoutColRef = collection(db, getWorkoutHistoryCollectionPath());
        // Note: For history, sorting by date is ideal, but Firestore's orderBy() requires an index.
        // We will fetch and sort in memory to avoid index requirements in this single-file app.
        const unsubscribeWorkout = onSnapshot(workoutColRef, (snapshot) => {
            const historyList = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                historyList.push({ id: doc.id, ...data });
            });
            // Sort by date descending (newest first) in memory
            historyList.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setWorkoutHistory(historyList);
        }, (err) => {
            console.error("Error listening to workout history:", err);
            setError("Failed to load workout history.");
        });

        // Placeholder for Meal History Listener
        // const mealColRef = collection(db, getMealHistoryCollectionPath());
        // const unsubscribeMeal = onSnapshot(mealColRef, (snapshot) => { ... });

        return () => {
            unsubscribeWorkout();
            // unsubscribeMeal();
        };

    }, [db, userId]);

    // --- DATA HANDLING ---

    const getPrivateDocPath = (docId) => `artifacts/${__app_id}/users/${userId}/config/${docId}`;
    const getBestLiftsCollectionPath = () => `artifacts/${__app_id}/users/${userId}/bestLifts`;
    const getWorkoutHistoryCollectionPath = () => `artifacts/${__app_id}/users/${userId}/workoutHistory`;
    // const getMealHistoryCollectionPath = () => `artifacts/${__app_id}/users/${userId}/mealHistory`; // Placeholder path

    const fetchUserData = async (uid) => {
        if (!db || !uid) return;

        // Fetch Gym Profile
        const gymRef = doc(db, getPrivateDocPath('gymProfile'));
        const gymSnap = await getDoc(gymRef);
        if (gymSnap.exists()) {
            setGymProfile(gymSnap.data());
        }

        // Fetch User Profile (Name/Goal)
        const userRef = doc(db, getPrivateDocPath('userProfile'));
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
            setUserProfile({ ...userProfile, ...userSnap.data() });
        }
        
        // Fetch Best Lifts (Simplification: fetch all for now, in a real app, query is better)
        const bestLiftsSnap = await getDocs(collection(db, getBestLiftsCollectionPath()));
        const lifts = {};
        bestLiftsSnap.forEach(d => {
            lifts[d.id] = d.data();
        });
        setBestLifts(lifts);
    };
    
    // --- NAVIGATION & AUTH HELPERS ---

    /** @param {View} newView */
    const navigate = (newView) => {
        if (newView === 'dashboard' && !isAuthenticated) return;
        setView(newView);
    };

    const handleLogout = async () => {
        try {
            await signOut(auth);
            console.log('User logged out successfully.');
            setGymProfile({});
            setUserProfile({ name: 'Fit User', goal: 'Strength Gain' });
            navigate('login'); // Navigation back to login
        } catch (err) {
            console.error('Logout failed:', err);
            setError('Logout failed. Please try again.');
        }
    };
    
    // --- UI COMPONENTS ---

    const LoadingSpinner = () => (
        <div className="text-center py-10">
            <p className="text-xl font-semibold text-gray-700 mb-4">Initializing Application...</p>
            <div className="animate-spin rounded-full h-10 w-10 border-b-2 mx-auto" style={{ borderBottomColor: VFIT_PRIMARY }}></div>
        </div>
    );
    
    // --- VIEW 1: AUTH ---

    const LoginView = () => (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-gray-800 text-center">Login to VFit</h2>
            <form onSubmit={(e) => { e.preventDefault(); if (isAuthenticated) navigate('dashboard'); }} className="space-y-4">
                <input type="email" placeholder="Email (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                <input type="password" placeholder="Password (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                <button type="submit" 
                        style={{ backgroundColor: VFIT_PRIMARY }}
                        className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-300">
                    Sign In
                </button>
            </form>
            <p className="text-center text-sm text-gray-600">
                Don't have an account? 
                <span onClick={() => navigate('register')} style={{ color: VFIT_PRIMARY }} className="font-medium cursor-pointer hover:underline">Register here</span>
            </p>
        </div>
    );

    const RegisterView = () => (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-gray-800 text-center">Join VFit</h2>
            <form onSubmit={(e) => { e.preventDefault(); navigate('login'); }} className="space-y-4">
                <input type="text" placeholder="Username (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                <input type="email" placeholder="Email (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                <input type="password" placeholder="Password (dummy)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                <button type="submit" 
                        style={{ backgroundColor: VFIT_PRIMARY }}
                        className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300">
                    Create Account
                </button>
            </form>
            <p className="text-center text-sm text-gray-600">
                Already have an account? 
                <span onClick={() => navigate('login')} style={{ color: VFIT_PRIMARY }} className="font-medium cursor-pointer hover:underline">Sign In</span>
            </p>
        </div>
    );
    
    // --- VIEW 2: GYM SETUP ---
    
    const GymSetupView = () => {
        const [tempProfile, setTempProfile] = useState(gymProfile.equipment || {});
        const [isSaving, setIsSaving] = useState(false);

        const handleCheckboxChange = (category, key, checked) => {
            setTempProfile(prev => ({
                ...prev,
                [category]: {
                    ...(prev[category] || {}),
                    [key]: checked,
                }
            }));
        };

        const saveGymProfile = async () => {
            if (!userId || isSaving) return;
            setIsSaving(true);
            try {
                const gymRef = doc(db, getPrivateDocPath('gymProfile'));
                await setDoc(gymRef, { equipment: tempProfile, updateDate: new Date() });
                setGymProfile({ equipment: tempProfile }); // Update local state
                navigate('dashboard');
            } catch (err) {
                console.error("Failed to save gym profile:", err);
                setError("Failed to save gym profile.");
            } finally {
                setIsSaving(false);
            }
        };

        return (
            <div className="space-y-6">
                <h2 className="text-3xl font-bold text-gray-800 text-center mb-6">Set Up Your Training</h2>
                <div className="text-sm text-gray-600 text-center">
                    Select the equipment available at your gym. This helps customize your workout suggestions.
                </div>

                {Object.entries(gymEquipment).map(([category, items]) => (
                    <div key={category} className="p-4 border rounded-xl bg-gray-50 shadow-sm">
                        <h3 className="text-xl font-semibold capitalize mb-3" style={{ color: VFIT_PRIMARY }}>
                            {category.replace(/([A-Z])/g, ' $1')}
                        </h3>
                        <div className="grid grid-cols-2 gap-3">
                            {items.map(item => (
                                <div key={item.key} className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id={item.key}
                                        checked={tempProfile[category]?.[item.key] || false}
                                        onChange={(e) => handleCheckboxChange(category, item.key, e.target.checked)}
                                        className="h-4 w-4 rounded border-gray-300"
                                        style={{ color: VFIT_PRIMARY, borderColor: VFIT_PRIMARY }}
                                    />
                                    <label htmlFor={item.key} className="ml-2 text-sm font-medium text-gray-700 cursor-pointer">
                                        {item.icon} {item.name}
                                    </label>
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
                
                <button 
                    onClick={saveGymProfile}
                    disabled={isSaving}
                    style={{ backgroundColor: VFIT_PRIMARY }}
                    className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300 disabled:opacity-50">
                    {isSaving ? 'Saving...' : 'Save Gym Profile'}
                </button>
            </div>
        );
    };

    // --- VIEW 3: DASHBOARD ---

    const DashboardView = () => {
        
        const [logType, setLogType] = useState('workout'); // 'workout' or 'meal'
        // No longer need isAdding state

        const handleAddLog = (e) => {
            e.preventDefault();
            if (logType === 'workout') {
                navigate('start-workout');
            } else {
                // Meal logging implementation would go here
                console.log('Meal logging feature placeholder!');
            }
        };

        const renderLogForm = () => (
            <form onSubmit={handleAddLog} className="space-y-4">
                <div className="flex space-x-4">
                    <button 
                        type="button" 
                        onClick={() => setLogType('workout')}
                        className={`flex-1 py-2 rounded-lg font-semibold transition ${logType === 'workout' ? 'text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                        style={{ backgroundColor: logType === 'workout' ? VFIT_PRIMARY : '' }}
                    >
                        Add Workout
                    </button>
                    <button 
                        type="button" 
                        onClick={() => setLogType('meal')}
                        className={`flex-1 py-2 rounded-lg font-semibold transition ${logType === 'meal' ? 'text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                        style={{ backgroundColor: logType === 'meal' ? VFIT_PRIMARY : '' }}
                    >
                        Add Meal
                    </button>
                </div>

                <div className="bg-white p-4 rounded-xl shadow border border-gray-200">
                    {logType === 'workout' ? (
                        <div>
                            <p className="text-gray-700 font-semibold mb-2">Log a new training session.</p>
                            <button 
                                type="submit" 
                                style={{ backgroundColor: VFIT_PRIMARY }}
                                className="w-full py-2 text-white font-semibold rounded-lg hover:opacity-90 transition">
                                START WORKOUT
                            </button>
                        </div>
                    ) : (
                        <div>
                            <input type="text" placeholder="Meal Name" className="w-full p-2 border border-gray-300 rounded-lg mb-2" />
                            <input type="text" placeholder="Calories (kcal)" className="w-full p-2 border border-gray-300 rounded-lg mb-2" />
                            <button 
                                type="submit" 
                                className="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                                LOG MEAL
                            </button>
                        </div>
                    )}
                </div>
            </form>
        );

        return (
            <div className="space-y-6">
                <h2 className="text-3xl font-bold text-gray-800 text-center">Dashboard</h2>

                {/* Profile Overview */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-blue-100 p-4 rounded-xl border-l-4 border-blue-500">
                        <p className="text-sm font-medium text-gray-500">Name</p>
                        <p className="text-xl font-bold text-gray-800">{userProfile.name}</p>
                    </div>
                    <div className="bg-purple-100 p-4 rounded-xl border-l-4 border-purple-500">
                        <p className="text-sm font-medium text-gray-500">Goal</p>
                        <p className="text-xl font-bold text-gray-800">{userProfile.goal}</p>
                    </div>
                </div>

                {/* Gym Setup Status */}
                <div className="p-4 rounded-xl border-2 border-dashed border-gray-300 text-center cursor-pointer hover:bg-gray-50 transition"
                     onClick={() => navigate('gym-setup')}>
                    <p className="text-lg font-semibold" style={{ color: VFIT_PRIMARY }}>
                        {Object.keys(gymProfile.equipment || {}).length > 0 ? 'Gym Profile Set Up' : 'Set Up Your Gym Profile'}
                    </p>
                    <p className="text-sm text-gray-500">
                        {Object.keys(gymProfile.equipment || {}).length > 0 ? 'Click to Review/Edit' : 'Define your available equipment.'}
                    </p>
                </div>

                {/* Log Activity */}
                {renderLogForm()}

                {/* History Button */}
                <button onClick={() => navigate('history')} 
                        className="w-full py-3 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 transition duration-300">
                    View Activity History
                </button>

                {/* Logout Button */}
                <button onClick={handleLogout} className="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Logout ({userId.substring(0, 4)})
                </button>
            </div>
        );
    };
    
    // --- VIEW 4: START WORKOUT CONFIG ---

    const StartWorkoutView = () => {
        // Move state management for the form locally to prevent parent re-renders on every keystroke.
        const [localSessionName, setLocalSessionName] = useState(workoutConfig.sessionName);
        const [localSplit, setLocalSplit] = useState(workoutConfig.split);
        const [localMuscleSelection, setLocalMuscleSelection] = useState(workoutConfig.muscleSelection);
        
        // Effect to initialize local state if parent workoutConfig changes (e.g., if navigated to dashboard and back)
        useEffect(() => {
            setLocalSessionName(workoutConfig.sessionName);
            setLocalSplit(workoutConfig.split);
            setLocalMuscleSelection(workoutConfig.muscleSelection);
        }, [workoutConfig]);


        const handleConfigChange = (e) => {
            const { name, value } = e.target;
            if (name === 'sessionName') {
                // Update local state, no parent re-render
                setLocalSessionName(value);
            } else if (name === 'split') {
                // Update local state for split
                setLocalSplit(value);
                // Reset muscle selection if we switch away from Specific Muscles
                if (value !== 'Specific Muscles') {
                    setLocalMuscleSelection([]);
                }
            }
        };

        const handleMuscleToggle = (muscle) => {
            // Update local state for muscle selection
            setLocalMuscleSelection(prev => {
                return prev.includes(muscle)
                    ? prev.filter(m => m !== muscle)
                    : [...prev, muscle];
            });
        };
        
        const startSession = (e) => {
            e.preventDefault();
            // 1. Validation using local state
            if (localSplit === 'Specific Muscles' && localMuscleSelection.length === 0) {
                 setError('Please select at least one muscle group.');
                 return;
            }
            if (!localSessionName) {
                 setError('Please enter a session name.');
                 return;
            }
            setError(null);
            
            // 2. Update parent state ONCE on successful submission
            setWorkoutConfig({
                split: localSplit,
                muscleSelection: localMuscleSelection,
                sessionName: localSessionName,
            });

            setActiveWorkout([]); // Reset active workout exercises
            navigate('active-workout');
        };

        return (
            <div className="space-y-6">
                <h2 className="text-3xl font-bold text-gray-800 text-center">Start Training Session</h2>
                <button onClick={() => navigate('dashboard')} className="text-sm text-gray-500 hover:text-gray-700 flex items-center mb-4">
                    &#8592; Back to Dashboard
                </button>

                <form onSubmit={startSession} className="space-y-4 p-4 border rounded-xl shadow-sm bg-white">
                    {/* Session Name */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Session Name</label>
                        <input 
                            type="text" 
                            name="sessionName"
                            // Use local state
                            value={localSessionName}
                            onChange={handleConfigChange}
                            placeholder="e.g., Heavy Lower Body Day" 
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }} />
                    </div>

                    {/* Workout Split */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Workout Split/Focus</label>
                        <select 
                            name="split"
                            // Use local state
                            value={localSplit}
                            onChange={handleConfigChange}
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }}>
                            <option value="">-- Select Split --</option>
                            {workoutSplits.map(split => <option key={split} value={split}>{split}</option>)}
                        </select>
                    </div>

                    {/* Muscle Checkboxes (Conditional) */}
                    {localSplit === 'Specific Muscles' && (
                        <div className="p-3 bg-gray-50 rounded-lg">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Select Muscle Groups:</label>
                            <div className="grid grid-cols-3 gap-2 text-sm">
                                {muscleGroups.map(muscle => (
                                    <div key={muscle} className="flex items-center">
                                        <input
                                            type="checkbox"
                                            id={`muscle-${muscle}`}
                                            // Use local state
                                            checked={localMuscleSelection.includes(muscle)}
                                            onChange={() => handleMuscleToggle(muscle)}
                                            className="h-4 w-4 rounded border-gray-300"
                                            style={{ color: VFIT_PRIMARY, borderColor: VFIT_PRIMARY }}
                                        />
                                        <label htmlFor={`muscle-${muscle}`} className="ml-1 text-gray-600 text-xs cursor-pointer">
                                            {muscle}
                                        </label>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Error Message */}
                    {error && <div className="text-red-600 text-sm">{error}</div>}

                    <button 
                        type="submit" 
                        style={{ backgroundColor: VFIT_PRIMARY }}
                        className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300">
                        START WORKOUT
                    </button>
                </form>
            </div>
        );
    };

    // --- VIEW 5: ACTIVE WORKOUT ---
    
    const ActiveWorkoutView = () => {
        const [exerciseName, setExerciseName] = useState('');
        const [sets, setSets] = useState(3);
        const [weight, setWeight] = useState(0);
        const [reps, setReps] = useState(8);
        const [isSaving, setIsSaving] = useState(false);
        const [isEquipmentModalOpen, setIsEquipmentModalOpen] = useState(false);
        
        // State for temporary session-specific equipment override
        // Initializing with existing profile, defaults to {} if profile is empty
        const [tempEquipmentOverride, setTempEquipmentOverride] = useState(gymProfile.equipment || {});

        // Initializing with existing best lift for the currently selected exercise
        useEffect(() => {
            const currentBest = bestLifts[exerciseName] || { weight: 0, reps: 0 };
            setWeight(currentBest.weight || 0);
            setReps(currentBest.reps || 8);
        }, [exerciseName, bestLifts]);

        // Initialize tempEquipmentOverride when gymProfile loads or changes
        useEffect(() => {
            setTempEquipmentOverride(gymProfile.equipment || {});
        }, [gymProfile]);


        // Determine available exercises based on config (focus) and equipment
        const getSuggestedExercises = useCallback(() => {
            const targetSplit = workoutConfig.split;
            const currentAvailableEquipment = tempEquipmentOverride; 
            
            // Determine target muscles based on the selected split or specific muscle selection
            const targetMuscles = targetSplit === 'Specific Muscles' 
                ? workoutConfig.muscleSelection 
                : SPLIT_MUSCLE_MAPPING[targetSplit] || []; // Uses the refined SPLIT_MUSCLE_MAPPING
                
            if (targetMuscles.length === 0) return [];

            return EXERCISE_CATALOG
                .filter(ex => 
                    // 1. Filter by Muscle Target: Exercise primary muscle must intersect with the target muscle list
                    ex.primary.some(muscle => targetMuscles.includes(muscle))
                )
                .filter(ex => 
                    // 2. Filter by Available Equipment: All required equipment for the exercise must be available
                    ex.equipment.every(requiredKey => 
                        // Check if the required key exists and is checked in any equipment category (weights, cardio, floorSpace)
                        Object.values(currentAvailableEquipment).some(category => category?.[requiredKey])
                    )
                )
                .map(ex => ex.name); 
        }, [workoutConfig, tempEquipmentOverride]); // Dependencies ensure re-calculation on config or equipment change
        
        // Cache the suggested exercises
        const suggestedExercises = getSuggestedExercises();
        const currentBestLift = bestLifts[exerciseName] || { weight: 0, reps: 0 };
        
        // If the selected exercise is no longer in the suggested list, reset it
        useEffect(() => {
            if (exerciseName && !suggestedExercises.includes(exerciseName)) {
                setExerciseName('');
            }
        }, [suggestedExercises, exerciseName]);
        
        // Add a new exercise to the active workout log
        const addExercise = (e) => {
            e.preventDefault();
            if (!exerciseName || sets <= 0 || reps <= 0) return;
            
            const newExercise = {
                id: Date.now(),
                name: exerciseName,
                setLogs: Array.from({ length: sets }, () => ({
                    reps: reps,
                    weight: weight,
                })),
                totalVolume: 0,
            };
            
            // Calculate total volume for the newly added exercise
            newExercise.totalVolume = newExercise.setLogs.reduce((sum, log) => sum + (log.reps * log.weight), 0);

            setActiveWorkout(prev => [...prev, newExercise]);
            
            // Reset form for next exercise (keep weight/reps from previous set)
            setExerciseName('');
            setSets(3);
            // weight/reps are kept to make logging similar lifts easier
        };
        
        // Update reps/weight for an individual set log
        const updateSetLog = (exerciseId, setIndex, field, value) => {
            setActiveWorkout(prev => prev.map(ex => {
                if (ex.id === exerciseId) {
                    const newSetLogs = ex.setLogs.map((set, i) => 
                        i === setIndex ? { ...set, [field]: value } : set
                    );
                    // Recalculate total volume
                    const newTotalVolume = newSetLogs.reduce((sum, log) => sum + (log.reps * log.weight), 0);
                    return { ...ex, setLogs: newSetLogs, totalVolume: newTotalVolume };
                }
                return ex;
            }));
        };

        const saveWorkout = async () => {
            if (!userId || activeWorkout.length === 0 || isSaving) return;
            setIsSaving(true);
            
            try {
                // 1. Save Workout History
                const historyColRef = collection(db, getWorkoutHistoryCollectionPath());
                await addDoc(historyColRef, {
                    userId: userId,
                    sessionName: workoutConfig.sessionName || 'Untitled Session',
                    split: workoutConfig.split,
                    date: new Date().toISOString(),
                    exercises: activeWorkout,
                    totalSessionVolume: activeWorkout.reduce((sum, ex) => sum + ex.totalVolume, 0),
                });
                
                // 2. Update Best Lifts (based on highest weight or highest volume at equal weight)
                for (const ex of activeWorkout) {
                    // Find the best single set in the current session based on PR logic (Volume first, then Weight)
                    let sessionBestSet = { weight: 0, reps: 0, volume: 0 };
                    
                    for (const set of ex.setLogs) {
                        const volume = set.reps * set.weight;
                        
                        // Primary check: Highest Volume
                        if (volume > sessionBestSet.volume) {
                            sessionBestSet = { weight: set.weight, reps: set.reps, volume: volume };
                        } else if (volume === sessionBestSet.volume && set.weight > sessionBestSet.weight) {
                            // Volume Tie-breaker: Prefer set with higher weight
                            sessionBestSet = { weight: set.weight, reps: set.reps, volume: volume };
                        }
                    }

                    const currentBest = bestLifts[ex.name] || { weight: 0, reps: 0 };
                    const currentBestVolume = currentBest.weight * currentBest.reps;
                    
                    // Only update if the session best set is better than the current overall best
                    if (sessionBestSet.volume > currentBestVolume) {
                        const bestLiftRef = doc(db, getBestLiftsCollectionPath(), ex.name);
                        await setDoc(bestLiftRef, { 
                            weight: sessionBestSet.weight, 
                            reps: sessionBestSet.reps,
                            volume: sessionBestSet.volume,
                            date: new Date().toISOString()
                        });
                        // Update local state
                        setBestLifts(prev => ({ 
                            ...prev, 
                            [ex.name]: { 
                                weight: sessionBestSet.weight, 
                                reps: sessionBestSet.reps, 
                                volume: sessionBestSet.volume 
                            } 
                        }));
                    }
                }

                console.log('Workout saved successfully! Total Volume: ' + activeWorkout.reduce((sum, ex) => sum + ex.totalVolume, 0) + ' kg');
                
                // Reset and navigate
                setActiveWorkout([]);
                setWorkoutConfig({ split: workoutSplits[0], muscleSelection: [], sessionName: '' });
                navigate('dashboard');
                
            } catch (err) {
                console.error("Failed to save workout:", err);
                setError("Failed to save workout data.");
            } finally {
                setIsSaving(false);
            }
        };

        return (
            <div className="space-y-6">
                
                {/* Navigation Buttons */}
                <div className="flex justify-between items-center mb-4">
                    <button onClick={() => navigate('start-workout')} className="text-sm px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center">
                        &#8592; Back to Config
                    </button>
                    <button onClick={() => navigate('dashboard')} className="text-sm px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 text-gray-700">
                        Go to Dashboard
                    </button>
                </div>

                <h2 className="text-3xl font-bold text-gray-800 text-center">{workoutConfig.sessionName || 'Active Workout'}</h2>
                <div className="text-sm text-gray-500 text-center">Focus: {workoutConfig.split}</div>
                
                {/* Current Workout Summary */}
                <div className="p-4 bg-gray-100 rounded-xl shadow-inner space-y-3">
                    <p className="font-bold text-lg text-gray-800">Exercises Logged: {activeWorkout.length}</p>
                    <p className="text-sm text-gray-600">Total Volume: {activeWorkout.reduce((sum, ex) => sum + ex.totalVolume, 0)} kg</p>
                </div>

                {/* Log New Exercise Form */}
                <form onSubmit={addExercise} className="p-4 border border-gray-300 rounded-xl shadow-md space-y-3 relative">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="text-xl font-semibold" style={{ color: VFIT_PRIMARY }}>Add Exercise</h3>
                        {/* Equipment Adjuster Button */}
                        <button 
                            type="button" 
                            onClick={() => setIsEquipmentModalOpen(true)}
                            className="text-sm px-3 py-1 rounded-full text-white font-medium hover:bg-opacity-90 transition"
                            style={{ backgroundColor: VFIT_ACCENT }}>
                            Edit Equipment
                        </button>
                    </div>
                    
                    {/* Exercise Dropdown */}
                    <div>
                        <select 
                            value={exerciseName}
                            onChange={(e) => setExerciseName(e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-1 focus:outline-none" style={{ borderColor: VFIT_PRIMARY, '--tw-ring-color': VFIT_PRIMARY }}>
                            <option value="">-- Select Exercise --</option>
                            {suggestedExercises.length === 0 ? (
                                <option disabled>No exercises found for this focus or equipment.</option>
                            ) : (
                                suggestedExercises.map(ex => <option key={ex} value={ex}>{ex}</option>)
                            )}
                        </select>
                    </div>

                    {/* Sets, Reps, Weight Inputs */}
                    <div className="grid grid-cols-3 gap-2">
                        <CounterInput label="Sets" value={sets} setValue={setSets} min={1} />
                        <CounterInput label="Reps" value={reps} setValue={setReps} min={1} />
                        <CounterInput label="Weight (kg)" value={weight} setValue={setWeight} min={0} bestLift={currentBestLift} />
                    </div>

                    <button 
                        type="submit" 
                        className="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition"
                        disabled={suggestedExercises.length === 0 || !exerciseName}>
                        ADD TO WORKOUT
                    </button>
                    {suggestedExercises.length === 0 && (
                         <p className="text-red-500 text-xs mt-2 text-center">No exercises available. Adjust focus or equipment.</p>
                    )}
                </form>

                {/* Logged Exercises */}
                <div className="space-y-4">
                    {activeWorkout.map((ex, exIndex) => (
                        <div key={ex.id} className="p-3 bg-white rounded-lg shadow border border-gray-200">
                            <h4 className="font-bold text-lg text-gray-800">{ex.name} (Volume: {ex.totalVolume} kg)</h4>
                            <div className="mt-2 space-y-2">
                                {ex.setLogs.map((set, setIndex) => (
                                    <SetLogEditor
                                        key={setIndex}
                                        setIndex={setIndex}
                                        setLog={set}
                                        updateLog={(field, value) => updateSetLog(ex.id, setIndex, field, value)}
                                    />
                                ))}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Finish Workout Button */}
                <button 
                    onClick={saveWorkout}
                    disabled={activeWorkout.length === 0 || isSaving}
                    style={{ backgroundColor: activeWorkout.length > 0 ? VFIT_ACCENT : 'gray' }}
                    className="w-full py-3 text-white font-extrabold rounded-lg shadow-xl hover:opacity-90 transition disabled:opacity-50">
                    {isSaving ? 'Saving Workout...' : 'FINISH & SAVE WORKOUT'}
                </button>
                
                {/* Equipment Modal */}
                <GymEquipmentModal 
                    isOpen={isEquipmentModalOpen} 
                    onClose={() => setIsEquipmentModalOpen(false)}
                    initialEquipment={tempEquipmentOverride}
                    onSave={setTempEquipmentOverride}
                />
            </div>
        );
    };
    
    // --- VIEW 6: HISTORY ---

    const HistoryView = () => {
        const [activeTab, setActiveTab] = useState('workouts');
        
        // Helper to format date
        const formatDate = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };
        
        // Find the best set (PR) in a given list of set logs for an exercise
        const getExercisePR = (setLogs) => {
            let volumePR = { weight: 0, reps: 0, volume: 0 };
            let weightPR = { weight: 0, reps: 0 }; 

            for (const set of setLogs) {
                const volume = set.weight * set.reps;
                
                // 1. Volume PR Calculation (Primary metric)
                if (volume > volumePR.volume) {
                    volumePR = { weight: set.weight, reps: set.reps, volume: volume };
                } else if (volume === volumePR.volume && set.weight > volumePR.weight) {
                    // Volume Tie-breaker: Prefer set with higher weight
                    volumePR = { weight: set.weight, reps: set.reps, volume: volume };
                }

                // 2. Max Weight PR Calculation
                if (set.weight > weightPR.weight) {
                    weightPR = { weight: set.weight, reps: set.reps };
                } else if (set.weight === weightPR.weight && set.reps > weightPR.reps) {
                    // Max Weight Tie-breaker: Same weight, higher reps is better for the 1RM estimation
                    weightPR = { weight: set.weight, reps: set.reps };
                }
            }
            return { volumePR, weightPR };
        };

        const WorkoutHistoryTab = () => (
            <div className="space-y-4 pt-4">
                {workoutHistory.length === 0 ? (
                    <div className="p-4 bg-blue-100 rounded-lg text-blue-700 text-center">
                        No workouts logged yet. Start a session from the Dashboard!
                    </div>
                ) : (
                    workoutHistory.map(workout => (
                        <div key={workout.id} className="p-4 bg-white rounded-xl shadow border border-gray-200">
                            <div className="flex justify-between items-start mb-2 border-b pb-2">
                                <h3 className="text-xl font-bold" style={{ color: VFIT_PRIMARY }}>
                                    {workout.sessionName}
                                </h3>
                                <div className="text-right">
                                    <p className="text-sm font-medium text-gray-500">{formatDate(workout.date)}</p>
                                    <p className="text-xs text-gray-400">Split: {workout.split}</p>
                                </div>
                            </div>
                            
                            <p className="text-sm font-semibold text-gray-700 mb-3">Total Volume: {workout.totalSessionVolume} kg</p>

                            <div className="space-y-2">
                                {workout.exercises.map((ex, exIndex) => {
                                    const { volumePR, weightPR } = getExercisePR(ex.setLogs);
                                    
                                    // Check if the Max Volume set and the Max Weight set are the exact same
                                    const isSameSet = volumePR.weight === weightPR.weight && volumePR.reps === weightPR.reps;
                                    
                                    return (
                                        <div key={exIndex} className="p-2 bg-gray-50 rounded-lg">
                                            <h4 className="text-md font-semibold text-gray-800">{ex.name}</h4>
                                            
                                            {/* Max Volume PR Display */}
                                            <div className="mt-1 text-xs flex justify-between items-center text-gray-600">
                                                <span className="font-bold text-gray-700">Max Volume:</span>
                                                <span className="text-green-600 font-medium">
                                                    {volumePR.weight} kg $\times$ {volumePR.reps} reps
                                                </span>
                                            </div>

                                            {/* Max Weight PR Display (Only if it's a different set) */}
                                            {!isSameSet && (
                                                <div className="mt-0.5 text-xs flex justify-between items-center text-gray-600">
                                                    <span className="font-bold text-gray-700">Max Weight:</span>
                                                    <span className="text-blue-600 font-medium">
                                                        {weightPR.weight} kg ({weightPR.reps} reps)
                                                    </span>
                                                </div>
                                            )}

                                            {/* Detailed Sets - collapsed by default for brevity */}
                                            <details className="mt-1 text-xs">
                                                <summary className="cursor-pointer text-gray-500 hover:text-gray-700">View All Sets ({ex.setLogs.length})</summary>
                                                <ul className="list-disc pl-5 mt-1 space-y-0.5">
                                                    {ex.setLogs.map((set, setIndex) => (
                                                        <li key={setIndex} className="text-gray-500">
                                                            Set {setIndex + 1}: {set.weight} kg $\times$ {set.reps} reps (Volume: {set.weight * set.reps} kg)
                                                        </li>
                                                    ))}
                                                </ul>
                                            </details>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))
                )}
            </div>
        );

        const MealHistoryTab = () => (
            <div className="space-y-4 pt-4">
                <div className="p-4 bg-yellow-100 rounded-lg text-yellow-700 text-center">
                    Meal logging feature is not yet fully implemented.
                </div>
                {/* Placeholder for meal history list */}
                {mealHistory.length === 0 ? (
                    <div className="p-4 bg-gray-100 rounded-lg text-gray-500 text-center">
                        No meals logged.
                    </div>
                ) : (
                    // Meal list rendering here...
                    <div>Meal log goes here</div>
                )}
            </div>
        );

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center mb-4">
                    <button onClick={() => navigate('dashboard')} className="text-sm px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center">
                        &#8592; Back to Dashboard
                    </button>
                    <h2 className="text-3xl font-bold text-gray-800">History</h2>
                    <div></div> {/* Spacer */}
                </div>
                

                {/* Tab Navigation */}
                <div className="flex border-b border-gray-300">
                    <button 
                        onClick={() => setActiveTab('workouts')}
                        className={`py-2 px-4 font-semibold ${activeTab === 'workouts' ? 'border-b-2 text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                        style={{ borderBottomColor: activeTab === 'workouts' ? VFIT_PRIMARY : 'transparent' }}>
                        Workout Logs
                    </button>
                    <button 
                        onClick={() => setActiveTab('meals')}
                        className={`py-2 px-4 font-semibold ${activeTab === 'meals' ? 'border-b-2 text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                        style={{ borderBottomColor: activeTab === 'meals' ? VFIT_PRIMARY : 'transparent' }}>
                        Meal Logs
                    </button>
                </div>

                {/* Tab Content */}
                {activeTab === 'workouts' ? <WorkoutHistoryTab /> : <MealHistoryTab />}

            </div>
        );
    };

    // --- SUB-COMPONENTS (shared) ---
    
    // Quick Equipment Adjuster Modal
    const GymEquipmentModal = ({ isOpen, onClose, initialEquipment, onSave }) => {
        const [tempProfile, setTempProfile] = useState(initialEquipment);

        useEffect(() => {
            // Reset temp profile when modal opens with new initial data
            if (isOpen) {
                setTempProfile(initialEquipment);
            }
        }, [isOpen, initialEquipment]);

        const handleCheckboxChange = (category, key, checked) => {
            setTempProfile(prev => ({
                ...prev,
                [category]: {
                    ...(prev[category] || {}),
                    [key]: checked,
                }
            }));
        };

        const handleSave = () => {
            onSave(tempProfile);
            onClose();
        };

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                    <h3 className="text-2xl font-bold" style={{ color: VFIT_PRIMARY }}>
                        Quick Equipment Adjuster
                    </h3>
                    <p className="text-sm text-gray-600">
                        These changes only affect the suggested exercises for the current session.
                    </p>

                    {Object.entries(gymEquipment).map(([category, items]) => (
                        <div key={category} className="p-3 border rounded-lg bg-gray-50">
                            <h4 className="font-semibold capitalize mb-2">{category.replace(/([A-Z])/g, ' $1')}</h4>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                {items.map(item => (
                                    <div key={item.key} className="flex items-center">
                                        <input
                                            type="checkbox"
                                            id={`modal-${item.key}`}
                                            checked={tempProfile[category]?.[item.key] || false}
                                            onChange={(e) => handleCheckboxChange(category, item.key, e.target.checked)}
                                            className="h-4 w-4 rounded border-gray-300"
                                            style={{ color: VFIT_ACCENT, borderColor: VFIT_ACCENT }}
                                        />
                                        <label htmlFor={`modal-${item.key}`} className="ml-2 text-gray-700 cursor-pointer">
                                            {item.icon} {item.name}
                                        </label>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}

                    <button 
                        onClick={handleSave}
                        style={{ backgroundColor: VFIT_PRIMARY }}
                        className="w-full py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-300">
                        Apply Changes
                    </button>
                    <button 
                        onClick={onClose}
                        className="w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-300">
                        Cancel
                    </button>
                </div>
            </div>
        );
    };

    const CounterInput = ({ label, value, setValue, min = 0, bestLift = null }) => (
        <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">{label}
                {bestLift && label.includes('Weight') && bestLift.weight > 0 && 
                    <span className="ml-1 text-xs text-green-500 font-normal"> (PR: {bestLift.weight}kg x {bestLift.reps}r)</span>
                }
            </label>
            <div className="flex items-center space-x-1">
                <button type="button" onClick={() => setValue(Math.max(min, value - 1))} className="p-1 bg-gray-200 rounded-lg hover:bg-gray-300 w-8">-</button>
                <input 
                    type="number" 
                    value={value} 
                    onChange={(e) => setValue(Math.max(min, Number(e.target.value)))} 
                    className="w-full text-center p-1 border rounded-lg"
                />
                <button type="button" onClick={() => setValue(value + 1)} className="p-1 bg-gray-200 rounded-lg hover:bg-gray-300 w-8">+</button>
            </div>
        </div>
    );
    
    const SetLogEditor = ({ setIndex, setLog, updateLog }) => (
        <div className="flex items-center space-x-2 bg-gray-50 p-2 rounded-md">
            <span className="font-medium w-8 text-center text-gray-600">Set {setIndex + 1}</span>
            
            <div className="flex-1 flex items-center space-x-1">
                <CounterInput label="Reps" value={setLog.reps} setValue={(val) => updateLog('reps', val)} min={1} />
            </div>
            
            <div className="flex-1 flex items-center space-x-1">
                <CounterInput label="Weight" value={setLog.weight} setValue={(val) => updateLog('weight', val)} min={0} />
            </div>
        </div>
    );

    // --- MAIN RENDERER ---

    const renderView = () => {
        switch (view) {
            case 'login':
                return <LoginView />;
            case 'register':
                return <RegisterView />;
            case 'gym-setup':
                return <GymSetupView />;
            case 'start-workout':
                return <StartWorkoutView />;
            case 'active-workout':
                return <ActiveWorkoutView />;
            case 'history':
                return <HistoryView />;
            case 'dashboard':
            default:
                return <DashboardView />;
        }
    };

    return (
        <div className="min-h-screen bg-gray-100">
            {/* Sticky Header: Dark Grey BG, Dark Orange VFit Text */}
            <header className="fixed top-0 left-0 right-0 w-full h-16 shadow-xl z-50 flex items-center justify-center" style={{ backgroundColor: VFIT_DARK_BG }}>
                <h1 
                    style={{ color: VFIT_PRIMARY }}
                    className="text-3xl font-extrabold tracking-widest uppercase cursor-pointer" 
                    onClick={() => navigate('dashboard')}>
                    VFit
                </h1>
            </header>

            <main className="pt-16 min-h-screen flex items-start justify-center p-4 sm:p-6 lg:p-8">
                <div className="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 sm:p-8">

                    {/* Global Error Display */}
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" role="alert">
                            {error}
                            <button onClick={() => setError(null)} className="ml-4 font-bold float-right">X</button>
                        </div>
                    )}

                    {/* Content Router */}
                    {!dbReady ? <LoadingSpinner /> : renderView()}
                </div>
            </main>
        </div>
    );
};

export default VFitApp;

