<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack Pro V6.2</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Barcode Scanner Styles */
        #interactive.viewport { width: 100%; height: 100%; position: relative; }
        #interactive.viewport video { width: 100%; height: 100%; object-fit: cover; border-radius: 1.5rem; }
        canvas.drawingBuffer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 1.5rem; }
        
        @keyframes scanLine { from { top: 0%; } to { top: 100%; } }
        .animate-scanLine { animation: scanLine 2s linear infinite; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24">

    <!-- Header -->
    <header class="bg-white border-b px-6 py-4 sticky top-0 z-40 flex justify-between items-center shadow-sm">
        <div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">FitTrack Pro</h1>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">V6.2 Performance</p>
        </div>
        <button onclick="switchTab('settings')" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
            <i data-lucide="settings" class="text-slate-600"></i>
        </button>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        
        <!-- DASHBOARD TAB -->
        <section id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                    <i data-lucide="flame" class="text-orange-500 mb-2"></i>
                    <div id="dash-calories" class="text-2xl font-black">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Calories</div>
                </div>
                <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                    <i data-lucide="target" class="text-blue-500 mb-2"></i>
                    <div id="dash-protein" class="text-2xl font-black">0g</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Protein</div>
                </div>
            </div>
            <div class="bg-indigo-600 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="text-lg font-bold mb-1">Active Progress</h3>
                    <p id="dash-sessions" class="text-indigo-100 text-sm mb-4">You've logged 0 sessions</p>
                    <button onclick="switchTab('training')" class="bg-white text-indigo-600 px-6 py-2 rounded-2xl font-bold text-sm">Start New Workout</button>
                </div>
                <i data-lucide="trending-up" class="absolute -right-4 -bottom-4 text-indigo-500/30 w-32 h-32"></i>
            </div>
        </section>

        <!-- TRAINING TAB -->
        <section id="training" class="tab-content space-y-6">
            <div id="workout-setup" class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm text-center">
                <h3 class="font-bold mb-4">Choose Training Type</h3>
                <select id="workout-focus" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold mb-4">
                    <option>Full Body</option>
                    <option>Upper Body</option>
                    <option>Lower Body</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="startManualWorkout()" class="p-4 bg-slate-900 text-white rounded-2xl font-bold flex flex-col items-center gap-2">
                        <i data-lucide="plus"></i> <span class="text-xs">Manual</span>
                    </button>
                    <button onclick="generateAIWorkout()" class="p-4 bg-indigo-600 text-white rounded-2xl font-bold flex flex-col items-center gap-2">
                        <i data-lucide="brain-circuit"></i> <span class="text-xs">AI Suggest</span>
                    </button>
                </div>
            </div>
            <div id="workout-active" class="hidden bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="active-workout-title" class="text-xl font-bold">Workout</h3>
                    <button onclick="cancelWorkout()" class="text-red-500 font-bold text-sm">Cancel</button>
                </div>
                <div id="exercise-list" class="space-y-4 mb-6"></div>
                <button onclick="addExerciseField()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-sm mb-4">+ Add Exercise</button>
                <button onclick="saveWorkout()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold">Log Workout</button>
            </div>
        </section>

        <!-- NUTRITION TAB -->
        <section id="nutrition" class="tab-content space-y-6">
            <div class="flex bg-white p-1 rounded-2xl border border-slate-100 shadow-sm">
                <button onclick="setNutritionTab('log')" id="nut-tab-log" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl bg-indigo-600 text-white shadow-lg transition-all">Diary</button>
                <button onclick="setNutritionTab('database')" id="nut-tab-db" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl text-slate-400 transition-all">Database</button>
            </div>

            <!-- Diary View -->
            <div id="nut-view-log" class="space-y-6">
                <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex items-center justify-between">
                    <button onclick="changeDate(-1)"><i data-lucide="chevron-left"></i></button>
                    <span id="date-display" class="font-bold"></span>
                    <button onclick="changeDate(1)"><i data-lucide="chevron-right"></i></button>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm relative">
                    <input id="food-search" placeholder="Search foods to log..." class="w-full p-4 bg-slate-50 rounded-2xl" oninput="handleFoodSearch(this.value)">
                    <div id="food-results" class="hidden absolute left-6 right-6 top-full mt-1 bg-white border rounded-2xl overflow-hidden z-50 shadow-2xl max-h-48 overflow-y-auto"></div>
                </div>
                <div id="daily-log-list" class="bg-white rounded-3xl border border-slate-100 shadow-sm divide-y"></div>
            </div>

            <!-- Database / Scanner View -->
            <div id="nut-view-db" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <div id="scanner-ui" class="hidden space-y-4 mb-6">
                        <div class="bg-indigo-600 text-white p-3 rounded-2xl flex items-center justify-center gap-2 mb-2 shadow-lg">
                            <i data-lucide="info" class="animate-pulse"></i>
                            <span id="scanner-feedback" class="text-sm font-bold tracking-tight">Aligning camera...</span>
                        </div>
                        <div id="interactive" class="viewport aspect-square bg-black rounded-3xl overflow-hidden shadow-2xl">
                            <div class="absolute inset-0 border-4 border-white/20 rounded-3xl z-10 pointer-events-none flex items-center justify-center">
                                <div class="w-48 h-48 border-2 border-indigo-400 border-dashed rounded-xl opacity-50 animate-pulse"></div>
                            </div>
                            <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-indigo-50 shadow-[0_0_15px_indigo] z-20 animate-scanLine"></div>
                        </div>
                        <button onclick="stopScanner()" class="w-full bg-slate-100 text-slate-600 p-4 rounded-2xl font-bold">Stop Camera</button>
                    </div>

                    <button id="btn-start-scan" onclick="startScanner()" class="group w-full bg-indigo-600 text-white p-8 rounded-3xl flex flex-col items-center gap-3 font-bold mb-6 shadow-xl shadow-indigo-100 transition-all active:scale-95">
                        <div class="p-4 bg-white/10 rounded-full group-hover:bg-white/20 transition-colors">
                            <i data-lucide="barcode" class="w-10 h-10"></i>
                        </div>
                        <span class="text-lg">Scan Product Barcode</span>
                        <span class="text-[10px] uppercase opacity-60 tracking-widest font-black">OpenFoodFacts API</span>
                    </button>

                    <div class="space-y-4 text-left p-2">
                        <div class="flex justify-between items-end border-b pb-2 mb-2">
                            <h4 class="font-black text-[10px] uppercase text-slate-400 tracking-wider">Product Details</h4>
                            <div id="fetch-loader" class="hidden"><i data-lucide="loader-2" class="animate-spin text-indigo-600 w-4 h-4"></i></div>
                        </div>
                        <div class="space-y-3">
                            <input id="form-name" placeholder="Name" class="w-full p-4 bg-slate-50 rounded-2xl font-bold focus:bg-white border-none outline-none">
                            <div class="grid grid-cols-2 gap-3">
                                <input id="form-cals" type="number" placeholder="Calories" class="w-full p-4 bg-slate-50 rounded-2xl font-bold focus:bg-white border-none outline-none">
                                <input id="form-prot" type="number" placeholder="Protein" class="w-full p-4 bg-slate-50 rounded-2xl font-bold focus:bg-white border-none outline-none">
                            </div>
                        </div>
                        <button onclick="saveToDatabase()" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase text-xs tracking-widest mt-2">Add to Database</button>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center text-[10px] font-black uppercase text-slate-400 tracking-wider">
                        <span>Saved Items</span>
                        <i data-lucide="database" class="w-3 h-3 text-slate-300"></i>
                    </div>
                    <div id="custom-db-list" class="divide-y max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <!-- BODY TAB -->
        <section id="metrics" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="font-bold mb-6">New Log</h3>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <input id="body-weight" type="number" placeholder="Weight (kg)" class="w-full p-4 bg-slate-50 rounded-2xl font-bold">
                    <input id="body-waist" type="number" placeholder="Waist (cm)" class="w-full p-4 bg-slate-50 rounded-2xl font-bold">
                </div>
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <div onclick="document.getElementById('file-front').click()" class="h-32 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer relative overflow-hidden">
                        <i data-lucide="camera" class="text-slate-300"></i>
                        <input type="file" id="file-front" class="hidden" onchange="previewImg(this, 'img-front')">
                        <img id="img-front" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                    <div onclick="document.getElementById('file-side').click()" class="h-32 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer relative overflow-hidden">
                        <i data-lucide="camera" class="text-slate-300"></i>
                        <input type="file" id="file-side" class="hidden" onchange="previewImg(this, 'img-side')">
                        <img id="img-side" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                    <div onclick="document.getElementById('file-back').click()" class="h-32 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer relative overflow-hidden">
                        <i data-lucide="camera" class="text-slate-300"></i>
                        <input type="file" id="file-back" class="hidden" onchange="previewImg(this, 'img-back')">
                        <img id="img-back" class="absolute inset-0 w-full h-full object-cover hidden">
                    </div>
                </div>
                <button onclick="saveMetrics()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold shadow-lg shadow-indigo-100">Save Metrics</button>
            </div>
        </section>

        <!-- HISTORY TAB -->
        <section id="history" class="tab-content space-y-6">
            <div class="flex bg-white p-1 rounded-2xl border border-slate-100 shadow-sm">
                <button onclick="setHistoryTab('training')" id="hist-tab-train" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl bg-indigo-600 text-white shadow-md">training</button>
                <button onclick="setHistoryTab('nutrition')" id="hist-tab-nut" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl text-slate-400">nutrition</button>
                <button onclick="setHistoryTab('body')" id="hist-tab-body" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl text-slate-400">body</button>
            </div>
            <div id="history-list" class="space-y-4"></div>
        </section>

        <!-- SETTINGS TAB -->
        <section id="settings" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="font-black text-[11px] uppercase text-slate-400 mb-4 tracking-wider">Gym Configuration</h3>
                <div id="gym-config-grid" class="grid grid-cols-2 gap-3"></div>
            </div>
            <button onclick="resetData()" class="w-full p-4 text-red-500 font-black uppercase text-[10px] tracking-widest bg-red-50 rounded-2xl">Reset Local Storage</button>
        </section>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t px-6 py-4 flex justify-between items-center z-50">
        <button onclick="switchTab('dashboard')" data-tab="dashboard" class="nav-item text-indigo-600 flex flex-col items-center gap-1">
            <i data-lucide="layout" stroke-width="3"></i><span class="text-[9px] font-black uppercase">Board</span>
        </button>
        <button onclick="switchTab('training')" data-tab="training" class="nav-item text-slate-300 flex flex-col items-center gap-1">
            <i data-lucide="dumbbell"></i><span class="text-[9px] font-black uppercase">Train</span>
        </button>
        <button onclick="switchTab('history')" data-tab="history" class="nav-item text-slate-300 flex flex-col items-center gap-1">
            <i data-lucide="history"></i><span class="text-[9px] font-black uppercase">History</span>
        </button>
        <button onclick="switchTab('nutrition')" data-tab="nutrition" class="nav-item text-slate-300 flex flex-col items-center gap-1">
            <i data-lucide="utensils"></i><span class="text-[9px] font-black uppercase">Food</span>
        </button>
        <button onclick="switchTab('metrics')" data-tab="metrics" class="nav-item text-slate-300 flex flex-col items-center gap-1">
            <i data-lucide="scale"></i><span class="text-[9px] font-black uppercase">Body</span>
        </button>
    </nav>

    <script>
        // --- CONSTANTS ---
        const EXERCISE_DATABASE = [
            { name: "Barbell Squat", focus: "Lower Body", equipment: "barbell" },
            { name: "Deadlift", focus: "Lower Body", equipment: "barbell" },
            { name: "Dumbbell Lunges", focus: "Lower Body", equipment: "dumbbell" },
            { name: "Leg Press", focus: "Lower Body", equipment: "weightMachine" },
            { name: "Leg Extension", focus: "Lower Body", equipment: "pinMachine" },
            { name: "Bench Press", focus: "Upper Body", equipment: "barbell" },
            { name: "Dumbbell Flyes", focus: "Upper Body", equipment: "dumbbell" },
            { name: "Lat Pulldown", focus: "Upper Body", equipment: "pinMachine" },
            { name: "Seated Cable Row", focus: "Upper Body", equipment: "cables" },
            { name: "Dumbbell Row", focus: "Upper Body", equipment: "dumbbell" },
            { name: "Overhead Press", focus: "Upper Body", equipment: "barbell" },
            { name: "Lateral Raise", focus: "Upper Body", equipment: "dumbbell" },
            { name: "Tricep Pushdown", focus: "Upper Body", equipment: "cables" },
            { name: "Bicep Curls", focus: "Upper Body", equipment: "dumbbell" },
        ];

        // --- STATE ---
        let state = {
            activeTab: 'dashboard',
            historyTab: 'training',
            nutritionTab: 'log',
            viewDate: new Date().toISOString().split('T')[0],
            gymConfig: { barbell: true, dumbbell: true, cables: true, pinMachine: true, weightMachine: true },
            dailyMeals: [],
            workoutHistory: [],
            metricsHistory: [],
            customFoodDb: []
        };

        let currentActiveWorkout = null;

        // --- INIT ---
        window.onload = () => {
            const saved = localStorage.getItem('fittrack_v6_vanilla');
            if (saved) state = { ...state, ...JSON.parse(saved) };
            
            renderGymConfig();
            updateDateDisplay();
            renderDashboard();
            lucide.createIcons();
        };

        function saveState() {
            localStorage.setItem('fittrack_v6_vanilla', JSON.stringify(state));
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            state.activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => {
                const icon = n.querySelector('svg');
                if (n.dataset.tab === tabId) {
                    n.classList.remove('text-slate-300');
                    n.classList.add('text-indigo-600', 'scale-110');
                    if (icon) icon.setAttribute('stroke-width', '3');
                } else {
                    n.classList.add('text-slate-300');
                    n.classList.remove('text-indigo-600', 'scale-110');
                    if (icon) icon.setAttribute('stroke-width', '2');
                }
            });

            if (tabId === 'dashboard') renderDashboard();
            if (tabId === 'history') renderHistory();
            if (tabId === 'nutrition') {
                renderCustomDb();
                renderDailyLog();
            }
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const today = state.dailyMeals.filter(m => m.date === state.viewDate);
            const cals = today.reduce((acc, m) => acc + Number(m.calories || 0), 0);
            const prot = today.reduce((acc, m) => acc + Number(m.protein || 0), 0);
            
            document.getElementById('dash-calories').innerText = cals;
            document.getElementById('dash-protein').innerText = prot.toFixed(1) + 'g';
            document.getElementById('dash-sessions').innerText = `You've logged ${state.workoutHistory.length} sessions`;
        }

        // --- TRAINING ---
        function startManualWorkout() {
            currentActiveWorkout = { focus: document.getElementById('workout-focus').value, exercises: [{ name: "New Exercise", weights: [''] }] };
            renderActiveWorkout();
        }

        function generateAIWorkout() {
            const focus = document.getElementById('workout-focus').value;
            const filtered = EXERCISE_DATABASE.filter(e => 
                (e.focus === focus || focus === 'Full Body') && state.gymConfig[e.equipment]
            );
            const selection = filtered.sort(() => 0.5 - Math.random()).slice(0, 5);
            currentActiveWorkout = {
                focus: focus,
                exercises: selection.map(s => ({ name: s.name, weights: [''] }))
            };
            renderActiveWorkout();
        }

        function renderActiveWorkout() {
            document.getElementById('workout-setup').classList.add('hidden');
            const activeDiv = document.getElementById('workout-active');
            activeDiv.classList.remove('hidden');
            document.getElementById('active-workout-title').innerText = currentActiveWorkout.focus;
            
            const list = document.getElementById('exercise-list');
            list.innerHTML = '';
            currentActiveWorkout.exercises.forEach((ex, exIdx) => {
                const item = document.createElement('div');
                item.className = "p-4 bg-slate-50 rounded-2xl";
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <input class="font-bold text-slate-800 bg-transparent outline-none w-full" value="${ex.name}" oninput="currentActiveWorkout.exercises[${exIdx}].name = this.value">
                        <button onclick="removeExercise(${exIdx})" class="text-slate-300"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex gap-2 flex-wrap" id="sets-${exIdx}">
                        ${ex.weights.map((w, sIdx) => `
                            <input placeholder="kg" class="w-16 p-2 rounded-lg bg-white border text-center text-xs" value="${w}" oninput="currentActiveWorkout.exercises[${exIdx}].weights[${sIdx}] = this.value">
                        `).join('')}
                        <button onclick="addSet(${exIdx})" class="p-2 bg-white rounded-lg border text-indigo-600"><i data-lucide="plus" class="w-3 h-3"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function addExerciseField() {
            currentActiveWorkout.exercises.push({ name: "New Exercise", weights: [''] });
            renderActiveWorkout();
        }

        function removeExercise(idx) {
            currentActiveWorkout.exercises.splice(idx, 1);
            renderActiveWorkout();
        }

        function addSet(idx) {
            currentActiveWorkout.exercises[idx].weights.push('');
            renderActiveWorkout();
        }

        function saveWorkout() {
            state.workoutHistory.unshift({ ...currentActiveWorkout, id: Date.now(), date: state.viewDate });
            saveState();
            cancelWorkout();
            switchTab('history');
        }

        function cancelWorkout() {
            currentActiveWorkout = null;
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
        }

        // --- NUTRITION ---
        function setNutritionTab(tab) {
            state.nutritionTab = tab;
            document.getElementById('nut-view-log').classList.toggle('hidden', tab !== 'log');
            document.getElementById('nut-view-db').classList.toggle('hidden', tab !== 'database');
            
            const lBtn = document.getElementById('nut-tab-log');
            const dBtn = document.getElementById('nut-tab-db');
            if(tab === 'log') {
                lBtn.className = "flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl bg-indigo-600 text-white shadow-lg";
                dBtn.className = "flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl text-slate-400";
                renderDailyLog();
            } else {
                dBtn.className = "flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl bg-indigo-600 text-white shadow-lg";
                lBtn.className = "flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl text-slate-400";
                renderCustomDb();
            }
        }

        function updateDateDisplay() {
            document.getElementById('date-display').innerText = state.viewDate;
        }

        function changeDate(days) {
            let d = new Date(state.viewDate);
            d.setDate(d.getDate() + days);
            state.viewDate = d.toISOString().split('T')[0];
            updateDateDisplay();
            renderDailyLog();
            renderDashboard();
        }

        function handleFoodSearch(val) {
            const results = document.getElementById('food-results');
            if (val.length < 2) { results.classList.add('hidden'); return; }
            
            const base = [
                { name: "Chicken Breast", calories: 165, protein: 31 },
                { name: "Banana", calories: 89, protein: 1.1 },
                { name: "Egg", calories: 70, protein: 6 },
                { name: "Greek Yogurt", calories: 59, protein: 10 },
            ];
            const combined = [...base, ...state.customFoodDb];
            const filtered = combined.filter(f => f.name.toLowerCase().includes(val.toLowerCase()));
            
            if (filtered.length > 0) {
                results.classList.remove('hidden');
                results.innerHTML = filtered.map(f => `
                    <div onclick="logFoodItem('${f.name}', ${f.calories}, ${f.protein})" class="p-4 border-b last:border-0 hover:bg-slate-50 cursor-pointer flex justify-between">
                        <span>${f.name}</span>
                        <span class="text-[10px] text-slate-400 font-bold">${f.calories} kcal</span>
                    </div>
                `).join('');
            } else {
                results.classList.add('hidden');
            }
        }

        function logFoodItem(name, cals, prot) {
            state.dailyMeals.unshift({ id: Date.now(), date: state.viewDate, name, calories: cals, protein: prot });
            saveState();
            document.getElementById('food-search').value = '';
            document.getElementById('food-results').classList.add('hidden');
            renderDailyLog();
            renderDashboard();
        }

        function renderDailyLog() {
            const list = document.getElementById('daily-log-list');
            const items = state.dailyMeals.filter(m => m.date === state.viewDate);
            list.innerHTML = items.length === 0 ? '<div class="p-8 text-center text-slate-400 text-xs italic">No foods logged.</div>' : '';
            
            items.forEach(m => {
                const row = document.createElement('div');
                row.className = "p-4 flex justify-between items-center";
                row.innerHTML = `
                    <div><p class="font-bold text-sm">${m.name}</p><p class="text-[10px] text-slate-400">${m.calories} kcal â€¢ ${m.protein}g protein</p></div>
                    <button onclick="deleteMeal(${m.id})" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(row);
            });
            lucide.createIcons();
        }

        function deleteMeal(id) {
            state.dailyMeals = state.dailyMeals.filter(m => m.id !== id);
            saveState();
            renderDailyLog();
            renderDashboard();
        }

        // --- SCANNER ---
        function startScanner() {
            document.getElementById('btn-start-scan').classList.add('hidden');
            document.getElementById('scanner-ui').classList.remove('hidden');
            setScannerFeedback("Accessing camera...");

            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader"] }
            }, (err) => {
                if(err) { alert("Camera error: " + err); stopScanner(); return; }
                Quagga.start();
                setScannerFeedback("Scan barcode...");
            });

            Quagga.onDetected((res) => {
                const code = res.codeResult.code;
                setScannerFeedback("Detected! Fetching...");
                stopScanner();
                fetchProduct(code);
            });
        }

        function stopScanner() {
            Quagga.stop();
            document.getElementById('btn-start-scan').classList.remove('hidden');
            document.getElementById('scanner-ui').classList.add('hidden');
        }

        function setScannerFeedback(txt) { document.getElementById('scanner-feedback').innerText = txt; }

        function fetchProduct(barcode) {
            const loader = document.getElementById('fetch-loader');
            loader.classList.remove('hidden');
            
            fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
                .then(r => r.json())
                .then(data => {
                    loader.classList.add('hidden');
                    if(data.status === 1) {
                        const p = data.product;
                        const nut = p.nutriments || {};
                        document.getElementById('form-name').value = p.product_name || `Product ${barcode}`;
                        document.getElementById('form-cals').value = Math.round(nut['energy-kcal_100g'] || nut['energy-kcal'] || 0);
                        document.getElementById('form-prot').value = (nut.proteins_100g || nut.proteins || 0).toFixed(1);
                    } else {
                        alert("Product not found. Enter details manually.");
                    }
                })
                .catch(() => { loader.classList.add('hidden'); alert("Network error."); });
        }

        function saveToDatabase() {
            const name = document.getElementById('form-name').value;
            const cals = document.getElementById('form-cals').value;
            const prot = document.getElementById('form-prot').value;
            if(!name || !cals) return;
            
            state.customFoodDb.push({ name, calories: Number(cals), protein: Number(prot || 0) });
            saveState();
            renderCustomDb();
            document.getElementById('form-name').value = '';
            document.getElementById('form-cals').value = '';
            document.getElementById('form-prot').value = '';
            alert("Saved to Database!");
        }

        function renderCustomDb() {
            const list = document.getElementById('custom-db-list');
            list.innerHTML = '';
            const combined = [
                { name: "Chicken Breast", calories: 165, protein: 31, type: 'Global' },
                { name: "Banana", calories: 89, protein: 1.1, type: 'Global' },
                ...state.customFoodDb.map(f => ({ ...f, type: 'Custom' }))
            ];
            combined.forEach(f => {
                const div = document.createElement('div');
                div.className = "p-4 flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-sm text-slate-700">${f.name}</span>
                        <span class="text-[9px] text-slate-400">Source: ${f.type}</span>
                    </div>
                    <div class="flex gap-2">
                        <div class="text-[10px] font-black bg-orange-50 text-orange-600 px-3 py-1 rounded-full">${f.calories} kcal</div>
                        <div class="text-[10px] font-black bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full">${f.protein}g P</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- BODY METRICS ---
        function previewImg(input, imgId) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveMetrics() {
            const weight = document.getElementById('body-weight').value;
            const waist = document.getElementById('body-waist').value;
            if(!weight) return;
            
            state.metricsHistory.unshift({
                id: Date.now(),
                date: state.viewDate,
                weight, waist,
                photoFront: document.getElementById('img-front').src
            });
            saveState();
            alert("Metrics saved!");
            switchTab('history');
            setHistoryTab('body');
        }

        // --- HISTORY ---
        function setHistoryTab(tab) {
            state.historyTab = tab;
            ['train', 'nut', 'body'].forEach(k => {
                document.getElementById('hist-tab-'+k).className = "flex-1 py-3 text-[10px] font-black uppercase rounded-xl text-slate-400";
            });
            document.getElementById('hist-tab-'+ (tab === 'training' ? 'train' : tab === 'nutrition' ? 'nut' : 'body')).className = "flex-1 py-3 text-[10px] font-black uppercase rounded-xl bg-indigo-600 text-white shadow-md";
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            if(state.historyTab === 'training') {
                state.workoutHistory.forEach(w => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-5 rounded-3xl border border-slate-100 shadow-sm";
                    div.innerHTML = `
                        <div class="flex justify-between mb-2"><h4 class="font-bold text-slate-800">${w.focus}</h4><p class="text-[10px] font-bold text-slate-400">${w.date}</p></div>
                        <div class="space-y-1 border-l-2 border-indigo-100 pl-3">
                            ${w.exercises.map(ex => `<div class="text-xs font-bold text-slate-600 flex justify-between"><span>${ex.name}</span> <span class="text-indigo-600 font-black">${ex.weights[0] || 0}kg</span></div>`).join('')}
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else if(state.historyTab === 'nutrition') {
                const grouped = {};
                state.dailyMeals.forEach(m => {
                    if(!grouped[m.date]) grouped[m.date] = { c: 0, p: 0 };
                    grouped[m.date].c += Number(m.calories);
                    grouped[m.date].p += Number(m.protein);
                });
                const table = document.createElement('div');
                table.className = "bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden";
                table.innerHTML = `
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 font-bold uppercase text-[9px]"><tr><th class="p-4">Date</th><th class="p-4">Cals</th><th class="p-4">Prot</th></tr></thead>
                        <tbody class="divide-y divide-slate-50">
                            ${Object.keys(grouped).sort().reverse().map(date => `
                                <tr><td class="p-4 font-bold">${date}</td><td class="p-4 font-black text-indigo-600">${grouped[date].c}</td><td class="p-4 font-black text-emerald-600">${Math.round(grouped[date].p)}g</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                list.appendChild(table);
            } else {
                state.metricsHistory.forEach(log => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex gap-4";
                    div.innerHTML = `
                        <div class="w-16 h-20 bg-slate-100 rounded-xl overflow-hidden">${log.photoFront ? `<img src="${log.photoFront}" class="w-full h-full object-cover">` : ''}</div>
                        <div class="flex-1">
                            <div class="flex justify-between"><span class="font-black text-lg">${log.weight}kg</span></div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${log.date}</p>
                            <p class="text-[10px] text-slate-400">Waist: ${log.waist}cm</p>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        // --- SETTINGS ---
        function renderGymConfig() {
            const grid = document.getElementById('gym-config-grid');
            grid.innerHTML = '';
            Object.keys(state.gymConfig).forEach(k => {
                const btn = document.createElement('button');
                btn.className = `p-3 rounded-xl text-[10px] font-black uppercase transition-all ${state.gymConfig[k] ? 'bg-indigo-600 text-white ring-2 ring-indigo-200' : 'bg-slate-50 text-slate-300'}`;
                btn.innerText = k;
                btn.onclick = () => { state.gymConfig[k] = !state.gymConfig[k]; saveState(); renderGymConfig(); };
                grid.appendChild(btn);
            });
        }

        function resetData() {
            if(confirm("Erase all progress?")) { localStorage.clear(); location.reload(); }
        }
    </script>
</body>
</html>

