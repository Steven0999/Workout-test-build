<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Dashboard - Pro Local</title>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #22c55e;
            --warning: #eab308;
            --purple: #a855f7;
            --danger: #ef4444;
            --bg: #f0f4f8;
            --text-dark: #111827;
            --text-gray: #4b5563;
            --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Segoe UI', 'Inter', system-ui, sans-serif; background-color: var(--bg); color: var(--text-dark); line-height: 1.6; padding-bottom: 50px; }

        /* --- LAYOUT --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        header { 
            background: var(--white); padding: 25px; border-radius: var(--radius); 
            box-shadow: var(--shadow); margin-bottom: 30px; 
            border-left: 6px solid var(--primary);
        }
        h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; color: var(--text-dark); }
        h2 { margin-bottom: 15px; font-size: 1.4rem; }
        h3 { margin-bottom: 10px; font-size: 1.1rem; color: var(--text-dark); }

        /* --- DASHBOARD GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        
        .btn-card { 
            padding: 25px; border: none; border-radius: var(--radius); color: white; font-size: 1.2rem; 
            font-weight: bold; cursor: pointer; transition: transform 0.2s, filter 0.2s;
            text-align: left; box-shadow: var(--shadow); display: flex; flex-direction: column;
            justify-content: space-between; min-height: 140px; position: relative; overflow: hidden;
        }
        .btn-card i { font-size: 2rem; margin-bottom: 10px; opacity: 0.8; }
        .btn-card:hover { transform: translateY(-3px); filter: brightness(110%); }
        .btn-card p { font-size: 0.8rem; font-weight: normal; opacity: 0.9; margin-top: auto; }

        .bg-indigo { background: var(--primary); }
        .bg-green { background: var(--success); }
        .bg-yellow { background: var(--warning); }
        .bg-purple { background: var(--purple); }
        .bg-dark { background: #1f2937; }
        .bg-red { background: var(--danger); }

        /* --- FORMS & VIEWS --- */
        .view-card { background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); animation: fadeIn 0.3s ease; margin-bottom: 20px;}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .view-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f3f4f6; padding-bottom: 15px; margin-bottom: 20px; }
        
        .back-btn { background: #f3f4f6; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-gray); }
        .back-btn:hover { background: #e5e7eb; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; font-size: 0.9rem; color: var(--text-gray); margin-bottom: 5px; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; }
        input:focus, select:focus { border-color: var(--primary); }

        .submit-btn { width: 100%; padding: 15px; border-radius: 8px; border: none; color: white; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 10px; }

        /* --- SPECIFIC MODULE STYLES --- */
        
        /* Analysis & Calendar */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px;
        }
        .cal-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: #f3f4f6; border-radius: 6px; font-size: 0.8rem; color: #9ca3af;
            cursor: pointer; transition: transform 0.1s;
        }
        .cal-day:hover { transform: scale(1.05); background: #e5e7eb; }
        .cal-day.active { background: var(--success); color: white; font-weight: bold; }
        
        .volume-bar-container { margin-bottom: 15px; }
        .volume-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }
        .progress-track { background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }
        .progress-fill.optimal { background: var(--success); } /* 12-20 sets */
        .progress-fill.over { background: var(--danger); } /* >20 sets */
        .progress-fill.under { background: var(--warning); } /* <12 sets */

        /* Search & Filter */
        .filter-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-container select, .filter-container input { margin-bottom: 0; }
        
        /* Photo Gallery */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .photo-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; cursor: pointer; }

        /* Tracking UI */
        .set-row { display: grid; grid-template-columns: 60px 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 8px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }

        /* Message Box */
        #message-box { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold; z-index: 2000; transition: opacity 0.3s; }

        /* Focus Selection Grid */
        .focus-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .focus-option {
            background: white; border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px;
            cursor: pointer; text-align: center; font-weight: bold; transition: all 0.2s;
        }
        .focus-option.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); }
        
        /* Checkbox Grid for Specific Muscles */
        .muscle-checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; background: #f9fafb; padding: 15px; border-radius: 8px; }
        .muscle-check { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 95%; max-width: 600px; max-height: 90vh;
            border-radius: 12px; padding: 25px; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        @media (max-width: 600px) {
            .filter-container { flex-direction: column; }
            .muscle-checkbox-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="message-box" class="hidden"></div>

    <!-- MAIN DASHBOARD -->
    <div id="view-dashboard" class="view">
        <header>
            <h1><i class="fas fa-dumbbell" style="color: var(--primary);"></i> Fitness Pro</h1>
            <p id="dashboard-subtitle" style="color: var(--text-gray);">Local Tracker v2.0</p>
        </header>

        <div class="grid">
            <button class="btn-card bg-indigo" onclick="showView('gym-config')">
                <i class="fas fa-cogs"></i> <span>Setup Gym</span>
            </button>
            <button class="btn-card bg-green" onclick="showView('plan-wizard-step1')">
                <i class="fas fa-play-circle"></i> <span>Start Workout</span>
                <p>Select Focus & Track</p>
            </button>
            <button class="btn-card bg-purple" onclick="showView('body-metrics')">
                <i class="fas fa-ruler-combined"></i> <span>Body & Photos</span>
                <p>Weight, measures, pics</p>
            </button>
            <button class="btn-card bg-dark" onclick="showView('analysis')">
                <i class="fas fa-chart-line"></i> <span>Analysis</span>
                <p>Volume, Strength & Heatmap</p>
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <button onclick="resetAppData()" style="color: var(--danger); background: none; border: none; text-decoration: underline; cursor: pointer;">
                Reset Data
            </button>
        </div>
    </div>

    <!-- GYM CONFIGURATION -->
    <div id="view-gym-config" class="view-card hidden">
        <div class="view-header">
            <h2>Gym Equipment Setup</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>
        <p style="margin-bottom: 20px; color: var(--text-gray);">Check all the equipment you have access to.</p>
        
        <form id="gym-setup-form">
            <h3 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">Weights</h3>
            <div id="equipment-weights" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;"></div>

            <h3 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">Cardio Machines</h3>
            <div id="equipment-cardio" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;"></div>

            <h3 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">Functional / Other</h3>
            <div id="equipment-functional" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;"></div>

            <button type="submit" class="submit-btn bg-indigo">Save Configuration</button>
        </form>
    </div>

    <!-- WORKOUT WIZARD STEP 1: FOCUS -->
    <div id="view-plan-wizard-step1" class="view-card hidden">
        <div class="view-header">
            <h2>Step 1: Workout Focus</h2>
            <button class="back-btn" onclick="showView('dashboard')">Cancel</button>
        </div>

        <p style="margin-bottom: 15px;">What are you training today?</p>
        
        <div class="focus-grid" id="focus-options-container">
            <!-- Injected by JS -->
        </div>

        <!-- Hidden checkbox area for specific muscles -->
        <div id="specific-muscle-selector" class="hidden">
            <h4 style="margin-top: 15px;">Select Specific Muscles:</h4>
            <div class="muscle-checkbox-grid" id="muscle-checkboxes">
                <!-- Injected by JS -->
            </div>
        </div>

        <button onclick="goToWorkoutSelection()" class="submit-btn bg-indigo" style="margin-top: 25px;">Next: Select Exercises <i class="fas fa-arrow-right"></i></button>
    </div>

    <!-- WORKOUT WIZARD STEP 2: SELECTION & TRACKING -->
    <div id="view-plan-workout" class="view-card hidden">
        <div class="view-header">
            <div>
                <h2>Step 2: Build Session</h2>
                <small id="active-focus-display" style="color: var(--primary); font-weight: bold;"></small>
            </div>
            <button class="back-btn" onclick="showView('plan-wizard-step1')">Back</button>
        </div>

        <div class="form-group" style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <label><i class="fas fa-search"></i> Find Exercise</label>
            <input type="text" id="exercise-search" placeholder="Type to filter list..." onkeyup="filterExerciseList()" autocomplete="off">
            
            <label style="margin-top: 10px;">Select from Results</label>
            <select id="exercise-select" size="6" style="height: 150px; margin-bottom: 15px;"></select>
            
            <div style="display: flex; gap: 10px;">
                <input type="number" id="input-sets" value="3" placeholder="Sets" style="flex:1;">
                <input type="number" id="input-reps" value="10" placeholder="Reps" style="flex:1;">
                <button onclick="addToSession()" class="submit-btn bg-green" style="margin-top:0; flex:2;">Add to Session</button>
            </div>
        </div>

        <!-- Active Session Preview -->
        <div id="active-session-ui" class="hidden" style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px;">
            <h3>Active Session</h3>
            <p style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 10px;">Add as many exercises as you like, then finish.</p>
            <div id="session-exercises"></div>
            <button onclick="finishSession()" class="submit-btn bg-indigo">Finish & Save Workout</button>
        </div>
    </div>

    <!-- BODY METRICS & PHOTOS -->
    <div id="view-body-metrics" class="view-card hidden">
        <div class="view-header">
            <h2>Body Tracker</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>
        
        <form id="metrics-form">
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label>Weight (kg)</label>
                    <input type="number" step="0.1" id="m-weight">
                </div>
                <div class="form-group">
                    <label>Chest (cm)</label>
                    <input type="number" step="0.1" id="m-chest">
                </div>
                <div class="form-group">
                    <label>Waist (cm)</label>
                    <input type="number" step="0.1" id="m-waist">
                </div>
                <div class="form-group">
                    <label>Arms (cm)</label>
                    <input type="number" step="0.1" id="m-arms">
                </div>
                <div class="form-group">
                    <label>Thighs (cm)</label>
                    <input type="number" step="0.1" id="m-thighs">
                </div>
            </div>
            
            <div class="form-group" style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px dashed #ccc;">
                <label><i class="fas fa-camera"></i> Progress Photo</label>
                <input type="file" id="m-photo" accept="image/*">
                <small style="color: var(--text-gray);">Images are compressed to save storage.</small>
            </div>

            <button type="submit" class="submit-btn bg-purple">Log Entry</button>
        </form>

        <div style="margin-top: 30px;">
            <h3>History</h3>
            <div id="metrics-history-list"></div>
        </div>
    </div>

    <!-- ANALYSIS VIEW -->
    <div id="view-analysis" class="view-card hidden">
        <div class="view-header">
            <h2>Analysis & Progress</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>

        <div style="margin-bottom: 30px;">
            <h3><i class="fas fa-calendar-alt"></i> Workout Streak</h3>
            <p style="font-size: 0.9rem; margin-bottom: 10px;">Click on a highlighted day to view/edit workout.</p>
            <div id="calendar-heatmap" class="calendar-grid"></div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3><i class="fas fa-layer-group"></i> Weekly Volume</h3>
            <p style="font-size: 0.9rem; margin-bottom: 10px;">Sets per muscle (Last 7 Days). Goal: 12-20 sets.</p>
            <div id="volume-bars"></div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3><i class="fas fa-chart-line"></i> Strength Progression</h3>
            <select id="chart-exercise-select" onchange="renderStrengthChart()" style="margin-bottom: 15px;">
                <!-- Filled by JS -->
            </select>
            <div style="height: 250px;">
                <canvas id="strengthChart"></canvas>
            </div>
        </div>
    </div>

    <!-- DAY DETAILS MODAL -->
    <div id="day-details-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="view-header">
                <h2 id="modal-date-title">Workout Details</h2>
                <button class="back-btn" onclick="closeDayModal()">Close</button>
            </div>
            <div id="modal-workout-content"></div>
            
            <!-- Add Exercise to Past Workout Section -->
            <div style="margin-top: 20px; border-top: 2px solid #f3f4f6; padding-top: 20px;">
                <h4>Add Exercise to this Day</h4>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <select id="modal-exercise-add" style="flex: 2;"></select>
                    <button onclick="addExerciseToPastWorkout()" class="submit-btn bg-indigo" style="flex: 1; margin: 0; padding: 5px;">Add</button>
                </div>
            </div>

            <button onclick="saveDayChanges()" class="submit-btn bg-green" style="margin-top: 20px;">Save Changes</button>
        </div>
    </div>

</div>

<script>
    /* --- DATA & CONFIG --- */
    const EQUIPMENT_CATEGORIES = {
        weights: ["barbell", "dumbbell", "cables", "machines", "smith machine"],
        cardio: ["treadmill", "bike", "rower", "elliptical", "stairmaster"],
        functional: ["bodyweight", "bands", "trx", "kettlebell", "medicine ball", "box"]
    };

    const MUSCLES_LIST = ["Chest", "Back", "Shoulders", "Quads", "Hamstrings", "Glutes", "Biceps", "Triceps", "Abs", "Calves", "Cardio"];
    
    const FOCUS_TYPES = ["Push", "Pull", "Squat", "Hinge", "Full Body", "Upper Body", "Lower Body", "Specific Muscles"];

    const FOCUS_MAP = {
        "Push": ["Chest", "Shoulders", "Triceps"],
        "Pull": ["Back", "Biceps", "Glutes"], 
        "Squat": ["Quads", "Glutes", "Calves"],
        "Hinge": ["Hamstrings", "Glutes"],
        "Upper Body": ["Chest", "Back", "Shoulders", "Biceps", "Triceps"],
        "Lower Body": ["Quads", "Hamstrings", "Glutes", "Calves"],
        "Full Body": MUSCLES_LIST,
        "Specific Muscles": [] 
    };
    
    const EXERCISE_LIBRARY = [
       
     //UPPER BODY   
        // SHOULDERS
        { name: "Shoulder Machine Raises", muscle: "Shoulders", equipment: ["machines"] },
        { name: "Lateral Cable Shoulder Raises", muscle: "Shoulders", equipment: ["cables"] },
        { name: "Dumbbell Shoulder Press", muscle: "Shoulders", equipment: ["dumbbell"] },
        { name: "Barbell Shoulder Press", muscle: "Shoulders", equipment: ["barbell"] },
        { name: "Pin Machine Rear Delt Flies", muscle: "Shoulders", equipment: ["machines"] },
        { name: "Dumbbell Lateral Raise", muscle: "Shoulders", equipment: ["dumbbell"] },
        
        // BACK
        { name: "Pin Machine Back Rows", muscle: "Back", equipment: ["machines"] },
        { name: "Pin Machine Pull Downs", muscle: "Back", equipment: ["machines"] },
        { name: "Weight Machine Back Rows", muscle: "Back", equipment: ["machines"] },
        { name: "Dumbbell Back Rows", muscle: "Back", equipment: ["dumbbell"] },
        { name: "Barbell Back Rows", muscle: "Back", equipment: ["barbell"] },
        { name: "Pull Ups", muscle: "Back", equipment: ["bodyweight"] },
        
        // CHEST
        { name: "Barbell Bench Press", muscle: "Chest", equipment: ["barbell"] },
        { name: "Dumbbell Incline Press", muscle: "Chest", equipment: ["dumbbell"] },
        { name: "Machine Chest Press", muscle: "Chest", equipment: ["machines"] },
        { name: "Cable Flys", muscle: "Chest", equipment: ["cables"] },
        { name: "Push Ups", muscle: "Chest", equipment: ["bodyweight"] },

        // ARMS
        { name: "Barbell Curl", muscle: "Biceps", equipment: ["barbell"] },
        { name: "Dumbbell Hammer Curl", muscle: "Biceps", equipment: ["dumbbell"] },
        { name: "Cable Tricep Pushdown", muscle: "Triceps", equipment: ["cables"] },
        { name: "Skullcrushers", muscle: "Triceps", equipment: ["barbell", "dumbbell"] },
        
    //LOWER BODY
        // Quadriceps 
        { name: "Barbell Squat", muscle: ["Quads", "Glutes"], equipment: ["barbell"] },
        { name: "Leg Press", muscle: "Quads", equipment: ["machines"] },
        { name: "Leg Extension", muscle: "Quads", equipment: ["machines"] },
        { name: "Box Jumps", muscle: "Quads", equipment: ["box", "functional"] },

        { name: "Calf Raises", muscle: "Calves", equipment: ["machines", "dumbbell", "bodyweight"] },
        
        //Hamstrings 
        { name: "Straight Leg Deadlift", muscle: "Hamstrings", equipment: ["barbell", "dumbbell"] },
        { name: "Lying Leg Curl", muscle: "Hamstrings", equipment: ["machines"] },
That's a great request! You have two distinct, complex single-file web applications:
 * Advanced Fitness Dashboard: Manages gym equipment configuration, workout planning, active workout tracking, and meal logging. (Pure JavaScript/HTML/Tailwind)
 * Body Metrics Tracker: Handles body measurements (e.g., waist, chest) and uses Firebase Firestore for real-time data persistence. (JavaScript/HTML/Tailwind/Firebase)
To merge them, I will combine the HTML structures, merge the CSS styles, and most critically, merge the JavaScript logic while ensuring both the pure JS state management (from the Dashboard) and the Firebase initialization/data handling (from the Metrics Tracker) work seamlessly together.
I will prioritize the more robust structure of the Advanced Fitness Dashboard and integrate the Body Metrics Tracker functionality as a new dedicated view, leveraging the existing modal logic where possible.
Key Integration Strategy:
 * Dashboard View Integration: Add the Body Metrics Tracker as a fifth primary button/view on the main dashboard.
 * HTML/CSS: Combine the <head> elements (including both sets of CSS) and nest the Body Metrics Tracker content (<main> and the measurement-modal) inside the main max-w-5xl container, styled to be a new view (#view-body-metrics).
 * JavaScript:
   * Place all Dashboard JS logic first in the combined <script type="module"> block.
   * Integrate the Firebase Imports and Global Constants (Firebase Config, Body Areas, etc.).
   * Merge the initApp and initializeFirebase functions, ensuring Firebase is ready before rendering the real-time data.
   * Adapt the Body Metrics JS functions (openModal, closeModal, startRealtimeListener, handleSaveMeasurement, renderMeasurements) to fit the new combined environment and be called from the new view's entry point.
Here is the complete, merged application.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Fitness & Metrics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* From Advanced Dashboard */
            transition: all 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics (From Advanced Dashboard) */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        .view-container {
            min-height: calc(100vh - 4rem);
        }
        /* Modal transitions (From Body Metrics) */
        .modal-metrics { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .fade-in { opacity: 1; transform: translateY(0); }
        .fade-out { opacity: 0; transform: translateY(-10px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <div id="message-box" class="fixed top-4 right-4 z-50 p-4 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-lg shadow-xl font-medium hidden transition-opacity duration-300 ease-in-out opacity-0">
            <p id="message-text"></p>
        </div>
        
        <div id="status-message" class="hidden mb-6"></div>

        <div id="view-dashboard" class="view-container space-y-8">
             <header class="bg-white p-6 rounded-2xl shadow-xl transition-all hover:shadow-2xl">
                <h1 class="text-4xl font-black text-gray-900 mb-2">Integrated Fitness Dashboard</h1>
                <div class="md:flex md:space-x-8">
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">User:</span> <span id="user-name"></span>
                    </p>
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">Goal:</span> <span id="user-goal"></span>
                    </p>
                    <p id="user-id-display" class="text-sm text-indigo-300 mt-1"></p>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <button onclick="showView('gym-config')" class="bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-dumbbell mr-2"></i> Configure Gym
                    <p id="current-gym-status" class="mt-1 text-sm opacity-80 italic"></p>
                </button>
                
                <button onclick="showView('plan-workout')" class="bg-green-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-running mr-2"></i> Plan Workout
                </button>
                
                <button onclick="showView('meal-log')" class="bg-yellow-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-utensils mr-2"></i> Log Meal
                </button>
                
                <button onclick="showView('body-metrics')" class="bg-purple-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-purple-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-ruler-combined mr-2"></i> Body Metrics
                </button>
                
                <button id="view-history-btn" class="bg-gray-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-chart-line mr-2"></i> View History
                </button>
                
            </div>
        </div>

        <div id="view-gym-config" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-indigo-700"><i class="fas fa-cogs mr-2"></i> Gym Setup Configuration</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="gym-setup-form" class="space-y-6">
                <div class="space-y-2">
                    <label for="gym-name" class="block text-sm font-medium text-gray-700">Gym Profile Name</label>
                    <input type="text" id="gym-name" name="gym-name" value="My Home Gym" required
                           class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                        <div id="weights-options" class="space-y-1 text-sm"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                        <div id="cardio-options" class="space-y-1 text-sm"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-expand-alt mr-2"></i> Functional / Floor</h3>
                        <div id="floor-options" class="space-y-1 text-sm"></div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg">
                    <i class="fas fa-save mr-2"></i> Save Gym Equipment
                </button>
            </form>
        </div>
        
        <div id="view-meal-log" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-yellow-600"><i class="fas fa-apple-alt mr-2"></i> Log a Meal</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="add-meal-form" class="space-y-4">
                <input type="text" placeholder="Meal Name (e.g., Chicken & Rice)" required name="meal-name"
                       class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500">
                <textarea placeholder="Nutritional Details / Ingredients" rows="4" name="meal-details"
                          class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                <button type="submit" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i> Log Meal
                </button>
            </form>
            
            <div id="logged-meals-summary" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border">
                <h3 class="text-xl font-bold text-gray-700">Today's Meals</h3>
                <p class="text-gray-500 italic" id="meal-list-placeholder">No meals logged today.</p>
                </div>
        </div>
        
        <div id="view-plan-workout" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-green-600"><i class="fas fa-hand-rock mr-2"></i> Select Training Focus</h2>
                <div class="space-x-2">
                    <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        &larr; Return to Dashboard
                    </button>
                </div>
            </div>
            
            <form id="workout-planning-form" class="space-y-4">
                <div>
                    <label for="workout-focus" class="block text-sm font-medium text-gray-700">What are you training?</label>
                    <select id="workout-focus"
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </select>
                </div>

                <div id="muscle-checkboxes" class="hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Select Target Muscles:</p>
                    <div id="muscle-options" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>
                </div>
                
                <button type="submit" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                    <i class="fas fa-forward mr-2"></i> Start Workout
                </button>
            </form>
        </div>

        <div id="view-track-workout" class="view-container p-6 bg-white rounded-2xl shadow-2xl border-2 border-green-500 space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-extrabold text-green-700">Active Workout: <span id="active-workout-title"></span></h2>
                <div class="space-x-2">
                    <button id="open-equipment-modal-btn" class="text-sm py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                        <i class="fas fa-tools mr-1"></i> Equipment
                    </button>
                    <button onclick="saveWorkout(); showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition shadow-md">
                        <i class="fas fa-times-circle mr-1"></i> Finish & Dashboard
                    </button>
                </div>
            </div>
            
            <form id="add-exercise-form" class="space-y-4 p-4 bg-green-50 rounded-xl border border-green-200">
                <h3 class="text-xl font-bold text-green-800"><i class="fas fa-plus mr-2"></i> Add Exercise</h3>
                
                <div>
                    <label for="exercise-select" class="block text-sm font-medium text-gray-700">Choose Exercise (Filtered by Equipment & Focus)</label>
                    <select id="exercise-select" required
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <option value="">-- Select an Exercise --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="sets-input" class="block text-sm font-medium text-gray-700">Sets</label>
                        <input type="number" id="sets-input" value="3" min="1" max="10" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="target-reps-input" class="block text-sm font-medium text-gray-700">Target Reps</label>
                        <input type="number" id="target-reps-input" value="10" min="1" max="50" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <button type="button" id="start-sets-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                    <i class="fas fa-cog mr-2"></i> Configure Sets
                </button>
            </form>

            <div id="sets-tracking-container" class="space-y-6">
                </div>
            
            <div id="logged-exercises-summary" class="mt-8 space-y-4">
                <h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises</h3>
                </div>
            
            <button id="finish-workout-btn" class="mt-8 w-full py-4 bg-indigo-600 text-white font-extrabold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-2xl">
                <i class="fas fa-flag-checkered mr-2"></i> Finish & Save Workout
            </button>
        </div>

        <div id="view-body-metrics" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
             <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-purple-700"><i class="fas fa-ruler-combined mr-2"></i> Body Metrics & Measurements</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <button id="add-measurement-btn-metrics"
                class="w-full sm:w-auto px-6 py-3 mb-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50"
                onclick="openMetricsModal()">
                <i class="fas fa-plus-circle mr-2"></i> Add New Measurement
            </button>

            <div id="measurements-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

            <div id="loading-state-metrics" class="text-center p-12">
                <i class="fas fa-spinner fa-spin text-4xl text-purple-500"></i>
                <p class="mt-4 text-gray-700 font-semibold">Initializing Firebase and loading data...</p>
            </div>
        </div>

        <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700"><i class="fas fa-medal mr-2"></i> Exercise History (Best Lifts)</h2>
                    <button id="close-history-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition">&times;</button>
                </div>
                <div id="history-content" class="p-6 overflow-y-auto custom-scroll space-y-4 flex-grow">
                    <p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>
                </div>
            </div>
        </div>
        
        <div id="equipment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-blue-100">
                    <h2 class="text-2xl font-bold text-blue-700"><i class="fas fa-sliders-h mr-2"></i> Adjust Available Equipment</h2>
                    <button id="close-equipment-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto custom-scroll flex-grow">
                    <form id="active-gym-setup-form" class="space-y-6">
                        <p class="text-gray-600 mb-4">Temporarily adjust what equipment is available right now. This will update your exercise selection.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                                <div id="active-weights-options" class="space-y-1 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                                <div id="active-cardio-options" class="space-y-1 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-expand-alt mr-2"></i> Functional / Floor</h3>
                                <div id="active-floor-options" class="space-y-1 text-sm"></div>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-150 shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i> Apply Changes & Close
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="measurement-modal" class="modal-metrics fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 opacity-0 pointer-events-none">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform fade-out transition-all">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">Record New Measurement</h2>
                    <form id="measurement-form">
                        <div class="space-y-4">
                            <div>
                                <label for="area-select" class="block text-sm font-medium text-gray-700 mb-1">Body Area</label>
                                <select
                                    id="area-select"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                ></select>
                            </div>

                            <div>
                                <label for="value-input" class="block text-sm font-medium text-gray-700 mb-1">Measurement Value</label>
                                <input
                                    id="value-input"
                                    type="number"
                                    step="0.1"
                                    placeholder="e.g., 32.5"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                />
                            </div>

                            <div>
                                <label for="unit-select" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                                <select
                                    id="unit-select"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                >
                                    <option value="inches">Inches</option>
                                    <option value="cm">Centimeters</option>
                                </select>
                            </div>
                        </div>

                        <button
                            type="submit"
                            id="save-measurement-btn-metrics"
                            class="mt-6 w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50"
                        >
                            Save Measurement
                        </button>
                    </form>
                    <button
                        onclick="closeMetricsModal()"
                        class="mt-4 w-full py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- FIREBASE IMPORTS (From Body Metrics Tracker) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- GLOBAL STATE AND DATA (Combined) ---
        let state = {
            currentView: 'dashboard',
            userName: "Alex Johnson",
            goal: "Build Strength & Endurance",
            gymName: "My Home Gym",
            gymSetup: { weights: ["dumbbell", "bench", "barbell", "cables", "weighted machines"], cardio: ["treadmill", "rower"], floor: ["TRX", "sandbag"] }, 
            exerciseHistory: {},
            currentWorkout: null,
            workoutLog: [],
            mealLog: [],
            previousView: 'dashboard',
        };

        const EQUIPMENT_MAP = {
            weights: ["bench", "barbell", "dumbbell", "pinstack machines", "weighted machines", "cables"],
            cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
            floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball", "floor"],
        };

        const FOCUS_OPTIONS = [
            "Full Body", "Upper Body", "Lower Body", "Press", "Pull", "Squat", "Hinge", "Specific Muscles", "Cardio"
        ];
        
        const MUSCLE_GROUPS = [
            "biceps", "triceps", "shoulders", "quads", "hamstrings", "abs", "chest", "lats", "upper back", "glutes", "calves"
        ];
        
        const BODY_AREAS = [
            'Neck', 'Chest', 'Waist', 'Hips', 'Right Bicep', 'Left Bicep', 'Right Thigh', 'Left Thigh',
            'Right Calf', 'Left Calf', 'Shoulders', 'Forearm',
        ];

        // Access global variables provided by the environment (Firebase related)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;


        // --- EXPANDED EXERCISE LIBRARY (Unchanged) ---
        const EXERCISE_LIBRARY = [
            // [Exercises as defined in the original Advanced Dashboard]
            { name: "Barbell Clean & Press", equipment: ["barbell"], focus: ["Full Body", "Press", "shoulders", "quads", "glutes"] },
            { name: "Dumbbell Thrusters", equipment: ["dumbbell"], focus: ["Full Body", "Squat", "Press", "shoulders", "quads"] },
            { name: "Sandbag Get-Ups", equipment: ["sandbag", "floor"], focus: ["Full Body", "abs", "shoulders"] },
            { name: "Medicine Ball Slams", equipment: ["medicine ball", "slam ball"], focus: ["Full Body", "abs"] },
            { name: "Barbell Bench Press", equipment: ["bench", "barbell"], focus: ["Upper Body", "Press", "chest", "triceps", "shoulders"] },
            { name: "Dumbbell Overhead Press", equipment: ["dumbbell"], focus: ["Upper Body", "Press", "shoulders", "triceps"] },
            { name: "Machine Chest Press", equipment: ["weighted machines", "pinstack machines"], focus: ["Upper Body", "Press", "chest", "triceps"] },
            { name: "Cable Crossover (High)", equipment: ["cables"], focus: ["Upper Body", "Press", "chest"] },
            { name: "Dumbbell Incline Press", equipment: ["bench", "dumbbell"], focus: ["Upper Body", "Press", "chest", "shoulders"] },
            { name: "Pinstack Shoulder Press", equipment: ["pinstack machines"], focus: ["Press", "shoulders", "triceps"] },
            { name: "Barbell Bent-Over Row", equipment: ["barbell"], focus: ["Upper Body", "Pull", "lats", "upper back", "biceps"] },
            { name: "Dumbbell Single-Arm Row", equipment: ["dumbbell", "bench"], focus: ["Upper Body", "Pull", "lats", "upper back"] },
            { name: "Cable Face Pulls", equipment: ["cables"], focus: ["Upper Body", "Pull", "upper back", "shoulders"] },
            { name: "Lat Pulldown (Machine)", equipment: ["pinstack machines"], focus: ["Upper Body", "Pull", "lats", "biceps"] },
            { name: "TRX Inverted Row", equipment: ["TRX"], focus: ["Upper Body", "Pull", "upper back", "biceps"] },
            { name: "Seated Cable Row", equipment: ["cables"], focus: ["Pull", "upper back", "lats", "biceps"] },
            { name: "Barbell Back Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes", "hamstrings", "calves"] },
            { name: "Dumbbell Goblet Squat", equipment: ["dumbbell", "floor"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Leg Extension (Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Squat", "quads"] },
            { name: "Leg Press (Machine)", equipment: ["weighted machines"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Dumbbell Bulgarian Split Squat", equipment: ["dumbbell", "bench"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Barbell Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes", "Full Body", "lats"] },
            { name: "Dumbbell Romanian Deadlift", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
            { name: "Cable Pull-Through", equipment: ["cables"], focus: ["Lower Body", "Hinge", "glutes", "hamstrings"] },
            { name: "Leg Curl (Machine)", equipment: ["pinstack machines", "weighted machines"], focus: ["Lower Body", "Hinge", "hamstrings"] },
            { name: "Glute-Ham Raise (Floor)", equipment: ["floor"], focus: ["Hinge", "hamstrings", "glutes"] },
            { name: "Dumbbell Hammer Curl", equipment: ["dumbbell"], focus: ["biceps"] },
            { name: "Barbell Bicep Curl", equipment: ["barbell"], focus: ["biceps"] },
            { name: "Cable Rope Tricep Pushdown", equipment: ["cables"], focus: ["triceps"] },
            { name: "Dumbbell Skullcrushers", equipment: ["dumbbell", "bench"], focus: ["triceps"] },
            { name: "Dumbbell Lateral Raise", equipment: ["dumbbell"], focus: ["shoulders"] },
            { name: "Cable Rear Delt Fly", equipment: ["cables"], focus: ["shoulders", "upper back"] },
            { name: "Machine Hip Abduction", equipment: ["weighted machines"], focus: ["glutes"] },
            { name: "Hanging Leg Raise", equipment: ["floor"], focus: ["abs"] },
            { name: "Weighted Machine Crunch", equipment: ["weighted machines"], focus: ["abs"] },
            { name: "Dumbbell Calf Raise", equipment: ["dumbbell"], focus: ["calves"] },
            { name: "Hyperextension (Floor)", equipment: ["floor"], focus: ["hamstrings", "glutes"] },
            { name: "Treadmill 5K Run", equipment: ["treadmill"], focus: ["Cardio", "Full Body"] },
            { name: "Rower 2000m Sprint", equipment: ["rower"], focus: ["Cardio", "Full Body"] },
            { name: "Assault Bike Interval", equipment: ["assault bike"], focus: ["Cardio", "Full Body"] },
            { name: "Cross Trainer Endurance", equipment: ["cross trainer"], focus: ["Cardio", "Full Body"] },
            { name: "Ski Erg 10 Minute Challenge", equipment: ["ski erg"], focus: ["Cardio", "Full Body", "Upper Body", "Pull"] },
            { name: "Step Machine Climb", equipment: ["step machine"], focus: ["Cardio", "Lower Body"] },
        ];


        // --- DOM ELEMENTS (Combined) ---
        const views = ['dashboard', 'gym-config', 'meal-log', 'plan-workout', 'track-workout', 'body-metrics'];
        const viewElements = views.reduce((acc, id) => {
            acc[id] = document.getElementById(`view-${id}`);
            return acc;
        }, {});
        
        const gymSetupForm = document.getElementById('gym-setup-form');
        const currentGymStatus = document.getElementById('current-gym-status');
        
        const workoutPlanningForm = document.getElementById('workout-planning-form');
        const workoutFocusSelect = document.getElementById('workout-focus');
        const muscleCheckboxesDiv = document.getElementById('muscle-checkboxes');
        const muscleOptionsDiv = document.getElementById('muscle-options');
        
        const activeWorkoutTitle = document.getElementById('active-workout-title');
        const exerciseSelect = document.getElementById('exercise-select');
        const setsInput = document.getElementById('sets-input');
        const targetRepsInput = document.getElementById('target-reps-input');
        const setsTrackingContainer = document.getElementById('sets-tracking-container');
        const loggedExercisesSummary = document.getElementById('logged-exercises-summary');
        
        const historyModal = document.getElementById('history-modal');
        const historyContent = document.getElementById('history-content');
        
        const equipmentModal = document.getElementById('equipment-modal');
        const activeGymSetupForm = document.getElementById('active-gym-setup-form');
        
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        const loggedMealsSummary = document.getElementById('logged-meals-summary');
        const mealListPlaceholder = document.getElementById('meal-list-placeholder');

        // Body Metrics Tracker Elements
        const statusMessageEl = document.getElementById('status-message');
        const loadingStateMetricsEl = document.getElementById('loading-state-metrics');
        const measurementsContainer = document.getElementById('measurements-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const addMeasurementBtnMetrics = document.getElementById('add-measurement-btn-metrics');
        const modalMetricsEl = document.getElementById('measurement-modal');
        const modalMetricsContentEl = modalMetricsEl.querySelector('.transform');
        const areaSelectEl = document.getElementById('area-select');
        const valueInputEl = document.getElementById('value-input');
        const unitSelectEl = document.getElementById('unit-select');
        const measurementForm = document.getElementById('measurement-form');


        // --- UTILITY & NAVIGATION FUNCTIONS (Combined) ---
        
        /** Manages the visibility of the application views. */
        window.showView = function(viewName, updateHistory = true) {
            // Guard clause if user tries to navigate away from an active, unsaved exercise
            if (state.currentWorkout && state.currentWorkout.currentExercise && viewName !== 'track-workout') {
                if (!confirmExit()) return;
            }
            
            if (updateHistory && state.currentView !== viewName) {
                state.previousView = state.currentView;
            }

            views.forEach(id => {
                const element = viewElements[id];
                if (element) { // Check if element exists before accessing classList
                    element.classList.add('hidden');
                    element.classList.remove('block');
                }
            });

            if (viewElements[viewName]) {
                viewElements[viewName].classList.remove('hidden');
                viewElements[viewName].classList.add('block'); 
                state.currentView = viewName;
            }
            
            // Special setup needed when entering certain views
            if (viewName === 'gym-config') {
                renderGymSetupCheckboxes(document.getElementById('weights-options'), document.getElementById('cardio-options'), document.getElementById('floor-options'));
                document.getElementById('gym-name').value = state.gymName;
            } else if (viewName === 'plan-workout') {
                renderExerciseDropdown();
            } else if (viewName === 'track-workout') {
                renderActiveEquipmentModal();
                updateLoggedExercisesSummary();
            } else if (viewName === 'meal-log') {
                renderMealLogSummary();
            } else if (viewName === 'body-metrics') {
                // Ensure the listener is active when this view is opened
                if (isAuthReady) {
                    loadingStateMetricsEl.classList.add('hidden');
                    startRealtimeListener(); 
                } else {
                    loadingStateMetricsEl.classList.remove('hidden');
                }
            }

            updateDashboardStatus();
        }

        /** Prompts user if they try to exit an active exercise without saving. */
        function confirmExit() {
             showMessage("Unsaved exercise cleared. Workout session remains active.", 'info', 5000);
             setsTrackingContainer.innerHTML = '';
             state.currentWorkout.currentExercise = null;
             return true;
        }

        /** Shows a temporary message in the custom box (Advanced Dashboard style). */
        function showMessage(message, type = 'success', duration = 3000) {
            let bgColor, borderColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-500';
                textColor = 'text-green-800';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-500';
                textColor = 'text-red-800';
            } else if (type === 'info') {
                bgColor = 'bg-blue-100';
                borderColor = 'border-blue-500';
                textColor = 'text-blue-800';
            } else if (type === 'metrics-error') { // New type for Firebase-related errors
                 bgColor = 'bg-purple-100';
                borderColor = 'border-purple-500';
                textColor = 'text-purple-800';
            }

            messageBox.className = `fixed top-4 right-4 z-50 p-4 ${bgColor} ${textColor} border-l-4 ${borderColor} rounded-lg shadow-xl font-medium transition-opacity duration-300 ease-in-out opacity-0`;
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('opacity-100'), 10);

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        /** Displays a message in the status bar (Error or Success - Body Metrics style) */
        function displayStatus(message, isError = false) {
             // Use the main status box for Firebase specific errors to match the original style
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'border-red-400', 'border-green-400', 'text-red-700', 'text-green-700');
            statusMessageEl.innerHTML = `<i class="mr-2 fas ${isError ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i> ${message}`;
            
            if (isError) {
                statusMessageEl.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700', 'px-4', 'py-3', 'rounded', 'relative');
            } else {
                statusMessageEl.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700', 'px-4', 'py-3', 'rounded', 'relative');
            }
        }
        
        /** Formats a number to 1 decimal place if it has a decimal, otherwise an integer. */
        function formatWeight(w) {
            return Number.isInteger(w) ? w : w.toFixed(1);
        }

        /** Calculates volume (Sets * Reps * Weight) */
        function calculateVolume(setsData) {
            return setsData.reduce((total, set) => total + (set.reps * set.weight), 0);
        }
        
        /** Updates the status text on the main dashboard */
        function updateDashboardStatus() {
             const totalEquipment = state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length;
             currentGymStatus.textContent = `${state.gymName} | ${totalEquipment} items available.`;
        }

        /** Formats ISO date to a readable string */
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ', ' +
                   date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        /** Formats a Date object into a readable string (for Metrics Tracker) */
        function formatDateMetrics(date) {
            if (!date) return 'N/A';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // --- BODY METRICS MODAL LOGIC (Adapted) ---
        
        window.openMetricsModal = function() {
            // Populate the area dropdown
            areaSelectEl.innerHTML = BODY_AREAS.map(area => `<option value="${area}">${area}</option>`).join('');
            
            // Reset form inputs
            valueInputEl.value = '';
            areaSelectEl.value = BODY_AREAS[0];
            unitSelectEl.value = 'inches';

            // Show modal
            modalMetricsEl.classList.remove('pointer-events-none', 'opacity-0');
            modalMetricsContentEl.classList.remove('fade-out');
            modalMetricsContentEl.classList.add('fade-in');
        }

        window.closeMetricsModal = function() {
            // Hide modal
            modalMetricsContentEl.classList.remove('fade-in');
            modalMetricsContentEl.classList.add('fade-out');
            setTimeout(() => {
                modalMetricsEl.classList.add('pointer-events-none', 'opacity-0');
            }, 300); 
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION (Merged) ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                displayStatus("Firebase configuration is missing.", true);
                loadingStateMetricsEl.classList.add('hidden');
                return;
            }
            
            try {
                setLogLevel('debug');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const handleAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        displayStatus("Failed to authenticate with Firebase.", true);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.innerHTML = `Firebase User ID: <span class="font-mono text-indigo-300">${userId}</span>`;
                        isAuthReady = true;
                        // Only start the listener if the user is in the metrics view
                        if (state.currentView === 'body-metrics') {
                             loadingStateMetricsEl.classList.add('hidden');
                             startRealtimeListener();
                        }
                    } else {
                        handleAuth();
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayStatus("Failed to initialize Firebase services.", true);
                loadingStateMetricsEl.classList.add('hidden');
            }
        }

        // --- FIRESTORE DATA LOGIC (Body Metrics) ---

        /** Sets up the real-time listener for measurements */
        function startRealtimeListener() {
            if (!isAuthReady || !db || !userId) {
                return;
            }

            const collectionPath = `artifacts/${appId}/users/${userId}/measurements`;
            const measurementsRef = collection(db, collectionPath);
            const q = query(measurementsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const fetchedMeasurements = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        area: data.area,
                        value: data.value,
                        unit: data.unit,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(),
                    };
                });
                
                renderMeasurements(fetchedMeasurements);
                loadingStateMetricsEl.classList.add('hidden');
                addMeasurementBtnMetrics.disabled = false;

            }, (err) => {
                console.error("Firestore onSnapshot error:", err);
                displayStatus("Failed to load measurements in real-time.", true);
                loadingStateMetricsEl.classList.add('hidden');
            });
        }

        /** Handles saving a new measurement from the modal form */
        async function handleSaveMeasurement(e) {
            e.preventDefault();

            const area = areaSelectEl.value;
            const value = parseFloat(valueInputEl.value);
            const unit = unitSelectEl.value;

            if (isNaN(value) || value <= 0 || !area) {
                showMessage("Please enter a valid positive value and select an area.", 'metrics-error');
                return;
            }

            if (!db || !userId) {
                showMessage("Metrics Tracker not ready. Please wait for initialization.", 'metrics-error');
                return;
            }

            const saveBtn = document.getElementById('save-measurement-btn-metrics');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/measurements`;
                const measurementsRef = collection(db, collectionPath);

                await addDoc(measurementsRef, {
                    userId,
                    area,
                    value,
                    unit,
                    timestamp: serverTimestamp(),
                });

                closeMetricsModal();
                showMessage(`Successfully recorded ${area} measurement!`, 'success');

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to save the measurement.", 'metrics-error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Measurement';
            }
        }

        // --- RENDERING LOGIC (Body Metrics) ---

        /** Groups and renders the measurements into cards */
        function renderMeasurements(measurements) {
            measurementsContainer.innerHTML = '';
            
            // 1. Group measurements by area
            const measurementsByArea = measurements.reduce((acc, current) => {
                const area = current.area;
                if (!acc[area]) { acc[area] = []; }
                acc[area].push(current);
                return acc;
            }, {});

            const areasMeasured = Object.keys(measurementsByArea).sort();

            if (areasMeasured.length === 0) {
                measurementsContainer.innerHTML = `
                    <div class="lg:col-span-3 text-center p-12 bg-white rounded-xl shadow-md border border-dashed border-purple-200">
                        <i class="fas fa-list-ul w-10 h-10 text-purple-400 mx-auto mb-3 text-3xl"></i>
                        <p class="text-gray-600 font-medium">No measurements recorded yet.</p>
                        <p class="text-sm text-gray-400 mt-1">Use the "Add New Measurement" button to start tracking your progress.</p>
                    </div>
                `;
                return;
            }

            // 2. Render a card for each area
            areasMeasured.forEach(area => {
                const areaMeasurements = measurementsByArea[area];
                
                const latest = areaMeasurements[0];
                const previous = areaMeasurements[1];
                
                let changeStatus = '';
                if (previous) {
                    const diff = latest.value - previous.value;
                    const sign = diff >= 0 ? '+' : '';
                    const color = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-600' : 'text-gray-500');
                    const icon = diff > 0 ? 'fa-arrow-up' : (diff < 0 ? 'fa-arrow-down' : 'fa-minus');
                    
                    changeStatus = `
                        <p class="text-sm font-medium mt-2 flex items-center ${color}">
                            <i class="fas ${icon} mr-1"></i> 
                            ${sign}${diff.toFixed(1)} ${latest.unit} (since last entry)
                        </p>
                    `;
                }

                const cardHtml = `
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-purple-200 transform hover:scale-[1.01] transition duration-200">
                        <h2 class="text-xl font-bold text-purple-700 mb-3 border-b pb-2">${area}</h2>
                        
                        <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-300 shadow-inner">
                            <p class="text-sm font-semibold text-purple-600 mb-1">Latest Reading (${formatDateMetrics(latest.timestamp)})</p>
                            <p class="text-4xl font-extrabold text-gray-900 leading-none">
                                ${latest.value.toFixed(1)}
                                <span class="text-base font-medium text-purple-500">${latest.unit}</span>
                            </p>
                            ${changeStatus}
                        </div>

                        ${areaMeasurements.length > 1 ? `
                            <p class="text-sm font-semibold text-gray-700 mt-4 mb-2">Previous Entries:</p>
                            <div class="space-y-1 max-h-28 overflow-y-auto">
                                ${areaMeasurements.slice(1, 4).map(m => `
                                    <div class="flex justify-between text-xs text-gray-600 border-b border-gray-100 py-1">
                                        <span>${formatDateMetrics(m.timestamp)}</span>
                                        <span class="font-bold">${m.value.toFixed(1)} ${m.unit}</span>
                                    </div>
                                `).join('')}
                                ${areaMeasurements.length > 4 ? `<p class="text-xs text-center text-gray-400 mt-2">... and ${areaMeasurements.length - 4} more</p>` : ''}
                            </div>
                        ` : ''}

                    </div>
                `;
                measurementsContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
        
        // --- OTHER RENDER & LOGIC FUNCTIONS (Unchanged from Advanced Dashboard) ---
        // [renderGymSetupCheckboxes, renderMuscleCheckboxes, renderWorkoutFocus, renderExerciseDropdown, renderSetsTracking, updateLoggedExercisesSummary, renderActiveEquipmentModal, renderMealLogSummary, renderHistory]
        // ... (All other functions from the Advanced Dashboard file are retained here for completeness) ...
        
        // --- HANDLERS (Unchanged from Advanced Dashboard) ---
        // [handleGymSetupSave, handleFocusChange, handleStartWorkout, handleSetRepWeightChange, handleSetInputUpdate, saveExercise, saveWorkout, handleMealLogSave]
        // ... (All other handlers from the Advanced Dashboard file are retained here for completeness) ...
        
        function renderGymSetupCheckboxes(weightsContainer, cardioContainer, floorContainer) {
            const currentSetup = state.gymSetup;
            const createCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = `gym-config-${item.replace(/\s/g, '-')}`;
                    const checked = currentSetup[category].includes(item) ? 'checked' : '';
                    return `<div class="flex items-center"><input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label></div>`;
                }).join('');
            };
            createCheckboxes(weightsContainer, 'weights');
            createCheckboxes(cardioContainer, 'cardio');
            createCheckboxes(floorContainer, 'floor');
        }

        function renderMuscleCheckboxes() {
            muscleOptionsDiv.innerHTML = MUSCLE_GROUPS.map(muscle => `<div class="flex items-center"><input id="muscle-${muscle}" type="checkbox" name="muscle" value="${muscle}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500"><label for="muscle-${muscle}" class="ml-2 text-gray-600 capitalize text-sm">${muscle}</label></div>`).join('');
        }

        function renderWorkoutFocus() {
            workoutFocusSelect.innerHTML = FOCUS_OPTIONS.map(focus => `<option value="${focus.toLowerCase().replace(/\s/g, '-')}">${focus}</option>`).join('');
            workoutFocusSelect.value = '';
            workoutFocusSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Choose Focus --</option>');
        }

        function renderExerciseDropdown() {
            const selectedFocus = workoutFocusSelect.value;
            const selectedMuscles = Array.from(document.querySelectorAll('#muscle-options input:checked')).map(cb => cb.value);
            const availableEquipment = [...state.gymSetup.weights, ...state.gymSetup.cardio, ...state.gymSetup.floor];
            let filteredExercises = EXERCISE_LIBRARY.filter(exercise => {
                const equipmentMatch = exercise.equipment.some(item => availableEquipment.includes(item));
                let focusMatch = false;
                const normalizedFocus = exercise.focus.map(f => f.toLowerCase().replace(/\s/g, '-'));
                if (selectedFocus === 'specific-muscles' && selectedMuscles.length > 0) {
                    focusMatch = selectedMuscles.some(muscle => normalizedFocus.includes(muscle));
                } else if (selectedFocus) {
                    focusMatch = normalizedFocus.includes(selectedFocus);
                } else {
                    focusMatch = true;
                }
                return equipmentMatch && focusMatch;
            });
            exerciseSelect.innerHTML = filteredExercises.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('');
            exerciseSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Select an Exercise --</option>');
            if (filteredExercises.length === 0 && selectedFocus) {
                showMessage("No exercises match your current gym setup and focus! Try selecting different equipment or focus.", 'error', 5000);
            }
        }
        
        function renderSetsTracking() {
            const exerciseName = exerciseSelect.value;
            const numSets = parseInt(setsInput.value);
            const targetReps = parseInt(targetRepsInput.value);
            if (!exerciseName || isNaN(numSets) || isNaN(targetReps) || numSets < 1 || targetReps < 1) {
                showMessage("Please select an exercise and enter valid sets/reps (min 1).", 'error');
                return;
            }
            state.currentWorkout.currentExercise = {
                name: exerciseName,
                setsData: Array.from({ length: numSets }, (_, i) => ({ set: i + 1, reps: targetReps, weight: 0.0 }))
            };
            const bestWeight = state.exerciseHistory[exerciseName]?.bestWeight || 0;
            setsTrackingContainer.innerHTML = state.currentWorkout.currentExercise.setsData.map((set, index) => {
                const setNumber = index + 1;
                return `<div class="set-row p-4 border border-gray-200 rounded-xl bg-gray-50 grid grid-cols-2 md:grid-cols-4 gap-4 items-center" data-set-index="${index}"><h4 class="font-bold text-lg text-green-700 col-span-2 md:col-span-1">Set ${setNumber}</h4><div class="flex items-center space-x-1"><label class="font-medium text-gray-700 text-sm">Reps:</label><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="-1" data-field="reps"><i class="fas fa-minus"></i></button><input type="number" value="${set.reps}" min="1" class="set-input-field w-10 text-center border-b-2 border-gray-400 text-sm" data-field="reps"><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="1" data-field="reps"><i class="fas fa-plus"></i></button></div><div class="flex items-center space-x-1"><label class="font-medium text-gray-700 text-sm">Weight (kg):</label><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="-2.5" data-field="weight"><i class="fas fa-minus"></i></button><input type="number" step="0.5" value="${formatWeight(set.weight)}" class="set-input-field w-12 text-center border-b-2 border-gray-400 text-sm" data-field="weight"><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="2.5" data-field="weight"><i class="fas fa-plus"></i></button></div><div class="text-sm text-gray-500 italic text-right col-span-2 md:col-span-1"><i class="fas fa-trophy text-yellow-500 mr-1"></i> PB: ${formatWeight(bestWeight)}kg</div></div>`;
            }).join('');
            setsTrackingContainer.insertAdjacentHTML('beforeend', `<button type="button" id="save-exercise-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg"><i class="fas fa-check-double mr-2"></i> Log Exercise: ${exerciseName}</button>`);
            document.getElementById('save-exercise-btn').addEventListener('click', saveExercise);
            document.querySelectorAll('.rep-change').forEach(btn => { btn.addEventListener('click', handleSetRepWeightChange); });
            document.querySelectorAll('.set-input-field').forEach(input => { input.addEventListener('change', handleSetInputUpdate); });
        }
        
        function updateLoggedExercisesSummary() {
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {
                loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises (0)</h3><p class="text-gray-500 italic">No exercises logged yet in this session.</p>`;
                return;
            }
            const items = state.currentWorkout.exercises.map(ex => {
                const totalVolume = calculateVolume(ex.setsData);
                const maxWeight = ex.setsData.reduce((max, s) => Math.max(max, s.weight), 0);
                return `<div class="p-3 border-l-4 border-green-400 bg-gray-50 rounded-lg"><p class="font-semibold text-gray-800">${ex.name}</p><p class="text-sm text-gray-600"><i class="fas fa-layer-group mr-1"></i> Sets: ${ex.setsData.length} | <i class="fas fa-weight-hanging mr-1"></i> Max Lift: ${formatWeight(maxWeight)}kg | <i class="fas fa-box-open mr-1"></i> Total Volume: ${formatWeight(totalVolume)}kg</p></div>`;
            }).join('');
            loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises (${state.currentWorkout.exercises.length})</h3><div class="space-y-2">${items}</div>`;
        }

        function renderActiveEquipmentModal() {
            const w = document.getElementById('active-weights-options');
            const c = document.getElementById('active-cardio-options');
            const f = document.getElementById('active-floor-options');
            const createModalCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = 'active-' + item.replace(/\s/g, '-');
                    const checked = state.gymSetup[category].includes(item) ? 'checked' : '';
                    return `<div class="flex items-center"><input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label></div>`;
                }).join('');
            };
            createModalCheckboxes(w, 'weights');
            createModalCheckboxes(c, 'cardio');
            createModalCheckboxes(f, 'floor');
        }
        
        function renderMealLogSummary() {
            if (state.mealLog.length === 0) {
                mealListPlaceholder.classList.remove('hidden');
                loggedMealsSummary.querySelector('#meal-list-container')?.remove();
                return;
            }
            mealListPlaceholder.classList.add('hidden');
            let listHtml = state.mealLog.map(meal => `<div class="p-3 border-l-4 border-yellow-400 bg-white rounded-lg shadow-sm"><p class="font-semibold text-gray-800">${meal.name}</p><p class="text-xs text-gray-500">${meal.details || 'No details provided'}</p><p class="text-xs text-yellow-600 mt-1">${formatDate(meal.date)}</p></div>`).join('');
            let listContainer = loggedMealsSummary.querySelector('#meal-list-container');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.id = 'meal-list-container';
                listContainer.className = 'space-y-3';
                loggedMealsSummary.appendChild(listContainer);
            }
            listContainer.innerHTML = listHtml;
        }

        function handleGymSetupSave(e) {
            e.preventDefault();
            const form = e.currentTarget;
            const formData = new FormData(form);
            const isModal = form.id === 'active-gym-setup-form';
            if (!isModal) { state.gymName = formData.get('gym-name') || "Custom Gym"; }
            state.gymSetup.weights = formData.getAll('weights');
            state.gymSetup.cardio = formData.getAll('cardio');
            state.gymSetup.floor = formData.getAll('floor');
            if (isModal) {
                equipmentModal.classList.add('hidden');
                renderExerciseDropdown();
                showMessage(`Equipment updated! Exercise list refreshed.`, 'info');
            } else {
                showMessage("Gym setup saved successfully!", 'success');
                showView('dashboard');
            }
        }
      
        function handleFocusChange() {
            const isSpecific = workoutFocusSelect.value === 'specific-muscles';
            muscleCheckboxesDiv.classList.toggle('hidden', !isSpecific);
            renderExerciseDropdown();
        }

        function handleStartWorkout(e) {
            e.preventDefault();
            const focus = workoutFocusSelect.value;
            if (!focus) { showMessage("Please select a training focus before starting.", 'error'); return; }
            state.currentWorkout = {
                title: focus.replace(/-/g, ' ').toUpperCase(),
                date: new Date().toISOString(),
                exercises: [],
                currentExercise: null,
            };
            activeWorkoutTitle.textContent = state.currentWorkout.title;
            setsTrackingContainer.innerHTML = '';
            updateLoggedExercisesSummary();
            showView('track-workout');
            renderExerciseDropdown();
            showMessage(`Workout started: ${state.currentWorkout.title}`, 'info', 4000);
        }

        function handleSetRepWeightChange(e) {
            const button = e.currentTarget;
            const delta = parseFloat(button.getAttribute('data-delta'));
            const field = button.getAttribute('data-field');
            const row = button.closest('.set-row');
            const inputField = row.querySelector(`.set-input-field[data-field="${field}"]`);
            let currentValue = parseFloat(inputField.value);
            let newValue = currentValue + delta;
            if (field === 'reps') {
                newValue = Math.max(1, Math.round(newValue));
            } else if (field === 'weight') {
                newValue = Math.max(0.0, newValue);
                newValue = parseFloat(newValue.toFixed(1));
            }
            inputField.value = formatWeight(newValue);
            handleSetInputUpdate({ currentTarget: inputField });
        }
      
        function handleSetInputUpdate(e) {
            const inputField = e.currentTarget;
            const row = inputField.closest('.set-row');
            const index = parseInt(row.getAttribute('data-set-index'));
            const field = inputField.getAttribute('data-field');
            let value = parseFloat(inputField.value);
            if (field === 'weight') { value = parseFloat(value.toFixed(1)); }
            if (state.currentWorkout?.currentExercise && !isNaN(value)) {
                state.currentWorkout.currentExercise.setsData[index][field] = value;
            }
        }

        function saveExercise() {
            if (!state.currentWorkout || !state.currentWorkout.currentExercise) { showMessage("Error: No active exercise to save.", 'error'); return; }
            const exercise = state.currentWorkout.currentExercise;
            const validSets = exercise.setsData.filter(s => s.weight > 0 || s.reps > 0);
            if (validSets.length === 0) { showMessage("Cannot save: No sets recorded positive reps or weight.", 'error'); return; }
            const volume = calculateVolume(validSets);
            const maxWeight = validSets.filter(s => s.reps > 0).reduce((max, s) => Math.max(max, s.weight), 0);
            if (!state.exerciseHistory[exercise.name] || maxWeight > state.exerciseHistory[exercise.name].bestWeight) {
                state.exerciseHistory[exercise.name] = { bestWeight: maxWeight, bestReps: validSets.find(s => s.weight === maxWeight)?.reps || 0, lastDate: new Date().toLocaleDateString(), };
                if (maxWeight > 0) { showMessage(`New PB for ${exercise.name}: ${formatWeight(maxWeight)}kg!`, 'success'); }
            }
            state.currentWorkout.exercises.push({ ...exercise, setsData: validSets, volume: volume, });
            setsTrackingContainer.innerHTML = '';
            exerciseSelect.value = '';
            setsInput.value = 3;
            targetRepsInput.value = 10;
            state.currentWorkout.currentExercise = null;
            updateLoggedExercisesSummary();
            showMessage(`${exercise.name} logged successfully! Total volume: ${formatWeight(volume)}kg.`, 'success');
        }

        window.saveWorkout = function() {
            if (state.currentWorkout?.currentExercise) {
                if (state.currentWorkout.currentExercise.setsData.some(s => s.weight > 0 || s.reps > 0)) { saveExercise(); } 
                else { state.currentWorkout.currentExercise = null; showMessage("Empty sets were discarded.", 'info'); }
            }
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) { showMessage("The workout is empty. No session saved.", 'error'); state.currentWorkout = null; return; }
            const totalVolume = state.currentWorkout.exercises.reduce((total, ex) => total + ex.volume, 0);
            state.workoutLog.push({ ...state.currentWorkout, totalVolume: totalVolume, duration: 'Simulated 45 min', });
            state.currentWorkout = null;
            showMessage(`Workout finished! Total volume lifted: ${formatWeight(totalVolume)}kg. Great job!`, 'success', 6000);
        }
        
        function handleMealLogSave(e) {
            e.preventDefault();
            const nameInput = e.target.querySelector('input[name="meal-name"]');
            const detailsInput = e.target.querySelector('textarea[name="meal-details"]');
            const mealName = nameInput.value.trim();
            const mealDetails = detailsInput.value.trim();
            if (mealName.length === 0) { showMessage("Please enter a name for the meal.", 'error'); return; }
            state.mealLog.push({ name: mealName, details: mealDetails, date: new Date().toISOString() });
            showMessage(`Meal "${mealName}" logged successfully!`, 'success');
            e.target.reset();
            renderMealLogSummary();
        }

        function renderHistory() {
            historyContent.innerHTML = '';
            const historyKeys = Object.keys(state.exerciseHistory).sort((a, b) => { return state.exerciseHistory[b].bestWeight - state.exerciseHistory[a].bestWeight; });
            if (historyKeys.length === 0) { historyContent.innerHTML = '<p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>'; return; }
            const items = historyKeys.map(name => {
                const item = state.exerciseHistory[name];
                return `<div class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm"><h4 class="text-xl font-bold text-gray-800">${name}</h4><p class="text-gray-600 mt-1"><i class="fas fa-arrow-up mr-1 text-red-500"></i> <span class="font-semibold">Best Weight:</span> ${formatWeight(item.bestWeight)}kg (for ${item.bestReps} reps)</p><p class="text-xs text-gray-400">Last PB Achieved: ${item.lastDate}</p></div>`;
            }).join('');
            historyContent.innerHTML = `<div class="space-y-4">${items}</div>`;
        }


        // --- INITIALIZATION & EVENT LISTENERS (Merged) ---

        function initApp() {
            // Load user info (currently hardcoded)
            document.getElementById('user-name').textContent = state.userName;
            document.getElementById('user-goal').textContent = state.goal;

            // Render initial controls
            renderMuscleCheckboxes();
            renderWorkoutFocus();
            updateDashboardStatus();
            
            // Setup default view
            showView('dashboard', false); 

            // Firebase Initialization must happen once on load
            initializeFirebase(); 

            // Event Listeners for forms
            gymSetupForm.addEventListener('submit', handleGymSetupSave);
            activeGymSetupForm.addEventListener('submit', handleGymSetupSave);
            workoutFocusSelect.addEventListener('change', handleFocusChange);
            workoutPlanningForm.addEventListener('submit', handleStartWorkout);
            document.getElementById('add-meal-form').addEventListener('submit', handleMealLogSave);
            
            // Body Metrics Listener
            measurementForm.addEventListener('submit', handleSaveMeasurement);
            
            // Active Workout Listeners
            document.getElementById('start-sets-btn').addEventListener('click', renderSetsTracking);
            document.getElementById('finish-workout-btn').addEventListener('click', () => {
                saveWorkout();
                showView('dashboard');
            });

            // Navigation Listeners
            document.getElementById('view-history-btn').addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
            });
            document.getElementById('close-history-btn').addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });

            // Equipment Modal Listeners
            document.getElementById('open-equipment-modal-btn').addEventListener('click', () => {
                renderActiveEquipmentModal();
                equipmentModal.classList.remove('hidden');
            });
            document.getElementById('close-equipment-modal-btn').addEventListener('click', () => {
                equipmentModal.classList.add('hidden');
            });
            
            // Re-render exercise list when muscles are checked/unchecked
            muscleOptionsDiv.addEventListener('change', () => {
                 if (workoutFocusSelect.value === 'specific-muscles') {
                    renderExerciseDropdown();
                 }
            });
        }

        // Run initialization when the page is ready
        window.onload = initApp;

    </script>

</body>
</html>
```eof

That's a great request! You have two distinct, complex single-file web applications:
 * Advanced Fitness Dashboard: Manages gym equipment configuration, workout planning, active workout tracking, and meal logging. (Pure JavaScript/HTML/Tailwind)
 * Body Metrics Tracker: Handles body measurements (e.g., waist, chest) and uses Firebase Firestore for real-time data persistence. (JavaScript/HTML/Tailwind/Firebase)
To merge them, I will combine the HTML structures, merge the CSS styles, and most critically, merge the JavaScript logic while ensuring both the pure JS state management (from the Dashboard) and the Firebase initialization/data handling (from the Metrics Tracker) work seamlessly together.
I will prioritize the more robust structure of the Advanced Fitness Dashboard and integrate the Body Metrics Tracker functionality as a new dedicated view, leveraging the existing modal logic where possible.
Key Integration Strategy:
 * Dashboard View Integration: Add the Body Metrics Tracker as a fifth primary button/view on the main dashboard.
 * HTML/CSS: Combine the <head> elements (including both sets of CSS) and nest the Body Metrics Tracker content (<main> and the measurement-modal) inside the main max-w-5xl container, styled to be a new view (#view-body-metrics).
 * JavaScript:
   * Place all Dashboard JS logic first in the combined <script type="module"> block.
   * Integrate the Firebase Imports and Global Constants (Firebase Config, Body Areas, etc.).
   * Merge the initApp and initializeFirebase functions, ensuring Firebase is ready before rendering the real-time data.
   * Adapt the Body Metrics JS functions (openModal, closeModal, startRealtimeListener, handleSaveMeasurement, renderMeasurements) to fit the new combined environment and be called from the new view's entry point.
Here is the complete, merged application.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Fitness & Metrics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* From Advanced Dashboard */
            transition: all 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics (From Advanced Dashboard) */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        .view-container {
            min-height: calc(100vh - 4rem);
        }
        /* Modal transitions (From Body Metrics) */
        .modal-metrics { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .fade-in { opacity: 1; transform: translateY(0); }
        .fade-out { opacity: 0; transform: translateY(-10px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <div id="message-box" class="fixed top-4 right-4 z-50 p-4 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-lg shadow-xl font-medium hidden transition-opacity duration-300 ease-in-out opacity-0">
            <p id="message-text"></p>
        </div>
        
        <div id="status-message" class="hidden mb-6"></div>

        <div id="view-dashboard" class="view-container space-y-8">
             <header class="bg-white p-6 rounded-2xl shadow-xl transition-all hover:shadow-2xl">
                <h1 class="text-4xl font-black text-gray-900 mb-2">Integrated Fitness Dashboard</h1>
                <div class="md:flex md:space-x-8">
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">User:</span> <span id="user-name"></span>
                    </p>
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">Goal:</span> <span id="user-goal"></span>
                    </p>
                    <p id="user-id-display" class="text-sm text-indigo-300 mt-1"></p>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <button onclick="showView('gym-config')" class="bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-dumbbell mr-2"></i> Configure Gym
                    <p id="current-gym-status" class="mt-1 text-sm opacity-80 italic"></p>
                </button>
                
                <button onclick="showView('plan-workout')" class="bg-green-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-running mr-2"></i> Plan Workout
                </button>
                
                <button onclick="showView('meal-log')" class="bg-yellow-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-utensils mr-2"></i> Log Meal
                </button>
                
                <button onclick="showView('body-metrics')" class="bg-purple-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-purple-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-ruler-combined mr-2"></i> Body Metrics
                </button>
                
                <button id="view-history-btn" class="bg-gray-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-chart-line mr-2"></i> View History
                </button>
                
            </div>
        </div>

        <div id="view-gym-config" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-indigo-700"><i class="fas fa-cogs mr-2"></i> Gym Setup Configuration</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="gym-setup-form" class="space-y-6">
                <div class="space-y-2">
                    <label for="gym-name" class="block text-sm font-medium text-gray-700">Gym Profile Name</label>
                    <input type="text" id="gym-name" name="gym-name" value="My Home Gym" required
                           class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                        <div id="weights-options" class="space-y-1 text-sm"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                        <div id="cardio-options" class="space-y-1 text-sm"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-expand-alt mr-2"></i> Functional / Floor</h3>
                        <div id="floor-options" class="space-y-1 text-sm"></div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg">
                    <i class="fas fa-save mr-2"></i> Save Gym Equipment
                </button>
            </form>
        </div>
        
        <div id="view-meal-log" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-yellow-600"><i class="fas fa-apple-alt mr-2"></i> Log a Meal</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="add-meal-form" class="space-y-4">
                <input type="text" placeholder="Meal Name (e.g., Chicken & Rice)" required name="meal-name"
                       class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500">
                <textarea placeholder="Nutritional Details / Ingredients" rows="4" name="meal-details"
                          class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                <button type="submit" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i> Log Meal
                </button>
            </form>
            
            <div id="logged-meals-summary" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border">
                <h3 class="text-xl font-bold text-gray-700">Today's Meals</h3>
                <p class="text-gray-500 italic" id="meal-list-placeholder">No meals logged today.</p>
                </div>
        </div>
        
        <div id="view-plan-workout" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-green-600"><i class="fas fa-hand-rock mr-2"></i> Select Training Focus</h2>
                <div class="space-x-2">
                    <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        &larr; Return to Dashboard
                    </button>
                </div>
            </div>
            
            <form id="workout-planning-form" class="space-y-4">
                <div>
                    <label for="workout-focus" class="block text-sm font-medium text-gray-700">What are you training?</label>
                    <select id="workout-focus"
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </select>
                </div>

                <div id="muscle-checkboxes" class="hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Select Target Muscles:</p>
                    <div id="muscle-options" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>
                </div>
                
                <button type="submit" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                    <i class="fas fa-forward mr-2"></i> Start Workout
                </button>
            </form>
        </div>

        <div id="view-track-workout" class="view-container p-6 bg-white rounded-2xl shadow-2xl border-2 border-green-500 space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-extrabold text-green-700">Active Workout: <span id="active-workout-title"></span></h2>
                <div class="space-x-2">
                    <button id="open-equipment-modal-btn" class="text-sm py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                        <i class="fas fa-tools mr-1"></i> Equipment
                    </button>
                    <button onclick="saveWorkout(); showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition shadow-md">
                        <i class="fas fa-times-circle mr-1"></i> Finish & Dashboard
                    </button>
                </div>
            </div>
            
            <form id="add-exercise-form" class="space-y-4 p-4 bg-green-50 rounded-xl border border-green-200">
                <h3 class="text-xl font-bold text-green-800"><i class="fas fa-plus mr-2"></i> Add Exercise</h3>
                
                <div>
                    <label for="exercise-select" class="block text-sm font-medium text-gray-700">Choose Exercise (Filtered by Equipment & Focus)</label>
                    <select id="exercise-select" required
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <option value="">-- Select an Exercise --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="sets-input" class="block text-sm font-medium text-gray-700">Sets</label>
                        <input type="number" id="sets-input" value="3" min="1" max="10" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="target-reps-input" class="block text-sm font-medium text-gray-700">Target Reps</label>
                        <input type="number" id="target-reps-input" value="10" min="1" max="50" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <button type="button" id="start-sets-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                    <i class="fas fa-cog mr-2"></i> Configure Sets
                </button>
            </form>

            <div id="sets-tracking-container" class="space-y-6">
                </div>
            
            <div id="logged-exercises-summary" class="mt-8 space-y-4">
                <h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises</h3>
                </div>
            
            <button id="finish-workout-btn" class="mt-8 w-full py-4 bg-indigo-600 text-white font-extrabold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-2xl">
                <i class="fas fa-flag-checkered mr-2"></i> Finish & Save Workout
            </button>
        </div>

        <div id="view-body-metrics" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
             <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-purple-700"><i class="fas fa-ruler-combined mr-2"></i> Body Metrics & Measurements</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <button id="add-measurement-btn-metrics"
                class="w-full sm:w-auto px-6 py-3 mb-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50"
                onclick="openMetricsModal()">
                <i class="fas fa-plus-circle mr-2"></i> Add New Measurement
            </button>

            <div id="measurements-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

            <div id="loading-state-metrics" class="text-center p-12">
                <i class="fas fa-spinner fa-spin text-4xl text-purple-500"></i>
                <p class="mt-4 text-gray-700 font-semibold">Initializing Firebase and loading data...</p>
            </div>
        </div>

        <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700"><i class="fas fa-medal mr-2"></i> Exercise History (Best Lifts)</h2>
                    <button id="close-history-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition">&times;</button>
                </div>
                <div id="history-content" class="p-6 overflow-y-auto custom-scroll space-y-4 flex-grow">
                    <p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>
                </div>
            </div>
        </div>
        
        <div id="equipment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-blue-100">
                    <h2 class="text-2xl font-bold text-blue-700"><i class="fas fa-sliders-h mr-2"></i> Adjust Available Equipment</h2>
                    <button id="close-equipment-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto custom-scroll flex-grow">
                    <form id="active-gym-setup-form" class="space-y-6">
                        <p class="text-gray-600 mb-4">Temporarily adjust what equipment is available right now. This will update your exercise selection.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                                <div id="active-weights-options" class="space-y-1 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                                <div id="active-cardio-options" class="space-y-1 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-expand-alt mr-2"></i> Functional / Floor</h3>
                                <div id="active-floor-options" class="space-y-1 text-sm"></div>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-150 shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i> Apply Changes & Close
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="measurement-modal" class="modal-metrics fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 opacity-0 pointer-events-none">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform fade-out transition-all">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">Record New Measurement</h2>
                    <form id="measurement-form">
                        <div class="space-y-4">
                            <div>
                                <label for="area-select" class="block text-sm font-medium text-gray-700 mb-1">Body Area</label>
                                <select
                                    id="area-select"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                ></select>
                            </div>

                            <div>
                                <label for="value-input" class="block text-sm font-medium text-gray-700 mb-1">Measurement Value</label>
                                <input
                                    id="value-input"
                                    type="number"
                                    step="0.1"
                                    placeholder="e.g., 32.5"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                />
                            </div>

                            <div>
                                <label for="unit-select" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                                <select
                                    id="unit-select"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                >
                                    <option value="inches">Inches</option>
                                    <option value="cm">Centimeters</option>
                                </select>
                            </div>
                        </div>

                        <button
                            type="submit"
                            id="save-measurement-btn-metrics"
                            class="mt-6 w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50"
                        >
                            Save Measurement
                        </button>
                    </form>
                    <button
                        onclick="closeMetricsModal()"
                        class="mt-4 w-full py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- FIREBASE IMPORTS (From Body Metrics Tracker) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- GLOBAL STATE AND DATA (Combined) ---
        let state = {
            currentView: 'dashboard',
            userName: "Alex Johnson",
            goal: "Build Strength & Endurance",
            gymName: "My Home Gym",
            gymSetup: { weights: ["dumbbell", "bench", "barbell", "cables", "weighted machines"], cardio: ["treadmill", "rower"], floor: ["TRX", "sandbag"] }, 
            exerciseHistory: {},
            currentWorkout: null,
            workoutLog: [],
            mealLog: [],
            previousView: 'dashboard',
        };

        const EQUIPMENT_MAP = {
            weights: ["bench", "barbell", "dumbbell", "pinstack machines", "weighted machines", "cables"],
            cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
            floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball", "floor"],
        };

        const FOCUS_OPTIONS = [
            "Full Body", "Upper Body", "Lower Body", "Press", "Pull", "Squat", "Hinge", "Specific Muscles", "Cardio"
        ];
        
        const MUSCLE_GROUPS = [
            "biceps", "triceps", "shoulders", "quads", "hamstrings", "abs", "chest", "lats", "upper back", "glutes", "calves"
        ];
        
        const BODY_AREAS = [
            'Neck', 'Chest', 'Waist', 'Hips', 'Right Bicep', 'Left Bicep', 'Right Thigh', 'Left Thigh',
            'Right Calf', 'Left Calf', 'Shoulders', 'Forearm',
        ];

        // Access global variables provided by the environment (Firebase related)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;


        // --- EXPANDED EXERCISE LIBRARY (Unchanged) ---
        const EXERCISE_LIBRARY = [
            // [Exercises as defined in the original Advanced Dashboard]
            { name: "Barbell Clean & Press", equipment: ["barbell"], focus: ["Full Body", "Press", "shoulders", "quads", "glutes"] },
            { name: "Dumbbell Thrusters", equipment: ["dumbbell"], focus: ["Full Body", "Squat", "Press", "shoulders", "quads"] },
            { name: "Sandbag Get-Ups", equipment: ["sandbag", "floor"], focus: ["Full Body", "abs", "shoulders"] },
            { name: "Medicine Ball Slams", equipment: ["medicine ball", "slam ball"], focus: ["Full Body", "abs"] },
            { name: "Barbell Bench Press", equipment: ["bench", "barbell"], focus: ["Upper Body", "Press", "chest", "triceps", "shoulders"] },
            { name: "Dumbbell Overhead Press", equipment: ["dumbbell"], focus: ["Upper Body", "Press", "shoulders", "triceps"] },
            { name: "Machine Chest Press", equipment: ["weighted machines", "pinstack machines"], focus: ["Upper Body", "Press", "chest", "triceps"] },
            { name: "Cable Crossover (High)", equipment: ["cables"], focus: ["Upper Body", "Press", "chest"] },
            { name: "Dumbbell Incline Press", equipment: ["bench", "dumbbell"], focus: ["Upper Body", "Press", "chest", "shoulders"] },
            { name: "Pinstack Shoulder Press", equipment: ["pinstack machines"], focus: ["Press", "shoulders", "triceps"] },
            { name: "Barbell Bent-Over Row", equipment: ["barbell"], focus: ["Upper Body", "Pull", "lats", "upper back", "biceps"] },
            { name: "Dumbbell Single-Arm Row", equipment: ["dumbbell", "bench"], focus: ["Upper Body", "Pull", "lats", "upper back"] },
            { name: "Cable Face Pulls", equipment: ["cables"], focus: ["Upper Body", "Pull", "upper back", "shoulders"] },
            { name: "Lat Pulldown (Machine)", equipment: ["pinstack machines"], focus: ["Upper Body", "Pull", "lats", "biceps"] },
            { name: "TRX Inverted Row", equipment: ["TRX"], focus: ["Upper Body", "Pull", "upper back", "biceps"] },
            { name: "Seated Cable Row", equipment: ["cables"], focus: ["Pull", "upper back", "lats", "biceps"] },
            { name: "Barbell Back Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes", "hamstrings", "calves"] },
            { name: "Dumbbell Goblet Squat", equipment: ["dumbbell", "floor"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Leg Extension (Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Squat", "quads"] },
            { name: "Leg Press (Machine)", equipment: ["weighted machines"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Dumbbell Bulgarian Split Squat", equipment: ["dumbbell", "bench"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Barbell Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes", "Full Body", "lats"] },
            { name: "Dumbbell Romanian Deadlift", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
            { name: "Cable Pull-Through", equipment: ["cables"], focus: ["Lower Body", "Hinge", "glutes", "hamstrings"] },
            { name: "Leg Curl (Machine)", equipment: ["pinstack machines", "weighted machines"], focus: ["Lower Body", "Hinge", "hamstrings"] },
            { name: "Glute-Ham Raise (Floor)", equipment: ["floor"], focus: ["Hinge", "hamstrings", "glutes"] },
            { name: "Dumbbell Hammer Curl", equipment: ["dumbbell"], focus: ["biceps"] },
            { name: "Barbell Bicep Curl", equipment: ["barbell"], focus: ["biceps"] },
            { name: "Cable Rope Tricep Pushdown", equipment: ["cables"], focus: ["triceps"] },
            { name: "Dumbbell Skullcrushers", equipment: ["dumbbell", "bench"], focus: ["triceps"] },
            { name: "Dumbbell Lateral Raise", equipment: ["dumbbell"], focus: ["shoulders"] },
            { name: "Cable Rear Delt Fly", equipment: ["cables"], focus: ["shoulders", "upper back"] },
            { name: "Machine Hip Abduction", equipment: ["weighted machines"], focus: ["glutes"] },
            { name: "Hanging Leg Raise", equipment: ["floor"], focus: ["abs"] },
            { name: "Weighted Machine Crunch", equipment: ["weighted machines"], focus: ["abs"] },
            { name: "Dumbbell Calf Raise", equipment: ["dumbbell"], focus: ["calves"] },
            { name: "Hyperextension (Floor)", equipment: ["floor"], focus: ["hamstrings", "glutes"] },
            { name: "Treadmill 5K Run", equipment: ["treadmill"], focus: ["Cardio", "Full Body"] },
            { name: "Rower 2000m Sprint", equipment: ["rower"], focus: ["Cardio", "Full Body"] },
            { name: "Assault Bike Interval", equipment: ["assault bike"], focus: ["Cardio", "Full Body"] },
            { name: "Cross Trainer Endurance", equipment: ["cross trainer"], focus: ["Cardio", "Full Body"] },
            { name: "Ski Erg 10 Minute Challenge", equipment: ["ski erg"], focus: ["Cardio", "Full Body", "Upper Body", "Pull"] },
            { name: "Step Machine Climb", equipment: ["step machine"], focus: ["Cardio", "Lower Body"] },
        ];


        // --- DOM ELEMENTS (Combined) ---
        const views = ['dashboard', 'gym-config', 'meal-log', 'plan-workout', 'track-workout', 'body-metrics'];
        const viewElements = views.reduce((acc, id) => {
            acc[id] = document.getElementById(`view-${id}`);
            return acc;
        }, {});
        
        const gymSetupForm = document.getElementById('gym-setup-form');
        const currentGymStatus = document.getElementById('current-gym-status');
        
        const workoutPlanningForm = document.getElementById('workout-planning-form');
        const workoutFocusSelect = document.getElementById('workout-focus');
        const muscleCheckboxesDiv = document.getElementById('muscle-checkboxes');
        const muscleOptionsDiv = document.getElementById('muscle-options');
        
        const activeWorkoutTitle = document.getElementById('active-workout-title');
        const exerciseSelect = document.getElementById('exercise-select');
        const setsInput = document.getElementById('sets-input');
        const targetRepsInput = document.getElementById('target-reps-input');
        const setsTrackingContainer = document.getElementById('sets-tracking-container');
        const loggedExercisesSummary = document.getElementById('logged-exercises-summary');
        
        const historyModal = document.getElementById('history-modal');
        const historyContent = document.getElementById('history-content');
        
        const equipmentModal = document.getElementById('equipment-modal');
        const activeGymSetupForm = document.getElementById('active-gym-setup-form');
        
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        const loggedMealsSummary = document.getElementById('logged-meals-summary');
        const mealListPlaceholder = document.getElementById('meal-list-placeholder');

        // Body Metrics Tracker Elements
        const statusMessageEl = document.getElementById('status-message');
        const loadingStateMetricsEl = document.getElementById('loading-state-metrics');
        const measurementsContainer = document.getElementById('measurements-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const addMeasurementBtnMetrics = document.getElementById('add-measurement-btn-metrics');
        const modalMetricsEl = document.getElementById('measurement-modal');
        const modalMetricsContentEl = modalMetricsEl.querySelector('.transform');
        const areaSelectEl = document.getElementById('area-select');
        const valueInputEl = document.getElementById('value-input');
        const unitSelectEl = document.getElementById('unit-select');
        const measurementForm = document.getElementById('measurement-form');


        // --- UTILITY & NAVIGATION FUNCTIONS (Combined) ---
        
        /** Manages the visibility of the application views. */
        window.showView = function(viewName, updateHistory = true) {
            // Guard clause if user tries to navigate away from an active, unsaved exercise
            if (state.currentWorkout && state.currentWorkout.currentExercise && viewName !== 'track-workout') {
                if (!confirmExit()) return;
            }
            
            if (updateHistory && state.currentView !== viewName) {
                state.previousView = state.currentView;
            }

            views.forEach(id => {
                const element = viewElements[id];
                if (element) { // Check if element exists before accessing classList
                    element.classList.add('hidden');
                    element.classList.remove('block');
                }
            });

            if (viewElements[viewName]) {
                viewElements[viewName].classList.remove('hidden');
                viewElements[viewName].classList.add('block'); 
                state.currentView = viewName;
            }
            
            // Special setup needed when entering certain views
            if (viewName === 'gym-config') {
                renderGymSetupCheckboxes(document.getElementById('weights-options'), document.getElementById('cardio-options'), document.getElementById('floor-options'));
                document.getElementById('gym-name').value = state.gymName;
            } else if (viewName === 'plan-workout') {
                renderExerciseDropdown();
            } else if (viewName === 'track-workout') {
                renderActiveEquipmentModal();
                updateLoggedExercisesSummary();
            } else if (viewName === 'meal-log') {
                renderMealLogSummary();
            } else if (viewName === 'body-metrics') {
                // Ensure the listener is active when this view is opened
                if (isAuthReady) {
                    loadingStateMetricsEl.classList.add('hidden');
                    startRealtimeListener(); 
                } else {
                    loadingStateMetricsEl.classList.remove('hidden');
                }
            }

            updateDashboardStatus();
        }

        /** Prompts user if they try to exit an active exercise without saving. */
        function confirmExit() {
             showMessage("Unsaved exercise cleared. Workout session remains active.", 'info', 5000);
             setsTrackingContainer.innerHTML = '';
             state.currentWorkout.currentExercise = null;
             return true;
        }

        /** Shows a temporary message in the custom box (Advanced Dashboard style). */
        function showMessage(message, type = 'success', duration = 3000) {
            let bgColor, borderColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-500';
                textColor = 'text-green-800';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-500';
                textColor = 'text-red-800';
            } else if (type === 'info') {
                bgColor = 'bg-blue-100';
                borderColor = 'border-blue-500';
                textColor = 'text-blue-800';
            } else if (type === 'metrics-error') { // New type for Firebase-related errors
                 bgColor = 'bg-purple-100';
                borderColor = 'border-purple-500';
                textColor = 'text-purple-800';
            }

            messageBox.className = `fixed top-4 right-4 z-50 p-4 ${bgColor} ${textColor} border-l-4 ${borderColor} rounded-lg shadow-xl font-medium transition-opacity duration-300 ease-in-out opacity-0`;
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('opacity-100'), 10);

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        /** Displays a message in the status bar (Error or Success - Body Metrics style) */
        function displayStatus(message, isError = false) {
             // Use the main status box for Firebase specific errors to match the original style
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'border-red-400', 'border-green-400', 'text-red-700', 'text-green-700');
            statusMessageEl.innerHTML = `<i class="mr-2 fas ${isError ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i> ${message}`;
            
            if (isError) {
                statusMessageEl.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700', 'px-4', 'py-3', 'rounded', 'relative');
            } else {
                statusMessageEl.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700', 'px-4', 'py-3', 'rounded', 'relative');
            }
        }
        
        /** Formats a number to 1 decimal place if it has a decimal, otherwise an integer. */
        function formatWeight(w) {
            return Number.isInteger(w) ? w : w.toFixed(1);
        }

        /** Calculates volume (Sets * Reps * Weight) */
        function calculateVolume(setsData) {
            return setsData.reduce((total, set) => total + (set.reps * set.weight), 0);
        }
        
        /** Updates the status text on the main dashboard */
        function updateDashboardStatus() {
             const totalEquipment = state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length;
             currentGymStatus.textContent = `${state.gymName} | ${totalEquipment} items available.`;
        }

        /** Formats ISO date to a readable string */
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ', ' +
                   date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        /** Formats a Date object into a readable string (for Metrics Tracker) */
        function formatDateMetrics(date) {
            if (!date) return 'N/A';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // --- BODY METRICS MODAL LOGIC (Adapted) ---
        
        window.openMetricsModal = function() {
            // Populate the area dropdown
            areaSelectEl.innerHTML = BODY_AREAS.map(area => `<option value="${area}">${area}</option>`).join('');
            
            // Reset form inputs
            valueInputEl.value = '';
            areaSelectEl.value = BODY_AREAS[0];
            unitSelectEl.value = 'inches';

            // Show modal
            modalMetricsEl.classList.remove('pointer-events-none', 'opacity-0');
            modalMetricsContentEl.classList.remove('fade-out');
            modalMetricsContentEl.classList.add('fade-in');
        }

        window.closeMetricsModal = function() {
            // Hide modal
            modalMetricsContentEl.classList.remove('fade-in');
            modalMetricsContentEl.classList.add('fade-out');
            setTimeout(() => {
                modalMetricsEl.classList.add('pointer-events-none', 'opacity-0');
            }, 300); 
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION (Merged) ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                displayStatus("Firebase configuration is missing.", true);
                loadingStateMetricsEl.classList.add('hidden');
                return;
            }
            
            try {
                setLogLevel('debug');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const handleAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        displayStatus("Failed to authenticate with Firebase.", true);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.innerHTML = `Firebase User ID: <span class="font-mono text-indigo-300">${userId}</span>`;
                        isAuthReady = true;
                        // Only start the listener if the user is in the metrics view
                        if (state.currentView === 'body-metrics') {
                             loadingStateMetricsEl.classList.add('hidden');
                             startRealtimeListener();
                        }
                    } else {
                        handleAuth();
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayStatus("Failed to initialize Firebase services.", true);
                loadingStateMetricsEl.classList.add('hidden');
            }
        }

        // --- FIRESTORE DATA LOGIC (Body Metrics) ---

        /** Sets up the real-time listener for measurements */
        function startRealtimeListener() {
            if (!isAuthReady || !db || !userId) {
                return;
            }

            const collectionPath = `artifacts/${appId}/users/${userId}/measurements`;
            const measurementsRef = collection(db, collectionPath);
            const q = query(measurementsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const fetchedMeasurements = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        area: data.area,
                        value: data.value,
                        unit: data.unit,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(),
                    };
                });
                
                renderMeasurements(fetchedMeasurements);
                loadingStateMetricsEl.classList.add('hidden');
                addMeasurementBtnMetrics.disabled = false;

            }, (err) => {
                console.error("Firestore onSnapshot error:", err);
                displayStatus("Failed to load measurements in real-time.", true);
                loadingStateMetricsEl.classList.add('hidden');
            });
        }

        /** Handles saving a new measurement from the modal form */
        async function handleSaveMeasurement(e) {
            e.preventDefault();

            const area = areaSelectEl.value;
            const value = parseFloat(valueInputEl.value);
            const unit = unitSelectEl.value;

            if (isNaN(value) || value <= 0 || !area) {
                showMessage("Please enter a valid positive value and select an area.", 'metrics-error');
                return;
            }

            if (!db || !userId) {
                showMessage("Metrics Tracker not ready. Please wait for initialization.", 'metrics-error');
                return;
            }

            const saveBtn = document.getElementById('save-measurement-btn-metrics');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/measurements`;
                const measurementsRef = collection(db, collectionPath);

                await addDoc(measurementsRef, {
                    userId,
                    area,
                    value,
                    unit,
                    timestamp: serverTimestamp(),
                });

                closeMetricsModal();
                showMessage(`Successfully recorded ${area} measurement!`, 'success');

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to save the measurement.", 'metrics-error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Measurement';
            }
        }

        // --- RENDERING LOGIC (Body Metrics) ---

        /** Groups and renders the measurements into cards */
        function renderMeasurements(measurements) {
            measurementsContainer.innerHTML = '';
            
            // 1. Group measurements by area
            const measurementsByArea = measurements.reduce((acc, current) => {
                const area = current.area;
                if (!acc[area]) { acc[area] = []; }
                acc[area].push(current);
                return acc;
            }, {});

            const areasMeasured = Object.keys(measurementsByArea).sort();

            if (areasMeasured.length === 0) {
                measurementsContainer.innerHTML = `
                    <div class="lg:col-span-3 text-center p-12 bg-white rounded-xl shadow-md border border-dashed border-purple-200">
                        <i class="fas fa-list-ul w-10 h-10 text-purple-400 mx-auto mb-3 text-3xl"></i>
                        <p class="text-gray-600 font-medium">No measurements recorded yet.</p>
                        <p class="text-sm text-gray-400 mt-1">Use the "Add New Measurement" button to start tracking your progress.</p>
                    </div>
                `;
                return;
            }

            // 2. Render a card for each area
            areasMeasured.forEach(area => {
                const areaMeasurements = measurementsByArea[area];
                
                const latest = areaMeasurements[0];
                const previous = areaMeasurements[1];
                
                let changeStatus = '';
                if (previous) {
                    const diff = latest.value - previous.value;
                    const sign = diff >= 0 ? '+' : '';
                    const color = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-600' : 'text-gray-500');
                    const icon = diff > 0 ? 'fa-arrow-up' : (diff < 0 ? 'fa-arrow-down' : 'fa-minus');
                    
                    changeStatus = `
                        <p class="text-sm font-medium mt-2 flex items-center ${color}">
                            <i class="fas ${icon} mr-1"></i> 
                            ${sign}${diff.toFixed(1)} ${latest.unit} (since last entry)
                        </p>
                    `;
                }

                const cardHtml = `
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-purple-200 transform hover:scale-[1.01] transition duration-200">
                        <h2 class="text-xl font-bold text-purple-700 mb-3 border-b pb-2">${area}</h2>
                        
                        <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-300 shadow-inner">
                            <p class="text-sm font-semibold text-purple-600 mb-1">Latest Reading (${formatDateMetrics(latest.timestamp)})</p>
                            <p class="text-4xl font-extrabold text-gray-900 leading-none">
                                ${latest.value.toFixed(1)}
                                <span class="text-base font-medium text-purple-500">${latest.unit}</span>
                            </p>
                            ${changeStatus}
                        </div>

                        ${areaMeasurements.length > 1 ? `
                            <p class="text-sm font-semibold text-gray-700 mt-4 mb-2">Previous Entries:</p>
                            <div class="space-y-1 max-h-28 overflow-y-auto">
                                ${areaMeasurements.slice(1, 4).map(m => `
                                    <div class="flex justify-between text-xs text-gray-600 border-b border-gray-100 py-1">
                                        <span>${formatDateMetrics(m.timestamp)}</span>
                                        <span class="font-bold">${m.value.toFixed(1)} ${m.unit}</span>
                                    </div>
                                `).join('')}
                                ${areaMeasurements.length > 4 ? `<p class="text-xs text-center text-gray-400 mt-2">... and ${areaMeasurements.length - 4} more</p>` : ''}
                            </div>
                        ` : ''}

                    </div>
                `;
                measurementsContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
        
        // --- OTHER RENDER & LOGIC FUNCTIONS (Unchanged from Advanced Dashboard) ---
        // [renderGymSetupCheckboxes, renderMuscleCheckboxes, renderWorkoutFocus, renderExerciseDropdown, renderSetsTracking, updateLoggedExercisesSummary, renderActiveEquipmentModal, renderMealLogSummary, renderHistory]
        // ... (All other functions from the Advanced Dashboard file are retained here for completeness) ...
        
        // --- HANDLERS (Unchanged from Advanced Dashboard) ---
        // [handleGymSetupSave, handleFocusChange, handleStartWorkout, handleSetRepWeightChange, handleSetInputUpdate, saveExercise, saveWorkout, handleMealLogSave]
        // ... (All other handlers from the Advanced Dashboard file are retained here for completeness) ...
        
        function renderGymSetupCheckboxes(weightsContainer, cardioContainer, floorContainer) {
            const currentSetup = state.gymSetup;
            const createCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = `gym-config-${item.replace(/\s/g, '-')}`;
                    const checked = currentSetup[category].includes(item) ? 'checked' : '';
                    return `<div class="flex items-center"><input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label></div>`;
                }).join('');
            };
            createCheckboxes(weightsContainer, 'weights');
            createCheckboxes(cardioContainer, 'cardio');
            createCheckboxes(floorContainer, 'floor');
        }

        function renderMuscleCheckboxes() {
            muscleOptionsDiv.innerHTML = MUSCLE_GROUPS.map(muscle => `<div class="flex items-center"><input id="muscle-${muscle}" type="checkbox" name="muscle" value="${muscle}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500"><label for="muscle-${muscle}" class="ml-2 text-gray-600 capitalize text-sm">${muscle}</label></div>`).join('');
        }

        function renderWorkoutFocus() {
            workoutFocusSelect.innerHTML = FOCUS_OPTIONS.map(focus => `<option value="${focus.toLowerCase().replace(/\s/g, '-')}">${focus}</option>`).join('');
            workoutFocusSelect.value = '';
            workoutFocusSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Choose Focus --</option>');
        }

        function renderExerciseDropdown() {
            const selectedFocus = workoutFocusSelect.value;
            const selectedMuscles = Array.from(document.querySelectorAll('#muscle-options input:checked')).map(cb => cb.value);
            const availableEquipment = [...state.gymSetup.weights, ...state.gymSetup.cardio, ...state.gymSetup.floor];
            let filteredExercises = EXERCISE_LIBRARY.filter(exercise => {
                const equipmentMatch = exercise.equipment.some(item => availableEquipment.includes(item));
                let focusMatch = false;
                const normalizedFocus = exercise.focus.map(f => f.toLowerCase().replace(/\s/g, '-'));
                if (selectedFocus === 'specific-muscles' && selectedMuscles.length > 0) {
                    focusMatch = selectedMuscles.some(muscle => normalizedFocus.includes(muscle));
                } else if (selectedFocus) {
                    focusMatch = normalizedFocus.includes(selectedFocus);
                } else {
                    focusMatch = true;
                }
                return equipmentMatch && focusMatch;
            });
            exerciseSelect.innerHTML = filteredExercises.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('');
            exerciseSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Select an Exercise --</option>');
            if (filteredExercises.length === 0 && selectedFocus) {
                showMessage("No exercises match your current gym setup and focus! Try selecting different equipment or focus.", 'error', 5000);
            }
        }
        
        function renderSetsTracking() {
            const exerciseName = exerciseSelect.value;
            const numSets = parseInt(setsInput.value);
            const targetReps = parseInt(targetRepsInput.value);
            if (!exerciseName || isNaN(numSets) || isNaN(targetReps) || numSets < 1 || targetReps < 1) {
                showMessage("Please select an exercise and enter valid sets/reps (min 1).", 'error');
                return;
            }
            state.currentWorkout.currentExercise = {
                name: exerciseName,
                setsData: Array.from({ length: numSets }, (_, i) => ({ set: i + 1, reps: targetReps, weight: 0.0 }))
            };
            const bestWeight = state.exerciseHistory[exerciseName]?.bestWeight || 0;
            setsTrackingContainer.innerHTML = state.currentWorkout.currentExercise.setsData.map((set, index) => {
                const setNumber = index + 1;
                return `<div class="set-row p-4 border border-gray-200 rounded-xl bg-gray-50 grid grid-cols-2 md:grid-cols-4 gap-4 items-center" data-set-index="${index}"><h4 class="font-bold text-lg text-green-700 col-span-2 md:col-span-1">Set ${setNumber}</h4><div class="flex items-center space-x-1"><label class="font-medium text-gray-700 text-sm">Reps:</label><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="-1" data-field="reps"><i class="fas fa-minus"></i></button><input type="number" value="${set.reps}" min="1" class="set-input-field w-10 text-center border-b-2 border-gray-400 text-sm" data-field="reps"><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="1" data-field="reps"><i class="fas fa-plus"></i></button></div><div class="flex items-center space-x-1"><label class="font-medium text-gray-700 text-sm">Weight (kg):</label><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="-2.5" data-field="weight"><i class="fas fa-minus"></i></button><input type="number" step="0.5" value="${formatWeight(set.weight)}" class="set-input-field w-12 text-center border-b-2 border-gray-400 text-sm" data-field="weight"><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="2.5" data-field="weight"><i class="fas fa-plus"></i></button></div><div class="text-sm text-gray-500 italic text-right col-span-2 md:col-span-1"><i class="fas fa-trophy text-yellow-500 mr-1"></i> PB: ${formatWeight(bestWeight)}kg</div></div>`;
            }).join('');
            setsTrackingContainer.insertAdjacentHTML('beforeend', `<button type="button" id="save-exercise-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg"><i class="fas fa-check-double mr-2"></i> Log Exercise: ${exerciseName}</button>`);
            document.getElementById('save-exercise-btn').addEventListener('click', saveExercise);
            document.querySelectorAll('.rep-change').forEach(btn => { btn.addEventListener('click', handleSetRepWeightChange); });
            document.querySelectorAll('.set-input-field').forEach(input => { input.addEventListener('change', handleSetInputUpdate); });
        }
        
        function updateLoggedExercisesSummary() {
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {
                loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises (0)</h3><p class="text-gray-500 italic">No exercises logged yet in this session.</p>`;
                return;
            }
            const items = state.currentWorkout.exercises.map(ex => {
                const totalVolume = calculateVolume(ex.setsData);
                const maxWeight = ex.setsData.reduce((max, s) => Math.max(max, s.weight), 0);
                return `<div class="p-3 border-l-4 border-green-400 bg-gray-50 rounded-lg"><p class="font-semibold text-gray-800">${ex.name}</p><p class="text-sm text-gray-600"><i class="fas fa-layer-group mr-1"></i> Sets: ${ex.setsData.length} | <i class="fas fa-weight-hanging mr-1"></i> Max Lift: ${formatWeight(maxWeight)}kg | <i class="fas fa-box-open mr-1"></i> Total Volume: ${formatWeight(totalVolume)}kg</p></div>`;
            }).join('');
            loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises (${state.currentWorkout.exercises.length})</h3><div class="space-y-2">${items}</div>`;
        }

        function renderActiveEquipmentModal() {
            const w = document.getElementById('active-weights-options');
            const c = document.getElementById('active-cardio-options');
            const f = document.getElementById('active-floor-options');
            const createModalCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = 'active-' + item.replace(/\s/g, '-');
                    const checked = state.gymSetup[category].includes(item) ? 'checked' : '';
                    return `<div class="flex items-center"><input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label></div>`;
                }).join('');
            };
            createModalCheckboxes(w, 'weights');
            createModalCheckboxes(c, 'cardio');
            createModalCheckboxes(f, 'floor');
        }
        
        function renderMealLogSummary() {
            if (state.mealLog.length === 0) {
                mealListPlaceholder.classList.remove('hidden');
                loggedMealsSummary.querySelector('#meal-list-container')?.remove();
                return;
            }
            mealListPlaceholder.classList.add('hidden');
            let listHtml = state.mealLog.map(meal => `<div class="p-3 border-l-4 border-yellow-400 bg-white rounded-lg shadow-sm"><p class="font-semibold text-gray-800">${meal.name}</p><p class="text-xs text-gray-500">${meal.details || 'No details provided'}</p><p class="text-xs text-yellow-600 mt-1">${formatDate(meal.date)}</p></div>`).join('');
            let listContainer = loggedMealsSummary.querySelector('#meal-list-container');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.id = 'meal-list-container';
                listContainer.className = 'space-y-3';
                loggedMealsSummary.appendChild(listContainer);
            }
            listContainer.innerHTML = listHtml;
        }

        function handleGymSetupSave(e) {
            e.preventDefault();
            const form = e.currentTarget;
            const formData = new FormData(form);
            const isModal = form.id === 'active-gym-setup-form';
            if (!isModal) { state.gymName = formData.get('gym-name') || "Custom Gym"; }
            state.gymSetup.weights = formData.getAll('weights');
            state.gymSetup.cardio = formData.getAll('cardio');
            state.gymSetup.floor = formData.getAll('floor');
            if (isModal) {
                equipmentModal.classList.add('hidden');
                renderExerciseDropdown();
                showMessage(`Equipment updated! Exercise list refreshed.`, 'info');
            } else {
                showMessage("Gym setup saved successfully!", 'success');
                showView('dashboard');
            }
        }
      
        function handleFocusChange() {
            const isSpecific = workoutFocusSelect.value === 'specific-muscles';
            muscleCheckboxesDiv.classList.toggle('hidden', !isSpecific);
            renderExerciseDropdown();
        }

        function handleStartWorkout(e) {
            e.preventDefault();
            const focus = workoutFocusSelect.value;
            if (!focus) { showMessage("Please select a training focus before starting.", 'error'); return; }
            state.currentWorkout = {
                title: focus.replace(/-/g, ' ').toUpperCase(),
                date: new Date().toISOString(),
                exercises: [],
                currentExercise: null,
            };
            activeWorkoutTitle.textContent = state.currentWorkout.title;
            setsTrackingContainer.innerHTML = '';
            updateLoggedExercisesSummary();
            showView('track-workout');
            renderExerciseDropdown();
            showMessage(`Workout started: ${state.currentWorkout.title}`, 'info', 4000);
        }

        function handleSetRepWeightChange(e) {
            const button = e.currentTarget;
            const delta = parseFloat(button.getAttribute('data-delta'));
            const field = button.getAttribute('data-field');
            const row = button.closest('.set-row');
            const inputField = row.querySelector(`.set-input-field[data-field="${field}"]`);
            let currentValue = parseFloat(inputField.value);
            let newValue = currentValue + delta;
            if (field === 'reps') {
                newValue = Math.max(1, Math.round(newValue));
            } else if (field === 'weight') {
                newValue = Math.max(0.0, newValue);
                newValue = parseFloat(newValue.toFixed(1));
            }
            inputField.value = formatWeight(newValue);
            handleSetInputUpdate({ currentTarget: inputField });
        }
      
        function handleSetInputUpdate(e) {
            const inputField = e.currentTarget;
            const row = inputField.closest('.set-row');
            const index = parseInt(row.getAttribute('data-set-index'));
            const field = inputField.getAttribute('data-field');
            let value = parseFloat(inputField.value);
            if (field === 'weight') { value = parseFloat(value.toFixed(1)); }
            if (state.currentWorkout?.currentExercise && !isNaN(value)) {
                state.currentWorkout.currentExercise.setsData[index][field] = value;
            }
        }

        function saveExercise() {
            if (!state.currentWorkout || !state.currentWorkout.currentExercise) { showMessage("Error: No active exercise to save.", 'error'); return; }
            const exercise = state.currentWorkout.currentExercise;
            const validSets = exercise.setsData.filter(s => s.weight > 0 || s.reps > 0);
            if (validSets.length === 0) { showMessage("Cannot save: No sets recorded positive reps or weight.", 'error'); return; }
            const volume = calculateVolume(validSets);
            const maxWeight = validSets.filter(s => s.reps > 0).reduce((max, s) => Math.max(max, s.weight), 0);
            if (!state.exerciseHistory[exercise.name] || maxWeight > state.exerciseHistory[exercise.name].bestWeight) {
                state.exerciseHistory[exercise.name] = { bestWeight: maxWeight, bestReps: validSets.find(s => s.weight === maxWeight)?.reps || 0, lastDate: new Date().toLocaleDateString(), };
                if (maxWeight > 0) { showMessage(`New PB for ${exercise.name}: ${formatWeight(maxWeight)}kg!`, 'success'); }
            }
            state.currentWorkout.exercises.push({ ...exercise, setsData: validSets, volume: volume, });
            setsTrackingContainer.innerHTML = '';
            exerciseSelect.value = '';
            setsInput.value = 3;
            targetRepsInput.value = 10;
            state.currentWorkout.currentExercise = null;
            updateLoggedExercisesSummary();
            showMessage(`${exercise.name} logged successfully! Total volume: ${formatWeight(volume)}kg.`, 'success');
        }

        window.saveWorkout = function() {
            if (state.currentWorkout?.currentExercise) {
                if (state.currentWorkout.currentExercise.setsData.some(s => s.weight > 0 || s.reps > 0)) { saveExercise(); } 
                else { state.currentWorkout.currentExercise = null; showMessage("Empty sets were discarded.", 'info'); }
            }
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) { showMessage("The workout is empty. No session saved.", 'error'); state.currentWorkout = null; return; }
            const totalVolume = state.currentWorkout.exercises.reduce((total, ex) => total + ex.volume, 0);
            state.workoutLog.push({ ...state.currentWorkout, totalVolume: totalVolume, duration: 'Simulated 45 min', });
            state.currentWorkout = null;
            showMessage(`Workout finished! Total volume lifted: ${formatWeight(totalVolume)}kg. Great job!`, 'success', 6000);
        }
        
        function handleMealLogSave(e) {
            e.preventDefault();
            const nameInput = e.target.querySelector('input[name="meal-name"]');
            const detailsInput = e.target.querySelector('textarea[name="meal-details"]');
            const mealName = nameInput.value.trim();
            const mealDetails = detailsInput.value.trim();
            if (mealName.length === 0) { showMessage("Please enter a name for the meal.", 'error'); return; }
            state.mealLog.push({ name: mealName, details: mealDetails, date: new Date().toISOString() });
            showMessage(`Meal "${mealName}" logged successfully!`, 'success');
            e.target.reset();
            renderMealLogSummary();
        }

        function renderHistory() {
            historyContent.innerHTML = '';
            const historyKeys = Object.keys(state.exerciseHistory).sort((a, b) => { return state.exerciseHistory[b].bestWeight - state.exerciseHistory[a].bestWeight; });
            if (historyKeys.length === 0) { historyContent.innerHTML = '<p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>'; return; }
            const items = historyKeys.map(name => {
                const item = state.exerciseHistory[name];
                return `<div class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm"><h4 class="text-xl font-bold text-gray-800">${name}</h4><p class="text-gray-600 mt-1"><i class="fas fa-arrow-up mr-1 text-red-500"></i> <span class="font-semibold">Best Weight:</span> ${formatWeight(item.bestWeight)}kg (for ${item.bestReps} reps)</p><p class="text-xs text-gray-400">Last PB Achieved: ${item.lastDate}</p></div>`;
            }).join('');
            historyContent.innerHTML = `<div class="space-y-4">${items}</div>`;
        }


        // --- INITIALIZATION & EVENT LISTENERS (Merged) ---

        function initApp() {
            // Load user info (currently hardcoded)
            document.getElementById('user-name').textContent = state.userName;
            document.getElementById('user-goal').textContent = state.goal;

            // Render initial controls
            renderMuscleCheckboxes();
            renderWorkoutFocus();
            updateDashboardStatus();
            
            // Setup default view
            showView('dashboard', false); 

            // Firebase Initialization must happen once on load
            initializeFirebase(); 

            // Event Listeners for forms
            gymSetupForm.addEventListener('submit', handleGymSetupSave);
            activeGymSetupForm.addEventListener('submit', handleGymSetupSave);
            workoutFocusSelect.addEventListener('change', handleFocusChange);
            workoutPlanningForm.addEventListener('submit', handleStartWorkout);
            document.getElementById('add-meal-form').addEventListener('submit', handleMealLogSave);
            
            // Body Metrics Listener
            measurementForm.addEventListener('submit', handleSaveMeasurement);
            
            // Active Workout Listeners
            document.getElementById('start-sets-btn').addEventListener('click', renderSetsTracking);
            document.getElementById('finish-workout-btn').addEventListener('click', () => {
                saveWorkout();
                showView('dashboard');
            });

            // Navigation Listeners
            document.getElementById('view-history-btn').addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
            });
            document.getElementById('close-history-btn').addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });

            // Equipment Modal Listeners
            document.getElementById('open-equipment-modal-btn').addEventListener('click', () => {
                renderActiveEquipmentModal();
                equipmentModal.classList.remove('hidden');
            });
            document.getElementById('close-equipment-modal-btn').addEventListener('click', () => {
                equipmentModal.classList.add('hidden');
            });
            
            // Re-render exercise list when muscles are checked/unchecked
            muscleOptionsDiv.addEventListener('change', () => {
                 if (workoutFocusSelect.value === 'specific-muscles') {
                    renderExerciseDropdown();
                 }
            });
        }

        // Run initialization when the page is ready
        window.onload = initApp;

    </script>

</body>
</html>
```eof

That's a great request! You have two distinct, complex single-file web applications:
 * Advanced Fitness Dashboard: Manages gym equipment configuration, workout planning, active workout tracking, and meal logging. (Pure JavaScript/HTML/Tailwind)
 * Body Metrics Tracker: Handles body measurements (e.g., waist, chest) and uses Firebase Firestore for real-time data persistence. (JavaScript/HTML/Tailwind/Firebase)
To merge them, I will combine the HTML structures, merge the CSS styles, and most critically, merge the JavaScript logic while ensuring both the pure JS state management (from the Dashboard) and the Firebase initialization/data handling (from the Metrics Tracker) work seamlessly together.
I will prioritize the more robust structure of the Advanced Fitness Dashboard and integrate the Body Metrics Tracker functionality as a new dedicated view, leveraging the existing modal logic where possible.
Key Integration Strategy:
 * Dashboard View Integration: Add the Body Metrics Tracker as a fifth primary button/view on the main dashboard.
 * HTML/CSS: Combine the <head> elements (including both sets of CSS) and nest the Body Metrics Tracker content (<main> and the measurement-modal) inside the main max-w-5xl container, styled to be a new view (#view-body-metrics).
 * JavaScript:
   * Place all Dashboard JS logic first in the combined <script type="module"> block.
   * Integrate the Firebase Imports and Global Constants (Firebase Config, Body Areas, etc.).
   * Merge the initApp and initializeFirebase functions, ensuring Firebase is ready before rendering the real-time data.
   * Adapt the Body Metrics JS functions (openModal, closeModal, startRealtimeListener, handleSaveMeasurement, renderMeasurements) to fit the new combined environment and be called from the new view's entry point.
Here is the complete, merged application.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Fitness & Metrics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* From Advanced Dashboard */
            transition: all 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics (From Advanced Dashboard) */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        .view-container {
            min-height: calc(100vh - 4rem);
        }
        /* Modal transitions (From Body Metrics) */
        .modal-metrics { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .fade-in { opacity: 1; transform: translateY(0); }
        .fade-out { opacity: 0; transform: translateY(-10px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <div id="message-box" class="fixed top-4 right-4 z-50 p-4 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-lg shadow-xl font-medium hidden transition-opacity duration-300 ease-in-out opacity-0">
            <p id="message-text"></p>
        </div>
        
        <div id="status-message" class="hidden mb-6"></div>

        <div id="view-dashboard" class="view-container space-y-8">
             <header class="bg-white p-6 rounded-2xl shadow-xl transition-all hover:shadow-2xl">
                <h1 class="text-4xl font-black text-gray-900 mb-2">Integrated Fitness Dashboard</h1>
                <div class="md:flex md:space-x-8">
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">User:</span> <span id="user-name"></span>
                    </p>
                    <p class="text-lg text-gray-600">
                        <span class="font-bold text-indigo-600">Goal:</span> <span id="user-goal"></span>
                    </p>
                    <p id="user-id-display" class="text-sm text-indigo-300 mt-1"></p>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <button onclick="showView('gym-config')" class="bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-dumbbell mr-2"></i> Configure Gym
                    <p id="current-gym-status" class="mt-1 text-sm opacity-80 italic"></p>
                </button>
                
                <button onclick="showView('plan-workout')" class="bg-green-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-running mr-2"></i> Plan Workout
                </button>
                
                <button onclick="showView('meal-log')" class="bg-yellow-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-utensils mr-2"></i> Log Meal
                </button>
                
                <button onclick="showView('body-metrics')" class="bg-purple-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-purple-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-ruler-combined mr-2"></i> Body Metrics
                </button>
                
                <button id="view-history-btn" class="bg-gray-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02]">
                    <i class="fas fa-chart-line mr-2"></i> View History
                </button>
                
            </div>
        </div>

        <div id="view-gym-config" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-indigo-700"><i class="fas fa-cogs mr-2"></i> Gym Setup Configuration</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="gym-setup-form" class="space-y-6">
                <div class="space-y-2">
                    <label for="gym-name" class="block text-sm font-medium text-gray-700">Gym Profile Name</label>
                    <input type="text" id="gym-name" name="gym-name" value="My Home Gym" required
                           class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                        <div id="weights-options" class="space-y-1 text-sm"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                        <div id="cardio-options" class="space-y-1 text-sm"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-expand-alt mr-2"></i> Functional / Floor</h3>
                        <div id="floor-options" class="space-y-1 text-sm"></div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg">
                    <i class="fas fa-save mr-2"></i> Save Gym Equipment
                </button>
            </form>
        </div>
        
        <div id="view-meal-log" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-yellow-600"><i class="fas fa-apple-alt mr-2"></i> Log a Meal</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <form id="add-meal-form" class="space-y-4">
                <input type="text" placeholder="Meal Name (e.g., Chicken & Rice)" required name="meal-name"
                       class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500">
                <textarea placeholder="Nutritional Details / Ingredients" rows="4" name="meal-details"
                          class="w-full p-3 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                <button type="submit" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i> Log Meal
                </button>
            </form>
            
            <div id="logged-meals-summary" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border">
                <h3 class="text-xl font-bold text-gray-700">Today's Meals</h3>
                <p class="text-gray-500 italic" id="meal-list-placeholder">No meals logged today.</p>
                </div>
        </div>
        
        <div id="view-plan-workout" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-green-600"><i class="fas fa-hand-rock mr-2"></i> Select Training Focus</h2>
                <div class="space-x-2">
                    <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        &larr; Return to Dashboard
                    </button>
                </div>
            </div>
            
            <form id="workout-planning-form" class="space-y-4">
                <div>
                    <label for="workout-focus" class="block text-sm font-medium text-gray-700">What are you training?</label>
                    <select id="workout-focus"
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        </select>
                </div>

                <div id="muscle-checkboxes" class="hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Select Target Muscles:</p>
                    <div id="muscle-options" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>
                </div>
                
                <button type="submit" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                    <i class="fas fa-forward mr-2"></i> Start Workout
                </button>
            </form>
        </div>

        <div id="view-track-workout" class="view-container p-6 bg-white rounded-2xl shadow-2xl border-2 border-green-500 space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-extrabold text-green-700">Active Workout: <span id="active-workout-title"></span></h2>
                <div class="space-x-2">
                    <button id="open-equipment-modal-btn" class="text-sm py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                        <i class="fas fa-tools mr-1"></i> Equipment
                    </button>
                    <button onclick="saveWorkout(); showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition shadow-md">
                        <i class="fas fa-times-circle mr-1"></i> Finish & Dashboard
                    </button>
                </div>
            </div>
            
            <form id="add-exercise-form" class="space-y-4 p-4 bg-green-50 rounded-xl border border-green-200">
                <h3 class="text-xl font-bold text-green-800"><i class="fas fa-plus mr-2"></i> Add Exercise</h3>
                
                <div>
                    <label for="exercise-select" class="block text-sm font-medium text-gray-700">Choose Exercise (Filtered by Equipment & Focus)</label>
                    <select id="exercise-select" required
                            class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <option value="">-- Select an Exercise --</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="sets-input" class="block text-sm font-medium text-gray-700">Sets</label>
                        <input type="number" id="sets-input" value="3" min="1" max="10" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="target-reps-input" class="block text-sm font-medium text-gray-700">Target Reps</label>
                        <input type="number" id="target-reps-input" value="10" min="1" max="50" required
                               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <button type="button" id="start-sets-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                    <i class="fas fa-cog mr-2"></i> Configure Sets
                </button>
            </form>

            <div id="sets-tracking-container" class="space-y-6">
                </div>
            
            <div id="logged-exercises-summary" class="mt-8 space-y-4">
                <h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises</h3>
                </div>
            
            <button id="finish-workout-btn" class="mt-8 w-full py-4 bg-indigo-600 text-white font-extrabold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-2xl">
                <i class="fas fa-flag-checkered mr-2"></i> Finish & Save Workout
            </button>
        </div>

        <div id="view-body-metrics" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
             <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-3xl font-bold text-purple-700"><i class="fas fa-ruler-combined mr-2"></i> Body Metrics & Measurements</h2>
                <button onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    &larr; Return to Dashboard
                </button>
            </div>
            
            <button id="add-measurement-btn-metrics"
                class="w-full sm:w-auto px-6 py-3 mb-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50"
                onclick="openMetricsModal()">
                <i class="fas fa-plus-circle mr-2"></i> Add New Measurement
            </button>

            <div id="measurements-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

            <div id="loading-state-metrics" class="text-center p-12">
                <i class="fas fa-spinner fa-spin text-4xl text-purple-500"></i>
                <p class="mt-4 text-gray-700 font-semibold">Initializing Firebase and loading data...</p>
            </div>
        </div>

        <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700"><i class="fas fa-medal mr-2"></i> Exercise History (Best Lifts)</h2>
                    <button id="close-history-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition">&times;</button>
                </div>
                <div id="history-content" class="p-6 overflow-y-auto custom-scroll space-y-4 flex-grow">
                    <p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>
                </div>
            </div>
        </div>
        
        <div id="equipment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-blue-100">
                    <h2 class="text-2xl font-bold text-blue-700"><i class="fas fa-sliders-h mr-2"></i> Adjust Available Equipment</h2>
                    <button id="close-equipment-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto custom-scroll flex-grow">
                    <form id="active-gym-setup-form" class="space-y-6">
                        <p class="text-gray-600 mb-4">Temporarily adjust what equipment is available right now. This will update your exercise selection.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                                <div id="active-weights-options" class="space-y-1 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                                <div id="active-cardio-options" class="space-y-1 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 class="font-semibold text-lg text-gray-800 mb-2"><i class="fas fa-expand-alt mr-2"></i> Functional / Floor</h3>
                                <div id="active-floor-options" class="space-y-1 text-sm"></div>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-150 shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i> Apply Changes & Close
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="measurement-modal" class="modal-metrics fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 opacity-0 pointer-events-none">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform fade-out transition-all">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">Record New Measurement</h2>
                    <form id="measurement-form">
                        <div class="space-y-4">
                            <div>
                                <label for="area-select" class="block text-sm font-medium text-gray-700 mb-1">Body Area</label>
                                <select
                                    id="area-select"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                ></select>
                            </div>

                            <div>
                                <label for="value-input" class="block text-sm font-medium text-gray-700 mb-1">Measurement Value</label>
                                <input
                                    id="value-input"
                                    type="number"
                                    step="0.1"
                                    placeholder="e.g., 32.5"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                />
                            </div>

                            <div>
                                <label for="unit-select" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                                <select
                                    id="unit-select"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                                    required
                                >
                                    <option value="inches">Inches</option>
                                    <option value="cm">Centimeters</option>
                                </select>
                            </div>
                        </div>

                        <button
                            type="submit"
                            id="save-measurement-btn-metrics"
                            class="mt-6 w-full py-3 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50"
                        >
                            Save Measurement
                        </button>
                    </form>
                    <button
                        onclick="closeMetricsModal()"
                        class="mt-4 w-full py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- FIREBASE IMPORTS (From Body Metrics Tracker) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- GLOBAL STATE AND DATA (Combined) ---
        let state = {
            currentView: 'dashboard',
            userName: "Alex Johnson",
            goal: "Build Strength & Endurance",
            gymName: "My Home Gym",
            gymSetup: { weights: ["dumbbell", "bench", "barbell", "cables", "weighted machines"], cardio: ["treadmill", "rower"], floor: ["TRX", "sandbag"] }, 
            exerciseHistory: {},
            currentWorkout: null,
            workoutLog: [],
            mealLog: [],
            previousView: 'dashboard',
        };

        const EQUIPMENT_MAP = {
            weights: ["bench", "barbell", "dumbbell", "pinstack machines", "weighted machines", "cables"],
            cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
            floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball", "floor"],
        };

        const FOCUS_OPTIONS = [
            "Full Body", "Upper Body", "Lower Body", "Press", "Pull", "Squat", "Hinge", "Specific Muscles", "Cardio"
        ];
        
        const MUSCLE_GROUPS = [
            "biceps", "triceps", "shoulders", "quads", "hamstrings", "abs", "chest", "lats", "upper back", "glutes", "calves"
        ];
        
        const BODY_AREAS = [
            'Neck', 'Chest', 'Waist', 'Hips', 'Right Bicep', 'Left Bicep', 'Right Thigh', 'Left Thigh',
            'Right Calf', 'Left Calf', 'Shoulders', 'Forearm',
        ];

        // Access global variables provided by the environment (Firebase related)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;


        // --- EXPANDED EXERCISE LIBRARY (Unchanged) ---
        const EXERCISE_LIBRARY = [
            // [Exercises as defined in the original Advanced Dashboard]
            { name: "Barbell Clean & Press", equipment: ["barbell"], focus: ["Full Body", "Press", "shoulders", "quads", "glutes"] },
            { name: "Dumbbell Thrusters", equipment: ["dumbbell"], focus: ["Full Body", "Squat", "Press", "shoulders", "quads"] },
            { name: "Sandbag Get-Ups", equipment: ["sandbag", "floor"], focus: ["Full Body", "abs", "shoulders"] },
            { name: "Medicine Ball Slams", equipment: ["medicine ball", "slam ball"], focus: ["Full Body", "abs"] },
            { name: "Barbell Bench Press", equipment: ["bench", "barbell"], focus: ["Upper Body", "Press", "chest", "triceps", "shoulders"] },
            { name: "Dumbbell Overhead Press", equipment: ["dumbbell"], focus: ["Upper Body", "Press", "shoulders", "triceps"] },
            { name: "Machine Chest Press", equipment: ["weighted machines", "pinstack machines"], focus: ["Upper Body", "Press", "chest", "triceps"] },
            { name: "Cable Crossover (High)", equipment: ["cables"], focus: ["Upper Body", "Press", "chest"] },
            { name: "Dumbbell Incline Press", equipment: ["bench", "dumbbell"], focus: ["Upper Body", "Press", "chest", "shoulders"] },
            { name: "Pinstack Shoulder Press", equipment: ["pinstack machines"], focus: ["Press", "shoulders", "triceps"] },
            { name: "Barbell Bent-Over Row", equipment: ["barbell"], focus: ["Upper Body", "Pull", "lats", "upper back", "biceps"] },
            { name: "Dumbbell Single-Arm Row", equipment: ["dumbbell", "bench"], focus: ["Upper Body", "Pull", "lats", "upper back"] },
            { name: "Cable Face Pulls", equipment: ["cables"], focus: ["Upper Body", "Pull", "upper back", "shoulders"] },
            { name: "Lat Pulldown (Machine)", equipment: ["pinstack machines"], focus: ["Upper Body", "Pull", "lats", "biceps"] },
            { name: "TRX Inverted Row", equipment: ["TRX"], focus: ["Upper Body", "Pull", "upper back", "biceps"] },
            { name: "Seated Cable Row", equipment: ["cables"], focus: ["Pull", "upper back", "lats", "biceps"] },
            { name: "Barbell Back Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes", "hamstrings", "calves"] },
            { name: "Dumbbell Goblet Squat", equipment: ["dumbbell", "floor"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Leg Extension (Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Squat", "quads"] },
            { name: "Leg Press (Machine)", equipment: ["weighted machines"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Dumbbell Bulgarian Split Squat", equipment: ["dumbbell", "bench"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
            { name: "Barbell Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes", "Full Body", "lats"] },
            { name: "Dumbbell Romanian Deadlift", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
            { name: "Cable Pull-Through", equipment: ["cables"], focus: ["Lower Body", "Hinge", "glutes", "hamstrings"] },
            { name: "Leg Curl (Machine)", equipment: ["pinstack machines", "weighted machines"], focus: ["Lower Body", "Hinge", "hamstrings"] },
            { name: "Glute-Ham Raise (Floor)", equipment: ["floor"], focus: ["Hinge", "hamstrings", "glutes"] },
            { name: "Dumbbell Hammer Curl", equipment: ["dumbbell"], focus: ["biceps"] },
            { name: "Barbell Bicep Curl", equipment: ["barbell"], focus: ["biceps"] },
            { name: "Cable Rope Tricep Pushdown", equipment: ["cables"], focus: ["triceps"] },
            { name: "Dumbbell Skullcrushers", equipment: ["dumbbell", "bench"], focus: ["triceps"] },
            { name: "Dumbbell Lateral Raise", equipment: ["dumbbell"], focus: ["shoulders"] },
            { name: "Cable Rear Delt Fly", equipment: ["cables"], focus: ["shoulders", "upper back"] },
            { name: "Machine Hip Abduction", equipment: ["weighted machines"], focus: ["glutes"] },
            { name: "Hanging Leg Raise", equipment: ["floor"], focus: ["abs"] },
            { name: "Weighted Machine Crunch", equipment: ["weighted machines"], focus: ["abs"] },
            { name: "Dumbbell Calf Raise", equipment: ["dumbbell"], focus: ["calves"] },
            { name: "Hyperextension (Floor)", equipment: ["floor"], focus: ["hamstrings", "glutes"] },
            { name: "Treadmill 5K Run", equipment: ["treadmill"], focus: ["Cardio", "Full Body"] },
            { name: "Rower 2000m Sprint", equipment: ["rower"], focus: ["Cardio", "Full Body"] },
            { name: "Assault Bike Interval", equipment: ["assault bike"], focus: ["Cardio", "Full Body"] },
            { name: "Cross Trainer Endurance", equipment: ["cross trainer"], focus: ["Cardio", "Full Body"] },
            { name: "Ski Erg 10 Minute Challenge", equipment: ["ski erg"], focus: ["Cardio", "Full Body", "Upper Body", "Pull"] },
            { name: "Step Machine Climb", equipment: ["step machine"], focus: ["Cardio", "Lower Body"] },
        ];


        // --- DOM ELEMENTS (Combined) ---
        const views = ['dashboard', 'gym-config', 'meal-log', 'plan-workout', 'track-workout', 'body-metrics'];
        const viewElements = views.reduce((acc, id) => {
            acc[id] = document.getElementById(`view-${id}`);
            return acc;
        }, {});
        
        const gymSetupForm = document.getElementById('gym-setup-form');
        const currentGymStatus = document.getElementById('current-gym-status');
        
        const workoutPlanningForm = document.getElementById('workout-planning-form');
        const workoutFocusSelect = document.getElementById('workout-focus');
        const muscleCheckboxesDiv = document.getElementById('muscle-checkboxes');
        const muscleOptionsDiv = document.getElementById('muscle-options');
        
        const activeWorkoutTitle = document.getElementById('active-workout-title');
        const exerciseSelect = document.getElementById('exercise-select');
        const setsInput = document.getElementById('sets-input');
        const targetRepsInput = document.getElementById('target-reps-input');
        const setsTrackingContainer = document.getElementById('sets-tracking-container');
        const loggedExercisesSummary = document.getElementById('logged-exercises-summary');
        
        const historyModal = document.getElementById('history-modal');
        const historyContent = document.getElementById('history-content');
        
        const equipmentModal = document.getElementById('equipment-modal');
        const activeGymSetupForm = document.getElementById('active-gym-setup-form');
        
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        const loggedMealsSummary = document.getElementById('logged-meals-summary');
        const mealListPlaceholder = document.getElementById('meal-list-placeholder');

        // Body Metrics Tracker Elements
        const statusMessageEl = document.getElementById('status-message');
        const loadingStateMetricsEl = document.getElementById('loading-state-metrics');
        const measurementsContainer = document.getElementById('measurements-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const addMeasurementBtnMetrics = document.getElementById('add-measurement-btn-metrics');
        const modalMetricsEl = document.getElementById('measurement-modal');
        const modalMetricsContentEl = modalMetricsEl.querySelector('.transform');
        const areaSelectEl = document.getElementById('area-select');
        const valueInputEl = document.getElementById('value-input');
        const unitSelectEl = document.getElementById('unit-select');
        const measurementForm = document.getElementById('measurement-form');


        // --- UTILITY & NAVIGATION FUNCTIONS (Combined) ---
        
        /** Manages the visibility of the application views. */
        window.showView = function(viewName, updateHistory = true) {
            // Guard clause if user tries to navigate away from an active, unsaved exercise
            if (state.currentWorkout && state.currentWorkout.currentExercise && viewName !== 'track-workout') {
                if (!confirmExit()) return;
            }
            
            if (updateHistory && state.currentView !== viewName) {
                state.previousView = state.currentView;
            }

            views.forEach(id => {
                const element = viewElements[id];
                if (element) { // Check if element exists before accessing classList
                    element.classList.add('hidden');
                    element.classList.remove('block');
                }
            });

            if (viewElements[viewName]) {
                viewElements[viewName].classList.remove('hidden');
                viewElements[viewName].classList.add('block'); 
                state.currentView = viewName;
            }
            
            // Special setup needed when entering certain views
            if (viewName === 'gym-config') {
                renderGymSetupCheckboxes(document.getElementById('weights-options'), document.getElementById('cardio-options'), document.getElementById('floor-options'));
                document.getElementById('gym-name').value = state.gymName;
            } else if (viewName === 'plan-workout') {
                renderExerciseDropdown();
            } else if (viewName === 'track-workout') {
                renderActiveEquipmentModal();
                updateLoggedExercisesSummary();
            } else if (viewName === 'meal-log') {
                renderMealLogSummary();
            } else if (viewName === 'body-metrics') {
                // Ensure the listener is active when this view is opened
                if (isAuthReady) {
                    loadingStateMetricsEl.classList.add('hidden');
                    startRealtimeListener(); 
                } else {
                    loadingStateMetricsEl.classList.remove('hidden');
                }
            }

            updateDashboardStatus();
        }

        /** Prompts user if they try to exit an active exercise without saving. */
        function confirmExit() {
             showMessage("Unsaved exercise cleared. Workout session remains active.", 'info', 5000);
             setsTrackingContainer.innerHTML = '';
             state.currentWorkout.currentExercise = null;
             return true;
        }

        /** Shows a temporary message in the custom box (Advanced Dashboard style). */
        function showMessage(message, type = 'success', duration = 3000) {
            let bgColor, borderColor, textColor;
            if (type === 'success') {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-500';
                textColor = 'text-green-800';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-500';
                textColor = 'text-red-800';
            } else if (type === 'info') {
                bgColor = 'bg-blue-100';
                borderColor = 'border-blue-500';
                textColor = 'text-blue-800';
            } else if (type === 'metrics-error') { // New type for Firebase-related errors
                 bgColor = 'bg-purple-100';
                borderColor = 'border-purple-500';
                textColor = 'text-purple-800';
            }

            messageBox.className = `fixed top-4 right-4 z-50 p-4 ${bgColor} ${textColor} border-l-4 ${borderColor} rounded-lg shadow-xl font-medium transition-opacity duration-300 ease-in-out opacity-0`;
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('opacity-100'), 10);

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, duration);
        }

        /** Displays a message in the status bar (Error or Success - Body Metrics style) */
        function displayStatus(message, isError = false) {
             // Use the main status box for Firebase specific errors to match the original style
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'border-red-400', 'border-green-400', 'text-red-700', 'text-green-700');
            statusMessageEl.innerHTML = `<i class="mr-2 fas ${isError ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i> ${message}`;
            
            if (isError) {
                statusMessageEl.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700', 'px-4', 'py-3', 'rounded', 'relative');
            } else {
                statusMessageEl.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700', 'px-4', 'py-3', 'rounded', 'relative');
            }
        }
        
        /** Formats a number to 1 decimal place if it has a decimal, otherwise an integer. */
        function formatWeight(w) {
            return Number.isInteger(w) ? w : w.toFixed(1);
        }

        /** Calculates volume (Sets * Reps * Weight) */
        function calculateVolume(setsData) {
            return setsData.reduce((total, set) => total + (set.reps * set.weight), 0);
        }
        
        /** Updates the status text on the main dashboard */
        function updateDashboardStatus() {
             const totalEquipment = state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length;
             currentGymStatus.textContent = `${state.gymName} | ${totalEquipment} items available.`;
        }

        /** Formats ISO date to a readable string */
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ', ' +
                   date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        /** Formats a Date object into a readable string (for Metrics Tracker) */
        function formatDateMetrics(date) {
            if (!date) return 'N/A';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // --- BODY METRICS MODAL LOGIC (Adapted) ---
        
        window.openMetricsModal = function() {
            // Populate the area dropdown
            areaSelectEl.innerHTML = BODY_AREAS.map(area => `<option value="${area}">${area}</option>`).join('');
            
            // Reset form inputs
            valueInputEl.value = '';
            areaSelectEl.value = BODY_AREAS[0];
            unitSelectEl.value = 'inches';

            // Show modal
            modalMetricsEl.classList.remove('pointer-events-none', 'opacity-0');
            modalMetricsContentEl.classList.remove('fade-out');
            modalMetricsContentEl.classList.add('fade-in');
        }

        window.closeMetricsModal = function() {
            // Hide modal
            modalMetricsContentEl.classList.remove('fade-in');
            modalMetricsContentEl.classList.add('fade-out');
            setTimeout(() => {
                modalMetricsEl.classList.add('pointer-events-none', 'opacity-0');
            }, 300); 
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION (Merged) ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                displayStatus("Firebase configuration is missing.", true);
                loadingStateMetricsEl.classList.add('hidden');
                return;
            }
            
            try {
                setLogLevel('debug');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const handleAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        displayStatus("Failed to authenticate with Firebase.", true);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.innerHTML = `Firebase User ID: <span class="font-mono text-indigo-300">${userId}</span>`;
                        isAuthReady = true;
                        // Only start the listener if the user is in the metrics view
                        if (state.currentView === 'body-metrics') {
                             loadingStateMetricsEl.classList.add('hidden');
                             startRealtimeListener();
                        }
                    } else {
                        handleAuth();
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayStatus("Failed to initialize Firebase services.", true);
                loadingStateMetricsEl.classList.add('hidden');
            }
        }

        // --- FIRESTORE DATA LOGIC (Body Metrics) ---

        /** Sets up the real-time listener for measurements */
        function startRealtimeListener() {
            if (!isAuthReady || !db || !userId) {
                return;
            }

            const collectionPath = `artifacts/${appId}/users/${userId}/measurements`;
            const measurementsRef = collection(db, collectionPath);
            const q = query(measurementsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const fetchedMeasurements = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        area: data.area,
                        value: data.value,
                        unit: data.unit,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(),
                    };
                });
                
                renderMeasurements(fetchedMeasurements);
                loadingStateMetricsEl.classList.add('hidden');
                addMeasurementBtnMetrics.disabled = false;

            }, (err) => {
                console.error("Firestore onSnapshot error:", err);
                displayStatus("Failed to load measurements in real-time.", true);
                loadingStateMetricsEl.classList.add('hidden');
            });
        }

        /** Handles saving a new measurement from the modal form */
        async function handleSaveMeasurement(e) {
            e.preventDefault();

            const area = areaSelectEl.value;
            const value = parseFloat(valueInputEl.value);
            const unit = unitSelectEl.value;

            if (isNaN(value) || value <= 0 || !area) {
                showMessage("Please enter a valid positive value and select an area.", 'metrics-error');
                return;
            }

            if (!db || !userId) {
                showMessage("Metrics Tracker not ready. Please wait for initialization.", 'metrics-error');
                return;
            }

            const saveBtn = document.getElementById('save-measurement-btn-metrics');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/measurements`;
                const measurementsRef = collection(db, collectionPath);

                await addDoc(measurementsRef, {
                    userId,
                    area,
                    value,
                    unit,
                    timestamp: serverTimestamp(),
                });

                closeMetricsModal();
                showMessage(`Successfully recorded ${area} measurement!`, 'success');

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to save the measurement.", 'metrics-error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Measurement';
            }
        }

        // --- RENDERING LOGIC (Body Metrics) ---

        /** Groups and renders the measurements into cards */
        function renderMeasurements(measurements) {
            measurementsContainer.innerHTML = '';
            
            // 1. Group measurements by area
            const measurementsByArea = measurements.reduce((acc, current) => {
                const area = current.area;
                if (!acc[area]) { acc[area] = []; }
                acc[area].push(current);
                return acc;
            }, {});

            const areasMeasured = Object.keys(measurementsByArea).sort();

            if (areasMeasured.length === 0) {
                measurementsContainer.innerHTML = `
                    <div class="lg:col-span-3 text-center p-12 bg-white rounded-xl shadow-md border border-dashed border-purple-200">
                        <i class="fas fa-list-ul w-10 h-10 text-purple-400 mx-auto mb-3 text-3xl"></i>
                        <p class="text-gray-600 font-medium">No measurements recorded yet.</p>
                        <p class="text-sm text-gray-400 mt-1">Use the "Add New Measurement" button to start tracking your progress.</p>
                    </div>
                `;
                return;
            }

            // 2. Render a card for each area
            areasMeasured.forEach(area => {
                const areaMeasurements = measurementsByArea[area];
                
                const latest = areaMeasurements[0];
                const previous = areaMeasurements[1];
                
                let changeStatus = '';
                if (previous) {
                    const diff = latest.value - previous.value;
                    const sign = diff >= 0 ? '+' : '';
                    const color = diff > 0 ? 'text-green-600' : (diff < 0 ? 'text-red-600' : 'text-gray-500');
                    const icon = diff > 0 ? 'fa-arrow-up' : (diff < 0 ? 'fa-arrow-down' : 'fa-minus');
                    
                    changeStatus = `
                        <p class="text-sm font-medium mt-2 flex items-center ${color}">
                            <i class="fas ${icon} mr-1"></i> 
                            ${sign}${diff.toFixed(1)} ${latest.unit} (since last entry)
                        </p>
                    `;
                }

                const cardHtml = `
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-purple-200 transform hover:scale-[1.01] transition duration-200">
                        <h2 class="text-xl font-bold text-purple-700 mb-3 border-b pb-2">${area}</h2>
                        
                        <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-300 shadow-inner">
                            <p class="text-sm font-semibold text-purple-600 mb-1">Latest Reading (${formatDateMetrics(latest.timestamp)})</p>
                            <p class="text-4xl font-extrabold text-gray-900 leading-none">
                                ${latest.value.toFixed(1)}
                                <span class="text-base font-medium text-purple-500">${latest.unit}</span>
                            </p>
                            ${changeStatus}
                        </div>

                        ${areaMeasurements.length > 1 ? `
                            <p class="text-sm font-semibold text-gray-700 mt-4 mb-2">Previous Entries:</p>
                            <div class="space-y-1 max-h-28 overflow-y-auto">
                                ${areaMeasurements.slice(1, 4).map(m => `
                                    <div class="flex justify-between text-xs text-gray-600 border-b border-gray-100 py-1">
                                        <span>${formatDateMetrics(m.timestamp)}</span>
                                        <span class="font-bold">${m.value.toFixed(1)} ${m.unit}</span>
                                    </div>
                                `).join('')}
                                ${areaMeasurements.length > 4 ? `<p class="text-xs text-center text-gray-400 mt-2">... and ${areaMeasurements.length - 4} more</p>` : ''}
                            </div>
                        ` : ''}

                    </div>
                `;
                measurementsContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
        
        // --- OTHER RENDER & LOGIC FUNCTIONS (Unchanged from Advanced Dashboard) ---
        // [renderGymSetupCheckboxes, renderMuscleCheckboxes, renderWorkoutFocus, renderExerciseDropdown, renderSetsTracking, updateLoggedExercisesSummary, renderActiveEquipmentModal, renderMealLogSummary, renderHistory]
        // ... (All other functions from the Advanced Dashboard file are retained here for completeness) ...
        
        // --- HANDLERS (Unchanged from Advanced Dashboard) ---
        // [handleGymSetupSave, handleFocusChange, handleStartWorkout, handleSetRepWeightChange, handleSetInputUpdate, saveExercise, saveWorkout, handleMealLogSave]
        // ... (All other handlers from the Advanced Dashboard file are retained here for completeness) ...
        
        function renderGymSetupCheckboxes(weightsContainer, cardioContainer, floorContainer) {
            const currentSetup = state.gymSetup;
            const createCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = `gym-config-${item.replace(/\s/g, '-')}`;
                    const checked = currentSetup[category].includes(item) ? 'checked' : '';
                    return `<div class="flex items-center"><input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label></div>`;
                }).join('');
            };
            createCheckboxes(weightsContainer, 'weights');
            createCheckboxes(cardioContainer, 'cardio');
            createCheckboxes(floorContainer, 'floor');
        }

        function renderMuscleCheckboxes() {
            muscleOptionsDiv.innerHTML = MUSCLE_GROUPS.map(muscle => `<div class="flex items-center"><input id="muscle-${muscle}" type="checkbox" name="muscle" value="${muscle}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500"><label for="muscle-${muscle}" class="ml-2 text-gray-600 capitalize text-sm">${muscle}</label></div>`).join('');
        }

        function renderWorkoutFocus() {
            workoutFocusSelect.innerHTML = FOCUS_OPTIONS.map(focus => `<option value="${focus.toLowerCase().replace(/\s/g, '-')}">${focus}</option>`).join('');
            workoutFocusSelect.value = '';
            workoutFocusSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Choose Focus --</option>');
        }

        function renderExerciseDropdown() {
            const selectedFocus = workoutFocusSelect.value;
            const selectedMuscles = Array.from(document.querySelectorAll('#muscle-options input:checked')).map(cb => cb.value);
            const availableEquipment = [...state.gymSetup.weights, ...state.gymSetup.cardio, ...state.gymSetup.floor];
            let filteredExercises = EXERCISE_LIBRARY.filter(exercise => {
                const equipmentMatch = exercise.equipment.some(item => availableEquipment.includes(item));
                let focusMatch = false;
                const normalizedFocus = exercise.focus.map(f => f.toLowerCase().replace(/\s/g, '-'));
                if (selectedFocus === 'specific-muscles' && selectedMuscles.length > 0) {
                    focusMatch = selectedMuscles.some(muscle => normalizedFocus.includes(muscle));
                } else if (selectedFocus) {
                    focusMatch = normalizedFocus.includes(selectedFocus);
                } else {
                    focusMatch = true;
                }
                return equipmentMatch && focusMatch;
            });
            exerciseSelect.innerHTML = filteredExercises.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('');
            exerciseSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Select an Exercise --</option>');
            if (filteredExercises.length === 0 && selectedFocus) {
                showMessage("No exercises match your current gym setup and focus! Try selecting different equipment or focus.", 'error', 5000);
            }
        }
        
        function renderSetsTracking() {
            const exerciseName = exerciseSelect.value;
            const numSets = parseInt(setsInput.value);
            const targetReps = parseInt(targetRepsInput.value);
            if (!exerciseName || isNaN(numSets) || isNaN(targetReps) || numSets < 1 || targetReps < 1) {
                showMessage("Please select an exercise and enter valid sets/reps (min 1).", 'error');
                return;
            }
            state.currentWorkout.currentExercise = {
                name: exerciseName,
                setsData: Array.from({ length: numSets }, (_, i) => ({ set: i + 1, reps: targetReps, weight: 0.0 }))
            };
            const bestWeight = state.exerciseHistory[exerciseName]?.bestWeight || 0;
            setsTrackingContainer.innerHTML = state.currentWorkout.currentExercise.setsData.map((set, index) => {
                const setNumber = index + 1;
                return `<div class="set-row p-4 border border-gray-200 rounded-xl bg-gray-50 grid grid-cols-2 md:grid-cols-4 gap-4 items-center" data-set-index="${index}"><h4 class="font-bold text-lg text-green-700 col-span-2 md:col-span-1">Set ${setNumber}</h4><div class="flex items-center space-x-1"><label class="font-medium text-gray-700 text-sm">Reps:</label><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="-1" data-field="reps"><i class="fas fa-minus"></i></button><input type="number" value="${set.reps}" min="1" class="set-input-field w-10 text-center border-b-2 border-gray-400 text-sm" data-field="reps"><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="1" data-field="reps"><i class="fas fa-plus"></i></button></div><div class="flex items-center space-x-1"><label class="font-medium text-gray-700 text-sm">Weight (kg):</label><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="-2.5" data-field="weight"><i class="fas fa-minus"></i></button><input type="number" step="0.5" value="${formatWeight(set.weight)}" class="set-input-field w-12 text-center border-b-2 border-gray-400 text-sm" data-field="weight"><button type="button" class="rep-change bg-gray-300 hover:bg-gray-400 p-1 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold" data-delta="2.5" data-field="weight"><i class="fas fa-plus"></i></button></div><div class="text-sm text-gray-500 italic text-right col-span-2 md:col-span-1"><i class="fas fa-trophy text-yellow-500 mr-1"></i> PB: ${formatWeight(bestWeight)}kg</div></div>`;
            }).join('');
            setsTrackingContainer.insertAdjacentHTML('beforeend', `<button type="button" id="save-exercise-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg"><i class="fas fa-check-double mr-2"></i> Log Exercise: ${exerciseName}</button>`);
            document.getElementById('save-exercise-btn').addEventListener('click', saveExercise);
            document.querySelectorAll('.rep-change').forEach(btn => { btn.addEventListener('click', handleSetRepWeightChange); });
            document.querySelectorAll('.set-input-field').forEach(input => { input.addEventListener('change', handleSetInputUpdate); });
        }
        
        function updateLoggedExercisesSummary() {
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {
                loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises (0)</h3><p class="text-gray-500 italic">No exercises logged yet in this session.</p>`;
                return;
            }
            const items = state.currentWorkout.exercises.map(ex => {
                const totalVolume = calculateVolume(ex.setsData);
                const maxWeight = ex.setsData.reduce((max, s) => Math.max(max, s.weight), 0);
                return `<div class="p-3 border-l-4 border-green-400 bg-gray-50 rounded-lg"><p class="font-semibold text-gray-800">${ex.name}</p><p class="text-sm text-gray-600"><i class="fas fa-layer-group mr-1"></i> Sets: ${ex.setsData.length} | <i class="fas fa-weight-hanging mr-1"></i> Max Lift: ${formatWeight(maxWeight)}kg | <i class="fas fa-box-open mr-1"></i> Total Volume: ${formatWeight(totalVolume)}kg</p></div>`;
            }).join('');
            loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises (${state.currentWorkout.exercises.length})</h3><div class="space-y-2">${items}</div>`;
        }

        function renderActiveEquipmentModal() {
            const w = document.getElementById('active-weights-options');
            const c = document.getElementById('active-cardio-options');
            const f = document.getElementById('active-floor-options');
            const createModalCheckboxes = (container, category) => {
                container.innerHTML = EQUIPMENT_MAP[category].map(item => {
                    const id = 'active-' + item.replace(/\s/g, '-');
                    const checked = state.gymSetup[category].includes(item) ? 'checked' : '';
                    return `<div class="flex items-center"><input id="${id}" name="${category}" type="checkbox" value="${item}" ${checked} class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="${id}" class="ml-2 text-gray-600 capitalize">${item}</label></div>`;
                }).join('');
            };
            createModalCheckboxes(w, 'weights');
            createModalCheckboxes(c, 'cardio');
            createModalCheckboxes(f, 'floor');
        }
        
        function renderMealLogSummary() {
            if (state.mealLog.length === 0) {
                mealListPlaceholder.classList.remove('hidden');
                loggedMealsSummary.querySelector('#meal-list-container')?.remove();
                return;
            }
            mealListPlaceholder.classList.add('hidden');
            let listHtml = state.mealLog.map(meal => `<div class="p-3 border-l-4 border-yellow-400 bg-white rounded-lg shadow-sm"><p class="font-semibold text-gray-800">${meal.name}</p><p class="text-xs text-gray-500">${meal.details || 'No details provided'}</p><p class="text-xs text-yellow-600 mt-1">${formatDate(meal.date)}</p></div>`).join('');
            let listContainer = loggedMealsSummary.querySelector('#meal-list-container');
            if (!listContainer) {
                listContainer = document.createElement('div');
                listContainer.id = 'meal-list-container';
                listContainer.className = 'space-y-3';
                loggedMealsSummary.appendChild(listContainer);
            }
            listContainer.innerHTML = listHtml;
        }

        function handleGymSetupSave(e) {
            e.preventDefault();
            const form = e.currentTarget;
            const formData = new FormData(form);
            const isModal = form.id === 'active-gym-setup-form';
            if (!isModal) { state.gymName = formData.get('gym-name') || "Custom Gym"; }
            state.gymSetup.weights = formData.getAll('weights');
            state.gymSetup.cardio = formData.getAll('cardio');
            state.gymSetup.floor = formData.getAll('floor');
            if (isModal) {
                equipmentModal.classList.add('hidden');
                renderExerciseDropdown();
                showMessage(`Equipment updated! Exercise list refreshed.`, 'info');
            } else {
                showMessage("Gym setup saved successfully!", 'success');
                showView('dashboard');
            }
        }
      
        function handleFocusChange() {
            const isSpecific = workoutFocusSelect.value === 'specific-muscles';
            muscleCheckboxesDiv.classList.toggle('hidden', !isSpecific);
            renderExerciseDropdown();
        }

        function handleStartWorkout(e) {
            e.preventDefault();
            const focus = workoutFocusSelect.value;
            if (!focus) { showMessage("Please select a training focus before starting.", 'error'); return; }
            state.currentWorkout = {
                title: focus.replace(/-/g, ' ').toUpperCase(),
                date: new Date().toISOString(),
                exercises: [],
                currentExercise: null,
            };
            activeWorkoutTitle.textContent = state.currentWorkout.title;
            setsTrackingContainer.innerHTML = '';
            updateLoggedExercisesSummary();
            showView('track-workout');
            renderExerciseDropdown();
            showMessage(`Workout started: ${state.currentWorkout.title}`, 'info', 4000);
        }

        function handleSetRepWeightChange(e) {
            const button = e.currentTarget;
            const delta = parseFloat(button.getAttribute('data-delta'));
            const field = button.getAttribute('data-field');
            const row = button.closest('.set-row');
            const inputField = row.querySelector(`.set-input-field[data-field="${field}"]`);
            let currentValue = parseFloat(inputField.value);
            let newValue = currentValue + delta;
            if (field === 'reps') {
                newValue = Math.max(1, Math.round(newValue));
            } else if (field === 'weight') {
                newValue = Math.max(0.0, newValue);
                newValue = parseFloat(newValue.toFixed(1));
            }
            inputField.value = formatWeight(newValue);
            handleSetInputUpdate({ currentTarget: inputField });
        }
      
        function handleSetInputUpdate(e) {
            const inputField = e.currentTarget;
            const row = inputField.closest('.set-row');
            const index = parseInt(row.getAttribute('data-set-index'));
            const field = inputField.getAttribute('data-field');
            let value = parseFloat(inputField.value);
            if (field === 'weight') { value = parseFloat(value.toFixed(1)); }
            if (state.currentWorkout?.currentExercise && !isNaN(value)) {
                state.currentWorkout.currentExercise.setsData[index][field] = value;
            }
        }

        function saveExercise() {
            if (!state.currentWorkout || !state.currentWorkout.currentExercise) { showMessage("Error: No active exercise to save.", 'error'); return; }
            const exercise = state.currentWorkout.currentExercise;
            const validSets = exercise.setsData.filter(s => s.weight > 0 || s.reps > 0);
            if (validSets.length === 0) { showMessage("Cannot save: No sets recorded positive reps or weight.", 'error'); return; }
            const volume = calculateVolume(validSets);
            const maxWeight = validSets.filter(s => s.reps > 0).reduce((max, s) => Math.max(max, s.weight), 0);
            if (!state.exerciseHistory[exercise.name] || maxWeight > state.exerciseHistory[exercise.name].bestWeight) {
                state.exerciseHistory[exercise.name] = { bestWeight: maxWeight, bestReps: validSets.find(s => s.weight === maxWeight)?.reps || 0, lastDate: new Date().toLocaleDateString(), };
                if (maxWeight > 0) { showMessage(`New PB for ${exercise.name}: ${formatWeight(maxWeight)}kg!`, 'success'); }
            }
            state.currentWorkout.exercises.push({ ...exercise, setsData: validSets, volume: volume, });
            setsTrackingContainer.innerHTML = '';
            exerciseSelect.value = '';
            setsInput.value = 3;
            targetRepsInput.value = 10;
            state.currentWorkout.currentExercise = null;
            updateLoggedExercisesSummary();
            showMessage(`${exercise.name} logged successfully! Total volume: ${formatWeight(volume)}kg.`, 'success');
        }

        window.saveWorkout = function() {
            if (state.currentWorkout?.currentExercise) {
                if (state.currentWorkout.currentExercise.setsData.some(s => s.weight > 0 || s.reps > 0)) { saveExercise(); } 
                else { state.currentWorkout.currentExercise = null; showMessage("Empty sets were discarded.", 'info'); }
            }
            if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) { showMessage("The workout is empty. No session saved.", 'error'); state.currentWorkout = null; return; }
            const totalVolume = state.currentWorkout.exercises.reduce((total, ex) => total + ex.volume, 0);
            state.workoutLog.push({ ...state.currentWorkout, totalVolume: totalVolume, duration: 'Simulated 45 min', });
            state.currentWorkout = null;
            showMessage(`Workout finished! Total volume lifted: ${formatWeight(totalVolume)}kg. Great job!`, 'success', 6000);
        }
        
        function handleMealLogSave(e) {
            e.preventDefault();
            const nameInput = e.target.querySelector('input[name="meal-name"]');
            const detailsInput = e.target.querySelector('textarea[name="meal-details"]');
            const mealName = nameInput.value.trim();
            const mealDetails = detailsInput.value.trim();
            if (mealName.length === 0) { showMessage("Please enter a name for the meal.", 'error'); return; }
            state.mealLog.push({ name: mealName, details: mealDetails, date: new Date().toISOString() });
            showMessage(`Meal "${mealName}" logged successfully!`, 'success');
            e.target.reset();
            renderMealLogSummary();
        }

        function renderHistory() {
            historyContent.innerHTML = '';
            const historyKeys = Object.keys(state.exerciseHistory).sort((a, b) => { return state.exerciseHistory[b].bestWeight - state.exerciseHistory[a].bestWeight; });
            if (historyKeys.length === 0) { historyContent.innerHTML = '<p class="text-gray-500 italic text-center">No history yet. Log a workout to see your best lifts!</p>'; return; }
            const items = historyKeys.map(name => {
                const item = state.exerciseHistory[name];
                return `<div class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm"><h4 class="text-xl font-bold text-gray-800">${name}</h4><p class="text-gray-600 mt-1"><i class="fas fa-arrow-up mr-1 text-red-500"></i> <span class="font-semibold">Best Weight:</span> ${formatWeight(item.bestWeight)}kg (for ${item.bestReps} reps)</p><p class="text-xs text-gray-400">Last PB Achieved: ${item.lastDate}</p></div>`;
            }).join('');
            historyContent.innerHTML = `<div class="space-y-4">${items}</div>`;
        }


        // --- INITIALIZATION & EVENT LISTENERS (Merged) ---

        function initApp() {
            // Load user info (currently hardcoded)
            document.getElementById('user-name').textContent = state.userName;
            document.getElementById('user-goal').textContent = state.goal;

            // Render initial controls
            renderMuscleCheckboxes();
            renderWorkoutFocus();
            updateDashboardStatus();
            
            // Setup default view
            showView('dashboard', false); 

            // Firebase Initialization must happen once on load
            initializeFirebase(); 

            // Event Listeners for forms
            gymSetupForm.addEventListener('submit', handleGymSetupSave);
            activeGymSetupForm.addEventListener('submit', handleGymSetupSave);
            workoutFocusSelect.addEventListener('change', handleFocusChange);
            workoutPlanningForm.addEventListener('submit', handleStartWorkout);
            document.getElementById('add-meal-form').addEventListener('submit', handleMealLogSave);
            
            // Body Metrics Listener
            measurementForm.addEventListener('submit', handleSaveMeasurement);
            
            // Active Workout Listeners
            document.getElementById('start-sets-btn').addEventListener('click', renderSetsTracking);
            document.getElementById('finish-workout-btn').addEventListener('click', () => {
                saveWorkout();
                showView('dashboard');
            });

            // Navigation Listeners
            document.getElementById('view-history-btn').addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
            });
            document.getElementById('close-history-btn').addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });

            // Equipment Modal Listeners
            document.getElementById('open-equipment-modal-btn').addEventListener('click', () => {
                renderActiveEquipmentModal();
                equipmentModal.classList.remove('hidden');
            });
            document.getElementById('close-equipment-modal-btn').addEventListener('click', () => {
                equipmentModal.classList.add('hidden');
            });
            
            // Re-render exercise list when muscles are checked/unchecked
            muscleOptionsDiv.addEventListener('change', () => {
                 if (workoutFocusSelect.value === 'specific-muscles') {
                    renderExerciseDropdown();
                 }
            });
        }

        // Run initialization when the page is ready
        window.onload = initApp;

    </script>

</body>
</html>
```eof

{ name: "Romanian Deadlift", muscle: "Glutes", equipment: ["barbell", "dumbbell"] },

        
        //Glutes
        { name: "Glute Bridges", muscle: "Glutes", equipment: ["bodyweight", "barbell"] },
        { name: "Romanian Deadlift", muscle: "Glutes", equipment: ["barbell", "dumbbell"] },

        
        
        // CARDIO & FUNCTIONAL
        { name: "Treadmill Run", muscle: "Cardio", equipment: ["treadmill"] },
        { name: "Stationary Bike", muscle: "Cardio", equipment: ["bike"] },
        { name: "Rowing Machine", muscle: "Cardio", equipment: ["rower"] },
        { name: "Kettlebell Swing", muscle: "Hamstrings", equipment: ["kettlebell"] },
        { name: "Medicine Ball Slam", muscle: "Abs", equipment: ["medicine ball"] },
        { name: "Burpees", muscle: "Cardio", equipment: ["bodyweight"] }
    ];

    // Initial State
    let appState = JSON.parse(localStorage.getItem('fitnessProState')) || {
        equipment: ["barbell", "dumbbell", "machines", "bodyweight", "treadmill"], 
        workouts: [], 
        metrics: []
    };

    let currentSession = { exercises: [] };
    let currentFocus = "";
    let selectedMuscles = [];
    let strengthChartInstance = null;
    let editingWorkoutDate = null; // Stores ISO date string when editing

    /* --- VIEW NAVIGATION --- */
    function showView(viewId) {
        document.querySelectorAll('.view, .view-card').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${viewId}`).classList.remove('hidden');
        window.scrollTo(0,0);

        if(viewId === 'gym-config') renderEquipmentForm();
        if(viewId === 'plan-wizard-step1') renderFocusSelection();
        if(viewId === 'body-metrics') renderMetricsHistory();
        if(viewId === 'analysis') renderAnalysis();
    }

    function saveState() {
        try {
            localStorage.setItem('fitnessProState', JSON.stringify(appState));
        } catch (e) {
            alert("Storage full! Try deleting old photos or data.");
        }
    }

    function showMsg(text, color='success') {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.style.background = color === 'success' ? 'var(--success)' : 'var(--danger)';
        box.classList.remove('hidden');
        box.style.opacity = '1';
        setTimeout(() => box.classList.add('hidden'), 3000);
    }

    /* --- GYM CONFIG --- */
    function renderEquipmentForm() {
        const createCheckboxes = (cat, containerId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = EQUIPMENT_CATEGORIES[cat].map(eq => `
                <label style="background: #f9fafb; padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" value="${eq}" ${appState.equipment.includes(eq) ? 'checked' : ''}>
                    ${eq.charAt(0).toUpperCase() + eq.slice(1)}
                </label>
            `).join('');
        };

        createCheckboxes('weights', 'equipment-weights');
        createCheckboxes('cardio', 'equipment-cardio');
        createCheckboxes('functional', 'equipment-functional');
    }

    document.getElementById('gym-setup-form').onsubmit = (e) => {
        e.preventDefault();
        const checkboxes = document.querySelectorAll('#gym-setup-form input:checked');
        appState.equipment = Array.from(checkboxes).map(c => c.value);
        saveState();
        showMsg("Equipment Saved");
        showView('dashboard');
    };

    /* --- WORKOUT WIZARD STEP 1: FOCUS --- */
    function renderFocusSelection() {
        const container = document.getElementById('focus-options-container');
        container.innerHTML = FOCUS_TYPES.map(focus => `
            <div class="focus-option" onclick="selectFocus(this, '${focus}')">
                ${focus}
            </div>
        `).join('');
        
        currentFocus = "";
        selectedMuscles = [];
        document.getElementById('specific-muscle-selector').classList.add('hidden');
        
        const muscleContainer = document.getElementById('muscle-checkboxes');
        muscleContainer.innerHTML = MUSCLES_LIST.map(m => `
            <label class="muscle-check">
                <input type="checkbox" value="${m}" onchange="updateSelectedMuscles()"> ${m}
            </label>
        `).join('');
    }

    function selectFocus(el, focus) {
        document.querySelectorAll('.focus-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        currentFocus = focus;

        const muscleSelector = document.getElementById('specific-muscle-selector');
        if (focus === "Specific Muscles") {
            muscleSelector.classList.remove('hidden');
        } else {
            muscleSelector.classList.add('hidden');
        }
    }

    function updateSelectedMuscles() {
        const checks = document.querySelectorAll('#muscle-checkboxes input:checked');
        selectedMuscles = Array.from(checks).map(c => c.value);
    }

    function goToWorkoutSelection() {
        if(!currentFocus) return alert("Please select a workout focus first.");
        if(currentFocus === "Specific Muscles" && selectedMuscles.length === 0) return alert("Please select at least one muscle group.");

        document.getElementById('active-focus-display').textContent = 
            currentFocus === "Specific Muscles" ? selectedMuscles.join(", ") : currentFocus;
        
        document.getElementById('exercise-search').value = "";
        filterExerciseList();
        renderSessionPreview();
        showView('plan-workout');
    }

    /* --- WORKOUT STEP 2: LOGIC --- */
    function filterExerciseList() {
        const search = document.getElementById('exercise-search').value.toLowerCase();
        const select = document.getElementById('exercise-select');
        
        let allowedMuscles = currentFocus === "Specific Muscles" ? selectedMuscles : FOCUS_MAP[currentFocus];

        const available = EXERCISE_LIBRARY.filter(ex => ex.equipment.some(eq => appState.equipment.includes(eq)));

        const filtered = available.filter(ex => {
            const matchesFocus = allowedMuscles.includes(ex.muscle);
            const matchesSearch = ex.name.toLowerCase().includes(search);
            return matchesFocus && matchesSearch;
        });

        select.innerHTML = filtered.length === 0 
            ? '<option disabled>No exercises found matching criteria</option>' 
            : filtered.map(ex => `<option value="${ex.name}">${ex.name} (${ex.muscle})</option>`).join('');
    }

    function addToSession() {
        const name = document.getElementById('exercise-select').value;
        if(!name || name.includes("No exercises")) return alert("Select an exercise first");
        
        const sets = parseInt(document.getElementById('input-sets').value);
        const reps = parseInt(document.getElementById('input-reps').value);

        if(currentSession.exercises.find(e => e.name === name)) return alert("Exercise already in session.");

        currentSession.exercises.push({
            name: name,
            targetSets: sets,
            targetReps: reps
        });

        renderSessionPreview();
        document.getElementById('active-session-ui').classList.remove('hidden');
        document.getElementById('active-session-ui').scrollIntoView({behavior: "smooth"});
    }

    function renderSessionPreview() {
        const container = document.getElementById('session-exercises');
        if(currentSession.exercises.length === 0) {
             container.innerHTML = "";
             return;
        }

        container.innerHTML = currentSession.exercises.map((ex, index) => `
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong>${ex.name}</strong>
                    <button onclick="removeExercise(${index})" style="background:none; border:none; color:red; cursor:pointer;">&times;</button>
                </div>
                <div id="sets-container-${index}">
                    ${generateSetInputs(index, ex.targetSets, ex.targetReps)}
                </div>
            </div>
        `).join('');
    }

    function generateSetInputs(exIndex, sets, reps) {
        let html = '';
        for(let i=0; i<sets; i++) {
            html += `
            <div class="set-row">
                <span style="font-size: 0.85rem; font-weight: bold; color: var(--text-gray);">Set ${i+1}</span>
                <input type="number" placeholder="${reps} reps" class="s-reps-${exIndex}" value="${reps}">
                <input type="number" placeholder="kg" class="s-weight-${exIndex}">
            </div>`;
        }
        return html;
    }

    function removeExercise(index) {
        currentSession.exercises.splice(index, 1);
        renderSessionPreview();
        if(currentSession.exercises.length === 0) document.getElementById('active-session-ui').classList.add('hidden');
    }

    function finishSession() {
        if(currentSession.exercises.length === 0) return;

        const finalizedSession = {
            date: new Date().toISOString(),
            exercises: []
        };

        currentSession.exercises.forEach((ex, idx) => {
            const repsInputs = document.querySelectorAll(`.s-reps-${idx}`);
            const weightInputs = document.querySelectorAll(`.s-weight-${idx}`);
            
            const setsData = [];
            let maxWeight = 0;

            for(let i=0; i<repsInputs.length; i++) {
                const r = parseFloat(repsInputs[i].value) || 0;
                const w = parseFloat(weightInputs[i].value) || 0;
                if(r > 0 && w > 0) {
                    setsData.push({ reps: r, weight: w });
                    if(w > maxWeight) maxWeight = w;
                }
            }

            if(setsData.length > 0) {
                finalizedSession.exercises.push({
                    name: ex.name,
                    sets: setsData,
                    maxWeight: maxWeight,
                    muscle: EXERCISE_LIBRARY.find(lib => lib.name === ex.name)?.muscle || "Other"
                });
            }
        });

        if(finalizedSession.exercises.length > 0) {
            appState.workouts.push(finalizedSession);
            saveState();
            currentSession = { exercises: [] };
            showMsg("Workout Saved!");
            showView('dashboard');
        } else {
            alert("No valid sets recorded (must have reps and weight > 0).");
        }
    }

    /* --- METRICS & PHOTOS --- */
    document.getElementById('metrics-form').onsubmit = async (e) => {
        e.preventDefault();
        
        const entry = {
            date: new Date().toISOString(),
            weight: document.getElementById('m-weight').value,
            chest: document.getElementById('m-chest').value,
            waist: document.getElementById('m-waist').value,
            arms: document.getElementById('m-arms').value,
            thighs: document.getElementById('m-thighs').value,
            photo: null
        };

        const fileInput = document.getElementById('m-photo');
        if (fileInput.files && fileInput.files[0]) {
            entry.photo = await compressImage(fileInput.files[0]);
        }

        appState.metrics.push(entry);
        saveState();
        renderMetricsHistory();
        e.target.reset();
        showMsg("Metrics Logged");
    };

    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300; 
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            }
        });
    }

    function renderMetricsHistory() {
        const container = document.getElementById('metrics-history-list');
        const sorted = [...appState.metrics].reverse();
        
        container.innerHTML = sorted.map(m => `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <strong>${new Date(m.date).toLocaleDateString()}</strong>
                    <span style="color: var(--primary); font-weight:bold;">${m.weight ? m.weight + ' kg' : ''}</span>
                </div>
                <div style="display:flex; gap:15px; font-size: 0.9rem; color: var(--text-gray); flex-wrap: wrap;">
                    ${m.chest ? `<span>Chest: ${m.chest}</span>` : ''}
                    ${m.waist ? `<span>Waist: ${m.waist}</span>` : ''}
                    ${m.arms ? `<span>Arms: ${m.arms}</span>` : ''}
                </div>
                ${m.photo ? `<img src="${m.photo}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px; margin-top: 10px; border: 1px solid #ccc;">` : ''}
            </div>
        `).join('');
    }

    /* --- ANALYSIS & CHARTS --- */
    function renderAnalysis() {
        renderHeatmap();
        renderVolumeAnalysis();
        populateChartSelect();
        renderStrengthChart();
    }

    function renderHeatmap() {
        const container = document.getElementById('calendar-heatmap');
        container.innerHTML = "";
        
        const now = new Date();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        
        const workoutMap = {}; // Key: day (int), Value: workout object
        
        appState.workouts.forEach(w => {
            const d = new Date(w.date);
            if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                workoutMap[d.getDate()] = w;
            }
        });

        for(let i=1; i<=daysInMonth; i++) {
            const dayEl = document.createElement('div');
            const hasWorkout = !!workoutMap[i];
            dayEl.className = `cal-day ${hasWorkout ? 'active' : ''}`;
            dayEl.textContent = i;
            if(hasWorkout) {
                dayEl.onclick = () => openDayDetails(workoutMap[i]);
                dayEl.title = "View/Edit Workout";
            }
            container.appendChild(dayEl);
        }
    }

    /* --- HISTORY EDITING (MODAL) --- */
    function openDayDetails(workout) {
        editingWorkoutDate = workout.date;
        document.getElementById('day-details-modal').classList.remove('hidden');
        document.getElementById('modal-date-title').textContent = new Date(workout.date).toDateString();
        
        renderModalContent(workout);
        populateModalExerciseSelect();
    }

    function renderModalContent(workout) {
        const container = document.getElementById('modal-workout-content');
        container.innerHTML = workout.exercises.map((ex, exIdx) => `
            <div style="background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>${ex.name}</strong>
                    <button onclick="deleteExerciseFromHistory(${exIdx})" style="color:red; background:none; border:none; cursor:pointer;">&times;</button>
                </div>
                <div style="margin-top:5px;">
                    ${ex.sets.map((set, sIdx) => `
                        <div style="display:grid; grid-template-columns: 50px 1fr 1fr; gap:5px; margin-bottom:5px; align-items:center;">
                            <small>Set ${sIdx+1}</small>
                            <input type="number" class="edit-reps" data-ex="${exIdx}" data-set="${sIdx}" value="${set.reps}" style="padding:5px;">
                            <input type="number" class="edit-weight" data-ex="${exIdx}" data-set="${sIdx}" value="${set.weight}" style="padding:5px;">
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function populateModalExerciseSelect() {
        const select = document.getElementById('modal-exercise-add');
        // Filter to available equipment
        const available = EXERCISE_LIBRARY.filter(ex => ex.equipment.some(eq => appState.equipment.includes(eq)));
        select.innerHTML = available.map(ex => `<option value="${ex.name}">${ex.name}</option>`).join('');
    }

    function addExerciseToPastWorkout() {
        const name = document.getElementById('modal-exercise-add').value;
        const workout = appState.workouts.find(w => w.date === editingWorkoutDate);
        if(!workout || !name) return;

        // Add with default 3 sets 10 reps placeholders
        workout.exercises.push({
            name: name,
            sets: [{reps:10, weight:10}, {reps:10, weight:10}, {reps:10, weight:10}],
            maxWeight: 10,
            muscle: EXERCISE_LIBRARY.find(lib => lib.name === name)?.muscle || "Other"
        });
        
        renderModalContent(workout);
    }

    function deleteExerciseFromHistory(index) {
        if(!confirm("Remove this exercise?")) return;
        const workout = appState.workouts.find(w => w.date === editingWorkoutDate);
        if(workout) {
            workout.exercises.splice(index, 1);
            renderModalContent(workout);
        }
    }

    function saveDayChanges() {
        const workout = appState.workouts.find(w => w.date === editingWorkoutDate);
        if(!workout) return;

        // Harvest data from modal inputs
        const repInputs = document.querySelectorAll('.edit-reps');
        const weightInputs = document.querySelectorAll('.edit-weight');

        // Loop through inputs and update data structure in place
        // Note: The UI is rendered index-sequentially, so we can trust order
        let inputCounter = 0;
        workout.exercises.forEach(ex => {
            let maxW = 0;
            ex.sets.forEach(set => {
                const r = parseFloat(repInputs[inputCounter].value);
                const w = parseFloat(weightInputs[inputCounter].value);
                set.reps = r;
                set.weight = w;
                if(w > maxW) maxW = w;
                inputCounter++;
            });
            ex.maxWeight = maxW;
        });

        // Filter out exercises that might have become empty sets if logic changed (not really possible here but good practice)
        saveState();
        closeDayModal();
        showMsg("History Updated");
        renderStrengthChart(); // Refresh chart if needed
        renderVolumeAnalysis();
    }

    function closeDayModal() {
        document.getElementById('day-details-modal').classList.add('hidden');
        editingWorkoutDate = null;
    }

    /* --- CHARTING --- */
    function renderVolumeAnalysis() {
        const container = document.getElementById('volume-bars');
        container.innerHTML = "";
        
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        
        const weeklySets = {};
        
        appState.workouts.forEach(w => {
            if(new Date(w.date) >= oneWeekAgo) {
                w.exercises.forEach(ex => {
                    if(!weeklySets[ex.muscle]) weeklySets[ex.muscle] = 0;
                    weeklySets[ex.muscle] += ex.sets.length;
                });
            }
        });

        MUSCLES_LIST.forEach(m => {
            if(m === "Cardio") return; 
            const sets = weeklySets[m] || 0;
            const percentage = Math.min((sets / 25) * 100, 100);
            
            let statusClass = "under"; 
            if(sets >= 12 && sets <= 20) statusClass = "optimal";
            if(sets > 20) statusClass = "over";

            container.innerHTML += `
                <div class="volume-bar-container">
                    <div class="volume-label">
                        <span>${m}</span>
                        <span>${sets} / 12-20 sets</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill ${statusClass}" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
    }

    function populateChartSelect() {
        const select = document.getElementById('chart-exercise-select');
        const exercises = [...new Set(appState.workouts.flatMap(w => w.exercises.map(e => e.name)))];
        if(exercises.length === 0) {
            select.innerHTML = "<option>No data yet</option>";
            return;
        }
        select.innerHTML = exercises.map(e => `<option value="${e}">${e}</option>`).join('');
    }

    function renderStrengthChart() {
        const exerciseName = document.getElementById('chart-exercise-select').value;
        const ctx = document.getElementById('strengthChart').getContext('2d');
        
        const dataPoints = [];
        
        appState.workouts.forEach(w => {
            const match = w.exercises.find(e => e.name === exerciseName);
            if(match) {
                dataPoints.push({
                    x: new Date(w.date).toLocaleDateString(),
                    y: match.maxWeight
                });
            }
        });

        if(strengthChartInstance) strengthChartInstance.destroy();

        strengthChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataPoints.map(d => d.x),
                datasets: [{
                    label: `Max Weight (kg) - ${exerciseName}`,
                    data: dataPoints.map(d => d.y),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    }

    function resetAppData() {
        if(confirm("Delete all data? This cannot be undone.")) {
            localStorage.removeItem('fitnessProState');
            location.reload();
        }
    }

</script>
</body>
</html>

