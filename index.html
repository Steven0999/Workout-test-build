<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="VFit App Pro - Complete fitness tracking app with cloud sync">
    <meta name="theme-color" content="#4f46e5">
    <title>VFit App Pro - Your Complete Fitness Companion</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’ª</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #f43f5e;
            --bg-main: #f8fafc;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .photo-slot {
            aspect-ratio: 3/4;
            background: #f1f5f9;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            border: 2px dashed #e2e8f0;
            position: relative;
            transition: all 0.2s;
            min-height: 120px;
        }
        
        .photo-slot:hover { border-color: var(--brand-primary); transform: scale(1.02); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        button { 
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.97); }

        input, select {
            min-height: 48px;
            font-size: 16px;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .translate-x-0 { transform: translateX(0); }
        .-translate-x-full { transform: translateX(-100%); }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #app-screen {
            display: none;
        }

        .input-group {
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .input-group input {
            padding-left: 3rem;
        }

        .store-dropdown { animation: dropdownPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropdownPop {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @media (max-width: 640px) {
            main { padding: 0.75rem !important; }
            .glass-card { padding: 1rem !important; }
            .toast { font-size: 0.8125rem; padding: 0.625rem 1rem; }
            
            h1 { font-size: 1.125rem; }
            h2 { font-size: 1rem; }
            h3 { font-size: 0.9375rem; }
            h4 { font-size: 0.875rem; }
            
            .text-5xl { font-size: 2.25rem !important; line-height: 1.2; }
            .text-4xl { font-size: 1.875rem !important; line-height: 1.2; }
            .text-3xl { font-size: 1.5rem !important; line-height: 1.3; }
            .text-2xl { font-size: 1.25rem !important; }
            .text-xl { font-size: 1.125rem !important; }
            .text-lg { font-size: 1rem !important; }
            
            .rounded-\[2\.5rem\], .rounded-\[3rem\], .rounded-\[32px\], .rounded-\[40px\] {
                border-radius: 1.5rem !important;
            }
        }

        .grid {
            display: grid;
            width: 100%;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.75rem;
        }

        @media (max-width: 640px) {
            .grid-cols-2, .grid-cols-3 {
                gap: 0.5rem;
            }
        }

        #exercise-list > div {
            width: 100%;
            margin-bottom: 1rem;
        }

        .flex.gap-2 {
            display: flex;
            gap: 0.5rem;
            width: 100%;
        }

        @media (max-width: 640px) {
            .flex.gap-2 {
                gap: 0.375rem;
            }
        }

        .flex-1 {
            flex: 1 1 0%;
            min-width: 0;
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="w-full max-w-md px-4">
            <div class="bg-white rounded-[3rem] p-8 shadow-2xl">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">ðŸ’ª</div>
                    <h1 class="text-3xl font-black text-indigo-600 mb-2">VFit<span class="text-slate-600">Pro</span></h1>
                    <p class="text-slate-500 text-sm">Your complete fitness companion</p>
                </div>

                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
                    
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="login-password" placeholder="Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>

                        <button onclick="loginUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Sign In
                        </button>

                        <button onclick="showForgotPassword()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Forgot Password?
                        </button>

                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Don't have an account?</p>
                            <button onclick="showRegister()" class="text-indigo-600 font-bold hover:text-indigo-700">
                                Create Account
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                    
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <input type="text" id="register-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>

                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="register-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-password" placeholder="Password (min 6 characters)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>

                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-confirm" placeholder="Confirm Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>

                        <button onclick="registerUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Create Account
                        </button>

                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Already have an account?</p>
                            <button onclick="showLogin()" class="text-indigo-600 font-bold hover:text-indigo-700">
                                Sign In
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgot-password-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Reset Password</h2>
                    
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600 text-center mb-4">Enter your email and we'll send you a reset link</p>

                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="forgot-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>

                        <button onclick="resetPassword()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Send Reset Link
                        </button>

                        <button onclick="showLogin()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Back to Login
                        </button>
                    </div>
                </div>
            </div>

            <p class="text-center text-white text-xs mt-6 opacity-75">
                By continuing, you agree to our Terms of Service and Privacy Policy
            </p>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen">
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-4 sm:px-6 py-4 sm:py-5 sticky top-0 z-40 flex justify-between items-center">
            <button onclick="toggleSidebar()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors">
                <i data-lucide="menu" class="w-6 h-6 text-slate-700"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">VFit<span class="text-slate-600">Pro</span></h1>
                <p id="user-email" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Loading...</p>
            </div>
            <button onclick="switchTab('profile')" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors">
                <i data-lucide="user" class="w-6 h-6 text-slate-700"></i>
            </button>
        </header>

        <main class="max-w-xl mx-auto p-4 sm:p-6 space-y-6">
            
            <!-- DASHBOARD -->
            <section id="dashboard" class="tab-content active space-y-6">
                <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center">
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 192 192">
                            <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                            <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                        </svg>
                        <div class="absolute text-center">
                            <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Today</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                        <div class="text-center">
                            <div id="dash-protein" class="font-bold">0g</div>
                            <div class="text-[9px] uppercase text-slate-400">Protein</div>
                        </div>
                        <div class="text-center border-x">
                            <div id="dash-carbs" class="font-bold">0g</div>
                            <div class="text-[9px] uppercase text-slate-400">Carbs</div>
                        </div>
                        <div class="text-center">
                            <div id="dash-fat" class="font-bold">0g</div>
                            <div class="text-[9px] uppercase text-slate-400">Fats</div>
                        </div>
                    </div>
                </div>

                <div id="hydration-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="droplet" class="text-cyan-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Hydration Goal</h4>
                                <p id="water-count" class="text-xs text-slate-500">0 / 2.5L</p>
                            </div>
                        </div>
                        <button onclick="toggleHydrationGoal()" id="hydration-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click âœ“ when you reach your daily goal</div>
                </div>

                <div id="steps-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="footprints" class="text-amber-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Steps Goal</h4>
                                <p id="steps-count" class="text-xs text-slate-500">0 / 10,000</p>
                            </div>
                        </div>
                        <button onclick="toggleStepsGoal()" id="steps-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click âœ“ when you reach your daily goal</div>
                </div>

                <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white shadow-xl">
                    <h3 class="text-lg font-bold mb-1">Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="switchTab('training')" class="bg-indigo-600 px-4 py-3 rounded-2xl font-bold text-xs">Log Workout</button>
                        <button onclick="switchTab('nutrition')" class="bg-emerald-600 px-4 py-3 rounded-2xl font-bold text-xs">Add Food</button>
                    </div>
                </div>
            </section>

            <!-- PROFILE -->
            <section id="profile" class="tab-content space-y-6">
                <div class="glass-card p-8 rounded-[3rem] text-center">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="user" class="w-12 h-12 text-indigo-600"></i>
                    </div>
                    <h2 id="profile-name" class="text-2xl font-black mb-2">User Name</h2>
                    <p id="profile-email" class="text-sm text-slate-500 mb-6">user@example.com</p>

                    <div class="space-y-3">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Member Since</p>
                            <p id="profile-created" class="font-bold">Loading...</p>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Total Workouts</p>
                            <p id="profile-workouts" class="font-bold">0</p>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Account Status</p>
                            <p class="font-bold text-emerald-600">âœ“ Active</p>
                        </div>
                    </div>

                    <button onclick="logoutUser()" class="w-full mt-6 bg-red-500 text-white p-4 rounded-2xl font-bold hover:bg-red-600">
                        Sign Out
                    </button>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">App Settings</h3>
                    <button onclick="switchTab('settings')" class="w-full bg-slate-100 p-4 rounded-xl font-medium text-left flex items-center justify-between">
                        <span>Preferences & Goals</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </section>

            <!-- TRAINING -->
            <section id="training" class="tab-content space-y-6">
                <div class="glass-card p-6 rounded-[2.5rem] space-y-4">
                    <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                        <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Gym</button>
                        <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-slate-400">Home</button>
                    </div>
                    
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Exercise Focus</label>
                        <select id="workout-focus" onchange="toggleSpecificMuscle()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Full Body</option>
                            <option>Upper</option>
                            <option>Lower</option>
                            <option>Push</option>
                            <option>Pull</option>
                            <option>Legs</option>
                            <option>Specific Muscle</option>
                        </select>
                    </div>

                    <div id="specific-muscle-container" class="hidden">
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Muscle</label>
                        <select id="specific-muscle" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Chest</option>
                            <option>Back</option>
                            <option>Shoulders</option>
                            <option>Biceps</option>
                            <option>Triceps</option>
                            <option>Quads</option>
                            <option>Hamstrings</option>
                            <option>Glutes</option>
                            <option>Calves</option>
                        </select>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Cardio</span>
                            <input type="checkbox" id="add-cardio-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Core</span>
                            <input type="checkbox" id="add-core-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="startWorkout('manual')" class="p-5 bg-slate-900 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-slate-800 active:bg-slate-700">Manual Entry</button>
                        <button onclick="startWorkout('ai')" class="p-5 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-indigo-700 active:bg-indigo-800">AI Generate</button>
                    </div>
                </div>

                <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div>
                            <h3 id="active-workout-title" class="text-xl font-black">Workout</h3>
                            <p id="workout-timer" class="text-indigo-600 font-bold">00:00:00</p>
                        </div>
                        <button onclick="cancelWorkout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl">Ã—</button>
                    </div>
                    <div id="exercise-list" class="space-y-4 mb-6"></div>
                    <button onclick="addExercise()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs mb-4">+ Add Exercise</button>
                    <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold">Finish Workout</button>
                </div>
            </section>

            <!-- NUTRITION -->
            <section id="nutrition" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setNutritionTab('diary')" id="nut-tab-diary" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Diary</button>
                    <button onclick="setNutritionTab('search')" id="nut-tab-search" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Search</button>
                </div>

                <div id="nut-view-diary" class="space-y-6">
                    <div class="bg-white rounded-[32px] p-8 border border-slate-100 shadow-xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <div id="total-kcal" class="text-5xl font-black text-slate-900 mb-1">0</div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Calories Today</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black text-blue-600 flex items-center gap-1 justify-end">
                                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i> <span id="total-protein">0.0</span>g
                                </div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Protein</div>
                            </div>
                        </div>
                    </div>

                    <div id="meal-sections"></div>
                </div>

                <div id="nut-view-search" class="hidden space-y-6">
                    <div>
                        <label class="text-xs font-semibold text-slate-400 ml-1 mb-2 block">Store / Restaurant</label>
                        <div class="relative">
                            <input 
                                id="store-search-input" 
                                type="text" 
                                placeholder="Search stores or restaurants..." 
                                class="w-full p-4 bg-white rounded-3xl border border-slate-100 font-medium outline-none"
                                onfocus="showStoreDropdown()"
                                oninput="filterStoreDropdown(this.value)"
                                autocomplete="off">
                            <div id="store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto"></div>
                        </div>
                        <input type="hidden" id="store-select" value="all">
                    </div>

                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                            <input id="food-search-input" type="text" placeholder="Search food..." 
                                class="w-full bg-slate-100 border-2 border-transparent rounded-[20px] py-4 pl-12 pr-4 focus:bg-white focus:border-emerald-500 outline-none font-semibold">
                        </div>
                        <button onclick="openBarcodeScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center">
                            <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div id="search-loading" class="hidden py-20 text-center">
                        <i data-lucide="loader-2" class="animate-spin text-emerald-500 mx-auto"></i>
                    </div>
                    <div id="search-results-list" class="space-y-3"></div>
                </div>
            </section>

            <!-- METRICS -->
            <section id="metrics" class="tab-content space-y-6">
                <div class="glass-card p-8 rounded-[3rem] space-y-8">
                    <div class="bg-slate-50 p-6 rounded-3xl text-center border">
                        <span class="text-[10px] font-black uppercase text-slate-400 block mb-2">Weight (kg)</span>
                        <input id="metric-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-transparent text-center text-5xl font-black outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Chest (cm)</label>
                            <input id="metric-chest" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Shoulders (cm)</label>
                            <input id="metric-shoulders" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Arms (cm)</label>
                            <input id="metric-arms" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Waist (cm)</label>
                            <input id="metric-waist" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Legs (cm)</label>
                            <input id="metric-legs" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Glutes (cm)</label>
                            <input id="metric-glutes" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 text-center">Progress Photos</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="photo-slot" onclick="triggerPhotoUpload('front')">
                                <img id="photo-front-preview" class="hidden" alt="Front">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Front</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('side')">
                                <img id="photo-side-preview" class="hidden" alt="Side">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Side</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('back')">
                                <img id="photo-back-preview" class="hidden" alt="Back">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Back</span>
                            </div>
                        </div>
                        <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                    </div>

                    <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase">
                        Save Metrics
                    </button>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="settings" class="tab-content space-y-6">
                <div class="glass-card p-6 rounded-[2.5rem] space-y-8">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Calorie Goal</label>
                        <input id="calorie-goal-input" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-bold" onchange="updateCalorieGoal(this.value)">
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Gym Equipment</h3>
                        <div id="gym-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Home Equipment</h3>
                        <div id="home-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>
                </div>
            </section>
        </main>

        <!-- SIDEBAR -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100]" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-80 bg-white shadow-2xl z-[101] transform -translate-x-full">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-black text-indigo-600">Menu</h2>
                    <button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <nav class="space-y-2">
                    <button onclick="switchTab('dashboard'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Dashboard</span>
                    </button>
                    
                    <button onclick="switchTab('training'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="dumbbell" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Training</span>
                    </button>
                    
                    <button onclick="switchTab('nutrition'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="apple" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Nutrition</span>
                    </button>
                    
                    <button onclick="switchTab('metrics'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Metrics</span>
                    </button>
                    
                    <button onclick="switchTab('profile'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="user" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Profile</span>
                    </button>
                    
                    <button onclick="switchTab('settings'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Settings</span>
                    </button>
                </nav>
            </div>
        </div>

        <!-- FOOD POPUP MODAL -->
        <div id="food-popup" class="modal-overlay">
            <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-32 h-32 sm:w-40 sm:h-40 bg-slate-50 rounded-3xl overflow-hidden mb-4 p-3 shadow-lg border-2 border-slate-100">
                        <img id="popup-image" src="" class="w-full h-full object-contain" alt="Food image">
                    </div>
                    <h2 id="popup-name" class="text-xl sm:text-2xl font-black text-center leading-tight mb-2">Product</h2>
                </div>

                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-5 rounded-3xl mb-6 shadow-sm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Calories</p>
                            <p id="popup-nutrition-cals" class="font-black text-3xl text-indigo-600">0</p>
                            <p class="text-xs text-slate-400 mt-1">kcal</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Protein</p>
                            <p id="popup-nutrition-protein" class="font-black text-3xl text-blue-600">0</p>
                            <p class="text-xs text-slate-400 mt-1">grams</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 pt-3 border-t border-indigo-200">
                        <div class="text-center">
                            <p class="text-[9px] font-bold text-slate-500 uppercase">Carbs</p>
                            <p id="popup-nutrition-carbs" class="font-bold text-sm text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[9px] font-bold text-slate-500 uppercase">Fat</p>
                            <p id="popup-nutrition-fat" class="font-bold text-sm text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[9px] font-bold text-slate-500 uppercase">Fiber</p>
                            <p id="popup-nutrition-fiber" class="font-bold text-sm text-indigo-600">0g</p>
                        </div>
                    </div>
                    
                    <p id="popup-nutrition" class="text-xs text-center text-slate-500 mt-3"></p>
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Meal Type</label>
                    <select id="popup-meal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-base">
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack">Snack</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-4">
                        <button onclick="setAmountType('portion')" id="amount-type-portion" class="flex-1 py-3 rounded-xl text-xs font-black uppercase bg-white shadow text-emerald-600">Portion</button>
                        <button onclick="setAmountType('grams')" id="amount-type-grams" class="flex-1 py-3 rounded-xl text-xs font-black uppercase text-slate-400">Grams</button>
                    </div>
                    <input id="popup-amount" type="number" value="1" min="1" class="w-full bg-slate-50 border-4 border-slate-200 rounded-[24px] py-5 text-4xl font-black text-center outline-none focus:border-emerald-500 transition-colors">
                </div>

                <div class="bg-slate-900 text-white p-5 rounded-3xl mb-6 shadow-xl">
                    <p class="text-[10px] font-black uppercase text-slate-400 text-center mb-3">Total You're Adding</p>
                    <div class="flex justify-around items-center">
                        <div class="text-center">
                            <p id="popup-total-kcal" class="font-black text-3xl mb-1">0</p>
                            <p class="text-xs text-slate-400 uppercase">Calories</p>
                        </div>
                        <div class="w-px h-12 bg-slate-700"></div>
                        <div class="text-center">
                            <p id="popup-total-protein" class="font-black text-3xl text-emerald-400 mb-1">0g</p>
                            <p class="text-xs text-slate-400 uppercase">Protein</p>
                        </div>
                    </div>
                </div>

                <button onclick="addFoodItem()" class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:shadow-xl transition-all active:scale-95 mb-3">
                    Add to Diary
                </button>
                <button onclick="closeFoodPopup()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600 transition-colors">
                    Cancel
                </button>
            </div>
        </div>

        <!-- BARCODE SCANNER MODAL -->
        <div id="barcode-scanner-modal" class="modal-overlay">
            <div class="bg-white w-full max-w-lg rounded-[40px] p-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-black">Scan Barcode</h3>
                    <button onclick="closeBarcodeScanner()" class="w-10 h-10 bg-slate-100 rounded-full">Ã—</button>
                </div>
                <div id="barcode-reader" class="w-full h-64 bg-black rounded-2xl mb-4"></div>
                <div class="flex gap-2">
                    <input id="manual-barcode" type="text" placeholder="Or enter barcode manually..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                    <button onclick="lookupBarcode()" class="bg-slate-900 text-white px-6 rounded-xl">Search</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA9H9hmvfrQmc2wIwnS2jCPLgdmXBquQXM",
            authDomain: "vfit-app-pro.firebaseapp.com",
            projectId: "vfit-app-pro",
            storageBucket: "vfit-app-pro.firebasestorage.app",
            messagingSenderId: "815730068689",
            appId: "1:815730068689:web:0c6587d7dbe62b0f3c09f0",
            measurementId: "G-74L12X0NE8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = {};

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        
        const EXERCISE_DB = {
            gym: {
                'Full Body': {
                    compound: ['Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press'],
                    isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl', 'Calf Raise']
                },
                'Upper': {
                    compound: ['Bench Press', 'Pull Ups', 'Dumbbell Row', 'Overhead Press', 'Dips'],
                    isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Face Pulls', 'Cable Flyes']
                },
                'Lower': {
                    compound: ['Barbell Squat', 'Romanian Deadlift', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Abduction', 'Glute Kickback']
                },
                'Push': {
                    compound: ['Bench Press', 'Overhead Press', 'Incline Press', 'Dips'],
                    isolation: ['Tricep Pushdown', 'Lateral Raise', 'Cable Flyes', 'Skull Crushers']
                },
                'Pull': {
                    compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                    isolation: ['Bicep Curl', 'Face Pulls', 'Hammer Curl', 'Cable Row']
                },
                'Legs': {
                    compound: ['Squat', 'Deadlift', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Thrust']
                },
                'Chest': { compound: ['Bench Press', 'Incline Press', 'Dumbbell Press'], isolation: ['Cable Flyes', 'Pec Deck', 'Dumbbell Flyes'] },
                'Back': { compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'], isolation: ['Cable Row', 'Face Pulls', 'Straight Arm Pulldown'] },
                'Shoulders': { compound: ['Overhead Press', 'Arnold Press'], isolation: ['Lateral Raise', 'Front Raise', 'Face Pulls', 'Reverse Flyes'] },
                'Biceps': { compound: ['Chin Ups'], isolation: ['Barbell Curl', 'Hammer Curl', 'Preacher Curl', 'Cable Curl'] },
                'Triceps': { compound: ['Close Grip Bench Press', 'Dips'], isolation: ['Tricep Pushdown', 'Skull Crushers', 'Overhead Extension'] },
                'Quads': { compound: ['Squat', 'Leg Press', 'Lunges'], isolation: ['Leg Extension', 'Sissy Squat'] },
                'Hamstrings': { compound: ['Romanian Deadlift', 'Good Morning'], isolation: ['Leg Curl', 'Nordic Curl'] },
                'Glutes': { compound: ['Hip Thrust', 'Bulgarian Split Squat'], isolation: ['Cable Kickback', 'Hip Abduction', 'Glute Bridge'] },
                'Calves': { compound: [], isolation: ['Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise'] }
            },
            home: {
                'Full Body': { compound: ['Push Ups', 'Bodyweight Squat', 'Burpees'], isolation: ['Plank', 'Crunches', 'Leg Raises'] },
                'Upper': { compound: ['Push Ups', 'Pike Push Ups', 'Inverted Row'], isolation: ['Tricep Dips', 'Plank to Push Up', 'Superman'] },
                'Lower': { compound: ['Bodyweight Squat', 'Lunges', 'Step Ups'], isolation: ['Glute Bridge', 'Calf Raise', 'Donkey Kicks'] },
                'Push': { compound: ['Push Ups', 'Pike Push Ups'], isolation: ['Diamond Push Ups', 'Tricep Dips', 'Shoulder Taps'] },
                'Pull': { compound: ['Inverted Row', 'Chin Ups'], isolation: ['Superman', 'Reverse Snow Angels', 'Bicep Holds'] },
                'Legs': { compound: ['Squat', 'Lunges', 'Jump Squat'], isolation: ['Glute Bridge', 'Calf Raise', 'Leg Raises'] }
            }
        };

        const ALL_EXERCISES = [
            'Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press',
            'Dumbbell Press', 'Incline Press', 'Dips', 'Barbell Row', 'Lat Pulldown',
            'T-Bar Row', 'Romanian Deadlift', 'Leg Press', 'Lunges', 'Good Morning',
            'Hip Thrust', 'Bulgarian Split Squat', 'Arnold Press', 'Close Grip Bench Press',
            'Chin Ups', 'Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl',
            'Calf Raise', 'Face Pulls', 'Cable Flyes', 'Leg Extension', 'Hip Abduction',
            'Glute Kickback', 'Cable Row', 'Hammer Curl', 'Skull Crushers', 'Pec Deck',
            'Dumbbell Flyes', 'Front Raise', 'Reverse Flyes', 'Preacher Curl', 'Cable Curl',
            'Overhead Extension', 'Sissy Squat', 'Nordic Curl', 'Cable Kickback', 'Glute Bridge',
            'Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise', 'Straight Arm Pulldown',
            'Push Ups', 'Bodyweight Squat', 'Burpees', 'Pike Push Ups', 'Inverted Row',
            'Step Ups', 'Donkey Kicks', 'Diamond Push Ups', 'Shoulder Taps', 'Superman',
            'Reverse Snow Angels', 'Bicep Holds', 'Jump Squat', 'Plank', 'Crunches',
            'Leg Raises', 'Tricep Dips', 'Plank to Push Up'
        ].sort();

        const CARDIO_EXERCISES = ['Treadmill', 'Rowing Machine', 'Stationary Bike', 'Elliptical', 'Stair Climber'];
        const CORE_EXERCISES = ['Plank', 'Crunches', 'Russian Twists', 'Leg Raises', 'Mountain Climbers', 'Dead Bug'];

        const UK_STORES_RESTAURANTS = [
            { name: 'All Stores & Restaurants', value: 'all', type: 'all' },
            { name: 'Tesco', value: 'tesco', type: 'supermarket' },
            { name: "Sainsbury's", value: 'sainsburys', type: 'supermarket' },
            { name: 'ASDA', value: 'asda', type: 'supermarket' },
            { name: 'Morrisons', value: 'morrisons', type: 'supermarket' },
            { name: 'Aldi', value: 'aldi', type: 'supermarket' },
            { name: 'Lidl', value: 'lidl', type: 'supermarket' },
            { name: 'Waitrose', value: 'waitrose', type: 'supermarket' },
            { name: 'Co-op', value: 'coop', type: 'supermarket' },
            { name: 'Iceland', value: 'iceland', type: 'supermarket' },
            { name: "McDonald's", value: 'mcdonalds', type: 'fastfood' },
            { name: 'KFC', value: 'kfc', type: 'fastfood' },
            { name: 'Burger King', value: 'burgerking', type: 'fastfood' },
            { name: 'Subway', value: 'subway', type: 'fastfood' },
            { name: 'Greggs', value: 'greggs', type: 'fastfood' },
            { name: "Nando's", value: 'nandos', type: 'fastfood' }
        ].sort((a, b) => a.name.localeCompare(b.name));

        let state = {
            viewDate: new Date().toISOString().split('T')[0],
            goals: { calories: 2500, water: 2500, steps: 10000 },
            waterLogs: {},
            stepsLogs: {},
            dailyMeals: [],
            workoutHistory: [],
            nutritionHistory: [],
            metricsHistory: [],
            workoutEnv: 'gym',
            currentPhotos: { front: null, side: null, back: null },
            hydrationGoalCompletions: {},
            stepsGoalCompletions: {},
            equipment: {
                gym: { 'Barbell': true, 'Dumbbells': true, 'Cable Machine': true, 'Leg Press': true, 'Pull Up Bar': true, 'Bench': true },
                home: { 'Dumbbells': false, 'Resistance Bands': false, 'Pull Up Bar': false, 'Yoga Mat': true }
            }
        };

        let workoutTimer = null;
        let workoutStartTime = null;
        let currentFoodItem = null;
        let currentAmountType = 'portion';
        let searchResults = [];
        let html5QrCode = null;
        let currentPhotoType = null;

        // ========================================
        // UTILITIES
        // ========================================

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // ========================================
        // AUTH FUNCTIONS
        // ========================================

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
        }

        async function registerUser() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;

            if (!name) { showToast('Please enter your name'); return; }
            if (!email || !password) { showToast('Please fill all fields'); return; }
            if (password.length < 6) { showToast('Password must be at least 6 characters'); return; }
            if (password !== confirm) { showToast('Passwords do not match'); return; }

            try {
                showToast('Creating account...');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await user.updateProfile({ displayName: name });

                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    ...state
                });

                showToast('Account created successfully! ðŸŽ‰');
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') showToast('Email already in use');
                else if (error.code === 'auth/invalid-email') showToast('Invalid email address');
                else showToast('Registration failed: ' + error.message);
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) { showToast('Please enter email and password'); return; }

            try {
                showToast('Signing in...');
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Welcome back! ðŸ’ª');
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    showToast('Invalid email or password');
                } else {
                    showToast('Login failed: ' + error.message);
                }
            }
        }

        async function resetPassword() {
            const email = document.getElementById('forgot-email').value.trim();
            if (!email) { showToast('Please enter your email'); return; }

            try {
                await auth.sendPasswordResetEmail(email);
                showToast('Password reset email sent! Check your inbox.');
                showLogin();
            } catch (error) {
                console.error('Reset error:', error);
                showToast('Failed to send reset email');
            }
        }

        async function logoutUser() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await auth.signOut();
                    showToast('Signed out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Logout failed');
                }
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                
                await loadUserData();
                
                document.getElementById('user-email').textContent = user.email;
                renderProfile();
                renderDashboard();
                renderSettings();
                
            } else {
                currentUser = null;
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
            
            lucide.createIcons();
        });

        async function loadUserData() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    state = { ...state, ...data };
                } else {
                    await db.collection('users').doc(currentUser.uid).set(state);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Failed to load user data');
            }
        }

        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update(state);
                console.log('Data saved to cloud');
            } catch (error) {
                console.error('Error saving data:', error);
                showToast('Failed to save data');
            }
        }

        // ========================================
        // TAB MANAGEMENT
        // ========================================

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            lucide.createIcons();
        }

        // ========================================
        // SIDEBAR
        // ========================================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('translate-x-0');
            
            if (isOpen) {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.add('translate-x-0');
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        // ========================================
        // DASHBOARD
        // ========================================

        function renderDashboard() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            const totalCals = todayMeals.reduce((sum, m) => sum + (m.calories || 0), 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + (m.protein || 0), 0);

            document.getElementById('dash-calories').innerText = Math.round(totalCals);
            document.getElementById('dash-protein').innerText = Math.round(totalProtein) + 'g';
            document.getElementById('dash-carbs').innerText = Math.round(totalCals * 0.4 / 4) + 'g';
            document.getElementById('dash-fat').innerText = Math.round(totalCals * 0.3 / 9) + 'g';

            const progress = Math.min((totalCals / state.goals.calories) * 534, 534);
            document.getElementById('calorie-progress').style.strokeDashoffset = 534 - progress;

            const water = state.waterLogs[state.viewDate] || 0;
            document.getElementById('water-count').innerText = `${(water/1000).toFixed(1)} / ${(state.goals.water/1000).toFixed(1)}L`;

            const steps = state.stepsLogs[state.viewDate] || 0;
            document.getElementById('steps-count').innerText = `${steps.toLocaleString()} / ${state.goals.steps.toLocaleString()}`;

            const hydrationComplete = state.hydrationGoalCompletions[state.viewDate] || false;
            const hydrationCheckBtn = document.getElementById('hydration-check');
            if (hydrationCheckBtn) {
                if (hydrationComplete) {
                    hydrationCheckBtn.classList.add('bg-cyan-500', 'border-cyan-500');
                    hydrationCheckBtn.classList.remove('border-slate-200');
                    hydrationCheckBtn.querySelector('i').classList.remove('text-transparent');
                    hydrationCheckBtn.querySelector('i').classList.add('text-white');
                } else {
                    hydrationCheckBtn.classList.remove('bg-cyan-500', 'border-cyan-500');
                    hydrationCheckBtn.classList.add('border-slate-200');
                    hydrationCheckBtn.querySelector('i').classList.add('text-transparent');
                    hydrationCheckBtn.querySelector('i').classList.remove('text-white');
                }
            }

            const stepsComplete = state.stepsGoalCompletions[state.viewDate] || false;
            const stepsCheckBtn = document.getElementById('steps-check');
            if (stepsCheckBtn) {
                if (stepsComplete) {
                    stepsCheckBtn.classList.add('bg-amber-500', 'border-amber-500');
                    stepsCheckBtn.classList.remove('border-slate-200');
                    stepsCheckBtn.querySelector('i').classList.remove('text-transparent');
                    stepsCheckBtn.querySelector('i').classList.add('text-white');
                } else {
                    stepsCheckBtn.classList.remove('bg-amber-500', 'border-amber-500');
                    stepsCheckBtn.classList.add('border-slate-200');
                    stepsCheckBtn.querySelector('i').classList.add('text-transparent');
                    stepsCheckBtn.querySelector('i').classList.remove('text-white');
                }
            }
        }

        function toggleHydrationGoal() {
            const date = state.viewDate;
            state.hydrationGoalCompletions[date] = !state.hydrationGoalCompletions[date];
            saveUserData();
            renderDashboard();
            showToast(state.hydrationGoalCompletions[date] ? 'Hydration goal completed! ðŸ’§' : 'Hydration goal unmarked');
            lucide.createIcons();
        }

        function toggleStepsGoal() {
            const date = state.viewDate;
            state.stepsGoalCompletions[date] = !state.stepsGoalCompletions[date];
            saveUserData();
            renderDashboard();
            showToast(state.stepsGoalCompletions[date] ? 'Steps goal completed! ðŸ‘Ÿ' : 'Steps goal unmarked');
            lucide.createIcons();
        }

        // ========================================
        // PROFILE
        // ========================================

        function renderProfile() {
            if (!currentUser || !userData) return;
            
            document.getElementById('profile-name').textContent = state.name || currentUser.displayName || 'User';
            document.getElementById('profile-email').textContent = currentUser.email;
            
            if (state.createdAt) {
                const date = state.createdAt.toDate ? state.createdAt.toDate() : new Date();
                document.getElementById('profile-created').textContent = date.toLocaleDateString();
            } else {
                document.getElementById('profile-created').textContent = 'Just now';
            }
            
            document.getElementById('profile-workouts').textContent = (state.workoutHistory || []).length;
        }

        // ========================================
        // TRAINING
        // ========================================

        function setWorkoutEnv(env) {
            state.workoutEnv = env;
            document.getElementById('env-tab-gym').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'gym' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('env-tab-home').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'home' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        }

        function toggleSpecificMuscle() {
            const focus = document.getElementById('workout-focus').value;
            document.getElementById('specific-muscle-container').classList.toggle('hidden', focus !== 'Specific Muscle');
        }

        function startWorkout(mode) {
            const focus = document.getElementById('workout-focus').value;
            const muscle = focus === 'Specific Muscle' ? document.getElementById('specific-muscle').value : focus;
            
            document.getElementById('workout-setup').classList.add('hidden');
            document.getElementById('workout-active').classList.remove('hidden');
            document.getElementById('active-workout-title').innerText = muscle;
            document.getElementById('exercise-list').innerHTML = '';

            if (mode === 'ai') {
                const exercises = EXERCISE_DB[state.workoutEnv][muscle];
                const addCardio = document.getElementById('add-cardio-check').checked;
                const addCore = document.getElementById('add-core-check').checked;
                
                if (exercises) {
                    const compounds = exercises.compound || [];
                    const selectedCompounds = compounds.sort(() => 0.5 - Math.random()).slice(0, 2);
                    const isolations = exercises.isolation || [];
                    const selectedIsolations = isolations.sort(() => 0.5 - Math.random()).slice(0, 3);
                    
                    let delay = 0;
                    [...selectedCompounds, ...selectedIsolations].forEach(ex => {
                        setTimeout(() => addExercise(ex), delay);
                        delay += 10;
                    });
                    
                    if (addCardio) {
                        const cardio = CARDIO_EXERCISES[Math.floor(Math.random() * CARDIO_EXERCISES.length)];
                        setTimeout(() => addExercise(cardio), delay);
                        delay += 10;
                    }
                    
                    if (addCore) {
                        const core1 = CORE_EXERCISES[Math.floor(Math.random() * CORE_EXERCISES.length)];
                        const core2 = CORE_EXERCISES.filter(c => c !== core1)[Math.floor(Math.random() * (CORE_EXERCISES.length - 1))];
                        setTimeout(() => addExercise(core1), delay);
                        delay += 10;
                        setTimeout(() => addExercise(core2), delay);
                    }
                    
                    showToast('AI workout generated!');
                } else {
                    showToast('No exercises found for this selection');
                }
            }

            workoutStartTime = Date.now();
            workoutTimer = setInterval(updateWorkoutTimer, 1000);
        }

        function updateWorkoutTimer() {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('workout-timer').innerText = `${h}:${m}:${s}`;
        }

        function addExercise(name = '') {
            const id = 'ex-' + Date.now() + Math.random().toString(36).substr(2, 9);
            const pr = name ? getPersonalRecord(name) : null;
            
            const card = document.createElement('div');
            card.className = "bg-white p-4 sm:p-5 rounded-2xl shadow-md border-2 border-indigo-100 mb-3 sm:mb-4 w-full";
            
            const nameInput = document.createElement('input');
            nameInput.type = "text";
            nameInput.value = name;
            nameInput.placeholder = "Exercise name...";
            nameInput.className = "w-full p-3 sm:p-3.5 border-2 border-slate-200 rounded-xl font-bold text-base sm:text-lg mb-3";
            
            const setsContainer = document.createElement('div');
            setsContainer.id = `sets-${id}`;
            setsContainer.className = "bg-slate-50 p-3 sm:p-4 rounded-xl mb-3 sm:mb-4 min-h-[100px] w-full";
            
            const header = document.createElement('div');
            header.className = "flex gap-2 sm:gap-3 mb-2 sm:mb-3";
            header.innerHTML = `
                <div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Reps</span></div>
                <div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Weight (kg)</span></div>
                <div class="w-9 sm:w-10"></div>
            `;
            setsContainer.appendChild(header);
            
            const addSetBtn = document.createElement('button');
            addSetBtn.type = "button";
            addSetBtn.className = "w-full py-3 sm:py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-sm sm:text-base hover:bg-indigo-700 active:bg-indigo-800";
            addSetBtn.textContent = "+ Add Set";
            addSetBtn.addEventListener('click', () => addSetToExercise(id, pr));
            
            const deleteExBtn = document.createElement('button');
            deleteExBtn.type = "button";
            deleteExBtn.className = "w-full py-2 sm:py-2.5 mt-2 bg-red-50 text-red-600 rounded-xl font-bold text-xs sm:text-sm hover:bg-red-100";
            deleteExBtn.textContent = "Delete Exercise";
            deleteExBtn.addEventListener('click', () => card.remove());
            
            card.appendChild(nameInput);
            card.appendChild(setsContainer);
            card.appendChild(addSetBtn);
            card.appendChild(deleteExBtn);
            
            document.getElementById('exercise-list').appendChild(card);
            
            setTimeout(() => addSetToExercise(id, pr), 50);
        }

        function addSetToExercise(exerciseId, pr) {
            const container = document.getElementById(`sets-${exerciseId}`);
            if (!container) return;
            
            const setRow = document.createElement('div');
            setRow.className = "flex gap-2 sm:gap-3 items-center mb-2 bg-white p-2 sm:p-3 rounded-lg border border-slate-200";
            
            const repsInput = document.createElement('input');
            repsInput.type = "number";
            repsInput.placeholder = "Reps";
            repsInput.min = "0";
            repsInput.className = "flex-1 p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
            
            const weightDiv = document.createElement('div');
            weightDiv.className = "flex-1 relative";
            
            const weightInput = document.createElement('input');
            weightInput.type = "number";
            weightInput.placeholder = "Weight";
            weightInput.min = "0";
            weightInput.step = "0.5";
            weightInput.className = "w-full p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
            
            weightDiv.appendChild(weightInput);
            
            if (pr) {
                const pbBadge = document.createElement('span');
                pbBadge.className = "absolute -top-2 -right-2 text-[9px] sm:text-[10px] font-black text-white bg-emerald-500 px-2 py-1 rounded-full shadow-md whitespace-nowrap z-10";
                pbBadge.textContent = `PB ${pr}kg`;
                weightDiv.appendChild(pbBadge);
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.type = "button";
            deleteBtn.className = "w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold text-lg sm:text-xl flex-shrink-0";
            deleteBtn.textContent = "Ã—";
            deleteBtn.addEventListener('click', () => setRow.remove());
            
            setRow.appendChild(repsInput);
            setRow.appendChild(weightDiv);
            setRow.appendChild(deleteBtn);
            
            container.appendChild(setRow);
        }

        function getPersonalRecord(exerciseName) {
            let maxWeight = 0;
            (state.workoutHistory || []).forEach(workout => {
                (workout.exercises || []).forEach(ex => {
                    if (ex.name === exerciseName) {
                        (ex.sets || []).forEach(set => {
                            const weight = parseFloat(set.weight) || parseFloat(set.kg) || 0;
                            if (weight > maxWeight) maxWeight = weight;
                        });
                    }
                });
            });
            return maxWeight > 0 ? maxWeight : null;
        }

        function saveWorkout() {
            clearInterval(workoutTimer);
            
            const exercises = [];
            document.querySelectorAll('#exercise-list > div').forEach(card => {
                const nameInput = card.querySelector('input[type="text"]');
                const name = nameInput ? nameInput.value.trim() : '';
                if (!name) return;
                
                const sets = [];
                const setRows = card.querySelectorAll('.flex.gap-2.items-center.mb-2');
                setRows.forEach(row => {
                    const inputs = row.querySelectorAll('input[type="number"]');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        sets.push({ reps: inputs[0].value, weight: inputs[1].value });
                    }
                });
                
                if (sets.length > 0) {
                    exercises.push({ name, sets });
                }
            });

            if (exercises.length === 0) {
                showToast('Add at least one exercise with sets');
                return;
            }

            const workoutDate = new Date().toISOString().split('T')[0];

            if (!state.workoutHistory) state.workoutHistory = [];
            
            state.workoutHistory.unshift({
                id: Date.now(),
                date: workoutDate,
                focus: document.getElementById('active-workout-title').innerText,
                duration: document.getElementById('workout-timer').innerText,
                exercises
            });

            saveUserData();
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
            renderDashboard();
            showToast('Workout saved!');
        }

        function cancelWorkout() {
            if (confirm('Discard workout?')) {
                clearInterval(workoutTimer);
                document.getElementById('workout-setup').classList.remove('hidden');
                document.getElementById('workout-active').classList.add('hidden');
            }
        }

        // ========================================
        // NUTRITION
        // ========================================

        function setNutritionTab(tab) {
            document.getElementById('nut-tab-diary').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'diary' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('nut-tab-search').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            
            document.getElementById('nut-view-diary').classList.toggle('hidden', tab !== 'diary');
            document.getElementById('nut-view-search').classList.toggle('hidden', tab !== 'search');

            if (tab === 'diary') renderDiary();
        }

        function renderDiary() {
            const todayMeals = (state.dailyMeals || []).filter(m => m.date === state.viewDate);
            const totalCals = todayMeals.reduce((sum, m) => sum + (m.calories || 0), 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + (m.protein || 0), 0);

            document.getElementById('total-kcal').innerText = Math.round(totalCals);
            document.getElementById('total-protein').innerText = totalProtein.toFixed(1);

            const sections = ['breakfast', 'lunch', 'dinner', 'snack'];
            let html = '';
            
            sections.forEach(section => {
                const meals = todayMeals.filter(m => m.mealType === section);
                const icon = { breakfast: 'coffee', lunch: 'utensils', dinner: 'moon', snack: 'cookie' }[section];
                
                html += `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="${icon}" class="w-4 h-4 text-slate-400"></i>
                            <h3 class="text-[11px] font-black text-slate-400 uppercase">${section}</h3>
                        </div>
                        ${meals.length === 0 ? '<p class="text-xs text-slate-300 italic px-4">Nothing logged</p>' : ''}
                        ${meals.map(m => `
                            <div class="bg-white p-4 rounded-[24px] mb-2 border border-slate-100 flex items-center gap-4">
                                <img src="${m.image}" class="w-12 h-12 object-contain bg-slate-50 rounded-lg p-1" onerror="this.src='https://via.placeholder.com/100'">
                                <div class="flex-1">
                                    <p class="font-bold text-sm">${m.name}</p>
                                    <p class="text-xs text-slate-400">${m.amount} â€¢ ${m.calories}kcal â€¢ ${m.protein}g protein</p>
                                </div>
                                <button onclick="removeMeal(${m.id})" class="text-slate-300 hover:text-red-500">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>`;
            });

            document.getElementById('meal-sections').innerHTML = html;
            lucide.createIcons();
        }

        function removeMeal(id) {
            state.dailyMeals = (state.dailyMeals || []).filter(m => m.id !== id);
            saveUserData();
            renderDiary();
            renderDashboard();
            showToast('Item removed');
        }

        // Food Search
        let searchDebounce;
        document.getElementById('food-search-input')?.addEventListener('input', (e) => {
            clearTimeout(searchDebounce);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('search-results-list').innerHTML = '';
                return;
            }
            searchDebounce = setTimeout(() => searchFood(query), 500);
        });

        async function searchFood(query) {
            document.getElementById('search-loading').classList.remove('hidden');
            document.getElementById('search-results-list').innerHTML = '';

            try {
                const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=20&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                const response = await fetch(url);
                const data = await response.json();
                
                searchResults = (data.products || []).map(p => ({
                    name: p.product_name || 'Unknown',
                    image: p.image_small_url || 'https://via.placeholder.com/100',
                    calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                    protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1),
                    carbs: parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                    fat: parseFloat(p.nutriments?.fat_100g || 0).toFixed(1),
                    fiber: parseFloat(p.nutriments?.fiber_100g || 0).toFixed(1),
                    serving: p.serving_size || '100g',
                    brand: p.brands || ''
                }));
                
                renderSearchResults();
                
            } catch (error) {
                console.error('Search error:', error);
                showToast('Search failed');
            } finally {
                document.getElementById('search-loading').classList.add('hidden');
            }
        }

        function renderSearchResults() {
            if (searchResults.length === 0) {
                document.getElementById('search-results-list').innerHTML = '<p class="text-center text-slate-400 py-8">No results found</p>';
                return;
            }
            
            const html = searchResults.map((item, idx) => `
                <div onclick="openFoodPopup(${idx})" class="bg-white p-4 rounded-[28px] border flex items-center gap-4 cursor-pointer hover:shadow-lg transition-all">
                    <img src="${item.image}" class="w-14 h-14 object-contain bg-slate-50 rounded-xl p-1" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1">
                        <p class="font-bold text-sm">${item.name}</p>
                        ${item.brand ? `<p class="text-[10px] text-indigo-600 font-semibold mb-1">${item.brand}</p>` : ''}
                        <p class="text-xs text-slate-400">${item.calories}kcal â€¢ ${item.protein}g protein â€¢ ${item.serving}</p>
                    </div>
                    <i data-lucide="plus" class="text-emerald-600"></i>
                </div>
            `).join('');
            
            document.getElementById('search-results-list').innerHTML = html;
            lucide.createIcons();
        }

        function showStoreDropdown() {
            const dropdown = document.getElementById('store-dropdown');
            if (!dropdown) return;
            
            const html = UK_STORES_RESTAURANTS.map(store => {
                const typeLabel = store.type === 'fastfood' ? 'ðŸ”' : store.type === 'supermarket' ? 'ðŸ›’' : '';
                return `<div onclick="selectStore('${store.value}', '${store.name}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                    <span>${typeLabel}</span>
                    <span class="font-medium text-sm flex-1">${store.name}</span>
                </div>`;
            }).join('');
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function filterStoreDropdown(query) {
            const dropdown = document.getElementById('store-dropdown');
            if (!dropdown) return;
            
            const filtered = UK_STORES_RESTAURANTS.filter(store => 
                store.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>';
            } else {
                const html = filtered.map(store => {
                    const typeLabel = store.type === 'fastfood' ? 'ðŸ”' : store.type === 'supermarket' ? 'ðŸ›’' : '';
                    return `<div onclick="selectStore('${store.value}', '${store.name}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                        <span>${typeLabel}</span>
                        <span class="font-medium text-sm flex-1">${store.name}</span>
                    </div>`;
                }).join('');
                dropdown.innerHTML = html;
            }
            
            dropdown.classList.remove('hidden');
        }

        function selectStore(value, name) {
            document.getElementById('store-search-input').value = name;
            document.getElementById('store-select').value = value;
            document.getElementById('store-dropdown').classList.add('hidden');
            showToast(`Filter: ${name}`);
        }

        function openFoodPopup(idx) {
            currentFoodItem = searchResults[idx];
            document.getElementById('popup-image').src = currentFoodItem.image;
            document.getElementById('popup-name').innerText = currentFoodItem.name;
            document.getElementById('popup-nutrition').innerText = `Per ${currentFoodItem.serving}`;
            
            document.getElementById('popup-nutrition-cals').innerText = currentFoodItem.calories;
            document.getElementById('popup-nutrition-protein').innerText = currentFoodItem.protein;
            document.getElementById('popup-nutrition-carbs').innerText = (currentFoodItem.carbs || 0) + 'g';
            document.getElementById('popup-nutrition-fat').innerText = (currentFoodItem.fat || 0) + 'g';
            document.getElementById('popup-nutrition-fiber').innerText = (currentFoodItem.fiber || 0) + 'g';
            
            document.getElementById('popup-amount').value = 1;
            currentAmountType = 'portion';
            updateFoodPopup();
            document.getElementById('food-popup').style.display = 'flex';
            lucide.createIcons();
        }

        function closeFoodPopup() {
            document.getElementById('food-popup').style.display = 'none';
        }

        function setAmountType(type) {
            currentAmountType = type;
            document.getElementById('amount-type-portion').className = `flex-1 py-3 rounded-xl text-xs font-black uppercase ${type === 'portion' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
            document.getElementById('amount-type-grams').className = `flex-1 py-3 rounded-xl text-xs font-black uppercase ${type === 'grams' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
            updateFoodPopup();
        }

        document.getElementById('popup-amount')?.addEventListener('input', updateFoodPopup);

        function updateFoodPopup() {
            if (!currentFoodItem) return;
            const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
            const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
            
            const totalCals = Math.round(currentFoodItem.calories * multiplier);
            const totalProtein = (currentFoodItem.protein * multiplier).toFixed(1);
            
            document.getElementById('popup-total-kcal').innerText = totalCals;
            document.getElementById('popup-total-protein').innerText = totalProtein + 'g';
        }

        function addFoodItem() {
            if (!currentFoodItem) return;
            
            const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
            const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
            const mealType = document.getElementById('popup-meal-type').value;

            if (!state.dailyMeals) state.dailyMeals = [];

            state.dailyMeals.push({
                id: Date.now(),
                date: state.viewDate,
                name: currentFoodItem.name,
                image: currentFoodItem.image,
                amount: currentAmountType === 'portion' ? `${amount} portion(s)` : `${amount}g`,
                calories: Math.round(currentFoodItem.calories * multiplier),
                protein: parseFloat((currentFoodItem.protein * multiplier).toFixed(1)),
                mealType
            });

            saveUserData();
            closeFoodPopup();
            setNutritionTab('diary');
            renderDashboard();
            showToast('Added to diary!');
        }

        function openBarcodeScanner() {
            document.getElementById('barcode-scanner-modal').style.display = 'flex';
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("barcode-reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    (code) => {
                        document.getElementById('manual-barcode').value = code;
                        lookupBarcode();
                    }
                ).catch(err => console.error('Scanner error:', err));
            }
        }

        function closeBarcodeScanner() {
            if (html5QrCode) {
                html5QrCode.stop();
                html5QrCode = null;
            }
            document.getElementById('barcode-scanner-modal').style.display = 'none';
        }

        async function lookupBarcode() {
            const code = document.getElementById('manual-barcode').value.trim();
            if (!code) return;

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const p = data.product;
                    searchResults = [{
                        name: p.product_name || 'Unknown',
                        image: p.image_small_url || 'https://via.placeholder.com/100',
                        calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                        protein: (p.nutriments?.proteins_100g || 0).toFixed(1),
                        carbs: (p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                        fat: (p.nutriments?.fat_100g || 0).toFixed(1),
                        fiber: (p.nutriments?.fiber_100g || 0).toFixed(1),
                        serving: p.serving_size || '100g'
                    }];
                    closeBarcodeScanner();
                    openFoodPopup(0);
                } else {
                    showToast('Product not found');
                }
            } catch (error) {
                showToast('Barcode lookup failed');
            }
        }

        // ========================================
        // METRICS
        // ========================================

        function triggerPhotoUpload(type) {
            currentPhotoType = type;
            document.getElementById('photo-upload-input').click();
        }

        document.getElementById('photo-upload-input')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                    state.currentPhotos[currentPhotoType] = compressedImage;

                    const preview = document.getElementById(`photo-${currentPhotoType}-preview`);
                    preview.src = compressedImage;
                    preview.classList.remove('hidden');

                    showToast(`${currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1)} photo added`);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function saveMetrics() {
            const weight = parseFloat(document.getElementById('metric-weight').value);
            if (!weight) {
                showToast('Please enter weight');
                return;
            }

            if (!state.metricsHistory) state.metricsHistory = [];
            
            state.metricsHistory.unshift({
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                weight,
                chest: parseFloat(document.getElementById('metric-chest').value) || 0,
                shoulders: parseFloat(document.getElementById('metric-shoulders').value) || 0,
                arms: parseFloat(document.getElementById('metric-arms').value) || 0,
                waist: parseFloat(document.getElementById('metric-waist').value) || 0,
                legs: parseFloat(document.getElementById('metric-legs').value) || 0,
                glutes: parseFloat(document.getElementById('metric-glutes').value) || 0,
                photos: {
                    front: state.currentPhotos.front,
                    side: state.currentPhotos.side,
                    back: state.currentPhotos.back
                }
            });

            saveUserData();
            renderDashboard();
            showToast('Metrics saved!');
            
            ['weight', 'chest', 'shoulders', 'arms', 'waist', 'legs', 'glutes'].forEach(m => {
                document.getElementById(`metric-${m}`).value = '';
            });
            
            state.currentPhotos = { front: null, side: null, back: null };
            ['front', 'side', 'back'].forEach(type => {
                document.getElementById(`photo-${type}-preview`).classList.add('hidden');
            });
        }

        // ========================================
        // SETTINGS
        // ========================================

        function updateCalorieGoal(value) {
            state.goals.calories = Number(value);
            saveUserData();
            renderDashboard();
            showToast('Goal updated');
        }

        function renderSettings() {
            document.getElementById('calorie-goal-input').value = state.goals.calories;

            const gymHtml = Object.keys(state.equipment.gym).map(eq => `
                <button onclick="toggleEquipment('gym', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase ${state.equipment.gym[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}">
                    ${eq}
                </button>
            `).join('');
            document.getElementById('gym-equipment-list').innerHTML = gymHtml;

            const homeHtml = Object.keys(state.equipment.home).map(eq => `
                <button onclick="toggleEquipment('home', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase ${state.equipment.home[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}">
                    ${eq}
                </button>
            `).join('');
            document.getElementById('home-equipment-list').innerHTML = homeHtml;
        }

        function toggleEquipment(env, equipment) {
            state.equipment[env][equipment] = !state.equipment[env][equipment];
            saveUserData();
            renderSettings();
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        document.addEventListener('click', function(e) {
            if (!e.target.matches('#store-search-input') && !e.target.closest('#store-dropdown')) {
                const storeDropdown = document.getElementById('store-dropdown');
                if (storeDropdown) storeDropdown.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
