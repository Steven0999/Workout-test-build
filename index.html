<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FitTrack Pro - Complete fitness tracking app with cloud sync">
    <meta name="theme-color" content="#4f46e5">
    <title>FitTrack Pro - Your Complete Fitness Companion</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí™</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #f43f5e;
            --bg-main: #f8fafc;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .photo-slot {
            aspect-ratio: 3/4;
            background: #f1f5f9;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            border: 2px dashed #e2e8f0;
            position: relative;
            transition: all 0.2s;
            min-height: 120px;
        }
        
        .photo-slot:hover { border-color: var(--brand-primary); transform: scale(1.02); }
        .photo-slot:active { transform: scale(0.98); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-overlay > div {
            width: 100%;
            max-width: 32rem;
            margin: auto;
        }

        .store-dropdown { animation: dropdownPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropdownPop {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            word-wrap: break-word;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        button { 
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.97); }

        input, select {
            min-height: 48px;
            font-size: 16px;
        }

        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .translate-x-0 { transform: translateX(0); }
        .-translate-x-full { transform: translateX(-100%); }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin { animation: spin 1s linear infinite; }

        /* Auth screens */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #app-screen { display: none; }

        .input-group { position: relative; }
        .input-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }
        .input-group input { padding-left: 3rem; }

        /* Cloud sync indicator */
        .sync-indicator {
            position: fixed;
            top: 70px;
            right: 16px;
            background: #1e293b;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            z-index: 300;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .sync-indicator.show { opacity: 1; transform: translateY(0); }

        @media (max-width: 640px) {
            main { padding: 0.75rem !important; }
            .space-y-6 > * + * { margin-top: 1rem !important; }
            .glass-card { padding: 1rem !important; }

            .text-5xl { font-size: 2.25rem !important; line-height: 1.2; }
            .text-4xl { font-size: 1.875rem !important; line-height: 1.2; }
            .text-3xl { font-size: 1.5rem !important; line-height: 1.3; }
            .text-2xl { font-size: 1.25rem !important; }
            .text-xl { font-size: 1.125rem !important; }

            .modal-overlay > div {
                border-radius: 1.5rem !important;
                padding: 1.25rem !important;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
            
            button { min-height: 48px !important; }
            input, select { min-height: 52px !important; font-size: 16px !important; }
        }

        .muscle-chip.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .flex-1 { flex: 1 1 0%; min-width: 0; }

        header { padding: 1rem 1.25rem; }
        @media (max-width: 640px) { header { padding: 0.875rem 1rem; } }

        /* Save diary modal special styles */
        .save-diary-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .save-diary-stat-row:last-child { border-bottom: none; }

        /* Nutrition log entry styles */
        .nutrition-log-card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.25rem;
            border: 1px solid #f1f5f9;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }
        .nutrition-log-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* Calorie ring animation */
        @keyframes ringFill {
            from { stroke-dashoffset: 534; }
            to { stroke-dashoffset: var(--target-offset); }
        }

        /* Macro bar styles */
        .macro-bar {
            height: 6px;
            border-radius: 3px;
            background: #f1f5f9;
            overflow: hidden;
            margin-top: 4px;
        }
        .macro-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Water wave animation */
        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Step counter pulse */
        @keyframes stepPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Workout card hover */
        .exercise-card-hover {
            transition: all 0.2s ease;
        }
        .exercise-card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.12);
        }

        /* PR badge pulse */
        @keyframes prBadgePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pr-badge { animation: prBadgePulse 2s infinite; }

        /* Food search result hover */
        .food-result-card {
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .food-result-card:hover {
            background: #f8fafc;
            transform: translateX(4px);
        }

        /* Metrics grid */
        .metrics-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Log entry animation */
        @keyframes logSlideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .log-entry { animation: logSlideIn 0.3s ease; }

        /* Settings toggle */
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }

        /* Goal chip colours */
        .goal-short { background: #dcfce7; color: #166534; }
        .goal-medium { background: #fef9c3; color: #854d0e; }
        .goal-long { background: #f3e8ff; color: #6b21a8; }

        /* Habit completion animation */
        @keyframes habitCheck {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .habit-checked { animation: habitCheck 0.3s ease; }

        /* Chart container */
        .chart-wrapper {
            position: relative;
            height: 300px;
            background: #f8fafc;
            border-radius: 1.5rem;
            padding: 1rem;
        }

        /* Comparison photo */
        .comparison-photo {
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
            aspect-ratio: 3/4;
            background: #f1f5f9;
        }

        /* Delete account danger styling */
        .danger-zone {
            border: 2px dashed #fecaca;
            border-radius: 1.5rem;
            padding: 1.5rem;
            background: #fff5f5;
        }

        /* Barcode scanner */
        #barcode-reader video {
            border-radius: 1rem;
            width: 100% !important;
        }
        #barcode-reader canvas {
            border-radius: 1rem;
        }

        /* Exercise dropdown */
        .exercise-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            transition: background 0.1s;
        }
        .exercise-dropdown-item:hover { background: #eef2ff; }
        .exercise-dropdown-item:last-child { border-bottom: none; }

        /* Meal type selector tabs */
        .meal-type-tab {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Amount input stepper */
        .amount-stepper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .amount-stepper button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Workout timer display */
        .workout-timer-display {
            font-size: 1.5rem;
            font-weight: 900;
            color: #4f46e5;
            font-variant-numeric: tabular-nums;
        }

        /* Photo upload overlay */
        .photo-upload-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: inherit;
        }
        .photo-slot:hover .photo-upload-overlay { opacity: 1; }

        /* Sidebar nav active state */
        .sidebar-nav-active {
            background: #eef2ff;
            color: #4f46e5;
        }

        /* Profile stats card */
        .profile-stat {
            background: #f8fafc;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
        }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading skeleton */
        @keyframes skeleton {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
            border-radius: 0.5rem;
        }

        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4);
            z-index: 50;
            cursor: pointer;
            transition: all 0.2s;
        }
        .fab:hover { transform: scale(1.1); box-shadow: 0 12px 32px rgba(79, 70, 229, 0.5); }
        .fab:active { transform: scale(0.95); }

        /* Weekly bar chart */
        .weekly-bar {
            flex: 1;
            background: #f1f5f9;
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 4px;
            transition: height 0.5s ease;
        }
        .weekly-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #4f46e5;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }

        /* Streak indicator */
        .streak-fire {
            display: inline-block;
            animation: flickerFire 0.5s infinite alternate;
        }
        @keyframes flickerFire {
            from { transform: scale(1) rotate(-2deg); }
            to { transform: scale(1.1) rotate(2deg); }
        }

        /* Hydration wave */
        .hydration-visual {
            position: relative;
            overflow: hidden;
            height: 60px;
            border-radius: 1rem;
            background: #e0f2fe;
        }
        .hydration-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #7dd3fc, #0284c7);
            transition: height 0.5s ease;
        }

        /* Cardio activity icon badges */
        .activity-badge-running { background: #fef2f2; color: #ef4444; }
        .activity-badge-cycling { background: #fffbeb; color: #f59e0b; }
        .activity-badge-swimming { background: #ecfeff; color: #06b6d4; }
        .activity-badge-walking { background: #f0fdf4; color: #22c55e; }
        .activity-badge-hiking { background: #faf5ff; color: #a855f7; }
        .activity-badge-rowing { background: #fff7ed; color: #f97316; }

        /* Nutrition macro doughnut */
        .macro-legend {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .macro-legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .macro-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Equipment toggle chip */
        .equipment-chip {
            padding: 0.625rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.625rem;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        /* Form validation states */
        .input-error { border-color: #ef4444 !important; background: #fff5f5 !important; }
        .input-success { border-color: #22c55e !important; background: #f0fdf4 !important; }

        /* Swipe hint */
        @keyframes swipeHint {
            0%, 100% { transform: translateX(0); opacity: 0.6; }
            50% { transform: translateX(8px); opacity: 1; }
        }

        /* Tag cloud for muscles */
        .muscle-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            background: #eef2ff;
            color: #4f46e5;
            margin: 0.2rem;
        }

        /* Step progress dots */
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s;
        }
        .step-dot.active {
            background: #4f46e5;
            transform: scale(1.3);
        }

        /* Date nav pill */
        .date-nav-pill {
            background: #f8fafc;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        /* Intensity selector */
        .intensity-btn {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.625rem;
            font-weight: 800;
            text-transform: uppercase;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #64748b;
        }
        .intensity-btn.selected { background: #4f46e5; color: white; }

        /* Ripple effect */
        @keyframes ripple {
            from { transform: scale(0); opacity: 0.6; }
            to { transform: scale(4); opacity: 0; }
        }
        .ripple-container {
            position: relative;
            overflow: hidden;
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        /* Fullscreen photo view */
        .photo-fullscreen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        .photo-fullscreen img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Milestone badge */
        .milestone-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #78350f;
        }

        /* Quick add buttons */
        .quick-add-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            background: #eef2ff;
            color: #4f46e5;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 36px;
        }
        .quick-add-btn:hover { background: #4f46e5; color: white; }

        /* Save diary button animation */
        @keyframes savePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(5, 150, 105, 0); }
        }
        .save-diary-btn-pulse {
            animation: savePulse 2s infinite;
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>
    <div id="sync-indicator" class="sync-indicator">‚òÅÔ∏è Saving...</div>

    <!-- ========================================== -->
    <!-- AUTH SCREEN                                -->
    <!-- ========================================== -->
    <div id="auth-screen">
        <div class="w-full max-w-md px-4">
            <div class="bg-white rounded-[3rem] p-8 shadow-2xl">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üí™</div>
                    <h1 class="text-3xl font-black text-indigo-600 mb-2">FitTrack<span class="text-slate-600">Pro</span></h1>
                    <p class="text-slate-500 text-sm">Your complete fitness companion</p>
                </div>

                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="login-password" placeholder="Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="loginUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Sign In
                        </button>
                        <button onclick="showForgotPassword()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Forgot Password?
                        </button>
                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Don't have an account?</p>
                            <button onclick="showRegister()" class="text-indigo-600 font-bold hover:text-indigo-700">Create Account</button>
                        </div>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <input type="text" id="register-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="register-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-password" placeholder="Password (min 6 characters)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-confirm" placeholder="Confirm Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="registerUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Create Account
                        </button>
                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Already have an account?</p>
                            <button onclick="showLogin()" class="text-indigo-600 font-bold hover:text-indigo-700">Sign In</button>
                        </div>
                    </div>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgot-password-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Reset Password</h2>
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600 text-center mb-4">Enter your email and we'll send you a reset link</p>
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="forgot-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="resetPassword()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Send Reset Link
                        </button>
                        <button onclick="showLogin()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Back to Login
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-center text-white text-xs mt-6 opacity-75">
                By continuing, you agree to our Terms of Service and Privacy Policy
            </p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MAIN APP SCREEN                            -->
    <!-- ========================================== -->
    <div id="app-screen">

        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-4 sm:px-6 py-4 sm:py-5 sticky top-0 z-40 flex justify-between items-center">
            <button onclick="toggleSidebar()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Menu">
                <i data-lucide="menu" class="w-6 h-6 text-slate-700"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">FitTrack<span class="text-slate-600">Pro</span></h1>
                <div class="flex items-center gap-2 justify-center">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p id="status-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Loading...</p>
                </div>
            </div>
            <button onclick="switchTab('profile')" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Profile">
                <i data-lucide="user" class="w-6 h-6 text-slate-700"></i>
            </button>
        </header>

        <main class="max-w-xl mx-auto p-4 sm:p-6 space-y-6">

            <!-- ============================== -->
            <!-- DASHBOARD TAB                  -->
            <!-- ============================== -->
            <section id="dashboard" class="tab-content active space-y-6">
                <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center relative overflow-hidden">
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 192 192">
                            <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                            <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                        </svg>
                        <div class="absolute text-center">
                            <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Eaten</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                        <div class="text-center"><div id="dash-protein" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Protein</div></div>
                        <div class="text-center border-x"><div id="dash-carbs" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Carbs</div></div>
                        <div class="text-center"><div id="dash-fat" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Fats</div></div>
                    </div>
                </div>

                <!-- Macro Progress Bars -->
                <div class="glass-card rounded-[2rem] p-5">
                    <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4">Macro Breakdown</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-xs font-bold text-blue-600">Protein</span>
                                <span id="dash-protein-pct" class="text-xs text-slate-400">0%</span>
                            </div>
                            <div class="macro-bar"><div id="dash-protein-bar" class="macro-bar-fill bg-blue-500" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-xs font-bold text-amber-600">Carbs</span>
                                <span id="dash-carbs-pct" class="text-xs text-slate-400">0%</span>
                            </div>
                            <div class="macro-bar"><div id="dash-carbs-bar" class="macro-bar-fill bg-amber-400" style="width:0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-xs font-bold text-rose-600">Fats</span>
                                <span id="dash-fat-pct" class="text-xs text-slate-400">0%</span>
                            </div>
                            <div class="macro-bar"><div id="dash-fat-bar" class="macro-bar-fill bg-rose-400" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Hydration Tracker -->
                <div id="hydration-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="droplet" class="text-cyan-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Hydration Goal</h4>
                                <p id="water-count" class="text-xs text-slate-500">0 / 2.5L</p>
                            </div>
                        </div>
                        <button onclick="toggleHydrationGoal()" id="hydration-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <!-- Quick water add buttons -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="addWater(250)" class="quick-add-btn">+250ml</button>
                        <button onclick="addWater(500)" class="quick-add-btn">+500ml</button>
                        <button onclick="addWater(750)" class="quick-add-btn">+750ml</button>
                        <button onclick="addWater(-250)" class="quick-add-btn text-red-500 bg-red-50 hover:bg-red-500 hover:text-white">-250ml</button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click ‚úì when you reach your daily goal</div>
                </div>

                <!-- Steps Tracker -->
                <div id="steps-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="footprints" class="text-amber-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Steps Goal</h4>
                                <p id="steps-count" class="text-xs text-slate-500">0 / 10,000</p>
                            </div>
                        </div>
                        <button onclick="toggleStepsGoal()" id="steps-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <!-- Quick steps add buttons -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="addSteps(1000)" class="quick-add-btn">+1k</button>
                        <button onclick="addSteps(2500)" class="quick-add-btn">+2.5k</button>
                        <button onclick="addSteps(5000)" class="quick-add-btn">+5k</button>
                        <button onclick="addSteps(-1000)" class="quick-add-btn text-red-500 bg-red-50 hover:bg-red-500 hover:text-white">-1k</button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click ‚úì when you reach your daily goal</div>
                </div>

                <!-- Habits Tracker -->
                <div id="habits-tracker" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="check-circle" class="text-purple-500"></i>
                            </div>
                            <h3 class="font-bold text-lg">Daily Habits</h3>
                        </div>
                        <div id="habit-completion-badge" class="text-xs font-black text-purple-600 bg-purple-50 px-3 py-1 rounded-full">0/0</div>
                    </div>
                    <div id="dashboard-habits-list" class="space-y-3"></div>
                </div>

                <!-- Weekly Overview -->
                <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-xl">
                    <h3 class="text-lg font-bold mb-1">Weekly Overview</h3>
                    <div id="muscle-volume-stats" class="grid grid-cols-2 gap-y-3 gap-x-6 mb-6"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="switchTab('training')" class="bg-indigo-600 px-4 py-3 rounded-2xl font-bold text-xs uppercase hover:bg-indigo-700">Log Workout</button>
                        <button onclick="switchTab('nutrition')" class="bg-emerald-600 px-4 py-3 rounded-2xl font-bold text-xs uppercase hover:bg-emerald-700">Add Food</button>
                    </div>
                </div>

                <!-- Today's Summary Card -->
                <div class="glass-card rounded-[2rem] p-6">
                    <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4">Today at a Glance</h3>
                    <div id="today-summary" class="space-y-3"></div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- PROFILE TAB                    -->
            <!-- ============================== -->
            <section id="profile" class="tab-content space-y-6">
                <div class="glass-card p-8 rounded-[3rem] text-center">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="user" class="w-12 h-12 text-indigo-600"></i>
                    </div>
                    <h2 id="profile-name" class="text-2xl font-black mb-2">User Name</h2>
                    <p id="profile-email" class="text-sm text-slate-500 mb-6">user@example.com</p>

                    <div class="space-y-3">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Member Since</p>
                            <p id="profile-created" class="font-bold">Loading...</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Total Workouts</p>
                            <p id="profile-workouts" class="font-bold">0</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Nutrition Logs Saved</p>
                            <p id="profile-nutrition-logs" class="font-bold">0</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Account Status</p>
                            <p class="font-bold text-emerald-600">‚úì Active (Cloud Sync)</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Last Cloud Sync</p>
                            <p id="profile-last-sync" class="font-bold text-indigo-600 text-sm">Not yet synced</p>
                        </div>
                    </div>

                    <button onclick="syncToCloud()" class="w-full mt-4 bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">
                        ‚òÅÔ∏è Sync to Cloud
                    </button>

                    <button onclick="logoutUser()" class="w-full mt-3 bg-red-500 text-white p-4 rounded-2xl font-bold hover:bg-red-600">
                        Sign Out
                    </button>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">App Settings</h3>
                    <button onclick="switchTab('settings')" class="w-full bg-slate-100 p-4 rounded-xl font-medium text-left flex items-center justify-between">
                        <span>Preferences & Goals</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- TRAINING TAB                   -->
            <!-- ============================== -->
            <section id="training" class="tab-content space-y-6">
                <!-- Date Selector -->
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeWorkoutDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="workout-date-picker" onchange="selectWorkoutDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeWorkoutDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="workout-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Finish Workout" to confirm</p>
                    </div>
                </div>

                <!-- Workout Setup -->
                <div id="workout-setup" class="glass-card p-6 rounded-[2.5rem] space-y-4">
                    <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                        <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Gym</button>
                        <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-slate-400">Home</button>
                    </div>
                    
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Exercise Focus</label>
                        <select id="workout-focus" onchange="toggleSpecificMuscle()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Full Body</option>
                            <option>Upper</option>
                            <option>Lower</option>
                            <option>Push</option>
                            <option>Pull</option>
                            <option>Legs</option>
                            <option>Specific Muscle</option>
                        </select>
                    </div>

                    <div id="specific-muscle-container" class="hidden">
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Muscle</label>
                        <select id="specific-muscle" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Chest</option>
                            <option>Back</option>
                            <option>Shoulders</option>
                            <option>Biceps</option>
                            <option>Triceps</option>
                            <option>Quads</option>
                            <option>Hamstrings</option>
                            <option>Glutes</option>
                            <option>Calves</option>
                        </select>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Cardio</span>
                            <input type="checkbox" id="add-cardio-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Core</span>
                            <input type="checkbox" id="add-core-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="startWorkout('manual')" class="p-5 bg-slate-900 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-slate-800 active:bg-slate-700">Manual Entry</button>
                        <button onclick="startWorkout('ai')" class="p-5 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-indigo-700 active:bg-indigo-800">AI Generate</button>
                    </div>
                    
                    <button onclick="openCardioModal()" class="w-full mt-3 p-5 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-[1.5rem] font-bold text-base flex items-center justify-center gap-2 hover:from-cyan-600 hover:to-blue-600">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                        Log Outdoor Cardio
                    </button>
                </div>

                <!-- Active Workout -->
                <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div>
                            <h3 id="active-workout-title" class="text-xl font-black">Workout</h3>
                            <p id="workout-timer" class="text-indigo-600 font-bold workout-timer-display">00:00:00</p>
                        </div>
                        <button onclick="cancelWorkout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl text-xl font-bold">√ó</button>
                    </div>
                    <div id="exercise-list" class="space-y-4 mb-6"></div>
                    <button onclick="addExercise()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs mb-4 hover:border-indigo-400 hover:text-indigo-500">+ Add Exercise</button>
                    <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold hover:bg-slate-800">Finish Workout</button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- NUTRITION TAB                  -->
            <!-- ============================== -->
            <section id="nutrition" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setNutritionTab('diary')" id="nut-tab-diary" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Diary</button>
                    <button onclick="setNutritionTab('search')" id="nut-tab-search" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Search</button>
                </div>

                <!-- DIARY VIEW -->
                <div id="nut-view-diary" class="space-y-6">
                    <!-- Date navigator -->
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex items-center justify-between gap-3">
                            <button onclick="changeNutritionDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <div class="flex-1">
                                <input type="date" id="nutrition-date-picker" onchange="selectNutritionDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                            </div>
                            <button onclick="changeNutritionDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="nutrition-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                            <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Save Changes" to confirm</p>
                        </div>
                    </div>

                    <!-- Past-date save/cancel bar -->
                    <div id="nutrition-save-buttons" class="hidden flex gap-3">
                        <button onclick="saveNutritionChanges()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700">Save Changes</button>
                        <button onclick="cancelNutritionChanges()" class="flex-1 py-4 bg-slate-200 text-slate-700 rounded-2xl font-bold hover:bg-slate-300">Cancel</button>
                    </div>

                    <!-- Calorie summary -->
                    <div class="bg-white rounded-[32px] p-8 border border-slate-100 shadow-xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <div id="total-kcal" class="text-5xl font-black text-slate-900 mb-1">0</div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Calories Today</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black text-blue-600 flex items-center gap-1 justify-end">
                                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i> <span id="total-protein">0.0</span>g
                                </div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Protein</div>
                            </div>
                        </div>
                        <!-- Goal progress bar -->
                        <div class="mt-4">
                            <div class="flex justify-between mb-1">
                                <span class="text-[10px] text-slate-400 font-bold">Goal</span>
                                <span id="diary-goal-remaining" class="text-[10px] text-slate-400 font-bold">2500 remaining</span>
                            </div>
                            <div class="macro-bar" style="height:8px;"><div id="diary-calorie-bar" class="macro-bar-fill bg-indigo-500" style="width:0%"></div></div>
                        </div>
                    </div>

                    <!-- Meal sections -->
                    <div id="meal-sections"></div>

                    <!-- Cloud sync info + SAVE DIARY BUTTON -->
                    <div class="text-center py-4 px-6 bg-indigo-50 rounded-2xl border border-indigo-100 mt-6">
                        <div class="flex items-center justify-center gap-2 mb-1">
                            <i data-lucide="cloud" class="w-4 h-4 text-indigo-600"></i>
                            <p class="text-sm font-bold text-indigo-900">Cloud Sync Enabled</p>
                        </div>
                        <p class="text-xs text-indigo-600">Your meals are saved to your account in real-time</p>
                    </div>

                    <!-- *** SAVE DIARY BUTTON *** -->
                    <button onclick="openSaveDiaryModal()" class="w-full save-diary-btn-pulse bg-emerald-700 text-white p-4 rounded-2xl font-bold hover:bg-emerald-800 flex items-center justify-center gap-2 shadow-lg">
                        üíæ Save Diary to Log
                    </button>
                </div>

                <!-- SEARCH VIEW -->
                <div id="nut-view-search" class="hidden space-y-6">
                    <div>
                        <label class="text-xs font-semibold text-slate-400 ml-1 mb-2 block">Store / Restaurant</label>
                        <div class="relative">
                            <input 
                                id="store-search-input" 
                                type="text" 
                                placeholder="Search stores or restaurants..." 
                                class="w-full p-4 bg-white rounded-3xl border border-slate-100 font-medium outline-none"
                                onfocus="showStoreDropdown()"
                                oninput="filterStoreDropdown(this.value)"
                                autocomplete="off">
                            <div id="store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto store-dropdown"></div>
                        </div>
                        <input type="hidden" id="store-select" value="all">
                    </div>

                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                            <input id="food-search-input" type="text" placeholder="Search food..." 
                                class="w-full bg-slate-100 border-2 border-transparent rounded-[20px] py-4 pl-12 pr-4 focus:bg-white focus:border-emerald-500 outline-none font-semibold">
                        </div>
                        <button onclick="openBarcodeScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:bg-indigo-700">
                            <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <button onclick="openCreateMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700">
                        Create Meal
                    </button>

                    <div id="created-meals-list" class="space-y-3"></div>

                    <div id="search-loading" class="hidden py-20 text-center">
                        <i data-lucide="loader-2" class="animate-spin text-emerald-500 mx-auto w-8 h-8"></i>
                    </div>
                    <div id="search-results-list" class="space-y-3"></div>
                    
                    <div class="text-center py-4">
                        <p class="text-xs text-slate-400 mb-3">Can't find what you're looking for?</p>
                        <button onclick="openManualFoodEntry()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-slate-800 transition-all">
                            + Add Food Manually
                        </button>
                    </div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- LOGS TAB                       -->
            <!-- ============================== -->
            <section id="logs" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setLogsTab('training')" id="logs-tab-training" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Training</button>
                    <button onclick="setLogsTab('nutrition')" id="logs-tab-nutrition" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Nutrition</button>
                </div>
                
                <div id="logs-training-view" class="space-y-4">
                    <div class="glass-card p-4 rounded-2xl">
                        <p class="text-xs font-black uppercase text-slate-400 mb-3">Filter Workouts</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-weights" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üí™ Weights</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-cardio" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üèÉ Cardio</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-core" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üéØ Core</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-walking" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üö∂ Walking</span>
                            </label>
                        </div>
                    </div>
                    <div id="training-logs-list"></div>
                </div>

                <div id="logs-nutrition-view" class="hidden space-y-4">
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                            <i data-lucide="droplet" class="w-5 h-5 text-cyan-500"></i>
                            Hydration History
                        </h3>
                        <div id="hydration-logs-list" class="space-y-2"></div>
                    </div>
                    <div id="nutrition-logs-list"></div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- METRICS TAB                    -->
            <!-- ============================== -->
            <section id="metrics" class="tab-content space-y-6">
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeMetricsDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="metrics-date-picker" onchange="selectMetricsDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeMetricsDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="metrics-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Recording for past date - Click "Save Metrics" to confirm</p>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-[3rem] space-y-8">
                    <div class="bg-slate-50 p-6 rounded-3xl text-center border">
                        <span class="text-[10px] font-black uppercase text-slate-400 block mb-2">Weight (kg)</span>
                        <input id="metric-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-transparent text-center text-5xl font-black outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Chest (cm)</label>
                            <input id="metric-chest" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Shoulders (cm)</label>
                            <input id="metric-shoulders" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Arms (cm)</label>
                            <input id="metric-arms" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Waist (cm)</label>
                            <input id="metric-waist" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Legs (cm)</label>
                            <input id="metric-legs" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Glutes (cm)</label>
                            <input id="metric-glutes" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 text-center">Progress Photos</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="photo-slot" onclick="triggerPhotoUpload('front')">
                                <img id="photo-front-preview" class="hidden" alt="Front">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Front</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('side')">
                                <img id="photo-side-preview" class="hidden" alt="Side">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Side</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('back')">
                                <img id="photo-back-preview" class="hidden" alt="Back">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Back</span>
                            </div>
                        </div>
                        <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                    </div>

                    <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase hover:bg-rose-600">
                        Save Metrics
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openMetricsChart()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                        <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="line-chart" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">Progress Charts</h4>
                        <p class="text-xs text-slate-400">View trends</p>
                    </button>
                    <button onclick="openPhotoComparison()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                        <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="images" class="w-6 h-6 text-emerald-600"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">Compare Photos</h4>
                        <p class="text-xs text-slate-400">Side by side</p>
                    </button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- SETTINGS TAB                   -->
            <!-- ============================== -->
            <section id="settings" class="tab-content space-y-6">
                <div class="glass-card p-6 rounded-[2.5rem] space-y-8">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Calorie Goal</label>
                        <input id="calorie-goal-input" type="number" value="2500" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none" onchange="updateCalorieGoal(this.value)">
                    </div>

                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Protein Goal (g)</label>
                        <input id="protein-goal-input" type="number" value="150" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none">
                    </div>

                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Water Goal (ml)</label>
                        <input id="water-goal-input" type="number" value="2500" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none">
                    </div>

                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Steps Goal</label>
                        <input id="steps-goal-input" type="number" value="10000" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none">
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Gym Equipment</h3>
                        <div id="gym-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Home Equipment</h3>
                        <div id="home-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[11px] font-black uppercase text-slate-400">Daily Habits</h3>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="habits-enabled" onchange="toggleHabits()" class="w-5 h-5 accent-indigo-600">
                                <span class="text-xs font-bold text-slate-600">Enable</span>
                            </label>
                        </div>
                        <div id="habits-section" class="hidden space-y-3">
                            <div class="flex gap-2">
                                <input id="new-habit-input" type="text" placeholder="Add a new habit..." class="flex-1 p-3 bg-slate-50 rounded-xl outline-none">
                                <button onclick="addHabit()" class="px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Add</button>
                            </div>
                            <div id="habits-list" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-6">
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Tracking Options</h3>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Track Hydration</p>
                                    <p class="text-xs text-slate-500">Log daily water intake</p>
                                </div>
                                <input type="checkbox" id="track-hydration" onchange="toggleTracking('hydration')" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Track Steps</p>
                                    <p class="text-xs text-slate-500">Count daily steps</p>
                                </div>
                                <input type="checkbox" id="track-steps" onchange="toggleTracking('steps')" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Auto-save Diary at Midnight</p>
                                    <p class="text-xs text-slate-500">Automatically archive diary each night</p>
                                </div>
                                <input type="checkbox" id="auto-save-midnight" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[11px] font-black uppercase text-slate-400">Goals</h3>
                            <button onclick="openGoalSetting()" class="text-xs font-bold text-indigo-600 hover:text-indigo-700">+ Add Goal</button>
                        </div>
                        <div id="goals-list" class="space-y-2"></div>
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">
                        Save Settings
                    </button>

                    <!-- DANGER ZONE -->
                    <div class="border-t-2 border-red-100 pt-6 mt-4">
                        <h3 class="text-[11px] font-black uppercase text-red-400 mb-2">Danger Zone</h3>
                        <p class="text-xs text-slate-500 mb-4">Permanently deletes your account and all associated data. This cannot be undone.</p>
                        <button onclick="openDeleteAccountModal()" class="w-full bg-red-50 text-red-600 border-2 border-red-200 p-4 rounded-2xl font-bold hover:bg-red-100 hover:border-red-400 transition-all">
                            üóëÔ∏è Delete My Account
                        </button>
                    </div>
                </div>
            </section>

        </main>

        <!-- ========================================== -->
        <!-- SIDEBAR                                    -->
        <!-- ========================================== -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100]" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-80 bg-white shadow-2xl z-[101] transform -translate-x-full">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-black text-indigo-600">Menu</h2>
                    <button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav class="space-y-2">
                    <button onclick="switchTab('dashboard'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Dashboard</span>
                    </button>
                    <button onclick="switchTab('training'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="dumbbell" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Training</span>
                    </button>
                    <button onclick="switchTab('nutrition'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="apple" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Nutrition</span>
                    </button>
                    <button onclick="switchTab('logs'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="clipboard-list" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Logs</span>
                    </button>
                    <button onclick="switchTab('metrics'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Metrics</span>
                    </button>
                    <button onclick="switchTab('profile'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="user" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Profile</span>
                    </button>
                    <button onclick="switchTab('settings'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Settings</span>
                    </button>
                </nav>

                <div class="mt-8 p-4 bg-slate-50 rounded-2xl">
                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Signed in as</p>
                    <p id="sidebar-user-email" class="text-sm font-bold text-slate-700 truncate">Loading...</p>
                    <button onclick="logoutUser(); toggleSidebar();" class="w-full mt-3 text-xs text-red-500 font-bold hover:text-red-600">Sign Out</button>
                </div>
            </div>
        </div>

    </div><!-- END APP SCREEN -->

    <!-- ========================================== -->
    <!-- MODALS                                     -->
    <!-- ========================================== -->

    <!-- DELETE ACCOUNT MODAL -->
    <div id="delete-account-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                </div>
                <h3 class="text-2xl font-black text-red-600 mb-2">Delete Account</h3>
                <p class="text-sm text-slate-600">This will <strong>permanently delete</strong> your account and all your fitness data. This action <strong>cannot be undone</strong>.</p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-2xl p-4 mb-6">
                <p class="text-xs text-red-700 font-bold text-center">‚ö†Ô∏è All your data will be permanently erased</p>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Confirm your password to proceed</label>
                <div class="input-group">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                    <input type="password" id="delete-account-password" placeholder="Enter your current password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-red-500 font-medium">
                </div>
            </div>
            <button onclick="confirmDeleteAccount()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black hover:bg-red-700 mb-3 transition-all">
                Permanently Delete My Account
            </button>
            <button onclick="closeDeleteAccountModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel ‚Äî Keep My Account
            </button>
        </div>
    </div>

    <!-- *** SAVE DIARY MODAL *** -->
    <div id="save-diary-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8">
            <div class="text-center mb-6">
                <div class="text-5xl mb-3">üìã</div>
                <h3 class="text-2xl font-black mb-2">Save Diary to Log</h3>
                <p class="text-sm text-slate-500 leading-relaxed">Archive your diary entries to your nutrition log. The diary will be cleared for a fresh start tomorrow.</p>
            </div>
            <div class="mb-5">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Record Under Which Day?</label>
                <input type="date" id="save-diary-date" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-emerald-500 text-lg">
            </div>
            <div class="bg-slate-50 p-5 rounded-2xl mb-6">
                <p class="text-[10px] text-slate-400 uppercase font-black mb-3">What will be saved</p>
                <div id="save-diary-stats" class="text-sm text-slate-700 space-y-1"></div>
            </div>
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-3 mb-5">
                <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Diary entries for this day will be cleared after saving</p>
            </div>
            <button onclick="confirmSaveDiary()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-emerald-700 mb-3 shadow-lg">
                ‚úÖ Save &amp; Clear Diary
            </button>
            <button onclick="closeSaveDiaryModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel
            </button>
        </div>
    </div>

    <!-- MANUAL FOOD ENTRY MODAL -->
    <div id="manual-food-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Add Food Manually</h3>
                <button onclick="closeManualFoodEntry()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Image (Optional)</label>
                <div class="flex items-center gap-4">
                    <div id="manual-food-preview" class="w-24 h-24 bg-slate-100 rounded-2xl flex items-center justify-center overflow-hidden">
                        <i data-lucide="image" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="manual-food-image" accept="image/*" class="hidden" onchange="previewManualFoodImage(event)">
                        <button onclick="document.getElementById('manual-food-image').click()" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100">
                            Choose Image
                        </button>
                        <button onclick="clearManualFoodImage()" class="w-full mt-2 py-2 text-xs text-slate-400 hover:text-red-600">
                            Clear Image
                        </button>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Name</label>
                <input type="text" id="manual-food-name" placeholder="e.g., Chicken Sandwich" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Store / Restaurant</label>
                <div class="relative">
                    <input 
                        id="manual-food-store-input" 
                        type="text" 
                        placeholder="Search stores or restaurants..." 
                        class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500"
                        onfocus="showManualStoreDropdown()"
                        oninput="filterManualStoreDropdown(this.value)"
                        autocomplete="off">
                    <div id="manual-store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories (kcal)</label>
                    <input type="number" id="manual-food-calories" min="0" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Protein (g)</label>
                    <input type="number" id="manual-food-protein" min="0" step="0.1" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
            </div>
            <div class="mb-6">
                <button onclick="toggleManualFoodMacros()" class="w-full text-left text-xs font-bold text-indigo-600 hover:text-indigo-700 mb-3">
                    <span id="manual-macros-toggle">+ Add More Details (Optional)</span>
                </button>
                <div id="manual-food-macros" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Carbs (g)</label>
                        <input type="number" id="manual-food-carbs" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fat (g)</label>
                        <input type="number" id="manual-food-fat" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fiber (g)</label>
                        <input type="number" id="manual-food-fiber" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Sugar (g)</label>
                        <input type="number" id="manual-food-sugar" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Serving Size</label>
                <input type="text" id="manual-food-serving" placeholder="e.g., 1 sandwich, 100g" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <button onclick="saveManualFood()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:bg-emerald-700 mb-3">
                Save to My Foods
            </button>
            <button onclick="closeManualFoodEntry()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel
            </button>
        </div>
    </div>

    <!-- GOAL SETTING MODAL -->
    <div id="goal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Set Goal</h3>
                <button onclick="closeGoalModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Type</label>
                <select id="goal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="short">Short-term (1-4 weeks)</option>
                    <option value="medium">Medium-term (1-3 months)</option>
                    <option value="long">Long-term (3+ months)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Description</label>
                <input type="text" id="goal-description" placeholder="e.g., Lose 5kg, Run 5k" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Target Date</label>
                <input type="date" id="goal-deadline" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <button onclick="saveGoal()" class="w-full bg-indigo-600 text-white py-5 rounded-[24px] font-black hover:bg-indigo-700 mb-3">
                Save Goal
            </button>
            <button onclick="closeGoalModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- CARDIO LOGGING MODAL -->
    <div id="cardio-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Log Cardio Activity</h3>
                <button onclick="closeCardioModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Activity Type</label>
                <select id="cardio-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="running">üèÉ Running</option>
                    <option value="cycling">üö¥ Cycling</option>
                    <option value="swimming">üèä Swimming</option>
                    <option value="walking">üö∂ Walking</option>
                    <option value="hiking">‚õ∞Ô∏è Hiking</option>
                    <option value="rowing">üö£ Rowing</option>
                    <option value="elliptical">‚ö° Elliptical</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Duration (min)</label>
                    <input type="number" id="cardio-duration" min="1" placeholder="30" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Distance (km)</label>
                    <input type="number" id="cardio-distance" min="0" step="0.1" placeholder="5.0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories Burned (optional)</label>
                <input type="number" id="cardio-calories" min="0" placeholder="300" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Notes (optional)</label>
                <textarea id="cardio-notes" rows="3" placeholder="How did it feel?" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none resize-none"></textarea>
            </div>
            <button onclick="saveCardio()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black hover:bg-emerald-700 mb-3">
                Save Activity
            </button>
            <button onclick="closeCardioModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- EXERCISE DEMO MODAL -->
    <div id="exercise-demo-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="demo-exercise-name" class="text-xl sm:text-2xl font-black">Exercise Demo</h3>
                <button onclick="closeExerciseDemo()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none hover:bg-slate-200">√ó</button>
            </div>
            <div class="mb-6">
                <div id="demo-video-container" class="aspect-video bg-slate-100 rounded-2xl overflow-hidden mb-4 flex items-center justify-center">
                    <iframe id="demo-video" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">How to perform</h4>
                <div id="demo-instructions" class="space-y-2 text-sm text-slate-700"></div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">Muscles targeted</h4>
                <div id="demo-muscles" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">Tips</h4>
                <div id="demo-tips" class="space-y-2 text-sm text-slate-700"></div>
            </div>
            <button onclick="closeExerciseDemo()" class="w-full bg-indigo-600 text-white py-4 rounded-[24px] font-black hover:bg-indigo-700">
                Back to Workout
            </button>
        </div>
    </div>

    <!-- FOOD ITEM POPUP -->
    <div id="food-popup" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 h-32 sm:w-40 sm:h-40 bg-slate-50 rounded-3xl overflow-hidden mb-4 p-3 shadow-lg border-2 border-slate-100">
                    <img id="popup-image" src="" class="w-full h-full object-contain" alt="Food image">
                </div>
                <h2 id="popup-name" class="text-xl sm:text-2xl font-black text-center leading-tight mb-2">Product</h2>
            </div>
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-5 rounded-3xl mb-6 shadow-sm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Calories</p>
                        <p id="popup-nutrition-cals" class="font-black text-3xl text-indigo-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">kcal</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Protein</p>
                        <p id="popup-nutrition-protein" class="font-black text-3xl text-blue-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">grams</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 pt-3 border-t border-indigo-200">
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Carbs</p>
                        <p id="popup-nutrition-carbs" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fat</p>
                        <p id="popup-nutrition-fat" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fiber</p>
                        <p id="popup-nutrition-fiber" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                </div>
                <div id="detailed-nutrition" class="hidden mt-3 pt-3 border-t border-indigo-200">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sugar</p>
                            <p id="popup-nutrition-sugar" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sat Fat</p>
                            <p id="popup-nutrition-satfat" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sodium</p>
                            <p id="popup-nutrition-sodium" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Cholest</p>
                            <p id="popup-nutrition-cholesterol" class="font-bold text-indigo-600">0mg</p>
                        </div>
                    </div>
                </div>
                <button onclick="toggleDetailedNutrition()" class="w-full mt-2 text-[10px] font-bold text-indigo-600 hover:text-indigo-700">
                    <span id="toggle-text">Show More ‚ñº</span>
                </button>
                <p id="popup-nutrition" class="text-xs text-center text-slate-500 mt-3"></p>
            </div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Meal Type</label>
                <select id="popup-meal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-base">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label>
                <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-4">
                    <button onclick="setAmountType('portion')" id="amount-type-portion" class="flex-1 py-3 rounded-xl text-xs font-black uppercase bg-white shadow text-emerald-600">Portion</button>
                    <button onclick="setAmountType('grams')" id="amount-type-grams" class="flex-1 py-3 rounded-xl text-xs font-black uppercase text-slate-400">Grams</button>
                </div>
                <input id="popup-amount" type="number" value="1" min="1" class="w-full bg-slate-50 border-4 border-slate-200 rounded-[24px] py-5 text-4xl font-black text-center outline-none focus:border-emerald-500 transition-colors">
            </div>
            <div class="bg-slate-900 text-white p-5 rounded-3xl mb-6 shadow-xl">
                <p class="text-[10px] font-black uppercase text-slate-400 text-center mb-3">Total You're Adding</p>
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <p id="popup-total-kcal" class="font-black text-3xl mb-1">0</p>
                        <p class="text-xs text-slate-400 uppercase">Calories</p>
                    </div>
                    <div class="w-px h-12 bg-slate-700"></div>
                    <div class="text-center">
                        <p id="popup-total-protein" class="font-black text-3xl text-emerald-400 mb-1">0g</p>
                        <p class="text-xs text-slate-400 uppercase">Protein</p>
                    </div>
                </div>
            </div>
            <button onclick="addFoodItem()" class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:shadow-xl transition-all active:scale-95 mb-3">
                Add to Diary
            </button>
            <button onclick="closeFoodPopup()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600 transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- BARCODE SCANNER MODAL -->
    <div id="barcode-scanner-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black">Scan Barcode</h3>
                <button onclick="closeBarcodeScanner()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div id="barcode-reader" class="w-full h-64 bg-black rounded-2xl mb-4"></div>
            <div class="flex gap-2">
                <input id="manual-barcode" type="text" placeholder="Or enter barcode manually..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="lookupBarcode()" class="bg-slate-900 text-white px-6 rounded-xl font-bold hover:bg-slate-800">Search</button>
            </div>
        </div>
    </div>

    <!-- CREATE MEAL MODAL -->
    <div id="create-meal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Create Meal</h3>
                <button onclick="closeCreateMeal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Meal Name *</label>
                <input id="meal-name-input" type="text" placeholder="e.g. Chicken & Rice Bowl" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <div class="flex gap-2 mb-4">
                <input id="meal-ingredient-search" type="text" placeholder="Search ingredient..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="showToast('Barcode for meals coming soon!')" class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center hover:bg-indigo-700">
                    <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="meal-search-results" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
            <div class="mb-6">
                <h4 class="text-sm font-black text-slate-400 uppercase mb-2">Ingredients</h4>
                <div id="meal-ingredients-list" class="space-y-2"></div>
            </div>
            <button onclick="saveMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700">Save Meal</button>
        </div>
    </div>

    <!-- METRICS CHART MODAL -->
    <div id="metrics-chart-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Progress Charts</h3>
                <button onclick="closeMetricsChart()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="mb-6">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Metric</label>
                <select id="chart-metric-select" onchange="renderMetricChart()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-lg">
                    <option value="weight">Weight (kg)</option>
                    <option value="chest">Chest (cm)</option>
                    <option value="shoulders">Shoulders (cm)</option>
                    <option value="arms">Arms (cm)</option>
                    <option value="waist">Waist (cm)</option>
                    <option value="legs">Legs (cm)</option>
                    <option value="glutes">Glutes (cm)</option>
                </select>
            </div>
            <div class="h-80 relative bg-slate-50 rounded-3xl p-4">
                <canvas id="metrics-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- PHOTO COMPARISON MODAL -->
    <div id="photo-comparison-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Compare Photos</h3>
                <button onclick="closePhotoComparison()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">First Date</label>
                        <select id="compare-date-1" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Second Date</label>
                        <select id="compare-date-2" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Photo Angle</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setComparePhotoType('front')" id="compare-type-front" class="p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white">Front</button>
                        <button onclick="setComparePhotoType('side')" id="compare-type-side" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Side</button>
                        <button onclick="setComparePhotoType('back')" id="compare-type-back" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Back</button>
                    </div>
                </div>
            </div>
            <div id="comparison-view" class="grid grid-cols-2 gap-6 hidden">
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-1"></div>
                    <img id="compare-img-1" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="Before">
                </div>
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-2"></div>
                    <img id="compare-img-2" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="After">
                </div>
            </div>
            <div id="no-comparison-message" class="text-center py-12 text-slate-400">
                <i data-lucide="images" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                <p class="font-bold">Select two dates to compare</p>
            </div>
        </div>
    </div>

    <script>
    // ==========================================================================
    // FIREBASE CONFIGURATION
    // ==========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyA9H9hmvfrQmc2wIwnS2jCPLgdmXBquQXM",
        authDomain: "vfit-app-pro.firebaseapp.com",
        projectId: "vfit-app-pro",
        storageBucket: "vfit-app-pro.firebasestorage.app",
        messagingSenderId: "815730068689",
        appId: "1:815730068689:web:0c6587d7dbe62b0f3c09f0",
        measurementId: "G-74L12X0NE8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let firebaseUserData = {};

    // ==========================================================================
    // CLOUD SYNC ‚Äî DEBOUNCED AUTO-SAVE
    // ==========================================================================
    let syncTimeout = null;

    function showSyncIndicator() {
        const el = document.getElementById('sync-indicator');
        if (el) {
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }
    }

    /**
     * Schedule a debounced Firestore save (500ms after last change).
     * Saves the full app state to: users/{uid}/appData/state
     */
    function scheduleSyncToFirestore() {
        if (!currentUser) return;
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(() => persistStateToFirestore(), 500);
    }

    async function persistStateToFirestore() {
        if (!currentUser) return;
        try {
            showSyncIndicator();
            const photos = extractPhotosFromState();
            const stateWithoutPhotos = { ...state };
            stateWithoutPhotos.metricsHistory = (state.metricsHistory || []).map(m => {
                const copy = { ...m };
                delete copy.photos;
                return copy;
            });
            stateWithoutPhotos.currentPhotos = {};

            const batch = db.batch();

            const stateRef = db.collection('users').doc(currentUser.uid)
                               .collection('appData').doc('state');
            batch.set(stateRef, {
                ...stateWithoutPhotos,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            const photosRef = db.collection('users').doc(currentUser.uid)
                                .collection('appData').doc('photos');
            batch.set(photosRef, { photos, lastSync: firebase.firestore.FieldValue.serverTimestamp() });

            const profileRef = db.collection('users').doc(currentUser.uid);
            batch.update(profileRef, {
                calorieGoal: state.goals?.calories || 2500,
                totalWorkouts: state.workoutHistory?.length || 0,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            await batch.commit();

            const syncLabel = document.getElementById('profile-last-sync');
            if (syncLabel) syncLabel.textContent = new Date().toLocaleTimeString();
        } catch (error) {
            console.error('Firestore sync error:', error);
        }
    }

    function extractPhotosFromState() {
        const photos = {};
        photos.currentPhotos = state.currentPhotos || {};
        (state.metricsHistory || []).forEach(m => {
            if (m.photos) photos[m.date] = m.photos;
        });
        return photos;
    }

    async function loadStateFromFirestore() {
        if (!currentUser) return false;
        try {
            const [stateSnap, photosSnap] = await Promise.all([
                db.collection('users').doc(currentUser.uid).collection('appData').doc('state').get(),
                db.collection('users').doc(currentUser.uid).collection('appData').doc('photos').get()
            ]);

            if (!stateSnap.exists) return false;

            const cloudState = stateSnap.data();
            const photosData = photosSnap.exists ? photosSnap.data().photos || {} : {};

            if (cloudState.metricsHistory) {
                cloudState.metricsHistory = cloudState.metricsHistory.map(m => ({
                    ...m,
                    photos: photosData[m.date] || {}
                }));
            }
            cloudState.currentPhotos = photosData.currentPhotos || {};

            delete cloudState.lastSync;

            state = { ...DEFAULT_STATE, ...cloudState };
            state.goals = { ...DEFAULT_STATE.goals, ...(cloudState.goals || {}) };
            state.equipment = {
                gym:  { ...DEFAULT_STATE.equipment.gym,  ...(cloudState.equipment?.gym  || {}) },
                home: { ...DEFAULT_STATE.equipment.home, ...(cloudState.equipment?.home || {}) }
            };
            saveState();
            return true;
        } catch (error) {
            console.error('Error loading from Firestore:', error);
            return false;
        }
    }

    // ==========================================================================
    // PATCHED saveState ‚Äî also syncs to Firestore
    // ==========================================================================
    function saveState() {
        try {
            localStorage.setItem('fittrack_state', JSON.stringify(state));
        } catch (e) {
            console.error('LocalStorage save error:', e);
        }
        scheduleSyncToFirestore();
    }

    // ==========================================================================
    // AUTH FORM HELPERS
    // ==========================================================================
    function showLogin() {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
    }
    function showRegister() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
    }
    function showForgotPassword() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.remove('hidden');
    }

    // ==========================================================================
    // AUTH FUNCTIONS
    // ==========================================================================
    async function registerUser() {
        const name     = document.getElementById('register-name').value.trim();
        const email    = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirm  = document.getElementById('register-confirm').value;

        if (!name)               { showToast('Please enter your name'); return; }
        if (!email || !password) { showToast('Please fill all fields'); return; }
        if (password.length < 6) { showToast('Password must be at least 6 characters'); return; }
        if (password !== confirm) { showToast('Passwords do not match'); return; }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            await user.updateProfile({ displayName: name });

            await db.collection('users').doc(user.uid).set({
                name,
                email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                calorieGoal: 2500,
                totalWorkouts: 0
            });

            const defaultStateForCloud = { ...DEFAULT_STATE, goals: { ...DEFAULT_STATE.goals } };
            delete defaultStateForCloud.currentPhotos;
            await db.collection('users').doc(user.uid).collection('appData').doc('state').set({
                ...defaultStateForCloud,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('users').doc(user.uid).collection('appData').doc('photos').set({
                photos: {},
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('Account created successfully! üéâ');
        } catch (error) {
            console.error('Registration error:', error);
            if (error.code === 'auth/email-already-in-use') showToast('Email already in use');
            else if (error.code === 'auth/invalid-email')   showToast('Invalid email address');
            else showToast('Registration failed: ' + error.message);
        }
    }

    async function loginUser() {
        const email    = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        if (!email || !password) { showToast('Please enter email and password'); return; }
        try {
            await auth.signInWithEmailAndPassword(email, password);
            showToast('Welcome back! üí™');
        } catch (error) {
            console.error('Login error:', error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found')
                showToast('Invalid email or password');
            else
                showToast('Login failed: ' + error.message);
        }
    }

    async function resetPassword() {
        const email = document.getElementById('forgot-email').value.trim();
        if (!email) { showToast('Please enter your email'); return; }
        try {
            await auth.sendPasswordResetEmail(email);
            showToast('Password reset email sent! Check your inbox.');
            showLogin();
        } catch (error) {
            showToast('Failed to send reset email');
        }
    }

    async function logoutUser() {
        if (confirm('Are you sure you want to sign out?')) {
            try {
                await persistStateToFirestore();
                await auth.signOut();
                state = { ...DEFAULT_STATE };
                saveState();
                showToast('Signed out successfully');
            } catch (error) {
                showToast('Logout failed');
            }
        }
    }

    // ==========================================================================
    // DELETE ACCOUNT
    // ==========================================================================
    function openDeleteAccountModal() {
        document.getElementById('delete-account-password').value = '';
        document.getElementById('delete-account-modal').style.display = 'flex';
        lucide.createIcons();
    }

    function closeDeleteAccountModal() {
        document.getElementById('delete-account-modal').style.display = 'none';
        document.getElementById('delete-account-password').value = '';
    }

    async function confirmDeleteAccount() {
        const password = document.getElementById('delete-account-password').value;
        if (!password) { showToast('Please enter your password to confirm'); return; }
        if (!currentUser) { showToast('No user signed in'); return; }

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await currentUser.reauthenticateWithCredential(credential);

            showToast('Deleting your data...');
            const appDataColl = db.collection('users').doc(currentUser.uid).collection('appData');
            const appDataDocs = await appDataColl.get();
            const deletePromises = appDataDocs.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);

            await db.collection('users').doc(currentUser.uid).delete();
            await currentUser.delete();

            state = { ...DEFAULT_STATE };
            localStorage.removeItem('fittrack_state');

            closeDeleteAccountModal();
            showToast('Your account has been permanently deleted.');
        } catch (error) {
            console.error('Delete account error:', error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                showToast('Incorrect password. Please try again.');
            } else if (error.code === 'auth/requires-recent-login') {
                showToast('Please sign out and sign back in, then try again.');
            } else {
                showToast('Failed to delete account: ' + error.message);
            }
        }
    }

    // ==========================================================================
    // CLOUD SYNC (manual button)
    // ==========================================================================
    async function syncToCloud() {
        if (!currentUser) { showToast('Not signed in'); return; }
        try {
            await persistStateToFirestore();
            showToast('Synced to cloud ‚òÅÔ∏è');
        } catch (error) {
            showToast('Sync failed ‚Äî check connection');
        }
    }

    // ==========================================================================
    // AUTH STATE OBSERVER
    // ==========================================================================
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            const loaded = await loadStateFromFirestore();
            if (!loaded) loadState();

            try {
                const profileDoc = await db.collection('users').doc(user.uid).get();
                if (profileDoc.exists) firebaseUserData = profileDoc.data();
            } catch(e) { console.error('Profile load error:', e); }

            const emailEl = document.getElementById('status-date');
            if (emailEl) emailEl.innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });

            const sidebarEmail = document.getElementById('sidebar-user-email');
            if (sidebarEmail) sidebarEmail.textContent = user.email;

            renderProfile();
            renderDashboard();
            renderDiary();
            renderSettings();
            setupMidnightSave();
            lucide.createIcons();
        } else {
            currentUser = null;
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
            lucide.createIcons();
        }
    });

    function renderProfile() {
        if (!currentUser) return;
        const name = currentUser.displayName || firebaseUserData?.name || 'User';
        document.getElementById('profile-name').textContent = name;
        document.getElementById('profile-email').textContent = currentUser.email;

        if (firebaseUserData?.createdAt) {
            try {
                const date = firebaseUserData.createdAt.toDate
                    ? firebaseUserData.createdAt.toDate()
                    : new Date(firebaseUserData.createdAt);
                document.getElementById('profile-created').textContent = date.toLocaleDateString();
            } catch { document.getElementById('profile-created').textContent = 'Recently'; }
        } else {
            document.getElementById('profile-created').textContent = 'Recently';
        }
        document.getElementById('profile-workouts').textContent = state.workoutHistory?.length || 0;
        const nutritionLogsEl = document.getElementById('profile-nutrition-logs');
        if (nutritionLogsEl) nutritionLogsEl.textContent = state.nutritionHistory?.length || 0;
    }

    // ==========================================================================
    // STATE MANAGEMENT
    // ==========================================================================
    const DEFAULT_STATE = {
        viewDate: new Date().toISOString().split('T')[0],
        metricsDate: new Date().toISOString().split('T')[0],
        goals: { calories: 2500, water: 2500, steps: 10000, protein: 150 },
        waterLogs: {},
        stepsLogs: {},
        dailyMeals: [],
        workoutHistory: [],
        nutritionHistory: [],
        metricsHistory: [],
        createdMeals: [],
        customFoods: [],
        workoutEnv: 'gym',
        currentPhotos: { front: null, side: null, back: null },
        habits: [],
        habitsEnabled: false,
        habitCompletions: {},
        hydrationGoalCompletions: {},
        stepsGoalCompletions: {},
        trackHydration: true,
        trackSteps: true,
        userGoals: [],
        cardioLogs: [],
        hydrationLogs: {},
        equipment: {
            gym:  { 'Barbell': true, 'Dumbbells': true, 'Cable Machine': true, 'Leg Press': true, 'Pull Up Bar': true, 'Bench': true },
            home: { 'Dumbbells': false, 'Resistance Bands': false, 'Pull Up Bar': false, 'Yoga Mat': true }
        }
    };

    let state = { ...DEFAULT_STATE };
    let workoutTimer = null;
    let workoutStartTime = null;
    let currentFoodItem = null;
    let currentAmountType = 'portion';
    let searchResults = [];
    let mealIngredients = [];
    let html5QrCode = null;
    let metricsChart = null;
    let currentPhotoType = null;
    let manualFoodImageData = null;

    // ==========================================================================
    // LOCAL CACHE
    // ==========================================================================
    function loadState() {
        try {
            const saved = localStorage.getItem('fittrack_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...DEFAULT_STATE, ...parsed };
                state.goals = { ...DEFAULT_STATE.goals, ...(parsed.goals || {}) };
                state.equipment = {
                    gym:  { ...DEFAULT_STATE.equipment.gym,  ...(parsed.equipment?.gym  || {}) },
                    home: { ...DEFAULT_STATE.equipment.home, ...(parsed.equipment?.home || {}) }
                };
            }
        } catch (e) { console.error('Load error:', e); }
    }

    // ==========================================================================
    // MIDNIGHT AUTO-SAVE SETUP
    // ==========================================================================
    function setupMidnightSave() {
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 10, 0); // 10 seconds past midnight to be safe
        const msUntilMidnight = tomorrow - now;
        setTimeout(() => {
            midnightAutoSave();
            // Re-schedule for the next night
            setupMidnightSave();
        }, msUntilMidnight);
        console.log(`Midnight auto-save scheduled in ${Math.round(msUntilMidnight / 1000 / 60)} minutes`);
    }

    /**
     * Called automatically at midnight.
     * Archives yesterday's diary to nutritionHistory, clears the diary for that date,
     * then resets viewDate to today.
     */
    function midnightAutoSave() {
        // The "today" at call time is actually yesterday (just ticked to a new day)
        const autoSaveEnabled = document.getElementById('auto-save-midnight')?.checked !== false;
        if (!autoSaveEnabled) return;

        // Calculate yesterday's date string
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const result = saveDailyNutrition(yesterdayStr);

        // Reset viewDate to new today
        const newToday = new Date().toISOString().split('T')[0];
        state.viewDate = newToday;

        // Reset hydration/steps goal completions for new day (optional ‚Äî keeps history)
        saveState();

        if (result) {
            showToast(`üåô Diary for ${yesterdayStr} auto-saved! (${result.count} items, ${Math.round(result.calories)} kcal)`);
        }

        // Update date pickers to new day
        ['nutrition-date-picker', 'workout-date-picker', 'metrics-date-picker'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = newToday;
        });

        renderDiary();
        renderDashboard();
        const statusDateEl = document.getElementById('status-date');
        if (statusDateEl) statusDateEl.innerText = new Date().toLocaleDateString('en-US', {
            weekday: 'short', month: 'short', day: 'numeric'
        });
    }

    // ==========================================================================
    // SAVE DAILY NUTRITION (UPGRADED ‚Äî clears diary, returns result)
    // ==========================================================================
    /**
     * Archives diary entries for a given date to nutritionHistory,
     * then CLEARS those entries from dailyMeals so the diary is fresh.
     * @param {string} targetDate  ISO date string (YYYY-MM-DD). Defaults to viewDate.
     * @returns {{ calories, protein, count }} or null if no meals found.
     */
    function saveDailyNutrition(targetDate) {
        const dateToSave = targetDate || state.viewDate;
        const dateMeals = (state.dailyMeals || []).filter(m => m.date === dateToSave);

        if (dateMeals.length === 0) return null;

        const totalCals    = dateMeals.reduce((sum, m) => sum + (m.calories || 0), 0);
        const totalProtein = dateMeals.reduce((sum, m) => sum + (m.protein  || 0), 0);
        const totalCarbs   = dateMeals.reduce((sum, m) => sum + (m.carbs    || 0), 0);
        const totalFat     = dateMeals.reduce((sum, m) => sum + (m.fat      || 0), 0);
        const totalFiber   = dateMeals.reduce((sum, m) => sum + (m.fiber    || 0), 0);

        if (!state.nutritionHistory) state.nutritionHistory = [];
        const existing = state.nutritionHistory.findIndex(h => h.date === dateToSave);

        const entry = {
            date:     dateToSave,
            calories: totalCals,
            protein:  totalProtein,
            carbs:    totalCarbs,
            fat:      totalFat,
            fiber:    totalFiber,
            meals:    [...dateMeals],
            savedAt:  new Date().toISOString()
        };

        if (existing >= 0) {
            state.nutritionHistory[existing] = entry;
        } else {
            state.nutritionHistory.unshift(entry);
        }

        // *** KEY CHANGE: clear diary for this date so tomorrow starts fresh ***
        state.dailyMeals = state.dailyMeals.filter(m => m.date !== dateToSave);

        saveState();
        return { calories: totalCals, protein: totalProtein, carbs: totalCarbs, fat: totalFat, count: dateMeals.length };
    }

    // ==========================================================================
    // SAVE DIARY MODAL FUNCTIONS (NEW)
    // ==========================================================================

    /**
     * Opens the "Save Diary to Log" modal.
     * Pre-fills date picker with the current viewDate and shows a live preview.
     */
    function openSaveDiaryModal() {
        // Set the date input to current viewDate
        const dateInput = document.getElementById('save-diary-date');
        if (dateInput) dateInput.value = state.viewDate;

        // Show live preview for current date
        updateSaveDiaryPreview(state.viewDate);

        // Display modal
        document.getElementById('save-diary-modal').style.display = 'flex';
        lucide.createIcons();

        // Attach date change listener (clone to avoid duplicate listeners)
        if (dateInput) {
            const newInput = dateInput.cloneNode(true);
            dateInput.parentNode.replaceChild(newInput, dateInput);
            newInput.value = state.viewDate;
            newInput.addEventListener('change', function() {
                updateSaveDiaryPreview(this.value);
            });
        }
    }

    /**
     * Updates the preview box inside the Save Diary modal
     * to show how many meals / kcal / protein will be archived.
     * @param {string} dateStr
     */
    function updateSaveDiaryPreview(dateStr) {
        const meals = (state.dailyMeals || []).filter(m => m.date === dateStr);
        const statsEl = document.getElementById('save-diary-stats');
        if (!statsEl) return;

        if (meals.length === 0) {
            statsEl.innerHTML = '<p class="text-slate-400 italic text-center py-2">No diary entries found for this day</p>';
            return;
        }

        const totalCals    = meals.reduce((s, m) => s + (m.calories || 0), 0);
        const totalProtein = meals.reduce((s, m) => s + (m.protein  || 0), 0);
        const totalCarbs   = meals.reduce((s, m) => s + (m.carbs    || 0), 0);
        const totalFat     = meals.reduce((s, m) => s + (m.fat      || 0), 0);

        // Group by meal type
        const byType = {};
        meals.forEach(m => { byType[m.mealType] = (byType[m.mealType] || 0) + 1; });
        const typeStr = Object.entries(byType).map(([t, c]) => `${c} ${t}`).join(', ');

        statsEl.innerHTML = `
            <div class="save-diary-stat-row">
                <span class="text-slate-500">Date</span>
                <span class="font-black text-indigo-600">${new Date(dateStr + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
            </div>
            <div class="save-diary-stat-row">
                <span class="text-slate-500">Food items</span>
                <span class="font-black">${meals.length} (${typeStr})</span>
            </div>
            <div class="save-diary-stat-row">
                <span class="text-slate-500">Total Calories</span>
                <span class="font-black text-indigo-600">${Math.round(totalCals)} kcal</span>
            </div>
            <div class="save-diary-stat-row">
                <span class="text-slate-500">Total Protein</span>
                <span class="font-black text-blue-600">${totalProtein.toFixed(1)}g</span>
            </div>
            <div class="save-diary-stat-row">
                <span class="text-slate-500">Total Carbs</span>
                <span class="font-black text-amber-600">${totalCarbs.toFixed(1)}g</span>
            </div>
            <div class="save-diary-stat-row" style="border-bottom:none;">
                <span class="text-slate-500">Total Fat</span>
                <span class="font-black text-rose-600">${totalFat.toFixed(1)}g</span>
            </div>
        `;
    }

    /** Closes the Save Diary modal. */
    function closeSaveDiaryModal() {
        document.getElementById('save-diary-modal').style.display = 'none';
    }

    /**
     * Triggered by the "Save & Clear Diary" button inside the modal.
     * Reads the chosen date, calls saveDailyNutrition, refreshes UI.
     */
    function confirmSaveDiary() {
        const dateInput = document.getElementById('save-diary-date');
        const dateStr = dateInput?.value;

        if (!dateStr) {
            showToast('Please select a date');
            return;
        }

        const meals = (state.dailyMeals || []).filter(m => m.date === dateStr);
        if (meals.length === 0) {
            showToast('No diary entries found for this date');
            return;
        }

        const result = saveDailyNutrition(dateStr);
        closeSaveDiaryModal();

        if (result) {
            renderDiary();
            renderDashboard();
            renderLogs();
            renderProfile();
            showToast(`‚úÖ Diary saved! ${result.count} items ¬∑ ${Math.round(result.calories)} kcal archived to logs`);
        }
    }

    // ==========================================================================
    // TAB MANAGEMENT
    // ==========================================================================
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        const tab = document.getElementById(tabId);
        if (tab) tab.classList.add('active');
        if (tabId === 'logs')      { renderLogs(); filterWorkouts(); }
        if (tabId === 'profile')   renderProfile();
        if (tabId === 'settings')  renderSettings();
        if (tabId === 'dashboard') renderDashboard();
        if (tabId === 'nutrition') {
            selectNutritionDate(state.viewDate);
        }
        lucide.createIcons();
    }

    // ==========================================================================
    // SIDEBAR
    // ==========================================================================
    function toggleSidebar() {
        const sidebar  = document.getElementById('sidebar');
        const overlay  = document.getElementById('sidebar-overlay');
        const isOpen   = sidebar.classList.contains('translate-x-0');
        if (isOpen) {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.add('translate-x-0');
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }
        lucide.createIcons();
    }

    // ==========================================================================
    // TOAST
    // ==========================================================================
    function showToast(message, duration = 3500) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ==========================================================================
    // EXERCISE DATABASE
    // ==========================================================================
    const EXERCISE_DB = {
        gym: {
            'Full Body': { compound: ['Barbell Squat','Deadlift','Bench Press','Pull Ups','Overhead Press'], isolation: ['Bicep Curl','Tricep Pushdown','Lateral Raise','Leg Curl','Calf Raise'] },
            'Upper':     { compound: ['Bench Press','Pull Ups','Dumbbell Row','Overhead Press','Dips'], isolation: ['Bicep Curl','Tricep Pushdown','Lateral Raise','Face Pulls','Cable Flyes'] },
            'Lower':     { compound: ['Barbell Squat','Romanian Deadlift','Leg Press','Lunges'], isolation: ['Leg Extension','Leg Curl','Calf Raise','Hip Abduction','Glute Kickback'] },
            'Push':      { compound: ['Bench Press','Overhead Press','Incline Press','Dips'], isolation: ['Tricep Pushdown','Lateral Raise','Cable Flyes','Skull Crushers'] },
            'Pull':      { compound: ['Pull Ups','Barbell Row','Lat Pulldown','T-Bar Row'], isolation: ['Bicep Curl','Face Pulls','Hammer Curl','Cable Row'] },
            'Legs':      { compound: ['Squat','Deadlift','Leg Press','Lunges'], isolation: ['Leg Extension','Leg Curl','Calf Raise','Hip Thrust'] },
            'Chest':     { compound: ['Bench Press','Incline Press','Dumbbell Press'], isolation: ['Cable Flyes','Pec Deck','Dumbbell Flyes'] },
            'Back':      { compound: ['Pull Ups','Barbell Row','Lat Pulldown','T-Bar Row'], isolation: ['Cable Row','Face Pulls','Straight Arm Pulldown'] },
            'Shoulders': { compound: ['Overhead Press','Arnold Press'], isolation: ['Lateral Raise','Front Raise','Face Pulls','Reverse Flyes'] },
            'Biceps':    { compound: ['Chin Ups'], isolation: ['Barbell Curl','Hammer Curl','Preacher Curl','Cable Curl'] },
            'Triceps':   { compound: ['Close Grip Bench Press','Dips'], isolation: ['Tricep Pushdown','Skull Crushers','Overhead Extension'] },
            'Quads':     { compound: ['Squat','Leg Press','Lunges'], isolation: ['Leg Extension','Sissy Squat'] },
            'Hamstrings':{ compound: ['Romanian Deadlift','Good Morning'], isolation: ['Leg Curl','Nordic Curl'] },
            'Glutes':    { compound: ['Hip Thrust','Bulgarian Split Squat'], isolation: ['Cable Kickback','Hip Abduction','Glute Bridge'] },
            'Calves':    { compound: [], isolation: ['Standing Calf Raise','Seated Calf Raise','Donkey Calf Raise'] }
        },
        home: {
            'Full Body': { compound: ['Push Ups','Bodyweight Squat','Burpees'], isolation: ['Plank','Crunches','Leg Raises'] },
            'Upper':     { compound: ['Push Ups','Pike Push Ups','Inverted Row'], isolation: ['Tricep Dips','Plank to Push Up','Superman'] },
            'Lower':     { compound: ['Bodyweight Squat','Lunges','Step Ups'], isolation: ['Glute Bridge','Calf Raise','Donkey Kicks'] },
            'Push':      { compound: ['Push Ups','Pike Push Ups'], isolation: ['Diamond Push Ups','Tricep Dips','Shoulder Taps'] },
            'Pull':      { compound: ['Inverted Row','Chin Ups'], isolation: ['Superman','Reverse Snow Angels','Bicep Holds'] },
            'Legs':      { compound: ['Squat','Lunges','Jump Squat'], isolation: ['Glute Bridge','Calf Raise','Leg Raises'] }
        }
    };

    const ALL_EXERCISES = [
        'Barbell Squat','Deadlift','Bench Press','Pull Ups','Overhead Press','Dumbbell Press',
        'Incline Press','Dips','Barbell Row','Lat Pulldown','T-Bar Row','Romanian Deadlift',
        'Leg Press','Lunges','Good Morning','Hip Thrust','Bulgarian Split Squat','Arnold Press',
        'Close Grip Bench Press','Chin Ups','Bicep Curl','Tricep Pushdown','Lateral Raise',
        'Leg Curl','Calf Raise','Face Pulls','Cable Flyes','Leg Extension','Hip Abduction',
        'Glute Kickback','Cable Row','Hammer Curl','Skull Crushers','Pec Deck','Dumbbell Flyes',
        'Front Raise','Reverse Flyes','Preacher Curl','Cable Curl','Overhead Extension',
        'Sissy Squat','Nordic Curl','Cable Kickback','Glute Bridge','Standing Calf Raise',
        'Seated Calf Raise','Donkey Calf Raise','Straight Arm Pulldown','Push Ups',
        'Bodyweight Squat','Burpees','Pike Push Ups','Inverted Row','Step Ups','Donkey Kicks',
        'Diamond Push Ups','Shoulder Taps','Superman','Reverse Snow Angels','Bicep Holds',
        'Jump Squat','Plank','Crunches','Leg Raises','Tricep Dips','Plank to Push Up',
        'Barbell Curl','Dumbbell Row','T-Bar Row','Sumo Deadlift','Hack Squat',
        'Incline Dumbbell Curl','Zottman Curl','Concentration Curl','Spider Curl',
        'Cable Lateral Raise','Upright Row','Shrugs','Bent Over Lateral Raise',
        'Chest Fly Machine','Assisted Pull Up','Smith Machine Squat','Box Squat',
        'Pause Squat','Front Squat','Zercher Squat','Jefferson Curl','Stiff Leg Deadlift',
        'Trap Bar Deadlift','Single Leg RDL','Step Up','Wall Sit','Sissy Squat',
        'Hack Squat','Leg Press Calf Raise','Cable Pull Through','Good Morning',
        'Reverse Hyper','45 Degree Back Extension','Seated Good Morning'
    ].filter((v,i,a) => a.indexOf(v) === i).sort();

    const CARDIO_EXERCISES = ['Treadmill','Rowing Machine','Stationary Bike','Elliptical','Stair Climber','Jump Rope','Battle Ropes'];
    const CORE_EXERCISES   = ['Plank','Crunches','Russian Twists','Leg Raises','Mountain Climbers','Dead Bug','Ab Wheel Rollout','Hanging Leg Raise','Cable Crunch','Pallof Press'];

    // ==========================================================================
    // UK STORES & RESTAURANTS
    // ==========================================================================
    const UK_STORES_RESTAURANTS = [
        { name: 'All Stores & Restaurants', value: 'all', type: 'all' },
        { name: 'Tesco', value: 'tesco', type: 'supermarket' },
        { name: "Sainsbury's", value: 'sainsburys', type: 'supermarket' },
        { name: 'ASDA', value: 'asda', type: 'supermarket' },
        { name: 'Morrisons', value: 'morrisons', type: 'supermarket' },
        { name: 'Aldi', value: 'aldi', type: 'supermarket' },
        { name: 'Lidl', value: 'lidl', type: 'supermarket' },
        { name: 'Waitrose', value: 'waitrose', type: 'supermarket' },
        { name: 'Co-op', value: 'coop', type: 'supermarket' },
        { name: 'Iceland', value: 'iceland', type: 'supermarket' },
        { name: 'Costco', value: 'costco', type: 'supermarket' },
        { name: 'M&S Food', value: 'marks', type: 'supermarket' },
        { name: 'Ocado', value: 'ocado', type: 'supermarket' },
        { name: 'Farmfoods', value: 'farmfoods', type: 'supermarket' },
        { name: 'Booths', value: 'booths', type: 'supermarket' },
        { name: 'Budgens', value: 'budgens', type: 'supermarket' },
        { name: "McDonald's", value: 'mcdonalds', type: 'fastfood' },
        { name: 'KFC', value: 'kfc', type: 'fastfood' },
        { name: 'Burger King', value: 'burgerking', type: 'fastfood' },
        { name: 'Subway', value: 'subway', type: 'fastfood' },
        { name: 'Greggs', value: 'greggs', type: 'fastfood' },
        { name: "Nando's", value: 'nandos', type: 'fastfood' },
        { name: 'Pizza Hut', value: 'pizzahut', type: 'fastfood' },
        { name: "Domino's", value: 'dominos', type: 'fastfood' },
        { name: "Papa John's", value: 'papajohns', type: 'fastfood' },
        { name: 'Five Guys', value: 'fiveguys', type: 'fastfood' },
        { name: 'Wagamama', value: 'wagamama', type: 'fastfood' },
        { name: 'Pret A Manger', value: 'pret', type: 'fastfood' },
        { name: 'Leon', value: 'leon', type: 'fastfood' },
        { name: 'Yo! Sushi', value: 'yosushi', type: 'fastfood' },
        { name: 'Gourmet Burger Kitchen', value: 'gbk', type: 'fastfood' },
        { name: 'Costa Coffee', value: 'costa', type: 'fastfood' },
        { name: 'Starbucks', value: 'starbucks', type: 'fastfood' },
        { name: 'Caff√® Nero', value: 'nero', type: 'fastfood' }
    ].sort((a,b) => { if(a.value==='all') return -1; if(b.value==='all') return 1; return a.name.localeCompare(b.name); });

    // ==========================================================================
    // DASHBOARD
    // ==========================================================================
    function renderDashboard() {
        const todayMeals   = (state.dailyMeals || []).filter(m => m.date === state.viewDate);
        const totalCals    = todayMeals.reduce((sum,m) => sum + (m.calories||0), 0);
        const totalProtein = todayMeals.reduce((sum,m) => sum + (m.protein||0), 0);
        const totalCarbs   = todayMeals.reduce((sum,m) => sum + (m.carbs||0), 0);
        const totalFat     = todayMeals.reduce((sum,m) => sum + (m.fat||0), 0);

        const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

        setEl('dash-calories', Math.round(totalCals));
        setEl('dash-protein', Math.round(totalProtein) + 'g');
        setEl('dash-carbs', Math.round(totalCarbs) + 'g');
        setEl('dash-fat', Math.round(totalFat) + 'g');

        const calorieGoal = state.goals?.calories || 2500;
        const calPct = Math.min((totalCals / calorieGoal) * 100, 100);
        const progress = Math.min((totalCals / calorieGoal) * 534, 534);
        const progressEl = document.getElementById('calorie-progress');
        if (progressEl) progressEl.style.strokeDashoffset = 534 - progress;

        // Macro bars
        const proteinPct = Math.min((totalProtein / (state.goals?.protein || 150)) * 100, 100);
        const carbPct    = Math.min((totalCarbs / 300) * 100, 100);
        const fatPct     = Math.min((totalFat / 80) * 100, 100);

        const setBar = (barId, pctId, pct) => {
            const bar = document.getElementById(barId);
            const pctEl = document.getElementById(pctId);
            if (bar) bar.style.width = pct + '%';
            if (pctEl) pctEl.innerText = Math.round(pct) + '%';
        };
        setBar('dash-protein-bar', 'dash-protein-pct', proteinPct);
        setBar('dash-carbs-bar', 'dash-carbs-pct', carbPct);
        setBar('dash-fat-bar', 'dash-fat-pct', fatPct);

        // Hydration
        const water = state.waterLogs?.[state.viewDate] || 0;
        const waterGoal = state.goals?.water || 2500;
        const waterCountEl = document.getElementById('water-count');
        if (waterCountEl) waterCountEl.innerText = `${(water/1000).toFixed(1)} / ${(waterGoal/1000).toFixed(1)}L`;

        // Steps
        const steps = state.stepsLogs?.[state.viewDate] || 0;
        const stepsGoal = state.goals?.steps || 10000;
        const stepsCountEl = document.getElementById('steps-count');
        if (stepsCountEl) stepsCountEl.innerText = `${steps.toLocaleString()} / ${stepsGoal.toLocaleString()}`;

        // Hydration checkmark
        const hydrationComplete = state.hydrationGoalCompletions?.[state.viewDate] || false;
        const hydrationCheckBtn = document.getElementById('hydration-check');
        if (hydrationCheckBtn) {
            const icon = hydrationCheckBtn.querySelector('i');
            if (hydrationComplete) {
                hydrationCheckBtn.classList.add('bg-cyan-500','border-cyan-500');
                hydrationCheckBtn.classList.remove('border-slate-200');
                if (icon) { icon.classList.remove('text-transparent'); icon.classList.add('text-white'); }
            } else {
                hydrationCheckBtn.classList.remove('bg-cyan-500','border-cyan-500');
                hydrationCheckBtn.classList.add('border-slate-200');
                if (icon) { icon.classList.add('text-transparent'); icon.classList.remove('text-white'); }
            }
        }

        // Steps checkmark
        const stepsComplete = state.stepsGoalCompletions?.[state.viewDate] || false;
        const stepsCheckBtn = document.getElementById('steps-check');
        if (stepsCheckBtn) {
            const icon = stepsCheckBtn.querySelector('i');
            if (stepsComplete) {
                stepsCheckBtn.classList.add('bg-amber-500','border-amber-500');
                stepsCheckBtn.classList.remove('border-slate-200');
                if (icon) { icon.classList.remove('text-transparent'); icon.classList.add('text-white'); }
            } else {
                stepsCheckBtn.classList.remove('bg-amber-500','border-amber-500');
                stepsCheckBtn.classList.add('border-slate-200');
                if (icon) { icon.classList.add('text-transparent'); icon.classList.remove('text-white'); }
            }
        }

        // Weekly stats
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
        const weekWorkouts = (state.workoutHistory||[]).filter(w => new Date(w.date) > weekAgo).length;
        const lastWeight = state.metricsHistory?.[0]?.weight || '--';
        const statsEl = document.getElementById('muscle-volume-stats');
        if (statsEl) statsEl.innerHTML = `
            <div class="bg-white/10 p-3 rounded-xl"><div class="text-[10px] opacity-70 uppercase">This Week</div><div class="font-bold text-xl">${weekWorkouts} workouts</div></div>
            <div class="bg-white/10 p-3 rounded-xl"><div class="text-[10px] opacity-70 uppercase">Last Weight</div><div class="font-bold text-xl">${lastWeight} kg</div></div>`;

        // Today at a glance
        const summaryEl = document.getElementById('today-summary');
        if (summaryEl) {
            const todayWorkouts = (state.workoutHistory||[]).filter(w => w.date === state.viewDate);
            let html = '';
            if (todayWorkouts.length > 0) {
                html += todayWorkouts.map(w => `<div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-xl"><span class="text-xl">üí™</span><div><p class="font-bold text-sm">${w.focus}</p><p class="text-xs text-slate-400">${w.duration}</p></div></div>`).join('');
            }
            if (todayMeals.length > 0) {
                html += `<div class="flex items-center gap-3 p-3 bg-emerald-50 rounded-xl"><span class="text-xl">üçΩÔ∏è</span><div><p class="font-bold text-sm">${todayMeals.length} meals logged</p><p class="text-xs text-slate-400">${Math.round(totalCals)} kcal ¬∑ ${totalProtein.toFixed(0)}g protein</p></div></div>`;
            }
            if (hydrationComplete) {
                html += `<div class="flex items-center gap-3 p-3 bg-cyan-50 rounded-xl"><span class="text-xl">üíß</span><div><p class="font-bold text-sm">Hydration goal met!</p><p class="text-xs text-slate-400">${(water/1000).toFixed(1)}L consumed</p></div></div>`;
            }
            if (!html) html = '<p class="text-slate-400 text-sm italic text-center py-4">Nothing logged yet today</p>';
            summaryEl.innerHTML = html;
        }

        if (state.habitsEnabled) {
            document.getElementById('habits-tracker')?.classList.remove('hidden');
            renderDashboardHabits();
        }
        lucide.createIcons();
    }

    function toggleHydrationGoal() {
        if (!state.hydrationGoalCompletions) state.hydrationGoalCompletions = {};
        state.hydrationGoalCompletions[state.viewDate] = !state.hydrationGoalCompletions[state.viewDate];
        saveState(); renderDashboard();
        showToast(state.hydrationGoalCompletions[state.viewDate] ? 'Hydration goal reached! üíß' : 'Hydration goal unmarked');
        lucide.createIcons();
    }

    function toggleStepsGoal() {
        if (!state.stepsGoalCompletions) state.stepsGoalCompletions = {};
        state.stepsGoalCompletions[state.viewDate] = !state.stepsGoalCompletions[state.viewDate];
        saveState(); renderDashboard();
        showToast(state.stepsGoalCompletions[state.viewDate] ? 'Steps goal reached! üëü' : 'Steps goal unmarked');
        lucide.createIcons();
    }

    // ==========================================================================
    // TRAINING
    // ==========================================================================
    function setWorkoutEnv(env) {
        state.workoutEnv = env;
        const gymTab  = document.getElementById('env-tab-gym');
        const homeTab = document.getElementById('env-tab-home');
        if (gymTab)  gymTab.className  = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env==='gym'  ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (homeTab) homeTab.className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env==='home' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
    }

    function toggleSpecificMuscle() {
        const focus = document.getElementById('workout-focus').value;
        document.getElementById('specific-muscle-container')?.classList.toggle('hidden', focus !== 'Specific Muscle');
    }

    function startWorkout(mode) {
        const focus  = document.getElementById('workout-focus').value;
        const muscle = focus === 'Specific Muscle' ? document.getElementById('specific-muscle').value : focus;
        document.getElementById('workout-setup').classList.add('hidden');
        document.getElementById('workout-active').classList.remove('hidden');
        document.getElementById('active-workout-title').innerText = muscle;
        document.getElementById('exercise-list').innerHTML = '';

        if (mode === 'ai') {
            const env = state.workoutEnv || 'gym';
            const exercises = EXERCISE_DB[env]?.[muscle];
            const addCardio = document.getElementById('add-cardio-check').checked;
            const addCore   = document.getElementById('add-core-check').checked;
            if (exercises) {
                const compounds  = (exercises.compound||[]).sort(()=>0.5-Math.random()).slice(0,2);
                const isolations = (exercises.isolation||[]).sort(()=>0.5-Math.random()).slice(0,3);
                let delay = 0;
                [...compounds,...isolations].forEach(ex => { setTimeout(()=>addExercise(ex), delay); delay+=20; });
                if (addCardio) { const c = CARDIO_EXERCISES[Math.floor(Math.random()*CARDIO_EXERCISES.length)]; setTimeout(()=>addExercise(c), delay); delay+=20; }
                if (addCore)   { const c1 = CORE_EXERCISES[Math.floor(Math.random()*CORE_EXERCISES.length)]; setTimeout(()=>addExercise(c1), delay); delay+=20; }
                showToast('AI workout generated! üí™');
            } else showToast('No exercises found for this selection');
        }

        workoutStartTime = Date.now();
        workoutTimer = setInterval(updateWorkoutTimer, 1000);
    }

    function updateWorkoutTimer() {
        const elapsed = Math.floor((Date.now()-workoutStartTime)/1000);
        const h = Math.floor(elapsed/3600).toString().padStart(2,'0');
        const m = Math.floor((elapsed%3600)/60).toString().padStart(2,'0');
        const s = (elapsed%60).toString().padStart(2,'0');
        const el = document.getElementById('workout-timer');
        if (el) el.innerText = `${h}:${m}:${s}`;
    }

    function addExercise(name='') {
        const id = 'ex-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
        const pr = name ? getPersonalRecord(name) : null;
        const card = document.createElement('div');
        card.id = `card-${id}`;
        card.className = "bg-white p-4 sm:p-5 rounded-2xl shadow-md border-2 border-indigo-100 mb-3 sm:mb-4 w-full exercise-card-hover";

        const nameContainer = document.createElement('div');
        nameContainer.className = "relative mb-3 sm:mb-4";
        const inputWrapper = document.createElement('div');
        inputWrapper.className = "flex gap-2 items-center";
        const nameInput = document.createElement('input');
        nameInput.type = "text"; nameInput.value = name;
        nameInput.placeholder = "Search or type exercise name...";
        nameInput.className = "flex-1 p-3 sm:p-3.5 border-2 border-slate-200 rounded-xl font-bold text-base sm:text-lg";
        nameInput.id = `ex-name-${id}`; nameInput.autocomplete = "off";

        const infoBtn = document.createElement('button');
        infoBtn.type = "button";
        infoBtn.className = "w-10 h-10 sm:w-11 sm:h-11 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center hover:bg-indigo-200 flex-shrink-0";
        infoBtn.innerHTML = '<i data-lucide="info" class="w-5 h-5"></i>';
        infoBtn.addEventListener('click', () => { const n=nameInput.value.trim(); if(n) showExerciseDemo(n); else showToast('Enter exercise name first'); });

        const dropdown = document.createElement('div');
        dropdown.id = `dropdown-${id}`;
        dropdown.className = "hidden absolute z-50 mt-1 w-full bg-white rounded-xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto";
        nameInput.addEventListener('focus', ()=>showExerciseDropdown(id));
        nameInput.addEventListener('input', (e)=>filterExerciseDropdown(id, e.target.value));

        inputWrapper.appendChild(nameInput); inputWrapper.appendChild(infoBtn);
        nameContainer.appendChild(inputWrapper); nameContainer.appendChild(dropdown);

        const setsContainer = document.createElement('div');
        setsContainer.id = `sets-${id}`;
        setsContainer.className = "bg-slate-50 p-3 sm:p-4 rounded-xl mb-3 sm:mb-4 min-h-[100px] w-full";
        const header = document.createElement('div');
        header.className = "flex gap-2 sm:gap-3 mb-2 sm:mb-3";
        header.innerHTML = `<div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Reps</span></div><div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Weight (kg)</span></div><div class="w-9 sm:w-10"></div>`;
        setsContainer.appendChild(header);

        const addSetBtn = document.createElement('button');
        addSetBtn.type = "button";
        addSetBtn.className = "w-full py-3 sm:py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-sm sm:text-base hover:bg-indigo-700";
        addSetBtn.textContent = "+ Add Set";
        addSetBtn.addEventListener('click', ()=>addSetToExercise(id, pr));

        const deleteExBtn = document.createElement('button');
        deleteExBtn.type = "button";
        deleteExBtn.className = "w-full py-2 sm:py-2.5 mt-2 bg-red-50 text-red-600 rounded-xl font-bold text-xs sm:text-sm hover:bg-red-100";
        deleteExBtn.textContent = "Delete Exercise";
        deleteExBtn.addEventListener('click', ()=>card.remove());

        card.appendChild(nameContainer); card.appendChild(setsContainer);
        card.appendChild(addSetBtn); card.appendChild(deleteExBtn);
        document.getElementById('exercise-list')?.appendChild(card);
        setTimeout(()=>addSetToExercise(id, pr), 60);
        lucide.createIcons();
    }

    function showExerciseDropdown(id) {
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (!dropdown) return;
        dropdown.innerHTML = ALL_EXERCISES.map(ex => {
            const pr = getPersonalRecord(ex);
            return `<div onclick="selectExerciseFromDropdown('${id}','${ex.replace(/'/g,"\\'")}')\" class="exercise-dropdown-item"><span class="font-medium">${ex}</span>${pr?`<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded pr-badge">PR: ${pr}kg</span>`:''}</div>`;
        }).join('');
        dropdown.classList.remove('hidden');
    }

    function filterExerciseDropdown(id, query) {
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (!dropdown) return;
        const filtered = ALL_EXERCISES.filter(ex => ex.toLowerCase().includes(query.toLowerCase()));
        if (filtered.length === 0 && query.length > 0) {
            dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No matches ‚Äî keep typing for custom name</div>';
            dropdown.classList.remove('hidden');
        } else if (filtered.length > 0) {
            dropdown.innerHTML = filtered.map(ex => {
                const pr = getPersonalRecord(ex);
                return `<div onclick="selectExerciseFromDropdown('${id}','${ex.replace(/'/g,"\\'")}')\" class="exercise-dropdown-item"><span class="font-medium">${ex}</span>${pr?`<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>`:''}</div>`;
            }).join('');
            dropdown.classList.remove('hidden');
        } else if (query.length === 0) {
            showExerciseDropdown(id);
        } else {
            dropdown.classList.add('hidden');
        }
    }

    function selectExerciseFromDropdown(id, exerciseName) {
        const input    = document.getElementById(`ex-name-${id}`);
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (input)    input.value = exerciseName;
        if (dropdown) dropdown.classList.add('hidden');
        const pr = getPersonalRecord(exerciseName);
        if (pr) showToast(`PR for ${exerciseName}: ${pr}kg`);
    }

    function addSetToExercise(exerciseId, pr) {
        const container = document.getElementById(`sets-${exerciseId}`);
        if (!container) return;
        const setRow = document.createElement('div');
        setRow.className = "flex gap-2 sm:gap-3 items-center mb-2 bg-white p-2 sm:p-3 rounded-lg border border-slate-200";
        const repsInput   = document.createElement('input');
        repsInput.type = "number"; repsInput.placeholder = "Reps"; repsInput.min = "0";
        repsInput.className = "flex-1 p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
        const weightDiv   = document.createElement('div'); weightDiv.className = "flex-1 relative";
        const weightInput = document.createElement('input');
        weightInput.type = "number"; weightInput.placeholder = "Weight"; weightInput.min = "0"; weightInput.step = "0.5";
        weightInput.className = "w-full p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
        weightDiv.appendChild(weightInput);
        if (pr) {
            const pbBadge = document.createElement('span');
            pbBadge.className = "absolute -top-2 -right-2 text-[9px] sm:text-[10px] font-black text-white bg-emerald-500 px-2 py-1 rounded-full shadow-md whitespace-nowrap z-10";
            pbBadge.textContent = `PB ${pr}kg`;
            weightDiv.appendChild(pbBadge);
        }
        const deleteBtn = document.createElement('button');
        deleteBtn.type = "button";
        deleteBtn.className = "w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold text-lg flex-shrink-0";
        deleteBtn.textContent = "√ó";
        deleteBtn.addEventListener('click', ()=>setRow.remove());
        setRow.appendChild(repsInput); setRow.appendChild(weightDiv); setRow.appendChild(deleteBtn);
        container.appendChild(setRow);
    }

    function getPersonalRecord(exerciseName) {
        let maxWeight = 0;
        (state.workoutHistory||[]).forEach(workout => {
            (workout.exercises||[]).forEach(ex => {
                if (ex.name === exerciseName) {
                    (ex.sets||[]).forEach(set => {
                        const w = parseFloat(set.weight)||parseFloat(set.kg)||0;
                        if (w > maxWeight) maxWeight = w;
                    });
                }
            });
        });
        return maxWeight > 0 ? maxWeight : null;
    }

    function saveWorkout() {
        clearInterval(workoutTimer);
        const exercises = [];
        document.querySelectorAll('#exercise-list > div').forEach(card => {
            const nameInput = card.querySelector('input[type="text"]');
            const name = nameInput ? nameInput.value.trim() : '';
            if (!name) return;
            const sets = [];
            card.querySelectorAll('.flex.gap-2.items-center.mb-2').forEach(row => {
                const inputs = row.querySelectorAll('input[type="number"]');
                if (inputs.length >= 2 && inputs[0].value && inputs[1].value)
                    sets.push({ reps: inputs[0].value, weight: inputs[1].value });
            });
            if (sets.length > 0) exercises.push({ name, sets });
        });
        if (exercises.length === 0) { showToast('Add at least one exercise with sets'); return; }
        const workoutDate = window.selectedWorkoutDate || document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
        state.workoutHistory.unshift({ id: Date.now(), date: workoutDate, focus: document.getElementById('active-workout-title').innerText, duration: document.getElementById('workout-timer').innerText, exercises });
        saveState();
        document.getElementById('workout-setup').classList.remove('hidden');
        document.getElementById('workout-active').classList.add('hidden');
        renderDashboard();
        renderProfile();
        showToast('Workout saved! üèãÔ∏è');
    }

    function cancelWorkout() {
        if (confirm('Discard workout?')) {
            clearInterval(workoutTimer);
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
        }
    }

    document.addEventListener('click', function(e) {
        if (!e.target.matches('[id^="ex-name-"]') && !e.target.closest('[id^="dropdown-"]'))
            document.querySelectorAll('[id^="dropdown-"]').forEach(d=>d.classList.add('hidden'));
        if (!e.target.matches('#store-search-input') && !e.target.closest('#store-dropdown'))
            document.getElementById('store-dropdown')?.classList.add('hidden');
        if (!e.target.matches('#manual-food-store-input') && !e.target.closest('#manual-store-dropdown'))
            document.getElementById('manual-store-dropdown')?.classList.add('hidden');
    });

    // ==========================================================================
    // DATE MANAGEMENT ‚Äî TRAINING
    // ==========================================================================
    function changeWorkoutDate(days) {
        const current = document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current); date.setDate(date.getDate()+days);
        selectWorkoutDate(date.toISOString().split('T')[0]);
    }
    function selectWorkoutDate(dateStr) {
        document.getElementById('workout-date-picker').value = dateStr;
        window.selectedWorkoutDate = dateStr;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('workout-date-warning')?.classList.toggle('hidden', dateStr===today);
        lucide.createIcons();
    }

    // ==========================================================================
    // NUTRITION ‚Äî TAB & DIARY
    // ==========================================================================
    function setNutritionTab(tab) {
        const diaryBtn  = document.getElementById('nut-tab-diary');
        const searchBtn = document.getElementById('nut-tab-search');
        if (diaryBtn)  diaryBtn.className  = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab==='diary'  ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (searchBtn) searchBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab==='search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        document.getElementById('nut-view-diary')?.classList.toggle('hidden', tab!=='diary');
        document.getElementById('nut-view-search')?.classList.toggle('hidden', tab!=='search');
        if (tab==='diary')  renderDiary();
        if (tab==='search') renderCreatedMeals();
    }

    function renderDiary() {
        const todayMeals   = (state.dailyMeals || []).filter(m => m.date === state.viewDate);
        const totalCals    = todayMeals.reduce((sum,m) => sum+(m.calories||0), 0);
        const totalProtein = todayMeals.reduce((sum,m) => sum+(m.protein||0), 0);
        const totalKcalEl  = document.getElementById('total-kcal');
        if (totalKcalEl) totalKcalEl.innerText = Math.round(totalCals);
        const totalProteinEl = document.getElementById('total-protein');
        if (totalProteinEl) totalProteinEl.innerText = totalProtein.toFixed(1);

        // Goal progress
        const goal = state.goals?.calories || 2500;
        const remaining = goal - Math.round(totalCals);
        const pct = Math.min((totalCals / goal) * 100, 100);
        const remainingEl = document.getElementById('diary-goal-remaining');
        if (remainingEl) remainingEl.innerText = remaining > 0 ? `${remaining} remaining` : `${Math.abs(remaining)} over goal`;
        const diaryBar = document.getElementById('diary-calorie-bar');
        if (diaryBar) { diaryBar.style.width = pct + '%'; diaryBar.className = `macro-bar-fill ${pct >= 100 ? 'bg-rose-500' : pct >= 80 ? 'bg-amber-500' : 'bg-indigo-500'}`; }

        const sections = ['breakfast','lunch','dinner','snack'];
        const icons = { breakfast:'coffee', lunch:'utensils', dinner:'moon', snack:'cookie' };
        let html = '';
        sections.forEach(section => {
            const meals = todayMeals.filter(m => m.mealType === section);
            const sectionCals = meals.reduce((s,m)=>s+(m.calories||0),0);
            html += `<div class="mb-6">
                <div class="flex items-center justify-between gap-2 mb-3">
                    <div class="flex items-center gap-2">
                        <i data-lucide="${icons[section]}" class="w-4 h-4 text-slate-400"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase">${section}</h3>
                    </div>
                    ${sectionCals > 0 ? `<span class="text-[10px] font-bold text-slate-400">${Math.round(sectionCals)} kcal</span>` : ''}
                </div>
                ${meals.length===0 ? '<p class="text-xs text-slate-300 italic px-4">Nothing logged</p>' : ''}
                ${meals.map(m=>`<div class="nutrition-log-card flex items-center gap-4">
                    <img src="${m.image||'https://via.placeholder.com/100'}" class="w-12 h-12 object-contain bg-slate-50 rounded-lg p-1 flex-shrink-0" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm truncate">${m.name}</p>
                        <p class="text-xs text-slate-400">${m.amount} ‚Ä¢ ${m.calories}kcal ‚Ä¢ ${m.protein}g protein</p>
                    </div>
                    <button onclick="removeMeal(${m.id})" class="text-slate-300 hover:text-red-500 flex-shrink-0">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`).join('')}
            </div>`;
        });
        const mealSections = document.getElementById('meal-sections');
        if (mealSections) mealSections.innerHTML = html;
        lucide.createIcons();
    }

    function removeMeal(id) {
        state.dailyMeals = state.dailyMeals.filter(m => m.id !== id);
        saveState(); renderDiary(); renderDashboard();
        showToast('Item removed');
    }

    function changeNutritionDate(days) {
        const current = document.getElementById('nutrition-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current); date.setDate(date.getDate()+days);
        selectNutritionDate(date.toISOString().split('T')[0]);
    }

    function selectNutritionDate(dateStr) {
        state.viewDate = dateStr;
        const picker = document.getElementById('nutrition-date-picker');
        if (picker) picker.value = dateStr;
        const today = new Date().toISOString().split('T')[0];
        const isToday = dateStr === today;
        document.getElementById('nutrition-date-warning')?.classList.toggle('hidden', isToday);
        document.getElementById('nutrition-save-buttons')?.classList.toggle('hidden', isToday);
        renderDiary(); renderDashboard(); lucide.createIcons();
    }

    function saveNutritionChanges() {
        const today = new Date().toISOString().split('T')[0];
        if (state.viewDate !== today) {
            const meals = (state.dailyMeals || []).filter(m => m.date===state.viewDate);
            if (meals.length > 0) {
                const totalCals    = meals.reduce((sum,m)=>sum+(m.calories||0),0);
                const totalProtein = meals.reduce((sum,m)=>sum+(m.protein||0),0);
                state.nutritionHistory = (state.nutritionHistory || []).filter(h=>h.date!==state.viewDate);
                state.nutritionHistory.unshift({date:state.viewDate, calories:totalCals, protein:totalProtein, meals});
            }
        }
        saveState(); showToast('Changes saved!');
        selectNutritionDate(new Date().toISOString().split('T')[0]);
    }

    function cancelNutritionChanges() {
        loadState(); selectNutritionDate(new Date().toISOString().split('T')[0]);
        showToast('Changes cancelled');
    }

    function changeMetricsDate(days) {
        const current = document.getElementById('metrics-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current); date.setDate(date.getDate()+days);
        selectMetricsDate(date.toISOString().split('T')[0]);
    }

    function selectMetricsDate(dateStr) {
        state.metricsDate = dateStr;
        const picker = document.getElementById('metrics-date-picker');
        if (picker) picker.value = dateStr;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('metrics-date-warning')?.classList.toggle('hidden', dateStr===today);
        const existing = (state.metricsHistory || []).find(m => m.date===dateStr);
        if (existing) {
            ['weight','chest','shoulders','arms','waist','legs','glutes'].forEach(f => {
                const el = document.getElementById(`metric-${f}`);
                if (el) el.value = existing[f]||'';
            });
            if (existing.photos) {
                state.currentPhotos = {...existing.photos};
                ['front','side','back'].forEach(t => {
                    const img = document.getElementById(`photo-${t}-preview`);
                    if (img) { if(existing.photos[t]){img.src=existing.photos[t]; img.classList.remove('hidden');} else img.classList.add('hidden'); }
                });
            }
            showToast('Loaded metrics for '+new Date(dateStr+'T00:00:00').toLocaleDateString());
        } else {
            ['weight','chest','shoulders','arms','waist','legs','glutes'].forEach(f => {
                const el = document.getElementById(`metric-${f}`);
                if (el) el.value = '';
            });
            state.currentPhotos = {front:null,side:null,back:null};
            ['front','side','back'].forEach(t => { document.getElementById(`photo-${t}-preview`)?.classList.add('hidden'); });
        }
        lucide.createIcons();
    }

                        <div class="text-2xl font-black text-indigo-600">${Math.round(n.calories)}</div>
                        <div class="text-[10px] text-slate-400 uppercase">kcal</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-blue-50 p-2 rounded-xl text-center"><p class="text-xs font-black text-blue-600">${n.protein?.toFixed(1)||0}g</p><p class="text-[9px] text-slate-400 uppercase">Protein</p></div>
                    <div class="bg-amber-50 p-2 rounded-xl text-center"><p class="text-xs font-black text-amber-600">${n.carbs?.toFixed(1)||0}g</p><p class="text-[9px] text-slate-400 uppercase">Carbs</p></div>
                    <div class="bg-rose-50 p-2 rounded-xl text-center"><p class="text-xs font-black text-rose-600">${n.fat?.toFixed(1)||0}g</p><p class="text-[9px] text-slate-400 uppercase">Fat</p></div>
                </div>
                ${n.meals&&n.meals.length>0?`<div class="mt-3 pt-3 border-t border-slate-100"><p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Items</p><div class="flex flex-wrap gap-1">${n.meals.slice(0,5).map(m=>`<span class="text-[10px] bg-slate-100 px-2 py-1 rounded-full font-medium">${m.name}</span>`).join('')}${n.meals.length>5?`<span class="text-[10px] bg-slate-200 px-2 py-1 rounded-full font-medium">+${n.meals.length-5} more</span>`:''}</div></div>`:''}
                <div class="mt-3 flex justify-end">
                    <button onclick="deleteNutritionLog('${n.date}')" class="text-xs text-red-400 hover:text-red-600 font-bold">Delete</button>
                </div>
            </div>`).join('');
        const nutritionList = document.getElementById('nutrition-logs-list');
        if (nutritionList) nutritionList.innerHTML = nutritionHtml;
        lucide.createIcons();
    }

    function deleteNutritionLog(date) {
        if (confirm(`Delete nutrition log for ${date}?`)) {
            state.nutritionHistory = (state.nutritionHistory||[]).filter(n=>n.date!==date);
            saveState(); renderLogs(); renderProfile(); showToast('Log deleted');
        }
    }

    function filterWorkouts() {
        const showWeights = document.getElementById('filter-weights')?.checked;
        const showCardio  = document.getElementById('filter-cardio')?.checked;
        const showCore    = document.getElementById('filter-core')?.checked;
        const showWalking = document.getElementById('filter-walking')?.checked;
        const cardioKeywords = ['cardio','running','cycling','swimming','rowing','elliptical','treadmill','bike','run'];
        const coreKeywords   = ['core','plank','abs','crunch'];
        const walkKeywords   = ['walking','walk','hike','hiking'];

        const filtered = (state.workoutHistory||[]).filter(w=>{
            const focus = (w.focus||'').toLowerCase();
            const isCardio  = cardioKeywords.some(k=>focus.includes(k)) || (w.type==='cardio');
            const isCore    = coreKeywords.some(k=>focus.includes(k));
            const isWalking = walkKeywords.some(k=>focus.includes(k));
            const isWeights = !isCardio && !isCore && !isWalking;
            return (isWeights&&showWeights)||(isCardio&&showCardio)||(isCore&&showCore)||(isWalking&&showWalking);
        });

        const html = filtered.length===0 ? '<p class="text-center text-slate-400 py-10">No workouts logged yet</p>' :
            filtered.map(w=>{
                const focus = (w.focus||'').toLowerCase();
                const isCardio = ['cardio','running','cycling','swimming','rowing','elliptical','treadmill','bike','run'].some(k=>focus.includes(k))||w.type==='cardio';
                const isCore   = ['core','plank','abs','crunch'].some(k=>focus.includes(k));
                const icon = isCardio?'üèÉ':isCore?'üéØ':'üí™';
                const exerciseCount = (w.exercises||[]).length;
                return `<div class="glass-card p-5 rounded-[28px] log-entry">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${icon}</div>
                            <div>
                                <h4 class="font-bold">${w.focus}</h4>
                                <p class="text-xs text-slate-400">${new Date(w.date+'T00:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})} ¬∑ ${w.duration}</p>
                            </div>
                        </div>
                        <button onclick="deleteWorkout(${w.id})" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    ${exerciseCount>0?`<div class="space-y-2">${(w.exercises||[]).map(ex=>`<div class="bg-slate-50 px-4 py-2 rounded-xl flex justify-between items-center"><span class="font-medium text-sm">${ex.name}</span><span class="text-xs text-slate-400">${ex.sets?.length||0} sets</span></div>`).join('')}</div>`:''}
                    ${w.notes?`<p class="mt-3 text-xs text-slate-400 italic">${w.notes}</p>`:''}
                </div>`;
            }).join('');

        const list = document.getElementById('training-logs-list');
        if (list) list.innerHTML = html;
        lucide.createIcons();
    }

    function deleteWorkout(id) {
        if (confirm('Delete this workout?')) {
            state.workoutHistory = (state.workoutHistory||[]).filter(w=>w.id!==id);
            saveState(); filterWorkouts(); renderProfile(); renderDashboard(); showToast('Workout deleted');
        }
    }

    function renderHydrationLogs() {
        const hydrationLogs = state.hydrationLogs || {};
        const waterLogs = state.waterLogs || {};
        const allDates = [...new Set([...Object.keys(hydrationLogs), ...Object.keys(waterLogs)])].sort().reverse();
        const html = allDates.length===0 ? '<p class="text-xs text-slate-400 italic text-center py-4">No hydration data yet</p>' :
            allDates.map(date=>`<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                <span class="text-xs font-bold">${new Date(date+'T00:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}</span>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-black text-cyan-600">${((waterLogs[date]||0)/1000).toFixed(1)}L</span>
                    ${state.hydrationGoalCompletions?.[date] ? '<span class="text-xs text-emerald-600 font-black">‚úì Goal</span>' : ''}
                </div>
            </div>`).join('');
        const list = document.getElementById('hydration-logs-list');
        if (list) list.innerHTML = html;
    }

    // ==========================================================================
    // WATER & STEPS
    // ==========================================================================
    function addWater(ml) {
        if (!state.waterLogs) state.waterLogs={};
        state.waterLogs[state.viewDate] = Math.max(0, (state.waterLogs[state.viewDate]||0) + ml);
        saveState(); renderDashboard();
        showToast(ml>0 ? `+${ml}ml logged üíß` : `${ml}ml removed`);
    }

    function addSteps(steps) {
        if (!state.stepsLogs) state.stepsLogs={};
        state.stepsLogs[state.viewDate] = Math.max(0, (state.stepsLogs[state.viewDate]||0) + steps);
        saveState(); renderDashboard();
        showToast(steps>0 ? `+${steps.toLocaleString()} steps üëü` : `${steps.toLocaleString()} steps removed`);
    }

    // ==========================================================================
    // METRICS
    // ==========================================================================
    function saveMetrics() {
        const weight    = parseFloat(document.getElementById('metric-weight')?.value)||null;
        const chest     = parseFloat(document.getElementById('metric-chest')?.value)||null;
        const shoulders = parseFloat(document.getElementById('metric-shoulders')?.value)||null;
        const arms      = parseFloat(document.getElementById('metric-arms')?.value)||null;
        const waist     = parseFloat(document.getElementById('metric-waist')?.value)||null;
        const legs      = parseFloat(document.getElementById('metric-legs')?.value)||null;
        const glutes    = parseFloat(document.getElementById('metric-glutes')?.value)||null;
        if (!weight && !chest && !shoulders && !arms && !waist && !legs && !glutes) { showToast('Please enter at least one metric'); return; }
        const targetDate = state.metricsDate || new Date().toISOString().split('T')[0];
        const entry = { date:targetDate, weight, chest, shoulders, arms, waist, legs, glutes, photos:{...state.currentPhotos} };
        if (!state.metricsHistory) state.metricsHistory=[];
        const existing = state.metricsHistory.findIndex(m=>m.date===targetDate);
        if (existing>=0) state.metricsHistory[existing]=entry;
        else state.metricsHistory.unshift(entry);
        state.metricsHistory.sort((a,b)=>new Date(b.date)-new Date(a.date));
        saveState(); renderDashboard();
        showToast(`Metrics saved for ${new Date(targetDate+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})}! üìä`);
    }

    function triggerPhotoUpload(type) {
        currentPhotoType=type;
        const input = document.getElementById('photo-upload-input');
        if (input) { input.onchange=(e)=>handlePhotoUpload(e,type); input.click(); }
    }

    function handlePhotoUpload(event, type) {
        const file = event.target.files[0]; if(!file) return;
        const maxSize = 2*1024*1024;
        if (file.size>maxSize) { showToast('Image too large. Please use an image under 2MB'); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_DIM = 800;
                let {width,height} = img;
                if (width>height){ if(width>MAX_DIM){height=Math.round(height*MAX_DIM/width);width=MAX_DIM;} }
                else { if(height>MAX_DIM){width=Math.round(width*MAX_DIM/height);height=MAX_DIM;} }
                canvas.width=width; canvas.height=height;
                canvas.getContext('2d').drawImage(img,0,0,width,height);
                const compressed = canvas.toDataURL('image/jpeg',0.7);
                if (!state.currentPhotos) state.currentPhotos={};
                state.currentPhotos[type] = compressed;
                const preview = document.getElementById(`photo-${type}-preview`);
                if (preview) { preview.src=compressed; preview.classList.remove('hidden'); }
                showToast(`${type.charAt(0).toUpperCase()+type.slice(1)} photo uploaded!`);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // ==========================================================================
    // CARDIO LOGGING
    // ==========================================================================
    function openCardioModal() {
        document.getElementById('cardio-modal').style.display='flex';
        document.getElementById('cardio-duration').value='';
        document.getElementById('cardio-distance').value='';
        document.getElementById('cardio-calories').value='';
        document.getElementById('cardio-notes').value='';
        lucide.createIcons();
    }
    function closeCardioModal() { document.getElementById('cardio-modal').style.display='none'; }
    function saveCardio() {
        const type     = document.getElementById('cardio-type')?.value;
        const duration = parseFloat(document.getElementById('cardio-duration')?.value)||0;
        const distance = parseFloat(document.getElementById('cardio-distance')?.value)||0;
        const calories = parseFloat(document.getElementById('cardio-calories')?.value)||0;
        const notes    = document.getElementById('cardio-notes')?.value.trim();
        if (!duration) { showToast('Please enter duration'); return; }
        const workoutDate = document.getElementById('workout-date-picker')?.value || new Date().toISOString().split('T')[0];
        const emoji = {running:'üèÉ',cycling:'üö¥',swimming:'üèä',walking:'üö∂',hiking:'‚õ∞Ô∏è',rowing:'üö£',elliptical:'‚ö°'}[type]||'üèÉ';
        state.workoutHistory.unshift({ id:Date.now(), date:workoutDate, type:'cardio', focus:`${emoji} ${type.charAt(0).toUpperCase()+type.slice(1)}`, duration:`${duration}min${distance?` ¬∑ ${distance}km`:''}`, exercises:[], calories, notes, distance });
        saveState(); closeCardioModal(); renderDashboard(); showToast('Activity logged! üèÉ');
    }

    // ==========================================================================
    // EXERCISE DEMO
    // ==========================================================================
    const EXERCISE_INFO = {
        'Bench Press': { instructions:['Lie flat on bench with feet on floor','Grip bar slightly wider than shoulder width','Lower bar to lower chest with control','Press up explosively to starting position'], muscles:['Chest','Triceps','Anterior Deltoids'], tips:['Keep shoulder blades retracted throughout','Maintain slight arch in lower back','Avoid bouncing bar off chest'] },
        'Barbell Squat': { instructions:['Position bar on upper traps','Stand feet shoulder-width apart','Descend by pushing hips back and bending knees','Drive through heels to return to start'], muscles:['Quads','Glutes','Hamstrings','Core'], tips:['Keep chest tall and core braced','Knees should track over toes','Aim for thighs parallel or below'] },
        'Deadlift': { instructions:['Stand with feet hip-width apart, bar over mid-foot','Hinge at hips to grip bar shoulder-width','Brace core, lift chest and engage lats','Drive hips through and stand up tall'], muscles:['Hamstrings','Glutes','Back','Traps','Core'], tips:['Keep bar close to body throughout','Do not round lower back','Breathe in before lifting'] },
        'Pull Ups': { instructions:['Hang from bar with hands shoulder-width apart','Pull elbows down toward hips','Chin over bar at top','Lower with control'], muscles:['Lats','Biceps','Rear Deltoids'], tips:['Avoid swinging or kipping','Squeeze shoulder blades together','Use full range of motion'] },
        'Overhead Press': { instructions:['Grip bar at shoulder width','Press directly overhead','Tuck chin to allow bar to clear face','Lock out arms at top'], muscles:['Shoulders','Triceps','Upper Chest'], tips:['Squeeze glutes and abs for stability','Avoid excessive lumbar extension','Look straight ahead throughout'] }
    };

    function showExerciseDemo(exerciseName) {
        const info = EXERCISE_INFO[exerciseName] || { instructions:['No specific instructions available for this exercise.'], muscles:['Various muscle groups'], tips:['Focus on proper form','Control the weight throughout','Breathe steadily'] };
        document.getElementById('demo-exercise-name').innerText = exerciseName;
        const instructionsEl = document.getElementById('demo-instructions');
        if (instructionsEl) instructionsEl.innerHTML = info.instructions.map((step,i)=>`<div class="flex gap-3 items-start p-3 bg-slate-50 rounded-xl"><span class="w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">${i+1}</span><span>${step}</span></div>`).join('');
        const musclesEl = document.getElementById('demo-muscles');
        if (musclesEl) musclesEl.innerHTML = (info.muscles||[]).map(m=>`<span class="muscle-tag">${m}</span>`).join('');
        const tipsEl = document.getElementById('demo-tips');
        if (tipsEl) tipsEl.innerHTML = (info.tips||[]).map(t=>`<div class="flex gap-2 items-start p-3 bg-amber-50 rounded-xl"><span class="text-amber-500">üí°</span><span>${t}</span></div>`).join('');
        const videoContainer = document.getElementById('demo-video-container');
        if (videoContainer) { const searchQuery = encodeURIComponent(`${exerciseName} proper form tutorial`); videoContainer.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center bg-slate-100 rounded-2xl gap-3"><i data-lucide="video" class="w-12 h-12 text-slate-300"></i><p class="text-slate-400 text-sm font-bold">Video Tutorial</p><a href="https://www.youtube.com/results?search_query=${searchQuery}" target="_blank" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-red-600">Watch on YouTube</a></div>`; }
        document.getElementById('exercise-demo-modal').style.display='flex'; lucide.createIcons();
    }
    function closeExerciseDemo() { document.getElementById('exercise-demo-modal').style.display='none'; }

    // ==========================================================================
    // SETTINGS
    // ==========================================================================
    function renderSettings() {
        const calorieGoalInput = document.getElementById('calorie-goal-input');
        if (calorieGoalInput) calorieGoalInput.value = state.goals?.calories||2500;
        const proteinGoalInput = document.getElementById('protein-goal-input');
        if (proteinGoalInput) proteinGoalInput.value = state.goals?.protein||150;
        const waterGoalInput = document.getElementById('water-goal-input');
        if (waterGoalInput) waterGoalInput.value = state.goals?.water||2500;
        const stepsGoalInput = document.getElementById('steps-goal-input');
        if (stepsGoalInput) stepsGoalInput.value = state.goals?.steps||10000;

        const gymList  = document.getElementById('gym-equipment-list');
        const homeList = document.getElementById('home-equipment-list');
        if (gymList) gymList.innerHTML = Object.entries(state.equipment?.gym||{}).map(([item,selected])=>`<label class="equipment-chip cursor-pointer select-none ${selected?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600'} transition-all"><input type="checkbox" class="hidden" ${selected?'checked':''} onchange="toggleEquipment('gym','${item}',this.checked)">${item}</label>`).join('');
        if (homeList) homeList.innerHTML = Object.entries(state.equipment?.home||{}).map(([item,selected])=>`<label class="equipment-chip cursor-pointer select-none ${selected?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600'} transition-all"><input type="checkbox" class="hidden" ${selected?'checked':''} onchange="toggleEquipment('home','${item}',this.checked)">${item}</label>`).join('');

        const habitsEnabled = document.getElementById('habits-enabled');
        if (habitsEnabled) habitsEnabled.checked = state.habitsEnabled||false;
        const habitsSection = document.getElementById('habits-section');
        if (habitsSection) habitsSection.classList.toggle('hidden', !state.habitsEnabled);
        renderHabitsList();
        renderGoalsList();
        const trackHydration = document.getElementById('track-hydration');
        if (trackHydration) trackHydration.checked = state.trackHydration!==false;
        const trackSteps = document.getElementById('track-steps');
        if (trackSteps) trackSteps.checked = state.trackSteps!==false;
    }

    function updateCalorieGoal(val) { if (!state.goals) state.goals={}; state.goals.calories=parseInt(val)||2500; }
    function toggleEquipment(env, item, checked) { if(!state.equipment) state.equipment={gym:{},home:{}}; state.equipment[env][item]=checked; }

    function saveSettings() {
        if (!state.goals) state.goals={};
        state.goals.calories = parseInt(document.getElementById('calorie-goal-input')?.value)||2500;
        state.goals.protein  = parseInt(document.getElementById('protein-goal-input')?.value)||150;
        state.goals.water    = parseInt(document.getElementById('water-goal-input')?.value)||2500;
        state.goals.steps    = parseInt(document.getElementById('steps-goal-input')?.value)||10000;
        state.trackHydration = document.getElementById('track-hydration')?.checked!==false;
        state.trackSteps     = document.getElementById('track-steps')?.checked!==false;
        toggleTracking('hydration'); toggleTracking('steps');
        saveState(); renderDashboard(); showToast('Settings saved!');
    }

    function toggleTracking(type) {
        const isOn = type==='hydration' ? state.trackHydration!==false : state.trackSteps!==false;
        const el   = type==='hydration' ? document.getElementById('hydration-tracker') : document.getElementById('steps-tracker');
        if (el) el.classList.toggle('hidden', !isOn);
    }

    function toggleHabits() {
        state.habitsEnabled = document.getElementById('habits-enabled')?.checked||false;
        document.getElementById('habits-section')?.classList.toggle('hidden', !state.habitsEnabled);
        if (state.habitsEnabled) document.getElementById('habits-tracker')?.classList.remove('hidden');
        else document.getElementById('habits-tracker')?.classList.add('hidden');
        saveState();
    }

    function addHabit() {
        const input = document.getElementById('new-habit-input');
        const name  = input?.value.trim(); if(!name) return;
        if (!state.habits) state.habits=[];
        state.habits.push({ id:Date.now(), name });
        saveState(); renderHabitsList(); renderDashboardHabits();
        if (input) input.value='';
    }

    function renderHabitsList() {
        const html = (state.habits||[]).map((h,idx)=>`<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
            <span class="flex-1 font-medium text-sm">${h.name}</span>
            <button onclick="state.habits.splice(${idx},1);saveState();renderHabitsList();renderDashboardHabits();" class="text-red-400 hover:text-red-600 font-bold text-xl">√ó</button>
        </div>`).join('');
        const list = document.getElementById('habits-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-300 italic text-center py-2">No habits yet</p>';
    }

    function renderDashboardHabits() {
        const today = state.viewDate || new Date().toISOString().split('T')[0];
        if (!state.habitCompletions) state.habitCompletions={};
        const completed = (state.habitCompletions[today]||[]);
        const html = (state.habits||[]).map(h=>{ const isDone=completed.includes(h.id); return `<button onclick="toggleHabit('${h.id}')" class="flex items-center gap-3 w-full p-3 rounded-xl ${isDone?'bg-purple-600 text-white':'bg-slate-50'} transition-all">
            <div class="w-6 h-6 rounded-full border-2 ${isDone?'border-white bg-white/30 text-white':'border-slate-300'} flex items-center justify-center flex-shrink-0"><i data-lucide="check" class="w-4 h-4 ${isDone?'':'text-transparent'}"></i></div>
            <span class="font-bold text-sm flex-1 text-left ${isDone?'line-through opacity-75':''}">${h.name}</span>
        </button>`; }).join('');
        const list  = document.getElementById('dashboard-habits-list');
        const badge = document.getElementById('habit-completion-badge');
        if (list)  list.innerHTML = html;
        if (badge) badge.innerText = `${completed.length}/${(state.habits||[]).length}`;
        lucide.createIcons();
    }

    function toggleHabit(id) {
        const today = state.viewDate || new Date().toISOString().split('T')[0];
        if (!state.habitCompletions) state.habitCompletions={};
        if (!state.habitCompletions[today]) state.habitCompletions[today]=[];
        const idx = state.habitCompletions[today].indexOf(id);
        if (idx>=0) state.habitCompletions[today].splice(idx,1);
        else state.habitCompletions[today].push(id);
        saveState(); renderDashboardHabits();
    }

    // ==========================================================================
    // GOALS
    // ==========================================================================
    function openGoalSetting() {
        const deadline = document.getElementById('goal-deadline');
        if (deadline) { const d=new Date(); d.setMonth(d.getMonth()+1); deadline.value=d.toISOString().split('T')[0]; }
        document.getElementById('goal-description').value='';
        document.getElementById('goal-modal').style.display='flex'; lucide.createIcons();
    }
    function closeGoalModal() { document.getElementById('goal-modal').style.display='none'; }
    function saveGoal() {
        const type  = document.getElementById('goal-type')?.value;
        const desc  = document.getElementById('goal-description')?.value.trim();
        const deadline = document.getElementById('goal-deadline')?.value;
        if (!desc) { showToast('Please describe your goal'); return; }
        if (!state.userGoals) state.userGoals=[];
        state.userGoals.push({ id:Date.now(), type, description:desc, deadline, createdAt:new Date().toISOString(), completed:false });
        saveState(); closeGoalModal(); renderGoalsList(); showToast('Goal set!');
    }
    function renderGoalsList() {
        const html = (state.userGoals||[]).map(g=>{
            const cls = g.type==='short'?'goal-short':g.type==='medium'?'goal-medium':'goal-long';
            const label = g.type==='short'?'Short-term':g.type==='medium'?'Medium-term':'Long-term';
            return `<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl ${g.completed?'opacity-60':''}">
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm ${g.completed?'line-through':''}">${g.description}</p>
                    <div class="flex items-center gap-2 mt-1"><span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${cls}">${label}</span>${g.deadline?`<span class="text-[10px] text-slate-400">By ${new Date(g.deadline+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</span>`:''}</div>
                </div>
                <button onclick="toggleGoal(${g.id})" class="w-8 h-8 rounded-full ${g.completed?'bg-emerald-500 text-white':'border-2 border-slate-300'} flex items-center justify-center hover:scale-110 transition-all"><i data-lucide="check" class="w-4 h-4 ${g.completed?'':'text-transparent'}"></i></button>
                <button onclick="deleteGoal(${g.id})" class="text-slate-300 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>`;
        }).join('');
        const list = document.getElementById('goals-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-300 italic text-center py-2">No goals set yet</p>';
        lucide.createIcons();
    }
    function toggleGoal(id) { const g=(state.userGoals||[]).find(g=>g.id===id); if(g){ g.completed=!g.completed; saveState(); renderGoalsList(); showToast(g.completed?'Goal completed! üéâ':'Goal reopened'); } }
    function deleteGoal(id) { state.userGoals=(state.userGoals||[]).filter(g=>g.id!==id); saveState(); renderGoalsList(); showToast('Goal removed'); }

    // ==========================================================================
    // METRICS CHART
    // ==========================================================================
    function openMetricsChart() {
        document.getElementById('metrics-chart-modal').style.display='flex';
        renderMetricChart(); lucide.createIcons();
    }
    function closeMetricsChart() { document.getElementById('metrics-chart-modal').style.display='none'; }
    function renderMetricChart() {
        const metric = document.getElementById('chart-metric-select')?.value||'weight';
        const data   = (state.metricsHistory||[]).filter(m=>m[metric]!=null).map(m=>({ date:m.date, value:parseFloat(m[metric]) })).sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(-20);
        const canvas = document.getElementById('metrics-chart');
        if (!canvas) return;
        if (metricsChart) { metricsChart.destroy(); metricsChart=null; }
        if (data.length===0) { canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height); return; }
        metricsChart = new Chart(canvas, { type:'line', data:{ labels:data.map(d=>new Date(d.date+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})), datasets:[{ label:metric.charAt(0).toUpperCase()+metric.slice(1), data:data.map(d=>d.value), borderColor:'#4f46e5', backgroundColor:'rgba(79,70,229,0.1)', borderWidth:3, pointBackgroundColor:'#4f46e5', pointRadius:5, fill:true, tension:0.4 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ grid:{color:'rgba(0,0,0,0.05)'}, ticks:{color:'#94a3b8',font:{weight:'bold'}} }, x:{ grid:{display:false}, ticks:{color:'#94a3b8',font:{weight:'bold'}} } } } });
    }

    // ==========================================================================
    // PHOTO COMPARISON
    // ==========================================================================
    let comparePhotoType = 'front';
    function openPhotoComparison() {
        document.getElementById('photo-comparison-modal').style.display='flex';
        const dates = [...new Set((state.metricsHistory||[]).filter(m=>m.photos).map(m=>m.date))].sort();
        const populateDates = (selectId) => {
            const sel = document.getElementById(selectId);
            if (!sel) return;
            sel.innerHTML = '<option value="">Select date...</option>';
            dates.forEach(d=>{ const opt=document.createElement('option'); opt.value=d; opt.text=new Date(d+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); sel.appendChild(opt); });
        };
        populateDates('compare-date-1'); populateDates('compare-date-2');
        setComparePhotoType('front'); lucide.createIcons();
    }
    function closePhotoComparison() { document.getElementById('photo-comparison-modal').style.display='none'; }
    function setComparePhotoType(type) {
        comparePhotoType=type;
        ['front','side','back'].forEach(t=>{ const btn=document.getElementById(`compare-type-${t}`); if(btn) btn.className=`p-4 rounded-2xl font-bold text-sm ${t===type?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600'}`; });
        loadComparisonPhotos();
    }
    function loadComparisonPhotos() {
        const date1 = document.getElementById('compare-date-1')?.value;
        const date2 = document.getElementById('compare-date-2')?.value;
        const viewEl = document.getElementById('comparison-view');
        const noMsgEl = document.getElementById('no-comparison-message');
        if (!date1||!date2) { viewEl?.classList.add('hidden'); noMsgEl?.classList.remove('hidden'); return; }
        const m1 = (state.metricsHistory||[]).find(m=>m.date===date1);
        const m2 = (state.metricsHistory||[]).find(m=>m.date===date2);
        const photo1 = m1?.photos?.[comparePhotoType];
        const photo2 = m2?.photos?.[comparePhotoType];
        if (!photo1&&!photo2) { viewEl?.classList.add('hidden'); noMsgEl?.classList.remove('hidden'); noMsgEl.innerHTML='<i data-lucide="images" class="w-16 h-16 mx-auto mb-4 opacity-50"></i><p class="font-bold">No photos available for selected dates & angle</p>'; lucide.createIcons(); return; }
        viewEl?.classList.remove('hidden'); noMsgEl?.classList.add('hidden');
        const img1 = document.getElementById('compare-img-1');
        const img2 = document.getElementById('compare-img-2');
        const label1 = document.getElementById('compare-label-1');
        const label2 = document.getElementById('compare-label-2');
        if (img1) img1.src = photo1||'https://via.placeholder.com/300x400?text=No+Photo';
        if (img2) img2.src = photo2||'https://via.placeholder.com/300x400?text=No+Photo';
        if (label1) label1.textContent = new Date(date1+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
        if (label2) label2.textContent = new Date(date2+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    }

    // ==========================================================================
    // INITIALISATION
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        const datePickers = ['workout-date-picker','nutrition-date-picker','metrics-date-picker'];
        datePickers.forEach(id => { const el=document.getElementById(id); if(el) el.value=today; });
        window.selectedWorkoutDate = today;
        state.viewDate = today;
        state.metricsDate = today;
        lucide.createIcons();
    });

    </script>
</body>
</html>

