<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTrack Pro - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #f43f5e;
            --bg-main: #f8fafc;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .photo-slot {
            aspect-ratio: 3/4; background: #f1f5f9; border-radius: 1.5rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; border: 2px dashed #e2e8f0; position: relative;
            transition: all 0.2s;
        }
        .photo-slot:hover { border-color: var(--brand-primary); transform: scale(1.02); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px;
        }

        .muscle-chip.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .store-dropdown { animation: dropdownPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropdownPop {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px;
            font-size: 14px; font-weight: 600; z-index: 1000; opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        button { 
            transition: all 0.2s ease;
            min-height: 44px; /* Better touch target */
        }
        button:active { 
            transform: scale(0.97); 
        }
        button:focus-visible { 
            outline: 2px solid var(--brand-primary); 
            outline-offset: 2px; 
        }

        /* Better touch targets for inputs */
        input, select {
            min-height: 48px;
            font-size: 16px; /* Prevent zoom on iOS */
        }

        /* Larger tap areas for navigation */
        .nav-item {
            padding: 12px;
            min-width: 64px;
            min-height: 64px;
        }

        /* Smoother photo slot interactions */
        .photo-slot {
            min-height: 200px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .photo-slot:active {
            transform: scale(0.98);
        }

        /* Better modal transitions */
        .modal-overlay {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="pb-28">

    <div id="toast" class="toast"></div>

    <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 py-5 sticky top-0 z-40 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">FitTrack<span class="text-slate-600">Pro</span></h1>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <p id="status-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Loading...</p>
            </div>
        </div>
        <button onclick="switchTab('settings')" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Settings">
            <i data-lucide="settings" class="w-6 h-6 text-slate-700"></i>
        </button>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="tab-content active space-y-6">
            <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center relative overflow-hidden">
                <div class="relative w-48 h-48 flex items-center justify-center">
                    <svg class="w-full h-full" viewBox="0 0 192 192">
                        <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                        <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                    </svg>
                    <div class="absolute text-center">
                        <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Eaten</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                    <div class="text-center"><div id="dash-protein" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Protein</div></div>
                    <div class="text-center border-x"><div id="dash-carbs" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Carbs</div></div>
                    <div class="text-center"><div id="dash-fat" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Fats</div></div>
                </div>
            </div>

            <div class="glass-card rounded-[2.5rem] p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center"><i data-lucide="droplet" class="text-cyan-500"></i></div>
                    <div><h4 class="font-bold">Hydration</h4><p id="water-count" class="text-xs text-slate-500">0 / 2.5L</p></div>
                </div>
                <div class="flex gap-3">
                    <button onclick="updateWater(-250)" class="w-14 h-14 rounded-2xl bg-slate-50 text-xl font-bold hover:bg-slate-100 active:bg-slate-200">-</button>
                    <button onclick="updateWater(250)" class="w-14 h-14 rounded-2xl bg-cyan-500 text-white shadow-lg text-2xl font-bold hover:bg-cyan-600 active:bg-cyan-700">+</button>
                </div>
            </div>

            <div class="glass-card rounded-[2.5rem] p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center"><i data-lucide="footprints" class="text-amber-500"></i></div>
                        <div><h4 class="font-bold">Steps</h4><p id="steps-count" class="text-xs text-slate-500">0 / 10,000</p></div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="updateSteps(-500)" class="flex-1 h-14 rounded-2xl bg-slate-50 text-slate-600 font-bold text-lg hover:bg-slate-100 active:bg-slate-200">-500</button>
                    <button onclick="updateSteps(500)" class="flex-1 h-14 rounded-2xl bg-amber-500 text-white font-bold text-lg hover:bg-amber-600 active:bg-amber-700">+500</button>
                </div>
            </div>

            <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-xl">
                <h3 class="text-lg font-bold mb-1">Weekly Overview</h3>
                <div id="muscle-volume-stats" class="grid grid-cols-2 gap-y-3 gap-x-6 mb-6"></div>
                <button onclick="switchTab('training')" class="bg-indigo-600 px-6 py-3 rounded-2xl font-bold text-xs uppercase">Log Workout</button>
            </div>
        </section>

        <!-- TRAINING -->
        <section id="training" class="tab-content space-y-6">
            <div id="workout-setup" class="glass-card p-6 rounded-[2.5rem] space-y-4">
                <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                    <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Gym</button>
                    <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-slate-400">Home</button>
                </div>
                
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Exercise Focus</label>
                    <select id="workout-focus" onchange="toggleSpecificMuscle()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                        <option>Full Body</option>
                        <option>Upper</option>
                        <option>Lower</option>
                        <option>Push</option>
                        <option>Pull</option>
                        <option>Legs</option>
                        <option>Specific Muscle</option>
                    </select>
                </div>

                <div id="specific-muscle-container" class="hidden">
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Muscle</label>
                    <select id="specific-muscle" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                        <option>Chest</option>
                        <option>Back</option>
                        <option>Shoulders</option>
                        <option>Biceps</option>
                        <option>Triceps</option>
                        <option>Quads</option>
                        <option>Hamstrings</option>
                        <option>Glutes</option>
                        <option>Calves</option>
                    </select>
                </div>

                <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-black uppercase text-slate-600">Add Cardio</span>
                        <input type="checkbox" id="add-cardio-check" class="w-5 h-5 accent-indigo-600">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-black uppercase text-slate-600">Add Core</span>
                        <input type="checkbox" id="add-core-check" class="w-5 h-5 accent-indigo-600">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="startWorkout('manual')" class="p-5 bg-slate-900 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-slate-800 active:bg-slate-700">Manual Entry</button>
                    <button onclick="startWorkout('ai')" class="p-5 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-indigo-700 active:bg-indigo-800">AI Generate</button>
                </div>
            </div>

            <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div>
                        <h3 id="active-workout-title" class="text-xl font-black">Workout</h3>
                        <p id="workout-timer" class="text-indigo-600 font-bold">00:00:00</p>
                    </div>
                    <button onclick="cancelWorkout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl">×</button>
                </div>
                <div id="exercise-list" class="space-y-4 mb-6"></div>
                <button onclick="addExercise()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs mb-4">+ Add Exercise</button>
                <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold">Finish Workout</button>
            </div>
        </section>

        <!-- NUTRITION -->
        <section id="nutrition" class="tab-content space-y-6">
            <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                <button onclick="setNutritionTab('diary')" id="nut-tab-diary" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Diary</button>
                <button onclick="setNutritionTab('search')" id="nut-tab-search" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Search</button>
            </div>

            <!-- DIARY TAB -->
            <div id="nut-view-diary" class="space-y-6">
                <div class="bg-white rounded-[32px] p-8 border border-slate-100 shadow-xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <div id="total-kcal" class="text-5xl font-black text-slate-900 mb-1">0</div>
                            <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Calories Today</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-black text-blue-600 flex items-center gap-1 justify-end">
                                <i data-lucide="zap" class="w-5 h-5 fill-current"></i> <span id="total-protein">0.0</span>g
                            </div>
                            <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Protein</div>
                        </div>
                    </div>
                </div>

                <div id="meal-sections"></div>
            </div>

            <!-- SEARCH TAB -->
            <div id="nut-view-search" class="hidden space-y-6">
                <div>
                    <label class="text-xs font-semibold text-slate-400 ml-1 mb-2 block">Store</label>
                    <select id="store-select" class="w-full p-4 bg-white rounded-3xl border border-slate-100 font-medium outline-none">
                        <option value="all">All Stores</option>
                        <option value="tesco">Tesco</option>
                        <option value="sainsburys">Sainsbury's</option>
                        <option value="asda">ASDA</option>
                        <option value="morrisons">Morrisons</option>
                        <option value="aldi">Aldi</option>
                        <option value="lidl">Lidl</option>
                        <option value="waitrose">Waitrose</option>
                        <option value="coop">Co-op</option>
                        <option value="iceland">Iceland</option>
                        <option value="costco">Costco</option>
                        <option value="marks">M&S Food</option>
                        <option value="ocado">Ocado</option>
                        <option value="farmfoods">Farmfoods</option>
                        <option value="booths">Booths</option>
                        <option value="budgens">Budgens</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                        <input id="food-search-input" type="text" placeholder="Search food..." 
                            class="w-full bg-slate-100 border-2 border-transparent rounded-[20px] py-4 pl-12 pr-4 focus:bg-white focus:border-emerald-500 outline-none font-semibold">
                    </div>
                    <button onclick="openBarcodeScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center">
                        <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                    </button>
                </div>

                <button onclick="openCreateMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold">
                    Create Meal
                </button>

                <div id="created-meals-list" class="space-y-3"></div>

                <div id="search-loading" class="hidden py-20 text-center">
                    <i data-lucide="loader-2" class="animate-spin text-emerald-500 mx-auto"></i>
                </div>
                <div id="search-results-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- LOGS -->
        <section id="logs" class="tab-content space-y-6">
            <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                <button onclick="setLogsTab('training')" id="logs-tab-training" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Training</button>
                <button onclick="setLogsTab('nutrition')" id="logs-tab-nutrition" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Nutrition</button>
            </div>
            
            <div id="logs-training-view" class="space-y-4">
                <div id="training-logs-list"></div>
            </div>

            <div id="logs-nutrition-view" class="hidden space-y-4">
                <div id="nutrition-logs-list"></div>
            </div>
        </section>

        <!-- BODY METRICS -->
        <section id="metrics" class="tab-content space-y-6">
            <div class="glass-card p-8 rounded-[3rem] space-y-8">
                <div class="bg-slate-50 p-6 rounded-3xl text-center border">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2">Weight (kg)</span>
                    <input id="metric-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-transparent text-center text-5xl font-black outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Chest (cm)</label>
                        <input id="metric-chest" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Shoulders (cm)</label>
                        <input id="metric-shoulders" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Arms (cm)</label>
                        <input id="metric-arms" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Waist (cm)</label>
                        <input id="metric-waist" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Legs (cm)</label>
                        <input id="metric-legs" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Glutes (cm)</label>
                        <input id="metric-glutes" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                </div>

                <!-- PROGRESS PHOTOS -->
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black uppercase text-slate-400 text-center">Progress Photos</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="photo-slot" onclick="triggerPhotoUpload('front')">
                            <img id="photo-front-preview" class="hidden" alt="Front">
                            <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                            <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Front</span>
                        </div>
                        <div class="photo-slot" onclick="triggerPhotoUpload('side')">
                            <img id="photo-side-preview" class="hidden" alt="Side">
                            <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                            <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Side</span>
                        </div>
                        <div class="photo-slot" onclick="triggerPhotoUpload('back')">
                            <img id="photo-back-preview" class="hidden" alt="Back">
                            <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                            <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Back</span>
                        </div>
                    </div>
                    <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                </div>

                <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase">
                    Save Metrics
                </button>
            </div>

            <!-- VIEW OPTIONS BUTTONS -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openMetricsChart()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                    <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="line-chart" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                    <h4 class="font-bold text-sm mb-1">Progress Charts</h4>
                    <p class="text-xs text-slate-400">View trends</p>
                </button>

                <button onclick="openPhotoComparison()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                    <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="images" class="w-6 h-6 text-emerald-600"></i>
                    </div>
                    <h4 class="font-bold text-sm mb-1">Compare Photos</h4>
                    <p class="text-xs text-slate-400">Side by side</p>
                </button>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings" class="tab-content space-y-6">
            <div class="glass-card p-6 rounded-[2.5rem] space-y-8">
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Calorie Goal</label>
                    <input id="calorie-goal-input" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-bold" onchange="updateCalorieGoal(this.value)">
                </div>

                <div>
                    <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Gym Equipment</h3>
                    <div id="gym-equipment-list" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div>
                    <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Home Equipment</h3>
                    <div id="home-equipment-list" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t px-6 py-4 flex justify-between items-center z-50">
        <button onclick="switchTab('dashboard')" data-tab="dashboard" class="nav-item flex flex-col items-center gap-1.5 text-indigo-600">
            <div class="w-12 h-8 rounded-full flex items-center justify-center bg-indigo-50"><i data-lucide="layout-grid"></i></div>
        </button>
        <button onclick="switchTab('training')" data-tab="training" class="nav-item flex flex-col items-center gap-1.5 text-slate-300">
            <div class="w-12 h-8 rounded-full flex items-center justify-center"><i data-lucide="dumbbell"></i></div>
        </button>
        <button onclick="switchTab('nutrition')" data-tab="nutrition" class="nav-item flex flex-col items-center gap-1.5 text-slate-300">
            <div class="w-12 h-8 rounded-full flex items-center justify-center"><i data-lucide="apple"></i></div>
        </button>
        <button onclick="switchTab('logs')" data-tab="logs" class="nav-item flex flex-col items-center gap-1.5 text-slate-300">
            <div class="w-12 h-8 rounded-full flex items-center justify-center"><i data-lucide="calendar"></i></div>
        </button>
        <button onclick="switchTab('metrics')" data-tab="metrics" class="nav-item flex flex-col items-center gap-1.5 text-slate-300">
            <div class="w-12 h-8 rounded-full flex items-center justify-center"><i data-lucide="scale"></i></div>
        </button>
    </nav>

    <!-- FOOD ITEM POPUP -->
    <div id="food-popup" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex flex-col items-center mb-6">
                <div class="w-24 h-24 bg-slate-50 rounded-2xl overflow-hidden mb-4 p-2">
                    <img id="popup-image" src="" class="w-full h-full object-contain" alt="">
                </div>
                <h2 id="popup-name" class="text-xl font-black text-center leading-tight mb-1">Product</h2>
                <p id="popup-nutrition" class="text-sm text-slate-500"></p>
            </div>

            <div class="mb-4">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Meal Type</label>
                <select id="popup-meal-type" class="w-full p-3 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>

            <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                <button onclick="setAmountType('portion')" id="amount-type-portion" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase bg-white shadow text-emerald-600">Portion</button>
                <button onclick="setAmountType('grams')" id="amount-type-grams" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase text-slate-400">Grams</button>
            </div>

            <div class="mb-6">
                <input id="popup-amount" type="number" value="1" class="w-full bg-slate-50 border-4 border-slate-100 rounded-[24px] py-6 text-4xl font-black text-center outline-none focus:border-emerald-500">
            </div>

            <div class="bg-slate-50 p-4 rounded-2xl mb-6 flex justify-around">
                <div class="text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Total Kcal</p>
                    <p id="popup-total-kcal" class="font-black text-lg">0</p>
                </div>
                <div class="w-px h-8 bg-slate-200 mt-2"></div>
                <div class="text-center">
                    <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Total Protein</p>
                    <p id="popup-total-protein" class="font-black text-lg text-blue-600">0g</p>
                </div>
            </div>

            <button onclick="addFoodItem()" class="w-full bg-slate-900 text-white py-6 rounded-[24px] font-black mb-3">Add to Diary</button>
            <button onclick="closeFoodPopup()" class="w-full py-4 text-xs font-black text-slate-300 uppercase">Close</button>
        </div>
    </div>

    <!-- BARCODE SCANNER MODAL -->
    <div id="barcode-scanner-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black">Scan Barcode</h3>
                <button onclick="closeBarcodeScanner()" class="w-10 h-10 bg-slate-100 rounded-full">×</button>
            </div>
            <div id="barcode-reader" class="w-full h-64 bg-black rounded-2xl mb-4"></div>
            <div class="flex gap-2">
                <input id="manual-barcode" type="text" placeholder="Or enter barcode manually..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="lookupBarcode()" class="bg-slate-900 text-white px-6 rounded-xl">Search</button>
            </div>
        </div>
    </div>

    <!-- CREATE MEAL MODAL -->
    <div id="create-meal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Create Meal</h3>
                <button onclick="closeCreateMeal()" class="w-10 h-10 bg-slate-100 rounded-full">×</button>
            </div>

            <div class="mb-4">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Meal Name *</label>
                <input id="meal-name-input" type="text" placeholder="e.g. Chicken & Rice Bowl" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>

            <div class="mb-4">
                <label class="text-xs font-semibold text-slate-400 mb-2 block">Store</label>
                <select id="meal-store-select" class="w-full p-3 bg-slate-50 rounded-2xl font-medium outline-none">
                    <option value="all">All Stores</option>
                    <option value="tesco">Tesco</option>
                    <option value="sainsburys">Sainsbury's</option>
                    <option value="asda">ASDA</option>
                    <option value="morrisons">Morrisons</option>
                    <option value="aldi">Aldi</option>
                    <option value="lidl">Lidl</option>
                    <option value="waitrose">Waitrose</option>
                    <option value="coop">Co-op</option>
                    <option value="iceland">Iceland</option>
                    <option value="costco">Costco</option>
                    <option value="marks">M&S Food</option>
                    <option value="ocado">Ocado</option>
                    <option value="farmfoods">Farmfoods</option>
                    <option value="booths">Booths</option>
                    <option value="budgens">Budgens</option>
                </select>
            </div>

            <div class="flex gap-2 mb-4">
                <input id="meal-ingredient-search" type="text" placeholder="Search ingredient..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="openMealBarcodeScanner()" class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center">
                    <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="meal-search-results" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>

            <div class="mb-6">
                <h4 class="text-sm font-black text-slate-400 uppercase mb-2">Ingredients</h4>
                <div id="meal-ingredients-list" class="space-y-2"></div>
            </div>

            <button onclick="saveMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold">Save Meal</button>
        </div>
    </div>

    <!-- METRICS CHART MODAL -->
    <div id="metrics-chart-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Progress Charts</h3>
                <button onclick="closeMetricsChart()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">×</button>
            </div>

            <div class="mb-6">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Metric</label>
                <select id="chart-metric-select" onchange="renderMetricChart()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-lg">
                    <option value="weight">Weight (kg)</option>
                    <option value="chest">Chest (cm)</option>
                    <option value="shoulders">Shoulders (cm)</option>
                    <option value="arms">Arms (cm)</option>
                    <option value="waist">Waist (cm)</option>
                    <option value="legs">Legs (cm)</option>
                    <option value="glutes">Glutes (cm)</option>
                </select>
            </div>

            <div class="h-80 relative bg-slate-50 rounded-3xl p-4">
                <canvas id="metrics-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- PHOTO COMPARISON MODAL -->
    <div id="photo-comparison-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Compare Photos</h3>
                <button onclick="closePhotoComparison()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">×</button>
            </div>

            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">First Date</label>
                        <select id="compare-date-1" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Second Date</label>
                        <select id="compare-date-2" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Photo Angle</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setComparePhotoType('front')" id="compare-type-front" class="p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white">Front</button>
                        <button onclick="setComparePhotoType('side')" id="compare-type-side" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Side</button>
                        <button onclick="setComparePhotoType('back')" id="compare-type-back" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Back</button>
                    </div>
                </div>
            </div>

            <div id="comparison-view" class="grid grid-cols-2 gap-6 hidden">
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-1"></div>
                    <img id="compare-img-1" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="Before">
                </div>
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-2"></div>
                    <img id="compare-img-2" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="After">
                </div>
            </div>

            <div id="no-comparison-message" class="text-center py-12 text-slate-400">
                <i data-lucide="images" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                <p class="font-bold">Select two dates to compare</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        
        const EXERCISE_DB = {
            gym: {
                'Full Body': {
                    compound: ['Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press'],
                    isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl', 'Calf Raise']
                },
                'Upper': {
                    compound: ['Bench Press', 'Pull Ups', 'Dumbbell Row', 'Overhead Press', 'Dips'],
                    isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Face Pulls', 'Cable Flyes']
                },
                'Lower': {
                    compound: ['Barbell Squat', 'Romanian Deadlift', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Abduction', 'Glute Kickback']
                },
                'Push': {
                    compound: ['Bench Press', 'Overhead Press', 'Incline Press', 'Dips'],
                    isolation: ['Tricep Pushdown', 'Lateral Raise', 'Cable Flyes', 'Skull Crushers']
                },
                'Pull': {
                    compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                    isolation: ['Bicep Curl', 'Face Pulls', 'Hammer Curl', 'Cable Row']
                },
                'Legs': {
                    compound: ['Squat', 'Deadlift', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Thrust']
                },
                'Chest': {
                    compound: ['Bench Press', 'Incline Press', 'Dumbbell Press'],
                    isolation: ['Cable Flyes', 'Pec Deck', 'Dumbbell Flyes']
                },
                'Back': {
                    compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                    isolation: ['Cable Row', 'Face Pulls', 'Straight Arm Pulldown']
                },
                'Shoulders': {
                    compound: ['Overhead Press', 'Arnold Press'],
                    isolation: ['Lateral Raise', 'Front Raise', 'Face Pulls', 'Reverse Flyes']
                },
                'Biceps': {
                    compound: ['Chin Ups'],
                    isolation: ['Barbell Curl', 'Hammer Curl', 'Preacher Curl', 'Cable Curl']
                },
                'Triceps': {
                    compound: ['Close Grip Bench Press', 'Dips'],
                    isolation: ['Tricep Pushdown', 'Skull Crushers', 'Overhead Extension']
                },
                'Quads': {
                    compound: ['Squat', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Sissy Squat']
                },
                'Hamstrings': {
                    compound: ['Romanian Deadlift', 'Good Morning'],
                    isolation: ['Leg Curl', 'Nordic Curl']
                },
                'Glutes': {
                    compound: ['Hip Thrust', 'Bulgarian Split Squat'],
                    isolation: ['Cable Kickback', 'Hip Abduction', 'Glute Bridge']
                },
                'Calves': {
                    compound: [],
                    isolation: ['Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise']
                }
            },
            home: {
                'Full Body': {
                    compound: ['Push Ups', 'Bodyweight Squat', 'Burpees'],
                    isolation: ['Plank', 'Crunches', 'Leg Raises']
                },
                'Upper': {
                    compound: ['Push Ups', 'Pike Push Ups', 'Inverted Row'],
                    isolation: ['Tricep Dips', 'Plank to Push Up', 'Superman']
                },
                'Lower': {
                    compound: ['Bodyweight Squat', 'Lunges', 'Step Ups'],
                    isolation: ['Glute Bridge', 'Calf Raise', 'Donkey Kicks']
                },
                'Push': {
                    compound: ['Push Ups', 'Pike Push Ups'],
                    isolation: ['Diamond Push Ups', 'Tricep Dips', 'Shoulder Taps']
                },
                'Pull': {
                    compound: ['Inverted Row', 'Chin Ups'],
                    isolation: ['Superman', 'Reverse Snow Angels', 'Bicep Holds']
                },
                'Legs': {
                    compound: ['Squat', 'Lunges', 'Jump Squat'],
                    isolation: ['Glute Bridge', 'Calf Raise', 'Leg Raises']
                }
            }
        };

        // All exercises list for dropdown
        const ALL_EXERCISES = [
            'Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press',
            'Dumbbell Press', 'Incline Press', 'Dips', 'Barbell Row', 'Lat Pulldown',
            'T-Bar Row', 'Romanian Deadlift', 'Leg Press', 'Lunges', 'Good Morning',
            'Hip Thrust', 'Bulgarian Split Squat', 'Arnold Press', 'Close Grip Bench Press',
            'Chin Ups', 'Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl',
            'Calf Raise', 'Face Pulls', 'Cable Flyes', 'Leg Extension', 'Hip Abduction',
            'Glute Kickback', 'Cable Row', 'Hammer Curl', 'Skull Crushers', 'Pec Deck',
            'Dumbbell Flyes', 'Front Raise', 'Reverse Flyes', 'Preacher Curl', 'Cable Curl',
            'Overhead Extension', 'Sissy Squat', 'Nordic Curl', 'Cable Kickback', 'Glute Bridge',
            'Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise', 'Straight Arm Pulldown',
            'Push Ups', 'Bodyweight Squat', 'Burpees', 'Pike Push Ups', 'Inverted Row',
            'Step Ups', 'Donkey Kicks', 'Diamond Push Ups', 'Shoulder Taps', 'Superman',
            'Reverse Snow Angels', 'Bicep Holds', 'Jump Squat', 'Plank', 'Crunches',
            'Leg Raises', 'Tricep Dips', 'Plank to Push Up'
        ].sort();

        const CARDIO_EXERCISES = ['Treadmill', 'Rowing Machine', 'Stationary Bike', 'Elliptical', 'Stair Climber'];
        const CORE_EXERCISES = ['Plank', 'Crunches', 'Russian Twists', 'Leg Raises', 'Mountain Climbers', 'Dead Bug'];

        let state = {
            viewDate: new Date().toISOString().split('T')[0],
            goals: { calories: 2500, water: 2500, steps: 10000 },
            waterLogs: {},
            stepsLogs: {},
            dailyMeals: [],
            workoutHistory: [],
            nutritionHistory: [],
            metricsHistory: [],
            createdMeals: [],
            workoutEnv: 'gym',
            currentPhotos: { front: null, side: null, back: null },
            equipment: {
                gym: {
                    'Barbell': true,
                    'Dumbbells': true,
                    'Cable Machine': true,
                    'Leg Press': true,
                    'Pull Up Bar': true,
                    'Bench': true
                },
                home: {
                    'Dumbbells': false,
                    'Resistance Bands': false,
                    'Pull Up Bar': false,
                    'Yoga Mat': true
                }
            }
        };

        let workoutTimer = null;
        let workoutStartTime = null;
        let currentFoodItem = null;
        let currentAmountType = 'portion';
        let searchResults = [];
        let mealIngredients = [];
        let html5QrCode = null;
        let metricsChart = null;
        let currentPhotoType = null;

        // ============================================================================
        // UTILITIES
        // ============================================================================

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function saveState() {
            try {
                localStorage.setItem('fittrack_state', JSON.stringify(state));
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('fittrack_state');
                if (saved) {
                    state = { ...state, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.error('Load error:', e);
            }
        }

        // Auto-save meals at midnight
        function setupMidnightSave() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const msUntilMidnight = tomorrow - now;

            setTimeout(() => {
                saveDailyNutrition();
                setupMidnightSave(); // Set up for next day
            }, msUntilMidnight);
        }

        function saveDailyNutrition() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            if (todayMeals.length > 0) {
                const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
                const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);
                state.nutritionHistory.unshift({
                    date: state.viewDate,
                    calories: totalCals,
                    protein: totalProtein,
                    meals: todayMeals
                });
                saveState();
                showToast('Daily nutrition saved automatically');
            }
        }

        // ============================================================================
        // TAB MANAGEMENT
        // ============================================================================

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');

            document.querySelectorAll('.nav-item').forEach(btn => {
                const isActive = btn.dataset.tab === tabId;
                btn.classList.toggle('text-indigo-600', isActive);
                btn.classList.toggle('text-slate-300', !isActive);
                const bg = btn.querySelector('div');
                if (bg) bg.classList.toggle('bg-indigo-50', isActive);
            });

            if (tabId === 'logs') renderLogs();

            lucide.createIcons();
        }

        // ============================================================================
        // DASHBOARD
        // ============================================================================

        function renderDashboard() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);

            document.getElementById('dash-calories').innerText = Math.round(totalCals);
            document.getElementById('dash-protein').innerText = Math.round(totalProtein) + 'g';
            document.getElementById('dash-carbs').innerText = Math.round(totalCals * 0.4 / 4) + 'g';
            document.getElementById('dash-fat').innerText = Math.round(totalCals * 0.3 / 9) + 'g';

            const progress = Math.min((totalCals / state.goals.calories) * 534, 534);
            document.getElementById('calorie-progress').style.strokeDashoffset = 534 - progress;

            const water = state.waterLogs[state.viewDate] || 0;
            document.getElementById('water-count').innerText = `${(water/1000).toFixed(1)} / ${(state.goals.water/1000).toFixed(1)}L`;

            const steps = state.stepsLogs[state.viewDate] || 0;
            document.getElementById('steps-count').innerText = `${steps.toLocaleString()} / ${state.goals.steps.toLocaleString()}`;

            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekWorkouts = state.workoutHistory.filter(w => new Date(w.date) > weekAgo).length;

            document.getElementById('muscle-volume-stats').innerHTML = `
                <div class="bg-white/10 p-3 rounded-xl">
                    <div class="text-[10px] opacity-70 uppercase">This Week</div>
                    <div class="font-bold text-xl">${weekWorkouts} workouts</div>
                </div>
                <div class="bg-white/10 p-3 rounded-xl">
                    <div class="text-[10px] opacity-70 uppercase">Last Weight</div>
                    <div class="font-bold text-xl">${state.metricsHistory[0]?.weight || '--'} kg</div>
                </div>`;
        }

        function updateWater(ml) {
            state.waterLogs[state.viewDate] = Math.max(0, (state.waterLogs[state.viewDate] || 0) + ml);
            saveState();
            renderDashboard();
            showToast(ml > 0 ? 'Water added' : 'Water removed');
        }

        function updateSteps(steps) {
            state.stepsLogs[state.viewDate] = Math.max(0, (state.stepsLogs[state.viewDate] || 0) + steps);
            saveState();
            renderDashboard();
            showToast(steps > 0 ? 'Steps added' : 'Steps removed');
        }

        // ============================================================================
        // TRAINING
        // ============================================================================

        function setWorkoutEnv(env) {
            state.workoutEnv = env;
            document.getElementById('env-tab-gym').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'gym' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('env-tab-home').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'home' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        }

        function toggleSpecificMuscle() {
            const focus = document.getElementById('workout-focus').value;
            document.getElementById('specific-muscle-container').classList.toggle('hidden', focus !== 'Specific Muscle');
        }

        function startWorkout(mode) {
            const focus = document.getElementById('workout-focus').value;
            const muscle = focus === 'Specific Muscle' ? document.getElementById('specific-muscle').value : focus;
            
            document.getElementById('workout-setup').classList.add('hidden');
            document.getElementById('workout-active').classList.remove('hidden');
            document.getElementById('active-workout-title').innerText = muscle;
            document.getElementById('exercise-list').innerHTML = '';

            if (mode === 'ai') {
                const exercises = EXERCISE_DB[state.workoutEnv][muscle];
                const addCardio = document.getElementById('add-cardio-check').checked;
                const addCore = document.getElementById('add-core-check').checked;
                
                if (exercises) {
                    // Get 2 compound exercises
                    const compounds = exercises.compound || [];
                    const selectedCompounds = compounds.sort(() => 0.5 - Math.random()).slice(0, 2);
                    
                    // Get 3 isolation exercises
                    const isolations = exercises.isolation || [];
                    const selectedIsolations = isolations.sort(() => 0.5 - Math.random()).slice(0, 3);
                    
                    // Add weight training exercises (compounds first, then isolations)
                    // Use setTimeout to stagger the additions slightly so each gets a unique ID
                    let delay = 0;
                    [...selectedCompounds, ...selectedIsolations].forEach(ex => {
                        setTimeout(() => addExercise(ex), delay);
                        delay += 10;
                    });
                    
                    // Add cardio after weight training if selected
                    if (addCardio) {
                        const cardio = CARDIO_EXERCISES[Math.floor(Math.random() * CARDIO_EXERCISES.length)];
                        setTimeout(() => addExercise(cardio), delay);
                        delay += 10;
                    }
                    
                    // Add core at the end if selected
                    if (addCore) {
                        const core1 = CORE_EXERCISES[Math.floor(Math.random() * CORE_EXERCISES.length)];
                        const core2 = CORE_EXERCISES.filter(c => c !== core1)[Math.floor(Math.random() * (CORE_EXERCISES.length - 1))];
                        setTimeout(() => addExercise(core1), delay);
                        delay += 10;
                        setTimeout(() => addExercise(core2), delay);
                    }
                    
                    showToast('AI workout generated: 2 compound + 3 isolation');
                } else {
                    showToast('No exercises found for this selection');
                }
            }

            workoutStartTime = Date.now();
            workoutTimer = setInterval(updateWorkoutTimer, 1000);
        }

        function updateWorkoutTimer() {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('workout-timer').innerText = `${h}:${m}:${s}`;
        }

        function addExercise(name = '') {
            const id = Date.now() + Math.random();
            const pr = name ? getPersonalRecord(name) : null;
            const div = document.createElement('div');
            div.className = "glass-card p-4 rounded-2xl mb-4";
            div.innerHTML = `
                <div class="mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex-1 relative">
                            <input type="text" id="exercise-search-${id}" value="${name}" placeholder="Search or type exercise..." 
                                class="w-full bg-slate-50 p-3 rounded-xl font-bold outline-none pr-20" 
                                onfocus="showExerciseDropdown(${id})" 
                                oninput="filterExercises(${id}, this.value)">
                            ${pr ? `<span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>` : ''}
                            <div id="dropdown-${id}" class="hidden absolute z-20 mt-1 w-full bg-white rounded-xl shadow-xl border max-h-60 overflow-y-auto"></div>
                        </div>
                        <button onclick="this.closest('.glass-card').remove()" class="text-slate-300 ml-3 w-10 h-10 hover:bg-slate-100 rounded-lg flex items-center justify-center">×</button>
                    </div>
                </div>
                <div class="sets-container-${id} space-y-2 mb-2"></div>
                <button onclick="addSet(${id})" class="w-full py-3 bg-slate-50 text-xs font-black text-slate-400 rounded-xl hover:bg-slate-100">+ Add Set</button>
            `;
            document.getElementById('exercise-list').appendChild(div);
            
            // Add first set with PR showing if exercise name is provided
            addSet(id);
            
            lucide.createIcons();
        }

        function showExerciseDropdown(id) {
            const dropdown = document.getElementById(`dropdown-${id}`);
            const html = ALL_EXERCISES.map(ex => {
                const pr = getPersonalRecord(ex);
                return `<div onclick="selectExercise(${id}, '${ex}')" class="p-3 hover:bg-slate-50 cursor-pointer border-b last:border-0 flex justify-between items-center">
                    <span class="font-medium text-sm">${ex}</span>
                    ${pr ? `<span class="text-xs font-black text-emerald-600">PR: ${pr}kg</span>` : ''}
                </div>`;
            }).join('');
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function filterExercises(id, query) {
            const dropdown = document.getElementById(`dropdown-${id}`);
            const filtered = ALL_EXERCISES.filter(ex => ex.toLowerCase().includes(query.toLowerCase()));
            
            if (filtered.length === 0 && query.length > 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic">No exercises found - keep typing to add custom</div>';
            } else if (filtered.length > 0) {
                const html = filtered.map(ex => {
                    const pr = getPersonalRecord(ex);
                    return `<div onclick="selectExercise(${id}, '${ex}')" class="p-3 hover:bg-slate-50 cursor-pointer border-b last:border-0 flex justify-between items-center">
                        <span class="font-medium text-sm">${ex}</span>
                        ${pr ? `<span class="text-xs font-black text-emerald-600">PR: ${pr}kg</span>` : ''}
                    </div>`;
                }).join('');
                dropdown.innerHTML = html;
            }
            
            if (query.length > 0) {
                dropdown.classList.remove('hidden');
            }
        }

        function selectExercise(id, exerciseName) {
            const input = document.getElementById(`exercise-search-${id}`);
            const oldName = input.value;
            input.value = exerciseName;
            document.getElementById(`dropdown-${id}`).classList.add('hidden');
            
            // Update PR display in exercise name field
            const pr = getPersonalRecord(exerciseName);
            const parent = input.parentElement;
            const existingPR = parent.querySelector('.absolute.right-3');
            if (existingPR) existingPR.remove();
            
            if (pr) {
                const prBadge = document.createElement('span');
                prBadge.className = 'absolute right-3 top-1/2 -translate-y-1/2 text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded';
                prBadge.textContent = `PR: ${pr}kg`;
                parent.appendChild(prBadge);
                showToast(`Personal Record: ${pr}kg`);
            }
            
            // Update PR display in all weight input fields for this exercise
            const container = document.querySelector(`.sets-container-${id}`);
            if (container) {
                // Skip the header row and update actual set inputs
                const setRows = Array.from(container.children).filter(child => 
                    child.querySelector('input[type="number"]')
                );
                
                setRows.forEach(row => {
                    const weightInputParent = row.querySelector('.relative');
                    if (weightInputParent) {
                        const existingPB = weightInputParent.querySelector('.absolute');
                        if (existingPB) existingPB.remove();
                        
                        if (pr) {
                            const pbBadge = document.createElement('span');
                            pbBadge.className = 'absolute right-2 top-1/2 -translate-y-1/2 text-[10px] font-black text-emerald-600 whitespace-nowrap bg-emerald-50 px-1.5 py-0.5 rounded';
                            pbBadge.textContent = `PB: ${pr}kg`;
                            weightInputParent.appendChild(pbBadge);
                        }
                    }
                });
            }
        }

        function getPersonalRecord(exerciseName) {
            let maxWeight = 0;
            state.workoutHistory.forEach(workout => {
                workout.exercises.forEach(ex => {
                    if (ex.name === exerciseName) {
                        ex.sets.forEach(set => {
                            const weight = parseFloat(set.kg) || 0;
                            if (weight > maxWeight) maxWeight = weight;
                        });
                    }
                });
            });
            return maxWeight > 0 ? maxWeight : null;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('[id^="exercise-search-"]')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.classList.add('hidden'));
            }
        });

        function addSet(exerciseId) {
            const container = document.querySelector(`.sets-container-${exerciseId}`);
            const exerciseInput = document.querySelector(`#exercise-search-${exerciseId}`);
            const exerciseName = exerciseInput ? exerciseInput.value : '';
            const pr = exerciseName ? getPersonalRecord(exerciseName) : null;
            
            // Add header labels if this is the first set
            if (container.children.length === 0) {
                const headerHtml = `
                    <div class="flex gap-2 mb-1">
                        <div class="flex-1 text-center">
                            <span class="text-[10px] font-black text-slate-400 uppercase">Weight (kg)</span>
                        </div>
                        <div class="flex-1 text-center">
                            <span class="text-[10px] font-black text-slate-400 uppercase">Reps</span>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', headerHtml);
            }
            
            const html = `
                <div class="flex gap-2 items-center">
                    <div class="flex-1 relative">
                        <input type="number" placeholder="0" class="w-full bg-slate-50 p-3 rounded-xl text-center font-bold outline-none" step="0.5">
                        ${pr ? `<span class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] font-black text-emerald-600 whitespace-nowrap bg-emerald-50 px-1.5 py-0.5 rounded">PB: ${pr}kg</span>` : ''}
                    </div>
                    <input type="number" placeholder="0" class="flex-1 bg-slate-50 p-3 rounded-xl text-center font-bold outline-none">
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function saveWorkout() {
            clearInterval(workoutTimer);
            
            const exercises = [];
            document.querySelectorAll('#exercise-list .glass-card').forEach(card => {
                const nameInput = card.querySelector('[id^="exercise-search-"]');
                const name = nameInput ? nameInput.value.trim() : '';
                if (!name) return;
                
                const sets = [];
                const inputs = card.querySelectorAll('input[type="number"]');
                for (let i = 0; i < inputs.length; i += 2) {
                    if (inputs[i].value && inputs[i+1].value) {
                        sets.push({ kg: inputs[i].value, reps: inputs[i+1].value });
                    }
                }
                if (sets.length > 0) {
                    exercises.push({ name, sets });
                }
            });

            if (exercises.length === 0) {
                showToast('Add at least one exercise with sets');
                return;
            }

            state.workoutHistory.unshift({
                id: Date.now(),
                date: state.viewDate,
                focus: document.getElementById('active-workout-title').innerText,
                duration: document.getElementById('workout-timer').innerText,
                exercises
            });

            saveState();
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
            renderDashboard();
            showToast('Workout saved!');
        }

        function cancelWorkout() {
            if (confirm('Discard workout?')) {
                clearInterval(workoutTimer);
                document.getElementById('workout-setup').classList.remove('hidden');
                document.getElementById('workout-active').classList.add('hidden');
            }
        }

        // ============================================================================
        // NUTRITION
        // ============================================================================

        function setNutritionTab(tab) {
            document.getElementById('nut-tab-diary').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'diary' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('nut-tab-search').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            
            document.getElementById('nut-view-diary').classList.toggle('hidden', tab !== 'diary');
            document.getElementById('nut-view-search').classList.toggle('hidden', tab !== 'search');

            if (tab === 'diary') renderDiary();
            if (tab === 'search') renderCreatedMeals();
        }

        function renderDiary() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);

            document.getElementById('total-kcal').innerText = Math.round(totalCals);
            document.getElementById('total-protein').innerText = totalProtein.toFixed(1);

            const sections = ['breakfast', 'lunch', 'dinner', 'snack'];
            let html = '';
            
            sections.forEach(section => {
                const meals = todayMeals.filter(m => m.mealType === section);
                const icon = { breakfast: 'coffee', lunch: 'utensils', dinner: 'moon', snack: 'cookie' }[section];
                
                html += `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="${icon}" class="w-4 h-4 text-slate-400"></i>
                            <h3 class="text-[11px] font-black text-slate-400 uppercase">${section}</h3>
                        </div>
                        ${meals.length === 0 ? '<p class="text-xs text-slate-300 italic px-4">Nothing logged</p>' : ''}
                        ${meals.map(m => `
                            <div class="bg-white p-4 rounded-[24px] mb-2 border border-slate-100 flex items-center gap-4">
                                <img src="${m.image}" class="w-12 h-12 object-contain bg-slate-50 rounded-lg p-1" onerror="this.src='https://via.placeholder.com/100'">
                                <div class="flex-1">
                                    <p class="font-bold text-sm">${m.name}</p>
                                    <p class="text-xs text-slate-400">${m.amount} • ${m.calories}kcal • ${m.protein}g protein</p>
                                </div>
                                <button onclick="removeMeal(${m.id})" class="text-slate-300 hover:text-red-500">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>`;
            });

            document.getElementById('meal-sections').innerHTML = html;
            lucide.createIcons();
        }

        function removeMeal(id) {
            state.dailyMeals = state.dailyMeals.filter(m => m.id !== id);
            saveState();
            renderDiary();
            renderDashboard();
            showToast('Item removed');
        }

        // Food Search
        let searchDebounce;
        document.getElementById('food-search-input')?.addEventListener('input', (e) => {
            clearTimeout(searchDebounce);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('search-results-list').innerHTML = '';
                return;
            }
            searchDebounce = setTimeout(() => searchFood(query), 500);
        });

        async function searchFood(query) {
            document.getElementById('search-loading').classList.remove('hidden');
            document.getElementById('search-results-list').innerHTML = '';

            try {
                const store = document.getElementById('store-select').value;
                const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=20&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                
                const response = await fetch(url);
                const data = await response.json();
                searchResults = (data.products || []).map(p => ({
                    name: p.product_name || 'Unknown',
                    image: p.image_small_url || 'https://via.placeholder.com/100',
                    calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                    protein: (p.nutriments?.proteins_100g || 0).toFixed(1),
                    serving: p.serving_size || '100g'
                }));

                renderSearchResults();
            } catch (error) {
                console.error('Search error:', error);
                showToast('Search failed');
            } finally {
                document.getElementById('search-loading').classList.add('hidden');
            }
        }

        function renderSearchResults() {
            const html = searchResults.map((item, idx) => `
                <div onclick="openFoodPopup(${idx})" class="bg-white p-4 rounded-[28px] border flex items-center gap-4 cursor-pointer hover:shadow-lg transition-all">
                    <img src="${item.image}" class="w-14 h-14 object-contain bg-slate-50 rounded-xl p-1" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1">
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-slate-400">${item.calories}kcal • ${item.protein}g protein per ${item.serving}</p>
                    </div>
                    <i data-lucide="plus" class="text-emerald-600"></i>
                </div>
            `).join('');
            document.getElementById('search-results-list').innerHTML = html;
            lucide.createIcons();
        }

        function openFoodPopup(idx) {
            currentFoodItem = searchResults[idx];
            document.getElementById('popup-image').src = currentFoodItem.image;
            document.getElementById('popup-name').innerText = currentFoodItem.name;
            document.getElementById('popup-nutrition').innerText = `${currentFoodItem.calories}kcal, ${currentFoodItem.protein}g protein per ${currentFoodItem.serving}`;
            document.getElementById('popup-amount').value = 1;
            currentAmountType = 'portion';
            updateFoodPopup();
            document.getElementById('food-popup').style.display = 'flex';
            lucide.createIcons();
        }

        function closeFoodPopup() {
            document.getElementById('food-popup').style.display = 'none';
        }

        function setAmountType(type) {
            currentAmountType = type;
            document.getElementById('amount-type-portion').className = `flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${type === 'portion' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
            document.getElementById('amount-type-grams').className = `flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${type === 'grams' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
            updateFoodPopup();
        }

        document.getElementById('popup-amount')?.addEventListener('input', updateFoodPopup);

        function updateFoodPopup() {
            if (!currentFoodItem) return;
            const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
            const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
            
            const totalCals = Math.round(currentFoodItem.calories * multiplier);
            const totalProtein = (currentFoodItem.protein * multiplier).toFixed(1);
            
            document.getElementById('popup-total-kcal').innerText = totalCals;
            document.getElementById('popup-total-protein').innerText = totalProtein + 'g';
        }

        function addFoodItem() {
            if (!currentFoodItem) return;
            
            const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
            const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
            const mealType = document.getElementById('popup-meal-type').value;

            state.dailyMeals.push({
                id: Date.now(),
                date: state.viewDate,
                name: currentFoodItem.name,
                image: currentFoodItem.image,
                amount: currentAmountType === 'portion' ? `${amount} portion(s)` : `${amount}g`,
                calories: Math.round(currentFoodItem.calories * multiplier),
                protein: parseFloat((currentFoodItem.protein * multiplier).toFixed(1)),
                mealType
            });

            saveState();
            closeFoodPopup();
            setNutritionTab('diary');
            renderDashboard();
            showToast('Added to diary!');
        }

        // Barcode Scanner
        function openBarcodeScanner() {
            document.getElementById('barcode-scanner-modal').style.display = 'flex';
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("barcode-reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    (code) => {
                        document.getElementById('manual-barcode').value = code;
                        lookupBarcode();
                    }
                ).catch(err => console.error('Scanner error:', err));
            }
        }

        function closeBarcodeScanner() {
            if (html5QrCode) {
                html5QrCode.stop();
                html5QrCode = null;
            }
            document.getElementById('barcode-scanner-modal').style.display = 'none';
        }

        async function lookupBarcode() {
            const code = document.getElementById('manual-barcode').value.trim();
            if (!code) return;

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const p = data.product;
                    searchResults = [{
                        name: p.product_name || 'Unknown',
                        image: p.image_small_url || 'https://via.placeholder.com/100',
                        calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                        protein: (p.nutriments?.proteins_100g || 0).toFixed(1),
                        serving: p.serving_size || '100g'
                    }];
                    closeBarcodeScanner();
                    openFoodPopup(0);
                } else {
                    showToast('Product not found');
                }
            } catch (error) {
                showToast('Barcode lookup failed');
            }
        }

        // Created Meals
        function renderCreatedMeals() {
            const html = state.createdMeals.map((meal, idx) => `
                <div onclick="addCreatedMeal(${idx})" class="bg-white p-4 rounded-[28px] border flex items-center gap-4 cursor-pointer hover:shadow-lg transition-all">
                    <div class="w-14 h-14 bg-emerald-50 rounded-xl flex items-center justify-center">
                        <i data-lucide="chef-hat" class="text-emerald-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-sm">${meal.name}</p>
                        <p class="text-xs text-slate-400">${meal.calories}kcal • ${meal.protein}g protein • ${meal.ingredients.length} ingredients</p>
                    </div>
                    <i data-lucide="plus" class="text-emerald-600"></i>
                </div>
            `).join('');
            document.getElementById('created-meals-list').innerHTML = html;
            lucide.createIcons();
        }

        function addCreatedMeal(idx) {
            const meal = state.createdMeals[idx];
            state.dailyMeals.push({
                id: Date.now(),
                date: state.viewDate,
                name: meal.name,
                image: 'https://via.placeholder.com/100',
                amount: '1 meal',
                calories: meal.calories,
                protein: meal.protein,
                mealType: 'dinner'
            });
            saveState();
            setNutritionTab('diary');
            renderDashboard();
            showToast('Meal added!');
        }

        // Create Meal
        function openCreateMeal() {
            mealIngredients = [];
            document.getElementById('meal-name-input').value = '';
            document.getElementById('meal-ingredients-list').innerHTML = '';
            document.getElementById('create-meal-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeCreateMeal() {
            document.getElementById('create-meal-modal').style.display = 'none';
        }

        let mealSearchDebounce;
        document.getElementById('meal-ingredient-search')?.addEventListener('input', (e) => {
            clearTimeout(mealSearchDebounce);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('meal-search-results').innerHTML = '';
                return;
            }
            mealSearchDebounce = setTimeout(() => searchMealIngredient(query), 500);
        });

        async function searchMealIngredient(query) {
            try {
                const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=10&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                const response = await fetch(url);
                const data = await response.json();
                
                const results = (data.products || []).map(p => ({
                    name: p.product_name || 'Unknown',
                    image: p.image_small_url || 'https://via.placeholder.com/100',
                    calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                    protein: (p.nutriments?.proteins_100g || 0).toFixed(1)
                }));

                const html = results.map((item, idx) => `
                    <div onclick="addMealIngredient(${idx}, ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-slate-100">
                        <img src="${item.image}" class="w-10 h-10 object-contain rounded" onerror="this.src='https://via.placeholder.com/100'">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-xs truncate">${item.name}</p>
                            <p class="text-[10px] text-slate-400">${item.calories}kcal, ${item.protein}g protein</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('meal-search-results').innerHTML = html;
            } catch (error) {
                console.error('Ingredient search error:', error);
            }
        }

        function addMealIngredient(idx, item) {
            const amount = prompt('Enter amount (in grams):', '100');
            if (!amount) return;

            const multiplier = parseFloat(amount) / 100;
            mealIngredients.push({
                name: item.name,
                amount: `${amount}g`,
                calories: Math.round(item.calories * multiplier),
                protein: parseFloat((item.protein * multiplier).toFixed(1))
            });

            renderMealIngredients();
            document.getElementById('meal-ingredient-search').value = '';
            document.getElementById('meal-search-results').innerHTML = '';
        }

        function renderMealIngredients() {
            const html = mealIngredients.map((ing, idx) => `
                <div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between">
                    <div>
                        <p class="font-bold text-xs">${ing.name}</p>
                        <p class="text-[10px] text-slate-400">${ing.amount} • ${ing.calories}kcal • ${ing.protein}g protein</p>
                    </div>
                    <button onclick="mealIngredients.splice(${idx}, 1); renderMealIngredients();" class="text-slate-300">×</button>
                </div>
            `).join('');
            document.getElementById('meal-ingredients-list').innerHTML = html || '<p class="text-xs text-slate-300 italic">No ingredients yet</p>';
        }

        function openMealBarcodeScanner() {
            // Similar to main barcode scanner but for meal creation
            showToast('Barcode scanner for meals - coming soon!');
        }

        function saveMeal() {
            const name = document.getElementById('meal-name-input').value.trim();
            if (!name) {
                showToast('Please enter meal name');
                return;
            }
            if (mealIngredients.length === 0) {
                showToast('Add at least one ingredient');
                return;
            }

            const totalCals = mealIngredients.reduce((sum, ing) => sum + ing.calories, 0);
            const totalProtein = mealIngredients.reduce((sum, ing) => sum + ing.protein, 0);

            state.createdMeals.push({
                id: Date.now(),
                name,
                calories: totalCals,
                protein: totalProtein,
                ingredients: [...mealIngredients]
            });

            saveState();
            closeCreateMeal();
            renderCreatedMeals();
            showToast('Meal saved!');
        }

        // ============================================================================
        // LOGS
        // ============================================================================

        function setLogsTab(tab) {
            document.getElementById('logs-tab-training').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'training' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('logs-tab-nutrition').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'nutrition' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            
            document.getElementById('logs-training-view').classList.toggle('hidden', tab !== 'training');
            document.getElementById('logs-nutrition-view').classList.toggle('hidden', tab !== 'nutrition');
            
            renderLogs();
        }

        function renderLogs() {
            // Training logs
            const trainingHtml = state.workoutHistory.length === 0 ? 
                '<p class="text-center text-slate-400 py-10">No workouts logged yet</p>' :
                state.workoutHistory.map(w => `
                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold">${w.focus}</h4>
                                <p class="text-xs text-slate-400">${w.date} • ${w.duration}</p>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500">
                            ${w.exercises.length} exercises • ${w.exercises.reduce((sum, e) => sum + e.sets.length, 0)} total sets
                        </div>
                    </div>
                `).join('');
            document.getElementById('training-logs-list').innerHTML = trainingHtml;

            // Nutrition logs
            const nutritionHtml = state.nutritionHistory.length === 0 ?
                '<p class="text-center text-slate-400 py-10">No nutrition logs yet</p>' :
                state.nutritionHistory.map(n => `
                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold">${n.date}</h4>
                                <p class="text-xs text-slate-400">${n.meals?.length || 0} items logged</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">${Math.round(n.calories)} kcal</p>
                                <p class="text-xs text-blue-600">${n.protein.toFixed(1)}g protein</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            document.getElementById('nutrition-logs-list').innerHTML = nutritionHtml;
        }

        // ============================================================================
        // BODY METRICS
        // ============================================================================

        function triggerPhotoUpload(type) {
            currentPhotoType = type;
            document.getElementById('photo-upload-input').click();
        }

        document.getElementById('photo-upload-input')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                    state.currentPhotos[currentPhotoType] = compressedImage;

                    // Show preview
                    const preview = document.getElementById(`photo-${currentPhotoType}-preview`);
                    preview.src = compressedImage;
                    preview.classList.remove('hidden');

                    showToast(`${currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1)} photo added`);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function saveMetrics() {
            const weight = parseFloat(document.getElementById('metric-weight').value);
            if (!weight) {
                showToast('Please enter weight');
                return;
            }

            state.metricsHistory.unshift({
                id: Date.now(),
                date: state.viewDate,
                weight,
                chest: parseFloat(document.getElementById('metric-chest').value) || 0,
                shoulders: parseFloat(document.getElementById('metric-shoulders').value) || 0,
                arms: parseFloat(document.getElementById('metric-arms').value) || 0,
                waist: parseFloat(document.getElementById('metric-waist').value) || 0,
                legs: parseFloat(document.getElementById('metric-legs').value) || 0,
                glutes: parseFloat(document.getElementById('metric-glutes').value) || 0,
                photos: {
                    front: state.currentPhotos.front,
                    side: state.currentPhotos.side,
                    back: state.currentPhotos.back
                }
            });

            saveState();
            renderDashboard();
            renderMetricChart();
            populateComparisonDates();
            showToast('Metrics saved!');
            
            // Clear inputs and photos
            ['weight', 'chest', 'shoulders', 'arms', 'waist', 'legs', 'glutes'].forEach(m => {
                document.getElementById(`metric-${m}`).value = '';
            });
            
            state.currentPhotos = { front: null, side: null, back: null };
            ['front', 'side', 'back'].forEach(type => {
                document.getElementById(`photo-${type}-preview`).classList.add('hidden');
            });
        }

        function populateComparisonDates() {
            const dates = state.metricsHistory
                .filter(m => m.photos && (m.photos.front || m.photos.side || m.photos.back))
                .map(m => ({ date: m.date, id: m.id }));

            const html = '<option value="">Select date...</option>' + dates.map(d => 
                `<option value="${d.id}">${d.date}</option>`
            ).join('');

            document.getElementById('compare-date-1').innerHTML = html;
            document.getElementById('compare-date-2').innerHTML = html;
        }

        let currentComparePhotoType = 'front';

        function setComparePhotoType(type) {
            currentComparePhotoType = type;
            ['front', 'side', 'back'].forEach(t => {
                const btn = document.getElementById(`compare-type-${t}`);
                if (t === type) {
                    btn.className = 'p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white';
                } else {
                    btn.className = 'p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600';
                }
            });
            loadComparisonPhotos();
        }

        function loadComparisonPhotos() {
            const id1 = document.getElementById('compare-date-1').value;
            const id2 = document.getElementById('compare-date-2').value;

            if (!id1 || !id2) {
                document.getElementById('comparison-view').classList.add('hidden');
                document.getElementById('no-comparison-message').classList.remove('hidden');
                return;
            }

            const metric1 = state.metricsHistory.find(m => m.id == id1);
            const metric2 = state.metricsHistory.find(m => m.id == id2);

            if (!metric1 || !metric2) return;

            const photo1 = metric1.photos?.[currentComparePhotoType];
            const photo2 = metric2.photos?.[currentComparePhotoType];

            if (photo1 && photo2) {
                document.getElementById('compare-img-1').src = photo1;
                document.getElementById('compare-img-2').src = photo2;
                document.getElementById('compare-label-1').textContent = metric1.date;
                document.getElementById('compare-label-2').textContent = metric2.date;
                document.getElementById('comparison-view').classList.remove('hidden');
                document.getElementById('no-comparison-message').classList.add('hidden');
                lucide.createIcons();
            } else {
                document.getElementById('comparison-view').classList.add('hidden');
                document.getElementById('no-comparison-message').classList.remove('hidden');
                showToast('Photos not available for selected dates');
            }
        }

        function openMetricsChart() {
            document.getElementById('metrics-chart-modal').style.display = 'flex';
            setTimeout(() => renderMetricChart(), 100); // Ensure canvas is visible
            lucide.createIcons();
        }

        function closeMetricsChart() {
            document.getElementById('metrics-chart-modal').style.display = 'none';
        }

        function openPhotoComparison() {
            populateComparisonDates();
            currentComparePhotoType = 'front';
            setComparePhotoType('front');
            document.getElementById('photo-comparison-modal').style.display = 'flex';
            document.getElementById('comparison-view').classList.add('hidden');
            document.getElementById('no-comparison-message').classList.remove('hidden');
            lucide.createIcons();
        }

        function closePhotoComparison() {
            document.getElementById('photo-comparison-modal').style.display = 'none';
        }

        function renderMetricChart() {
            const metric = document.getElementById('chart-metric-select')?.value || 'weight';
            const history = [...state.metricsHistory].reverse();
            
            const labels = history.map(m => new Date(m.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }));
            const data = history.map(m => m[metric]);

            if (metricsChart) metricsChart.destroy();

            const ctx = document.getElementById('metrics-chart');
            if (!ctx) return;

            metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: metric.charAt(0).toUpperCase() + metric.slice(1),
                        data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // ============================================================================
        // SETTINGS
        // ============================================================================

        function updateCalorieGoal(value) {
            state.goals.calories = Number(value);
            saveState();
            renderDashboard();
            showToast('Goal updated');
        }

        function renderSettings() {
            document.getElementById('calorie-goal-input').value = state.goals.calories;

            // Gym equipment
            const gymHtml = Object.keys(state.equipment.gym).map(eq => `
                <button onclick="toggleEquipment('gym', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase ${state.equipment.gym[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}">
                    ${eq}
                </button>
            `).join('');
            document.getElementById('gym-equipment-list').innerHTML = gymHtml;

            // Home equipment
            const homeHtml = Object.keys(state.equipment.home).map(eq => `
                <button onclick="toggleEquipment('home', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase ${state.equipment.home[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}">
                    ${eq}
                </button>
            `).join('');
            document.getElementById('home-equipment-list').innerHTML = homeHtml;
        }

        function toggleEquipment(env, equipment) {
            state.equipment[env][equipment] = !state.equipment[env][equipment];
            saveState();
            renderSettings();
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            
            document.getElementById('status-date').innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });

            renderDashboard();
            renderDiary();
            renderSettings();
            setupMidnightSave();
            
            lucide.createIcons();
            showToast('Welcome to FitTrack Pro! 💪');
        });
    </script>
</body>
</html>
