<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Fitness Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        .view-container { min-height: calc(100vh - 4rem); }
        .modal-metrics { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .fade-in { opacity: 1 !important; transform: translateY(0) !important; pointer-events: auto !important; }
        .hidden { display: none !important; } /* Force hidden to override flex/block */
        #reader { width: 100%; min-height: 250px; background: #000; border-radius: 8px; margin-bottom: 10px; }
        
        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .tab-btn:hover { background-color: #d0d0d0; }
        .tab-btn.active { background-color: #0066cc; color: white; }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in; }

        /* Inputs and Forms */
        input, select, textarea, button.std-btn {
            padding: 0.6rem;
            margin: 0.5rem 0;
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        select { background-color: white; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        th, td { padding: 0.75rem; border: 1px solid #ccc; text-align: left; }
        th { background-color: #0066cc; color: white; text-transform: uppercase; }

        /* Search Results */
        #searchResults, #databaseResults {
            background-color: white;
            border: 1px solid #ccc;
            margin-top: 0.5rem;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        #searchResults:empty, #databaseResults:empty { display: none; }

        #searchResults div, #databaseResults div {
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        #searchResults div:hover, #databaseResults div:hover { background-color: #f0f8ff; }

        /* Log Summary */
        .total-section {
            background-color: #eef7ff;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 1rem;
        }

        .total-section strong { display: inline-block; width: 160px; }

        .history-tabs { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .history-tabs button { background-color: #cccccc; color: black; padding: 0.5rem 1rem; border-radius: 5px; }
        .history-tabs button.active { background-color: #0066cc; color: white; }
        .history-view { display: none; }
        .history-view.active { display: block; }

        /* Scanner */
        #reader { width: 100%; max-width: 400px; margin: 10px auto; border-radius: 8px; overflow: hidden; }

        @media screen and (max-width: 768px) {
            .tabs { flex-direction: column; align-items: stretch; }
            .tab-btn { width: 100%; margin-bottom: 0.5rem; }
            th, td { font-size: 0.8rem; padding: 0.4rem; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-5xl mx-auto space-y-6 p-4 md:space-y-8 md:p-6">
        <!-- Notification Box -->
        <div id="message-box" class="fixed top-4 right-4 left-4 md:left-auto md:w-96 z-[100] p-4 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-lg shadow-xl font-medium hidden opacity-0 transition-opacity duration-300">
            <p id="message-text"></p>
        </div>

        <!-- MAIN DASHBOARD -->
        <div id="view-dashboard" class="view-container space-y-6">
            <header class="bg-white p-6 rounded-2xl shadow-xl">
                <h1 class="text-2xl md:text-4xl font-black text-gray-900 mb-2">Fitness Dashboard</h1>
                <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                    <p><span class="font-bold text-indigo-600">User:</span> <span id="user-name">Guest</span></p>
                    <p><span class="font-bold text-indigo-600">Goal:</span> <span id="user-goal">Gain Muscle</span></p>
                    <p><span class="font-bold text-indigo-600">Daily Calorie Goal:</span> <span id="goal-cal-display">--</span></p>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <button onclick="showView('gym-config')" class="bg-indigo-500 text-white p-6 rounded-xl shadow-lg hover:bg-indigo-600 transition transform hover:scale-[1.02] flex flex-col items-center">
                    <i class="fas fa-dumbbell text-3xl mb-2"></i>
                    <span class="font-bold text-lg">Configure Gym</span>
                    <span id="current-gym-status" class="text-xs opacity-75 mt-1 font-normal"></span>
                </button>

                <button onclick="showView('plan-workout')" class="bg-green-500 text-white p-6 rounded-xl shadow-lg hover:bg-green-600 transition transform hover:scale-[1.02] flex flex-col items-center">
                    <i class="fas fa-running text-3xl mb-2"></i>
                    <span class="font-bold text-lg">Plan Workout</span>
                </button>

                <button onclick="showView('meal-log')" class="bg-yellow-500 text-white p-6 rounded-xl shadow-lg hover:bg-yellow-600 transition transform hover:scale-[1.02] flex flex-col items-center">
                    <i class="fas fa-utensils text-3xl mb-2"></i>
                    <span class="font-bold text-lg">Nutrition Tracker</span>
                </button>

                <button onclick="showView('body-metrics')" class="bg-purple-500 text-white p-6 rounded-xl shadow-lg hover:bg-purple-600 transition transform hover:scale-[1.02] flex flex-col items-center">
                    <i class="fas fa-ruler-combined text-3xl mb-2"></i>
                    <span class="font-bold text-lg">Body Metrics</span>
                </button>

                <button id="view-history-btn" onclick="openHistory()" class="bg-gray-500 text-white p-6 rounded-xl shadow-lg hover:bg-gray-600 transition transform hover:scale-[1.02] flex flex-col items-center">
                    <i class="fas fa-chart-line text-3xl mb-2"></i>
                    <span class="font-bold text-lg">View History</span>
                </button>
            </div>

            <div class="text-center pt-10">
                <button onclick="resetApp()" class="text-xs text-red-400 hover:text-red-600 underline">Reset All Data</button>
            </div>
        </div>

        <!-- GYM CONFIG -->
        <div id="view-gym-config" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-2xl font-bold text-indigo-700">Gym Setup</h2>
                <button onclick="showView('dashboard')" class="bg-gray-100 px-4 py-2 rounded-lg">Back</button>
            </div>
            <form id="gym-setup-form" class="space-y-6">
                <input type="text" id="gym-name" placeholder="Gym Name" class="w-full p-3 border rounded-xl">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <h3 class="font-bold mb-3"><i class="fas fa-weight-hanging mr-2"></i> Weights</h3>
                        <div id="weights-options" class="space-y-2"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <h3 class="font-bold mb-3"><i class="fas fa-heartbeat mr-2"></i> Cardio</h3>
                        <div id="cardio-options" class="space-y-2"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <h3 class="font-bold mb-3"><i class="fas fa-expand-alt mr-2"></i> Functional</h3>
                        <div id="floor-options" class="space-y-2"></div>
                    </div>
                </div>
                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl">Save Setup</button>
            </form>
        </div>

        <!-- NUTRITION TRACKER (Corrected & Integrated) -->
        <div id="view-meal-log" class="view-container bg-white p-6 rounded-2xl shadow-xl hidden">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-yellow-600">Nutrition</h2>
                <button onclick="showView('dashboard')" class="bg-gray-100 px-4 py-2 rounded-lg">Back</button>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'trackerTab')" data-tab="trackerTab">Tracker</button>
                <button class="tab-btn" onclick="switchTab(event, 'addFoodTab')" data-tab="addFoodTab">Add Food Item</button>
                <button class="tab-btn" onclick="switchTab(event, 'goalsTab')" data-tab="goalsTab">Set Goals</button>
            </div>

            <!-- Tracker Tab -->
            <div id="trackerTab" class="tab-content active">
                <h3 class="text-xl font-bold mb-4">Daily Log</h3>
                
                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="Search food to log..." oninput="searchFood()" class="p-3 border rounded-xl w-full">
                    <div id="searchResults" class="border rounded-b-xl shadow-lg max-h-40 overflow-auto hidden"></div>
                </div>

                <div class="total-section mb-4">
                    <div class="flex justify-between text-lg">
                        <span>Calories: <strong id="val-cal">0</strong> / <span id="target-cal">2000</span></span>
                        <span>Protein: <strong id="val-prot">0</strong>g / <span id="target-prot">150</span>g</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="cal-progress" class="bg-yellow-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div id="today-log-container" class="space-y-2">
                    <!-- Log entries go here -->
                </div>
            </div>

            <!-- Add Food Tab with Scanner -->
            <div id="addFoodTab" class="tab-content">
                <h3 class="text-xl font-bold mb-4">Add New Food to Database</h3>
                
                <div style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                    <p style="font-weight: bold; margin-bottom: 5px;">Scan Barcode</p>
                    <div id="reader"></div>
                    <button onclick="startScanner()" class="bg-blue-600 text-white p-2 rounded w-full">Start Camera Scanner</button>
                    <button onclick="stopScanner()" id="stop-scan-btn" class="bg-red-500 text-white p-2 rounded w-full hidden mt-2">Stop Scanner</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold">Food Name</label>
                        <input type="text" id="new-food-name" class="w-full p-2 border rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold">Calories</label>
                            <input type="number" id="new-food-cal" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Protein (g)</label>
                            <input type="number" id="new-food-prot" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <button onclick="addNewFoodToDb()" class="bg-green-600 text-white font-bold py-3 rounded-xl w-full">Add to Database</button>
                </div>
            </div>

            <!-- Goals Tab -->
            <div id="goalsTab" class="tab-content">
                <h3 class="text-xl font-bold mb-4">Nutrition Goals</h3>
                <label class="block mb-2 font-bold">Daily Calories Target</label>
                <input type="number" id="goalCaloriesInput" placeholder="e.g. 2000" class="mb-4">
                
                <label class="block mb-2 font-bold">Daily Protein Goal (g)</label>
                <input type="number" id="goalProteinInput" placeholder="e.g. 150" class="mb-4">
                
                <button onclick="saveGoals()" class="bg-indigo-600 text-white py-3 rounded-xl w-full font-bold">Save Goals</button>
            </div>
        </div>

        <!-- WORKOUT PLANNING -->
        <div id="view-plan-workout" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-2xl font-bold text-green-600">Plan Workout</h2>
                <button onclick="showView('dashboard')" class="bg-gray-100 px-4 py-2 rounded-lg">Back</button>
            </div>
            <form id="workout-planning-form" class="space-y-6">
                <div>
                    <label class="block font-bold mb-2">Workout Focus</label>
                    <select id="workout-focus" onchange="handleFocusChange()" class="w-full p-4 border rounded-xl">
                        <option value="full-body">Full Body</option>
                        <option value="upper-body">Upper Body</option>
                        <option value="lower-body">Lower Body</option>
                        <option value="push">Push</option>
                        <option value="pull">Pull</option>
                        <option value="hinge">Hinge</option>
                        <option value="squat">Squat</option>
                        <option value="specific-muscles">Specific Muscle Group</option>
                    </select>
                </div>
                <div id="muscle-checkboxes" class="hidden space-y-2 bg-gray-50 p-4 rounded-xl">
                    <p class="font-bold text-sm">Select Muscles:</p>
                    <div id="muscle-options" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                </div>
                <button type="submit" class="w-full py-4 bg-green-600 text-white font-bold rounded-xl shadow-lg">Start Workout</button>
            </form>
        </div>

        <!-- WORKOUT TRACKING -->
        <div id="view-track-workout" class="view-container p-6 bg-white rounded-2xl shadow-2xl border-2 border-green-500 space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-xl md:text-2xl font-black text-green-700" id="active-workout-title">Active Session</h2>
                <button onclick="finishWorkout()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Finish</button>
            </div>
            
            <div class="bg-green-50 p-4 rounded-xl border border-green-200 space-y-4">
                <h3 class="font-bold text-green-800">Add Exercise</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="exercise-select" class="w-full p-3 border rounded-xl"></select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="sets-input" value="3" class="p-3 border rounded-xl text-center">
                        <input type="number" id="target-reps-input" value="10" class="p-3 border rounded-xl text-center">
                    </div>
                </div>
                <button onclick="renderSetsTracking()" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl">Configure Sets</button>
            </div>

            <div id="sets-tracking-container" class="space-y-4"></div>
            <div id="logged-exercises-summary" class="space-y-2 mt-4"></div>
        </div>

        <!-- BODY METRICS -->
        <div id="view-body-metrics" class="view-container p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="text-2xl font-bold text-purple-700">Metrics</h2>
                <button onclick="showView('dashboard')" class="bg-gray-100 px-4 py-2 rounded-lg">Back</button>
            </div>
            <button onclick="openSnapshotModal()" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg">Take Snapshot</button>
            <div id="measurements-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="history-modal" class="fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-2xl rounded-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="font-bold text-xl">Progress History</h2>
                <button onclick="closeModal('history-modal')" class="text-2xl">&times;</button>
            </div>
            <div id="history-content" class="p-4 overflow-y-auto space-y-4 bg-gray-50 flex-grow"></div>
        </div>
    </div>

    <div id="snapshot-modal" class="fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 space-y-4">
            <h2 class="text-xl font-bold text-purple-700 border-b pb-2">Daily Snapshot</h2>
            <form id="snapshot-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold">Weight</label>
                    <div class="flex gap-2">
                        <input type="number" id="weight-input" step="0.1" class="flex-grow p-3 border rounded-xl" required>
                        <select id="weight-unit-select" class="p-3 border rounded-xl"><option>kg</option><option>lbs</option></select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold">Arms</label>
                    <div class="flex gap-2">
                        <input type="number" id="arms-input" step="0.1" class="flex-grow p-3 border rounded-xl" required>
                        <select id="arm-unit-select" class="p-3 border rounded-xl"><option>cms</option><option>in</option></select>
                    </div>
                </div>
                <!--<div>
                    <label class="block text-sm font-bold">Legs</label>
                    <div class="flex gap-2">
                        <input type="number" id="legs-input" step="0.1" class="flex-grow p-3 border rounded-xl" required>
                        <select id="legs-unit-select" class="p-3 border rounded-xl"><option>cms</option><option>in</option></select>
                    </div>
                          <div>
                    <label class="block text-sm font-bold">chest</label>
                    <div class="flex gap-2">
                        <input type="number" id="chest-input" step="0.1" class="flex-grow p-3 border rounded-xl" required>
                        <select id="chest-unit-select" class="p-3 border rounded-xl"><option>cms</option><option>in</option></select>
                    </div>
                     </div><-->
                    <label class="block text-sm font-bold">Photo</label>
                    <input type="file" id="photo-file-input" class="w-full text-sm">
                </div>
                <button type="submit" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl">Save</button>
                <button type="button" onclick="closeModal('snapshot-modal')" class="w-full py-2 text-gray-400">Cancel</button>
            </form>
        </div>
    </div>

    <footer>&copy; 2025 VFit Fitness Dashboard</footer>

    <script>
        // --- DATA & STATE ---
        const LS_KEYS = { STATE: 'FT_STATE', LOG: 'FT_WORKOUTS', MEALS: 'FT_MEALS', METRICS: 'FT_METRICS', DB: 'FT_FOOD_DB', TODAY_MEALS: 'FT_TODAY_MEALS' };

        let state = {
            currentView: 'dashboard',
            userName: "Steven",
            goal: "Gain Muscle",
            gymName: "Home Gym",
            gymSetup: { 
                weights: ["dumbbell", "barbell", "pin machine", "weight machine", "cables"], 
                cardio: ["treadmill"], 
                floor: ["floor"] },
            exerciseHistory: {},
            currentWorkout: null,
            mealGoals: { calories: 2500, protein: 150 },
            foodDatabase: [
                { name: "Chicken Breast", calories: 165, protein: 31 },
                { name: "White Rice", calories: 130, protein: 2.7 },
                { name: "Egg", calories: 155, protein: 13 },
                { name: "Greek Yogurt", calories: 59, protein: 10 },
                { name: "Peanut Butter", calories: 588, protein: 25 }
            ],
            todayMeals: []
        };

        const EQUIPMENT_MAP = {
            weights: ["barbell", "dumbbell", "pinstack machines", "weighted machines", "cables machine", "smith machine", "bench"],
            cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
            floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball", "floor"]
        };

        const MUSCLE_GROUPS = ["chest", "back", "shoulders", "biceps", "triceps", "quads", "hamstrings", "glutes", "abs", "calves"];

        const EXERCISE_LIBRARY = [
            { name: "Bench Press", equipment: ["barbell", "bench"], focus: ["upper-body", "chest"] },
            { name: "Dumbbell Press", equipment: ["dumbbell", "bench"], focus: ["upper-body", "chest"] },
            { name: "Squats", equipment: ["barbell"], focus: ["lower-body", "quads", "glutes"] },
            { name: "Deadlifts", equipment: ["barbell"], focus: ["full-body", "back", "hamstrings"] },
            { name: "Shoulder Press", equipment: ["dumbbell"], focus: ["upper-body", "shoulders"] },
            { name: "Bicep Curls", equipment: ["dumbbell"], focus: ["upper-body", "biceps"] },
            { name: "Lat Pulldown", equipment: ["pinstack machines"], focus: ["upper-body", "back"] },
            { name: "Leg Press", equipment: ["weighted machines"], focus: ["lower-body", "quads"] },
            { name: "Treadmill Run", equipment: ["treadmill"], focus: ["full-body"] }
        ];

        let scanner = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            loadAllData();
            updateUI();
            showView('dashboard');
        };

        function loadAllData() {
            const savedState = localStorage.getItem(LS_KEYS.STATE);
            if (savedState) state = { ...state, ...JSON.parse(savedState) };
            
            const savedDb = localStorage.getItem(LS_KEYS.DB);
            if (savedDb) state.foodDatabase = JSON.parse(savedDb);

            const savedMeals = localStorage.getItem(LS_KEYS.TODAY_MEALS);
            if (savedMeals) state.todayMeals = JSON.parse(savedMeals);
            
            renderMealLog();
            renderMeasurements();
        }

        function saveState() {
            localStorage.setItem(LS_KEYS.STATE, JSON.stringify(state));
            localStorage.setItem(LS_KEYS.DB, JSON.stringify(state.foodDatabase));
            localStorage.setItem(LS_KEYS.TODAY_MEALS, JSON.stringify(state.todayMeals));
        }

        // --- NAVIGATION ---
        function showView(viewId) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.add('hidden'));
            const el = document.getElementById(`view-${viewId}`);
            if (el) el.classList.remove('hidden');
            
            // View specific init logic
            if (viewId === 'gym-config') renderGymConfig();
            if (viewId === 'plan-workout') renderMuscleOptions();
            if (viewId === 'track-workout') populateExerciseDropdown();
            if (viewId === 'meal-log') renderMealLog();
            
            updateUI();
        }

        function updateUI() {
            document.getElementById('user-name').textContent = state.userName;
            document.getElementById('user-goal').textContent = state.goal;
            document.getElementById('current-gym-status').textContent = `${state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length} items active`;
            document.getElementById('goal-cal-display').textContent = state.mealGoals.calories;
            document.getElementById('target-cal').textContent = state.mealGoals.calories;
            document.getElementById('target-prot').textContent = state.mealGoals.protein;
        }

        // --- GYM CONFIG ---
        function renderGymConfig() {
            const types = ['weights', 'cardio', 'floor'];
            types.forEach(type => {
                const container = document.getElementById(`${type}-options`);
                container.innerHTML = EQUIPMENT_MAP[type].map(item => `
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" name="${type}" value="${item}" ${state.gymSetup[type].includes(item) ? 'checked' : ''}>
                        ${item}
                    </label>
                `).join('');
            });
            document.getElementById('gym-name').value = state.gymName;
        }

        document.getElementById('gym-setup-form').onsubmit = (e) => {
            e.preventDefault();
            state.gymName = document.getElementById('gym-name').value;
            state.gymSetup.weights = Array.from(e.target.querySelectorAll('input[name="weights"]:checked')).map(i => i.value);
            state.gymSetup.cardio = Array.from(e.target.querySelectorAll('input[name="cardio"]:checked')).map(i => i.value);
            state.gymSetup.floor = Array.from(e.target.querySelectorAll('input[name="floor"]:checked')).map(i => i.value);
            saveState();
            showMessage("Gym Setup Saved");
            showView('dashboard');
        };

        // --- WORKOUT LOGIC ---
        function handleFocusChange() {
            const focus = document.getElementById('workout-focus').value;
            document.getElementById('muscle-checkboxes').classList.toggle('hidden', focus !== 'specific-muscles');
        }

        function renderMuscleOptions() {
            document.getElementById('muscle-options').innerHTML = MUSCLE_GROUPS.map(m => `
                <label class="flex items-center gap-2 text-xs">
                    <input type="checkbox" name="muscle" value="${m}"> ${m}
                </label>
            `).join('');
        }

        document.getElementById('workout-planning-form').onsubmit = (e) => {
            e.preventDefault();
            const focus = document.getElementById('workout-focus').value;
            const muscles = Array.from(e.target.querySelectorAll('input[name="muscle"]:checked')).map(i => i.value);
            
            state.currentWorkout = {
                title: focus === 'specific-muscles' ? `Focus: ${muscles.join(', ')}` : focus.replace('-', ' '),
                focus,
                muscles,
                date: new Date().toISOString(),
                exercises: []
            };
            
            document.getElementById('active-workout-title').textContent = state.currentWorkout.title;
            showView('track-workout');
        };

        function populateExerciseDropdown() {
            const availableEquip = [...state.gymSetup.weights, ...state.gymSetup.cardio, ...state.gymSetup.floor];
            const filtered = EXERCISE_LIBRARY.filter(ex => ex.equipment.some(e => availableEquip.includes(e)));
            
            document.getElementById('exercise-select').innerHTML = filtered.map(ex => `
                <option value="${ex.name}">${ex.name}</option>
            `).join('');
        }

        function renderSetsTracking() {
            const name = document.getElementById('exercise-select').value;
            const sets = parseInt(document.getElementById('sets-input').value);
            const targetReps = document.getElementById('target-reps-input').value;
            
            let html = `<div class="bg-white p-4 rounded-xl border-2 border-indigo-200 space-y-3">
                <h4 class="font-bold text-indigo-700">${name}</h4>`;
            
            for(let i=0; i<sets; i++) {
                html += `
                <div class="flex items-center gap-2 text-sm set-row" data-set="${i}">
                    <span class="w-12 font-bold">Set ${i+1}</span>
                    <input type="number" placeholder="kg" class="w-full p-2 border rounded weight-input">
                    <input type="number" value="${targetReps}" class="w-full p-2 border rounded reps-input">
                </div>`;
            }
            
            html += `<button onclick="logExercise('${name}')" class="w-full py-2 bg-indigo-500 text-white rounded-lg font-bold">Log Exercise</button></div>`;
            document.getElementById('sets-tracking-container').innerHTML = html;
        }

        function logExercise(name) {
            const rows = document.querySelectorAll('.set-row');
            const setsData = Array.from(rows).map(row => ({
                weight: parseFloat(row.querySelector('.weight-input').value) || 0,
                reps: parseInt(row.querySelector('.reps-input').value) || 0
            }));
            
            state.currentWorkout.exercises.push({ name, setsData });
            
            // PB check
            const maxWeight = Math.max(...setsData.map(s => s.weight));
            if(!state.exerciseHistory[name] || maxWeight > state.exerciseHistory[name].bestWeight) {
                state.exerciseHistory[name] = { bestWeight: maxWeight, date: new Date().toLocaleDateString() };
                showMessage(`New Personal Best for ${name}!`, 'success');
            }
            
            saveState();
            document.getElementById('sets-tracking-container').innerHTML = '';
            updateWorkoutSummary();
        }

        function updateWorkoutSummary() {
            const summary = document.getElementById('logged-exercises-summary');
            summary.innerHTML = state.currentWorkout.exercises.map(ex => `
                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm">
                    <span class="font-bold">${ex.name}</span>
                    <span class="text-gray-500">${ex.setsData.length} sets logged</span>
                </div>
            `).join('');
        }

        function finishWorkout() {
            const log = JSON.parse(localStorage.getItem(LS_KEYS.LOG) || '[]');
            log.push(state.currentWorkout);
            localStorage.setItem(LS_KEYS.LOG, JSON.stringify(log));
            state.currentWorkout = null;
            showMessage("Workout Saved to History");
            showView('dashboard');
        }

        // --- NUTRITION LOGIC ---
        function switchTab(evt, tabName) {
            // Hide all contents
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
            
            // Show target
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add("active");
                if (evt && evt.currentTarget) {
                    evt.currentTarget.classList.add("active");
                }
            }
            // Stop scanner if switching away from Add Food
            if (tabName !== 'addFoodTab' && scanner) {
                stopScanner();
            }
        }

        function searchFood() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            if (term.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const matches = state.foodDatabase.filter(f => f.name.toLowerCase().includes(term));
            
            if (matches.length > 0) {
                resultsDiv.classList.remove('hidden');
                matches.forEach(food => {
                    const div = document.createElement('div');
                    div.textContent = `${food.name} (${food.calories} cal, ${food.protein}g p)`;
                    div.onclick = () => addToDailyLog(food);
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.classList.add('hidden');
            }
        }

        function addToDailyLog(food) {
            state.todayMeals.push({ ...food, time: new Date().toLocaleTimeString() });
            saveState();
            renderMealLog();
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            showMessage(`Ate ${food.name}`);
        }

        function renderMealLog() {
            const container = document.getElementById('today-log-container');
            if(!container) return;
            
            let totalCal = 0;
            let totalProt = 0;

            container.innerHTML = state.todayMeals.map((item, index) => {
                totalCal += item.calories;
                totalProt += item.protein;
                return `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded border-b">
                    <div>
                        <div class="font-bold">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.calories} kcal | ${item.protein}g protein</div>
                    </div>
                    <button onclick="removeMeal(${index})" class="text-red-500 text-xs">X</button>
                </div>`;
            }).join('');

            // Update Summaries
            document.getElementById('val-cal').textContent = totalCal.toFixed(0);
            document.getElementById('val-prot').textContent = totalProt.toFixed(0);
            
            const calPercent = Math.min((totalCal / state.mealGoals.calories) * 100, 100);
            document.getElementById('cal-progress').style.width = `${calPercent}%`;
            
            // Inputs setup
            document.getElementById('goalCaloriesInput').value = state.mealGoals.calories;
            document.getElementById('goalProteinInput').value = state.mealGoals.protein;
        }

        function removeMeal(index) {
            state.todayMeals.splice(index, 1);
            saveState();
            renderMealLog();
        }

        function saveGoals() {
            state.mealGoals.calories = parseInt(document.getElementById('goalCaloriesInput').value) || 2000;
            state.mealGoals.protein = parseInt(document.getElementById('goalProteinInput').value) || 150;
            saveState();
            updateUI();
            renderMealLog();
            showMessage("Nutrition Goals Saved");
        }

        function addNewFoodToDb() {
            const name = document.getElementById('new-food-name').value;
            const cal = parseFloat(document.getElementById('new-food-cal').value);
            const prot = parseFloat(document.getElementById('new-food-prot').value);

            if (name && !isNaN(cal) && !isNaN(prot)) {
                state.foodDatabase.push({ name, calories: cal, protein: prot });
                saveState();
                showMessage(`${name} added to database`);
                // Clear inputs
                document.getElementById('new-food-name').value = '';
                document.getElementById('new-food-cal').value = '';
                document.getElementById('new-food-prot').value = '';
                switchTab(null, 'trackerTab'); // Switch back to tracker
            } else {
                alert("Please fill all fields correctly");
            }
        }

        // --- SCANNER LOGIC ---
        function startScanner() {
            const readerDiv = document.getElementById("reader");
            readerDiv.innerHTML = "";
            document.getElementById('stop-scan-btn').classList.remove('hidden');
            
            scanner = new Html5Qrcode("reader");
            
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length > 0) {
                    const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
                    scanner.start(
                        backCam.id,
                        { fps: 10, qrbox: 250 },
                        (decodedText) => {
                            stopScanner();
                            fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`)
                                .then(res => res.json())
                                .then(data => {
                                    if(data.status === 1) {
                                        const p = data.product;
                                        // Fill inputs
                                        document.getElementById('new-food-name').value = p.product_name || "Unknown";
                                        document.getElementById('new-food-cal').value = p.nutriments["energy-kcal_100g"] || 0;
                                        document.getElementById('new-food-prot').value = p.nutriments.proteins_100g || 0;
                                        alert("Product Found! details filled. Please confirm and Add.");
                                    } else {
                                        alert("Product not found in database.");
                                    }
                                }).catch(err => alert("Error fetching product data"));
                        }
                    );
                } else {
                    alert("No camera found");
                }
            }).catch(err => {
                console.error(err);
                alert("Camera permission error");
            });
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop().then(() => {
                    document.getElementById('reader').innerHTML = "";
                    document.getElementById('stop-scan-btn').classList.add('hidden');
                    scanner = null;
                }).catch(err => console.log(err));
            }
        }

        // --- BODY METRICS ---
        function openSnapshotModal() { document.getElementById('snapshot-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        document.getElementById('snapshot-form').onsubmit = async (e) => {
            e.preventDefault();
            const weight = parseFloat(document.getElementById('weight-input').value);
            const unit = document.getElementById('weight-unit-select').value;
            const arm = parseFloat(document.getElementById('arm-input').value);
            const unita = document.getElementById('arm-unit-select').value;

            const file = document.getElementById('photo-file-input').files[0];
            
            let photo = null;
            if(file) {
                photo = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = (e) => res(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const metrics = JSON.parse(localStorage.getItem(LS_KEYS.METRICS) || '[]');
            metrics.push({ date: new Date().toISOString(), weight, unit, arm, unita, photo });
            localStorage.setItem(LS_KEYS.METRICS, JSON.stringify(metrics));
            renderMeasurements();
            closeModal('snapshot-modal');
        };

        function renderMeasurements() {
            const metrics = JSON.parse(localStorage.getItem(LS_KEYS.METRICS) || '[]').reverse();
            document.getElementById('measurements-container').innerHTML = metrics.map(m => `
                <div class="bg-white p-4 rounded-xl shadow border-t-4 border-purple-500">
                    <p class="text-xs text-gray-400">${new Date(m.date).toLocaleDateString()}</p>
                    <p class="text-2xl font-black">${m.weight} ${m.unit}</p>
                    <p class="text-2xl font-black">${m.arm} ${m.unita}</p>
                    ${m.photo ? `<img src="${m.photo}" class="mt-2 rounded-lg w-full h-40 object-cover">` : ''}
                </div>
            `).join('');
        }

        // --- HISTORY ---
        function openHistory() {
            const modal = document.getElementById('history-modal');
            modal.classList.remove('hidden');
            const workouts = JSON.parse(localStorage.getItem(LS_KEYS.LOG) || '[]').reverse();
            
            document.getElementById('history-content').innerHTML = workouts.length ? workouts.map(w => `
                <div class="bg-white p-4 rounded-xl border">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-indigo-600">${w.title}</span>
                        <span class="text-xs text-gray-400">${new Date(w.date).toLocaleDateString()}</span>
                    </div>
                    <div class="text-xs space-y-1">
                        ${w.exercises.map(ex => `<div>${ex.name}: ${ex.setsData.length} sets</div>`).join('')}
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-400">No workouts recorded.</p>';
        }

        // --- UTILS ---
        function showMessage(text, type = "success") {
            const box = document.getElementById('message-box');
            document.getElementById('message-text').textContent = text;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('opacity-100'), 10);
            setTimeout(() => {
                box.classList.remove('opacity-100');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        function resetApp() {
            if(confirm("Delete all data? This cannot be undone.")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>

