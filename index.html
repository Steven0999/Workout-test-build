<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FitTrack Pro - Complete fitness tracking app with cloud sync">
    <meta name="theme-color" content="#4f46e5">
    <title>FitTrack Pro - Your Complete Fitness Companion</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí™</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #f43f5e;
            --bg-main: #f8fafc;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .photo-slot {
            aspect-ratio: 3/4;
            background: #f1f5f9;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            border: 2px dashed #e2e8f0;
            position: relative;
            transition: all 0.2s;
            min-height: 120px;
        }
        
        .photo-slot:hover { border-color: var(--brand-primary); transform: scale(1.02); }
        .photo-slot:active { transform: scale(0.98); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-overlay > div {
            width: 100%;
            max-width: 32rem;
            margin: auto;
        }

        .store-dropdown { animation: dropdownPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropdownPop {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            word-wrap: break-word;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        button { 
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.97); }

        input, select {
            min-height: 48px;
            font-size: 16px;
        }

        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .translate-x-0 { transform: translateX(0); }
        .-translate-x-full { transform: translateX(-100%); }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin { animation: spin 1s linear infinite; }

        /* Auth screens */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #app-screen { display: none; }

        .input-group { position: relative; }
        .input-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }
        .input-group input { padding-left: 3rem; }

        /* Cloud sync indicator */
        .sync-indicator {
            position: fixed;
            top: 70px;
            right: 16px;
            background: #1e293b;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            z-index: 300;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .sync-indicator.show { opacity: 1; transform: translateY(0); }

        @media (max-width: 640px) {
            main { padding: 0.75rem !important; }
            .space-y-6 > * + * { margin-top: 1rem !important; }
            .glass-card { padding: 1rem !important; }

            .text-5xl { font-size: 2.25rem !important; line-height: 1.2; }
            .text-4xl { font-size: 1.875rem !important; line-height: 1.2; }
            .text-3xl { font-size: 1.5rem !important; line-height: 1.3; }
            .text-2xl { font-size: 1.25rem !important; }
            .text-xl { font-size: 1.125rem !important; }

            .modal-overlay > div {
                border-radius: 1.5rem !important;
                padding: 1.25rem !important;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
            
            button { min-height: 48px !important; }
            input, select { min-height: 52px !important; font-size: 16px !important; }
        }

        .muscle-chip.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .flex-1 { flex: 1 1 0%; min-width: 0; }

        header { padding: 1rem 1.25rem; }
        @media (max-width: 640px) { header { padding: 0.875rem 1rem; } }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>
    <div id="sync-indicator" class="sync-indicator">‚òÅÔ∏è Saving...</div>

    <!-- ========================================== -->
    <!-- AUTH SCREEN -->
    <!-- ========================================== -->
    <div id="auth-screen">
        <div class="w-full max-w-md px-4">
            <div class="bg-white rounded-[3rem] p-8 shadow-2xl">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üí™</div>
                    <h1 class="text-3xl font-black text-indigo-600 mb-2">FitTrack<span class="text-slate-600">Pro</span></h1>
                    <p class="text-slate-500 text-sm">Your complete fitness companion</p>
                </div>

                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="login-password" placeholder="Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="loginUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Sign In
                        </button>
                        <button onclick="showForgotPassword()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Forgot Password?
                        </button>
                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Don't have an account?</p>
                            <button onclick="showRegister()" class="text-indigo-600 font-bold hover:text-indigo-700">Create Account</button>
                        </div>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <input type="text" id="register-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="register-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-password" placeholder="Password (min 6 characters)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-confirm" placeholder="Confirm Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="registerUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Create Account
                        </button>
                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Already have an account?</p>
                            <button onclick="showLogin()" class="text-indigo-600 font-bold hover:text-indigo-700">Sign In</button>
                        </div>
                    </div>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgot-password-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Reset Password</h2>
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600 text-center mb-4">Enter your email and we'll send you a reset link</p>
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="forgot-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="resetPassword()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Send Reset Link
                        </button>
                        <button onclick="showLogin()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Back to Login
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-center text-white text-xs mt-6 opacity-75">
                By continuing, you agree to our Terms of Service and Privacy Policy
            </p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MAIN APP SCREEN -->
    <!-- ========================================== -->
    <div id="app-screen">

        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-4 sm:px-6 py-4 sm:py-5 sticky top-0 z-40 flex justify-between items-center">
            <button onclick="toggleSidebar()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Menu">
                <i data-lucide="menu" class="w-6 h-6 text-slate-700"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">FitTrack<span class="text-slate-600">Pro</span></h1>
                <div class="flex items-center gap-2 justify-center">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p id="status-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Loading...</p>
                </div>
            </div>
            <button onclick="switchTab('profile')" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Profile">
                <i data-lucide="user" class="w-6 h-6 text-slate-700"></i>
            </button>
        </header>

        <main class="max-w-xl mx-auto p-4 sm:p-6 space-y-6">

            <!-- ============================== -->
            <!-- DASHBOARD TAB -->
            <!-- ============================== -->
            <section id="dashboard" class="tab-content active space-y-6">
                <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center relative overflow-hidden">
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 192 192">
                            <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                            <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                        </svg>
                        <div class="absolute text-center">
                            <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Eaten</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                        <div class="text-center"><div id="dash-protein" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Protein</div></div>
                        <div class="text-center border-x"><div id="dash-carbs" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Carbs</div></div>
                        <div class="text-center"><div id="dash-fat" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Fats</div></div>
                    </div>
                </div>

                <!-- Hydration Tracker -->
                <div id="hydration-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="droplet" class="text-cyan-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Hydration Goal</h4>
                                <p id="water-count" class="text-xs text-slate-500">0 / 2.5L</p>
                            </div>
                        </div>
                        <button onclick="toggleHydrationGoal()" id="hydration-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click ‚úì when you reach your daily goal</div>
                </div>

                <!-- Steps Tracker -->
                <div id="steps-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="footprints" class="text-amber-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Steps Goal</h4>
                                <p id="steps-count" class="text-xs text-slate-500">0 / 10,000</p>
                            </div>
                        </div>
                        <button onclick="toggleStepsGoal()" id="steps-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click ‚úì when you reach your daily goal</div>
                </div>

                <!-- Habits Tracker -->
                <div id="habits-tracker" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="check-circle" class="text-purple-500"></i>
                            </div>
                            <h3 class="font-bold text-lg">Daily Habits</h3>
                        </div>
                    </div>
                    <div id="dashboard-habits-list" class="space-y-3"></div>
                </div>

                <!-- Weekly Overview -->
                <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-xl">
                    <h3 class="text-lg font-bold mb-1">Weekly Overview</h3>
                    <div id="muscle-volume-stats" class="grid grid-cols-2 gap-y-3 gap-x-6 mb-6"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="switchTab('training')" class="bg-indigo-600 px-4 py-3 rounded-2xl font-bold text-xs uppercase hover:bg-indigo-700">Log Workout</button>
                        <button onclick="switchTab('nutrition')" class="bg-emerald-600 px-4 py-3 rounded-2xl font-bold text-xs uppercase hover:bg-emerald-700">Add Food</button>
                    </div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- PROFILE TAB -->
            <!-- ============================== -->
            <section id="profile" class="tab-content space-y-6">
                <div class="glass-card p-8 rounded-[3rem] text-center">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="user" class="w-12 h-12 text-indigo-600"></i>
                    </div>
                    <h2 id="profile-name" class="text-2xl font-black mb-2">User Name</h2>
                    <p id="profile-email" class="text-sm text-slate-500 mb-6">user@example.com</p>

                    <div class="space-y-3">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Member Since</p>
                            <p id="profile-created" class="font-bold">Loading...</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Total Workouts</p>
                            <p id="profile-workouts" class="font-bold">0</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Account Status</p>
                            <p class="font-bold text-emerald-600">‚úì Active (Cloud Sync)</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Last Cloud Sync</p>
                            <p id="profile-last-sync" class="font-bold text-indigo-600 text-sm">Not yet synced</p>
                        </div>
                    </div>

                    <button onclick="syncToCloud()" class="w-full mt-4 bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">
                        ‚òÅÔ∏è Sync to Cloud
                    </button>

                    <button onclick="logoutUser()" class="w-full mt-3 bg-red-500 text-white p-4 rounded-2xl font-bold hover:bg-red-600">
                        Sign Out
                    </button>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">App Settings</h3>
                    <button onclick="switchTab('settings')" class="w-full bg-slate-100 p-4 rounded-xl font-medium text-left flex items-center justify-between">
                        <span>Preferences & Goals</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- TRAINING TAB -->
            <!-- ============================== -->
            <section id="training" class="tab-content space-y-6">
                <!-- Date Selector -->
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeWorkoutDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="workout-date-picker" onchange="selectWorkoutDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeWorkoutDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="workout-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Finish Workout" to confirm</p>
                    </div>
                </div>

                <!-- Workout Setup -->
                <div id="workout-setup" class="glass-card p-6 rounded-[2.5rem] space-y-4">
                    <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                        <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Gym</button>
                        <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-slate-400">Home</button>
                    </div>
                    
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Exercise Focus</label>
                        <select id="workout-focus" onchange="toggleSpecificMuscle()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Full Body</option>
                            <option>Upper</option>
                            <option>Lower</option>
                            <option>Push</option>
                            <option>Pull</option>
                            <option>Legs</option>
                            <option>Specific Muscle</option>
                        </select>
                    </div>

                    <div id="specific-muscle-container" class="hidden">
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Muscle</label>
                        <select id="specific-muscle" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Chest</option>
                            <option>Back</option>
                            <option>Shoulders</option>
                            <option>Biceps</option>
                            <option>Triceps</option>
                            <option>Quads</option>
                            <option>Hamstrings</option>
                            <option>Glutes</option>
                            <option>Calves</option>
                        </select>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Cardio</span>
                            <input type="checkbox" id="add-cardio-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Core</span>
                            <input type="checkbox" id="add-core-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="startWorkout('manual')" class="p-5 bg-slate-900 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-slate-800 active:bg-slate-700">Manual Entry</button>
                        <button onclick="startWorkout('ai')" class="p-5 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-indigo-700 active:bg-indigo-800">AI Generate</button>
                    </div>
                    
                    <button onclick="openCardioModal()" class="w-full mt-3 p-5 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-[1.5rem] font-bold text-base flex items-center justify-center gap-2 hover:from-cyan-600 hover:to-blue-600">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                        Log Outdoor Cardio
                    </button>
                </div>

                <!-- Active Workout -->
                <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div>
                            <h3 id="active-workout-title" class="text-xl font-black">Workout</h3>
                            <p id="workout-timer" class="text-indigo-600 font-bold">00:00:00</p>
                        </div>
                        <button onclick="cancelWorkout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl text-xl font-bold">√ó</button>
                    </div>
                    <div id="exercise-list" class="space-y-4 mb-6"></div>
                    <button onclick="addExercise()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs mb-4 hover:border-indigo-400 hover:text-indigo-500">+ Add Exercise</button>
                    <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold hover:bg-slate-800">Finish Workout</button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- NUTRITION TAB -->
            <!-- ============================== -->
            <section id="nutrition" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setNutritionTab('diary')" id="nut-tab-diary" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Diary</button>
                    <button onclick="setNutritionTab('search')" id="nut-tab-search" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Search</button>
                </div>

                <!-- DIARY VIEW -->
                <div id="nut-view-diary" class="space-y-6">
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex items-center justify-between gap-3">
                            <button onclick="changeNutritionDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <div class="flex-1">
                                <input type="date" id="nutrition-date-picker" onchange="selectNutritionDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                            </div>
                            <button onclick="changeNutritionDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="nutrition-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                            <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Save Changes" to confirm</p>
                        </div>
                    </div>

                    <div id="nutrition-save-buttons" class="hidden flex gap-3">
                        <button onclick="saveNutritionChanges()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700">Save Changes</button>
                        <button onclick="cancelNutritionChanges()" class="flex-1 py-4 bg-slate-200 text-slate-700 rounded-2xl font-bold hover:bg-slate-300">Cancel</button>
                    </div>

                    <div class="bg-white rounded-[32px] p-8 border border-slate-100 shadow-xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <div id="total-kcal" class="text-5xl font-black text-slate-900 mb-1">0</div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Calories Today</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black text-blue-600 flex items-center gap-1 justify-end">
                                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i> <span id="total-protein">0.0</span>g
                                </div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Protein</div>
                            </div>
                        </div>
                    </div>

                    <div id="meal-sections"></div>

                    <div class="text-center py-4 px-6 bg-indigo-50 rounded-2xl border border-indigo-100 mt-6">
                        <div class="flex items-center justify-center gap-2 mb-1">
                            <i data-lucide="cloud" class="w-4 h-4 text-indigo-600"></i>
                            <p class="text-sm font-bold text-indigo-900">Cloud Sync Enabled</p>
                        </div>
                        <p class="text-xs text-indigo-600">Your meals are saved to your account in real-time</p>
                    </div>
                </div>

                <!-- SEARCH VIEW -->
                <div id="nut-view-search" class="hidden space-y-6">
                    <div>
                        <label class="text-xs font-semibold text-slate-400 ml-1 mb-2 block">Store / Restaurant</label>
                        <div class="relative">
                            <input 
                                id="store-search-input" 
                                type="text" 
                                placeholder="Search stores or restaurants..." 
                                class="w-full p-4 bg-white rounded-3xl border border-slate-100 font-medium outline-none"
                                onfocus="showStoreDropdown()"
                                oninput="filterStoreDropdown(this.value)"
                                autocomplete="off">
                            <div id="store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto store-dropdown"></div>
                        </div>
                        <input type="hidden" id="store-select" value="all">
                    </div>

                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                            <input id="food-search-input" type="text" placeholder="Search food..." 
                                class="w-full bg-slate-100 border-2 border-transparent rounded-[20px] py-4 pl-12 pr-4 focus:bg-white focus:border-emerald-500 outline-none font-semibold">
                        </div>
                        <button onclick="openBarcodeScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:bg-indigo-700">
                            <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <button onclick="openCreateMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700">
                        Create Meal
                    </button>

                    <div id="created-meals-list" class="space-y-3"></div>

                    <div id="search-loading" class="hidden py-20 text-center">
                        <i data-lucide="loader-2" class="animate-spin text-emerald-500 mx-auto w-8 h-8"></i>
                    </div>
                    <div id="search-results-list" class="space-y-3"></div>
                    
                    <div class="text-center py-4">
                        <p class="text-xs text-slate-400 mb-3">Can't find what you're looking for?</p>
                        <button onclick="openManualFoodEntry()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-slate-800 transition-all">
                            + Add Food Manually
                        </button>
                    </div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- LOGS TAB -->
            <!-- ============================== -->
            <section id="logs" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setLogsTab('training')" id="logs-tab-training" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Training</button>
                    <button onclick="setLogsTab('nutrition')" id="logs-tab-nutrition" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Nutrition</button>
                </div>
                
                <div id="logs-training-view" class="space-y-4">
                    <div class="glass-card p-4 rounded-2xl">
                        <p class="text-xs font-black uppercase text-slate-400 mb-3">Filter Workouts</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-weights" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üí™ Weights</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-cardio" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üèÉ Cardio</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-core" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üéØ Core</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-walking" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üö∂ Walking</span>
                            </label>
                        </div>
                    </div>
                    <div id="training-logs-list"></div>
                </div>

                <div id="logs-nutrition-view" class="hidden space-y-4">
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                            <i data-lucide="droplet" class="w-5 h-5 text-cyan-500"></i>
                            Hydration History
                        </h3>
                        <div id="hydration-logs-list" class="space-y-2"></div>
                    </div>
                    <div id="nutrition-logs-list"></div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- METRICS TAB -->
            <!-- ============================== -->
            <section id="metrics" class="tab-content space-y-6">
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeMetricsDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="metrics-date-picker" onchange="selectMetricsDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeMetricsDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="metrics-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Recording for past date - Click "Save Metrics" to confirm</p>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-[3rem] space-y-8">
                    <div class="bg-slate-50 p-6 rounded-3xl text-center border">
                        <span class="text-[10px] font-black uppercase text-slate-400 block mb-2">Weight (kg)</span>
                        <input id="metric-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-transparent text-center text-5xl font-black outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Chest (cm)</label>
                            <input id="metric-chest" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Shoulders (cm)</label>
                            <input id="metric-shoulders" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Arms (cm)</label>
                            <input id="metric-arms" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Waist (cm)</label>
                            <input id="metric-waist" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Legs (cm)</label>
                            <input id="metric-legs" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Glutes (cm)</label>
                            <input id="metric-glutes" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 text-center">Progress Photos</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="photo-slot" onclick="triggerPhotoUpload('front')">
                                <img id="photo-front-preview" class="hidden" alt="Front">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Front</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('side')">
                                <img id="photo-side-preview" class="hidden" alt="Side">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Side</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('back')">
                                <img id="photo-back-preview" class="hidden" alt="Back">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Back</span>
                            </div>
                        </div>
                        <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                    </div>

                    <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase hover:bg-rose-600">
                        Save Metrics
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openMetricsChart()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                        <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="line-chart" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">Progress Charts</h4>
                        <p class="text-xs text-slate-400">View trends</p>
                    </button>
                    <button onclick="openPhotoComparison()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                        <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="images" class="w-6 h-6 text-emerald-600"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">Compare Photos</h4>
                        <p class="text-xs text-slate-400">Side by side</p>
                    </button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- SETTINGS TAB -->
            <!-- ============================== -->
            <section id="settings" class="tab-content space-y-6">
                <div class="glass-card p-6 rounded-[2.5rem] space-y-8">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Calorie Goal</label>
                        <input id="calorie-goal-input" type="number" value="2500" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none" onchange="updateCalorieGoal(this.value)">
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Gym Equipment</h3>
                        <div id="gym-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Home Equipment</h3>
                        <div id="home-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[11px] font-black uppercase text-slate-400">Daily Habits</h3>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="habits-enabled" onchange="toggleHabits()" class="w-5 h-5 accent-indigo-600">
                                <span class="text-xs font-bold text-slate-600">Enable</span>
                            </label>
                        </div>
                        <div id="habits-section" class="hidden space-y-3">
                            <div class="flex gap-2">
                                <input id="new-habit-input" type="text" placeholder="Add a new habit..." class="flex-1 p-3 bg-slate-50 rounded-xl outline-none">
                                <button onclick="addHabit()" class="px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Add</button>
                            </div>
                            <div id="habits-list" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-6">
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Tracking Options</h3>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Track Hydration</p>
                                    <p class="text-xs text-slate-500">Log daily water intake</p>
                                </div>
                                <input type="checkbox" id="track-hydration" onchange="toggleTracking('hydration')" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Track Steps</p>
                                    <p class="text-xs text-slate-500">Count daily steps</p>
                                </div>
                                <input type="checkbox" id="track-steps" onchange="toggleTracking('steps')" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[11px] font-black uppercase text-slate-400">Goals</h3>
                            <button onclick="openGoalSetting()" class="text-xs font-bold text-indigo-600 hover:text-indigo-700">+ Add Goal</button>
                        </div>
                        <div id="goals-list" class="space-y-2"></div>
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">
                        Save Settings
                    </button>

                    <!-- ============================== -->
                    <!-- DANGER ZONE ‚Äî Delete Account  -->
                    <!-- ============================== -->
                    <div class="border-t-2 border-red-100 pt-6 mt-4">
                        <h3 class="text-[11px] font-black uppercase text-red-400 mb-2">Danger Zone</h3>
                        <p class="text-xs text-slate-500 mb-4">Permanently deletes your account and all associated data. This cannot be undone.</p>
                        <button onclick="openDeleteAccountModal()" class="w-full bg-red-50 text-red-600 border-2 border-red-200 p-4 rounded-2xl font-bold hover:bg-red-100 hover:border-red-400 transition-all">
                            üóëÔ∏è Delete My Account
                        </button>
                    </div>
                </div>
            </section>

        </main>

        <!-- ========================================== -->
        <!-- SIDEBAR -->
        <!-- ========================================== -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100]" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-80 bg-white shadow-2xl z-[101] transform -translate-x-full">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-black text-indigo-600">Menu</h2>
                    <button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav class="space-y-2">
                    <button onclick="switchTab('dashboard'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Dashboard</span>
                    </button>
                    <button onclick="switchTab('training'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="dumbbell" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Training</span>
                    </button>
                    <button onclick="switchTab('nutrition'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="apple" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Nutrition</span>
                    </button>
                    <button onclick="switchTab('logs'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="clipboard-list" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Logs</span>
                    </button>
                    <button onclick="switchTab('metrics'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Metrics</span>
                    </button>
                    <button onclick="switchTab('profile'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="user" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Profile</span>
                    </button>
                    <button onclick="switchTab('settings'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Settings</span>
                    </button>
                </nav>

                <!-- User info in sidebar -->
                <div class="mt-8 p-4 bg-slate-50 rounded-2xl">
                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Signed in as</p>
                    <p id="sidebar-user-email" class="text-sm font-bold text-slate-700 truncate">Loading...</p>
                    <button onclick="logoutUser(); toggleSidebar();" class="w-full mt-3 text-xs text-red-500 font-bold hover:text-red-600">Sign Out</button>
                </div>
            </div>
        </div>

    </div><!-- END APP SCREEN -->

    <!-- ========================================== -->
    <!-- MODALS -->
    <!-- ========================================== -->

    <!-- DELETE ACCOUNT MODAL -->
    <div id="delete-account-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                </div>
                <h3 class="text-2xl font-black text-red-600 mb-2">Delete Account</h3>
                <p class="text-sm text-slate-600">This will <strong>permanently delete</strong> your account and all your fitness data including workouts, nutrition logs, metrics, and progress photos. This action <strong>cannot be undone</strong>.</p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-2xl p-4 mb-6">
                <p class="text-xs text-red-700 font-bold text-center">‚ö†Ô∏è All your data will be permanently erased</p>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Confirm your password to proceed</label>
                <div class="input-group">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                    <input type="password" id="delete-account-password" placeholder="Enter your current password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-red-500 font-medium">
                </div>
            </div>
            <button onclick="confirmDeleteAccount()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black hover:bg-red-700 mb-3 transition-all">
                Permanently Delete My Account
            </button>
            <button onclick="closeDeleteAccountModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel ‚Äî Keep My Account
            </button>
        </div>
    </div>

    <!-- MANUAL FOOD ENTRY MODAL -->
    <div id="manual-food-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Add Food Manually</h3>
                <button onclick="closeManualFoodEntry()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Image (Optional)</label>
                <div class="flex items-center gap-4">
                    <div id="manual-food-preview" class="w-24 h-24 bg-slate-100 rounded-2xl flex items-center justify-center overflow-hidden">
                        <i data-lucide="image" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="manual-food-image" accept="image/*" class="hidden" onchange="previewManualFoodImage(event)">
                        <button onclick="document.getElementById('manual-food-image').click()" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100">
                            Choose Image
                        </button>
                        <button onclick="clearManualFoodImage()" class="w-full mt-2 py-2 text-xs text-slate-400 hover:text-red-600">
                            Clear Image
                        </button>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Name</label>
                <input type="text" id="manual-food-name" placeholder="e.g., Chicken Sandwich" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Store / Restaurant</label>
                <div class="relative">
                    <input 
                        id="manual-food-store-input" 
                        type="text" 
                        placeholder="Search stores or restaurants..." 
                        class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500"
                        onfocus="showManualStoreDropdown()"
                        oninput="filterManualStoreDropdown(this.value)"
                        autocomplete="off">
                    <div id="manual-store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories (kcal)</label>
                    <input type="number" id="manual-food-calories" min="0" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Protein (g)</label>
                    <input type="number" id="manual-food-protein" min="0" step="0.1" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
            </div>
            <div class="mb-6">
                <button onclick="toggleManualFoodMacros()" class="w-full text-left text-xs font-bold text-indigo-600 hover:text-indigo-700 mb-3">
                    <span id="manual-macros-toggle">+ Add More Details (Optional)</span>
                </button>
                <div id="manual-food-macros" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Carbs (g)</label>
                        <input type="number" id="manual-food-carbs" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fat (g)</label>
                        <input type="number" id="manual-food-fat" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fiber (g)</label>
                        <input type="number" id="manual-food-fiber" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Sugar (g)</label>
                        <input type="number" id="manual-food-sugar" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Serving Size</label>
                <input type="text" id="manual-food-serving" placeholder="e.g., 1 sandwich, 100g" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <button onclick="saveManualFood()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:bg-emerald-700 mb-3">
                Save to My Foods
            </button>
            <button onclick="closeManualFoodEntry()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel
            </button>
        </div>
    </div>

    <!-- GOAL SETTING MODAL -->
    <div id="goal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Set Goal</h3>
                <button onclick="closeGoalModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Type</label>
                <select id="goal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="short">Short-term (1-4 weeks)</option>
                    <option value="medium">Medium-term (1-3 months)</option>
                    <option value="long">Long-term (3+ months)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Description</label>
                <input type="text" id="goal-description" placeholder="e.g., Lose 5kg, Run 5k" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Target Date</label>
                <input type="date" id="goal-deadline" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <button onclick="saveGoal()" class="w-full bg-indigo-600 text-white py-5 rounded-[24px] font-black hover:bg-indigo-700 mb-3">
                Save Goal
            </button>
            <button onclick="closeGoalModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- CARDIO LOGGING MODAL -->
    <div id="cardio-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Log Cardio Activity</h3>
                <button onclick="closeCardioModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Activity Type</label>
                <select id="cardio-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="running">üèÉ Running</option>
                    <option value="cycling">üö¥ Cycling</option>
                    <option value="swimming">üèä Swimming</option>
                    <option value="walking">üö∂ Walking</option>
                    <option value="hiking">‚õ∞Ô∏è Hiking</option>
                    <option value="rowing">üö£ Rowing</option>
                    <option value="elliptical">‚ö° Elliptical</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Duration (min)</label>
                    <input type="number" id="cardio-duration" min="1" placeholder="30" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Distance (km)</label>
                    <input type="number" id="cardio-distance" min="0" step="0.1" placeholder="5.0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories Burned (optional)</label>
                <input type="number" id="cardio-calories" min="0" placeholder="300" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Notes (optional)</label>
                <textarea id="cardio-notes" rows="3" placeholder="How did it feel?" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none resize-none"></textarea>
            </div>
            <button onclick="saveCardio()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black hover:bg-emerald-700 mb-3">
                Save Activity
            </button>
            <button onclick="closeCardioModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- EXERCISE DEMONSTRATION MODAL -->
    <div id="exercise-demo-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="demo-exercise-name" class="text-xl sm:text-2xl font-black">Exercise Demo</h3>
                <button onclick="closeExerciseDemo()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none hover:bg-slate-200">√ó</button>
            </div>
            <div class="mb-6">
                <div id="demo-video-container" class="aspect-video bg-slate-100 rounded-2xl overflow-hidden mb-4 flex items-center justify-center">
                    <iframe id="demo-video" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">How to perform</h4>
                <div id="demo-instructions" class="space-y-2 text-sm text-slate-700"></div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">Muscles targeted</h4>
                <div id="demo-muscles" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">Tips</h4>
                <div id="demo-tips" class="space-y-2 text-sm text-slate-700"></div>
            </div>
            <button onclick="closeExerciseDemo()" class="w-full bg-indigo-600 text-white py-4 rounded-[24px] font-black hover:bg-indigo-700">
                Back to Workout
            </button>
        </div>
    </div>

    <!-- FOOD ITEM POPUP -->
    <div id="food-popup" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 h-32 sm:w-40 sm:h-40 bg-slate-50 rounded-3xl overflow-hidden mb-4 p-3 shadow-lg border-2 border-slate-100">
                    <img id="popup-image" src="" class="w-full h-full object-contain" alt="Food image">
                </div>
                <h2 id="popup-name" class="text-xl sm:text-2xl font-black text-center leading-tight mb-2">Product</h2>
            </div>
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-5 rounded-3xl mb-6 shadow-sm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Calories</p>
                        <p id="popup-nutrition-cals" class="font-black text-3xl text-indigo-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">kcal</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Protein</p>
                        <p id="popup-nutrition-protein" class="font-black text-3xl text-blue-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">grams</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 pt-3 border-t border-indigo-200">
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Carbs</p>
                        <p id="popup-nutrition-carbs" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fat</p>
                        <p id="popup-nutrition-fat" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fiber</p>
                        <p id="popup-nutrition-fiber" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                </div>
                <div id="detailed-nutrition" class="hidden mt-3 pt-3 border-t border-indigo-200">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sugar</p>
                            <p id="popup-nutrition-sugar" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sat Fat</p>
                            <p id="popup-nutrition-satfat" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sodium</p>
                            <p id="popup-nutrition-sodium" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Cholest</p>
                            <p id="popup-nutrition-cholesterol" class="font-bold text-indigo-600">0mg</p>
                        </div>
                    </div>
                </div>
                <button onclick="toggleDetailedNutrition()" class="w-full mt-2 text-[10px] font-bold text-indigo-600 hover:text-indigo-700">
                    <span id="toggle-text">Show More ‚ñº</span>
                </button>
                <p id="popup-nutrition" class="text-xs text-center text-slate-500 mt-3"></p>
            </div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Meal Type</label>
                <select id="popup-meal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-base">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label>
                <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-4">
                    <button onclick="setAmountType('portion')" id="amount-type-portion" class="flex-1 py-3 rounded-xl text-xs font-black uppercase bg-white shadow text-emerald-600">Portion</button>
                    <button onclick="setAmountType('grams')" id="amount-type-grams" class="flex-1 py-3 rounded-xl text-xs font-black uppercase text-slate-400">Grams</button>
                </div>
                <input id="popup-amount" type="number" value="1" min="1" class="w-full bg-slate-50 border-4 border-slate-200 rounded-[24px] py-5 text-4xl font-black text-center outline-none focus:border-emerald-500 transition-colors">
            </div>
            <div class="bg-slate-900 text-white p-5 rounded-3xl mb-6 shadow-xl">
                <p class="text-[10px] font-black uppercase text-slate-400 text-center mb-3">Total You're Adding</p>
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <p id="popup-total-kcal" class="font-black text-3xl mb-1">0</p>
                        <p class="text-xs text-slate-400 uppercase">Calories</p>
                    </div>
                    <div class="w-px h-12 bg-slate-700"></div>
                    <div class="text-center">
                        <p id="popup-total-protein" class="font-black text-3xl text-emerald-400 mb-1">0g</p>
                        <p class="text-xs text-slate-400 uppercase">Protein</p>
                    </div>
                </div>
            </div>
            <button onclick="addFoodItem()" class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:shadow-xl transition-all active:scale-95 mb-3">
                Add to Diary
            </button>
            <button onclick="closeFoodPopup()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600 transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- BARCODE SCANNER MODAL -->
    <div id="barcode-scanner-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black">Scan Barcode</h3>
                <button onclick="closeBarcodeScanner()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div id="barcode-reader" class="w-full h-64 bg-black rounded-2xl mb-4"></div>
            <div class="flex gap-2">
                <input id="manual-barcode" type="text" placeholder="Or enter barcode manually..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="lookupBarcode()" class="bg-slate-900 text-white px-6 rounded-xl font-bold hover:bg-slate-800">Search</button>
            </div>
        </div>
    </div>

    <!-- CREATE MEAL MODAL -->
    <div id="create-meal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Create Meal</h3>
                <button onclick="closeCreateMeal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Meal Name *</label>
                <input id="meal-name-input" type="text" placeholder="e.g. Chicken & Rice Bowl" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <div class="flex gap-2 mb-4">
                <input id="meal-ingredient-search" type="text" placeholder="Search ingredient..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="showToast('Barcode for meals coming soon!')" class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center hover:bg-indigo-700">
                    <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="meal-search-results" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
            <div class="mb-6">
                <h4 class="text-sm font-black text-slate-400 uppercase mb-2">Ingredients</h4>
                <div id="meal-ingredients-list" class="space-y-2"></div>
            </div>
            <button onclick="saveMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700">Save Meal</button>
        </div>
    </div>

    <!-- METRICS CHART MODAL -->
    <div id="metrics-chart-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Progress Charts</h3>
                <button onclick="closeMetricsChart()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="mb-6">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Metric</label>
                <select id="chart-metric-select" onchange="renderMetricChart()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-lg">
                    <option value="weight">Weight (kg)</option>
                    <option value="chest">Chest (cm)</option>
                    <option value="shoulders">Shoulders (cm)</option>
                    <option value="arms">Arms (cm)</option>
                    <option value="waist">Waist (cm)</option>
                    <option value="legs">Legs (cm)</option>
                    <option value="glutes">Glutes (cm)</option>
                </select>
            </div>
            <div class="h-80 relative bg-slate-50 rounded-3xl p-4">
                <canvas id="metrics-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- PHOTO COMPARISON MODAL -->
    <div id="photo-comparison-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Compare Photos</h3>
                <button onclick="closePhotoComparison()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">First Date</label>
                        <select id="compare-date-1" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Second Date</label>
                        <select id="compare-date-2" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Photo Angle</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setComparePhotoType('front')" id="compare-type-front" class="p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white">Front</button>
                        <button onclick="setComparePhotoType('side')" id="compare-type-side" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Side</button>
                        <button onclick="setComparePhotoType('back')" id="compare-type-back" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Back</button>
                    </div>
                </div>
            </div>
            <div id="comparison-view" class="grid grid-cols-2 gap-6 hidden">
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-1"></div>
                    <img id="compare-img-1" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="Before">
                </div>
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-2"></div>
                    <img id="compare-img-2" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="After">
                </div>
            </div>
            <div id="no-comparison-message" class="text-center py-12 text-slate-400">
                <i data-lucide="images" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                <p class="font-bold">Select two dates to compare</p>
            </div>
        </div>
    </div>

    <script>
    // ==========================================================================
    // FIREBASE CONFIGURATION
    // ==========================================================================
    // üî• REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
            apiKey: "AIzaSyA9H9hmvfrQmc2wIwnS2jCPLgdmXBquQXM",
            authDomain: "vfit-app-pro.firebaseapp.com",
            projectId: "vfit-app-pro",
            storageBucket: "vfit-app-pro.firebasestorage.app",
            messagingSenderId: "815730068689",
            appId: "1:815730068689:web:0c6587d7dbe62b0f3c09f0",
            measurementId: "G-74L12X0NE8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

    let currentUser = null;
    let firebaseUserData = {};

    // ==========================================================================
    // CLOUD SYNC ‚Äî DEBOUNCED AUTO-SAVE
    // ==========================================================================
    let syncTimeout = null;

    function showSyncIndicator() {
        const el = document.getElementById('sync-indicator');
        if (el) {
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }
    }

    /**
     * Schedule a debounced Firestore save (500ms after last change).
     * Saves the full app state to: users/{uid}/appData/state
     * A lightweight profile doc is kept at: users/{uid}
     */
    function scheduleSyncToFirestore() {
        if (!currentUser) return;
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(() => persistStateToFirestore(), 500);
    }

    async function persistStateToFirestore() {
        if (!currentUser) return;
        try {
            showSyncIndicator();
            // Split off photos (large base64 strings) into a separate sub-document
            // to stay within Firestore's 1MB doc limit.
            const photos = extractPhotosFromState();
            const stateWithoutPhotos = { ...state };
            stateWithoutPhotos.metricsHistory = (state.metricsHistory || []).map(m => {
                const copy = { ...m };
                delete copy.photos;
                return copy;
            });
            stateWithoutPhotos.currentPhotos = {};

            const batch = db.batch();

            // Main state document
            const stateRef = db.collection('users').doc(currentUser.uid)
                               .collection('appData').doc('state');
            batch.set(stateRef, {
                ...stateWithoutPhotos,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Photos document (separate to keep main doc small)
            const photosRef = db.collection('users').doc(currentUser.uid)
                                .collection('appData').doc('photos');
            batch.set(photosRef, { photos, lastSync: firebase.firestore.FieldValue.serverTimestamp() });

            // Update profile summary
            const profileRef = db.collection('users').doc(currentUser.uid);
            batch.update(profileRef, {
                calorieGoal: state.goals?.calories || 2500,
                totalWorkouts: state.workoutHistory?.length || 0,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            await batch.commit();

            // Update last-sync label in profile tab
            const syncLabel = document.getElementById('profile-last-sync');
            if (syncLabel) syncLabel.textContent = new Date().toLocaleTimeString();
        } catch (error) {
            console.error('Firestore sync error:', error);
        }
    }

    /** Pull all photo data out of metricsHistory + currentPhotos into one object */
    function extractPhotosFromState() {
        const photos = {};
        photos.currentPhotos = state.currentPhotos || {};
        (state.metricsHistory || []).forEach(m => {
            if (m.photos) photos[m.date] = m.photos;
        });
        return photos;
    }

    /** Load full state (+ photos) from Firestore */
    async function loadStateFromFirestore() {
        if (!currentUser) return false;
        try {
            const [stateSnap, photosSnap] = await Promise.all([
                db.collection('users').doc(currentUser.uid).collection('appData').doc('state').get(),
                db.collection('users').doc(currentUser.uid).collection('appData').doc('photos').get()
            ]);

            if (!stateSnap.exists) return false;

            const cloudState = stateSnap.data();
            const photosData = photosSnap.exists ? photosSnap.data().photos || {} : {};

            // Re-attach photos to metricsHistory entries
            if (cloudState.metricsHistory) {
                cloudState.metricsHistory = cloudState.metricsHistory.map(m => ({
                    ...m,
                    photos: photosData[m.date] || {}
                }));
            }
            cloudState.currentPhotos = photosData.currentPhotos || {};

            // Remove server timestamp field before merging
            delete cloudState.lastSync;

            state = { ...DEFAULT_STATE, ...cloudState };
            state.goals = { ...DEFAULT_STATE.goals, ...(cloudState.goals || {}) };
            state.equipment = {
                gym:  { ...DEFAULT_STATE.equipment.gym,  ...(cloudState.equipment?.gym  || {}) },
                home: { ...DEFAULT_STATE.equipment.home, ...(cloudState.equipment?.home || {}) }
            };
            saveState(); // Mirror to localStorage as cache
            return true;
        } catch (error) {
            console.error('Error loading from Firestore:', error);
            return false;
        }
    }

    // ==========================================================================
    // PATCHED saveState ‚Äî also syncs to Firestore
    // ==========================================================================
    function saveState() {
        try {
            localStorage.setItem('fittrack_state', JSON.stringify(state));
        } catch (e) {
            console.error('LocalStorage save error:', e);
        }
        scheduleSyncToFirestore();
    }

    // ==========================================================================
    // AUTH FORM HELPERS
    // ==========================================================================
    function showLogin() {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
    }
    function showRegister() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
    }
    function showForgotPassword() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.remove('hidden');
    }

    // ==========================================================================
    // AUTH FUNCTIONS
    // ==========================================================================
    async function registerUser() {
        const name     = document.getElementById('register-name').value.trim();
        const email    = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirm  = document.getElementById('register-confirm').value;

        if (!name)                         { showToast('Please enter your name'); return; }
        if (!email || !password)           { showToast('Please fill all fields'); return; }
        if (password.length < 6)           { showToast('Password must be at least 6 characters'); return; }
        if (password !== confirm)          { showToast('Passwords do not match'); return; }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            await user.updateProfile({ displayName: name });

            // Create profile document
            await db.collection('users').doc(user.uid).set({
                name,
                email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                calorieGoal: 2500,
                totalWorkouts: 0
            });

            // Initialise empty state documents
            const defaultStateForCloud = { ...DEFAULT_STATE, goals: { ...DEFAULT_STATE.goals } };
            delete defaultStateForCloud.currentPhotos;
            await db.collection('users').doc(user.uid).collection('appData').doc('state').set({
                ...defaultStateForCloud,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('users').doc(user.uid).collection('appData').doc('photos').set({
                photos: {},
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('Account created successfully! üéâ');
        } catch (error) {
            console.error('Registration error:', error);
            if (error.code === 'auth/email-already-in-use') showToast('Email already in use');
            else if (error.code === 'auth/invalid-email')   showToast('Invalid email address');
            else showToast('Registration failed: ' + error.message);
        }
    }

    async function loginUser() {
        const email    = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        if (!email || !password) { showToast('Please enter email and password'); return; }
        try {
            await auth.signInWithEmailAndPassword(email, password);
            showToast('Welcome back! üí™');
        } catch (error) {
            console.error('Login error:', error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found')
                showToast('Invalid email or password');
            else
                showToast('Login failed: ' + error.message);
        }
    }

    async function resetPassword() {
        const email = document.getElementById('forgot-email').value.trim();
        if (!email) { showToast('Please enter your email'); return; }
        try {
            await auth.sendPasswordResetEmail(email);
            showToast('Password reset email sent! Check your inbox.');
            showLogin();
        } catch (error) {
            showToast('Failed to send reset email');
        }
    }

    async function logoutUser() {
        if (confirm('Are you sure you want to sign out?')) {
            try {
                // Final sync before logout
                await persistStateToFirestore();
                await auth.signOut();
                state = { ...DEFAULT_STATE };
                saveState();
                showToast('Signed out successfully');
            } catch (error) {
                showToast('Logout failed');
            }
        }
    }

    // ==========================================================================
    // DELETE ACCOUNT
    // ==========================================================================
    function openDeleteAccountModal() {
        document.getElementById('delete-account-password').value = '';
        document.getElementById('delete-account-modal').style.display = 'flex';
        lucide.createIcons();
    }

    function closeDeleteAccountModal() {
        document.getElementById('delete-account-modal').style.display = 'none';
        document.getElementById('delete-account-password').value = '';
    }

    async function confirmDeleteAccount() {
        const password = document.getElementById('delete-account-password').value;
        if (!password) {
            showToast('Please enter your password to confirm');
            return;
        }

        if (!currentUser) {
            showToast('No user signed in');
            return;
        }

        try {
            // Re-authenticate to confirm identity before deletion
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email,
                password
            );
            await currentUser.reauthenticateWithCredential(credential);

            // Delete all Firestore data
            showToast('Deleting your data...');
            const appDataColl = db.collection('users').doc(currentUser.uid).collection('appData');
            const appDataDocs = await appDataColl.get();
            const deletePromises = appDataDocs.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);

            // Delete profile document
            await db.collection('users').doc(currentUser.uid).delete();

            // Delete Firebase Auth account
            await currentUser.delete();

            // Clear local state
            state = { ...DEFAULT_STATE };
            localStorage.removeItem('fittrack_state');

            closeDeleteAccountModal();
            showToast('Your account has been permanently deleted.');
        } catch (error) {
            console.error('Delete account error:', error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                showToast('Incorrect password. Please try again.');
            } else if (error.code === 'auth/requires-recent-login') {
                showToast('Please sign out and sign back in, then try again.');
            } else {
                showToast('Failed to delete account: ' + error.message);
            }
        }
    }

    // ==========================================================================
    // CLOUD SYNC (manual button)
    // ==========================================================================
    async function syncToCloud() {
        if (!currentUser) { showToast('Not signed in'); return; }
        try {
            await persistStateToFirestore();
            showToast('Synced to cloud ‚òÅÔ∏è');
        } catch (error) {
            showToast('Sync failed ‚Äî check connection');
        }
    }

    // ==========================================================================
    // AUTH STATE OBSERVER
    // ==========================================================================
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            // Try loading from Firestore first, fall back to localStorage
            const loaded = await loadStateFromFirestore();
            if (!loaded) loadState();

            // Load profile metadata
            try {
                const profileDoc = await db.collection('users').doc(user.uid).get();
                if (profileDoc.exists) firebaseUserData = profileDoc.data();
            } catch(e) { console.error('Profile load error:', e); }

            // Update UI
            const emailEl = document.getElementById('status-date');
            if (emailEl) emailEl.innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });

            const sidebarEmail = document.getElementById('sidebar-user-email');
            if (sidebarEmail) sidebarEmail.textContent = user.email;

            renderProfile();
            renderDashboard();
            renderDiary();
            renderSettings();
            setupMidnightSave();
            lucide.createIcons();
        } else {
            currentUser = null;
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
            lucide.createIcons();
        }
    });

    function renderProfile() {
        if (!currentUser) return;
        const name = currentUser.displayName || firebaseUserData?.name || 'User';
        document.getElementById('profile-name').textContent = name;
        document.getElementById('profile-email').textContent = currentUser.email;

        if (firebaseUserData?.createdAt) {
            try {
                const date = firebaseUserData.createdAt.toDate
                    ? firebaseUserData.createdAt.toDate()
                    : new Date(firebaseUserData.createdAt);
                document.getElementById('profile-created').textContent = date.toLocaleDateString();
            } catch { document.getElementById('profile-created').textContent = 'Recently'; }
        } else {
            document.getElementById('profile-created').textContent = 'Recently';
        }
        document.getElementById('profile-workouts').textContent = state.workoutHistory?.length || 0;
    }

    // ==========================================================================
    // STATE MANAGEMENT
    // ==========================================================================
    const DEFAULT_STATE = {
        viewDate: new Date().toISOString().split('T')[0],
        metricsDate: new Date().toISOString().split('T')[0],
        goals: { calories: 2500, water: 2500, steps: 10000 },
        waterLogs: {},
        stepsLogs: {},
        dailyMeals: [],
        workoutHistory: [],
        nutritionHistory: [],
        metricsHistory: [],
        createdMeals: [],
        customFoods: [],
        workoutEnv: 'gym',
        currentPhotos: { front: null, side: null, back: null },
        habits: [],
        habitsEnabled: false,
        habitCompletions: {},
        hydrationGoalCompletions: {},
        stepsGoalCompletions: {},
        trackHydration: true,
        trackSteps: true,
        userGoals: [],
        cardioLogs: [],
        hydrationLogs: {},
        equipment: {
            gym:  { 'Barbell': true, 'Dumbbells': true, 'Cable Machine': true, 'Leg Press': true, 'Pull Up Bar': true, 'Bench': true },
            home: { 'Dumbbells': false, 'Resistance Bands': false, 'Pull Up Bar': false, 'Yoga Mat': true }
        }
    };

    let state = { ...DEFAULT_STATE };
    let workoutTimer = null;
    let workoutStartTime = null;
    let currentFoodItem = null;
    let currentAmountType = 'portion';
    let searchResults = [];
    let mealIngredients = [];
    let html5QrCode = null;
    let metricsChart = null;
    let currentPhotoType = null;
    let manualFoodImageData = null;

    // ==========================================================================
    // LOCAL CACHE
    // ==========================================================================
    function loadState() {
        try {
            const saved = localStorage.getItem('fittrack_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...DEFAULT_STATE, ...parsed };
                state.goals = { ...DEFAULT_STATE.goals, ...(parsed.goals || {}) };
                state.equipment = {
                    gym:  { ...DEFAULT_STATE.equipment.gym,  ...(parsed.equipment?.gym  || {}) },
                    home: { ...DEFAULT_STATE.equipment.home, ...(parsed.equipment?.home || {}) }
                };
            }
        } catch (e) { console.error('Load error:', e); }
    }

    function setupMidnightSave() {
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        setTimeout(() => { saveDailyNutrition(); setupMidnightSave(); }, tomorrow - now);
    }

    function saveDailyNutrition() {
        const today = state.viewDate;
        const todayMeals = state.dailyMeals.filter(m => m.date === today);
        if (todayMeals.length > 0) {
            const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);
            const existing = state.nutritionHistory.findIndex(h => h.date === today);
            const entry = { date: today, calories: totalCals, protein: totalProtein, meals: todayMeals };
            if (existing >= 0) state.nutritionHistory[existing] = entry;
            else state.nutritionHistory.unshift(entry);
            saveState();
            showToast('Daily nutrition auto-saved');
        }
    }

    // ==========================================================================
    // TAB MANAGEMENT
    // ==========================================================================
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        const tab = document.getElementById(tabId);
        if (tab) tab.classList.add('active');
        if (tabId === 'logs')     { renderLogs(); filterWorkouts(); }
        if (tabId === 'profile')  renderProfile();
        if (tabId === 'settings') renderSettings();
        if (tabId === 'dashboard') renderDashboard();
        lucide.createIcons();
    }

    // ==========================================================================
    // SIDEBAR
    // ==========================================================================
    function toggleSidebar() {
        const sidebar  = document.getElementById('sidebar');
        const overlay  = document.getElementById('sidebar-overlay');
        const isOpen   = sidebar.classList.contains('translate-x-0');
        if (isOpen) {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.add('translate-x-0');
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }
        lucide.createIcons();
    }

    // ==========================================================================
    // TOAST
    // ==========================================================================
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ==========================================================================
    // EXERCISE DATABASE (unchanged from original)
    // ==========================================================================
    const EXERCISE_DB = {
        gym: {
            'Full Body': { compound: ['Barbell Squat','Deadlift','Bench Press','Pull Ups','Overhead Press'], isolation: ['Bicep Curl','Tricep Pushdown','Lateral Raise','Leg Curl','Calf Raise'] },
            'Upper':     { compound: ['Bench Press','Pull Ups','Dumbbell Row','Overhead Press','Dips'], isolation: ['Bicep Curl','Tricep Pushdown','Lateral Raise','Face Pulls','Cable Flyes'] },
            'Lower':     { compound: ['Barbell Squat','Romanian Deadlift','Leg Press','Lunges'], isolation: ['Leg Extension','Leg Curl','Calf Raise','Hip Abduction','Glute Kickback'] },
            'Push':      { compound: ['Bench Press','Overhead Press','Incline Press','Dips'], isolation: ['Tricep Pushdown','Lateral Raise','Cable Flyes','Skull Crushers'] },
            'Pull':      { compound: ['Pull Ups','Barbell Row','Lat Pulldown','T-Bar Row'], isolation: ['Bicep Curl','Face Pulls','Hammer Curl','Cable Row'] },
            'Legs':      { compound: ['Squat','Deadlift','Leg Press','Lunges'], isolation: ['Leg Extension','Leg Curl','Calf Raise','Hip Thrust'] },
            'Chest':     { compound: ['Bench Press','Incline Press','Dumbbell Press'], isolation: ['Cable Flyes','Pec Deck','Dumbbell Flyes'] },
            'Back':      { compound: ['Pull Ups','Barbell Row','Lat Pulldown','T-Bar Row'], isolation: ['Cable Row','Face Pulls','Straight Arm Pulldown'] },
            'Shoulders': { compound: ['Overhead Press','Arnold Press'], isolation: ['Lateral Raise','Front Raise','Face Pulls','Reverse Flyes'] },
            'Biceps':    { compound: ['Chin Ups'], isolation: ['Barbell Curl','Hammer Curl','Preacher Curl','Cable Curl'] },
            'Triceps':   { compound: ['Close Grip Bench Press','Dips'], isolation: ['Tricep Pushdown','Skull Crushers','Overhead Extension'] },
            'Quads':     { compound: ['Squat','Leg Press','Lunges'], isolation: ['Leg Extension','Sissy Squat'] },
            'Hamstrings':{ compound: ['Romanian Deadlift','Good Morning'], isolation: ['Leg Curl','Nordic Curl'] },
            'Glutes':    { compound: ['Hip Thrust','Bulgarian Split Squat'], isolation: ['Cable Kickback','Hip Abduction','Glute Bridge'] },
            'Calves':    { compound: [], isolation: ['Standing Calf Raise','Seated Calf Raise','Donkey Calf Raise'] }
        },
        home: {
            'Full Body': { compound: ['Push Ups','Bodyweight Squat','Burpees'], isolation: ['Plank','Crunches','Leg Raises'] },
            'Upper':     { compound: ['Push Ups','Pike Push Ups','Inverted Row'], isolation: ['Tricep Dips','Plank to Push Up','Superman'] },
            'Lower':     { compound: ['Bodyweight Squat','Lunges','Step Ups'], isolation: ['Glute Bridge','Calf Raise','Donkey Kicks'] },
            'Push':      { compound: ['Push Ups','Pike Push Ups'], isolation: ['Diamond Push Ups','Tricep Dips','Shoulder Taps'] },
            'Pull':      { compound: ['Inverted Row','Chin Ups'], isolation: ['Superman','Reverse Snow Angels','Bicep Holds'] },
            'Legs':      { compound: ['Squat','Lunges','Jump Squat'], isolation: ['Glute Bridge','Calf Raise','Leg Raises'] }
        }
    };

    const ALL_EXERCISES = [
        'Barbell Squat','Deadlift','Bench Press','Pull Ups','Overhead Press','Dumbbell Press',
        'Incline Press','Dips','Barbell Row','Lat Pulldown','T-Bar Row','Romanian Deadlift',
        'Leg Press','Lunges','Good Morning','Hip Thrust','Bulgarian Split Squat','Arnold Press',
        'Close Grip Bench Press','Chin Ups','Bicep Curl','Tricep Pushdown','Lateral Raise',
        'Leg Curl','Calf Raise','Face Pulls','Cable Flyes','Leg Extension','Hip Abduction',
        'Glute Kickback','Cable Row','Hammer Curl','Skull Crushers','Pec Deck','Dumbbell Flyes',
        'Front Raise','Reverse Flyes','Preacher Curl','Cable Curl','Overhead Extension',
        'Sissy Squat','Nordic Curl','Cable Kickback','Glute Bridge','Standing Calf Raise',
        'Seated Calf Raise','Donkey Calf Raise','Straight Arm Pulldown','Push Ups',
        'Bodyweight Squat','Burpees','Pike Push Ups','Inverted Row','Step Ups','Donkey Kicks',
        'Diamond Push Ups','Shoulder Taps','Superman','Reverse Snow Angels','Bicep Holds',
        'Jump Squat','Plank','Crunches','Leg Raises','Tricep Dips','Plank to Push Up',
        'Barbell Curl','Dumbbell Row','T-Bar Row'
    ].filter((v,i,a) => a.indexOf(v) === i).sort();

    const CARDIO_EXERCISES = ['Treadmill','Rowing Machine','Stationary Bike','Elliptical','Stair Climber'];
    const CORE_EXERCISES   = ['Plank','Crunches','Russian Twists','Leg Raises','Mountain Climbers','Dead Bug'];

    // ==========================================================================
    // UK STORES & RESTAURANTS (unchanged)
    // ==========================================================================
    const UK_STORES_RESTAURANTS = [
        { name: 'All Stores & Restaurants', value: 'all', type: 'all' },
        { name: 'Tesco', value: 'tesco', type: 'supermarket' },
        { name: "Sainsbury's", value: 'sainsburys', type: 'supermarket' },
        { name: 'ASDA', value: 'asda', type: 'supermarket' },
        { name: 'Morrisons', value: 'morrisons', type: 'supermarket' },
        { name: 'Aldi', value: 'aldi', type: 'supermarket' },
        { name: 'Lidl', value: 'lidl', type: 'supermarket' },
        { name: 'Waitrose', value: 'waitrose', type: 'supermarket' },
        { name: 'Co-op', value: 'coop', type: 'supermarket' },
        { name: 'Iceland', value: 'iceland', type: 'supermarket' },
        { name: 'Costco', value: 'costco', type: 'supermarket' },
        { name: 'M&S Food', value: 'marks', type: 'supermarket' },
        { name: 'Ocado', value: 'ocado', type: 'supermarket' },
        { name: 'Farmfoods', value: 'farmfoods', type: 'supermarket' },
        { name: 'Booths', value: 'booths', type: 'supermarket' },
        { name: 'Budgens', value: 'budgens', type: 'supermarket' },
        { name: "McDonald's", value: 'mcdonalds', type: 'fastfood' },
        { name: 'KFC', value: 'kfc', type: 'fastfood' },
        { name: 'Burger King', value: 'burgerking', type: 'fastfood' },
        { name: 'Subway', value: 'subway', type: 'fastfood' },
        { name: 'Greggs', value: 'greggs', type: 'fastfood' },
        { name: "Nando's", value: 'nandos', type: 'fastfood' },
        { name: 'Pizza Hut', value: 'pizzahut', type: 'fastfood' },
        { name: "Domino's", value: 'dominos', type: 'fastfood' },
        { name: "Papa John's", value: 'papajohns', type: 'fastfood' },
        { name: 'Five Guys', value: 'fiveguys', type: 'fastfood' },
        { name: 'Wagamama', value: 'wagamama', type: 'fastfood' },
        { name: 'Pret A Manger', value: 'pret', type: 'fastfood' },
        { name: 'Leon', value: 'leon', type: 'fastfood' },
        { name: 'Yo! Sushi', value: 'yosushi', type: 'fastfood' },
        { name: 'Gourmet Burger Kitchen', value: 'gbk', type: 'fastfood' },
        { name: 'Costa Coffee', value: 'costa', type: 'fastfood' },
        { name: 'Starbucks', value: 'starbucks', type: 'fastfood' },
        { name: 'Caff√® Nero', value: 'nero', type: 'fastfood' }
    ].sort((a,b) => { if(a.value==='all') return -1; if(b.value==='all') return 1; return a.name.localeCompare(b.name); });

    // ==========================================================================
    // DASHBOARD
    // ==========================================================================
    function renderDashboard() {
        const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
        const totalCals    = todayMeals.reduce((sum,m) => sum + (m.calories||0), 0);
        const totalProtein = todayMeals.reduce((sum,m) => sum + (m.protein||0), 0);

        const dashCals = document.getElementById('dash-calories');
        if (dashCals) dashCals.innerText = Math.round(totalCals);
        const dashProtein = document.getElementById('dash-protein');
        if (dashProtein) dashProtein.innerText = Math.round(totalProtein) + 'g';
        const dashCarbs = document.getElementById('dash-carbs');
        if (dashCarbs) dashCarbs.innerText = Math.round(totalCals*0.4/4) + 'g';
        const dashFat = document.getElementById('dash-fat');
        if (dashFat) dashFat.innerText = Math.round(totalCals*0.3/9) + 'g';

        const calorieGoal = state.goals?.calories || 2500;
        const progress = Math.min((totalCals/calorieGoal)*534, 534);
        const progressEl = document.getElementById('calorie-progress');
        if (progressEl) progressEl.style.strokeDashoffset = 534 - progress;

        const water = state.waterLogs?.[state.viewDate] || 0;
        const waterGoal = state.goals?.water || 2500;
        const waterCountEl = document.getElementById('water-count');
        if (waterCountEl) waterCountEl.innerText = `${(water/1000).toFixed(1)} / ${(waterGoal/1000).toFixed(1)}L`;

        const steps = state.stepsLogs?.[state.viewDate] || 0;
        const stepsGoal = state.goals?.steps || 10000;
        const stepsCountEl = document.getElementById('steps-count');
        if (stepsCountEl) stepsCountEl.innerText = `${steps.toLocaleString()} / ${stepsGoal.toLocaleString()}`;

        const hydrationComplete = state.hydrationGoalCompletions?.[state.viewDate] || false;
        const hydrationCheckBtn = document.getElementById('hydration-check');
        if (hydrationCheckBtn) {
            const icon = hydrationCheckBtn.querySelector('i');
            if (hydrationComplete) {
                hydrationCheckBtn.classList.add('bg-cyan-500','border-cyan-500');
                hydrationCheckBtn.classList.remove('border-slate-200');
                if (icon) { icon.classList.remove('text-transparent'); icon.classList.add('text-white'); }
            } else {
                hydrationCheckBtn.classList.remove('bg-cyan-500','border-cyan-500');
                hydrationCheckBtn.classList.add('border-slate-200');
                if (icon) { icon.classList.add('text-transparent'); icon.classList.remove('text-white'); }
            }
        }

        const stepsComplete = state.stepsGoalCompletions?.[state.viewDate] || false;
        const stepsCheckBtn = document.getElementById('steps-check');
        if (stepsCheckBtn) {
            const icon = stepsCheckBtn.querySelector('i');
            if (stepsComplete) {
                stepsCheckBtn.classList.add('bg-amber-500','border-amber-500');
                stepsCheckBtn.classList.remove('border-slate-200');
                if (icon) { icon.classList.remove('text-transparent'); icon.classList.add('text-white'); }
            } else {
                stepsCheckBtn.classList.remove('bg-amber-500','border-amber-500');
                stepsCheckBtn.classList.add('border-slate-200');
                if (icon) { icon.classList.add('text-transparent'); icon.classList.remove('text-white'); }
            }
        }

        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
        const weekWorkouts = (state.workoutHistory||[]).filter(w => new Date(w.date) > weekAgo).length;
        const lastWeight = state.metricsHistory?.[0]?.weight || '--';
        const statsEl = document.getElementById('muscle-volume-stats');
        if (statsEl) statsEl.innerHTML = `
            <div class="bg-white/10 p-3 rounded-xl"><div class="text-[10px] opacity-70 uppercase">This Week</div><div class="font-bold text-xl">${weekWorkouts} workouts</div></div>
            <div class="bg-white/10 p-3 rounded-xl"><div class="text-[10px] opacity-70 uppercase">Last Weight</div><div class="font-bold text-xl">${lastWeight} kg</div></div>`;

        if (state.habitsEnabled) {
            document.getElementById('habits-tracker')?.classList.remove('hidden');
            renderDashboardHabits();
        }
        lucide.createIcons();
    }

    function toggleHydrationGoal() {
        if (!state.hydrationGoalCompletions) state.hydrationGoalCompletions = {};
        state.hydrationGoalCompletions[state.viewDate] = !state.hydrationGoalCompletions[state.viewDate];
        saveState(); renderDashboard();
        showToast(state.hydrationGoalCompletions[state.viewDate] ? 'Hydration goal reached! üíß' : 'Hydration goal unmarked');
        lucide.createIcons();
    }

    function toggleStepsGoal() {
        if (!state.stepsGoalCompletions) state.stepsGoalCompletions = {};
        state.stepsGoalCompletions[state.viewDate] = !state.stepsGoalCompletions[state.viewDate];
        saveState(); renderDashboard();
        showToast(state.stepsGoalCompletions[state.viewDate] ? 'Steps goal reached! üëü' : 'Steps goal unmarked');
        lucide.createIcons();
    }

    // ==========================================================================
    // TRAINING
    // ==========================================================================
    function setWorkoutEnv(env) {
        state.workoutEnv = env;
        const gymTab  = document.getElementById('env-tab-gym');
        const homeTab = document.getElementById('env-tab-home');
        if (gymTab)  gymTab.className  = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env==='gym'  ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (homeTab) homeTab.className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env==='home' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
    }

    function toggleSpecificMuscle() {
        const focus = document.getElementById('workout-focus').value;
        document.getElementById('specific-muscle-container')?.classList.toggle('hidden', focus !== 'Specific Muscle');
    }

    function startWorkout(mode) {
        const focus  = document.getElementById('workout-focus').value;
        const muscle = focus === 'Specific Muscle' ? document.getElementById('specific-muscle').value : focus;
        document.getElementById('workout-setup').classList.add('hidden');
        document.getElementById('workout-active').classList.remove('hidden');
        document.getElementById('active-workout-title').innerText = muscle;
        document.getElementById('exercise-list').innerHTML = '';

        if (mode === 'ai') {
            const env = state.workoutEnv || 'gym';
            const exercises = EXERCISE_DB[env]?.[muscle];
            const addCardio = document.getElementById('add-cardio-check').checked;
            const addCore   = document.getElementById('add-core-check').checked;
            if (exercises) {
                const compounds  = (exercises.compound||[]).sort(()=>0.5-Math.random()).slice(0,2);
                const isolations = (exercises.isolation||[]).sort(()=>0.5-Math.random()).slice(0,3);
                let delay = 0;
                [...compounds,...isolations].forEach(ex => { setTimeout(()=>addExercise(ex), delay); delay+=20; });
                if (addCardio) { const c = CARDIO_EXERCISES[Math.floor(Math.random()*CARDIO_EXERCISES.length)]; setTimeout(()=>addExercise(c), delay); delay+=20; }
                if (addCore)   { const c1 = CORE_EXERCISES[Math.floor(Math.random()*CORE_EXERCISES.length)]; setTimeout(()=>addExercise(c1), delay); delay+=20; }
                showToast('AI workout generated! üí™');
            } else showToast('No exercises found for this selection');
        }

        workoutStartTime = Date.now();
        workoutTimer = setInterval(updateWorkoutTimer, 1000);
    }

    function updateWorkoutTimer() {
        const elapsed = Math.floor((Date.now()-workoutStartTime)/1000);
        const h = Math.floor(elapsed/3600).toString().padStart(2,'0');
        const m = Math.floor((elapsed%3600)/60).toString().padStart(2,'0');
        const s = (elapsed%60).toString().padStart(2,'0');
        const el = document.getElementById('workout-timer');
        if (el) el.innerText = `${h}:${m}:${s}`;
    }

    function addExercise(name='') {
        const id = 'ex-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
        const pr = name ? getPersonalRecord(name) : null;
        const card = document.createElement('div');
        card.id = `card-${id}`;
        card.className = "bg-white p-4 sm:p-5 rounded-2xl shadow-md border-2 border-indigo-100 mb-3 sm:mb-4 w-full";

        const nameContainer = document.createElement('div');
        nameContainer.className = "relative mb-3 sm:mb-4";
        const inputWrapper = document.createElement('div');
        inputWrapper.className = "flex gap-2 items-center";
        const nameInput = document.createElement('input');
        nameInput.type = "text"; nameInput.value = name;
        nameInput.placeholder = "Search or type exercise name...";
        nameInput.className = "flex-1 p-3 sm:p-3.5 border-2 border-slate-200 rounded-xl font-bold text-base sm:text-lg";
        nameInput.id = `ex-name-${id}`; nameInput.autocomplete = "off";

        const infoBtn = document.createElement('button');
        infoBtn.type = "button";
        infoBtn.className = "w-10 h-10 sm:w-11 sm:h-11 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center hover:bg-indigo-200 flex-shrink-0";
        infoBtn.innerHTML = '<i data-lucide="info" class="w-5 h-5"></i>';
        infoBtn.addEventListener('click', () => { const n=nameInput.value.trim(); if(n) showExerciseDemo(n); else showToast('Enter exercise name first'); });

        const dropdown = document.createElement('div');
        dropdown.id = `dropdown-${id}`;
        dropdown.className = "hidden absolute z-50 mt-1 w-full bg-white rounded-xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto";
        nameInput.addEventListener('focus', ()=>showExerciseDropdown(id));
        nameInput.addEventListener('input', (e)=>filterExerciseDropdown(id, e.target.value));

        inputWrapper.appendChild(nameInput); inputWrapper.appendChild(infoBtn);
        nameContainer.appendChild(inputWrapper); nameContainer.appendChild(dropdown);

        const setsContainer = document.createElement('div');
        setsContainer.id = `sets-${id}`;
        setsContainer.className = "bg-slate-50 p-3 sm:p-4 rounded-xl mb-3 sm:mb-4 min-h-[100px] w-full";
        const header = document.createElement('div');
        header.className = "flex gap-2 sm:gap-3 mb-2 sm:mb-3";
        header.innerHTML = `<div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Reps</span></div><div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Weight (kg)</span></div><div class="w-9 sm:w-10"></div>`;
        setsContainer.appendChild(header);

        const addSetBtn = document.createElement('button');
        addSetBtn.type = "button";
        addSetBtn.className = "w-full py-3 sm:py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-sm sm:text-base hover:bg-indigo-700";
        addSetBtn.textContent = "+ Add Set";
        addSetBtn.addEventListener('click', ()=>addSetToExercise(id, pr));

        const deleteExBtn = document.createElement('button');
        deleteExBtn.type = "button";
        deleteExBtn.className = "w-full py-2 sm:py-2.5 mt-2 bg-red-50 text-red-600 rounded-xl font-bold text-xs sm:text-sm hover:bg-red-100";
        deleteExBtn.textContent = "Delete Exercise";
        deleteExBtn.addEventListener('click', ()=>card.remove());

        card.appendChild(nameContainer); card.appendChild(setsContainer);
        card.appendChild(addSetBtn); card.appendChild(deleteExBtn);
        document.getElementById('exercise-list')?.appendChild(card);
        setTimeout(()=>addSetToExercise(id, pr), 60);
        lucide.createIcons();
    }

    function showExerciseDropdown(id) {
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (!dropdown) return;
        dropdown.innerHTML = ALL_EXERCISES.map(ex => {
            const pr = getPersonalRecord(ex);
            return `<div onclick="selectExerciseFromDropdown('${id}','${ex.replace(/'/g,"\\'")}')\" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center"><span class="font-medium text-sm">${ex}</span>${pr?`<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>`:''}</div>`;
        }).join('');
        dropdown.classList.remove('hidden');
    }

    function filterExerciseDropdown(id, query) {
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (!dropdown) return;
        const filtered = ALL_EXERCISES.filter(ex => ex.toLowerCase().includes(query.toLowerCase()));
        if (filtered.length === 0 && query.length > 0) {
            dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No matches ‚Äî keep typing for custom name</div>';
            dropdown.classList.remove('hidden');
        } else if (filtered.length > 0) {
            dropdown.innerHTML = filtered.map(ex => {
                const pr = getPersonalRecord(ex);
                return `<div onclick="selectExerciseFromDropdown('${id}','${ex.replace(/'/g,"\\'")}')\" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center"><span class="font-medium text-sm">${ex}</span>${pr?`<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>`:''}</div>`;
            }).join('');
            dropdown.classList.remove('hidden');
        } else if (query.length === 0) showExerciseDropdown(id);
        else dropdown.classList.add('hidden');
    }

    function selectExerciseFromDropdown(id, exerciseName) {
        const input    = document.getElementById(`ex-name-${id}`);
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (input)    input.value = exerciseName;
        if (dropdown) dropdown.classList.add('hidden');
        const pr = getPersonalRecord(exerciseName);
        if (pr) showToast(`PR for ${exerciseName}: ${pr}kg`);
    }

    function addSetToExercise(exerciseId, pr) {
        const container = document.getElementById(`sets-${exerciseId}`);
        if (!container) return;
        const setRow = document.createElement('div');
        setRow.className = "flex gap-2 sm:gap-3 items-center mb-2 bg-white p-2 sm:p-3 rounded-lg border border-slate-200";
        const repsInput   = document.createElement('input');
        repsInput.type = "number"; repsInput.placeholder = "Reps"; repsInput.min = "0";
        repsInput.className = "flex-1 p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
        const weightDiv   = document.createElement('div'); weightDiv.className = "flex-1 relative";
        const weightInput = document.createElement('input');
        weightInput.type = "number"; weightInput.placeholder = "Weight"; weightInput.min = "0"; weightInput.step = "0.5";
        weightInput.className = "w-full p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
        weightDiv.appendChild(weightInput);
        if (pr) {
            const pbBadge = document.createElement('span');
            pbBadge.className = "absolute -top-2 -right-2 text-[9px] sm:text-[10px] font-black text-white bg-emerald-500 px-2 py-1 rounded-full shadow-md whitespace-nowrap z-10";
            pbBadge.textContent = `PB ${pr}kg`;
            weightDiv.appendChild(pbBadge);
        }
        const deleteBtn = document.createElement('button');
        deleteBtn.type = "button";
        deleteBtn.className = "w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold text-lg flex-shrink-0";
        deleteBtn.textContent = "√ó";
        deleteBtn.addEventListener('click', ()=>setRow.remove());
        setRow.appendChild(repsInput); setRow.appendChild(weightDiv); setRow.appendChild(deleteBtn);
        container.appendChild(setRow);
    }

    function getPersonalRecord(exerciseName) {
        let maxWeight = 0;
        (state.workoutHistory||[]).forEach(workout => {
            (workout.exercises||[]).forEach(ex => {
                if (ex.name === exerciseName) {
                    (ex.sets||[]).forEach(set => {
                        const w = parseFloat(set.weight)||parseFloat(set.kg)||0;
                        if (w > maxWeight) maxWeight = w;
                    });
                }
            });
        });
        return maxWeight > 0 ? maxWeight : null;
    }

    function saveWorkout() {
        clearInterval(workoutTimer);
        const exercises = [];
        document.querySelectorAll('#exercise-list > div').forEach(card => {
            const nameInput = card.querySelector('input[type="text"]');
            const name = nameInput ? nameInput.value.trim() : '';
            if (!name) return;
            const sets = [];
            card.querySelectorAll('.flex.gap-2.items-center.mb-2').forEach(row => {
                const inputs = row.querySelectorAll('input[type="number"]');
                if (inputs.length >= 2 && inputs[0].value && inputs[1].value)
                    sets.push({ reps: inputs[0].value, weight: inputs[1].value });
            });
            if (sets.length > 0) exercises.push({ name, sets });
        });
        if (exercises.length === 0) { showToast('Add at least one exercise with sets'); return; }
        const workoutDate = window.selectedWorkoutDate || document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
        state.workoutHistory.unshift({ id: Date.now(), date: workoutDate, focus: document.getElementById('active-workout-title').innerText, duration: document.getElementById('workout-timer').innerText, exercises });
        saveState();
        document.getElementById('workout-setup').classList.remove('hidden');
        document.getElementById('workout-active').classList.add('hidden');
        renderDashboard();
        renderProfile();
        showToast('Workout saved! üèãÔ∏è');
    }

    function cancelWorkout() {
        if (confirm('Discard workout?')) {
            clearInterval(workoutTimer);
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
        }
    }

    document.addEventListener('click', function(e) {
        if (!e.target.matches('[id^="ex-name-"]') && !e.target.closest('[id^="dropdown-"]'))
            document.querySelectorAll('[id^="dropdown-"]').forEach(d=>d.classList.add('hidden'));
        if (!e.target.matches('#store-search-input') && !e.target.closest('#store-dropdown'))
            document.getElementById('store-dropdown')?.classList.add('hidden');
        if (!e.target.matches('#manual-food-store-input') && !e.target.closest('#manual-store-dropdown'))
            document.getElementById('manual-store-dropdown')?.classList.add('hidden');
    });

    // ==========================================================================
    // DATE MANAGEMENT ‚Äî TRAINING
    // ==========================================================================
    function changeWorkoutDate(days) {
        const current = document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current); date.setDate(date.getDate()+days);
        selectWorkoutDate(date.toISOString().split('T')[0]);
    }
    function selectWorkoutDate(dateStr) {
        document.getElementById('workout-date-picker').value = dateStr;
        window.selectedWorkoutDate = dateStr;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('workout-date-warning')?.classList.toggle('hidden', dateStr===today);
        lucide.createIcons();
    }

    // ==========================================================================
    // NUTRITION ‚Äî TAB & DIARY
    // ==========================================================================
    function setNutritionTab(tab) {
        const diaryBtn  = document.getElementById('nut-tab-diary');
        const searchBtn = document.getElementById('nut-tab-search');
        if (diaryBtn)  diaryBtn.className  = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab==='diary'  ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (searchBtn) searchBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab==='search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        document.getElementById('nut-view-diary')?.classList.toggle('hidden', tab!=='diary');
        document.getElementById('nut-view-search')?.classList.toggle('hidden', tab!=='search');
        if (tab==='diary')  renderDiary();
        if (tab==='search') renderCreatedMeals();
    }

    function renderDiary() {
        const todayMeals   = state.dailyMeals.filter(m => m.date === state.viewDate);
        const totalCals    = todayMeals.reduce((sum,m) => sum+(m.calories||0), 0);
        const totalProtein = todayMeals.reduce((sum,m) => sum+(m.protein||0), 0);
        const totalKcalEl  = document.getElementById('total-kcal');
        if (totalKcalEl) totalKcalEl.innerText = Math.round(totalCals);
        const totalProteinEl = document.getElementById('total-protein');
        if (totalProteinEl) totalProteinEl.innerText = totalProtein.toFixed(1);

        const sections = ['breakfast','lunch','dinner','snack'];
        let html = '';
        sections.forEach(section => {
            const meals = todayMeals.filter(m => m.mealType === section);
            const icons = { breakfast:'coffee', lunch:'utensils', dinner:'moon', snack:'cookie' };
            html += `<div class="mb-6">
                <div class="flex items-center gap-2 mb-3"><i data-lucide="${icons[section]}" class="w-4 h-4 text-slate-400"></i><h3 class="text-[11px] font-black text-slate-400 uppercase">${section}</h3></div>
                ${meals.length===0 ? '<p class="text-xs text-slate-300 italic px-4">Nothing logged</p>' : ''}
                ${meals.map(m=>`<div class="bg-white p-4 rounded-[24px] mb-2 border border-slate-100 flex items-center gap-4">
                    <img src="${m.image||'https://via.placeholder.com/100'}" class="w-12 h-12 object-contain bg-slate-50 rounded-lg p-1 flex-shrink-0" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1 min-w-0"><p class="font-bold text-sm truncate">${m.name}</p><p class="text-xs text-slate-400">${m.amount} ‚Ä¢ ${m.calories}kcal ‚Ä¢ ${m.protein}g protein</p></div>
                    <button onclick="removeMeal(${m.id})" class="text-slate-300 hover:text-red-500 flex-shrink-0"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`).join('')}
            </div>`;
        });
        const mealSections = document.getElementById('meal-sections');
        if (mealSections) mealSections.innerHTML = html;
        lucide.createIcons();
    }

    function removeMeal(id) {
        state.dailyMeals = state.dailyMeals.filter(m => m.id !== id);
        saveState(); renderDiary(); renderDashboard();
        showToast('Item removed');
    }

    function changeNutritionDate(days) {
        const current = document.getElementById('nutrition-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current); date.setDate(date.getDate()+days);
        selectNutritionDate(date.toISOString().split('T')[0]);
    }
    function selectNutritionDate(dateStr) {
        state.viewDate = dateStr;
        const picker = document.getElementById('nutrition-date-picker');
        if (picker) picker.value = dateStr;
        const today = new Date().toISOString().split('T')[0];
        const isToday = dateStr === today;
        document.getElementById('nutrition-date-warning')?.classList.toggle('hidden', isToday);
        document.getElementById('nutrition-save-buttons')?.classList.toggle('hidden', isToday);
        renderDiary(); renderDashboard(); lucide.createIcons();
    }
    function saveNutritionChanges() {
        const today = new Date().toISOString().split('T')[0];
        if (state.viewDate !== today) {
            const meals = state.dailyMeals.filter(m => m.date===state.viewDate);
            if (meals.length > 0) {
                const totalCals    = meals.reduce((sum,m)=>sum+(m.calories||0),0);
                const totalProtein = meals.reduce((sum,m)=>sum+(m.protein||0),0);
                state.nutritionHistory = state.nutritionHistory.filter(h=>h.date!==state.viewDate);
                state.nutritionHistory.unshift({date:state.viewDate, calories:totalCals, protein:totalProtein, meals});
            }
        }
        saveState(); showToast('Changes saved!');
        selectNutritionDate(new Date().toISOString().split('T')[0]);
    }
    function cancelNutritionChanges() {
        loadState(); selectNutritionDate(new Date().toISOString().split('T')[0]);
        showToast('Changes cancelled');
    }

    function changeMetricsDate(days) {
        const current = document.getElementById('metrics-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current); date.setDate(date.getDate()+days);
        selectMetricsDate(date.toISOString().split('T')[0]);
    }
    function selectMetricsDate(dateStr) {
        state.metricsDate = dateStr;
        const picker = document.getElementById('metrics-date-picker');
        if (picker) picker.value = dateStr;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('metrics-date-warning')?.classList.toggle('hidden', dateStr===today);
        const existing = state.metricsHistory.find(m => m.date===dateStr);
        if (existing) {
            ['weight','chest','shoulders','arms','waist','legs','glutes'].forEach(f => {
                const el = document.getElementById(`metric-${f}`);
                if (el) el.value = existing[f]||'';
            });
            if (existing.photos) {
                state.currentPhotos = {...existing.photos};
                ['front','side','back'].forEach(t => {
                    const img = document.getElementById(`photo-${t}-preview`);
                    if (img) { if(existing.photos[t]){img.src=existing.photos[t]; img.classList.remove('hidden');} else img.classList.add('hidden'); }
                });
            }
            showToast('Loaded metrics for '+new Date(dateStr+'T00:00:00').toLocaleDateString());
        } else {
            ['weight','chest','shoulders','arms','waist','legs','glutes'].forEach(f => {
                const el = document.getElementById(`metric-${f}`);
                if (el) el.value = '';
            });
            state.currentPhotos = {front:null,side:null,back:null};
            ['front','side','back'].forEach(t => { document.getElementById(`photo-${t}-preview`)?.classList.add('hidden'); });
        }
        lucide.createIcons();
    }

    // ==========================================================================
    // FOOD SEARCH (unchanged logic)
    // ==========================================================================
    function showStoreDropdown() {
        const dropdown = document.getElementById('store-dropdown');
        if (!dropdown) return;
        dropdown.innerHTML = UK_STORES_RESTAURANTS.map(store => {
            const icon = store.type==='fastfood' ? 'üçî' : store.type==='supermarket' ? 'üõí' : 'üåê';
            return `<div onclick="selectStore('${store.value}','${store.name.replace(/'/g,"\\'")}')\" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2"><span>${icon}</span><span class="font-medium text-sm flex-1">${store.name}</span></div>`;
        }).join('');
        dropdown.classList.remove('hidden');
    }
    function filterStoreDropdown(query) {
        const dropdown = document.getElementById('store-dropdown');
        if (!dropdown) return;
        const filtered = UK_STORES_RESTAURANTS.filter(s=>s.name.toLowerCase().includes(query.toLowerCase()));
        dropdown.innerHTML = filtered.length===0 ? '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>' :
            filtered.map(store => {
                const icon = store.type==='fastfood'?'üçî':store.type==='supermarket'?'üõí':'üåê';
                return `<div onclick="selectStore('${store.value}','${store.name.replace(/'/g,"\\'")}')\" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2"><span>${icon}</span><span class="font-medium text-sm flex-1">${store.name}</span></div>`;
            }).join('');
        dropdown.classList.remove('hidden');
    }
    function selectStore(value, name) {
        const input = document.getElementById('store-search-input');
        if (input) input.value = name;
        const hidden = document.getElementById('store-select');
        if (hidden) hidden.value = value;
        document.getElementById('store-dropdown')?.classList.add('hidden');
        showToast(`Filter: ${name}`);
        const foodInput = document.getElementById('food-search-input');
        if (foodInput && foodInput.value.trim().length>=2) searchFood(foodInput.value.trim());
    }
    function clearStoreFilter() {
        const input = document.getElementById('store-search-input');
        if (input) input.value = 'All Stores & Restaurants';
        const hidden = document.getElementById('store-select');
        if (hidden) hidden.value = 'all';
        showToast('Filter cleared');
        const foodInput = document.getElementById('food-search-input');
        if (foodInput && foodInput.value.trim().length>=2) searchFood(foodInput.value.trim());
    }

    let searchDebounce;
    document.addEventListener('DOMContentLoaded', ()=>{
        const foodSearchInput = document.getElementById('food-search-input');
        if (foodSearchInput) {
            foodSearchInput.addEventListener('input', (e)=>{
                clearTimeout(searchDebounce);
                const query = e.target.value.trim();
                if (query.length<2) { document.getElementById('search-results-list').innerHTML=''; return; }
                searchDebounce = setTimeout(()=>searchFood(query), 500);
            });
        }
    });

    async function searchFood(query) {
        const loadingEl = document.getElementById('search-loading');
        const resultsEl = document.getElementById('search-results-list');
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (resultsEl) resultsEl.innerHTML = '';
        try {
            const storeValue    = document.getElementById('store-select')?.value||'all';
            const selectedStore = UK_STORES_RESTAURANTS.find(s=>s.value===storeValue);
            let searchResults_temp = [];
            if (storeValue && storeValue!=='all' && selectedStore) {
                const storeName    = selectedStore.name;
                const combinedQuery = `${query} ${storeName}`;
                const isFastFood    = selectedStore.type==='fastfood';
                try {
                    const offUrl      = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(combinedQuery)}&search_simple=1&json=1&page_size=50&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                    const offResponse = await fetch(offUrl);
                    const offData     = await offResponse.json();
                    const offResults  = (offData.products||[]).map(p=>({
                        name:p.product_name||'Unknown', image:p.image_small_url||'https://via.placeholder.com/100',
                        calories:Math.round(p.nutriments?.['energy-kcal_100g']||0),
                        protein:parseFloat(p.nutriments?.proteins_100g||0).toFixed(1),
                        carbs:parseFloat(p.nutriments?.carbohydrates_100g||0).toFixed(1),
                        fat:parseFloat(p.nutriments?.fat_100g||0).toFixed(1),
                        fiber:parseFloat(p.nutriments?.fiber_100g||0).toFixed(1),
                        sugar:parseFloat(p.nutriments?.sugars_100g||0).toFixed(1),
                        sodium:parseFloat(p.nutriments?.sodium_100g||0).toFixed(3),
                        saturated_fat:parseFloat(p.nutriments?.['saturated-fat_100g']||0).toFixed(1),
                        cholesterol:parseFloat(p.nutriments?.cholesterol_100g||0).toFixed(1),
                        serving:p.serving_size||'100g', brand:p.brands||'', source:'OpenFoodFacts'
                    }));
                    const storeNameLower = storeName.toLowerCase();
                    searchResults_temp = offResults.filter(item=>(item.brand||'').toLowerCase().includes(storeNameLower)||(item.name||'').toLowerCase().includes(storeNameLower));
                } catch(e){ console.error('OFF error:',e); }
                if ((isFastFood && searchResults_temp.length<10)||searchResults_temp.length===0) {
                    try {
                        const usdaUrl      = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(combinedQuery)}&dataType=Branded&pageSize=30&api_key=DEMO_KEY`;
                        const usdaResponse = await fetch(usdaUrl);
                        const usdaData     = await usdaResponse.json();
                        const storeNameLower = storeName.toLowerCase();
                        const usdaResults  = (usdaData.foods||[]).filter(f=>(f.description||'').toLowerCase().includes(storeNameLower)||(f.brandName||'').toLowerCase().includes(storeNameLower)).map(f=>{
                            const nutrients = f.foodNutrients||[];
                            const getN = (names)=>{ for(let n of names){const found=nutrients.find(x=>x.nutrientName?.toLowerCase().includes(n)); if(found) return parseFloat(found.value||0);} return 0; };
                            return { name:f.description||'Unknown', image:'https://via.placeholder.com/100', calories:Math.round(getN(['energy','calories'])), protein:getN(['protein']).toFixed(1), carbs:getN(['carbohydrate']).toFixed(1), fat:getN(['total lipid','total fat']).toFixed(1), fiber:getN(['fiber']).toFixed(1), sugar:getN(['sugars']).toFixed(1), sodium:(getN(['sodium'])/1000).toFixed(3), saturated_fat:getN(['saturated']).toFixed(1), cholesterol:getN(['cholesterol']).toFixed(1), serving:f.servingSize?`${f.servingSize}${f.servingSizeUnit||'g'}`:'100g', brand:f.brandName||storeName, source:'USDA' };
                        });
                        searchResults_temp = [...searchResults_temp, ...usdaResults];
                    } catch(e){ console.error('USDA error:',e); }
                }
            } else {
                try {
                    const offUrl      = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=20&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                    const offResponse = await fetch(offUrl);
                    const offData     = await offResponse.json();
                    searchResults_temp = (offData.products||[]).map(p=>({name:p.product_name||'Unknown',image:p.image_small_url||'https://via.placeholder.com/100',calories:Math.round(p.nutriments?.['energy-kcal_100g']||0),protein:parseFloat(p.nutriments?.proteins_100g||0).toFixed(1),carbs:parseFloat(p.nutriments?.carbohydrates_100g||0).toFixed(1),fat:parseFloat(p.nutriments?.fat_100g||0).toFixed(1),fiber:parseFloat(p.nutriments?.fiber_100g||0).toFixed(1),sugar:parseFloat(p.nutriments?.sugars_100g||0).toFixed(1),sodium:parseFloat(p.nutriments?.sodium_100g||0).toFixed(3),saturated_fat:parseFloat(p.nutriments?.['saturated-fat_100g']||0).toFixed(1),cholesterol:parseFloat(p.nutriments?.cholesterol_100g||0).toFixed(1),serving:p.serving_size||'100g',brand:p.brands||'',source:'OpenFoodFacts'}));
                } catch(e){ console.error('OFF general error:',e); }
                try {
                    const usdaUrl      = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&pageSize=10&api_key=DEMO_KEY`;
                    const usdaResponse = await fetch(usdaUrl);
                    const usdaData     = await usdaResponse.json();
                    const usdaResults  = (usdaData.foods||[]).slice(0,10).map(f=>{
                        const nutrients = f.foodNutrients||[];
                        const getN = (names)=>{ for(let n of names){const found=nutrients.find(x=>x.nutrientName?.toLowerCase().includes(n)); if(found) return parseFloat(found.value||0);} return 0; };
                        return {name:f.description||'Unknown',image:'https://via.placeholder.com/100',calories:Math.round(getN(['energy','calories'])),protein:getN(['protein']).toFixed(1),carbs:getN(['carbohydrate']).toFixed(1),fat:getN(['total lipid','total fat']).toFixed(1),fiber:getN(['fiber']).toFixed(1),sugar:getN(['sugars']).toFixed(1),sodium:(getN(['sodium'])/1000).toFixed(3),saturated_fat:getN(['saturated']).toFixed(1),cholesterol:getN(['cholesterol']).toFixed(1),serving:'100g',brand:f.brandName||'',source:'USDA'};
                    });
                    searchResults_temp = [...searchResults_temp, ...usdaResults];
                } catch(e){ console.error('USDA general error:',e); }
            }
            const unique = []; const seen = new Set();
            for (const item of searchResults_temp) { const key=(item.name||'').toLowerCase().replace(/[^a-z0-9]/g,''); if(!seen.has(key)){seen.add(key); unique.push(item);} }
            const customMatches = (state.customFoods||[]).filter(f=>(f.name||'').toLowerCase().includes(query.toLowerCase())||(f.brand||'').toLowerCase().includes(query.toLowerCase()));
            searchResults = [...customMatches, ...unique];
            renderSearchResults();
        } catch (error) { console.error('Search error:', error); showToast('Search failed ‚Äî check connection'); }
        finally { if (loadingEl) loadingEl.classList.add('hidden'); }
    }

    function renderSearchResults() {
        const storeValue       = document.getElementById('store-select')?.value||'all';
        const selectedStoreName = storeValue!=='all' ? UK_STORES_RESTAURANTS.find(s=>s.value===storeValue)?.name : null;
        let filterMessage = '';
        if (selectedStoreName) filterMessage = `<div class="flex items-center justify-between py-3 mb-3 bg-indigo-50 rounded-2xl px-4"><span class="text-indigo-700 text-xs font-bold">Filtering by ${selectedStoreName}</span><button onclick="clearStoreFilter()" class="text-xs font-bold text-red-600 hover:text-red-700">Clear √ó</button></div>`;
        if (searchResults.length===0) {
            const msg = selectedStoreName
                ? `<div class="text-center py-12"><p class="text-slate-600 font-bold mb-2">No products found from ${selectedStoreName}</p><button onclick="clearStoreFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold mt-3">Search All Stores</button></div>`
                : `<p class="text-center text-slate-400 py-8">No results found</p>`;
            const el = document.getElementById('search-results-list');
            if (el) el.innerHTML = filterMessage+msg;
            lucide.createIcons(); return;
        }
        const html = searchResults.map((item,idx)=>`<div onclick="openFoodPopup(${idx})" class="bg-white p-4 rounded-[28px] border ${item.source==='Custom'?'border-purple-200 bg-purple-50':'border-slate-100'} flex items-center gap-4 cursor-pointer hover:shadow-lg transition-all">
            <img src="${item.image}" class="w-14 h-14 object-contain bg-slate-50 rounded-xl p-1 flex-shrink-0" onerror="this.src='https://via.placeholder.com/100'">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1 flex-wrap"><p class="font-bold text-sm">${item.name}</p>${item.source==='Custom'?`<span class="text-[8px] font-black px-1.5 py-0.5 rounded bg-purple-500 text-white">MY FOOD</span>`:''}</div>
                ${item.brand?`<p class="text-[10px] text-indigo-600 font-semibold mb-1">${item.brand}</p>`:''}
                <p class="text-xs text-slate-400">${item.calories}kcal ‚Ä¢ ${item.protein}g protein</p>
            </div><i data-lucide="plus" class="text-emerald-600 flex-shrink-0"></i>
        </div>`).join('');
        const el = document.getElementById('search-results-list');
        if (el) el.innerHTML = filterMessage+html;
        lucide.createIcons();
    }

    // ==========================================================================
    // MANUAL FOOD ENTRY
    // ==========================================================================
    function openManualFoodEntry() {
        document.getElementById('manual-food-modal').style.display = 'flex';
        ['manual-food-name','manual-food-store-input','manual-food-calories','manual-food-protein','manual-food-carbs','manual-food-fat','manual-food-fiber','manual-food-sugar'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        const serving = document.getElementById('manual-food-serving');
        if (serving) serving.value = '100g';
        clearManualFoodImage(); lucide.createIcons();
    }
    function closeManualFoodEntry() { document.getElementById('manual-food-modal').style.display='none'; manualFoodImageData=null; }
    function previewManualFoodImage(event) {
        const file = event.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { manualFoodImageData=e.target.result; const preview=document.getElementById('manual-food-preview'); if(preview) preview.innerHTML=`<img src="${e.target.result}" class="w-full h-full object-cover rounded-2xl">`; };
        reader.readAsDataURL(file);
    }
    function clearManualFoodImage() {
        manualFoodImageData=null;
        const preview = document.getElementById('manual-food-preview');
        if (preview) preview.innerHTML='<i data-lucide="image" class="w-10 h-10 text-slate-300"></i>';
        const fileInput = document.getElementById('manual-food-image');
        if (fileInput) fileInput.value='';
        lucide.createIcons();
    }
    function toggleManualFoodMacros() {
        const macrosDiv    = document.getElementById('manual-food-macros');
        const toggleText   = document.getElementById('manual-macros-toggle');
        const isHidden     = macrosDiv.classList.contains('hidden');
        macrosDiv.classList.toggle('hidden');
        if (toggleText) toggleText.innerText = isHidden ? '- Hide Extra Details' : '+ Add More Details (Optional)';
    }
    function showManualStoreDropdown() {
        const dropdown = document.getElementById('manual-store-dropdown'); if(!dropdown) return;
        dropdown.innerHTML = UK_STORES_RESTAURANTS.map(store=>{ const icon=store.type==='fastfood'?'üçî':store.type==='supermarket'?'üõí':'üåê'; return `<div onclick="selectManualStore('${store.name.replace(/'/g,"\\'")}')\" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2"><span>${icon}</span><span class="font-medium text-sm flex-1">${store.name}</span></div>`; }).join('');
        dropdown.classList.remove('hidden');
    }
    function filterManualStoreDropdown(query) {
        const dropdown = document.getElementById('manual-store-dropdown'); if(!dropdown) return;
        const filtered = UK_STORES_RESTAURANTS.filter(s=>s.name.toLowerCase().includes(query.toLowerCase()));
        dropdown.innerHTML = filtered.length===0 ? '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>' :
            filtered.map(store=>{ const icon=store.type==='fastfood'?'üçî':store.type==='supermarket'?'üõí':'üåê'; return `<div onclick="selectManualStore('${store.name.replace(/'/g,"\\'")}')\" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2"><span>${icon}</span><span class="font-medium text-sm flex-1">${store.name}</span></div>`; }).join('');
        dropdown.classList.remove('hidden');
    }
    function selectManualStore(storeName) {
        const input = document.getElementById('manual-food-store-input');
        if (input) input.value = storeName;
        document.getElementById('manual-store-dropdown')?.classList.add('hidden');
    }
    function saveManualFood() {
        const name    = document.getElementById('manual-food-name')?.value.trim();
        const store   = document.getElementById('manual-food-store-input')?.value.trim();
        const calories= parseFloat(document.getElementById('manual-food-calories')?.value)||0;
        const protein = parseFloat(document.getElementById('manual-food-protein')?.value)||0;
        const carbs   = parseFloat(document.getElementById('manual-food-carbs')?.value)||0;
        const fat     = parseFloat(document.getElementById('manual-food-fat')?.value)||0;
        const fiber   = parseFloat(document.getElementById('manual-food-fiber')?.value)||0;
        const sugar   = parseFloat(document.getElementById('manual-food-sugar')?.value)||0;
        const serving = document.getElementById('manual-food-serving')?.value.trim()||'100g';
        if (!name) { showToast('Please enter food name'); return; }
        if (calories===0 && protein===0) { showToast('Please enter at least calories or protein'); return; }
        const customFood = { id:Date.now(), name, brand:store||'Custom', image:manualFoodImageData||'https://via.placeholder.com/100', calories, protein:protein.toFixed(1), carbs:carbs.toFixed(1), fat:fat.toFixed(1), fiber:fiber.toFixed(1), sugar:sugar.toFixed(1), sodium:'0', saturated_fat:'0', cholesterol:'0', serving, source:'Custom' };
        if (!state.customFoods) state.customFoods=[];
        state.customFoods.push(customFood);
        saveState(); closeManualFoodEntry(); showToast(`${name} saved to My Foods!`);
        searchResults.unshift(customFood); renderSearchResults();
    }

    // ==========================================================================
    // FOOD POPUP
    // ==========================================================================
    function openFoodPopup(idx) {
        currentFoodItem = searchResults[idx]; if(!currentFoodItem) return;
        document.getElementById('popup-image').src = currentFoodItem.image||'https://via.placeholder.com/100';
        document.getElementById('popup-name').innerText = currentFoodItem.name;
        document.getElementById('popup-nutrition').innerText = `Per ${currentFoodItem.serving}${currentFoodItem.source?' ‚Ä¢ '+currentFoodItem.source:''}`;
        document.getElementById('popup-nutrition-cals').innerText = currentFoodItem.calories;
        document.getElementById('popup-nutrition-protein').innerText = currentFoodItem.protein;
        document.getElementById('popup-nutrition-carbs').innerText  = (currentFoodItem.carbs||0)+'g';
        document.getElementById('popup-nutrition-fat').innerText    = (currentFoodItem.fat||0)+'g';
        document.getElementById('popup-nutrition-fiber').innerText  = (currentFoodItem.fiber||0)+'g';
        document.getElementById('popup-nutrition-sugar').innerText  = (currentFoodItem.sugar||0)+'g';
        document.getElementById('popup-nutrition-satfat').innerText = (currentFoodItem.saturated_fat||0)+'g';
        document.getElementById('popup-nutrition-sodium').innerText = (currentFoodItem.sodium||0)+'g';
        document.getElementById('popup-nutrition-cholesterol').innerText = Math.round(currentFoodItem.cholesterol||0)+'mg';
        document.getElementById('detailed-nutrition').classList.add('hidden');
        document.getElementById('toggle-text').innerText = 'Show More ‚ñº';
        document.getElementById('popup-amount').value = 1;
        currentAmountType = 'portion'; setAmountType('portion'); updateFoodPopup();
        document.getElementById('food-popup').style.display = 'flex'; lucide.createIcons();
    }
    function toggleDetailedNutrition() {
        const div = document.getElementById('detailed-nutrition');
        const text = document.getElementById('toggle-text');
        div.classList.toggle('hidden');
        if (text) text.innerText = div.classList.contains('hidden') ? 'Show More ‚ñº' : 'Show Less ‚ñ≤';
    }
    function closeFoodPopup() { document.getElementById('food-popup').style.display='none'; }
    function setAmountType(type) {
        currentAmountType = type;
        const portionBtn = document.getElementById('amount-type-portion');
        const gramsBtn   = document.getElementById('amount-type-grams');
        if (portionBtn) portionBtn.className = `flex-1 py-3 rounded-xl text-xs font-black uppercase ${type==='portion'?'bg-white shadow text-emerald-600':'text-slate-400'}`;
        if (gramsBtn)   gramsBtn.className   = `flex-1 py-3 rounded-xl text-xs font-black uppercase ${type==='grams'?'bg-white shadow text-emerald-600':'text-slate-400'}`;
        updateFoodPopup();
    }
    function updateFoodPopup() {
        if (!currentFoodItem) return;
        const amount = parseFloat(document.getElementById('popup-amount')?.value)||0;
        const multiplier = currentAmountType==='portion' ? amount : amount/100;
        document.getElementById('popup-total-kcal').innerText    = Math.round(currentFoodItem.calories*multiplier);
        document.getElementById('popup-total-protein').innerText = (parseFloat(currentFoodItem.protein)*multiplier).toFixed(1)+'g';
    }
    document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('popup-amount')?.addEventListener('input', updateFoodPopup); });

    function addFoodItem() {
        if (!currentFoodItem) return;
        const amount     = parseFloat(document.getElementById('popup-amount').value)||0;
        const multiplier = currentAmountType==='portion' ? amount : amount/100;
        const mealType   = document.getElementById('popup-meal-type').value;
        if (!state.dailyMeals) state.dailyMeals=[];
        state.dailyMeals.push({
            id:Date.now(), date:state.viewDate, name:currentFoodItem.name, image:currentFoodItem.image,
            amount:currentAmountType==='portion'?`${amount} portion(s)`:`${amount}g`,
            calories:Math.round(currentFoodItem.calories*multiplier),
            protein:parseFloat((parseFloat(currentFoodItem.protein)*multiplier).toFixed(1)),
            carbs:parseFloat(((parseFloat(currentFoodItem.carbs)||0)*multiplier).toFixed(1)),
            fat:parseFloat(((parseFloat(currentFoodItem.fat)||0)*multiplier).toFixed(1)),
            fiber:parseFloat(((parseFloat(currentFoodItem.fiber)||0)*multiplier).toFixed(1)),
            sugar:parseFloat(((parseFloat(currentFoodItem.sugar)||0)*multiplier).toFixed(1)),
            sodium:parseFloat(((parseFloat(currentFoodItem.sodium)||0)*multiplier).toFixed(3)),
            saturated_fat:parseFloat(((parseFloat(currentFoodItem.saturated_fat)||0)*multiplier).toFixed(1)),
            cholesterol:parseFloat(((parseFloat(currentFoodItem.cholesterol)||0)*multiplier).toFixed(1)),
            mealType, source:currentFoodItem.source||'Manual'
        });
        saveState(); closeFoodPopup(); setNutritionTab('diary'); renderDashboard();
        showToast('Added to diary! üçΩÔ∏è');
    }

    // ==========================================================================
    // BARCODE SCANNER
    // ==========================================================================
    function openBarcodeScanner() {
        document.getElementById('barcode-scanner-modal').style.display='flex';
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("barcode-reader");
            html5QrCode.start({ facingMode:"environment" },{fps:10,qrbox:250},(code)=>{ document.getElementById('manual-barcode').value=code; lookupBarcode(); }).catch(err=>console.error('Scanner start error:',err));
        }
    }
    function closeBarcodeScanner() {
        if (html5QrCode) { html5QrCode.stop().catch(()=>{}); html5QrCode=null; }
        document.getElementById('barcode-scanner-modal').style.display='none';
    }
    async function lookupBarcode() {
        const code = document.getElementById('manual-barcode')?.value.trim(); if(!code) return;
        try {
            const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
            const data = await response.json();
            if (data.status===1) {
                const p = data.product;
                searchResults = [{ name:p.product_name||'Unknown', image:p.image_small_url||'https://via.placeholder.com/100', calories:Math.round(p.nutriments?.['energy-kcal_100g']||0), protein:parseFloat(p.nutriments?.proteins_100g||0).toFixed(1), carbs:parseFloat(p.nutriments?.carbohydrates_100g||0).toFixed(1), fat:parseFloat(p.nutriments?.fat_100g||0).toFixed(1), fiber:parseFloat(p.nutriments?.fiber_100g||0).toFixed(1), sugar:parseFloat(p.nutriments?.sugars_100g||0).toFixed(1), sodium:parseFloat(p.nutriments?.sodium_100g||0).toFixed(3), saturated_fat:parseFloat(p.nutriments?.['saturated-fat_100g']||0).toFixed(1), cholesterol:'0', serving:p.serving_size||'100g', brand:p.brands||'', source:'OpenFoodFacts' }];
                closeBarcodeScanner(); openFoodPopup(0);
            } else showToast('Product not found');
        } catch { showToast('Barcode lookup failed'); }
    }

    // ==========================================================================
    // CREATED MEALS
    // ==========================================================================
    function renderCreatedMeals() {
        const html = (state.createdMeals||[]).map((meal,idx)=>`<div class="bg-white p-4 rounded-[28px] border border-slate-100 flex items-center gap-4 transition-all">
            <div class="w-14 h-14 bg-emerald-50 rounded-xl flex items-center justify-center flex-shrink-0"><i data-lucide="chef-hat" class="text-emerald-600 w-7 h-7"></i></div>
            <div class="flex-1 min-w-0 cursor-pointer" onclick="addCreatedMeal(${idx})"><p class="font-bold text-sm truncate">${meal.name}</p><p class="text-xs text-slate-400">${meal.calories}kcal ‚Ä¢ ${meal.protein}g protein</p></div>
            <div class="flex gap-2 flex-shrink-0">
                <button onclick="addCreatedMeal(${idx})" class="w-9 h-9 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 flex items-center justify-center"><i data-lucide="plus" class="w-4 h-4"></i></button>
                <button onclick="editCreatedMeal(${idx})" class="w-9 h-9 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 flex items-center justify-center"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                <button onclick="deleteCreatedMeal(${idx})" class="w-9 h-9 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 flex items-center justify-center"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
        </div>`).join('');
        const list = document.getElementById('created-meals-list');
        if (list) list.innerHTML = html || '<p class="text-center text-slate-400 py-8 text-sm">No custom meals created yet</p>';
        lucide.createIcons();
    }
    function addCreatedMeal(idx) {
        const meal = state.createdMeals[idx]; if(!meal) return;
        if (!state.dailyMeals) state.dailyMeals=[];
        state.dailyMeals.push({ id:Date.now(), date:state.viewDate, name:meal.name, image:'https://via.placeholder.com/100', amount:'1 meal', calories:meal.calories, protein:meal.protein, mealType:'dinner' });
        saveState(); setNutritionTab('diary'); renderDashboard(); showToast('Meal added! üçΩÔ∏è');
    }
    function editCreatedMeal(idx) {
        const meal = state.createdMeals[idx];
        const nameInput = document.getElementById('meal-name-input');
        if (nameInput) nameInput.value = meal.name;
        mealIngredients = [...meal.ingredients]; renderMealIngredients();
        document.getElementById('create-meal-modal').style.display='flex';
        window.editingMealIndex = idx;
        const title = document.querySelector('#create-meal-modal h3');
        if (title) title.textContent='Edit Meal';
        lucide.createIcons();
    }
    function deleteCreatedMeal(idx) {
        const meal = state.createdMeals[idx];
        if (confirm(`Delete "${meal.name}"?`)) { state.createdMeals.splice(idx,1); saveState(); renderCreatedMeals(); showToast('Meal deleted'); }
    }
    function openCreateMeal() {
        mealIngredients=[];
        const nameInput = document.getElementById('meal-name-input');
        if (nameInput) nameInput.value='';
        renderMealIngredients();
        document.getElementById('create-meal-modal').style.display='flex';
        window.editingMealIndex=null;
        const title = document.querySelector('#create-meal-modal h3');
        if (title) title.textContent='Create Meal';
        lucide.createIcons();
    }
    function closeCreateMeal() { document.getElementById('create-meal-modal').style.display='none'; window.editingMealIndex=null; }

    let mealSearchDebounce;
    document.addEventListener('DOMContentLoaded',()=>{
        const mealSearch = document.getElementById('meal-ingredient-search');
        if (mealSearch) mealSearch.addEventListener('input',(e)=>{ clearTimeout(mealSearchDebounce); const query=e.target.value.trim(); if(query.length<2){document.getElementById('meal-search-results').innerHTML='';return;} mealSearchDebounce=setTimeout(()=>searchMealIngredient(query),500); });
    });

    async function searchMealIngredient(query) {
        try {
            const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=10&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
            const response = await fetch(url); const data = await response.json();
            const results = (data.products||[]).map(p=>({ name:p.product_name||'Unknown', image:p.image_small_url||'https://via.placeholder.com/100', calories:Math.round(p.nutriments?.['energy-kcal_100g']||0), protein:parseFloat(p.nutriments?.proteins_100g||0).toFixed(1) }));
            const html = results.map((item,idx)=>`<div onclick="promptAddIngredient('${item.name.replace(/'/g,"\\'")}',${item.calories},${item.protein},'${item.image}')" class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-slate-100"><img src="${item.image}" class="w-10 h-10 object-contain rounded" onerror="this.src='https://via.placeholder.com/100'"><div class="flex-1 min-w-0"><p class="font-bold text-xs truncate">${item.name}</p><p class="text-[10px] text-slate-400">${item.calories}kcal, ${item.protein}g protein</p></div></div>`).join('');
            const resultsEl = document.getElementById('meal-search-results');
            if (resultsEl) resultsEl.innerHTML = html;
        } catch(e){ console.error('Ingredient search error:',e); }
    }
    function promptAddIngredient(name, calories, protein, image) {
        const amount = prompt('Enter amount (in grams):', '100'); if(!amount) return;
        const multiplier = parseFloat(amount)/100;
        mealIngredients.push({ name, amount:`${amount}g`, calories:Math.round(calories*multiplier), protein:parseFloat((protein*multiplier).toFixed(1)) });
        renderMealIngredients();
        document.getElementById('meal-ingredient-search').value='';
        document.getElementById('meal-search-results').innerHTML='';
    }
    function renderMealIngredients() {
        const html = mealIngredients.map((ing,idx)=>`<div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between"><div><p class="font-bold text-xs">${ing.name}</p><p class="text-[10px] text-slate-400">${ing.amount} ‚Ä¢ ${ing.calories}kcal ‚Ä¢ ${ing.protein}g protein</p></div><button onclick="mealIngredients.splice(${idx},1);renderMealIngredients();" class="text-slate-300 hover:text-red-500 text-xl font-bold">√ó</button></div>`).join('');
        const list = document.getElementById('meal-ingredients-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-300 italic">No ingredients yet</p>';
    }
    function saveMeal() {
        const name = document.getElementById('meal-name-input')?.value.trim();
        if (!name) { showToast('Please enter meal name'); return; }
        if (mealIngredients.length===0) { showToast('Add at least one ingredient'); return; }
        const totalCals    = mealIngredients.reduce((s,i)=>s+i.calories,0);
        const totalProtein = mealIngredients.reduce((s,i)=>s+i.protein,0);
        const mealData = { id:Date.now(), name, calories:totalCals, protein:totalProtein, ingredients:[...mealIngredients] };
        if (!state.createdMeals) state.createdMeals=[];
        if (window.editingMealIndex!==null && window.editingMealIndex!==undefined) {
            mealData.id = state.createdMeals[window.editingMealIndex].id;
            state.createdMeals[window.editingMealIndex] = mealData;
            showToast('Meal updated!');
        } else { state.createdMeals.push(mealData); showToast('Meal saved!'); }
        saveState(); closeCreateMeal(); renderCreatedMeals();
    }

    // ==========================================================================
    // LOGS
    // ==========================================================================
    function setLogsTab(tab) {
        const trainingBtn  = document.getElementById('logs-tab-training');
        const nutritionBtn = document.getElementById('logs-tab-nutrition');
        if (trainingBtn)  trainingBtn.className  = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab==='training' ?'bg-white text-indigo-600 shadow-sm':'text-slate-400'}`;
        if (nutritionBtn) nutritionBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab==='nutrition'?'bg-white text-indigo-600 shadow-sm':'text-slate-400'}`;
        document.getElementById('logs-training-view')?.classList.toggle('hidden', tab!=='training');
        document.getElementById('logs-nutrition-view')?.classList.toggle('hidden', tab!=='nutrition');
        if (tab==='nutrition') renderHydrationLogs();
        else filterWorkouts();
        renderLogs();
    }

    function renderLogs() {
        const nutritionHtml = (state.nutritionHistory||[]).length===0 ? '<p class="text-center text-slate-400 py-10">No nutrition logs yet</p>' :
            (state.nutritionHistory||[]).map(n=>`<div class="glass-card p-5 rounded-2xl"><div class="flex justify-between items-start"><div><h4 class="font-bold">${n.date}</h4><p class="text-xs text-slate-400">${n.meals?.length||0} items logged</p></div><div class="text-right"><p class="font-bold">${Math.round(n.calories||0)} kcal</p><p class="text-xs text-blue-600">${(n.protein||0).toFixed(1)}g protein</p></div></div></div>`).join('');
        const nutritionLogsEl = document.getElementById('nutrition-logs-list');
        if (nutritionLogsEl) nutritionLogsEl.innerHTML = nutritionHtml;
    }

    function filterWorkouts() {
        const showWeights = document.getElementById('filter-weights')?.checked??true;
        const showCardio  = document.getElementById('filter-cardio')?.checked??true;
        const showCore    = document.getElementById('filter-core')?.checked??true;
        const showWalking = document.getElementById('filter-walking')?.checked??true;
        renderTrainingLogs(showWeights, showCardio, showCore, showWalking);
    }

    function renderTrainingLogs(showWeights=true, showCardio=true, showCore=true, showWalking=true) {
        const filtered = (state.workoutHistory||[]).filter(w=>{ const category=w.category||'weights'; const focus=(w.focus||'').toLowerCase(); if(category==='cardio'){const isWalking=((w.cardioData?.type||'')+focus).includes('walk'); return isWalking?showWalking:showCardio;} if(focus.includes('core')) return showCore; return showWeights; });
        const html = filtered.length===0 ? '<p class="text-center text-slate-400 py-10">No workouts logged yet</p>' :
            filtered.map(w=>`<div class="glass-card p-6 rounded-2xl"><div class="flex justify-between items-start mb-2"><div><p class="text-xs text-slate-400">${w.date}</p><h4 class="font-black text-lg">${w.focus}</h4>${w.cardioData?`<p class="text-sm text-indigo-600 mt-1">${w.cardioData.distance||0}km ‚Ä¢ ${w.cardioData.duration||0}min${w.cardioData.calories?` ‚Ä¢ ${w.cardioData.calories}kcal`:''}</p>`:`<p class="text-sm text-slate-500">${(w.exercises||[]).length} exercises ‚Ä¢ ${w.duration}</p>`}</div></div>${!w.cardioData&&(w.exercises||[]).length>0?`<div class="text-xs text-slate-400 mt-2">${(w.exercises||[]).slice(0,3).map(e=>e.name).join(' ‚Ä¢ ')}${(w.exercises||[]).length>3?` +${(w.exercises||[]).length-3} more`:''}</div>`:''}</div>`).join('');
        const listEl = document.getElementById('training-logs-list');
        if (listEl) listEl.innerHTML = html;
        lucide.createIcons();
    }

    // ==========================================================================
    // BODY METRICS
    // ==========================================================================
    function triggerPhotoUpload(type) { currentPhotoType=type; document.getElementById('photo-upload-input')?.click(); }

    document.addEventListener('DOMContentLoaded',()=>{
        const photoUpload = document.getElementById('photo-upload-input');
        if (photoUpload) {
            photoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0]; if(!file||!currentPhotoType) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const maxSize = 800; let {width,height}=img;
                        if(width>height&&width>maxSize){height*=maxSize/width;width=maxSize;}
                        else if(height>width&&height>maxSize){width*=maxSize/height;height=maxSize;}
                        canvas.width=width; canvas.height=height;
                        canvas.getContext('2d').drawImage(img,0,0,width,height);
                        const compressed = canvas.toDataURL('image/jpeg',0.7);
                        if (!state.currentPhotos) state.currentPhotos={};
                        state.currentPhotos[currentPhotoType] = compressed;
                        const preview = document.getElementById(`photo-${currentPhotoType}-preview`);
                        if (preview) { preview.src=compressed; preview.classList.remove('hidden'); }
                        showToast(`${currentPhotoType.charAt(0).toUpperCase()+currentPhotoType.slice(1)} photo added`);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    });

    function saveMetrics() {
        const weight = parseFloat(document.getElementById('metric-weight')?.value);
        if (!weight) { showToast('Please enter weight'); return; }
        const metricsDate  = state.metricsDate || new Date().toISOString().split('T')[0];
        const existingIndex = (state.metricsHistory||[]).findIndex(m=>m.date===metricsDate);
        const metricsData = { id:existingIndex>=0?state.metricsHistory[existingIndex].id:Date.now(), date:metricsDate, weight, chest:parseFloat(document.getElementById('metric-chest')?.value)||0, shoulders:parseFloat(document.getElementById('metric-shoulders')?.value)||0, arms:parseFloat(document.getElementById('metric-arms')?.value)||0, waist:parseFloat(document.getElementById('metric-waist')?.value)||0, legs:parseFloat(document.getElementById('metric-legs')?.value)||0, glutes:parseFloat(document.getElementById('metric-glutes')?.value)||0, photos:{...state.currentPhotos} };
        if (!state.metricsHistory) state.metricsHistory=[];
        if (existingIndex>=0) { state.metricsHistory[existingIndex]=metricsData; showToast('Metrics updated!'); }
        else { state.metricsHistory.unshift(metricsData); showToast('Metrics saved! üìä'); }
        saveState(); renderDashboard(); populateComparisonDates();
        ['weight','chest','shoulders','arms','waist','legs','glutes'].forEach(f=>{ const el=document.getElementById(`metric-${f}`); if(el) el.value=''; });
        state.currentPhotos={front:null,side:null,back:null};
        ['front','side','back'].forEach(t=>{ document.getElementById(`photo-${t}-preview`)?.classList.add('hidden'); });
        const today = new Date().toISOString().split('T')[0];
        if (metricsDate!==today) selectMetricsDate(today);
    }

    function populateComparisonDates() {
        const dates = (state.metricsHistory||[]).filter(m=>m.photos&&(m.photos.front||m.photos.side||m.photos.back)).map(m=>({date:m.date,id:m.id}));
        const html  = '<option value="">Select date...</option>'+dates.map(d=>`<option value="${d.id}">${d.date}</option>`).join('');
        const d1 = document.getElementById('compare-date-1'); const d2 = document.getElementById('compare-date-2');
        if (d1) d1.innerHTML=html; if (d2) d2.innerHTML=html;
    }

    let currentComparePhotoType = 'front';
    function setComparePhotoType(type) {
        currentComparePhotoType = type;
        ['front','side','back'].forEach(t=>{ const btn=document.getElementById(`compare-type-${t}`); if(btn) btn.className=`p-4 rounded-2xl font-bold text-sm ${t===type?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600'}`; });
        loadComparisonPhotos();
    }
    function loadComparisonPhotos() {
        const id1 = document.getElementById('compare-date-1')?.value;
        const id2 = document.getElementById('compare-date-2')?.value;
        if (!id1||!id2) { document.getElementById('comparison-view')?.classList.add('hidden'); document.getElementById('no-comparison-message')?.classList.remove('hidden'); return; }
        const m1 = state.metricsHistory.find(m=>String(m.id)===String(id1));
        const m2 = state.metricsHistory.find(m=>String(m.id)===String(id2));
        if (!m1||!m2) return;
        const p1 = m1.photos?.[currentComparePhotoType];
        const p2 = m2.photos?.[currentComparePhotoType];
        if (p1&&p2) {
            document.getElementById('compare-img-1').src=p1; document.getElementById('compare-img-2').src=p2;
            document.getElementById('compare-label-1').textContent=m1.date; document.getElementById('compare-label-2').textContent=m2.date;
            document.getElementById('comparison-view')?.classList.remove('hidden'); document.getElementById('no-comparison-message')?.classList.add('hidden');
        } else { document.getElementById('comparison-view')?.classList.add('hidden'); document.getElementById('no-comparison-message')?.classList.remove('hidden'); showToast('No photos for that angle on selected dates'); }
    }

    function openMetricsChart() { document.getElementById('metrics-chart-modal').style.display='flex'; setTimeout(()=>renderMetricChart(),100); lucide.createIcons(); }
    function closeMetricsChart() { document.getElementById('metrics-chart-modal').style.display='none'; }
    function openPhotoComparison() { populateComparisonDates(); currentComparePhotoType='front'; setComparePhotoType('front'); document.getElementById('photo-comparison-modal').style.display='flex'; document.getElementById('comparison-view')?.classList.add('hidden'); document.getElementById('no-comparison-message')?.classList.remove('hidden'); lucide.createIcons(); }
    function closePhotoComparison() { document.getElementById('photo-comparison-modal').style.display='none'; }

    function renderMetricChart() {
        const metric  = document.getElementById('chart-metric-select')?.value||'weight';
        const history = [...(state.metricsHistory||[])].reverse();
        const labels  = history.map(m=>new Date(m.date+'T00:00:00').toLocaleDateString('en-GB',{day:'2-digit',month:'short'}));
        const data    = history.map(m=>m[metric]||0);
        if (metricsChart) metricsChart.destroy();
        const ctx = document.getElementById('metrics-chart'); if(!ctx) return;
        metricsChart = new Chart(ctx,{type:'line',data:{labels,datasets:[{label:metric.charAt(0).toUpperCase()+metric.slice(1),data,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.1)',tension:0.4,borderWidth:3,pointRadius:4,pointBackgroundColor:'#fff',pointBorderWidth:2,pointBorderColor:'#6366f1'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{grid:{color:'#f1f5f9'},ticks:{font:{size:11}}},x:{grid:{color:'#f1f5f9'},ticks:{font:{size:10}}}}}});
    }

    // ==========================================================================
    // SETTINGS
    // ==========================================================================
    function updateCalorieGoal(value) {
        if (!state.goals) state.goals={};
        state.goals.calories = Number(value);
        saveState(); renderDashboard(); showToast('Goal updated');
    }
    function saveSettings() {
        const goalInput = document.getElementById('calorie-goal-input');
        if (goalInput&&goalInput.value) { if(!state.goals) state.goals={}; state.goals.calories=Number(goalInput.value); }
        saveState(); renderDashboard(); showToast('Settings saved ‚úì');
    }
    function renderSettings() {
        const goalInput = document.getElementById('calorie-goal-input');
        if (goalInput) goalInput.value = state.goals?.calories||2500;
        const gymHtml  = Object.keys(state.equipment.gym).map(eq=>`<button onclick="toggleEquipment('gym','${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase transition-all ${state.equipment.gym[eq]?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600 hover:bg-slate-200'}">${eq}</button>`).join('');
        const gymList = document.getElementById('gym-equipment-list'); if(gymList) gymList.innerHTML=gymHtml;
        const homeHtml = Object.keys(state.equipment.home).map(eq=>`<button onclick="toggleEquipment('home','${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase transition-all ${state.equipment.home[eq]?'bg-indigo-600 text-white':'bg-slate-100 text-slate-600 hover:bg-slate-200'}">${eq}</button>`).join('');
        const homeList = document.getElementById('home-equipment-list'); if(homeList) homeList.innerHTML=homeHtml;
        const habitsEnabled = document.getElementById('habits-enabled'); if(habitsEnabled) habitsEnabled.checked=state.habitsEnabled||false;
        document.getElementById('habits-section')?.classList.toggle('hidden', !state.habitsEnabled);
        document.getElementById('habits-tracker')?.classList.toggle('hidden', !state.habitsEnabled);
        if (state.habitsEnabled) { renderHabitsSettings(); renderDashboardHabits(); }
        const hydrationToggle = document.getElementById('track-hydration'); if(hydrationToggle) hydrationToggle.checked=state.trackHydration!==false;
        const stepsToggle     = document.getElementById('track-steps');     if(stepsToggle)     stepsToggle.checked=state.trackSteps!==false;
        renderGoals();
    }
    function toggleEquipment(env, equipment) {
        if (!state.equipment[env]) state.equipment[env]={};
        state.equipment[env][equipment] = !state.equipment[env][equipment];
        saveState(); renderSettings();
    }

    // ==========================================================================
    // HABITS
    // ==========================================================================
    function toggleHabits() {
        state.habitsEnabled = document.getElementById('habits-enabled').checked;
        document.getElementById('habits-section')?.classList.toggle('hidden', !state.habitsEnabled);
        document.getElementById('habits-tracker')?.classList.toggle('hidden', !state.habitsEnabled);
        saveState(); if(state.habitsEnabled){renderHabitsSettings();renderDashboardHabits();}
    }
    function addHabit() {
        const input = document.getElementById('new-habit-input');
        const name  = input?.value.trim(); if(!name) return;
        if (!state.habits) state.habits=[];
        state.habits.push({id:Date.now(), name});
        if (input) input.value='';
        saveState(); renderHabitsSettings(); renderDashboardHabits(); showToast('Habit added!');
    }
    function removeHabit(id) { state.habits=(state.habits||[]).filter(h=>h.id!==id); saveState(); renderHabitsSettings(); renderDashboardHabits(); }
    function renderHabitsSettings() {
        const html = (state.habits||[]).map(habit=>`<div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl"><span class="font-medium text-sm">${habit.name}</span><button onclick="removeHabit(${habit.id})" class="text-red-500 hover:bg-red-50 rounded-lg p-2"><i data-lucide="x" class="w-4 h-4"></i></button></div>`).join('');
        const list = document.getElementById('habits-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-400 italic text-center py-4">No habits added yet</p>';
        lucide.createIcons();
    }
    function toggleHabitCompletion(habitId) {
        const today = state.viewDate;
        if (!state.habitCompletions) state.habitCompletions={};
        if (!state.habitCompletions[today]) state.habitCompletions[today]={};
        state.habitCompletions[today][habitId] = !state.habitCompletions[today][habitId];
        saveState(); renderDashboardHabits();
    }
    function renderDashboardHabits() {
        const today       = state.viewDate;
        const completions = state.habitCompletions?.[today]||{};
        const html = (state.habits||[]).map(habit=>{ const done=completions[habit.id]||false; return `<div class="flex items-center gap-3 p-4 bg-white rounded-xl border-2 ${done?'border-emerald-500 bg-emerald-50':'border-slate-100'} transition-all"><button onclick="toggleHabitCompletion(${habit.id})" class="w-7 h-7 rounded-lg ${done?'bg-emerald-500 text-white':'bg-slate-100 text-slate-300'} flex items-center justify-center flex-shrink-0"><i data-lucide="${done?'check':'circle'}" class="w-4 h-4"></i></button><span class="flex-1 font-medium text-sm ${done?'text-emerald-900 line-through':'text-slate-900'}">${habit.name}</span></div>`; }).join('');
        const list = document.getElementById('dashboard-habits-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-400 italic text-center py-4">No habits to track today</p>';
        lucide.createIcons();
    }

    // ==========================================================================
    // TRACKING TOGGLES
    // ==========================================================================
    function toggleTracking(type) {
        if (type==='hydration') { state.trackHydration=document.getElementById('track-hydration').checked; document.getElementById('hydration-tracker')?.classList.toggle('hidden',!state.trackHydration); }
        else if (type==='steps') { state.trackSteps=document.getElementById('track-steps').checked; document.getElementById('steps-tracker')?.classList.toggle('hidden',!state.trackSteps); }
        saveState(); renderDashboard();
    }

    // ==========================================================================
    // GOAL SETTING
    // ==========================================================================
    function openGoalSetting() { document.getElementById('goal-modal').style.display='flex'; document.getElementById('goal-description').value=''; document.getElementById('goal-deadline').value=''; lucide.createIcons(); }
    function closeGoalModal() { document.getElementById('goal-modal').style.display='none'; }
    function saveGoal() {
        const type        = document.getElementById('goal-type')?.value;
        const description = document.getElementById('goal-description')?.value.trim();
        const deadline    = document.getElementById('goal-deadline')?.value;
        if (!description||!deadline) { showToast('Please fill all fields'); return; }
        if (!state.userGoals) state.userGoals=[];
        state.userGoals.push({id:Date.now(), type, description, deadline, completed:false, createdAt:new Date().toISOString()});
        saveState(); closeGoalModal(); renderGoals(); showToast('Goal added! üéØ');
    }
    function renderGoals() {
        const typeColors  = {short:'bg-green-100 text-green-700',medium:'bg-yellow-100 text-yellow-700',long:'bg-purple-100 text-purple-700'};
        const typeLabels  = {short:'Short-term',medium:'Medium-term',long:'Long-term'};
        const html = (state.userGoals||[]).filter(g=>!g.completed).map(goal=>`<div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl"><div class="flex-1"><span class="text-[9px] font-black ${typeColors[goal.type]||'bg-slate-100 text-slate-600'} px-2 py-1 rounded uppercase">${typeLabels[goal.type]||goal.type}</span><p class="font-bold text-sm mt-2">${goal.description}</p><p class="text-xs text-slate-400 mt-1">Due: ${new Date(goal.deadline+'T00:00:00').toLocaleDateString()}</p></div><div class="flex gap-2 flex-shrink-0 ml-3"><button onclick="completeGoal(${goal.id})" class="w-8 h-8 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 flex items-center justify-center"><i data-lucide="check" class="w-4 h-4"></i></button><button onclick="deleteGoal(${goal.id})" class="w-8 h-8 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 flex items-center justify-center"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>`).join('');
        const list = document.getElementById('goals-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-400 text-center py-4">No active goals</p>';
        lucide.createIcons();
    }
    function completeGoal(id) { const goal=(state.userGoals||[]).find(g=>g.id===id); if(goal){goal.completed=true;saveState();renderGoals();showToast('Goal completed! üéâ');} }
    function deleteGoal(id) { state.userGoals=(state.userGoals||[]).filter(g=>g.id!==id); saveState(); renderGoals(); }

    // ==========================================================================
    // CARDIO LOGGING
    // ==========================================================================
    function openCardioModal() {
        document.getElementById('cardio-modal').style.display='flex';
        ['cardio-duration','cardio-distance','cardio-calories'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
        document.getElementById('cardio-notes').value=''; lucide.createIcons();
    }
    function closeCardioModal() { document.getElementById('cardio-modal').style.display='none'; }
    function saveCardio() {
        const type     = document.getElementById('cardio-type')?.value;
        const duration = parseFloat(document.getElementById('cardio-duration')?.value);
        const distance = parseFloat(document.getElementById('cardio-distance')?.value)||0;
        const calories = parseFloat(document.getElementById('cardio-calories')?.value)||0;
        const notes    = document.getElementById('cardio-notes')?.value.trim()||'';
        const workoutDate = window.selectedWorkoutDate||document.getElementById('workout-date-picker')?.value||new Date().toISOString().split('T')[0];
        if (!duration) { showToast('Please enter duration'); return; }
        const cardioActivity = {id:Date.now(),date:workoutDate,type,duration,distance,calories,notes,category:'cardio'};
        if (!state.cardioLogs) state.cardioLogs=[];
        state.cardioLogs.push(cardioActivity);
        if (!state.workoutHistory) state.workoutHistory=[];
        state.workoutHistory.unshift({id:Date.now(),date:workoutDate,focus:`${type.charAt(0).toUpperCase()+type.slice(1)} Cardio`,duration:`${duration} min`,exercises:[{name:type.charAt(0).toUpperCase()+type.slice(1),sets:[{reps:duration,weight:distance}]}],category:'cardio',cardioData:cardioActivity});
        saveState(); closeCardioModal(); renderDashboard(); showToast('Cardio logged! üèÉ');
    }

    // ==========================================================================
    // HYDRATION LOGS
    // ==========================================================================
    function renderHydrationLogs() {
        const logs = Object.entries(state.hydrationLogs||{}).sort(([a],[b])=>b.localeCompare(a)).slice(0,30);
        const html = logs.length===0 ? '<p class="text-xs text-slate-400 text-center py-4">No hydration logs</p>' :
            logs.map(([date,ml])=>`<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl"><span class="text-sm font-bold">${new Date(date+'T00:00:00').toLocaleDateString()}</span><span class="text-sm text-cyan-600 font-bold">${ml}ml</span></div>`).join('');
        const list = document.getElementById('hydration-logs-list');
        if (list) list.innerHTML = html;
    }

    // ==========================================================================
    // EXERCISE DEMO
    // ==========================================================================
    const EXERCISE_DEMO_DB = {
        'Bench Press':      { video:'https://www.youtube.com/embed/rT7DgCr-3pg', instructions:['Lie flat on bench with feet firmly on floor','Grip bar slightly wider than shoulder width','Lower bar to mid-chest in controlled motion','Press bar up until arms fully extended','Keep shoulder blades retracted throughout'], muscles:['Chest','Triceps','Shoulders'], tips:['Keep your back slightly arched',"Don't bounce the bar off your chest",'Breathe in on descent, out on press'] },
        'Pull Ups':         { video:'https://www.youtube.com/embed/eGo4IYlbE5g', instructions:['Hang from bar with hands shoulder-width or wider','Pull body up until chin clears bar','Keep chest up and shoulders back','Lower with control to full extension','Avoid swinging or kipping'], muscles:['Lats','Biceps','Upper Back'], tips:['Lead with chest, not chin','Use resistance band for assistance if needed','Full dead hang at bottom'] },
        'Barbell Squat':    { video:'https://www.youtube.com/embed/ultWZbUMPL8', instructions:['Bar on upper back, feet shoulder-width','Chest up, core braced','Descend by pushing hips back and knees out','Go to parallel or slightly below','Drive through mid-foot to stand'], muscles:['Quads','Glutes','Hamstrings','Core'], tips:['Knees should track over toes','Keep heels down',"Don't round lower back"] },
        'Deadlift':         { video:'https://www.youtube.com/embed/op9kVnSso6Q', instructions:['Feet hip-width, bar over mid-foot','Grip bar just outside legs','Chest up, back straight, shoulders over bar','Drive through heels, extend hips and knees','Stand fully upright at top'], muscles:['Back','Glutes','Hamstrings','Core'], tips:['Keep bar close to body throughout',"Don't round your back",'Breathe and brace before each rep'] },
        'Overhead Press':   { video:'https://www.youtube.com/embed/QAQ64hK4Xxs', instructions:['Bar at shoulder height, grip shoulder-width','Brace core and glutes','Press bar straight up overhead','Move head back slightly as bar passes','Lock out arms at top'], muscles:['Shoulders','Triceps','Upper Chest'], tips:["Don't arch back excessively",'Press in straight line','Squeeze glutes to stay stable'] },
        'Hip Thrust':       { video:'https://www.youtube.com/embed/LM8XHLYJoYs', instructions:['Upper back on bench','Bar across hips','Feet flat on floor','Drive hips up','Squeeze glutes at top'], muscles:['Glutes','Hamstrings'], tips:['Best glute exercise','Use pad on bar','Full hip extension'] },
        'Lateral Raise':    { video:'https://www.youtube.com/embed/3VcKaXpzqRo', instructions:['Stand with dumbbells at sides','Raise arms out to sides to shoulder height','Lead with elbows, slight bend throughout','Lower with control','Keep torso still'], muscles:['Side Delts'], tips:["Don't swing or use momentum",'Thumbs slightly down at top','Control the descent'] },
        'Bicep Curl':       { video:'https://www.youtube.com/embed/kwG2ipFRgfo', instructions:['Stand with barbell or dumbbells','Keep elbows close to torso','Curl bar up toward shoulders','Squeeze biceps at top','Lower with control'], muscles:['Biceps','Forearms'], tips:["Don't swing or use back",'Keep elbows stationary','Full extension at bottom'] },
        'Tricep Pushdown':  { video:'https://www.youtube.com/embed/2-LAMcpzODU', instructions:['Stand facing cable machine','Grip bar with overhand grip','Elbows at sides','Push down until arms straight','Return with control'], muscles:['Triceps'], tips:['Keep elbows tucked','Full lockout',"Don't lean forward"] },
        'Leg Press':        { video:'https://www.youtube.com/embed/IZxyjW7MPJQ', instructions:['Sit in machine, feet shoulder-width','Release safety handles','Lower platform with control','Go until knees at 90 degrees','Press back up'], muscles:['Quads','Glutes','Hamstrings'], tips:["Don't lock knees",'Keep lower back on pad','Full range of motion'] },
        'Plank':            { video:'https://www.youtube.com/embed/ASdvN_XEl_c', instructions:['Start in push-up position on forearms','Keep body in straight line from head to heels','Engage core, glutes, and quads','Hold position','Breathe steadily'], muscles:['Core','Shoulders','Glutes'], tips:["Don't let hips sag or pike",'Breathe steadily','Start with 30 seconds'] },
        'Push Ups':         { video:'https://www.youtube.com/embed/IODxDxX7oi4', instructions:['Start in plank position, hands shoulder-width','Keep body in straight line','Lower chest to floor, elbows at 45 degrees','Push back up','Engage core throughout'], muscles:['Chest','Triceps','Core','Shoulders'], tips:["Don't let hips sag",'Full range of motion','Start with knees down if needed'] },
        'Romanian Deadlift':{ video:'https://www.youtube.com/embed/hNPvI7JNqKk', instructions:['Hold bar with shoulder-width grip','Keep slight knee bend','Hinge at hips, bar close to legs','Lower until hamstrings stretch','Drive hips forward to stand'], muscles:['Hamstrings','Glutes','Lower Back'], tips:['Feel stretch in hamstrings','Keep back flat',"Don't bend knees more"] },
        'Glute Bridge':     { video:'https://www.youtube.com/embed/wPM8icPu6H8', instructions:['Lie on your back, knees bent, feet flat','Arms at your sides','Drive through heels to lift hips','Squeeze glutes hard at the top','Lower hips back to floor and repeat'], muscles:['Glutes','Hamstrings','Core'], tips:['Can add weight on hips for progression','Hold at top for extra contraction',"Don't hyperextend your lower back"] },
        'Burpees':          { video:'https://www.youtube.com/embed/dZgVxmf6jkA', instructions:['Start standing, then squat down','Place hands on floor, jump feet back to plank','Perform a push-up','Jump feet forward to squat position','Explode up with arms overhead'], muscles:['Full Body','Cardio','Core'], tips:['One of best full-body exercises','Modify by stepping instead of jumping','Excellent for conditioning'] }
    };

    function showExerciseDemo(exerciseName) {
        let exercise = EXERCISE_DEMO_DB[exerciseName];
        if (!exercise) { const key = Object.keys(EXERCISE_DEMO_DB).find(k=>k.toLowerCase().includes(exerciseName.toLowerCase())||exerciseName.toLowerCase().includes(k.toLowerCase())); exercise=key?EXERCISE_DEMO_DB[key]:null; }
        document.getElementById('demo-exercise-name').textContent = exerciseName;
        const videoEl = document.getElementById('demo-video');
        if (videoEl) videoEl.src = exercise ? exercise.video+'?autoplay=0' : '';
        if (!exercise) {
            document.getElementById('demo-instructions').innerHTML = `<p class="text-slate-600">No demo available. Search YouTube for "${exerciseName}" for form tutorials.</p>`;
            document.getElementById('demo-muscles').innerHTML     = '<span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-bold">Various</span>';
            document.getElementById('demo-tips').innerHTML        = '<p class="text-slate-600">Focus on proper form and controlled movements.</p>';
        } else {
            document.getElementById('demo-instructions').innerHTML = exercise.instructions.map((inst,i)=>`<div class="flex gap-3"><span class="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-bold">${i+1}</span><p class="text-slate-700">${inst}</p></div>`).join('');
            document.getElementById('demo-muscles').innerHTML     = exercise.muscles.map(m=>`<span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold">${m}</span>`).join('');
            document.getElementById('demo-tips').innerHTML        = exercise.tips.map(tip=>`<div class="flex gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"></i><p class="text-slate-700">${tip}</p></div>`).join('');
        }
        document.getElementById('exercise-demo-modal').style.display='flex'; lucide.createIcons();
    }
    function closeExerciseDemo() { document.getElementById('exercise-demo-modal').style.display='none'; const v=document.getElementById('demo-video'); if(v) v.src=''; }

    // ==========================================================================
    // KEYBOARD SHORTCUTS
    // ==========================================================================
    document.addEventListener('keydown', function(e) {
        if (e.altKey) {
            switch(e.key) { case '1':switchTab('dashboard');break; case '2':switchTab('training');break; case '3':switchTab('nutrition');break; case '4':switchTab('logs');break; case '5':switchTab('metrics');break; case '6':switchTab('settings');break; }
        }
        if (e.key==='Escape') {
            document.querySelectorAll('.modal-overlay[style*="flex"]').forEach(modal=>{ modal.style.display='none'; });
            if(html5QrCode){html5QrCode.stop().catch(()=>{});html5QrCode=null;}
            const demoVideo=document.getElementById('demo-video'); if(demoVideo) demoVideo.src='';
        }
    });

    // ==========================================================================
    // MISC UTILITIES (kept from original)
    // ==========================================================================
    function addWater(ml) { if(!state.waterLogs)state.waterLogs={}; state.waterLogs[state.viewDate]=Math.max(0,(state.waterLogs[state.viewDate]||0)+ml); if(!state.hydrationLogs)state.hydrationLogs={}; state.hydrationLogs[state.viewDate]=state.waterLogs[state.viewDate]; saveState(); renderDashboard(); showToast(`${ml>0?'+':''}${ml}ml water logged`); }
    function addSteps(steps) { if(!state.stepsLogs)state.stepsLogs={}; state.stepsLogs[state.viewDate]=Math.max(0,(state.stepsLogs[state.viewDate]||0)+steps); saveState(); renderDashboard(); showToast(`${steps.toLocaleString()} steps logged`); }

    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================
    window.addEventListener('DOMContentLoaded', () => {
        // Init date pickers to today
        const today = new Date().toISOString().split('T')[0];
        ['workout-date-picker','nutrition-date-picker','metrics-date-picker'].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.value = today;
        });
        lucide.createIcons();
    });

    </script>
</body>
</html>
