<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Dashboard - Local Edition</title>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #22c55e;
            --success-hover: #16a34a;
            --warning: #eab308;
            --warning-hover: #ca8a04;
            --purple: #a855f7;
            --purple-hover: #9333ea;
            --danger: #ef4444;
            --bg: #f0f4f8;
            --text-dark: #111827;
            --text-gray: #4b5563;
            --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Segoe UI', 'Inter', system-ui, sans-serif; background-color: var(--bg); color: var(--text-dark); line-height: 1.6; }

        /* --- LAYOUT --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .hidden { display: none !important; }
        
        header { 
            background: var(--white); padding: 25px; border-radius: var(--radius); 
            box-shadow: var(--shadow); margin-bottom: 30px; 
            border-left: 6px solid var(--primary);
        }
        h1 { font-size: 2rem; font-weight: 800; margin-bottom: 10px; color: var(--text-dark); }
        h2 { margin-bottom: 15px; font-size: 1.5rem; }
        h3 { margin-bottom: 10px; font-size: 1.1rem; color: var(--text-gray); }

        .user-info { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; }
        .info-tag { 
            font-size: 0.9rem; background: #eef2ff; padding: 5px 12px; 
            border-radius: 20px; color: var(--text-gray); border: 1px solid #e0e7ff;
        }
        .info-tag span { font-weight: bold; color: var(--primary); }

        /* --- DASHBOARD GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        
        .btn-card { 
            padding: 25px; border: none; border-radius: var(--radius); color: white; font-size: 1.3rem; 
            font-weight: bold; cursor: pointer; transition: transform 0.2s, filter 0.2s;
            text-align: left; box-shadow: var(--shadow); display: flex; flex-direction: column;
            justify-content: space-between; min-height: 140px; position: relative; overflow: hidden;
        }
        .btn-card i { font-size: 2rem; margin-bottom: 10px; opacity: 0.8; }
        .btn-card:hover { transform: translateY(-3px); filter: brightness(110%); }
        .btn-card p { font-size: 0.85rem; font-weight: normal; opacity: 0.9; margin-top: auto; }

        /* Color Utilities */
        .bg-indigo { background: var(--primary); }
        .bg-green { background: var(--success); }
        .bg-yellow { background: var(--warning); }
        .bg-purple { background: var(--purple); }
        .bg-gray { background: #6b7280; }
        .bg-red { background: var(--danger); }

        /* --- FORMS & VIEWS --- */
        .view-card { background: var(--white); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .view-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #f3f4f6; padding-bottom: 15px; margin-bottom: 20px; 
        }
        
        .back-btn {
            background: #f3f4f6; border: none; padding: 8px 16px; border-radius: 8px;
            cursor: pointer; font-weight: 600; color: var(--text-gray); transition: background 0.2s;
        }
        .back-btn:hover { background: #e5e7eb; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; font-size: 0.9rem; color: var(--text-gray); margin-bottom: 5px; }
        
        input, select, textarea { 
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; 
            border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }

        .submit-btn { 
            width: 100%; padding: 15px; border-radius: 8px; border: none; color: white; 
            font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        /* --- CONFIG SECTION --- */
        .equipment-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .option-box { background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; }
        
        .checkbox-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; margin-bottom: 8px; cursor: pointer; }
        .checkbox-item input { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: var(--primary); }

        /* --- TRACKING UI --- */
        .set-row { 
            display: grid; grid-template-columns: 80px 1fr 1fr; gap: 10px; align-items: center; 
            margin-bottom: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .set-row span { font-weight: bold; color: var(--text-gray); font-size: 0.9rem; }
        .set-row input { padding: 8px; margin: 0; font-size: 0.9rem; }

        .logged-item { 
            border-left: 5px solid var(--success); background: #f0fdf4; padding: 15px; 
            border-radius: 8px; margin-bottom: 10px; border: 1px solid #dcfce7;
        }
        .logged-item strong { color: var(--text-dark); }
        .logged-item small { color: #6b7280; }

        /* --- MODALS --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content { 
            background: white; width: 95%; max-width: 600px; max-height: 85vh; 
            overflow-y: auto; border-radius: 20px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        /* --- MESSAGE BOX --- */
        #message-box {
            position: fixed; top: 20px; right: 20px; padding: 15px 25px; 
            border-radius: 8px; color: white; font-weight: bold; z-index: 1000;
            transition: opacity 0.3s, transform 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .grid { grid-template-columns: 1fr; }
            .set-row { grid-template-columns: 60px 1fr 1fr; gap: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="message-box" class="hidden"></div>

    <!-- MAIN DASHBOARD -->
    <div id="view-dashboard" class="view">
        <header>
            <h1><i class="fas fa-dumbbell" style="color: var(--primary);"></i> Integrated Fitness</h1>
            <div class="user-info">
                <div class="info-tag">Name: <span id="user-name-display">Guest User</span></div>
                <div class="info-tag">Gym: <span id="gym-name-display">Not Set</span></div>
            </div>
        </header>

        <div class="grid">
            <button class="btn-card bg-indigo" onclick="showView('gym-config')">
                <i class="fas fa-cogs"></i>
                <span>Configure Gym</span>
                <p id="gym-status">Loading items...</p>
            </button>
            <button class="btn-card bg-green" onclick="showView('plan-workout')">
                <i class="fas fa-running"></i>
                <span>Start Workout</span>
                <p>Plan & Track Session</p>
            </button>
            <button class="btn-card bg-yellow" onclick="showView('meal-log')">
                <i class="fas fa-utensils"></i>
                <span>Log Meal</span>
                <p>Track nutrition</p>
            </button>
            <button class="btn-card bg-purple" onclick="showView('body-metrics')">
                <i class="fas fa-weight"></i>
                <span>Body Metrics</span>
                <p>Log weight & progress</p>
            </button>
            <button class="btn-card bg-gray" onclick="openHistory()">
                <i class="fas fa-history"></i>
                <span>History</span>
                <p>View Charts & Logs</p>
            </button>
        </div>
        
        <div style="text-align: center; margin-top: 50px; opacity: 0.7;">
            <button onclick="resetAppData()" style="color: var(--danger); background: none; border: none; text-decoration: underline; cursor: pointer; font-size: 0.9rem;">
                <i class="fas fa-trash"></i> Reset All Local Data
            </button>
        </div>
    </div>

    <!-- GYM CONFIGURATION -->
    <div id="view-gym-config" class="view-card hidden">
        <div class="view-header">
            <h2>Gym Configuration</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>
        <form id="gym-setup-form">
            <div class="form-group">
                <label>Gym Name</label>
                <input type="text" id="gym-name-input" value="My Local Gym" placeholder="e.g. Garage Gym">
            </div>
            <div class="equipment-grid">
                <div class="option-box">
                    <h3><i class="fas fa-dumbbell"></i> Weights</h3>
                    <div id="weights-options"></div>
                </div>
                <div class="option-box">
                    <h3><i class="fas fa-bicycle"></i> Cardio</h3>
                    <div id="cardio-options"></div>
                </div>
                <div class="option-box">
                    <h3><i class="fas fa-child"></i> Floor/Other</h3>
                    <div id="floor-options"></div>
                </div>
            </div>
            <button type="submit" class="submit-btn bg-indigo">Save Configuration</button>
        </form>
    </div>

    <!-- MEAL LOG -->
    <div id="view-meal-log" class="view-card hidden">
        <div class="view-header">
            <h2>Log Meal</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>
        <form id="meal-form">
            <div class="form-group">
                <label>Meal Name</label>
                <input type="text" id="meal-name" placeholder="e.g. Breakfast Oatmeal" required>
            </div>
            <div class="form-group">
                <label>Details</label>
                <textarea id="meal-details" rows="3" placeholder="Calories, protein, macros..."></textarea>
            </div>
            <button type="submit" class="submit-btn bg-yellow">Log Meal</button>
        </form>
        <div id="todays-meals" style="margin-top: 30px;"></div>
    </div>

    <!-- PLAN WORKOUT -->
    <div id="view-plan-workout" class="view-card hidden">
        <div class="view-header">
            <h2>Workout Focus</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>
        <form id="plan-form">
            <div class="form-group">
                <label>Select Primary Focus</label>
                <select id="workout-focus"></select>
            </div>
            <button type="submit" class="submit-btn bg-green">Start Session</button>
        </form>
    </div>

    <!-- TRACK ACTIVE WORKOUT -->
    <div id="view-track-workout" class="view-card hidden">
        <div class="view-header">
            <div>
                <h2 id="active-workout-title">Active Session</h2>
                <small id="active-date" style="color: #6b7280;"></small>
            </div>
            <button class="back-btn" onclick="finishWorkout()">Finish & Save</button>
        </div>
        
        <div id="exercise-adder" class="option-box" style="margin-bottom: 25px; border-color: var(--primary);">
            <label>Add Exercise</label>
            <select id="exercise-select" style="margin-bottom: 10px;"></select>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="input-sets" value="3" placeholder="Sets" style="width: 80px;">
                <input type="number" id="input-reps" value="10" placeholder="Reps" style="width: 80px;">
                <button onclick="startTrackingExercise()" class="submit-btn bg-indigo" style="margin: 0; padding: 10px;">Add</button>
            </div>
        </div>

        <div id="active-sets-area"></div>
        
        <div style="margin-top: 30px; border-top: 2px solid #f3f4f6; padding-top: 20px;">
            <h3>Completed in this session:</h3>
            <div id="logged-exercises-list">
                <p style="color: #9ca3af; font-style: italic;">No exercises completed yet.</p>
            </div>
        </div>
    </div>

    <!-- BODY METRICS -->
    <div id="view-body-metrics" class="view-card hidden">
        <div class="view-header">
            <h2>Body Progress</h2>
            <button class="back-btn" onclick="showView('dashboard')">Back</button>
        </div>
        <form id="metrics-form" class="option-box">
            <div class="form-group">
                <label>Current Weight</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="metric-weight" step="0.1" placeholder="Weight (kg)">
                    <button type="submit" class="submit-btn bg-purple" style="margin: 0; width: auto; padding-left: 30px; padding-right: 30px;">Log</button>
                </div>
            </div>
        </form>
        <div id="metrics-history" style="margin-top: 20px;"></div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="view-header">
                <h2>History & Trends</h2>
                <button class="back-btn" onclick="closeModal()">Close</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <canvas id="historyChart" style="height: 250px; width: 100%;"></canvas>
            </div>

            <div style="max-height: 300px; overflow-y: auto;">
                <h3>Past Workouts</h3>
                <div id="history-list"></div>
            </div>
        </div>
    </div>

</div>

<script>
    /* --- DATA CONSTANTS --- */
    // Merged and cleaned up equipment list
    const EQUIPMENT_MAP = {
        weights: ["barbell", "dumbbell", "pinstack machines", "weighted machines", "cables machine", "smith machine", "back extension"],
        cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
        floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball", "floor"],
    };

    // Merged focus options
    const FOCUS_OPTIONS = ["Full Body", "Upper Body", "Lower Body", "Press", "Pull", "Squat", "Hinge", "Specific Muscles", "Cardio"];

    // Full Exercise Library
    const EXERCISE_LIBRARY = [
        { name: "Barbell Clean & Press", equipment: ["barbell"], focus: ["Full Body", "Press", "shoulders", "quads", "glutes"] },
        { name: "Dumbbell Thrusters", equipment: ["dumbbell"], focus: ["Full Body", "Squat", "Press", "shoulders", "quads"] },
        { name: "Sandbag Get-Ups", equipment: ["sandbag", "floor"], focus: ["Full Body", "abs", "shoulders"] },
        { name: "Medicine Ball Slams", equipment: ["medicine ball", "slam ball"], focus: ["Full Body", "abs"] },
        { name: "Barbell Bench Press", equipment: ["bench", "barbell"], focus: ["Upper Body", "Press", "chest", "triceps", "shoulders"] },
        { name: "Dumbbell Overhead Press", equipment: ["dumbbell"], focus: ["Upper Body", "Press", "shoulders", "triceps"] },
        { name: "Machine Chest Press", equipment: ["weighted machines", "pinstack machines"], focus: ["Upper Body", "Press", "chest", "triceps"] },
        { name: "Cable Crossover (High)", equipment: ["cables machine"], focus: ["Upper Body", "Press", "chest"] },
        { name: "Dumbbell Incline Press", equipment: ["bench", "dumbbell"], focus: ["Upper Body", "Press", "chest", "shoulders"] },
        { name: "Pinstack Shoulder Press", equipment: ["pinstack machines"], focus: ["Press", "shoulders", "triceps"] },
        { name: "Barbell Bent-Over Row", equipment: ["barbell"], focus: ["Upper Body", "Pull", "lats", "upper back", "biceps"] },
        { name: "Dumbbell Single-Arm Row", equipment: ["dumbbell", "bench"], focus: ["Upper Body", "Pull", "lats", "upper back"] },
        { name: "Cable Face Pulls", equipment: ["cables machine"], focus: ["Upper Body", "Pull", "upper back", "shoulders"] },
        { name: "Lat Pulldown (Machine)", equipment: ["pinstack machines"], focus: ["Upper Body", "Pull", "lats", "biceps"] },
        { name: "TRX Inverted Row", equipment: ["TRX"], focus: ["Upper Body", "Pull", "upper back", "biceps"] },
        { name: "Seated Cable Row", equipment: ["cables machine"], focus: ["Pull", "upper back", "lats", "biceps"] },
        { name: "Barbell Back Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes", "hamstrings"] },
        { name: "Barbell Front Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
        { name: "Dumbbell Split Squat", equipment: ["dumbbell"], focus: ["Lower Body", "Squat", "quads"] },
        { name: "Dumbbell Goblet Squat", equipment: ["dumbbell", "floor"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
        { name: "Leg Extension (Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Squat", "quads"] },
        { name: "Leg Press (Machine)", equipment: ["weighted machines"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
        { name: "Dumbbell Bulgarian Split Squat", equipment: ["dumbbell", "bench"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
        { name: "Dumbbell B stance Squat", equipment: ["dumbbell"], focus: ["Lower Body", "Squat", "glutes"] },
        { name: "Barbell Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes", "Full Body", "lats"] },
        { name: "Dumbbell Romanian Deadlift", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
        { name: "Barbell Romanian Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "Cable Pull-Through", equipment: ["cables machine"], focus: ["Lower Body", "Hinge", "glutes", "hamstrings"] },
        { name: "Leg Curl (Machine)", equipment: ["pinstack machines", "weighted machines"], focus: ["Lower Body", "hamstrings"] },
        { name: "Glute-Ham Raise (Floor)", equipment: ["floor"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
        { name: "Barbell Hip Thrusts", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "Smith Machine Reverse Lunges", equipment: ["smith machine"], focus: ["Lower Body", "Hinge", "glutes","quads"] },
        { name: "Dumbbell Reverse Lunges", equipment: ["dumbbell"], focus: ["Lower Body","Hinge", "glutes", "quads"] },
        { name: "Hip Thrusts (Plate Machine) ", equipment: ["weighted machines"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "Hip Thrusts (Pin Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "Single Leg Hip Thrusts (Dumbbell)", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "45 degree hip extenstions", equipment: ["back extension"], focus: ["Hinge", "glutes"] },
        { name: "Dumbbell Hammer Curl", equipment: ["dumbbell"], focus: ["biceps"] },
        { name: "Barbell Bicep Curl", equipment: ["barbell"], focus: ["biceps"] },
        { name: "Cable Rope Tricep Pushdown", equipment: ["cables machine"], focus: ["triceps"] },
        { name: "Dumbbell Skullcrushers", equipment: ["dumbbell", "bench"], focus: ["triceps"] },
        { name: "Dumbbell Lateral Raise", equipment: ["dumbbell"], focus: ["shoulders"] },
        { name: "Cable Rear Delt Fly", equipment: ["cables machine"], focus: ["shoulders", "upper back"] },
        { name: "Seated Machine Hip Abduction", equipment: ["weighted machines"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "Cable Machine Single Leg Abduction", equipment: ["cables machine"], focus: ["Lower Body", "Hinge", "glutes"] },
        { name: "Hanging Leg Raise", equipment: ["floor"], focus: ["abs"] },
        { name: "Weighted Machine Crunch", equipment: ["weighted machines"], focus: ["abs"] },
        { name: "Dumbbell Calf Raise", equipment: ["dumbbell"], focus: ["calves"] },
        { name: "Hyperextension (Floor)", equipment: ["floor"], focus: ["hamstrings", "glutes"] },
        { name: "Treadmill 5K Run", equipment: ["treadmill"], focus: ["Cardio", "Full Body"] },
        { name: "Rower 2000m Sprint", equipment: ["rower"], focus: ["Cardio", "Full Body"] },
        { name: "Assault Bike Interval", equipment: ["assault bike"], focus: ["Cardio", "Full Body"] },
        { name: "Cross Trainer Endurance", equipment: ["cross trainer"], focus: ["Cardio", "Full Body"] },
        { name: "Ski Erg 10 Minute Challenge", equipment: ["ski erg"], focus: ["Cardio", "Full Body", "Upper Body", "Pull"] },
        { name: "Step Machine Climb", equipment: ["step machine"], focus: ["Cardio", "Lower Body"] },
    ];

    /* --- APP STATE & LOCAL STORAGE --- */
    let state = JSON.parse(localStorage.getItem('fitnessAppState')) || {
        userName: "Local User",
        goal: "Maintenance",
        gymName: "My Gym",
        // Default to a basic setup if first time
        gymSetup: { weights: ["dumbbell"], cardio: ["treadmill"], floor: ["floor"] },
        workoutLog: [],
        mealLog: [],
        metrics: [],
        exerciseHistory: {} // Stores max weight for specific exercises
    };

    let currentSession = null;
    let chartInstance = null;

    /* --- NAVIGATION --- */
    function showView(viewId) {
        document.querySelectorAll('.view, .view-card').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${viewId}`).classList.remove('hidden');
        window.scrollTo(0,0);
        
        if(viewId === 'gym-config') renderGymConfig();
        if(viewId === 'plan-workout') renderWorkoutPlanner();
        if(viewId === 'meal-log') renderMeals();
        if(viewId === 'body-metrics') renderMetrics();
    }

    function saveState() {
        localStorage.setItem('fitnessAppState', JSON.stringify(state));
        updateDashboardUI();
    }

    function showMsg(text, type='success') {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
        box.classList.remove('hidden');
        box.style.opacity = '1';
        setTimeout(() => {
            box.style.opacity = '0';
            setTimeout(() => box.classList.add('hidden'), 300);
        }, 3000);
    }

    /* --- GYM CONFIGURATION --- */
    function renderGymConfig() {
        const renderOpts = (id, key) => {
            const container = document.getElementById(id);
            container.innerHTML = EQUIPMENT_MAP[key].map(item => `
                <label class="checkbox-item">
                    <input type="checkbox" name="${key}" value="${item}" 
                    ${state.gymSetup[key].includes(item) ? 'checked' : ''}>
                    ${item.charAt(0).toUpperCase() + item.slice(1)}
                </label>
            `).join('');
        };
        renderOpts('weights-options', 'weights');
        renderOpts('cardio-options', 'cardio');
        renderOpts('floor-options', 'floor');
        document.getElementById('gym-name-input').value = state.gymName;
    }

    document.getElementById('gym-setup-form').onsubmit = (e) => {
        e.preventDefault();
        state.gymName = document.getElementById('gym-name-input').value || "My Gym";
        ['weights', 'cardio', 'floor'].forEach(key => {
            const checked = Array.from(document.querySelectorAll(`input[name="${key}"]:checked`));
            state.gymSetup[key] = checked.map(i => i.value);
        });
        saveState();
        showMsg("Configuration Saved!");
        showView('dashboard');
    };

    /* --- MEALS --- */
    document.getElementById('meal-form').onsubmit = (e) => {
        e.preventDefault();
        const meal = {
            name: document.getElementById('meal-name').value,
            details: document.getElementById('meal-details').value,
            date: new Date().toLocaleDateString()
        };
        state.mealLog.push(meal);
        saveState();
        renderMeals();
        e.target.reset();
        showMsg("Meal Logged!");
    };

    function renderMeals() {
        const container = document.getElementById('todays-meals');
        const today = new Date().toLocaleDateString();
        const meals = state.mealLog.filter(m => m.date === today);
        
        if (meals.length === 0) {
            container.innerHTML = `<p style="color:var(--text-gray); font-style:italic;">No meals logged today.</p>`;
            return;
        }

        container.innerHTML = `<h3>Today's Meals</h3>` + meals.map(m => `
            <div class="logged-item" style="border-left-color: var(--warning)">
                <strong>${m.name}</strong><br><small>${m.details}</small>
            </div>
        `).join('');
    }

    /* --- WORKOUT PLANNER --- */
    function renderWorkoutPlanner() {
        const sel = document.getElementById('workout-focus');
        sel.innerHTML = FOCUS_OPTIONS.map(f => `<option value="${f}">${f}</option>`).join('');
    }

    document.getElementById('plan-form').onsubmit = (e) => {
        e.preventDefault();
        const focus = document.getElementById('workout-focus').value;
        const now = new Date();
        
        currentSession = { 
            title: focus, 
            date: now.toISOString(), 
            displayDate: now.toLocaleString(),
            exercises: [] 
        };
        
        // Filter exercises based on configured equipment
        const myEquip = [...state.gymSetup.weights, ...state.gymSetup.cardio, ...state.gymSetup.floor];
        
        // Logic: exercise is available if ALL its equipment requirements are in myEquip
        // OR if it has multiple options and we have at least one (simplified here to: if any equipment matches)
        const filtered = EXERCISE_LIBRARY.filter(ex => {
            // Check if user has at least one of the required pieces of equipment for this exercise
            // Note: EXERCISE_LIBRARY defines 'equipment' array as alternatives usually, or specific needs.
            // Simplified logic: If exercise needs 'barbell', user must have 'barbell'.
            return ex.equipment.some(req => myEquip.includes(req));
        });

        // Further sort by focus if possible, but for now just show all valid equipment exercises
        // To make it better, we put matching focus at top
        filtered.sort((a, b) => {
            const aMatch = a.focus.includes(focus) ? 1 : 0;
            const bMatch = b.focus.includes(focus) ? 1 : 0;
            return bMatch - aMatch;
        });
        
        const select = document.getElementById('exercise-select');
        select.innerHTML = filtered.map(ex => {
            const isFocus = ex.focus.includes(focus) ? "â˜… " : "";
            return `<option value="${ex.name}">${isFocus}${ex.name}</option>`
        }).join('');

        document.getElementById('active-workout-title').textContent = focus + " Session";
        document.getElementById('active-date').textContent = currentSession.displayDate;
        
        // Clear previous session UI
        document.getElementById('active-sets-area').innerHTML = "";
        document.getElementById('logged-exercises-list').innerHTML = "<p style='color: #9ca3af;'>No exercises completed yet.</p>";

        showView('track-workout');
    };

    /* --- TRACKING --- */
    function startTrackingExercise() {
        const name = document.getElementById('exercise-select').value;
        if (!name) return;

        const setsCount = parseInt(document.getElementById('input-sets').value) || 3;
        const repsCount = parseInt(document.getElementById('input-reps').value) || 10;

        let html = `
            <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px;">
            <h4><i class="fas fa-running"></i> ${name}</h4>
            <div style="margin-top:10px;">
        `;
        
        for(let i=1; i<=setsCount; i++) {
            html += `
                <div class="set-row" data-ex="${name}">
                    <span>Set ${i}</span>
                    <input type="number" class="set-reps" value="${repsCount}" placeholder="Reps">
                    <input type="number" class="set-weight" placeholder="kg">
                </div>
            `;
        }
        
        html += `
            </div>
            <button onclick="logExerciseToSession('${name}')" class="submit-btn bg-indigo" style="margin-top:10px;">
                Complete & Save ${name}
            </button>
            <button onclick="document.getElementById('active-sets-area').innerHTML=''" class="submit-btn bg-red" style="margin-top:5px; background:white; color:var(--danger); border:1px solid var(--danger);">
                Cancel
            </button>
            </div>
        `;
        document.getElementById('active-sets-area').innerHTML = html;
        // Scroll to area
        document.getElementById('active-sets-area').scrollIntoView({behavior: 'smooth'});
    }

    function logExerciseToSession(name) {
        const rows = document.querySelectorAll(`.set-row[data-ex="${name}"]`);
        const setsData = Array.from(rows).map(r => ({
            reps: parseFloat(r.querySelector('.set-reps').value) || 0,
            weight: parseFloat(r.querySelector('.set-weight').value) || 0
        }));

        currentSession.exercises.push({ name, sets: setsData });
        
        // Update Personal Bests
        const maxW = Math.max(...setsData.map(s => s.weight));
        if(!state.exerciseHistory[name] || maxW > state.exerciseHistory[name]) {
            state.exerciseHistory[name] = maxW;
        }

        document.getElementById('active-sets-area').innerHTML = "";
        renderLoggedSessionList();
        showMsg(`${name} Saved`);
    }

    function renderLoggedSessionList() {
        if(currentSession.exercises.length === 0) return;
        
        document.getElementById('logged-exercises-list').innerHTML = currentSession.exercises.map(ex => {
            const bestSet = Math.max(...ex.sets.map(s => s.weight));
            return `<div class="logged-item">
                <strong>${ex.name}</strong>
                <br><small>${ex.sets.length} sets completed. Max: ${bestSet}kg</small>
            </div>`
        }).join('');
    }

    function finishWorkout() {
        if(!currentSession || currentSession.exercises.length === 0) {
            if(confirm("No exercises logged. Discard session?")) {
                showView('dashboard');
            }
            return;
        }
        
        state.workoutLog.push(currentSession);
        saveState();
        showMsg("Workout Saved to History!");
        currentSession = null;
        showView('dashboard');
    }

    /* --- METRICS --- */
    document.getElementById('metrics-form').onsubmit = (e) => {
        e.preventDefault();
        const weight = document.getElementById('metric-weight').value;
        if(!weight) return;
        state.metrics.push({ weight: parseFloat(weight), date: new Date().toLocaleDateString() });
        saveState();
        renderMetrics();
        e.target.reset();
        showMsg("Weight Logged");
    };

    function renderMetrics() {
        const container = document.getElementById('metrics-history');
        if(state.metrics.length === 0) {
            container.innerHTML = "<p>No metrics logged yet.</p>";
            return;
        }
        container.innerHTML = state.metrics.slice().reverse().map(m => `
            <div class="logged-item" style="border-left-color: var(--purple)">
                <strong>${m.weight} kg</strong> - ${m.date}
            </div>
        `).join('');
    }

    /* --- HISTORY & CHART --- */
    function openHistory() {
        document.getElementById('history-modal').classList.remove('hidden');
        renderHistoryList();
        renderChart();
    }

    function closeModal() {
        document.getElementById('history-modal').classList.add('hidden');
    }

    function renderHistoryList() {
        const list = document.getElementById('history-list');
        if(state.workoutLog.length === 0) {
            list.innerHTML = "<p>No workouts recorded yet.</p>";
            return;
        }
        list.innerHTML = state.workoutLog.slice().reverse().map((w, idx) => `
            <div class="logged-item" style="background: #f9fafb; border-left-color: var(--primary);">
                <strong>${w.title}</strong>
                <span style="float:right; font-size:0.8rem; color:#6b7280;">${new Date(w.date).toLocaleDateString()}</span>
                <br><small>${w.exercises.length} Exercises: ${w.exercises.map(e => e.name).join(', ')}</small>
            </div>
        `).join('');
    }

    function renderChart() {
        const ctx = document.getElementById('historyChart').getContext('2d');
        
        // Destroy prev instance
        if(chartInstance) chartInstance.destroy();

        // Prepare data: Let's graph Weight metrics if exist, else workouts per week
        let chartData, chartLabels, chartLabel;

        if (state.metrics.length > 1) {
            // Sort by date usually implied by push order but let's be safe if we had true dates
            // Here just take last 10
            const recent = state.metrics.slice(-10);
            chartLabels = recent.map(m => m.date.slice(0, 5)); // DD/MM
            chartData = recent.map(m => m.weight);
            chartLabel = 'Body Weight (kg)';
        } else {
            // Graph workout frequency or dummy data
            // Let's do a simple bar of workouts stored
            chartLabels = state.workoutLog.map(w => new Date(w.date).toLocaleDateString().slice(0,5));
            chartData = state.workoutLog.map(w => w.exercises.length);
            chartLabel = 'Exercises per Session';
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: chartLabel,
                    data: chartData,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    }

    /* --- INITIALIZATION --- */
    function updateDashboardUI() {
        document.getElementById('user-name-display').textContent = state.userName;
        document.getElementById('gym-name-display').textContent = state.gymName;
        
        const count = state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length;
        document.getElementById('gym-status').textContent = `${count} equipment items available`;
    }

    function resetAppData() {
        if(confirm("Are you sure? This will delete all logs and settings permanently.")) {
            localStorage.removeItem('fitnessAppState');
            location.reload();
        }
    }

    window.onload = () => {
        updateDashboardUI();
        // Check if gym setup is empty (new user)
        if(state.gymSetup.weights.length === 1 && state.gymSetup.weights[0] === 'dumbbell' 
           && state.gymSetup.cardio.length === 1) {
            // Maybe prompt to setup gym, or just let them explore
        }
    };
</script>

</body>
</html>

