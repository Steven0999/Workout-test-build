<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FitTrack Pro - Complete fitness tracking app with cloud sync">
    <meta name="theme-color" content="#4f46e5">
    <title>FitTrack Pro - Your Complete Fitness Companion</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí™</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #f43f5e;
            --bg-main: #f8fafc;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .photo-slot {
            aspect-ratio: 3/4;
            background: #f1f5f9;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            border: 2px dashed #e2e8f0;
            position: relative;
            transition: all 0.2s;
            min-height: 120px;
        }
        
        .photo-slot:hover { border-color: var(--brand-primary); transform: scale(1.02); }
        .photo-slot:active { transform: scale(0.98); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-overlay > div {
            width: 100%;
            max-width: 32rem;
            margin: auto;
        }

        .store-dropdown { animation: dropdownPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropdownPop {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 90%;
            text-align: center;
            word-wrap: break-word;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        button { 
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.97); }

        input, select {
            min-height: 48px;
            font-size: 16px;
        }

        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .translate-x-0 { transform: translateX(0); }
        .-translate-x-full { transform: translateX(-100%); }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin { animation: spin 1s linear infinite; }

        /* Auth screens */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #app-screen { display: none; }

        .input-group { position: relative; }
        .input-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }
        .input-group input { padding-left: 3rem; }

        @media (max-width: 640px) {
            main { padding: 0.75rem !important; }
            .space-y-6 > * + * { margin-top: 1rem !important; }
            .glass-card { padding: 1rem !important; }

            .text-5xl { font-size: 2.25rem !important; line-height: 1.2; }
            .text-4xl { font-size: 1.875rem !important; line-height: 1.2; }
            .text-3xl { font-size: 1.5rem !important; line-height: 1.3; }
            .text-2xl { font-size: 1.25rem !important; }
            .text-xl { font-size: 1.125rem !important; }

            .modal-overlay > div {
                border-radius: 1.5rem !important;
                padding: 1.25rem !important;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
            
            button { min-height: 48px !important; }
            input, select { min-height: 52px !important; font-size: 16px !important; }
        }

        .muscle-chip.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .flex-1 { flex: 1 1 0%; min-width: 0; }

        header { padding: 1rem 1.25rem; }
        @media (max-width: 640px) { header { padding: 0.875rem 1rem; } }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ========================================== -->
    <!-- AUTH SCREEN -->
    <!-- ========================================== -->
    <div id="auth-screen">
        <div class="w-full max-w-md px-4">
            <div class="bg-white rounded-[3rem] p-8 shadow-2xl">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üí™</div>
                    <h1 class="text-3xl font-black text-indigo-600 mb-2">FitTrack<span class="text-slate-600">Pro</span></h1>
                    <p class="text-slate-500 text-sm">Your complete fitness companion</p>
                </div>

                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="login-password" placeholder="Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="loginUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Sign In
                        </button>
                        <button onclick="showForgotPassword()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Forgot Password?
                        </button>
                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Don't have an account?</p>
                            <button onclick="showRegister()" class="text-indigo-600 font-bold hover:text-indigo-700">Create Account</button>
                        </div>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <input type="text" id="register-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="register-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-password" placeholder="Password (min 6 characters)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <div class="input-group">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <input type="password" id="register-confirm" placeholder="Confirm Password" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="registerUser()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Create Account
                        </button>
                        <div class="text-center pt-4 border-t border-slate-100">
                            <p class="text-sm text-slate-500 mb-3">Already have an account?</p>
                            <button onclick="showLogin()" class="text-indigo-600 font-bold hover:text-indigo-700">Sign In</button>
                        </div>
                    </div>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgot-password-form" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Reset Password</h2>
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600 text-center mb-4">Enter your email and we'll send you a reset link</p>
                        <div class="input-group">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                            <input type="email" id="forgot-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-medium">
                        </div>
                        <button onclick="resetPassword()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all">
                            Send Reset Link
                        </button>
                        <button onclick="showLogin()" class="w-full text-sm text-indigo-600 font-medium hover:text-indigo-700">
                            Back to Login
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-center text-white text-xs mt-6 opacity-75">
                By continuing, you agree to our Terms of Service and Privacy Policy
            </p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MAIN APP SCREEN -->
    <!-- ========================================== -->
    <div id="app-screen">

        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-4 sm:px-6 py-4 sm:py-5 sticky top-0 z-40 flex justify-between items-center">
            <button onclick="toggleSidebar()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Menu">
                <i data-lucide="menu" class="w-6 h-6 text-slate-700"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">FitTrack<span class="text-slate-600">Pro</span></h1>
                <div class="flex items-center gap-2 justify-center">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p id="status-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Loading...</p>
                </div>
            </div>
            <button onclick="switchTab('profile')" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Profile">
                <i data-lucide="user" class="w-6 h-6 text-slate-700"></i>
            </button>
        </header>

        <main class="max-w-xl mx-auto p-4 sm:p-6 space-y-6">

            <!-- ============================== -->
            <!-- DASHBOARD TAB -->
            <!-- ============================== -->
            <section id="dashboard" class="tab-content active space-y-6">
                <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center relative overflow-hidden">
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 192 192">
                            <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                            <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                        </svg>
                        <div class="absolute text-center">
                            <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Eaten</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                        <div class="text-center"><div id="dash-protein" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Protein</div></div>
                        <div class="text-center border-x"><div id="dash-carbs" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Carbs</div></div>
                        <div class="text-center"><div id="dash-fat" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Fats</div></div>
                    </div>
                </div>

                <!-- Hydration Tracker -->
                <div id="hydration-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="droplet" class="text-cyan-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Hydration Goal</h4>
                                <p id="water-count" class="text-xs text-slate-500">0 / 2.5L</p>
                            </div>
                        </div>
                        <button onclick="toggleHydrationGoal()" id="hydration-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click ‚úì when you reach your daily goal</div>
                </div>

                <!-- Steps Tracker -->
                <div id="steps-tracker" class="glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="footprints" class="text-amber-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Steps Goal</h4>
                                <p id="steps-count" class="text-xs text-slate-500">0 / 10,000</p>
                            </div>
                        </div>
                        <button onclick="toggleStepsGoal()" id="steps-check" class="w-16 h-16 rounded-2xl border-4 border-slate-200 flex items-center justify-center hover:bg-slate-50 active:scale-95 transition-all">
                            <i data-lucide="check" class="w-8 h-8 text-transparent"></i>
                        </button>
                    </div>
                    <div class="text-xs text-slate-400 text-center">Click ‚úì when you reach your daily goal</div>
                </div>

                <!-- Habits Tracker (hidden if not enabled) -->
                <div id="habits-tracker" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center">
                                <i data-lucide="check-circle" class="text-purple-500"></i>
                            </div>
                            <h3 class="font-bold text-lg">Daily Habits</h3>
                        </div>
                    </div>
                    <div id="dashboard-habits-list" class="space-y-3"></div>
                </div>

                <!-- Weekly Overview -->
                <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-xl">
                    <h3 class="text-lg font-bold mb-1">Weekly Overview</h3>
                    <div id="muscle-volume-stats" class="grid grid-cols-2 gap-y-3 gap-x-6 mb-6"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="switchTab('training')" class="bg-indigo-600 px-4 py-3 rounded-2xl font-bold text-xs uppercase hover:bg-indigo-700">Log Workout</button>
                        <button onclick="switchTab('nutrition')" class="bg-emerald-600 px-4 py-3 rounded-2xl font-bold text-xs uppercase hover:bg-emerald-700">Add Food</button>
                    </div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- PROFILE TAB -->
            <!-- ============================== -->
            <section id="profile" class="tab-content space-y-6">
                <div class="glass-card p-8 rounded-[3rem] text-center">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="user" class="w-12 h-12 text-indigo-600"></i>
                    </div>
                    <h2 id="profile-name" class="text-2xl font-black mb-2">User Name</h2>
                    <p id="profile-email" class="text-sm text-slate-500 mb-6">user@example.com</p>

                    <div class="space-y-3">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Member Since</p>
                            <p id="profile-created" class="font-bold">Loading...</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Total Workouts</p>
                            <p id="profile-workouts" class="font-bold">0</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-xs text-slate-400 uppercase mb-1">Account Status</p>
                            <p class="font-bold text-emerald-600">‚úì Active (Cloud Sync)</p>
                        </div>
                    </div>

                    <button onclick="syncToCloud()" class="w-full mt-4 bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">
                        ‚òÅÔ∏è Sync to Cloud
                    </button>

                    <button onclick="logoutUser()" class="w-full mt-3 bg-red-500 text-white p-4 rounded-2xl font-bold hover:bg-red-600">
                        Sign Out
                    </button>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">App Settings</h3>
                    <button onclick="switchTab('settings')" class="w-full bg-slate-100 p-4 rounded-xl font-medium text-left flex items-center justify-between">
                        <span>Preferences & Goals</span>
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- TRAINING TAB -->
            <!-- ============================== -->
            <section id="training" class="tab-content space-y-6">
                <!-- Date Selector -->
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeWorkoutDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="workout-date-picker" onchange="selectWorkoutDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeWorkoutDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="workout-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Finish Workout" to confirm</p>
                    </div>
                </div>

                <!-- Workout Setup -->
                <div id="workout-setup" class="glass-card p-6 rounded-[2.5rem] space-y-4">
                    <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                        <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Gym</button>
                        <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-slate-400">Home</button>
                    </div>
                    
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Exercise Focus</label>
                        <select id="workout-focus" onchange="toggleSpecificMuscle()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Full Body</option>
                            <option>Upper</option>
                            <option>Lower</option>
                            <option>Push</option>
                            <option>Pull</option>
                            <option>Legs</option>
                            <option>Specific Muscle</option>
                        </select>
                    </div>

                    <div id="specific-muscle-container" class="hidden">
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Muscle</label>
                        <select id="specific-muscle" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option>Chest</option>
                            <option>Back</option>
                            <option>Shoulders</option>
                            <option>Biceps</option>
                            <option>Triceps</option>
                            <option>Quads</option>
                            <option>Hamstrings</option>
                            <option>Glutes</option>
                            <option>Calves</option>
                        </select>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Cardio</span>
                            <input type="checkbox" id="add-cardio-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-black uppercase text-slate-600">Add Core</span>
                            <input type="checkbox" id="add-core-check" class="w-5 h-5 accent-indigo-600">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="startWorkout('manual')" class="p-5 bg-slate-900 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-slate-800 active:bg-slate-700">Manual Entry</button>
                        <button onclick="startWorkout('ai')" class="p-5 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-indigo-700 active:bg-indigo-800">AI Generate</button>
                    </div>
                    
                    <button onclick="openCardioModal()" class="w-full mt-3 p-5 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-[1.5rem] font-bold text-base flex items-center justify-center gap-2 hover:from-cyan-600 hover:to-blue-600">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                        Log Outdoor Cardio
                    </button>
                </div>

                <!-- Active Workout -->
                <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div>
                            <h3 id="active-workout-title" class="text-xl font-black">Workout</h3>
                            <p id="workout-timer" class="text-indigo-600 font-bold">00:00:00</p>
                        </div>
                        <button onclick="cancelWorkout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl text-xl font-bold">√ó</button>
                    </div>
                    <div id="exercise-list" class="space-y-4 mb-6"></div>
                    <button onclick="addExercise()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs mb-4 hover:border-indigo-400 hover:text-indigo-500">+ Add Exercise</button>
                    <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold hover:bg-slate-800">Finish Workout</button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- NUTRITION TAB -->
            <!-- ============================== -->
            <section id="nutrition" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setNutritionTab('diary')" id="nut-tab-diary" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Diary</button>
                    <button onclick="setNutritionTab('search')" id="nut-tab-search" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Search</button>
                </div>

                <!-- DIARY VIEW -->
                <div id="nut-view-diary" class="space-y-6">
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex items-center justify-between gap-3">
                            <button onclick="changeNutritionDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <div class="flex-1">
                                <input type="date" id="nutrition-date-picker" onchange="selectNutritionDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                            </div>
                            <button onclick="changeNutritionDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div id="nutrition-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                            <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Save Changes" to confirm</p>
                        </div>
                    </div>

                    <div id="nutrition-save-buttons" class="hidden flex gap-3">
                        <button onclick="saveNutritionChanges()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700">Save Changes</button>
                        <button onclick="cancelNutritionChanges()" class="flex-1 py-4 bg-slate-200 text-slate-700 rounded-2xl font-bold hover:bg-slate-300">Cancel</button>
                    </div>

                    <div class="bg-white rounded-[32px] p-8 border border-slate-100 shadow-xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <div id="total-kcal" class="text-5xl font-black text-slate-900 mb-1">0</div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Calories Today</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black text-blue-600 flex items-center gap-1 justify-end">
                                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i> <span id="total-protein">0.0</span>g
                                </div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Protein</div>
                            </div>
                        </div>
                    </div>

                    <div id="meal-sections"></div>

                    <div class="text-center py-4 px-6 bg-indigo-50 rounded-2xl border border-indigo-100 mt-6">
                        <div class="flex items-center justify-center gap-2 mb-1">
                            <i data-lucide="clock" class="w-4 h-4 text-indigo-600"></i>
                            <p class="text-sm font-bold text-indigo-900">Auto-Save Enabled</p>
                        </div>
                        <p class="text-xs text-indigo-600">Your daily meals are automatically saved at midnight</p>
                    </div>
                </div>

                <!-- SEARCH VIEW -->
                <div id="nut-view-search" class="hidden space-y-6">
                    <div>
                        <label class="text-xs font-semibold text-slate-400 ml-1 mb-2 block">Store / Restaurant</label>
                        <div class="relative">
                            <input 
                                id="store-search-input" 
                                type="text" 
                                placeholder="Search stores or restaurants..." 
                                class="w-full p-4 bg-white rounded-3xl border border-slate-100 font-medium outline-none"
                                onfocus="showStoreDropdown()"
                                oninput="filterStoreDropdown(this.value)"
                                autocomplete="off">
                            <div id="store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto store-dropdown"></div>
                        </div>
                        <input type="hidden" id="store-select" value="all">
                    </div>

                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                            <input id="food-search-input" type="text" placeholder="Search food..." 
                                class="w-full bg-slate-100 border-2 border-transparent rounded-[20px] py-4 pl-12 pr-4 focus:bg-white focus:border-emerald-500 outline-none font-semibold">
                        </div>
                        <button onclick="openBarcodeScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:bg-indigo-700">
                            <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <button onclick="openCreateMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700">
                        Create Meal
                    </button>

                    <div id="created-meals-list" class="space-y-3"></div>

                    <div id="search-loading" class="hidden py-20 text-center">
                        <i data-lucide="loader-2" class="animate-spin text-emerald-500 mx-auto w-8 h-8"></i>
                    </div>
                    <div id="search-results-list" class="space-y-3"></div>
                    
                    <div class="text-center py-4">
                        <p class="text-xs text-slate-400 mb-3">Can't find what you're looking for?</p>
                        <button onclick="openManualFoodEntry()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-slate-800 transition-all">
                            + Add Food Manually
                        </button>
                    </div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- LOGS TAB -->
            <!-- ============================== -->
            <section id="logs" class="tab-content space-y-6">
                <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                    <button onclick="setLogsTab('training')" id="logs-tab-training" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Training</button>
                    <button onclick="setLogsTab('nutrition')" id="logs-tab-nutrition" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Nutrition</button>
                </div>
                
                <div id="logs-training-view" class="space-y-4">
                    <div class="glass-card p-4 rounded-2xl">
                        <p class="text-xs font-black uppercase text-slate-400 mb-3">Filter Workouts</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-weights" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üí™ Weights</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-cardio" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üèÉ Cardio</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-core" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üéØ Core</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <input type="checkbox" id="filter-walking" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-bold">üö∂ Walking</span>
                            </label>
                        </div>
                    </div>
                    <div id="training-logs-list"></div>
                </div>

                <div id="logs-nutrition-view" class="hidden space-y-4">
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                            <i data-lucide="droplet" class="w-5 h-5 text-cyan-500"></i>
                            Hydration History
                        </h3>
                        <div id="hydration-logs-list" class="space-y-2"></div>
                    </div>
                    <div id="nutrition-logs-list"></div>
                </div>
            </section>

            <!-- ============================== -->
            <!-- METRICS TAB -->
            <!-- ============================== -->
            <section id="metrics" class="tab-content space-y-6">
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeMetricsDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="metrics-date-picker" onchange="selectMetricsDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeMetricsDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="metrics-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Recording for past date - Click "Save Metrics" to confirm</p>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-[3rem] space-y-8">
                    <div class="bg-slate-50 p-6 rounded-3xl text-center border">
                        <span class="text-[10px] font-black uppercase text-slate-400 block mb-2">Weight (kg)</span>
                        <input id="metric-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-transparent text-center text-5xl font-black outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Chest (cm)</label>
                            <input id="metric-chest" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Shoulders (cm)</label>
                            <input id="metric-shoulders" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Arms (cm)</label>
                            <input id="metric-arms" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Waist (cm)</label>
                            <input id="metric-waist" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Legs (cm)</label>
                            <input id="metric-legs" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <label class="text-[9px] font-black text-slate-400 block uppercase">Glutes (cm)</label>
                            <input id="metric-glutes" type="number" class="w-full bg-transparent font-bold outline-none">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 text-center">Progress Photos</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="photo-slot" onclick="triggerPhotoUpload('front')">
                                <img id="photo-front-preview" class="hidden" alt="Front">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Front</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('side')">
                                <img id="photo-side-preview" class="hidden" alt="Side">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Side</span>
                            </div>
                            <div class="photo-slot" onclick="triggerPhotoUpload('back')">
                                <img id="photo-back-preview" class="hidden" alt="Back">
                                <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                                <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Back</span>
                            </div>
                        </div>
                        <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                    </div>

                    <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase hover:bg-rose-600">
                        Save Metrics
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openMetricsChart()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                        <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="line-chart" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">Progress Charts</h4>
                        <p class="text-xs text-slate-400">View trends</p>
                    </button>
                    <button onclick="openPhotoComparison()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                        <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="images" class="w-6 h-6 text-emerald-600"></i>
                        </div>
                        <h4 class="font-bold text-sm mb-1">Compare Photos</h4>
                        <p class="text-xs text-slate-400">Side by side</p>
                    </button>
                </div>
            </section>

            <!-- ============================== -->
            <!-- SETTINGS TAB -->
            <!-- ============================== -->
            <section id="settings" class="tab-content space-y-6">
                <div class="glass-card p-6 rounded-[2.5rem] space-y-8">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Calorie Goal</label>
                        <input id="calorie-goal-input" type="number" value="2500" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none" onchange="updateCalorieGoal(this.value)">
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Gym Equipment</h3>
                        <div id="gym-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Home Equipment</h3>
                        <div id="home-equipment-list" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[11px] font-black uppercase text-slate-400">Daily Habits</h3>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="habits-enabled" onchange="toggleHabits()" class="w-5 h-5 accent-indigo-600">
                                <span class="text-xs font-bold text-slate-600">Enable</span>
                            </label>
                        </div>
                        <div id="habits-section" class="hidden space-y-3">
                            <div class="flex gap-2">
                                <input id="new-habit-input" type="text" placeholder="Add a new habit..." class="flex-1 p-3 bg-slate-50 rounded-xl outline-none">
                                <button onclick="addHabit()" class="px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Add</button>
                            </div>
                            <div id="habits-list" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-6">
                        <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Tracking Options</h3>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Track Hydration</p>
                                    <p class="text-xs text-slate-500">Log daily water intake</p>
                                </div>
                                <input type="checkbox" id="track-hydration" onchange="toggleTracking('hydration')" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                            <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                                <div>
                                    <p class="font-bold text-sm">Track Steps</p>
                                    <p class="text-xs text-slate-500">Count daily steps</p>
                                </div>
                                <input type="checkbox" id="track-steps" onchange="toggleTracking('steps')" class="w-5 h-5 accent-indigo-600" checked>
                            </label>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[11px] font-black uppercase text-slate-400">Goals</h3>
                            <button onclick="openGoalSetting()" class="text-xs font-bold text-indigo-600 hover:text-indigo-700">+ Add Goal</button>
                        </div>
                        <div id="goals-list" class="space-y-2"></div>
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">
                        Save Settings
                    </button>
                </div>
            </section>

        </main>

        <!-- ========================================== -->
        <!-- SIDEBAR -->
        <!-- ========================================== -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100]" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-80 bg-white shadow-2xl z-[101] transform -translate-x-full">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-black text-indigo-600">Menu</h2>
                    <button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav class="space-y-2">
                    <button onclick="switchTab('dashboard'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Dashboard</span>
                    </button>
                    <button onclick="switchTab('training'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="dumbbell" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Training</span>
                    </button>
                    <button onclick="switchTab('nutrition'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="apple" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Nutrition</span>
                    </button>
                    <button onclick="switchTab('logs'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="clipboard-list" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Logs</span>
                    </button>
                    <button onclick="switchTab('metrics'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Metrics</span>
                    </button>
                    <button onclick="switchTab('profile'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="user" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Profile</span>
                    </button>
                    <button onclick="switchTab('settings'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                        <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                            <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <span class="font-bold text-slate-700">Settings</span>
                    </button>
                </nav>

                <!-- User info in sidebar -->
                <div class="mt-8 p-4 bg-slate-50 rounded-2xl">
                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Signed in as</p>
                    <p id="sidebar-user-email" class="text-sm font-bold text-slate-700 truncate">Loading...</p>
                    <button onclick="logoutUser(); toggleSidebar();" class="w-full mt-3 text-xs text-red-500 font-bold hover:text-red-600">Sign Out</button>
                </div>
            </div>
        </div>

    </div><!-- END APP SCREEN -->

    <!-- ========================================== -->
    <!-- MODALS -->
    <!-- ========================================== -->

    <!-- MANUAL FOOD ENTRY MODAL -->
    <div id="manual-food-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Add Food Manually</h3>
                <button onclick="closeManualFoodEntry()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Image (Optional)</label>
                <div class="flex items-center gap-4">
                    <div id="manual-food-preview" class="w-24 h-24 bg-slate-100 rounded-2xl flex items-center justify-center overflow-hidden">
                        <i data-lucide="image" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="manual-food-image" accept="image/*" class="hidden" onchange="previewManualFoodImage(event)">
                        <button onclick="document.getElementById('manual-food-image').click()" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100">
                            Choose Image
                        </button>
                        <button onclick="clearManualFoodImage()" class="w-full mt-2 py-2 text-xs text-slate-400 hover:text-red-600">
                            Clear Image
                        </button>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Name</label>
                <input type="text" id="manual-food-name" placeholder="e.g., Chicken Sandwich" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Store / Restaurant</label>
                <div class="relative">
                    <input 
                        id="manual-food-store-input" 
                        type="text" 
                        placeholder="Search stores or restaurants..." 
                        class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500"
                        onfocus="showManualStoreDropdown()"
                        oninput="filterManualStoreDropdown(this.value)"
                        autocomplete="off">
                    <div id="manual-store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories (kcal)</label>
                    <input type="number" id="manual-food-calories" min="0" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Protein (g)</label>
                    <input type="number" id="manual-food-protein" min="0" step="0.1" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
            </div>
            <div class="mb-6">
                <button onclick="toggleManualFoodMacros()" class="w-full text-left text-xs font-bold text-indigo-600 hover:text-indigo-700 mb-3">
                    <span id="manual-macros-toggle">+ Add More Details (Optional)</span>
                </button>
                <div id="manual-food-macros" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Carbs (g)</label>
                        <input type="number" id="manual-food-carbs" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fat (g)</label>
                        <input type="number" id="manual-food-fat" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fiber (g)</label>
                        <input type="number" id="manual-food-fiber" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Sugar (g)</label>
                        <input type="number" id="manual-food-sugar" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                </div>
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Serving Size</label>
                <input type="text" id="manual-food-serving" placeholder="e.g., 1 sandwich, 100g" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <button onclick="saveManualFood()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:bg-emerald-700 mb-3">
                Save to My Foods
            </button>
            <button onclick="closeManualFoodEntry()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel
            </button>
        </div>
    </div>

    <!-- GOAL SETTING MODAL -->
    <div id="goal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Set Goal</h3>
                <button onclick="closeGoalModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Type</label>
                <select id="goal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="short">Short-term (1-4 weeks)</option>
                    <option value="medium">Medium-term (1-3 months)</option>
                    <option value="long">Long-term (3+ months)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Description</label>
                <input type="text" id="goal-description" placeholder="e.g., Lose 5kg, Run 5k" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Target Date</label>
                <input type="date" id="goal-deadline" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <button onclick="saveGoal()" class="w-full bg-indigo-600 text-white py-5 rounded-[24px] font-black hover:bg-indigo-700 mb-3">
                Save Goal
            </button>
            <button onclick="closeGoalModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- CARDIO LOGGING MODAL -->
    <div id="cardio-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Log Cardio Activity</h3>
                <button onclick="closeCardioModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Activity Type</label>
                <select id="cardio-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="running">üèÉ Running</option>
                    <option value="cycling">üö¥ Cycling</option>
                    <option value="swimming">üèä Swimming</option>
                    <option value="walking">üö∂ Walking</option>
                    <option value="hiking">‚õ∞Ô∏è Hiking</option>
                    <option value="rowing">üö£ Rowing</option>
                    <option value="elliptical">‚ö° Elliptical</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Duration (min)</label>
                    <input type="number" id="cardio-duration" min="1" placeholder="30" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Distance (km)</label>
                    <input type="number" id="cardio-distance" min="0" step="0.1" placeholder="5.0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories Burned (optional)</label>
                <input type="number" id="cardio-calories" min="0" placeholder="300" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
            </div>
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Notes (optional)</label>
                <textarea id="cardio-notes" rows="3" placeholder="How did it feel?" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none resize-none"></textarea>
            </div>
            <button onclick="saveCardio()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black hover:bg-emerald-700 mb-3">
                Save Activity
            </button>
            <button onclick="closeCardioModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- EXERCISE DEMONSTRATION MODAL -->
    <div id="exercise-demo-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="demo-exercise-name" class="text-xl sm:text-2xl font-black">Exercise Demo</h3>
                <button onclick="closeExerciseDemo()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none hover:bg-slate-200">√ó</button>
            </div>
            <div class="mb-6">
                <div id="demo-video-container" class="aspect-video bg-slate-100 rounded-2xl overflow-hidden mb-4 flex items-center justify-center">
                    <iframe id="demo-video" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">How to perform</h4>
                <div id="demo-instructions" class="space-y-2 text-sm text-slate-700"></div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">Muscles targeted</h4>
                <div id="demo-muscles" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="mb-6">
                <h4 class="text-sm font-black uppercase text-slate-400 mb-3">Tips</h4>
                <div id="demo-tips" class="space-y-2 text-sm text-slate-700"></div>
            </div>
            <button onclick="closeExerciseDemo()" class="w-full bg-indigo-600 text-white py-4 rounded-[24px] font-black hover:bg-indigo-700">
                Back to Workout
            </button>
        </div>
    </div>

    <!-- FOOD ITEM POPUP -->
    <div id="food-popup" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 h-32 sm:w-40 sm:h-40 bg-slate-50 rounded-3xl overflow-hidden mb-4 p-3 shadow-lg border-2 border-slate-100">
                    <img id="popup-image" src="" class="w-full h-full object-contain" alt="Food image">
                </div>
                <h2 id="popup-name" class="text-xl sm:text-2xl font-black text-center leading-tight mb-2">Product</h2>
            </div>
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-5 rounded-3xl mb-6 shadow-sm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Calories</p>
                        <p id="popup-nutrition-cals" class="font-black text-3xl text-indigo-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">kcal</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Protein</p>
                        <p id="popup-nutrition-protein" class="font-black text-3xl text-blue-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">grams</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 pt-3 border-t border-indigo-200">
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Carbs</p>
                        <p id="popup-nutrition-carbs" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fat</p>
                        <p id="popup-nutrition-fat" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fiber</p>
                        <p id="popup-nutrition-fiber" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                </div>
                <div id="detailed-nutrition" class="hidden mt-3 pt-3 border-t border-indigo-200">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sugar</p>
                            <p id="popup-nutrition-sugar" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sat Fat</p>
                            <p id="popup-nutrition-satfat" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sodium</p>
                            <p id="popup-nutrition-sodium" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Cholest</p>
                            <p id="popup-nutrition-cholesterol" class="font-bold text-indigo-600">0mg</p>
                        </div>
                    </div>
                </div>
                <button onclick="toggleDetailedNutrition()" class="w-full mt-2 text-[10px] font-bold text-indigo-600 hover:text-indigo-700">
                    <span id="toggle-text">Show More ‚ñº</span>
                </button>
                <p id="popup-nutrition" class="text-xs text-center text-slate-500 mt-3"></p>
            </div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Meal Type</label>
                <select id="popup-meal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-base">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label>
                <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-4">
                    <button onclick="setAmountType('portion')" id="amount-type-portion" class="flex-1 py-3 rounded-xl text-xs font-black uppercase bg-white shadow text-emerald-600">Portion</button>
                    <button onclick="setAmountType('grams')" id="amount-type-grams" class="flex-1 py-3 rounded-xl text-xs font-black uppercase text-slate-400">Grams</button>
                </div>
                <input id="popup-amount" type="number" value="1" min="1" class="w-full bg-slate-50 border-4 border-slate-200 rounded-[24px] py-5 text-4xl font-black text-center outline-none focus:border-emerald-500 transition-colors">
            </div>
            <div class="bg-slate-900 text-white p-5 rounded-3xl mb-6 shadow-xl">
                <p class="text-[10px] font-black uppercase text-slate-400 text-center mb-3">Total You're Adding</p>
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <p id="popup-total-kcal" class="font-black text-3xl mb-1">0</p>
                        <p class="text-xs text-slate-400 uppercase">Calories</p>
                    </div>
                    <div class="w-px h-12 bg-slate-700"></div>
                    <div class="text-center">
                        <p id="popup-total-protein" class="font-black text-3xl text-emerald-400 mb-1">0g</p>
                        <p class="text-xs text-slate-400 uppercase">Protein</p>
                    </div>
                </div>
            </div>
            <button onclick="addFoodItem()" class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:shadow-xl transition-all active:scale-95 mb-3">
                Add to Diary
            </button>
            <button onclick="closeFoodPopup()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600 transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- BARCODE SCANNER MODAL -->
    <div id="barcode-scanner-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black">Scan Barcode</h3>
                <button onclick="closeBarcodeScanner()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div id="barcode-reader" class="w-full h-64 bg-black rounded-2xl mb-4"></div>
            <div class="flex gap-2">
                <input id="manual-barcode" type="text" placeholder="Or enter barcode manually..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="lookupBarcode()" class="bg-slate-900 text-white px-6 rounded-xl font-bold hover:bg-slate-800">Search</button>
            </div>
        </div>
    </div>

    <!-- CREATE MEAL MODAL -->
    <div id="create-meal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Create Meal</h3>
                <button onclick="closeCreateMeal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>
            <div class="mb-4">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Meal Name *</label>
                <input id="meal-name-input" type="text" placeholder="e.g. Chicken & Rice Bowl" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>
            <div class="flex gap-2 mb-4">
                <input id="meal-ingredient-search" type="text" placeholder="Search ingredient..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="showToast('Barcode for meals coming soon!')" class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center hover:bg-indigo-700">
                    <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="meal-search-results" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
            <div class="mb-6">
                <h4 class="text-sm font-black text-slate-400 uppercase mb-2">Ingredients</h4>
                <div id="meal-ingredients-list" class="space-y-2"></div>
            </div>
            <button onclick="saveMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold hover:bg-emerald-700">Save Meal</button>
        </div>
    </div>

    <!-- METRICS CHART MODAL -->
    <div id="metrics-chart-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Progress Charts</h3>
                <button onclick="closeMetricsChart()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="mb-6">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Metric</label>
                <select id="chart-metric-select" onchange="renderMetricChart()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-lg">
                    <option value="weight">Weight (kg)</option>
                    <option value="chest">Chest (cm)</option>
                    <option value="shoulders">Shoulders (cm)</option>
                    <option value="arms">Arms (cm)</option>
                    <option value="waist">Waist (cm)</option>
                    <option value="legs">Legs (cm)</option>
                    <option value="glutes">Glutes (cm)</option>
                </select>
            </div>
            <div class="h-80 relative bg-slate-50 rounded-3xl p-4">
                <canvas id="metrics-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- PHOTO COMPARISON MODAL -->
    <div id="photo-comparison-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Compare Photos</h3>
                <button onclick="closePhotoComparison()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>
            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">First Date</label>
                        <select id="compare-date-1" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Second Date</label>
                        <select id="compare-date-2" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Photo Angle</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setComparePhotoType('front')" id="compare-type-front" class="p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white">Front</button>
                        <button onclick="setComparePhotoType('side')" id="compare-type-side" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Side</button>
                        <button onclick="setComparePhotoType('back')" id="compare-type-back" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Back</button>
                    </div>
                </div>
            </div>
            <div id="comparison-view" class="grid grid-cols-2 gap-6 hidden">
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-1"></div>
                    <img id="compare-img-1" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="Before">
                </div>
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-2"></div>
                    <img id="compare-img-2" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="After">
                </div>
            </div>
            <div id="no-comparison-message" class="text-center py-12 text-slate-400">
                <i data-lucide="images" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                <p class="font-bold">Select two dates to compare</p>
            </div>
        </div>
    </div>

    <script>
    // ==========================================================================
    // FIREBASE CONFIGURATION
    // ==========================================================================
    // üî• REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyA9H9hmvfrQmc2wIwnS2jCPLgdmXBquQXM",
        authDomain: "vfit-app-pro.firebaseapp.com",
        projectId: "vfit-app-pro",
        storageBucket: "vfit-app-pro.firebasestorage.app",
        messagingSenderId: "815730068689",
        appId: "1:815730068689:web:0c6587d7dbe62b0f3c09f0",
        measurementId: "G-74L12X0NE8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let firebaseUserData = {};

    // ==========================================================================
    // AUTH FORM HELPERS
    // ==========================================================================

    function showLogin() {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
    }

    function showRegister() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
    }

    function showForgotPassword() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.remove('hidden');
    }

    // ==========================================================================
    // AUTH FUNCTIONS
    // ==========================================================================

    async function registerUser() {
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirm = document.getElementById('register-confirm').value;

        if (!name) { showToast('Please enter your name'); return; }
        if (!email || !password) { showToast('Please fill all fields'); return; }
        if (password.length < 6) { showToast('Password must be at least 6 characters'); return; }
        if (password !== confirm) { showToast('Passwords do not match'); return; }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            await user.updateProfile({ displayName: name });

            await db.collection('users').doc(user.uid).set({
                name: name,
                email: email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                calorieGoal: 2500,
                workouts: [],
                meals: [],
                metrics: []
            });

            showToast('Account created successfully! üéâ');
        } catch (error) {
            console.error('Registration error:', error);
            if (error.code === 'auth/email-already-in-use') {
                showToast('Email already in use');
            } else if (error.code === 'auth/invalid-email') {
                showToast('Invalid email address');
            } else {
                showToast('Registration failed: ' + error.message);
            }
        }
    }

    async function loginUser() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        if (!email || !password) { showToast('Please enter email and password'); return; }
        try {
            await auth.signInWithEmailAndPassword(email, password);
            showToast('Welcome back! üí™');
        } catch (error) {
            console.error('Login error:', error);
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                showToast('Invalid email or password');
            } else {
                showToast('Login failed: ' + error.message);
            }
        }
    }

    async function resetPassword() {
        const email = document.getElementById('forgot-email').value.trim();
        if (!email) { showToast('Please enter your email'); return; }
        try {
            await auth.sendPasswordResetEmail(email);
            showToast('Password reset email sent! Check your inbox.');
            showLogin();
        } catch (error) {
            console.error('Reset error:', error);
            showToast('Failed to send reset email');
        }
    }

    async function logoutUser() {
        if (confirm('Are you sure you want to sign out?')) {
            try {
                await auth.signOut();
                showToast('Signed out successfully');
                state = { ...DEFAULT_STATE };
                saveState();
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout failed');
            }
        }
    }

    // Load user data from Firestore and merge with local
    async function loadFirebaseUserData() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                firebaseUserData = doc.data();
                // Merge calorie goal from Firebase into local state
                if (firebaseUserData.calorieGoal) {
                    state.goals.calories = firebaseUserData.calorieGoal;
                }
            } else {
                await db.collection('users').doc(currentUser.uid).set({
                    name: currentUser.displayName || 'User',
                    email: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    calorieGoal: state.goals.calories || 2500,
                    workouts: [],
                    meals: [],
                    metrics: []
                });
            }
        } catch (error) {
            console.error('Error loading Firebase user data:', error);
        }
    }

    // Sync local state to Firestore
    async function syncToCloud() {
        if (!currentUser) { showToast('Not signed in'); return; }
        try {
            await db.collection('users').doc(currentUser.uid).update({
                calorieGoal: state.goals.calories,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast('Synced to cloud ‚òÅÔ∏è');
        } catch (error) {
            console.error('Sync error:', error);
            showToast('Sync failed - check connection');
        }
    }

    // ==========================================================================
    // AUTH STATE OBSERVER
    // ==========================================================================

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            // Load local state first, then merge Firebase data
            loadState();
            await loadFirebaseUserData();

            // Update UI
            const emailEl = document.getElementById('status-date');
            if (emailEl) emailEl.innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });

            const sidebarEmail = document.getElementById('sidebar-user-email');
            if (sidebarEmail) sidebarEmail.textContent = user.email;

            renderProfile();
            renderDashboard();
            renderDiary();
            renderSettings();
            setupMidnightSave();

            lucide.createIcons();
        } else {
            currentUser = null;
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
            lucide.createIcons();
        }
    });

    // Render profile with Firebase data
    function renderProfile() {
        if (!currentUser) return;

        const name = (currentUser.displayName) || (firebaseUserData && firebaseUserData.name) || 'User';
        document.getElementById('profile-name').textContent = name;
        document.getElementById('profile-email').textContent = currentUser.email;

        if (firebaseUserData && firebaseUserData.createdAt) {
            try {
                const date = firebaseUserData.createdAt.toDate
                    ? firebaseUserData.createdAt.toDate()
                    : new Date(firebaseUserData.createdAt);
                document.getElementById('profile-created').textContent = date.toLocaleDateString();
            } catch (e) {
                document.getElementById('profile-created').textContent = 'Recently';
            }
        } else {
            document.getElementById('profile-created').textContent = 'Recently';
        }

        document.getElementById('profile-workouts').textContent = state.workoutHistory.length;
    }

    // ==========================================================================
    // STATE MANAGEMENT
    // ==========================================================================

    const DEFAULT_STATE = {
        viewDate: new Date().toISOString().split('T')[0],
        metricsDate: new Date().toISOString().split('T')[0],
        goals: { calories: 2500, water: 2500, steps: 10000 },
        waterLogs: {},
        stepsLogs: {},
        dailyMeals: [],
        workoutHistory: [],
        nutritionHistory: [],
        metricsHistory: [],
        createdMeals: [],
        customFoods: [],
        workoutEnv: 'gym',
        currentPhotos: { front: null, side: null, back: null },
        habits: [],
        habitsEnabled: false,
        habitCompletions: {},
        hydrationGoalCompletions: {},
        stepsGoalCompletions: {},
        trackHydration: true,
        trackSteps: true,
        userGoals: [],
        cardioLogs: [],
        hydrationLogs: {},
        equipment: {
            gym: {
                'Barbell': true,
                'Dumbbells': true,
                'Cable Machine': true,
                'Leg Press': true,
                'Pull Up Bar': true,
                'Bench': true
            },
            home: {
                'Dumbbells': false,
                'Resistance Bands': false,
                'Pull Up Bar': false,
                'Yoga Mat': true
            }
        }
    };

    let state = { ...DEFAULT_STATE };

    let workoutTimer = null;
    let workoutStartTime = null;
    let currentFoodItem = null;
    let currentAmountType = 'portion';
    let searchResults = [];
    let mealIngredients = [];
    let html5QrCode = null;
    let metricsChart = null;
    let currentPhotoType = null;
    let manualFoodImageData = null;

    // ==========================================================================
    // PERSISTENCE
    // ==========================================================================

    function saveState() {
        try {
            localStorage.setItem('fittrack_state', JSON.stringify(state));
        } catch (e) {
            console.error('Save error:', e);
        }
    }

    function loadState() {
        try {
            const saved = localStorage.getItem('fittrack_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...DEFAULT_STATE, ...parsed };
                // Ensure nested objects are merged properly
                state.goals = { ...DEFAULT_STATE.goals, ...(parsed.goals || {}) };
                state.equipment = {
                    gym: { ...DEFAULT_STATE.equipment.gym, ...(parsed.equipment?.gym || {}) },
                    home: { ...DEFAULT_STATE.equipment.home, ...(parsed.equipment?.home || {}) }
                };
            }
        } catch (e) {
            console.error('Load error:', e);
        }
    }

    function setupMidnightSave() {
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const msUntilMidnight = tomorrow - now;

        setTimeout(() => {
            saveDailyNutrition();
            setupMidnightSave();
        }, msUntilMidnight);
    }

    function saveDailyNutrition() {
        const today = state.viewDate;
        const todayMeals = state.dailyMeals.filter(m => m.date === today);
        if (todayMeals.length > 0) {
            const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);
            const existing = state.nutritionHistory.findIndex(h => h.date === today);
            const entry = { date: today, calories: totalCals, protein: totalProtein, meals: todayMeals };
            if (existing >= 0) {
                state.nutritionHistory[existing] = entry;
            } else {
                state.nutritionHistory.unshift(entry);
            }
            saveState();
            showToast('Daily nutrition auto-saved');
        }
    }

    // ==========================================================================
    // TAB MANAGEMENT
    // ==========================================================================

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        const tab = document.getElementById(tabId);
        if (tab) tab.classList.add('active');
        if (tabId === 'logs') { renderLogs(); filterWorkouts(); }
        if (tabId === 'profile') renderProfile();
        if (tabId === 'settings') renderSettings();
        if (tabId === 'dashboard') renderDashboard();
        lucide.createIcons();
    }

    // ==========================================================================
    // SIDEBAR
    // ==========================================================================

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isOpen = sidebar.classList.contains('translate-x-0');
        if (isOpen) {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.add('translate-x-0');
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }
        lucide.createIcons();
    }

    // ==========================================================================
    // TOAST
    // ==========================================================================

    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ==========================================================================
    // EXERCISE DATABASE
    // ==========================================================================

    const EXERCISE_DB = {
        gym: {
            'Full Body': {
                compound: ['Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press'],
                isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl', 'Calf Raise']
            },
            'Upper': {
                compound: ['Bench Press', 'Pull Ups', 'Dumbbell Row', 'Overhead Press', 'Dips'],
                isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Face Pulls', 'Cable Flyes']
            },
            'Lower': {
                compound: ['Barbell Squat', 'Romanian Deadlift', 'Leg Press', 'Lunges'],
                isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Abduction', 'Glute Kickback']
            },
            'Push': {
                compound: ['Bench Press', 'Overhead Press', 'Incline Press', 'Dips'],
                isolation: ['Tricep Pushdown', 'Lateral Raise', 'Cable Flyes', 'Skull Crushers']
            },
            'Pull': {
                compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                isolation: ['Bicep Curl', 'Face Pulls', 'Hammer Curl', 'Cable Row']
            },
            'Legs': {
                compound: ['Squat', 'Deadlift', 'Leg Press', 'Lunges'],
                isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Thrust']
            },
            'Chest': {
                compound: ['Bench Press', 'Incline Press', 'Dumbbell Press'],
                isolation: ['Cable Flyes', 'Pec Deck', 'Dumbbell Flyes']
            },
            'Back': {
                compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                isolation: ['Cable Row', 'Face Pulls', 'Straight Arm Pulldown']
            },
            'Shoulders': {
                compound: ['Overhead Press', 'Arnold Press'],
                isolation: ['Lateral Raise', 'Front Raise', 'Face Pulls', 'Reverse Flyes']
            },
            'Biceps': {
                compound: ['Chin Ups'],
                isolation: ['Barbell Curl', 'Hammer Curl', 'Preacher Curl', 'Cable Curl']
            },
            'Triceps': {
                compound: ['Close Grip Bench Press', 'Dips'],
                isolation: ['Tricep Pushdown', 'Skull Crushers', 'Overhead Extension']
            },
            'Quads': {
                compound: ['Squat', 'Leg Press', 'Lunges'],
                isolation: ['Leg Extension', 'Sissy Squat']
            },
            'Hamstrings': {
                compound: ['Romanian Deadlift', 'Good Morning'],
                isolation: ['Leg Curl', 'Nordic Curl']
            },
            'Glutes': {
                compound: ['Hip Thrust', 'Bulgarian Split Squat'],
                isolation: ['Cable Kickback', 'Hip Abduction', 'Glute Bridge']
            },
            'Calves': {
                compound: [],
                isolation: ['Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise']
            }
        },
        home: {
            'Full Body': {
                compound: ['Push Ups', 'Bodyweight Squat', 'Burpees'],
                isolation: ['Plank', 'Crunches', 'Leg Raises']
            },
            'Upper': {
                compound: ['Push Ups', 'Pike Push Ups', 'Inverted Row'],
                isolation: ['Tricep Dips', 'Plank to Push Up', 'Superman']
            },
            'Lower': {
                compound: ['Bodyweight Squat', 'Lunges', 'Step Ups'],
                isolation: ['Glute Bridge', 'Calf Raise', 'Donkey Kicks']
            },
            'Push': {
                compound: ['Push Ups', 'Pike Push Ups'],
                isolation: ['Diamond Push Ups', 'Tricep Dips', 'Shoulder Taps']
            },
            'Pull': {
                compound: ['Inverted Row', 'Chin Ups'],
                isolation: ['Superman', 'Reverse Snow Angels', 'Bicep Holds']
            },
            'Legs': {
                compound: ['Squat', 'Lunges', 'Jump Squat'],
                isolation: ['Glute Bridge', 'Calf Raise', 'Leg Raises']
            }
        }
    };

    const ALL_EXERCISES = [
        'Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press',
        'Dumbbell Press', 'Incline Press', 'Dips', 'Barbell Row', 'Lat Pulldown',
        'T-Bar Row', 'Romanian Deadlift', 'Leg Press', 'Lunges', 'Good Morning',
        'Hip Thrust', 'Bulgarian Split Squat', 'Arnold Press', 'Close Grip Bench Press',
        'Chin Ups', 'Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl',
        'Calf Raise', 'Face Pulls', 'Cable Flyes', 'Leg Extension', 'Hip Abduction',
        'Glute Kickback', 'Cable Row', 'Hammer Curl', 'Skull Crushers', 'Pec Deck',
        'Dumbbell Flyes', 'Front Raise', 'Reverse Flyes', 'Preacher Curl', 'Cable Curl',
        'Overhead Extension', 'Sissy Squat', 'Nordic Curl', 'Cable Kickback', 'Glute Bridge',
        'Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise', 'Straight Arm Pulldown',
        'Push Ups', 'Bodyweight Squat', 'Burpees', 'Pike Push Ups', 'Inverted Row',
        'Step Ups', 'Donkey Kicks', 'Diamond Push Ups', 'Shoulder Taps', 'Superman',
        'Reverse Snow Angels', 'Bicep Holds', 'Jump Squat', 'Plank', 'Crunches',
        'Leg Raises', 'Tricep Dips', 'Plank to Push Up', 'Barbell Curl', 'Face Pulls',
        'Hip Abduction', 'T-Bar Row', 'Dumbbell Row', 'Cable Flyes'
    ].filter((v, i, a) => a.indexOf(v) === i).sort();

    const CARDIO_EXERCISES = ['Treadmill', 'Rowing Machine', 'Stationary Bike', 'Elliptical', 'Stair Climber'];
    const CORE_EXERCISES = ['Plank', 'Crunches', 'Russian Twists', 'Leg Raises', 'Mountain Climbers', 'Dead Bug'];

    // ==========================================================================
    // UK STORES & RESTAURANTS LIST
    // ==========================================================================

    const UK_STORES_RESTAURANTS = [
        { name: 'All Stores & Restaurants', value: 'all', type: 'all' },
        { name: 'Tesco', value: 'tesco', type: 'supermarket' },
        { name: "Sainsbury's", value: 'sainsburys', type: 'supermarket' },
        { name: 'ASDA', value: 'asda', type: 'supermarket' },
        { name: 'Morrisons', value: 'morrisons', type: 'supermarket' },
        { name: 'Aldi', value: 'aldi', type: 'supermarket' },
        { name: 'Lidl', value: 'lidl', type: 'supermarket' },
        { name: 'Waitrose', value: 'waitrose', type: 'supermarket' },
        { name: 'Co-op', value: 'coop', type: 'supermarket' },
        { name: 'Iceland', value: 'iceland', type: 'supermarket' },
        { name: 'Costco', value: 'costco', type: 'supermarket' },
        { name: 'M&S Food', value: 'marks', type: 'supermarket' },
        { name: 'Ocado', value: 'ocado', type: 'supermarket' },
        { name: 'Farmfoods', value: 'farmfoods', type: 'supermarket' },
        { name: 'Booths', value: 'booths', type: 'supermarket' },
        { name: 'Budgens', value: 'budgens', type: 'supermarket' },
        { name: "McDonald's", value: 'mcdonalds', type: 'fastfood' },
        { name: 'KFC', value: 'kfc', type: 'fastfood' },
        { name: 'Burger King', value: 'burgerking', type: 'fastfood' },
        { name: 'Subway', value: 'subway', type: 'fastfood' },
        { name: 'Greggs', value: 'greggs', type: 'fastfood' },
        { name: "Nando's", value: 'nandos', type: 'fastfood' },
        { name: 'Pizza Hut', value: 'pizzahut', type: 'fastfood' },
        { name: "Domino's", value: 'dominos', type: 'fastfood' },
        { name: "Papa John's", value: 'papajohns', type: 'fastfood' },
        { name: 'Five Guys', value: 'fiveguys', type: 'fastfood' },
        { name: 'Wagamama', value: 'wagamama', type: 'fastfood' },
        { name: 'Pret A Manger', value: 'pret', type: 'fastfood' },
        { name: 'Leon', value: 'leon', type: 'fastfood' },
        { name: 'Yo! Sushi', value: 'yosushi', type: 'fastfood' },
        { name: 'Gourmet Burger Kitchen', value: 'gbk', type: 'fastfood' },
        { name: 'Costa Coffee', value: 'costa', type: 'fastfood' },
        { name: 'Starbucks', value: 'starbucks', type: 'fastfood' },
        { name: 'Caff√® Nero', value: 'nero', type: 'fastfood' }
    ].sort((a, b) => {
        if (a.value === 'all') return -1;
        if (b.value === 'all') return 1;
        return a.name.localeCompare(b.name);
    });

    // ==========================================================================
    // DASHBOARD
    // ==========================================================================

    function renderDashboard() {
        const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
        const totalCals = todayMeals.reduce((sum, m) => sum + (m.calories || 0), 0);
        const totalProtein = todayMeals.reduce((sum, m) => sum + (m.protein || 0), 0);

        const dashCals = document.getElementById('dash-calories');
        if (dashCals) dashCals.innerText = Math.round(totalCals);

        const dashProtein = document.getElementById('dash-protein');
        if (dashProtein) dashProtein.innerText = Math.round(totalProtein) + 'g';

        const dashCarbs = document.getElementById('dash-carbs');
        if (dashCarbs) dashCarbs.innerText = Math.round(totalCals * 0.4 / 4) + 'g';

        const dashFat = document.getElementById('dash-fat');
        if (dashFat) dashFat.innerText = Math.round(totalCals * 0.3 / 9) + 'g';

        const calorieGoal = (state.goals && state.goals.calories) ? state.goals.calories : 2500;
        const progress = Math.min((totalCals / calorieGoal) * 534, 534);
        const progressEl = document.getElementById('calorie-progress');
        if (progressEl) progressEl.style.strokeDashoffset = 534 - progress;

        const water = (state.waterLogs && state.waterLogs[state.viewDate]) || 0;
        const waterGoal = (state.goals && state.goals.water) ? state.goals.water : 2500;
        const waterCountEl = document.getElementById('water-count');
        if (waterCountEl) waterCountEl.innerText = `${(water / 1000).toFixed(1)} / ${(waterGoal / 1000).toFixed(1)}L`;

        const steps = (state.stepsLogs && state.stepsLogs[state.viewDate]) || 0;
        const stepsGoal = (state.goals && state.goals.steps) ? state.goals.steps : 10000;
        const stepsCountEl = document.getElementById('steps-count');
        if (stepsCountEl) stepsCountEl.innerText = `${steps.toLocaleString()} / ${stepsGoal.toLocaleString()}`;

        // Hydration check button state
        const hydrationComplete = (state.hydrationGoalCompletions && state.hydrationGoalCompletions[state.viewDate]) || false;
        const hydrationCheckBtn = document.getElementById('hydration-check');
        if (hydrationCheckBtn) {
            const icon = hydrationCheckBtn.querySelector('i');
            if (hydrationComplete) {
                hydrationCheckBtn.classList.add('bg-cyan-500', 'border-cyan-500');
                hydrationCheckBtn.classList.remove('border-slate-200');
                if (icon) { icon.classList.remove('text-transparent'); icon.classList.add('text-white'); }
            } else {
                hydrationCheckBtn.classList.remove('bg-cyan-500', 'border-cyan-500');
                hydrationCheckBtn.classList.add('border-slate-200');
                if (icon) { icon.classList.add('text-transparent'); icon.classList.remove('text-white'); }
            }
        }

        // Steps check button state
        const stepsComplete = (state.stepsGoalCompletions && state.stepsGoalCompletions[state.viewDate]) || false;
        const stepsCheckBtn = document.getElementById('steps-check');
        if (stepsCheckBtn) {
            const icon = stepsCheckBtn.querySelector('i');
            if (stepsComplete) {
                stepsCheckBtn.classList.add('bg-amber-500', 'border-amber-500');
                stepsCheckBtn.classList.remove('border-slate-200');
                if (icon) { icon.classList.remove('text-transparent'); icon.classList.add('text-white'); }
            } else {
                stepsCheckBtn.classList.remove('bg-amber-500', 'border-amber-500');
                stepsCheckBtn.classList.add('border-slate-200');
                if (icon) { icon.classList.add('text-transparent'); icon.classList.remove('text-white'); }
            }
        }

        // Weekly overview stats
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const weekWorkouts = (state.workoutHistory || []).filter(w => new Date(w.date) > weekAgo).length;
        const lastWeight = state.metricsHistory && state.metricsHistory[0] ? state.metricsHistory[0].weight : '--';

        const statsEl = document.getElementById('muscle-volume-stats');
        if (statsEl) {
            statsEl.innerHTML = `
                <div class="bg-white/10 p-3 rounded-xl">
                    <div class="text-[10px] opacity-70 uppercase">This Week</div>
                    <div class="font-bold text-xl">${weekWorkouts} workouts</div>
                </div>
                <div class="bg-white/10 p-3 rounded-xl">
                    <div class="text-[10px] opacity-70 uppercase">Last Weight</div>
                    <div class="font-bold text-xl">${lastWeight} kg</div>
                </div>`;
        }

        // Render habits if enabled
        if (state.habitsEnabled) {
            const habitsTracker = document.getElementById('habits-tracker');
            if (habitsTracker) habitsTracker.classList.remove('hidden');
            renderDashboardHabits();
        }

        lucide.createIcons();
    }

    function toggleHydrationGoal() {
        const date = state.viewDate;
        if (!state.hydrationGoalCompletions) state.hydrationGoalCompletions = {};
        state.hydrationGoalCompletions[date] = !state.hydrationGoalCompletions[date];
        saveState();
        renderDashboard();
        showToast(state.hydrationGoalCompletions[date] ? 'Hydration goal reached! üíß' : 'Hydration goal unmarked');
        lucide.createIcons();
    }

    function toggleStepsGoal() {
        const date = state.viewDate;
        if (!state.stepsGoalCompletions) state.stepsGoalCompletions = {};
        state.stepsGoalCompletions[date] = !state.stepsGoalCompletions[date];
        saveState();
        renderDashboard();
        showToast(state.stepsGoalCompletions[date] ? 'Steps goal reached! üëü' : 'Steps goal unmarked');
        lucide.createIcons();
    }

    // ==========================================================================
    // TRAINING
    // ==========================================================================

    function setWorkoutEnv(env) {
        state.workoutEnv = env;
        const gymTab = document.getElementById('env-tab-gym');
        const homeTab = document.getElementById('env-tab-home');
        if (gymTab) gymTab.className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'gym' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (homeTab) homeTab.className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'home' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
    }

    function toggleSpecificMuscle() {
        const focus = document.getElementById('workout-focus').value;
        const container = document.getElementById('specific-muscle-container');
        if (container) container.classList.toggle('hidden', focus !== 'Specific Muscle');
    }

    function startWorkout(mode) {
        const focus = document.getElementById('workout-focus').value;
        const muscle = focus === 'Specific Muscle' ? document.getElementById('specific-muscle').value : focus;
        
        document.getElementById('workout-setup').classList.add('hidden');
        document.getElementById('workout-active').classList.remove('hidden');
        document.getElementById('active-workout-title').innerText = muscle;
        document.getElementById('exercise-list').innerHTML = '';

        if (mode === 'ai') {
            const env = state.workoutEnv || 'gym';
            const exercises = EXERCISE_DB[env] && EXERCISE_DB[env][muscle];
            const addCardio = document.getElementById('add-cardio-check').checked;
            const addCore = document.getElementById('add-core-check').checked;
            
            if (exercises) {
                const compounds = (exercises.compound || []).sort(() => 0.5 - Math.random()).slice(0, 2);
                const isolations = (exercises.isolation || []).sort(() => 0.5 - Math.random()).slice(0, 3);
                
                let delay = 0;
                [...compounds, ...isolations].forEach(ex => {
                    setTimeout(() => addExercise(ex), delay);
                    delay += 20;
                });
                
                if (addCardio) {
                    const cardio = CARDIO_EXERCISES[Math.floor(Math.random() * CARDIO_EXERCISES.length)];
                    setTimeout(() => addExercise(cardio), delay);
                    delay += 20;
                }
                
                if (addCore) {
                    const core1 = CORE_EXERCISES[Math.floor(Math.random() * CORE_EXERCISES.length)];
                    const core2 = CORE_EXERCISES.filter(c => c !== core1)[Math.floor(Math.random() * (CORE_EXERCISES.length - 1))];
                    setTimeout(() => addExercise(core1), delay);
                    delay += 20;
                    setTimeout(() => addExercise(core2), delay);
                }
                showToast('AI workout generated! üí™');
            } else {
                showToast('No exercises found for this selection');
            }
        }

        workoutStartTime = Date.now();
        workoutTimer = setInterval(updateWorkoutTimer, 1000);
    }

    function updateWorkoutTimer() {
        const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
        const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
        const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        const timerEl = document.getElementById('workout-timer');
        if (timerEl) timerEl.innerText = `${h}:${m}:${s}`;
    }

    function addExercise(name = '') {
        const id = 'ex-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const pr = name ? getPersonalRecord(name) : null;
        
        const card = document.createElement('div');
        card.id = `card-${id}`;
        card.className = "bg-white p-4 sm:p-5 rounded-2xl shadow-md border-2 border-indigo-100 mb-3 sm:mb-4 w-full";
        
        // Name container with dropdown and info button
        const nameContainer = document.createElement('div');
        nameContainer.className = "relative mb-3 sm:mb-4";
        
        const inputWrapper = document.createElement('div');
        inputWrapper.className = "flex gap-2 items-center";
        
        const nameInput = document.createElement('input');
        nameInput.type = "text";
        nameInput.value = name;
        nameInput.placeholder = "Search or type exercise name...";
        nameInput.className = "flex-1 p-3 sm:p-3.5 border-2 border-slate-200 rounded-xl font-bold text-base sm:text-lg";
        nameInput.id = `ex-name-${id}`;
        nameInput.autocomplete = "off";
        
        // Info / demo button
        const infoBtn = document.createElement('button');
        infoBtn.type = "button";
        infoBtn.className = "w-10 h-10 sm:w-11 sm:h-11 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center hover:bg-indigo-200 transition-colors flex-shrink-0";
        infoBtn.innerHTML = '<i data-lucide="info" class="w-5 h-5"></i>';
        infoBtn.addEventListener('click', () => {
            const exerciseName = nameInput.value.trim();
            if (exerciseName) showExerciseDemo(exerciseName);
            else showToast('Enter exercise name first');
        });
        
        // Dropdown
        const dropdown = document.createElement('div');
        dropdown.id = `dropdown-${id}`;
        dropdown.className = "hidden absolute z-50 mt-1 w-full bg-white rounded-xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto";
        
        nameInput.addEventListener('focus', () => showExerciseDropdown(id));
        nameInput.addEventListener('input', (e) => filterExerciseDropdown(id, e.target.value));
        
        inputWrapper.appendChild(nameInput);
        inputWrapper.appendChild(infoBtn);
        nameContainer.appendChild(inputWrapper);
        nameContainer.appendChild(dropdown);
        
        // Sets container
        const setsContainer = document.createElement('div');
        setsContainer.id = `sets-${id}`;
        setsContainer.className = "bg-slate-50 p-3 sm:p-4 rounded-xl mb-3 sm:mb-4 min-h-[100px] w-full";
        
        // Column header
        const header = document.createElement('div');
        header.className = "flex gap-2 sm:gap-3 mb-2 sm:mb-3";
        header.innerHTML = `
            <div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Reps</span></div>
            <div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Weight (kg)</span></div>
            <div class="w-9 sm:w-10"></div>`;
        setsContainer.appendChild(header);
        
        // Add Set button
        const addSetBtn = document.createElement('button');
        addSetBtn.type = "button";
        addSetBtn.className = "w-full py-3 sm:py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-sm sm:text-base hover:bg-indigo-700 active:bg-indigo-800";
        addSetBtn.textContent = "+ Add Set";
        addSetBtn.addEventListener('click', () => addSetToExercise(id, pr));
        
        // Delete exercise button
        const deleteExBtn = document.createElement('button');
        deleteExBtn.type = "button";
        deleteExBtn.className = "w-full py-2 sm:py-2.5 mt-2 bg-red-50 text-red-600 rounded-xl font-bold text-xs sm:text-sm hover:bg-red-100";
        deleteExBtn.textContent = "Delete Exercise";
        deleteExBtn.addEventListener('click', () => card.remove());
        
        card.appendChild(nameContainer);
        card.appendChild(setsContainer);
        card.appendChild(addSetBtn);
        card.appendChild(deleteExBtn);
        
        const exerciseList = document.getElementById('exercise-list');
        if (exerciseList) exerciseList.appendChild(card);
        
        // Auto-add first set after brief delay
        setTimeout(() => addSetToExercise(id, pr), 60);
        lucide.createIcons();
    }

    function showExerciseDropdown(id) {
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (!dropdown) return;
        
        const html = ALL_EXERCISES.map(ex => {
            const pr = getPersonalRecord(ex);
            return `<div onclick="selectExerciseFromDropdown('${id}', '${ex.replace(/'/g, "\\'")}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center transition-colors">
                <span class="font-medium text-sm">${ex}</span>
                ${pr ? `<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>` : ''}
            </div>`;
        }).join('');
        
        dropdown.innerHTML = html;
        dropdown.classList.remove('hidden');
    }

    function filterExerciseDropdown(id, query) {
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (!dropdown) return;
        
        const filtered = ALL_EXERCISES.filter(ex => ex.toLowerCase().includes(query.toLowerCase()));
        
        if (filtered.length === 0 && query.length > 0) {
            dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No matches ‚Äî keep typing for custom name</div>';
            dropdown.classList.remove('hidden');
        } else if (filtered.length > 0) {
            const html = filtered.map(ex => {
                const pr = getPersonalRecord(ex);
                return `<div onclick="selectExerciseFromDropdown('${id}', '${ex.replace(/'/g, "\\'")}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center transition-colors">
                    <span class="font-medium text-sm">${ex}</span>
                    ${pr ? `<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>` : ''}
                </div>`;
            }).join('');
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        } else if (query.length === 0) {
            showExerciseDropdown(id);
        } else {
            dropdown.classList.add('hidden');
        }
    }

    function selectExerciseFromDropdown(id, exerciseName) {
        const input = document.getElementById(`ex-name-${id}`);
        const dropdown = document.getElementById(`dropdown-${id}`);
        if (input) input.value = exerciseName;
        if (dropdown) dropdown.classList.add('hidden');
        
        const pr = getPersonalRecord(exerciseName);
        if (pr) showToast(`PR for ${exerciseName}: ${pr}kg`);
    }

    function addSetToExercise(exerciseId, pr) {
        const container = document.getElementById(`sets-${exerciseId}`);
        if (!container) return;
        
        const setRow = document.createElement('div');
        setRow.className = "flex gap-2 sm:gap-3 items-center mb-2 bg-white p-2 sm:p-3 rounded-lg border border-slate-200";
        
        const repsInput = document.createElement('input');
        repsInput.type = "number";
        repsInput.placeholder = "Reps";
        repsInput.min = "0";
        repsInput.className = "flex-1 p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
        
        const weightDiv = document.createElement('div');
        weightDiv.className = "flex-1 relative";
        
        const weightInput = document.createElement('input');
        weightInput.type = "number";
        weightInput.placeholder = "Weight";
        weightInput.min = "0";
        weightInput.step = "0.5";
        weightInput.className = "w-full p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
        
        weightDiv.appendChild(weightInput);
        
        if (pr) {
            const pbBadge = document.createElement('span');
            pbBadge.className = "absolute -top-2 -right-2 text-[9px] sm:text-[10px] font-black text-white bg-emerald-500 px-2 py-1 rounded-full shadow-md whitespace-nowrap z-10";
            pbBadge.textContent = `PB ${pr}kg`;
            weightDiv.appendChild(pbBadge);
        }
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = "button";
        deleteBtn.className = "w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold text-lg sm:text-xl flex-shrink-0";
        deleteBtn.textContent = "√ó";
        deleteBtn.addEventListener('click', () => setRow.remove());
        
        setRow.appendChild(repsInput);
        setRow.appendChild(weightDiv);
        setRow.appendChild(deleteBtn);
        
        container.appendChild(setRow);
    }

    function getPersonalRecord(exerciseName) {
        let maxWeight = 0;
        (state.workoutHistory || []).forEach(workout => {
            (workout.exercises || []).forEach(ex => {
                if (ex.name === exerciseName) {
                    (ex.sets || []).forEach(set => {
                        const weight = parseFloat(set.weight) || parseFloat(set.kg) || 0;
                        if (weight > maxWeight) maxWeight = weight;
                    });
                }
            });
        });
        return maxWeight > 0 ? maxWeight : null;
    }

    function saveWorkout() {
        clearInterval(workoutTimer);
        
        const exercises = [];
        document.querySelectorAll('#exercise-list > div').forEach(card => {
            const nameInput = card.querySelector('input[type="text"]');
            const name = nameInput ? nameInput.value.trim() : '';
            if (!name) return;
            
            const sets = [];
            card.querySelectorAll('.flex.gap-2.items-center.mb-2').forEach(row => {
                const inputs = row.querySelectorAll('input[type="number"]');
                if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                    sets.push({ reps: inputs[0].value, weight: inputs[1].value });
                }
            });
            
            if (sets.length > 0) exercises.push({ name, sets });
        });

        if (exercises.length === 0) {
            showToast('Add at least one exercise with sets');
            return;
        }

        const workoutDate = window.selectedWorkoutDate || document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];

        state.workoutHistory.unshift({
            id: Date.now(),
            date: workoutDate,
            focus: document.getElementById('active-workout-title').innerText,
            duration: document.getElementById('workout-timer').innerText,
            exercises
        });

        saveState();
        document.getElementById('workout-setup').classList.remove('hidden');
        document.getElementById('workout-active').classList.add('hidden');
        renderDashboard();
        showToast('Workout saved! üèãÔ∏è');
    }

    function cancelWorkout() {
        if (confirm('Discard workout?')) {
            clearInterval(workoutTimer);
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
        }
    }

    // Close exercise dropdowns on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.matches('[id^="ex-name-"]') && !e.target.closest('[id^="dropdown-"]')) {
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.classList.add('hidden'));
        }
        if (!e.target.matches('#store-search-input') && !e.target.closest('#store-dropdown')) {
            const sd = document.getElementById('store-dropdown');
            if (sd) sd.classList.add('hidden');
        }
        if (!e.target.matches('#manual-food-store-input') && !e.target.closest('#manual-store-dropdown')) {
            const msd = document.getElementById('manual-store-dropdown');
            if (msd) msd.classList.add('hidden');
        }
    });

    // ==========================================================================
    // DATE MANAGEMENT - TRAINING
    // ==========================================================================

    function changeWorkoutDate(days) {
        const current = document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current);
        date.setDate(date.getDate() + days);
        selectWorkoutDate(date.toISOString().split('T')[0]);
    }

    function selectWorkoutDate(dateStr) {
        document.getElementById('workout-date-picker').value = dateStr;
        window.selectedWorkoutDate = dateStr;
        const today = new Date().toISOString().split('T')[0];
        const warning = document.getElementById('workout-date-warning');
        if (warning) warning.classList.toggle('hidden', dateStr === today);
        lucide.createIcons();
    }

    // ==========================================================================
    // NUTRITION - TAB & DIARY
    // ==========================================================================

    function setNutritionTab(tab) {
        const diaryBtn = document.getElementById('nut-tab-diary');
        const searchBtn = document.getElementById('nut-tab-search');
        if (diaryBtn) diaryBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'diary' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (searchBtn) searchBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;

        const diaryView = document.getElementById('nut-view-diary');
        const searchView = document.getElementById('nut-view-search');
        if (diaryView) diaryView.classList.toggle('hidden', tab !== 'diary');
        if (searchView) searchView.classList.toggle('hidden', tab !== 'search');

        if (tab === 'diary') renderDiary();
        if (tab === 'search') renderCreatedMeals();
    }

    function renderDiary() {
        const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
        const totalCals = todayMeals.reduce((sum, m) => sum + (m.calories || 0), 0);
        const totalProtein = todayMeals.reduce((sum, m) => sum + (m.protein || 0), 0);

        const totalKcalEl = document.getElementById('total-kcal');
        if (totalKcalEl) totalKcalEl.innerText = Math.round(totalCals);
        const totalProteinEl = document.getElementById('total-protein');
        if (totalProteinEl) totalProteinEl.innerText = totalProtein.toFixed(1);

        const sections = ['breakfast', 'lunch', 'dinner', 'snack'];
        let html = '';
        
        sections.forEach(section => {
            const meals = todayMeals.filter(m => m.mealType === section);
            const icons = { breakfast: 'coffee', lunch: 'utensils', dinner: 'moon', snack: 'cookie' };
            
            html += `
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="${icons[section]}" class="w-4 h-4 text-slate-400"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase">${section}</h3>
                    </div>
                    ${meals.length === 0 ? '<p class="text-xs text-slate-300 italic px-4">Nothing logged</p>' : ''}
                    ${meals.map(m => `
                        <div class="bg-white p-4 rounded-[24px] mb-2 border border-slate-100 flex items-center gap-4">
                            <img src="${m.image || 'https://via.placeholder.com/100'}" class="w-12 h-12 object-contain bg-slate-50 rounded-lg p-1 flex-shrink-0" onerror="this.src='https://via.placeholder.com/100'">
                            <div class="flex-1 min-w-0">
                                <p class="font-bold text-sm truncate">${m.name}</p>
                                <p class="text-xs text-slate-400">${m.amount} ‚Ä¢ ${m.calories}kcal ‚Ä¢ ${m.protein}g protein</p>
                            </div>
                            <button onclick="removeMeal(${m.id})" class="text-slate-300 hover:text-red-500 flex-shrink-0">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>`;
        });

        const mealSections = document.getElementById('meal-sections');
        if (mealSections) mealSections.innerHTML = html;
        lucide.createIcons();
    }

    function removeMeal(id) {
        state.dailyMeals = state.dailyMeals.filter(m => m.id !== id);
        saveState();
        renderDiary();
        renderDashboard();
        showToast('Item removed');
    }

    // ==========================================================================
    // DATE MANAGEMENT - NUTRITION
    // ==========================================================================

    function changeNutritionDate(days) {
        const current = document.getElementById('nutrition-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current);
        date.setDate(date.getDate() + days);
        selectNutritionDate(date.toISOString().split('T')[0]);
    }

    function selectNutritionDate(dateStr) {
        state.viewDate = dateStr;
        const picker = document.getElementById('nutrition-date-picker');
        if (picker) picker.value = dateStr;
        const today = new Date().toISOString().split('T')[0];
        const isToday = dateStr === today;
        const warning = document.getElementById('nutrition-date-warning');
        const saveBtns = document.getElementById('nutrition-save-buttons');
        if (warning) warning.classList.toggle('hidden', isToday);
        if (saveBtns) saveBtns.classList.toggle('hidden', isToday);
        renderDiary();
        renderDashboard();
        lucide.createIcons();
    }

    function saveNutritionChanges() {
        const today = new Date().toISOString().split('T')[0];
        if (state.viewDate !== today) {
            const meals = state.dailyMeals.filter(m => m.date === state.viewDate);
            if (meals.length > 0) {
                const totalCals = meals.reduce((sum, m) => sum + (m.calories || 0), 0);
                const totalProtein = meals.reduce((sum, m) => sum + (m.protein || 0), 0);
                state.nutritionHistory = state.nutritionHistory.filter(h => h.date !== state.viewDate);
                state.nutritionHistory.unshift({ date: state.viewDate, calories: totalCals, protein: totalProtein, meals });
            }
        }
        saveState();
        showToast('Changes saved!');
        selectNutritionDate(new Date().toISOString().split('T')[0]);
    }

    function cancelNutritionChanges() {
        loadState();
        selectNutritionDate(new Date().toISOString().split('T')[0]);
        showToast('Changes cancelled');
    }

    // ==========================================================================
    // DATE MANAGEMENT - METRICS
    // ==========================================================================

    function changeMetricsDate(days) {
        const current = document.getElementById('metrics-date-picker').value || new Date().toISOString().split('T')[0];
        const date = new Date(current);
        date.setDate(date.getDate() + days);
        selectMetricsDate(date.toISOString().split('T')[0]);
    }

    function selectMetricsDate(dateStr) {
        state.metricsDate = dateStr;
        const picker = document.getElementById('metrics-date-picker');
        if (picker) picker.value = dateStr;
        const today = new Date().toISOString().split('T')[0];
        const warning = document.getElementById('metrics-date-warning');
        if (warning) warning.classList.toggle('hidden', dateStr === today);

        const existing = state.metricsHistory.find(m => m.date === dateStr);
        if (existing) {
            ['weight', 'chest', 'shoulders', 'arms', 'waist', 'legs', 'glutes'].forEach(field => {
                const el = document.getElementById(`metric-${field}`);
                if (el) el.value = existing[field] || '';
            });
            if (existing.photos) {
                state.currentPhotos = { ...existing.photos };
                ['front', 'side', 'back'].forEach(type => {
                    const img = document.getElementById(`photo-${type}-preview`);
                    if (img) {
                        if (existing.photos[type]) { img.src = existing.photos[type]; img.classList.remove('hidden'); }
                        else img.classList.add('hidden');
                    }
                });
            }
            showToast('Loaded metrics for ' + new Date(dateStr + 'T00:00:00').toLocaleDateString());
        } else {
            ['weight', 'chest', 'shoulders', 'arms', 'waist', 'legs', 'glutes'].forEach(field => {
                const el = document.getElementById(`metric-${field}`);
                if (el) el.value = '';
            });
            state.currentPhotos = { front: null, side: null, back: null };
            ['front', 'side', 'back'].forEach(type => {
                const img = document.getElementById(`photo-${type}-preview`);
                if (img) img.classList.add('hidden');
            });
        }
        lucide.createIcons();
    }

    // ==========================================================================
    // FOOD SEARCH
    // ==========================================================================

    function showStoreDropdown() {
        const dropdown = document.getElementById('store-dropdown');
        if (!dropdown) return;
        dropdown.innerHTML = UK_STORES_RESTAURANTS.map(store => {
            const icon = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : 'üåê';
            return `<div onclick="selectStore('${store.value}', '${store.name.replace(/'/g, "\\'")}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                <span>${icon}</span>
                <span class="font-medium text-sm flex-1">${store.name}</span>
            </div>`;
        }).join('');
        dropdown.classList.remove('hidden');
    }

    function filterStoreDropdown(query) {
        const dropdown = document.getElementById('store-dropdown');
        if (!dropdown) return;
        const filtered = UK_STORES_RESTAURANTS.filter(s => s.name.toLowerCase().includes(query.toLowerCase()));
        if (filtered.length === 0) {
            dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>';
        } else {
            dropdown.innerHTML = filtered.map(store => {
                const icon = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : 'üåê';
                return `<div onclick="selectStore('${store.value}', '${store.name.replace(/'/g, "\\'")}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2">
                    <span>${icon}</span>
                    <span class="font-medium text-sm flex-1">${store.name}</span>
                </div>`;
            }).join('');
        }
        dropdown.classList.remove('hidden');
    }

    function selectStore(value, name) {
        const input = document.getElementById('store-search-input');
        if (input) input.value = name;
        const hidden = document.getElementById('store-select');
        if (hidden) hidden.value = value;
        const dropdown = document.getElementById('store-dropdown');
        if (dropdown) dropdown.classList.add('hidden');
        showToast(`Filter: ${name}`);
        const foodInput = document.getElementById('food-search-input');
        if (foodInput && foodInput.value.trim().length >= 2) searchFood(foodInput.value.trim());
    }

    function clearStoreFilter() {
        const input = document.getElementById('store-search-input');
        if (input) input.value = 'All Stores & Restaurants';
        const hidden = document.getElementById('store-select');
        if (hidden) hidden.value = 'all';
        showToast('Filter cleared');
        const foodInput = document.getElementById('food-search-input');
        if (foodInput && foodInput.value.trim().length >= 2) searchFood(foodInput.value.trim());
    }

    let searchDebounce;
    document.addEventListener('DOMContentLoaded', () => {
        const foodSearchInput = document.getElementById('food-search-input');
        if (foodSearchInput) {
            foodSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchDebounce);
                const query = e.target.value.trim();
                if (query.length < 2) {
                    const resultsList = document.getElementById('search-results-list');
                    if (resultsList) resultsList.innerHTML = '';
                    return;
                }
                searchDebounce = setTimeout(() => searchFood(query), 500);
            });
        }
    });

    async function searchFood(query) {
        const loadingEl = document.getElementById('search-loading');
        const resultsEl = document.getElementById('search-results-list');
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (resultsEl) resultsEl.innerHTML = '';

        try {
            const storeValue = document.getElementById('store-select')?.value || 'all';
            const selectedStore = UK_STORES_RESTAURANTS.find(s => s.value === storeValue);
            let searchResults_temp = [];

            if (storeValue && storeValue !== 'all' && selectedStore) {
                const storeName = selectedStore.name;
                const combinedQuery = `${query} ${storeName}`;
                const isFastFood = selectedStore.type === 'fastfood';

                // OpenFoodFacts search
                try {
                    const offUrl = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(combinedQuery)}&search_simple=1&json=1&page_size=50&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                    const offResponse = await fetch(offUrl);
                    const offData = await offResponse.json();
                    const offResults = (offData.products || []).map(p => ({
                        name: p.product_name || 'Unknown',
                        image: p.image_small_url || 'https://via.placeholder.com/100',
                        calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                        protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1),
                        carbs: parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                        fat: parseFloat(p.nutriments?.fat_100g || 0).toFixed(1),
                        fiber: parseFloat(p.nutriments?.fiber_100g || 0).toFixed(1),
                        sugar: parseFloat(p.nutriments?.sugars_100g || 0).toFixed(1),
                        sodium: parseFloat(p.nutriments?.sodium_100g || 0).toFixed(3),
                        saturated_fat: parseFloat(p.nutriments?.['saturated-fat_100g'] || 0).toFixed(1),
                        cholesterol: parseFloat(p.nutriments?.cholesterol_100g || 0).toFixed(1),
                        serving: p.serving_size || '100g',
                        brand: p.brands || '',
                        source: 'OpenFoodFacts'
                    }));
                    const storeNameLower = storeName.toLowerCase();
                    searchResults_temp = offResults.filter(item =>
                        (item.brand || '').toLowerCase().includes(storeNameLower) ||
                        (item.name || '').toLowerCase().includes(storeNameLower)
                    );
                } catch (e) { console.error('OFF error:', e); }

                // USDA search (for fast food)
                if ((isFastFood && searchResults_temp.length < 10) || searchResults_temp.length === 0) {
                    try {
                        const usdaUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(combinedQuery)}&dataType=Branded&pageSize=30&api_key=DEMO_KEY`;
                        const usdaResponse = await fetch(usdaUrl);
                        const usdaData = await usdaResponse.json();
                        const storeNameLower = storeName.toLowerCase();
                        const usdaResults = (usdaData.foods || [])
                            .filter(f => (f.description || '').toLowerCase().includes(storeNameLower) || (f.brandName || '').toLowerCase().includes(storeNameLower))
                            .map(f => {
                                const nutrients = f.foodNutrients || [];
                                const getN = (names) => {
                                    for (let n of names) {
                                        const found = nutrients.find(x => x.nutrientName?.toLowerCase().includes(n));
                                        if (found) return parseFloat(found.value || 0);
                                    }
                                    return 0;
                                };
                                return {
                                    name: f.description || 'Unknown',
                                    image: 'https://via.placeholder.com/100',
                                    calories: Math.round(getN(['energy', 'calories'])),
                                    protein: getN(['protein']).toFixed(1),
                                    carbs: getN(['carbohydrate']).toFixed(1),
                                    fat: getN(['total lipid', 'total fat']).toFixed(1),
                                    fiber: getN(['fiber']).toFixed(1),
                                    sugar: getN(['sugars']).toFixed(1),
                                    sodium: (getN(['sodium']) / 1000).toFixed(3),
                                    saturated_fat: getN(['saturated']).toFixed(1),
                                    cholesterol: getN(['cholesterol']).toFixed(1),
                                    serving: f.servingSize ? `${f.servingSize}${f.servingSizeUnit || 'g'}` : '100g',
                                    brand: f.brandName || storeName,
                                    source: 'USDA'
                                };
                            });
                        searchResults_temp = [...searchResults_temp, ...usdaResults];
                    } catch (e) { console.error('USDA error:', e); }
                }
            } else {
                // General search
                try {
                    const offUrl = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=20&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                    const offResponse = await fetch(offUrl);
                    const offData = await offResponse.json();
                    searchResults_temp = (offData.products || []).map(p => ({
                        name: p.product_name || 'Unknown',
                        image: p.image_small_url || 'https://via.placeholder.com/100',
                        calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                        protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1),
                        carbs: parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                        fat: parseFloat(p.nutriments?.fat_100g || 0).toFixed(1),
                        fiber: parseFloat(p.nutriments?.fiber_100g || 0).toFixed(1),
                        sugar: parseFloat(p.nutriments?.sugars_100g || 0).toFixed(1),
                        sodium: parseFloat(p.nutriments?.sodium_100g || 0).toFixed(3),
                        saturated_fat: parseFloat(p.nutriments?.['saturated-fat_100g'] || 0).toFixed(1),
                        cholesterol: parseFloat(p.nutriments?.cholesterol_100g || 0).toFixed(1),
                        serving: p.serving_size || '100g',
                        brand: p.brands || '',
                        source: 'OpenFoodFacts'
                    }));
                } catch (e) { console.error('OFF general error:', e); }

                try {
                    const usdaUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&pageSize=10&api_key=DEMO_KEY`;
                    const usdaResponse = await fetch(usdaUrl);
                    const usdaData = await usdaResponse.json();
                    const usdaResults = (usdaData.foods || []).slice(0, 10).map(f => {
                        const nutrients = f.foodNutrients || [];
                        const getN = (names) => {
                            for (let n of names) {
                                const found = nutrients.find(x => x.nutrientName?.toLowerCase().includes(n));
                                if (found) return parseFloat(found.value || 0);
                            }
                            return 0;
                        };
                        return {
                            name: f.description || 'Unknown', image: 'https://via.placeholder.com/100',
                            calories: Math.round(getN(['energy', 'calories'])),
                            protein: getN(['protein']).toFixed(1), carbs: getN(['carbohydrate']).toFixed(1),
                            fat: getN(['total lipid', 'total fat']).toFixed(1), fiber: getN(['fiber']).toFixed(1),
                            sugar: getN(['sugars']).toFixed(1), sodium: (getN(['sodium']) / 1000).toFixed(3),
                            saturated_fat: getN(['saturated']).toFixed(1), cholesterol: getN(['cholesterol']).toFixed(1),
                            serving: '100g', brand: f.brandName || '', source: 'USDA'
                        };
                    });
                    searchResults_temp = [...searchResults_temp, ...usdaResults];
                } catch (e) { console.error('USDA general error:', e); }
            }

            // Deduplicate
            const unique = [];
            const seen = new Set();
            for (const item of searchResults_temp) {
                const key = (item.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                if (!seen.has(key)) { seen.add(key); unique.push(item); }
            }

            // Prepend custom foods matching query
            const customMatches = (state.customFoods || []).filter(f =>
                (f.name || '').toLowerCase().includes(query.toLowerCase()) ||
                (f.brand || '').toLowerCase().includes(query.toLowerCase())
            );

            searchResults = [...customMatches, ...unique];
            renderSearchResults();

        } catch (error) {
            console.error('Search error:', error);
            showToast('Search failed ‚Äî check connection');
        } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
        }
    }

    function renderSearchResults() {
        const storeValue = document.getElementById('store-select')?.value || 'all';
        const selectedStoreName = storeValue !== 'all' ? UK_STORES_RESTAURANTS.find(s => s.value === storeValue)?.name : null;

        let filterMessage = '';
        if (selectedStoreName) {
            filterMessage = `<div class="flex items-center justify-between py-3 mb-3 bg-indigo-50 rounded-2xl px-4">
                <span class="text-indigo-700 text-xs font-bold">Filtering by ${selectedStoreName}</span>
                <button onclick="clearStoreFilter()" class="text-xs font-bold text-red-600 hover:text-red-700">Clear √ó</button>
            </div>`;
        }

        if (searchResults.length === 0) {
            const msg = selectedStoreName
                ? `<div class="text-center py-12"><p class="text-slate-600 font-bold mb-2">No products found from ${selectedStoreName}</p><button onclick="clearStoreFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold mt-3">Search All Stores</button></div>`
                : `<p class="text-center text-slate-400 py-8">No results found</p>`;
            const el = document.getElementById('search-results-list');
            if (el) el.innerHTML = filterMessage + msg;
            lucide.createIcons();
            return;
        }

        const html = searchResults.map((item, idx) => `
            <div onclick="openFoodPopup(${idx})" class="bg-white p-4 rounded-[28px] border ${item.source === 'Custom' ? 'border-purple-200 bg-purple-50' : 'border-slate-100'} flex items-center gap-4 cursor-pointer hover:shadow-lg transition-all">
                <img src="${item.image}" class="w-14 h-14 object-contain bg-slate-50 rounded-xl p-1 flex-shrink-0" onerror="this.src='https://via.placeholder.com/100'">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                        <p class="font-bold text-sm">${item.name}</p>
                        ${item.source === 'Custom' ? `<span class="text-[8px] font-black px-1.5 py-0.5 rounded bg-purple-500 text-white">MY FOOD</span>` : ''}
                        ${item.source && item.source !== 'Custom' ? `<span class="text-[8px] font-black px-1.5 py-0.5 rounded ${item.source === 'USDA' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${item.source}</span>` : ''}
                    </div>
                    ${item.brand ? `<p class="text-[10px] text-indigo-600 font-semibold mb-1">${item.brand}</p>` : ''}
                    <p class="text-xs text-slate-400">${item.calories}kcal ‚Ä¢ ${item.protein}g protein ‚Ä¢ ${item.serving}</p>
                </div>
                <i data-lucide="plus" class="text-emerald-600 flex-shrink-0"></i>
            </div>
        `).join('');

        const el = document.getElementById('search-results-list');
        if (el) el.innerHTML = filterMessage + html;
        lucide.createIcons();
    }

    // ==========================================================================
    // MANUAL FOOD ENTRY
    // ==========================================================================

    function openManualFoodEntry() {
        document.getElementById('manual-food-modal').style.display = 'flex';
        ['manual-food-name', 'manual-food-store-input', 'manual-food-calories', 'manual-food-protein',
         'manual-food-carbs', 'manual-food-fat', 'manual-food-fiber', 'manual-food-sugar'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        const serving = document.getElementById('manual-food-serving');
        if (serving) serving.value = '100g';
        clearManualFoodImage();
        lucide.createIcons();
    }

    function closeManualFoodEntry() {
        document.getElementById('manual-food-modal').style.display = 'none';
        manualFoodImageData = null;
    }

    function previewManualFoodImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            manualFoodImageData = e.target.result;
            const preview = document.getElementById('manual-food-preview');
            if (preview) preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-2xl">`;
        };
        reader.readAsDataURL(file);
    }

    function clearManualFoodImage() {
        manualFoodImageData = null;
        const preview = document.getElementById('manual-food-preview');
        if (preview) preview.innerHTML = '<i data-lucide="image" class="w-10 h-10 text-slate-300"></i>';
        const fileInput = document.getElementById('manual-food-image');
        if (fileInput) fileInput.value = '';
        lucide.createIcons();
    }

    function toggleManualFoodMacros() {
        const macrosDiv = document.getElementById('manual-food-macros');
        const toggleText = document.getElementById('manual-macros-toggle');
        const isHidden = macrosDiv.classList.contains('hidden');
        macrosDiv.classList.toggle('hidden');
        if (toggleText) toggleText.innerText = isHidden ? '- Hide Extra Details' : '+ Add More Details (Optional)';
    }

    function showManualStoreDropdown() {
        const dropdown = document.getElementById('manual-store-dropdown');
        if (!dropdown) return;
        dropdown.innerHTML = UK_STORES_RESTAURANTS.map(store => {
            const icon = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : 'üåê';
            return `<div onclick="selectManualStore('${store.name.replace(/'/g, "\\'")}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2">
                <span>${icon}</span>
                <span class="font-medium text-sm flex-1">${store.name}</span>
            </div>`;
        }).join('');
        dropdown.classList.remove('hidden');
    }

    function filterManualStoreDropdown(query) {
        const dropdown = document.getElementById('manual-store-dropdown');
        if (!dropdown) return;
        const filtered = UK_STORES_RESTAURANTS.filter(s => s.name.toLowerCase().includes(query.toLowerCase()));
        if (filtered.length === 0) {
            dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>';
        } else {
            dropdown.innerHTML = filtered.map(store => {
                const icon = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : 'üåê';
                return `<div onclick="selectManualStore('${store.name.replace(/'/g, "\\'")}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2">
                    <span>${icon}</span>
                    <span class="font-medium text-sm flex-1">${store.name}</span>
                </div>`;
            }).join('');
        }
        dropdown.classList.remove('hidden');
    }

    function selectManualStore(storeName) {
        const input = document.getElementById('manual-food-store-input');
        if (input) input.value = storeName;
        const dropdown = document.getElementById('manual-store-dropdown');
        if (dropdown) dropdown.classList.add('hidden');
    }

    function saveManualFood() {
        const name = document.getElementById('manual-food-name')?.value.trim();
        const store = document.getElementById('manual-food-store-input')?.value.trim();
        const calories = parseFloat(document.getElementById('manual-food-calories')?.value) || 0;
        const protein = parseFloat(document.getElementById('manual-food-protein')?.value) || 0;
        const carbs = parseFloat(document.getElementById('manual-food-carbs')?.value) || 0;
        const fat = parseFloat(document.getElementById('manual-food-fat')?.value) || 0;
        const fiber = parseFloat(document.getElementById('manual-food-fiber')?.value) || 0;
        const sugar = parseFloat(document.getElementById('manual-food-sugar')?.value) || 0;
        const serving = document.getElementById('manual-food-serving')?.value.trim() || '100g';

        if (!name) { showToast('Please enter food name'); return; }
        if (calories === 0 && protein === 0) { showToast('Please enter at least calories or protein'); return; }

        const customFood = {
            id: Date.now(),
            name, brand: store || 'Custom',
            image: manualFoodImageData || 'https://via.placeholder.com/100',
            calories, protein: protein.toFixed(1), carbs: carbs.toFixed(1),
            fat: fat.toFixed(1), fiber: fiber.toFixed(1), sugar: sugar.toFixed(1),
            sodium: '0', saturated_fat: '0', cholesterol: '0', serving, source: 'Custom'
        };

        if (!state.customFoods) state.customFoods = [];
        state.customFoods.push(customFood);
        saveState();
        closeManualFoodEntry();
        showToast(`${name} saved to My Foods!`);

        searchResults.unshift(customFood);
        renderSearchResults();
    }

    // ==========================================================================
    // FOOD POPUP
    // ==========================================================================

    function openFoodPopup(idx) {
        currentFoodItem = searchResults[idx];
        if (!currentFoodItem) return;

        document.getElementById('popup-image').src = currentFoodItem.image || 'https://via.placeholder.com/100';
        document.getElementById('popup-name').innerText = currentFoodItem.name;
        document.getElementById('popup-nutrition').innerText = `Per ${currentFoodItem.serving}${currentFoodItem.source ? ' ‚Ä¢ ' + currentFoodItem.source : ''}`;
        document.getElementById('popup-nutrition-cals').innerText = currentFoodItem.calories;
        document.getElementById('popup-nutrition-protein').innerText = currentFoodItem.protein;
        document.getElementById('popup-nutrition-carbs').innerText = (currentFoodItem.carbs || 0) + 'g';
        document.getElementById('popup-nutrition-fat').innerText = (currentFoodItem.fat || 0) + 'g';
        document.getElementById('popup-nutrition-fiber').innerText = (currentFoodItem.fiber || 0) + 'g';
        document.getElementById('popup-nutrition-sugar').innerText = (currentFoodItem.sugar || 0) + 'g';
        document.getElementById('popup-nutrition-satfat').innerText = (currentFoodItem.saturated_fat || 0) + 'g';
        document.getElementById('popup-nutrition-sodium').innerText = (currentFoodItem.sodium || 0) + 'g';
        document.getElementById('popup-nutrition-cholesterol').innerText = Math.round(currentFoodItem.cholesterol || 0) + 'mg';
        document.getElementById('detailed-nutrition').classList.add('hidden');
        document.getElementById('toggle-text').innerText = 'Show More ‚ñº';
        document.getElementById('popup-amount').value = 1;
        currentAmountType = 'portion';
        setAmountType('portion');
        updateFoodPopup();
        document.getElementById('food-popup').style.display = 'flex';
        lucide.createIcons();
    }

    function toggleDetailedNutrition() {
        const div = document.getElementById('detailed-nutrition');
        const text = document.getElementById('toggle-text');
        const hidden = div.classList.contains('hidden');
        div.classList.toggle('hidden');
        if (text) text.innerText = hidden ? 'Show Less ‚ñ≤' : 'Show More ‚ñº';
    }

    function closeFoodPopup() { document.getElementById('food-popup').style.display = 'none'; }

    function setAmountType(type) {
        currentAmountType = type;
        const portionBtn = document.getElementById('amount-type-portion');
        const gramsBtn = document.getElementById('amount-type-grams');
        if (portionBtn) portionBtn.className = `flex-1 py-3 rounded-xl text-xs font-black uppercase ${type === 'portion' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
        if (gramsBtn) gramsBtn.className = `flex-1 py-3 rounded-xl text-xs font-black uppercase ${type === 'grams' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
        updateFoodPopup();
    }

    function updateFoodPopup() {
        if (!currentFoodItem) return;
        const amount = parseFloat(document.getElementById('popup-amount')?.value) || 0;
        const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
        const totalCals = Math.round(currentFoodItem.calories * multiplier);
        const totalProtein = (parseFloat(currentFoodItem.protein) * multiplier).toFixed(1);
        const totalCalsEl = document.getElementById('popup-total-kcal');
        const totalProteinEl = document.getElementById('popup-total-protein');
        if (totalCalsEl) totalCalsEl.innerText = totalCals;
        if (totalProteinEl) totalProteinEl.innerText = totalProtein + 'g';
    }

    // Add popup amount input listener after DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        const popupAmount = document.getElementById('popup-amount');
        if (popupAmount) popupAmount.addEventListener('input', updateFoodPopup);
    });

    function addFoodItem() {
        if (!currentFoodItem) return;
        const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
        const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
        const mealType = document.getElementById('popup-meal-type').value;

        if (!state.dailyMeals) state.dailyMeals = [];
        state.dailyMeals.push({
            id: Date.now(),
            date: state.viewDate,
            name: currentFoodItem.name,
            image: currentFoodItem.image,
            amount: currentAmountType === 'portion' ? `${amount} portion(s)` : `${amount}g`,
            calories: Math.round(currentFoodItem.calories * multiplier),
            protein: parseFloat((parseFloat(currentFoodItem.protein) * multiplier).toFixed(1)),
            carbs: parseFloat(((parseFloat(currentFoodItem.carbs) || 0) * multiplier).toFixed(1)),
            fat: parseFloat(((parseFloat(currentFoodItem.fat) || 0) * multiplier).toFixed(1)),
            fiber: parseFloat(((parseFloat(currentFoodItem.fiber) || 0) * multiplier).toFixed(1)),
            sugar: parseFloat(((parseFloat(currentFoodItem.sugar) || 0) * multiplier).toFixed(1)),
            sodium: parseFloat(((parseFloat(currentFoodItem.sodium) || 0) * multiplier).toFixed(3)),
            saturated_fat: parseFloat(((parseFloat(currentFoodItem.saturated_fat) || 0) * multiplier).toFixed(1)),
            cholesterol: parseFloat(((parseFloat(currentFoodItem.cholesterol) || 0) * multiplier).toFixed(1)),
            mealType,
            source: currentFoodItem.source || 'Manual'
        });

        saveState();
        closeFoodPopup();
        setNutritionTab('diary');
        renderDashboard();
        showToast('Added to diary! üçΩÔ∏è');
    }

    // ==========================================================================
    // BARCODE SCANNER
    // ==========================================================================

    function openBarcodeScanner() {
        document.getElementById('barcode-scanner-modal').style.display = 'flex';
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("barcode-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (code) => {
                    const barcodeInput = document.getElementById('manual-barcode');
                    if (barcodeInput) barcodeInput.value = code;
                    lookupBarcode();
                }
            ).catch(err => console.error('Scanner start error:', err));
        }
    }

    function closeBarcodeScanner() {
        if (html5QrCode) {
            html5QrCode.stop().catch(() => {});
            html5QrCode = null;
        }
        document.getElementById('barcode-scanner-modal').style.display = 'none';
    }

    async function lookupBarcode() {
        const code = document.getElementById('manual-barcode')?.value.trim();
        if (!code) return;
        try {
            const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
            const data = await response.json();
            if (data.status === 1) {
                const p = data.product;
                searchResults = [{
                    name: p.product_name || 'Unknown',
                    image: p.image_small_url || 'https://via.placeholder.com/100',
                    calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                    protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1),
                    carbs: parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                    fat: parseFloat(p.nutriments?.fat_100g || 0).toFixed(1),
                    fiber: parseFloat(p.nutriments?.fiber_100g || 0).toFixed(1),
                    sugar: parseFloat(p.nutriments?.sugars_100g || 0).toFixed(1),
                    sodium: parseFloat(p.nutriments?.sodium_100g || 0).toFixed(3),
                    saturated_fat: parseFloat(p.nutriments?.['saturated-fat_100g'] || 0).toFixed(1),
                    cholesterol: '0',
                    serving: p.serving_size || '100g',
                    brand: p.brands || '',
                    source: 'OpenFoodFacts'
                }];
                closeBarcodeScanner();
                openFoodPopup(0);
            } else {
                showToast('Product not found');
            }
        } catch (error) {
            showToast('Barcode lookup failed');
        }
    }

    // ==========================================================================
    // CREATED MEALS
    // ==========================================================================

    function renderCreatedMeals() {
        const html = (state.createdMeals || []).map((meal, idx) => `
            <div class="bg-white p-4 rounded-[28px] border border-slate-100 flex items-center gap-4 transition-all">
                <div class="w-14 h-14 bg-emerald-50 rounded-xl flex items-center justify-center flex-shrink-0">
                    <i data-lucide="chef-hat" class="text-emerald-600 w-7 h-7"></i>
                </div>
                <div class="flex-1 min-w-0 cursor-pointer" onclick="addCreatedMeal(${idx})">
                    <p class="font-bold text-sm truncate">${meal.name}</p>
                    <p class="text-xs text-slate-400">${meal.calories}kcal ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.ingredients.length} ingredients</p>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button onclick="addCreatedMeal(${idx})" class="w-9 h-9 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 flex items-center justify-center">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                    <button onclick="editCreatedMeal(${idx})" class="w-9 h-9 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 flex items-center justify-center">
                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteCreatedMeal(${idx})" class="w-9 h-9 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 flex items-center justify-center">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `).join('');
        const list = document.getElementById('created-meals-list');
        if (list) list.innerHTML = html || '<p class="text-center text-slate-400 py-8 text-sm">No custom meals created yet</p>';
        lucide.createIcons();
    }

    function addCreatedMeal(idx) {
        const meal = state.createdMeals[idx];
        if (!meal) return;
        if (!state.dailyMeals) state.dailyMeals = [];
        state.dailyMeals.push({
            id: Date.now(), date: state.viewDate, name: meal.name,
            image: 'https://via.placeholder.com/100', amount: '1 meal',
            calories: meal.calories, protein: meal.protein, mealType: 'dinner'
        });
        saveState();
        setNutritionTab('diary');
        renderDashboard();
        showToast('Meal added! üçΩÔ∏è');
    }

    function editCreatedMeal(idx) {
        const meal = state.createdMeals[idx];
        const nameInput = document.getElementById('meal-name-input');
        if (nameInput) nameInput.value = meal.name;
        mealIngredients = [...meal.ingredients];
        renderMealIngredients();
        document.getElementById('create-meal-modal').style.display = 'flex';
        window.editingMealIndex = idx;
        const title = document.querySelector('#create-meal-modal h3');
        if (title) title.textContent = 'Edit Meal';
        lucide.createIcons();
    }

    function deleteCreatedMeal(idx) {
        const meal = state.createdMeals[idx];
        if (confirm(`Delete "${meal.name}"?`)) {
            state.createdMeals.splice(idx, 1);
            saveState();
            renderCreatedMeals();
            showToast('Meal deleted');
        }
    }

    function openCreateMeal() {
        mealIngredients = [];
        const nameInput = document.getElementById('meal-name-input');
        if (nameInput) nameInput.value = '';
        renderMealIngredients();
        document.getElementById('create-meal-modal').style.display = 'flex';
        window.editingMealIndex = null;
        const title = document.querySelector('#create-meal-modal h3');
        if (title) title.textContent = 'Create Meal';
        lucide.createIcons();
    }

    function closeCreateMeal() {
        document.getElementById('create-meal-modal').style.display = 'none';
        window.editingMealIndex = null;
    }

    let mealSearchDebounce;
    document.addEventListener('DOMContentLoaded', () => {
        const mealSearch = document.getElementById('meal-ingredient-search');
        if (mealSearch) {
            mealSearch.addEventListener('input', (e) => {
                clearTimeout(mealSearchDebounce);
                const query = e.target.value.trim();
                if (query.length < 2) { document.getElementById('meal-search-results').innerHTML = ''; return; }
                mealSearchDebounce = setTimeout(() => searchMealIngredient(query), 500);
            });
        }
    });

    async function searchMealIngredient(query) {
        try {
            const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=10&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
            const response = await fetch(url);
            const data = await response.json();
            const results = (data.products || []).map(p => ({
                name: p.product_name || 'Unknown',
                image: p.image_small_url || 'https://via.placeholder.com/100',
                calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1)
            }));

            const html = results.map((item, idx) => `
                <div onclick="promptAddIngredient('${item.name.replace(/'/g, "\\'")}', ${item.calories}, ${item.protein}, '${item.image}')" class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-slate-100">
                    <img src="${item.image}" class="w-10 h-10 object-contain rounded" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-xs truncate">${item.name}</p>
                        <p class="text-[10px] text-slate-400">${item.calories}kcal, ${item.protein}g protein</p>
                    </div>
                </div>
            `).join('');
            const resultsEl = document.getElementById('meal-search-results');
            if (resultsEl) resultsEl.innerHTML = html;
        } catch (e) { console.error('Ingredient search error:', e); }
    }

    function promptAddIngredient(name, calories, protein, image) {
        const amount = prompt('Enter amount (in grams):', '100');
        if (!amount) return;
        const multiplier = parseFloat(amount) / 100;
        mealIngredients.push({
            name, amount: `${amount}g`,
            calories: Math.round(calories * multiplier),
            protein: parseFloat((protein * multiplier).toFixed(1))
        });
        renderMealIngredients();
        const search = document.getElementById('meal-ingredient-search');
        if (search) search.value = '';
        const results = document.getElementById('meal-search-results');
        if (results) results.innerHTML = '';
    }

    function renderMealIngredients() {
        const html = mealIngredients.map((ing, idx) => `
            <div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between">
                <div>
                    <p class="font-bold text-xs">${ing.name}</p>
                    <p class="text-[10px] text-slate-400">${ing.amount} ‚Ä¢ ${ing.calories}kcal ‚Ä¢ ${ing.protein}g protein</p>
                </div>
                <button onclick="mealIngredients.splice(${idx}, 1); renderMealIngredients();" class="text-slate-300 hover:text-red-500 text-xl font-bold">√ó</button>
            </div>
        `).join('');
        const list = document.getElementById('meal-ingredients-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-300 italic">No ingredients yet</p>';
    }

    function saveMeal() {
        const name = document.getElementById('meal-name-input')?.value.trim();
        if (!name) { showToast('Please enter meal name'); return; }
        if (mealIngredients.length === 0) { showToast('Add at least one ingredient'); return; }

        const totalCals = mealIngredients.reduce((s, i) => s + i.calories, 0);
        const totalProtein = mealIngredients.reduce((s, i) => s + i.protein, 0);

        const mealData = { id: Date.now(), name, calories: totalCals, protein: totalProtein, ingredients: [...mealIngredients] };

        if (!state.createdMeals) state.createdMeals = [];

        if (window.editingMealIndex !== null && window.editingMealIndex !== undefined) {
            mealData.id = state.createdMeals[window.editingMealIndex].id;
            state.createdMeals[window.editingMealIndex] = mealData;
            showToast('Meal updated!');
        } else {
            state.createdMeals.push(mealData);
            showToast('Meal saved!');
        }

        saveState();
        closeCreateMeal();
        renderCreatedMeals();
    }

    // ==========================================================================
    // LOGS
    // ==========================================================================

    function setLogsTab(tab) {
        const trainingBtn = document.getElementById('logs-tab-training');
        const nutritionBtn = document.getElementById('logs-tab-nutrition');
        if (trainingBtn) trainingBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'training' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        if (nutritionBtn) nutritionBtn.className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'nutrition' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;

        const trainingView = document.getElementById('logs-training-view');
        const nutritionView = document.getElementById('logs-nutrition-view');
        if (trainingView) trainingView.classList.toggle('hidden', tab !== 'training');
        if (nutritionView) nutritionView.classList.toggle('hidden', tab !== 'nutrition');

        if (tab === 'nutrition') renderHydrationLogs();
        else filterWorkouts();
        renderLogs();
    }

    function renderLogs() {
        // Nutrition logs
        const nutritionHtml = (state.nutritionHistory || []).length === 0
            ? '<p class="text-center text-slate-400 py-10">No nutrition logs yet</p>'
            : (state.nutritionHistory || []).map(n => `
                <div class="glass-card p-5 rounded-2xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${n.date}</h4>
                            <p class="text-xs text-slate-400">${n.meals?.length || 0} items logged</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold">${Math.round(n.calories || 0)} kcal</p>
                            <p class="text-xs text-blue-600">${(n.protein || 0).toFixed(1)}g protein</p>
                        </div>
                    </div>
                </div>
            `).join('');
        const nutritionLogsEl = document.getElementById('nutrition-logs-list');
        if (nutritionLogsEl) nutritionLogsEl.innerHTML = nutritionHtml;
    }

    function filterWorkouts() {
        const showWeights = document.getElementById('filter-weights')?.checked ?? true;
        const showCardio = document.getElementById('filter-cardio')?.checked ?? true;
        const showCore = document.getElementById('filter-core')?.checked ?? true;
        const showWalking = document.getElementById('filter-walking')?.checked ?? true;
        renderTrainingLogs(showWeights, showCardio, showCore, showWalking);
    }

    function renderTrainingLogs(showWeights = true, showCardio = true, showCore = true, showWalking = true) {
        const filtered = (state.workoutHistory || []).filter(w => {
            const category = w.category || 'weights';
            const focus = (w.focus || '').toLowerCase();
            if (category === 'cardio') {
                const isWalking = ((w.cardioData?.type || '') + focus).includes('walk');
                return isWalking ? showWalking : showCardio;
            }
            if (focus.includes('core')) return showCore;
            return showWeights;
        });

        const html = filtered.length === 0
            ? '<p class="text-center text-slate-400 py-10">No workouts logged yet</p>'
            : filtered.map(w => `
                <div class="glass-card p-6 rounded-2xl">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs text-slate-400">${w.date}</p>
                            <h4 class="font-black text-lg">${w.focus}</h4>
                            ${w.cardioData ? `
                                <p class="text-sm text-indigo-600 mt-1">
                                    ${w.cardioData.distance || 0}km ‚Ä¢ ${w.cardioData.duration || 0}min
                                    ${w.cardioData.calories ? ` ‚Ä¢ ${w.cardioData.calories}kcal` : ''}
                                </p>
                            ` : `<p class="text-sm text-slate-500">${(w.exercises || []).length} exercises ‚Ä¢ ${w.duration}</p>`}
                        </div>
                    </div>
                    ${!w.cardioData && (w.exercises || []).length > 0 ? `
                        <div class="text-xs text-slate-400 mt-2">
                            ${(w.exercises || []).slice(0, 3).map(e => e.name).join(' ‚Ä¢ ')}${(w.exercises || []).length > 3 ? ` +${(w.exercises || []).length - 3} more` : ''}
                        </div>
                    ` : ''}
                    ${w.cardioData?.notes ? `<p class="text-xs text-slate-500 mt-2 italic">${w.cardioData.notes}</p>` : ''}
                </div>
            `).join('');

        const listEl = document.getElementById('training-logs-list');
        if (listEl) listEl.innerHTML = html;
        lucide.createIcons();
    }

    // ==========================================================================
    // BODY METRICS
    // ==========================================================================

    function triggerPhotoUpload(type) {
        currentPhotoType = type;
        const input = document.getElementById('photo-upload-input');
        if (input) input.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const photoUpload = document.getElementById('photo-upload-input');
        if (photoUpload) {
            photoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file || !currentPhotoType) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const maxSize = 800;
                        let { width, height } = img;
                        if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
                        else if (height > width && height > maxSize) { width *= maxSize / height; height = maxSize; }
                        canvas.width = width; canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        const compressed = canvas.toDataURL('image/jpeg', 0.7);
                        if (!state.currentPhotos) state.currentPhotos = {};
                        state.currentPhotos[currentPhotoType] = compressed;
                        const preview = document.getElementById(`photo-${currentPhotoType}-preview`);
                        if (preview) { preview.src = compressed; preview.classList.remove('hidden'); }
                        showToast(`${currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1)} photo added`);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
    });

    function saveMetrics() {
        const weight = parseFloat(document.getElementById('metric-weight')?.value);
        if (!weight) { showToast('Please enter weight'); return; }

        const metricsDate = state.metricsDate || new Date().toISOString().split('T')[0];
        const existingIndex = (state.metricsHistory || []).findIndex(m => m.date === metricsDate);

        const metricsData = {
            id: existingIndex >= 0 ? state.metricsHistory[existingIndex].id : Date.now(),
            date: metricsDate,
            weight,
            chest: parseFloat(document.getElementById('metric-chest')?.value) || 0,
            shoulders: parseFloat(document.getElementById('metric-shoulders')?.value) || 0,
            arms: parseFloat(document.getElementById('metric-arms')?.value) || 0,
            waist: parseFloat(document.getElementById('metric-waist')?.value) || 0,
            legs: parseFloat(document.getElementById('metric-legs')?.value) || 0,
            glutes: parseFloat(document.getElementById('metric-glutes')?.value) || 0,
            photos: { ...state.currentPhotos }
        };

        if (!state.metricsHistory) state.metricsHistory = [];
        if (existingIndex >= 0) {
            state.metricsHistory[existingIndex] = metricsData;
            showToast('Metrics updated!');
        } else {
            state.metricsHistory.unshift(metricsData);
            showToast('Metrics saved! üìä');
        }

        saveState();
        renderDashboard();
        populateComparisonDates();

        ['weight', 'chest', 'shoulders', 'arms', 'waist', 'legs', 'glutes'].forEach(f => {
            const el = document.getElementById(`metric-${f}`);
            if (el) el.value = '';
        });
        state.currentPhotos = { front: null, side: null, back: null };
        ['front', 'side', 'back'].forEach(t => {
            const img = document.getElementById(`photo-${t}-preview`);
            if (img) img.classList.add('hidden');
        });

        const today = new Date().toISOString().split('T')[0];
        if (metricsDate !== today) selectMetricsDate(today);
    }

    function populateComparisonDates() {
        const dates = (state.metricsHistory || [])
            .filter(m => m.photos && (m.photos.front || m.photos.side || m.photos.back))
            .map(m => ({ date: m.date, id: m.id }));
        const html = '<option value="">Select date...</option>' + dates.map(d => `<option value="${d.id}">${d.date}</option>`).join('');
        const d1 = document.getElementById('compare-date-1');
        const d2 = document.getElementById('compare-date-2');
        if (d1) d1.innerHTML = html;
        if (d2) d2.innerHTML = html;
    }

    let currentComparePhotoType = 'front';

    function setComparePhotoType(type) {
        currentComparePhotoType = type;
        ['front', 'side', 'back'].forEach(t => {
            const btn = document.getElementById(`compare-type-${t}`);
            if (btn) btn.className = `p-4 rounded-2xl font-bold text-sm ${t === type ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}`;
        });
        loadComparisonPhotos();
    }

    function loadComparisonPhotos() {
        const id1 = document.getElementById('compare-date-1')?.value;
        const id2 = document.getElementById('compare-date-2')?.value;

        if (!id1 || !id2) {
            document.getElementById('comparison-view')?.classList.add('hidden');
            document.getElementById('no-comparison-message')?.classList.remove('hidden');
            return;
        }

        const m1 = state.metricsHistory.find(m => String(m.id) === String(id1));
        const m2 = state.metricsHistory.find(m => String(m.id) === String(id2));
        if (!m1 || !m2) return;

        const p1 = m1.photos?.[currentComparePhotoType];
        const p2 = m2.photos?.[currentComparePhotoType];

        if (p1 && p2) {
            document.getElementById('compare-img-1').src = p1;
            document.getElementById('compare-img-2').src = p2;
            document.getElementById('compare-label-1').textContent = m1.date;
            document.getElementById('compare-label-2').textContent = m2.date;
            document.getElementById('comparison-view')?.classList.remove('hidden');
            document.getElementById('no-comparison-message')?.classList.add('hidden');
        } else {
            document.getElementById('comparison-view')?.classList.add('hidden');
            document.getElementById('no-comparison-message')?.classList.remove('hidden');
            showToast('No photos for that angle on selected dates');
        }
    }

    function openMetricsChart() {
        document.getElementById('metrics-chart-modal').style.display = 'flex';
        setTimeout(() => renderMetricChart(), 100);
        lucide.createIcons();
    }

    function closeMetricsChart() { document.getElementById('metrics-chart-modal').style.display = 'none'; }

    function openPhotoComparison() {
        populateComparisonDates();
        currentComparePhotoType = 'front';
        setComparePhotoType('front');
        document.getElementById('photo-comparison-modal').style.display = 'flex';
        document.getElementById('comparison-view')?.classList.add('hidden');
        document.getElementById('no-comparison-message')?.classList.remove('hidden');
        lucide.createIcons();
    }

    function closePhotoComparison() { document.getElementById('photo-comparison-modal').style.display = 'none'; }

    function renderMetricChart() {
        const metric = document.getElementById('chart-metric-select')?.value || 'weight';
        const history = [...(state.metricsHistory || [])].reverse();
        const labels = history.map(m => new Date(m.date + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }));
        const data = history.map(m => m[metric] || 0);

        if (metricsChart) metricsChart.destroy();
        const ctx = document.getElementById('metrics-chart');
        if (!ctx) return;

        metricsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: metric.charAt(0).toUpperCase() + metric.slice(1),
                    data,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderWidth: 2,
                    pointBorderColor: '#6366f1'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 11 } } },
                    x: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } }
                }
            }
        });
    }

    // ==========================================================================
    // SETTINGS
    // ==========================================================================

    function updateCalorieGoal(value) {
        if (!state.goals) state.goals = {};
        state.goals.calories = Number(value);
        saveState();
        renderDashboard();
        showToast('Goal updated');
    }

    function saveSettings() {
        const goalInput = document.getElementById('calorie-goal-input');
        if (goalInput && goalInput.value) {
            if (!state.goals) state.goals = {};
            state.goals.calories = Number(goalInput.value);
        }
        saveState();
        renderDashboard();
        showToast('Settings saved ‚úì');
    }

    function renderSettings() {
        const goalInput = document.getElementById('calorie-goal-input');
        if (goalInput) goalInput.value = (state.goals && state.goals.calories) ? state.goals.calories : 2500;

        // Gym equipment
        const gymHtml = Object.keys(state.equipment.gym).map(eq => `
            <button onclick="toggleEquipment('gym', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase transition-all ${state.equipment.gym[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                ${eq}
            </button>
        `).join('');
        const gymList = document.getElementById('gym-equipment-list');
        if (gymList) gymList.innerHTML = gymHtml;

        // Home equipment
        const homeHtml = Object.keys(state.equipment.home).map(eq => `
            <button onclick="toggleEquipment('home', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase transition-all ${state.equipment.home[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                ${eq}
            </button>
        `).join('');
        const homeList = document.getElementById('home-equipment-list');
        if (homeList) homeList.innerHTML = homeHtml;

        // Habits
        const habitsEnabled = document.getElementById('habits-enabled');
        if (habitsEnabled) habitsEnabled.checked = state.habitsEnabled || false;
        document.getElementById('habits-section')?.classList.toggle('hidden', !state.habitsEnabled);
        document.getElementById('habits-tracker')?.classList.toggle('hidden', !state.habitsEnabled);
        if (state.habitsEnabled) { renderHabitsSettings(); renderDashboardHabits(); }

        // Tracking toggles
        const hydrationToggle = document.getElementById('track-hydration');
        const stepsToggle = document.getElementById('track-steps');
        if (hydrationToggle) hydrationToggle.checked = state.trackHydration !== false;
        if (stepsToggle) stepsToggle.checked = state.trackSteps !== false;

        // Goals
        renderGoals();
    }

    function toggleEquipment(env, equipment) {
        if (!state.equipment[env]) state.equipment[env] = {};
        state.equipment[env][equipment] = !state.equipment[env][equipment];
        saveState();
        renderSettings();
    }

    // ==========================================================================
    // HABITS
    // ==========================================================================

    function toggleHabits() {
        state.habitsEnabled = document.getElementById('habits-enabled').checked;
        document.getElementById('habits-section')?.classList.toggle('hidden', !state.habitsEnabled);
        document.getElementById('habits-tracker')?.classList.toggle('hidden', !state.habitsEnabled);
        saveState();
        if (state.habitsEnabled) { renderHabitsSettings(); renderDashboardHabits(); }
    }

    function addHabit() {
        const input = document.getElementById('new-habit-input');
        const name = input?.value.trim();
        if (!name) return;
        if (!state.habits) state.habits = [];
        state.habits.push({ id: Date.now(), name });
        if (input) input.value = '';
        saveState();
        renderHabitsSettings();
        renderDashboardHabits();
        showToast('Habit added!');
    }

    function removeHabit(id) {
        state.habits = (state.habits || []).filter(h => h.id !== id);
        saveState();
        renderHabitsSettings();
        renderDashboardHabits();
    }

    function renderHabitsSettings() {
        const html = (state.habits || []).map(habit => `
            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                <span class="font-medium text-sm">${habit.name}</span>
                <button onclick="removeHabit(${habit.id})" class="text-red-500 hover:bg-red-50 rounded-lg p-2">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
        const list = document.getElementById('habits-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-400 italic text-center py-4">No habits added yet</p>';
        lucide.createIcons();
    }

    function toggleHabitCompletion(habitId) {
        const today = state.viewDate;
        if (!state.habitCompletions) state.habitCompletions = {};
        if (!state.habitCompletions[today]) state.habitCompletions[today] = {};
        state.habitCompletions[today][habitId] = !state.habitCompletions[today][habitId];
        saveState();
        renderDashboardHabits();
    }

    function renderDashboardHabits() {
        const today = state.viewDate;
        const completions = (state.habitCompletions && state.habitCompletions[today]) || {};
        const html = (state.habits || []).map(habit => {
            const done = completions[habit.id] || false;
            return `
                <div class="flex items-center gap-3 p-4 bg-white rounded-xl border-2 ${done ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100'} transition-all">
                    <button onclick="toggleHabitCompletion(${habit.id})" class="w-7 h-7 rounded-lg ${done ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-300'} flex items-center justify-center transition-all flex-shrink-0">
                        <i data-lucide="${done ? 'check' : 'circle'}" class="w-4 h-4"></i>
                    </button>
                    <span class="flex-1 font-medium text-sm ${done ? 'text-emerald-900 line-through' : 'text-slate-900'}">${habit.name}</span>
                </div>`;
        }).join('');
        const list = document.getElementById('dashboard-habits-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-400 italic text-center py-4">No habits to track today</p>';
        lucide.createIcons();
    }

    // ==========================================================================
    // TRACKING TOGGLES
    // ==========================================================================

    function toggleTracking(type) {
        if (type === 'hydration') {
            state.trackHydration = document.getElementById('track-hydration').checked;
            document.getElementById('hydration-tracker')?.classList.toggle('hidden', !state.trackHydration);
        } else if (type === 'steps') {
            state.trackSteps = document.getElementById('track-steps').checked;
            document.getElementById('steps-tracker')?.classList.toggle('hidden', !state.trackSteps);
        }
        saveState();
        renderDashboard();
    }

    // ==========================================================================
    // GOAL SETTING
    // ==========================================================================

    function openGoalSetting() {
        document.getElementById('goal-modal').style.display = 'flex';
        const desc = document.getElementById('goal-description');
        const deadline = document.getElementById('goal-deadline');
        if (desc) desc.value = '';
        if (deadline) deadline.value = '';
        lucide.createIcons();
    }

    function closeGoalModal() { document.getElementById('goal-modal').style.display = 'none'; }

    function saveGoal() {
        const type = document.getElementById('goal-type')?.value;
        const description = document.getElementById('goal-description')?.value.trim();
        const deadline = document.getElementById('goal-deadline')?.value;
        if (!description || !deadline) { showToast('Please fill all fields'); return; }

        if (!state.userGoals) state.userGoals = [];
        state.userGoals.push({ id: Date.now(), type, description, deadline, completed: false, createdAt: new Date().toISOString() });

        saveState();
        closeGoalModal();
        renderGoals();
        showToast('Goal added! üéØ');
    }

    function renderGoals() {
        const typeColors = { short: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', long: 'bg-purple-100 text-purple-700' };
        const typeLabels = { short: 'Short-term', medium: 'Medium-term', long: 'Long-term' };

        const html = (state.userGoals || []).filter(g => !g.completed).map(goal => `
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                <div class="flex-1">
                    <span class="text-[9px] font-black ${typeColors[goal.type] || 'bg-slate-100 text-slate-600'} px-2 py-1 rounded uppercase">${typeLabels[goal.type] || goal.type}</span>
                    <p class="font-bold text-sm mt-2">${goal.description}</p>
                    <p class="text-xs text-slate-400 mt-1">Due: ${new Date(goal.deadline + 'T00:00:00').toLocaleDateString()}</p>
                </div>
                <div class="flex gap-2 flex-shrink-0 ml-3">
                    <button onclick="completeGoal(${goal.id})" class="w-8 h-8 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 flex items-center justify-center">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteGoal(${goal.id})" class="w-8 h-8 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 flex items-center justify-center">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `).join('');
        const list = document.getElementById('goals-list');
        if (list) list.innerHTML = html || '<p class="text-xs text-slate-400 text-center py-4">No active goals</p>';
        lucide.createIcons();
    }

    function completeGoal(id) {
        const goal = (state.userGoals || []).find(g => g.id === id);
        if (goal) { goal.completed = true; saveState(); renderGoals(); showToast('Goal completed! üéâ'); }
    }

    function deleteGoal(id) {
        state.userGoals = (state.userGoals || []).filter(g => g.id !== id);
        saveState();
        renderGoals();
    }

    // ==========================================================================
    // CARDIO LOGGING
    // ==========================================================================

    function openCardioModal() {
        document.getElementById('cardio-modal').style.display = 'flex';
        ['cardio-duration', 'cardio-distance', 'cardio-calories'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        const notes = document.getElementById('cardio-notes');
        if (notes) notes.value = '';
        lucide.createIcons();
    }

    function closeCardioModal() { document.getElementById('cardio-modal').style.display = 'none'; }

    function saveCardio() {
        const type = document.getElementById('cardio-type')?.value;
        const duration = parseFloat(document.getElementById('cardio-duration')?.value);
        const distance = parseFloat(document.getElementById('cardio-distance')?.value) || 0;
        const calories = parseFloat(document.getElementById('cardio-calories')?.value) || 0;
        const notes = document.getElementById('cardio-notes')?.value.trim() || '';
        const workoutDate = window.selectedWorkoutDate || document.getElementById('workout-date-picker')?.value || new Date().toISOString().split('T')[0];

        if (!duration) { showToast('Please enter duration'); return; }

        const cardioActivity = { id: Date.now(), date: workoutDate, type, duration, distance, calories, notes, category: 'cardio' };

        if (!state.cardioLogs) state.cardioLogs = [];
        state.cardioLogs.push(cardioActivity);

        if (!state.workoutHistory) state.workoutHistory = [];
        state.workoutHistory.unshift({
            id: Date.now(),
            date: workoutDate,
            focus: `${type.charAt(0).toUpperCase() + type.slice(1)} Cardio`,
            duration: `${duration} min`,
            exercises: [{ name: type.charAt(0).toUpperCase() + type.slice(1), sets: [{ reps: duration, weight: distance }] }],
            category: 'cardio',
            cardioData: cardioActivity
        });

        saveState();
        closeCardioModal();
        renderDashboard();
        showToast('Cardio logged! üèÉ');
    }

    // ==========================================================================
    // HYDRATION LOGS
    // ==========================================================================

    function renderHydrationLogs() {
        const logs = Object.entries(state.hydrationLogs || {}).sort(([a], [b]) => b.localeCompare(a)).slice(0, 30);
        const html = logs.length === 0
            ? '<p class="text-xs text-slate-400 text-center py-4">No hydration logs</p>'
            : logs.map(([date, ml]) => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                    <span class="text-sm font-bold">${new Date(date + 'T00:00:00').toLocaleDateString()}</span>
                    <span class="text-sm text-cyan-600 font-bold">${ml}ml</span>
                </div>
            `).join('');
        const list = document.getElementById('hydration-logs-list');
        if (list) list.innerHTML = html;
    }

    // ==========================================================================
    // EXERCISE DEMONSTRATION
    // ==========================================================================

    const EXERCISE_DEMO_DB = {
        'Bench Press': {
            video: 'https://www.youtube.com/embed/rT7DgCr-3pg',
            instructions: ['Lie flat on bench with feet firmly on floor','Grip bar slightly wider than shoulder width','Lower bar to mid-chest in controlled motion','Press bar up until arms fully extended','Keep shoulder blades retracted throughout'],
            muscles: ['Chest', 'Triceps', 'Shoulders'],
            tips: ["Keep your back slightly arched","Don't bounce the bar off your chest","Breathe in on descent, out on press"]
        },
        'Pull Ups': {
            video: 'https://www.youtube.com/embed/eGo4IYlbE5g',
            instructions: ['Hang from bar with hands shoulder-width or wider','Pull body up until chin clears bar','Keep chest up and shoulders back','Lower with control to full extension','Avoid swinging or kipping'],
            muscles: ['Lats', 'Biceps', 'Upper Back'],
            tips: ['Lead with chest, not chin','Use resistance band for assistance if needed','Full dead hang at bottom']
        },
        'Barbell Squat': {
            video: 'https://www.youtube.com/embed/ultWZbUMPL8',
            instructions: ['Bar on upper back, feet shoulder-width','Chest up, core braced','Descend by pushing hips back and knees out','Go to parallel or slightly below','Drive through mid-foot to stand'],
            muscles: ['Quads', 'Glutes', 'Hamstrings', 'Core'],
            tips: ['Knees should track over toes','Keep heels down',"Don't round lower back"]
        },
        'Deadlift': {
            video: 'https://www.youtube.com/embed/op9kVnSso6Q',
            instructions: ['Feet hip-width, bar over mid-foot','Grip bar just outside legs','Chest up, back straight, shoulders over bar','Drive through heels, extend hips and knees','Stand fully upright at top'],
            muscles: ['Back', 'Glutes', 'Hamstrings', 'Core'],
            tips: ['Keep bar close to body throughout',"Don't round your back",'Breathe and brace before each rep']
        },
        'Overhead Press': {
            video: 'https://www.youtube.com/embed/QAQ64hK4Xxs',
            instructions: ['Bar at shoulder height, grip shoulder-width','Brace core and glutes','Press bar straight up overhead','Move head back slightly as bar passes','Lock out arms at top'],
            muscles: ['Shoulders', 'Triceps', 'Upper Chest'],
            tips: ["Don't arch back excessively",'Press in straight line','Squeeze glutes to stay stable']
        },
        'Romanian Deadlift': {
            video: 'https://www.youtube.com/embed/hNPvI7JNqKk',
            instructions: ['Hold bar with shoulder-width grip','Keep slight knee bend','Hinge at hips, bar close to legs','Lower until hamstrings stretch','Drive hips forward to stand'],
            muscles: ['Hamstrings', 'Glutes', 'Lower Back'],
            tips: ['Feel stretch in hamstrings','Keep back flat',"Don't bend knees more"]
        },
        'Hip Thrust': {
            video: 'https://www.youtube.com/embed/LM8XHLYJoYs',
            instructions: ['Upper back on bench','Bar across hips','Feet flat on floor','Drive hips up','Squeeze glutes at top'],
            muscles: ['Glutes', 'Hamstrings'],
            tips: ['Best glute exercise','Use pad on bar','Full hip extension']
        },
        'Lateral Raise': {
            video: 'https://www.youtube.com/embed/3VcKaXpzqRo',
            instructions: ['Stand with dumbbells at sides','Raise arms out to sides to shoulder height','Lead with elbows, slight bend throughout','Lower with control','Keep torso still'],
            muscles: ['Side Delts'],
            tips: ["Don't swing or use momentum",'Thumbs slightly down at top','Control the descent']
        },
        'Bicep Curl': {
            video: 'https://www.youtube.com/embed/kwG2ipFRgfo',
            instructions: ['Stand with barbell or dumbbells','Keep elbows close to torso','Curl bar up toward shoulders','Squeeze biceps at top','Lower with control'],
            muscles: ['Biceps', 'Forearms'],
            tips: ["Don't swing or use back",'Keep elbows stationary','Full extension at bottom']
        },
        'Tricep Pushdown': {
            video: 'https://www.youtube.com/embed/2-LAMcpzODU',
            instructions: ['Stand facing cable machine','Grip bar with overhand grip','Elbows at sides','Push down until arms straight','Return with control'],
            muscles: ['Triceps'],
            tips: ['Keep elbows tucked','Full lockout',"Don't lean forward"]
        },
        'Leg Press': {
            video: 'https://www.youtube.com/embed/IZxyjW7MPJQ',
            instructions: ['Sit in machine, feet shoulder-width','Release safety handles','Lower platform with control','Go until knees at 90 degrees','Press back up'],
            muscles: ['Quads', 'Glutes', 'Hamstrings'],
            tips: ["Don't lock knees",'Keep lower back on pad','Full range of motion']
        },
        'Plank': {
            video: 'https://www.youtube.com/embed/ASdvN_XEl_c',
            instructions: ['Start in push-up position on forearms','Keep body in straight line from head to heels','Engage core, glutes, and quads','Hold position','Breathe steadily'],
            muscles: ['Core', 'Shoulders', 'Glutes'],
            tips: ["Don't let hips sag or pike",'Breathe steadily','Start with 30 seconds']
        },
        'Push Ups': {
            video: 'https://www.youtube.com/embed/IODxDxX7oi4',
            instructions: ['Start in plank position, hands shoulder-width','Keep body in straight line from head to heels','Lower chest to floor, elbows at 45 degrees','Push back up to starting position','Engage core throughout'],
            muscles: ['Chest', 'Triceps', 'Core', 'Shoulders'],
            tips: ["Don't let hips sag",'Full range of motion','Start with knees down if needed']
        },
        'Dips': {
            video: 'https://www.youtube.com/embed/2z8JmcrW-As',
            instructions: ['Grip parallel bars shoulder-width','Support body with arms straight','Lower by bending elbows','Go until upper arms parallel to floor','Press back up'],
            muscles: ['Chest', 'Triceps', 'Shoulders'],
            tips: ['Lean forward for chest','Keep shoulders down','Full lockout at top']
        },
        'Lunges': {
            video: 'https://www.youtube.com/embed/QOVaHwm-Q6U',
            instructions: ['Step forward with one leg','Lower hips until both knees at 90 degrees','Front knee over ankle, not past toes','Push through front heel to return','Alternate legs'],
            muscles: ['Quads', 'Glutes', 'Hamstrings'],
            tips: ['Keep torso upright',"Don't let front knee cave in",'Take longer step for more glute focus']
        },
        'Calf Raise': {
            video: 'https://www.youtube.com/embed/gwLzBJYoWlI',
            instructions: ['Stand on edge of platform','Balls of feet on edge','Lower heels below platform','Rise up on toes','Full contraction at top'],
            muscles: ['Calves'],
            tips: ['Full range of motion','Pause at top','Slow negatives']
        },
        'Face Pulls': {
            video: 'https://www.youtube.com/embed/rep-qVOkqgk',
            instructions: ['Set cable at face height','Grip rope with thumbs near ears','Pull rope to face','Spread handles apart at face','Squeeze shoulder blades'],
            muscles: ['Rear Delts', 'Upper Back'],
            tips: ['High reps work well','Focus on rear delts','External rotation at end']
        },
        'Skull Crushers': {
            video: 'https://www.youtube.com/embed/d_KZxkY_0cM',
            instructions: ['Lie on bench with bar overhead','Lower bar to forehead','Keep upper arms stationary','Extend arms back up',"Don't move elbows"],
            muscles: ['Triceps'],
            tips: ['Protect your face','Keep elbows in','Full extension']
        },
        'Hammer Curl': {
            video: 'https://www.youtube.com/embed/zC3nLlEvin4',
            instructions: ['Hold dumbbells with neutral grip','Keep elbows at sides','Curl up toward shoulders','Squeeze at top','Lower with control'],
            muscles: ['Biceps', 'Forearms', 'Brachialis'],
            tips: ['Neutral grip throughout',"Don't swing",'Can alternate or do both together']
        },
        'Cable Flyes': {
            video: 'https://www.youtube.com/embed/Iwe6AmxVf7o',
            instructions: ['Set cables to chest height','Step forward with slight lean','Arms extended with slight bend','Bring hands together in arc motion','Control the return'],
            muscles: ['Chest', 'Shoulders'],
            tips: ['Focus on chest squeeze',"Don't lock elbows",'Maintain slight forward lean']
        }
    };

    function showExerciseDemo(exerciseName) {
        // Try exact match, then partial match
        let exercise = EXERCISE_DEMO_DB[exerciseName];
        if (!exercise) {
            const key = Object.keys(EXERCISE_DEMO_DB).find(k => k.toLowerCase().includes(exerciseName.toLowerCase()) || exerciseName.toLowerCase().includes(k.toLowerCase()));
            exercise = key ? EXERCISE_DEMO_DB[key] : null;
        }

        const nameEl = document.getElementById('demo-exercise-name');
        if (nameEl) nameEl.textContent = exerciseName;

        const videoEl = document.getElementById('demo-video');
        if (videoEl) videoEl.src = exercise ? (exercise.video + '?autoplay=0') : '';

        if (!exercise) {
            const instructions = document.getElementById('demo-instructions');
            if (instructions) instructions.innerHTML = `<p class="text-slate-600">No demo available. Search YouTube for "${exerciseName}" for form tutorials.</p>`;
            const muscles = document.getElementById('demo-muscles');
            if (muscles) muscles.innerHTML = '<span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-bold">Various</span>';
            const tips = document.getElementById('demo-tips');
            if (tips) tips.innerHTML = '<p class="text-slate-600">Focus on proper form and controlled movements.</p>';
        } else {
            const instructions = document.getElementById('demo-instructions');
            if (instructions) {
                instructions.innerHTML = exercise.instructions.map((inst, i) =>
                    `<div class="flex gap-3"><span class="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-bold">${i + 1}</span><p class="text-slate-700">${inst}</p></div>`
                ).join('');
            }
            const muscles = document.getElementById('demo-muscles');
            if (muscles) {
                muscles.innerHTML = exercise.muscles.map(m => `<span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold">${m}</span>`).join('');
            }
            const tips = document.getElementById('demo-tips');
            if (tips) {
                tips.innerHTML = exercise.tips.map(tip =>
                    `<div class="flex gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"></i><p class="text-slate-700">${tip}</p></div>`
                ).join('');
            }
        }

        document.getElementById('exercise-demo-modal').style.display = 'flex';
        lucide.createIcons();
    }

    function closeExerciseDemo() {
        document.getElementById('exercise-demo-modal').style.display = 'none';
        const videoEl = document.getElementById('demo-video');
        if (videoEl) videoEl.src = '';
    }

    // ==========================================================================
    // EXTENDED EXERCISE DEMO DATABASE
    // ==========================================================================

    // Additional exercises merged into EXERCISE_DEMO_DB
    Object.assign(EXERCISE_DEMO_DB, {
        'Arnold Press': {
            video: 'https://www.youtube.com/embed/6Z15_WdXmVw',
            instructions: ['Sit with dumbbells at shoulder height, palms facing you','Press up while rotating palms to face forward','Fully extend arms overhead','Reverse the rotation on the way down','Control throughout the movement'],
            muscles: ['Shoulders', 'Triceps', 'Upper Chest'],
            tips: ['Smooth rotation throughout','Full range of motion',"Don't arch back excessively"]
        },
        'Leg Curl': {
            video: 'https://www.youtube.com/embed/ELOCsoDSmrg',
            instructions: ['Lie face down on machine','Place ankles under pad','Curl heels toward glutes','Squeeze hamstrings at top','Lower with control'],
            muscles: ['Hamstrings', 'Calves'],
            tips: ['Full range of motion',"Don't lift hips off pad",'Control the negative']
        },
        'Leg Extension': {
            video: 'https://www.youtube.com/embed/YyvSfVjQeL0',
            instructions: ['Sit in machine with ankles under pad','Grip the handles on the side','Extend legs until straight','Squeeze quads hard at top','Lower with slow control'],
            muscles: ['Quadriceps'],
            tips: ['Isolates quads effectively','Full contraction at top','Slow negative for hypertrophy']
        },
        'Lat Pulldown': {
            video: 'https://www.youtube.com/embed/CAwf7n6Luuc',
            instructions: ['Sit with thighs secured under pads','Grip bar wider than shoulders','Pull bar down to upper chest','Squeeze shoulder blades together','Control the bar back up'],
            muscles: ['Lats', 'Biceps', 'Upper Back'],
            tips: ['Pull with elbows, not hands','Chest up throughout','Avoid leaning back excessively']
        },
        'Barbell Row': {
            video: 'https://www.youtube.com/embed/FWJR5Ve8bnQ',
            instructions: ['Hip hinge with slight knee bend','Grip bar slightly wider than shoulder width','Pull bar to lower chest or upper abs','Keep torso at roughly 45 degrees','Lower bar with control'],
            muscles: ['Lats', 'Rhomboids', 'Biceps', 'Rear Delts'],
            tips: ["Don't stand too upright",'Pull to belly button, not chest','Squeeze shoulder blades at top']
        },
        'Glute Bridge': {
            video: 'https://www.youtube.com/embed/wPM8icPu6H8',
            instructions: ['Lie on your back, knees bent, feet flat','Arms at your sides or across chest','Drive through heels to lift hips','Squeeze glutes hard at the top','Lower hips back to floor and repeat'],
            muscles: ['Glutes', 'Hamstrings', 'Core'],
            tips: ['Can add weight on hips for progression','Hold at top for extra contraction',"Don't hyperextend your lower back"]
        },
        'Cable Row': {
            video: 'https://www.youtube.com/embed/GZbfZ033f74',
            instructions: ['Sit facing cable machine','Feet on platform, knees slightly bent','Grip the handle with neutral or overhand grip','Pull handle to lower abdomen','Squeeze shoulder blades, then return slowly'],
            muscles: ['Mid Back', 'Lats', 'Biceps', 'Rear Delts'],
            tips: ["Don't rock back and forth",'Keep elbows close to body','Full stretch at starting position']
        },
        'Face Pulls': {
            video: 'https://www.youtube.com/embed/rep-qVOkqgk',
            instructions: ['Set cable to face height','Grip rope attachment with both hands','Pull rope to forehead level','Flare elbows out at end position','Squeeze rear delts and return slowly'],
            muscles: ['Rear Delts', 'Upper Back', 'External Rotators'],
            tips: ['High reps (15-25) work great','Crucial for shoulder health','External rotation at end of movement']
        },
        'Good Morning': {
            video: 'https://www.youtube.com/embed/YA-h3n74FBY',
            instructions: ['Bar positioned on upper back like a squat','Feet hip-width apart','Keep slight bend in knees','Hinge at hips, lowering torso forward','Drive hips forward to return to start'],
            muscles: ['Hamstrings', 'Lower Back', 'Glutes'],
            tips: ['Keep back flat throughout','Feel the hamstring stretch at bottom','Start very light to learn the movement']
        },
        'Bulgarian Split Squat': {
            video: 'https://www.youtube.com/embed/2C-uNgKwPLE',
            instructions: ['Place rear foot on a bench behind you','Step forward into a wide split stance','Lower your hips straight down','Front thigh should reach parallel','Push through front heel to return'],
            muscles: ['Quads', 'Glutes', 'Hamstrings', 'Core'],
            tips: ['Excellent unilateral strength builder','Front knee should track over toes','Can hold dumbbells for added resistance']
        },
        'Nordic Curl': {
            video: 'https://www.youtube.com/embed/xZljSaTggEo',
            instructions: ['Kneel with ankles secured by partner or pad','Start upright, arms ready to catch','Slowly lower body toward floor with straight back','Use hamstrings to control the descent','Catch yourself with hands at bottom'],
            muscles: ['Hamstrings', 'Glutes'],
            tips: ['Very challenging ‚Äî one of best hamstring exercises','Use a resistance band for assistance initially','Focus on the slow eccentric phase']
        },
        'Inverted Row': {
            video: 'https://www.youtube.com/embed/DWnMmQx_CYQ',
            instructions: ['Set bar or rings at about waist height','Lie under bar, grip shoulder-width','Keep body straight from head to heels','Pull chest to bar while squeezing back','Lower with control'],
            muscles: ['Upper Back', 'Biceps', 'Rear Delts', 'Core'],
            tips: ['Great bodyweight pulling movement','Adjust angle to change difficulty','Feet elevated makes it harder']
        },
        'Pike Push Ups': {
            video: 'https://www.youtube.com/embed/sposDXWEB0A',
            instructions: ['Start in downward dog position','Hands shoulder-width, hips high','Lower head toward floor between hands','Push back up strongly','Keep hips elevated throughout'],
            muscles: ['Shoulders', 'Triceps', 'Upper Chest'],
            tips: ['Primarily targets shoulders','Good progression toward handstand push-up','Control the descent']
        },
        'Mountain Climbers': {
            video: 'https://www.youtube.com/embed/nmwgirgXLYM',
            instructions: ['Start in high plank position','Drive one knee toward chest','Quickly switch legs in running motion','Keep hips level throughout','Maintain fast, controlled pace'],
            muscles: ['Core', 'Hip Flexors', 'Shoulders', 'Cardio'],
            tips: ['Keep core tight and back flat',"Don't let hips rise","Great cardio and core combination"]
        },
        'Russian Twists': {
            video: 'https://www.youtube.com/embed/wkD8rjkodUI',
            instructions: ['Sit on floor with knees bent','Lean back slightly to engage core','Hold weight or clasp hands together','Rotate torso side to side','Feet can be elevated for more challenge'],
            muscles: ['Obliques', 'Core', 'Hip Flexors'],
            tips: ['Control the rotation ‚Äî no bouncing','Keep back straight, not rounded','Touch weight to ground on each side']
        },
        'Dead Bug': {
            video: 'https://www.youtube.com/embed/4XLEnwUr1d8',
            instructions: ['Lie on back with arms straight up','Knees bent at 90 degrees in the air','Slowly lower opposite arm and leg','Lower until just above the floor','Return to start and repeat other side'],
            muscles: ['Core', 'Lower Back Stability', 'Hip Flexors'],
            tips: ['Keep lower back pressed to floor','Move slowly and with control','Breathe out as you lower limbs']
        },
        'Tricep Dips': {
            video: 'https://www.youtube.com/embed/6kALZikXxLc',
            instructions: ['Support body on parallel bars or chair','Arms straight, body slightly forward','Bend elbows to lower body down','Go until upper arms are parallel to ground','Push back up to starting position'],
            muscles: ['Triceps', 'Chest', 'Front Shoulders'],
            tips: ['More forward lean = more chest involvement','Stay upright for tricep focus',"Don't go too low if shoulders hurt"]
        },
        'Straight Arm Pulldown': {
            video: 'https://www.youtube.com/embed/56sNOBEbMOk',
            instructions: ['Stand facing cable machine, bar overhead','Arms extended, slight elbow bend','Pull bar down to your thighs','Keep arms straight throughout','Return slowly with control'],
            muscles: ['Lats', 'Core', 'Teres Major'],
            tips: ['Great for lat isolation','Squeeze lats at bottom','Keep slight bend to protect elbows']
        },
        'Preacher Curl': {
            video: 'https://www.youtube.com/embed/fIWP-FRFNU0',
            instructions: ['Sit at preacher curl bench','Upper arms pressed firmly on pad','Full extension at bottom','Curl weight toward shoulders','Squeeze hard at top, lower slowly'],
            muscles: ['Biceps', 'Brachialis'],
            tips: ['Isolates the biceps effectively','Full range of motion is key','Keep upper arms on pad throughout']
        },
        'Overhead Extension': {
            video: 'https://www.youtube.com/embed/nRiJVZDpdL0',
            instructions: ['Hold dumbbell overhead with both hands','Keep upper arms close to ears','Lower dumbbell behind head by bending elbows','Extend arms back to starting position','Keep elbows pointing straight up'],
            muscles: ['Triceps Long Head'],
            tips: ['Great stretch on long head of tricep',"Don't flare elbows outward",'Can be done seated or standing']
        },
        'Close Grip Bench Press': {
            video: 'https://www.youtube.com/embed/JUpgGe1rWu8',
            instructions: ['Lie on bench, grip bar slightly narrower than shoulders','Lower bar to lower chest with elbows tucked','Keep elbows at roughly 45 degrees to body','Press straight up to full lockout','Control the descent'],
            muscles: ['Triceps', 'Inner Chest', 'Front Shoulders'],
            tips: ["Don't grip too narrow ‚Äî shoulder friendly spacing",'Elbows angled in, not flared','Excellent mass builder for triceps']
        },
        'Sissy Squat': {
            video: 'https://www.youtube.com/embed/nNDtfXPBfmc',
            instructions: ['Stand with heels elevated or holding support','Lean back and bend knees simultaneously','Lower until thighs are parallel or below','Keep hips extended (don\'t sit back)','Drive back up through quads'],
            muscles: ['Quadriceps', 'Hip Flexors'],
            tips: ['Very challenging ‚Äî use support initially','Pure quad isolation movement','Build up gradually to avoid knee pain']
        },
        'Donkey Calf Raise': {
            video: 'https://www.youtube.com/embed/rT_-9A4NiZg',
            instructions: ['Bend at waist 90 degrees with support','Balls of feet on elevated surface','Lower heels as far as possible','Rise up on toes through full range','Squeeze calves at top position'],
            muscles: ['Calves', 'Soleus'],
            tips: ['Old school but very effective','Full range of motion critical','Can add weight on lower back']
        },
        'Reverse Flyes': {
            video: 'https://www.youtube.com/embed/shemM_ONOOE',
            instructions: ['Hinge at hips, back flat, slight knee bend','Hold dumbbells with palms facing down','Raise arms out to sides like a bird','Squeeze rear delts at top of movement','Lower slowly and repeat'],
            muscles: ['Rear Delts', 'Upper Back', 'Rhomboids'],
            tips: ['Key exercise for shoulder balance','High reps feel great here','Keep slight elbow bend throughout']
        },
        'Hip Abduction': {
            video: 'https://www.youtube.com/embed/MiAFGVQ8RHQ',
            instructions: ['Set machine with appropriate weight','Sit with pads against outer thighs','Push legs outward against resistance','Hold briefly at widest point','Return slowly to starting position'],
            muscles: ['Glutes', 'Hip Abductors', 'TFL'],
            tips: ['Great glute medius exercise','Control both directions',"Don't use momentum"]
        },
        'Cable Kickback': {
            video: 'https://www.youtube.com/embed/EwiDdQ0RLZ0',
            instructions: ['Attach ankle cuff to low cable','Face the machine, hold frame for balance','Keep slight bend in standing leg','Kick working leg back and up','Squeeze glute at peak contraction'],
            muscles: ['Glutes', 'Hamstrings'],
            tips: ['Excellent glute isolator','Keep hips square throughout',"Don't swing ‚Äî use glute, not momentum"]
        },
        'Step Ups': {
            video: 'https://www.youtube.com/embed/dQnEx0kyfIM',
            instructions: ['Stand in front of a sturdy box or bench','Step up with one foot fully on the box','Drive through heel to stand on box','Step down with control','Alternate legs or complete one side'],
            muscles: ['Quads', 'Glutes', 'Hamstrings', 'Calves'],
            tips: ['Height determines difficulty','Can hold dumbbells for resistance','Great functional movement pattern']
        },
        'Donkey Kicks': {
            video: 'https://www.youtube.com/embed/SJ1Xuz9D-ZQ',
            instructions: ['Start on hands and knees (quadruped)','Keep core engaged and back flat','Kick one leg straight up behind you','Squeeze glute hard at top','Lower with control and repeat'],
            muscles: ['Glutes', 'Hamstrings', 'Core'],
            tips: ['Keep hips level ‚Äî no rotation','Can add ankle weight for resistance','Focus on squeezing glute, not kicking high']
        },
        'Jump Squat': {
            video: 'https://www.youtube.com/embed/A-cFYWvaHr0',
            instructions: ['Stand with feet shoulder-width apart','Lower into a squat position','Explode up jumping off both feet','Land softly with bent knees','Immediately lower into next squat'],
            muscles: ['Quads', 'Glutes', 'Calves', 'Cardio'],
            tips: ['Land softly to protect joints','Great for explosive power','Mix with regular squats for best results']
        },
        'Superman': {
            video: 'https://www.youtube.com/embed/z6PJMT2y8GQ',
            instructions: ['Lie face down on floor, arms extended overhead','Simultaneously lift arms, chest, and legs','Hold at peak for 1-2 seconds','Lower back to starting position','Keep neck neutral throughout'],
            muscles: ['Lower Back', 'Glutes', 'Hamstrings', 'Upper Back'],
            tips: ['Great for lower back health','Hold at top for extra time under tension','Use light weight vest for progression']
        },
        'Burpees': {
            video: 'https://www.youtube.com/embed/dZgVxmf6jkA',
            instructions: ['Start standing, then squat down','Place hands on floor, jump feet back to plank','Perform a push-up (optional)','Jump feet forward to squat position','Explode up with arms overhead'],
            muscles: ['Full Body', 'Cardio', 'Core', 'Chest', 'Legs'],
            tips: ['One of best full-body exercises','Modify by stepping instead of jumping','Excellent for conditioning and fat loss']
        }
    });

    // ==========================================================================
    // ADDITIONAL NUTRITION UTILITIES
    // ==========================================================================

    /**
     * Calculate TDEE (Total Daily Energy Expenditure) estimate
     * @param {number} weight - weight in kg
     * @param {number} height - height in cm
     * @param {number} age - age in years
     * @param {string} gender - 'male' or 'female'
     * @param {string} activity - 'sedentary', 'light', 'moderate', 'active', 'very_active'
     * @returns {number} estimated TDEE in calories
     */
    function calculateTDEE(weight, height, age, gender, activity) {
        // Mifflin-St Jeor Equation for BMR
        let bmr;
        if (gender === 'male') {
            bmr = 10 * weight + 6.25 * height - 5 * age + 5;
        } else {
            bmr = 10 * weight + 6.25 * height - 5 * age - 161;
        }
        const activityMultipliers = {
            sedentary: 1.2,
            light: 1.375,
            moderate: 1.55,
            active: 1.725,
            very_active: 1.9
        };
        return Math.round(bmr * (activityMultipliers[activity] || 1.55));
    }

    /**
     * Calculate macros based on calorie goal and split preference
     * @param {number} calories - daily calorie goal
     * @param {string} split - 'balanced', 'high_protein', 'low_carb', 'high_carb'
     * @returns {object} macros in grams
     */
    function calculateMacros(calories, split) {
        const splits = {
            balanced:     { protein: 0.25, carbs: 0.45, fat: 0.30 },
            high_protein: { protein: 0.35, carbs: 0.35, fat: 0.30 },
            low_carb:     { protein: 0.30, carbs: 0.20, fat: 0.50 },
            high_carb:    { protein: 0.20, carbs: 0.55, fat: 0.25 }
        };
        const ratio = splits[split] || splits.balanced;
        return {
            protein: Math.round((calories * ratio.protein) / 4),
            carbs:   Math.round((calories * ratio.carbs) / 4),
            fat:     Math.round((calories * ratio.fat) / 9)
        };
    }

    /**
     * Calculate BMI
     */
    function calculateBMI(weightKg, heightCm) {
        const heightM = heightCm / 100;
        const bmi = weightKg / (heightM * heightM);
        return {
            value: Math.round(bmi * 10) / 10,
            category: bmi < 18.5 ? 'Underweight' : bmi < 25 ? 'Normal weight' : bmi < 30 ? 'Overweight' : 'Obese'
        };
    }

    /**
     * Estimate calories burned per minute by activity type and weight
     * @param {string} activity
     * @param {number} weightKg
     * @returns {number} calories per minute
     */
    function estimateCaloriesBurnedPerMinute(activity, weightKg) {
        const mets = {
            running: 9.8, cycling: 7.5, swimming: 8.0, walking: 3.5,
            hiking: 6.0, rowing: 7.0, elliptical: 5.0
        };
        const met = mets[activity] || 5.0;
        return (met * weightKg * 3.5) / (200);
    }

    /**
     * Get nutritional quality score for a meal (rough estimate)
     * @param {object} meal
     * @returns {object} score and grade
     */
    function getMealQualityScore(meal) {
        let score = 50; // base
        const proteinPerCal = meal.protein / (meal.calories || 1);
        if (proteinPerCal > 0.15) score += 20;
        else if (proteinPerCal > 0.08) score += 10;
        if (meal.fiber > 5) score += 15;
        else if (meal.fiber > 2) score += 7;
        if (meal.sugar && meal.sugar > 20) score -= 15;
        if (meal.saturated_fat && meal.saturated_fat > 10) score -= 10;
        if (meal.sodium && meal.sodium > 1.5) score -= 10;
        score = Math.max(0, Math.min(100, score));
        let grade = score >= 80 ? 'A' : score >= 65 ? 'B' : score >= 50 ? 'C' : score >= 35 ? 'D' : 'F';
        return { score, grade };
    }

    // ==========================================================================
    // WORKOUT ANALYTICS & UTILITIES
    // ==========================================================================

    /**
     * Get total weekly volume (sets √ó reps √ó weight) for a muscle group
     * @param {string} muscleGroup
     * @returns {number} total volume
     */
    function getWeeklyVolumeForMuscle(muscleGroup) {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const muscleMap = {
            'chest': ['bench press', 'incline press', 'dumbbell press', 'flyes', 'dips', 'push-up', 'push ups'],
            'back': ['pull ups', 'row', 'lat pulldown', 'deadlift', 'pulldown'],
            'legs': ['squat', 'leg press', 'lunges', 'hip thrust', 'leg curl', 'leg extension', 'calf'],
            'shoulders': ['overhead press', 'lateral raise', 'front raise', 'face pull', 'arnold'],
            'arms': ['curl', 'tricep', 'dip', 'pushdown', 'extension']
        };

        const keywords = muscleMap[muscleGroup.toLowerCase()] || [muscleGroup.toLowerCase()];
        let totalVolume = 0;

        (state.workoutHistory || [])
            .filter(w => new Date(w.date) > weekAgo)
            .forEach(workout => {
                (workout.exercises || []).forEach(ex => {
                    const exNameLower = (ex.name || '').toLowerCase();
                    const isMatch = keywords.some(k => exNameLower.includes(k));
                    if (isMatch) {
                        (ex.sets || []).forEach(set => {
                            const reps = parseFloat(set.reps) || 0;
                            const weight = parseFloat(set.weight) || parseFloat(set.kg) || 0;
                            totalVolume += reps * weight;
                        });
                    }
                });
            });

        return totalVolume;
    }

    /**
     * Suggest rest days based on recent workout frequency
     * @returns {string} recommendation
     */
    function getRestDayRecommendation() {
        const last3Days = [];
        for (let i = 0; i < 3; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const hasWorkout = (state.workoutHistory || []).some(w => w.date === dateStr);
            last3Days.push(hasWorkout);
        }
        const consecutiveDays = last3Days.filter(Boolean).length;
        if (consecutiveDays >= 3) return "You've trained 3+ consecutive days. Consider a rest or active recovery day.";
        if (consecutiveDays === 2) return "2 days in a row. Monitor fatigue levels ‚Äî rest if needed.";
        return "Recovery looks good. Ready to train!";
    }

    /**
     * Get workout streak (consecutive days with a workout)
     * @returns {number}
     */
    function getWorkoutStreak() {
        let streak = 0;
        const today = new Date();
        for (let i = 0; i < 30; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const hasWorkout = (state.workoutHistory || []).some(w => w.date === dateStr);
            if (hasWorkout) { streak++; }
            else if (i > 0) { break; }
        }
        return streak;
    }

    /**
     * Get personal records summary for top exercises
     * @returns {Array}
     */
    function getAllPersonalRecords() {
        const records = {};
        (state.workoutHistory || []).forEach(workout => {
            (workout.exercises || []).forEach(ex => {
                if (!records[ex.name]) records[ex.name] = { weight: 0, reps: 0, date: '' };
                (ex.sets || []).forEach(set => {
                    const weight = parseFloat(set.weight) || 0;
                    const reps = parseFloat(set.reps) || 0;
                    if (weight > records[ex.name].weight) {
                        records[ex.name] = { weight, reps, date: workout.date };
                    }
                });
            });
        });
        return Object.entries(records)
            .filter(([, v]) => v.weight > 0)
            .sort((a, b) => b[1].weight - a[1].weight)
            .map(([name, data]) => ({ name, ...data }));
    }

    /**
     * Calculate 1 Rep Max estimate using Epley formula
     * @param {number} weight - weight lifted
     * @param {number} reps - reps performed
     * @returns {number} estimated 1RM
     */
    function calculate1RM(weight, reps) {
        if (reps === 1) return weight;
        return Math.round(weight * (1 + reps / 30));
    }

    /**
     * Get training frequency per muscle group in the past month
     * @returns {object}
     */
    function getMonthlyMuscleFrequency() {
        const monthAgo = new Date();
        monthAgo.setDate(monthAgo.getDate() - 30);
        const freq = {};

        (state.workoutHistory || [])
            .filter(w => new Date(w.date) > monthAgo)
            .forEach(workout => {
                const focus = (workout.focus || '').toLowerCase();
                ['chest', 'back', 'shoulders', 'legs', 'biceps', 'triceps', 'core'].forEach(muscle => {
                    if (focus.includes(muscle) || focus.includes('upper') || focus.includes('push') || focus.includes('pull') || focus.includes('full body')) {
                        freq[muscle] = (freq[muscle] || 0) + 1;
                    }
                });
            });

        return freq;
    }

    // ==========================================================================
    // DATE & TIME UTILITIES
    // ==========================================================================

    /**
     * Format a date string to a human-readable format
     * @param {string} dateStr - ISO date string
     * @param {string} format - 'short', 'long', 'relative'
     * @returns {string}
     */
    function formatDate(dateStr, format = 'short') {
        const date = new Date(dateStr + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const diff = Math.round((date - today) / (1000 * 60 * 60 * 24));

        if (format === 'relative') {
            if (diff === 0) return 'Today';
            if (diff === -1) return 'Yesterday';
            if (diff === 1) return 'Tomorrow';
            if (diff > -7) return `${Math.abs(diff)} days ago`;
            return date.toLocaleDateString();
        }
        if (format === 'long') return date.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    /**
     * Get start of week (Monday) for a given date
     * @param {Date} date
     * @returns {Date}
     */
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff);
        d.setHours(0, 0, 0, 0);
        return d;
    }

    /**
     * Check if two date strings are the same day
     * @param {string} dateStr1
     * @param {string} dateStr2
     * @returns {boolean}
     */
    function isSameDay(dateStr1, dateStr2) {
        return dateStr1.split('T')[0] === dateStr2.split('T')[0];
    }

    /**
     * Get an array of dates for the past N days
     * @param {number} n
     * @returns {Array<string>}
     */
    function getPastNDays(n) {
        const dates = [];
        for (let i = 0; i < n; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            dates.push(d.toISOString().split('T')[0]);
        }
        return dates;
    }

    // ==========================================================================
    // LOCAL STORAGE MANAGEMENT & EXPORT
    // ==========================================================================

    /**
     * Export all app data as a JSON file for backup
     */
    function exportData() {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `fittrack-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Data exported successfully!');
    }

    /**
     * Import data from a JSON backup file
     * @param {Event} event
     */
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm('This will replace all current data. Continue?')) {
                    state = { ...DEFAULT_STATE, ...imported };
                    saveState();
                    renderDashboard();
                    renderDiary();
                    renderSettings();
                    showToast('Data imported successfully!');
                }
            } catch (err) {
                showToast('Invalid backup file');
            }
        };
        reader.readAsText(file);
    }

    /**
     * Clear all data with confirmation
     */
    function clearAllData() {
        if (confirm('This will permanently delete all your data. Are you sure?')) {
            if (confirm('This cannot be undone. Are you absolutely sure?')) {
                state = { ...DEFAULT_STATE };
                saveState();
                renderDashboard();
                renderDiary();
                renderSettings();
                showToast('All data cleared');
            }
        }
    }

    /**
     * Get storage usage estimate in KB
     * @returns {number}
     */
    function getStorageUsageKB() {
        try {
            const data = localStorage.getItem('fittrack_state') || '';
            return Math.round((data.length * 2) / 1024);
        } catch (e) {
            return 0;
        }
    }

    // ==========================================================================
    // NOTIFICATION & REMINDER HELPERS
    // ==========================================================================

    /**
     * Request browser notification permission
     */
    async function requestNotificationPermission() {
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                showToast('Notifications enabled!');
                return true;
            }
        }
        showToast('Notifications not supported or denied');
        return false;
    }

    /**
     * Schedule a browser notification
     * @param {string} title
     * @param {string} body
     * @param {number} delayMs
     */
    function scheduleNotification(title, body, delayMs = 0) {
        if (Notification.permission !== 'granted') return;
        setTimeout(() => {
            new Notification(title, { body, icon: 'üí™' });
        }, delayMs);
    }

    // ==========================================================================
    // CHART UTILITIES
    // ==========================================================================

    /**
     * Render a weekly calorie chart
     * @param {string} canvasId
     */
    function renderWeeklyCalorieChart(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const days = getPastNDays(7).reverse();
        const labels = days.map(d => {
            const date = new Date(d + 'T00:00:00');
            return date.toLocaleDateString('en-GB', { weekday: 'short' });
        });

        const calorieData = days.map(day => {
            const meals = (state.dailyMeals || []).filter(m => m.date === day);
            return meals.reduce((sum, m) => sum + (m.calories || 0), 0);
        });

        const proteinData = days.map(day => {
            const meals = (state.dailyMeals || []).filter(m => m.date === day);
            return meals.reduce((sum, m) => sum + (m.protein || 0), 0);
        });

        if (window.weeklyCalChart) window.weeklyCalChart.destroy();
        window.weeklyCalChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Calories',
                        data: calorieData,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderRadius: 8
                    },
                    {
                        label: 'Protein (g)',
                        data: proteinData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    y: { grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    /**
     * Render a workout frequency heatmap-style data
     * @returns {Array<object>} last 30 days with workout data
     */
    function getWorkoutHeatmapData() {
        return getPastNDays(30).map(day => {
            const workouts = (state.workoutHistory || []).filter(w => w.date === day);
            return {
                date: day,
                count: workouts.length,
                label: formatDate(day, 'relative'),
                workouts: workouts.map(w => w.focus)
            };
        });
    }

    // ==========================================================================
    // MEAL PLAN TEMPLATES
    // ==========================================================================

    const MEAL_PLAN_TEMPLATES = {
        cutting: {
            name: 'Cutting Meal Plan',
            description: 'High protein, calorie deficit',
            meals: {
                breakfast: [
                    { name: 'Egg whites with spinach', calories: 180, protein: 25, carbs: 5, fat: 4 },
                    { name: 'Overnight oats with berries', calories: 280, protein: 12, carbs: 45, fat: 6 },
                    { name: 'Greek yogurt with fruit', calories: 200, protein: 18, carbs: 25, fat: 3 }
                ],
                lunch: [
                    { name: 'Chicken breast with salad', calories: 350, protein: 42, carbs: 15, fat: 10 },
                    { name: 'Tuna wrap', calories: 380, protein: 35, carbs: 35, fat: 8 },
                    { name: 'Turkey and vegetable stir-fry', calories: 320, protein: 38, carbs: 20, fat: 9 }
                ],
                dinner: [
                    { name: 'Salmon with broccoli', calories: 420, protein: 45, carbs: 10, fat: 18 },
                    { name: 'Lean beef with sweet potato', calories: 480, protein: 40, carbs: 35, fat: 14 },
                    { name: 'Chicken and vegetable casserole', calories: 380, protein: 42, carbs: 25, fat: 10 }
                ],
                snack: [
                    { name: 'Protein shake', calories: 150, protein: 25, carbs: 8, fat: 2 },
                    { name: 'Cottage cheese', calories: 120, protein: 15, carbs: 5, fat: 3 },
                    { name: 'Rice cakes with peanut butter', calories: 160, protein: 6, carbs: 22, fat: 6 }
                ]
            }
        },
        bulking: {
            name: 'Bulking Meal Plan',
            description: 'Calorie surplus, high protein and carbs',
            meals: {
                breakfast: [
                    { name: 'Oatmeal with banana and eggs', calories: 550, protein: 28, carbs: 75, fat: 14 },
                    { name: 'Whole grain toast with eggs and avocado', calories: 580, protein: 25, carbs: 50, fat: 26 }
                ],
                lunch: [
                    { name: 'Chicken rice bowl with vegetables', calories: 650, protein: 48, carbs: 70, fat: 15 },
                    { name: 'Pasta with meat sauce', calories: 700, protein: 42, carbs: 80, fat: 18 }
                ],
                dinner: [
                    { name: 'Steak with rice and vegetables', calories: 750, protein: 55, carbs: 65, fat: 22 },
                    { name: 'Salmon with quinoa and greens', calories: 680, protein: 48, carbs: 55, fat: 20 }
                ],
                snack: [
                    { name: 'Mass gainer shake', calories: 450, protein: 35, carbs: 60, fat: 8 },
                    { name: 'Peanut butter and banana on toast', calories: 380, protein: 12, carbs: 50, fat: 15 }
                ]
            }
        },
        maintenance: {
            name: 'Maintenance Meal Plan',
            description: 'Balanced macros for maintaining weight',
            meals: {
                breakfast: [
                    { name: 'Scrambled eggs with toast', calories: 380, protein: 22, carbs: 35, fat: 14 },
                    { name: 'Smoothie bowl with granola', calories: 420, protein: 15, carbs: 62, fat: 12 }
                ],
                lunch: [
                    { name: 'Quinoa bowl with chicken', calories: 520, protein: 38, carbs: 55, fat: 12 },
                    { name: 'Sandwich with lean protein', calories: 490, protein: 32, carbs: 50, fat: 14 }
                ],
                dinner: [
                    { name: 'Grilled fish with roasted veg', calories: 520, protein: 42, carbs: 30, fat: 18 },
                    { name: 'Chicken stir-fry with noodles', calories: 580, protein: 40, carbs: 60, fat: 14 }
                ],
                snack: [
                    { name: 'Mixed nuts', calories: 180, protein: 5, carbs: 8, fat: 14 },
                    { name: 'Apple with almond butter', calories: 220, protein: 5, carbs: 28, fat: 10 }
                ]
            }
        }
    };

    /**
     * Apply a meal plan template to today's diary
     * @param {string} planType - 'cutting', 'bulking', or 'maintenance'
     */
    function applyMealPlanTemplate(planType) {
        const plan = MEAL_PLAN_TEMPLATES[planType];
        if (!plan) return;

        if (!confirm(`Apply "${plan.name}" to today's diary? This will ADD to existing meals.`)) return;

        const today = state.viewDate;
        Object.entries(plan.meals).forEach(([mealType, options]) => {
            const selected = options[Math.floor(Math.random() * options.length)];
            if (!state.dailyMeals) state.dailyMeals = [];
            state.dailyMeals.push({
                id: Date.now() + Math.random(),
                date: today,
                name: selected.name,
                image: 'https://via.placeholder.com/100',
                amount: '1 serving',
                calories: selected.calories,
                protein: selected.protein,
                carbs: selected.carbs,
                fat: selected.fat,
                fiber: 0, sugar: 0, sodium: 0, saturated_fat: 0, cholesterol: 0,
                mealType,
                source: 'Template'
            });
        });

        saveState();
        renderDiary();
        renderDashboard();
        showToast(`${plan.name} applied! üçΩÔ∏è`);
    }

    // ==========================================================================
    // FITNESS LEVEL ASSESSMENT
    // ==========================================================================

    const FITNESS_BENCHMARKS = {
        male: {
            benchPress: { beginner: 60, intermediate: 100, advanced: 140, elite: 180 },
            squat: { beginner: 70, intermediate: 120, advanced: 160, elite: 210 },
            deadlift: { beginner: 90, intermediate: 140, advanced: 190, elite: 250 },
            overheadPress: { beginner: 35, intermediate: 60, advanced: 90, elite: 120 }
        },
        female: {
            benchPress: { beginner: 30, intermediate: 55, advanced: 80, elite: 105 },
            squat: { beginner: 40, intermediate: 70, advanced: 100, elite: 135 },
            deadlift: { beginner: 50, intermediate: 90, advanced: 120, elite: 160 },
            overheadPress: { beginner: 20, intermediate: 35, advanced: 50, elite: 70 }
        }
    };

    /**
     * Assess fitness level based on personal records
     * @param {string} gender - 'male' or 'female'
     * @returns {object} assessment results
     */
    function assessFitnessLevel(gender = 'male') {
        const benchmarks = FITNESS_BENCHMARKS[gender] || FITNESS_BENCHMARKS.male;
        const prMap = {};
        getAllPersonalRecords().forEach(pr => {
            prMap[pr.name.toLowerCase()] = pr.weight;
        });

        const results = {};
        const exercises = [
            { key: 'benchPress', names: ['bench press'] },
            { key: 'squat', names: ['barbell squat', 'squat'] },
            { key: 'deadlift', names: ['deadlift'] },
            { key: 'overheadPress', names: ['overhead press'] }
        ];

        exercises.forEach(ex => {
            const pr = ex.names.reduce((found, name) => found || prMap[name], null);
            if (pr) {
                const bm = benchmarks[ex.key];
                let level = 'Beginner';
                if (pr >= bm.elite) level = 'Elite';
                else if (pr >= bm.advanced) level = 'Advanced';
                else if (pr >= bm.intermediate) level = 'Intermediate';
                results[ex.key] = { pr, level };
            }
        });

        return results;
    }

    // ==========================================================================
    // WATER & STEPS MANUAL ADJUSTMENT HELPERS
    // ==========================================================================

    /**
     * Add water intake manually (called from potential UI)
     * @param {number} ml
     */
    function addWater(ml) {
        if (!state.waterLogs) state.waterLogs = {};
        state.waterLogs[state.viewDate] = Math.max(0, (state.waterLogs[state.viewDate] || 0) + ml);
        if (!state.hydrationLogs) state.hydrationLogs = {};
        state.hydrationLogs[state.viewDate] = state.waterLogs[state.viewDate];
        saveState();
        renderDashboard();
        showToast(`${ml > 0 ? '+' : ''}${ml}ml water logged`);
    }

    /**
     * Add steps manually (called from potential UI)
     * @param {number} steps
     */
    function addSteps(steps) {
        if (!state.stepsLogs) state.stepsLogs = {};
        state.stepsLogs[state.viewDate] = Math.max(0, (state.stepsLogs[state.viewDate] || 0) + steps);
        saveState();
        renderDashboard();
        showToast(`${steps.toLocaleString()} steps logged`);
    }

    // ==========================================================================
    // KEYBOARD SHORTCUTS
    // ==========================================================================

    document.addEventListener('keydown', function(e) {
        // Alt + number shortcuts for tabs
        if (e.altKey) {
            switch (e.key) {
                case '1': switchTab('dashboard'); break;
                case '2': switchTab('training'); break;
                case '3': switchTab('nutrition'); break;
                case '4': switchTab('logs'); break;
                case '5': switchTab('metrics'); break;
                case '6': switchTab('settings'); break;
            }
        }
        // Escape to close modals
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal-overlay[style*="flex"]');
            modals.forEach(modal => { modal.style.display = 'none'; });
            // Close barcode scanner if open
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
                html5QrCode = null;
            }
            // Stop demo video
            const demoVideo = document.getElementById('demo-video');
            if (demoVideo) demoVideo.src = '';
        }
    });

    // ==========================================================================
    // ADDITIONAL BODY METRICS UTILITIES
    // ==========================================================================

    /**
     * Get weight trend over the past N days
     * @param {number} days - number of days to look back
     * @returns {Array<object>} array of {date, weight} sorted ascending
     */
    function getWeightTrend(days = 30) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return (state.metricsHistory || [])
            .filter(m => m.weight && new Date(m.date) >= cutoff)
            .sort((a, b) => new Date(a.date) - new Date(b.date))
            .map(m => ({ date: m.date, weight: parseFloat(m.weight) }));
    }

    /**
     * Calculate average weight over the past N days
     * @param {number} days
     * @returns {number|null}
     */
    function getAverageWeight(days = 7) {
        const trend = getWeightTrend(days);
        if (!trend.length) return null;
        const sum = trend.reduce((acc, t) => acc + t.weight, 0);
        return Math.round((sum / trend.length) * 10) / 10;
    }

    /**
     * Calculate body fat percentage estimate using US Navy method
     * @param {string} gender
     * @param {number} waistCm
     * @param {number} neckCm
     * @param {number} heightCm
     * @param {number} hipCm - required for females
     * @returns {number|null}
     */
    function estimateBodyFat(gender, waistCm, neckCm, heightCm, hipCm = 0) {
        try {
            if (gender === 'male') {
                return Math.round((495 / (1.0324 - 0.19077 * Math.log10(waistCm - neckCm) + 0.15456 * Math.log10(heightCm)) - 450) * 10) / 10;
            } else {
                return Math.round((495 / (1.29579 - 0.35004 * Math.log10(waistCm + hipCm - neckCm) + 0.22100 * Math.log10(heightCm)) - 450) * 10) / 10;
            }
        } catch {
            return null;
        }
    }

    /**
     * Get lean body mass given weight and body fat %
     * @param {number} weightKg
     * @param {number} bodyFatPercent
     * @returns {number}
     */
    function getLeanBodyMass(weightKg, bodyFatPercent) {
        return Math.round(weightKg * (1 - bodyFatPercent / 100) * 10) / 10;
    }

    // ==========================================================================
    // SOCIAL SHARING UTILITIES
    // ==========================================================================

    /**
     * Generate a shareable workout summary string
     * @param {object} workout
     * @returns {string}
     */
    function generateWorkoutSummary(workout) {
        if (!workout) return '';
        const exerciseList = (workout.exercises || [])
            .map(ex => {
                const sets = (ex.sets || []).map(s => `${s.weight || 0}kg√ó${s.reps || 0}`).join(', ');
                return `${ex.name}: ${sets}`;
            })
            .join('\n');
        const totalSets = (workout.exercises || []).reduce((sum, ex) => sum + (ex.sets || []).length, 0);
        return `üí™ FitTrack Workout ‚Äî ${formatDate(workout.date, 'short')}\n` +
               `Focus: ${workout.focus || 'General'}\n` +
               `Duration: ${workout.duration || 0} min | ${totalSets} sets\n\n` +
               exerciseList;
    }

    /**
     * Copy text to clipboard with feedback
     * @param {string} text
     */
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showToast('Copied to clipboard! üìã');
        } catch {
            showToast('Could not copy ‚Äî please copy manually');
        }
    }

    /**
     * Share via Web Share API if available
     * @param {string} title
     * @param {string} text
     */
    async function shareNative(title, text) {
        if (navigator.share) {
            try {
                await navigator.share({ title, text });
            } catch {
                await copyToClipboard(text);
            }
        } else {
            await copyToClipboard(text);
        }
    }

    // ==========================================================================
    // ACCESSIBILITY HELPERS
    // ==========================================================================

    /**
     * Announce a message to screen readers via ARIA live region
     * @param {string} message
     */
    function announceToScreenReader(message) {
        let live = document.getElementById('aria-live-announcer');
        if (!live) {
            live = document.createElement('div');
            live.id = 'aria-live-announcer';
            live.setAttribute('aria-live', 'polite');
            live.setAttribute('aria-atomic', 'true');
            live.style.cssText = 'position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;';
            document.body.appendChild(live);
        }
        live.textContent = '';
        requestAnimationFrame(() => { live.textContent = message; });
    }

    /**
     * Trap focus within a modal for accessibility
     * @param {HTMLElement} modal
     */
    function trapFocusInModal(modal) {
        const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        modal.addEventListener('keydown', function(e) {
            if (e.key !== 'Tab') return;
            if (e.shiftKey) {
                if (document.activeElement === first) { last.focus(); e.preventDefault(); }
            } else {
                if (document.activeElement === last) { first.focus(); e.preventDefault(); }
            }
        });
        if (first) first.focus();
    }

    // ==========================================================================
    // COMPREHENSIVE WORKOUT PROGRAM LIBRARY
    // ==========================================================================

    const WORKOUT_PROGRAMS = {
        beginner_3day: {
            name: "Beginner Full Body - 3 Days/Week",
            level: "Beginner",
            duration: "4-8 weeks",
            description: "Perfect introduction to strength training with compound movements",
            schedule: ["Monday", "Wednesday", "Friday"],
            workouts: {
                day1: {
                    name: "Full Body Workout A",
                    warmup: ["5 min cardio", "Dynamic stretching", "Bodyweight squats 2x10"],
                    exercises: [
                        { name: "Goblet Squat", sets: 3, reps: "10-12", rest: 90, notes: "Focus on depth" },
                        { name: "Push Ups", sets: 3, reps: "8-12", rest: 90, notes: "Knees down if needed" },
                        { name: "Dumbbell Row", sets: 3, reps: "10-12", rest: 90, notes: "Each arm" },
                        { name: "Dumbbell Shoulder Press", sets: 3, reps: "8-10", rest: 90, notes: "Seated or standing" },
                        { name: "Plank", sets: 3, reps: "30-45s", rest: 60, notes: "Keep core tight" },
                        { name: "Dumbbell Curl", sets: 2, reps: "12-15", rest: 60, notes: "Controlled tempo" }
                    ],
                    cooldown: ["5 min walk", "Static stretching"]
                },
                day2: {
                    name: "Full Body Workout B",
                    warmup: ["5 min cardio", "Dynamic stretching", "Leg swings 2x10"],
                    exercises: [
                        { name: "Romanian Deadlift", sets: 3, reps: "10-12", rest: 90, notes: "Hinge at hips" },
                        { name: "Dumbbell Bench Press", sets: 3, reps: "8-12", rest: 90, notes: "Full range of motion" },
                        { name: "Lat Pulldown", sets: 3, reps: "10-12", rest: 90, notes: "Pull to upper chest" },
                        { name: "Lateral Raise", sets: 3, reps: "12-15", rest: 60, notes: "Light weight, controlled" },
                        { name: "Russian Twists", sets: 3, reps: "15-20", rest: 60, notes: "Each side" },
                        { name: "Tricep Pushdown", sets: 2, reps: "12-15", rest: 60, notes: "Elbows tucked" }
                    ],
                    cooldown: ["5 min walk", "Static stretching"]
                },
                day3: {
                    name: "Full Body Workout C",
                    warmup: ["5 min cardio", "Arm circles", "Cat-cow stretches"],
                    exercises: [
                        { name: "Leg Press", sets: 3, reps: "12-15", rest: 90, notes: "Feet shoulder-width" },
                        { name: "Incline Dumbbell Press", sets: 3, reps: "8-12", rest: 90, notes: "30-45 degree incline" },
                        { name: "Cable Row", sets: 3, reps: "10-12", rest: 90, notes: "Squeeze shoulder blades" },
                        { name: "Face Pulls", sets: 3, reps: "15-20", rest: 60, notes: "High reps for shoulders" },
                        { name: "Leg Raises", sets: 3, reps: "10-15", rest: 60, notes: "Control the descent" },
                        { name: "Hammer Curl", sets: 2, reps: "12-15", rest: 60, notes: "Neutral grip" }
                    ],
                    cooldown: ["5 min walk", "Full body stretch"]
                }
            }
        },
        ppl_6day: {
            name: "Push/Pull/Legs - 6 Days/Week",
            level: "Intermediate/Advanced",
            duration: "8-12 weeks",
            description: "High volume split for maximum muscle growth",
            schedule: ["Mon-Push", "Tue-Pull", "Wed-Legs", "Thu-Push", "Fri-Pull", "Sat-Legs"],
            workouts: {
                push1: {
                    name: "Push Day 1 - Strength Focus",
                    exercises: [
                        { name: "Barbell Bench Press", sets: 5, reps: "5-6", rest: 180, notes: "Heavy weight" },
                        { name: "Overhead Press", sets: 4, reps: "6-8", rest: 150, notes: "Strict form" },
                        { name: "Incline Dumbbell Press", sets: 4, reps: "8-10", rest: 120, notes: "Upper chest focus" },
                        { name: "Dips", sets: 3, reps: "8-12", rest: 90, notes: "Add weight if possible" },
                        { name: "Lateral Raise", sets: 4, reps: "12-15", rest: 60, notes: "Control the weight" },
                        { name: "Overhead Tricep Extension", sets: 3, reps: "10-12", rest: 90, notes: "Stretch position" },
                        { name: "Cable Pushdown", sets: 3, reps: "12-15", rest: 60, notes: "Squeeze at bottom" }
                    ]
                },
                pull1: {
                    name: "Pull Day 1 - Strength Focus",
                    exercises: [
                        { name: "Deadlift", sets: 5, reps: "5-6", rest: 240, notes: "Progressive overload" },
                        { name: "Pull Ups", sets: 4, reps: "6-10", rest: 150, notes: "Full range" },
                        { name: "Barbell Row", sets: 4, reps: "6-8", rest: 120, notes: "Torso at 45 degrees" },
                        { name: "Face Pulls", sets: 4, reps: "15-20", rest: 60, notes: "Rear delt focus" },
                        { name: "Barbell Curl", sets: 3, reps: "8-12", rest: 90, notes: "No momentum" },
                        { name: "Hammer Curl", sets: 3, reps: "10-12", rest: 60, notes: "Brachialis focus" },
                        { name: "Reverse Curl", sets: 2, reps: "12-15", rest: 60, notes: "Forearm development" }
                    ]
                },
                legs1: {
                    name: "Legs Day 1 - Quad Focus",
                    exercises: [
                        { name: "Barbell Squat", sets: 5, reps: "5-6", rest: 240, notes: "Below parallel" },
                        { name: "Front Squat", sets: 4, reps: "8-10", rest: 180, notes: "Upright torso" },
                        { name: "Leg Press", sets: 4, reps: "10-12", rest: 120, notes: "Full range" },
                        { name: "Leg Extension", sets: 3, reps: "12-15", rest: 90, notes: "Squeeze at top" },
                        { name: "Walking Lunges", sets: 3, reps: "12-15", rest: 90, notes: "Each leg" },
                        { name: "Standing Calf Raise", sets: 4, reps: "15-20", rest: 60, notes: "Full stretch" },
                        { name: "Ab Rollout", sets: 3, reps: "10-15", rest: 90, notes: "From knees if needed" }
                    ]
                },
                push2: {
                    name: "Push Day 2 - Hypertrophy Focus",
                    exercises: [
                        { name: "Incline Barbell Press", sets: 4, reps: "8-10", rest: 120, notes: "30 degree angle" },
                        { name: "Flat Dumbbell Press", sets: 4, reps: "10-12", rest: 90, notes: "Deep stretch" },
                        { name: "Cable Flyes", sets: 3, reps: "12-15", rest: 60, notes: "Constant tension" },
                        { name: "Arnold Press", sets: 4, reps: "10-12", rest: 90, notes: "Rotate palms" },
                        { name: "Cable Lateral Raise", sets: 3, reps: "15-20", rest: 60, notes: "One arm at a time" },
                        { name: "Close Grip Bench", sets: 4, reps: "8-10", rest: 90, notes: "Tricep focus" },
                        { name: "Rope Pushdown", sets: 3, reps: "15-20", rest: 60, notes: "Split rope at bottom" }
                    ]
                },
                pull2: {
                    name: "Pull Day 2 - Hypertrophy Focus",
                    exercises: [
                        { name: "Lat Pulldown", sets: 4, reps: "10-12", rest: 90, notes: "Wide grip" },
                        { name: "Seated Cable Row", sets: 4, reps: "10-12", rest: 90, notes: "Squeeze back" },
                        { name: "Single Arm Dumbbell Row", sets: 3, reps: "12-15", rest: 90, notes: "Each arm" },
                        { name: "Straight Arm Pulldown", sets: 3, reps: "12-15", rest: 60, notes: "Lat isolation" },
                        { name: "Reverse Flyes", sets: 4, reps: "15-20", rest: 60, notes: "Rear delt pump" },
                        { name: "Preacher Curl", sets: 3, reps: "10-12", rest: 90, notes: "Bicep peak" },
                        { name: "Cable Curl", sets: 3, reps: "12-15", rest: 60, notes: "Constant tension" }
                    ]
                },
                legs2: {
                    name: "Legs Day 2 - Posterior Chain Focus",
                    exercises: [
                        { name: "Romanian Deadlift", sets: 4, reps: "8-10", rest: 120, notes: "Hamstring stretch" },
                        { name: "Bulgarian Split Squat", sets: 4, reps: "10-12", rest: 90, notes: "Each leg" },
                        { name: "Leg Curl", sets: 4, reps: "12-15", rest: 90, notes: "Hamstring focus" },
                        { name: "Hip Thrust", sets: 4, reps: "10-12", rest: 120, notes: "Glute activation" },
                        { name: "Goblet Squat", sets: 3, reps: "15-20", rest: 60, notes: "High rep burn" },
                        { name: "Seated Calf Raise", sets: 4, reps: "15-20", rest: 60, notes: "Soleus focus" },
                        { name: "Hanging Leg Raise", sets: 3, reps: "12-15", rest: 90, notes: "Lower abs" }
                    ]
                }
            }
        },
        upper_lower_4day: {
            name: "Upper/Lower Split - 4 Days/Week",
            level: "Intermediate",
            duration: "6-10 weeks",
            description: "Balanced frequency and volume for strength and size",
            schedule: ["Mon-Upper", "Tue-Lower", "Thu-Upper", "Fri-Lower"],
            workouts: {
                upper_power: {
                    name: "Upper Body Power Day",
                    exercises: [
                        { name: "Barbell Bench Press", sets: 5, reps: "3-5", rest: 240, notes: "Max strength" },
                        { name: "Barbell Row", sets: 5, reps: "3-5", rest: 240, notes: "Explosive pull" },
                        { name: "Overhead Press", sets: 4, reps: "5-6", rest: 180, notes: "Shoulder strength" },
                        { name: "Pull Ups", sets: 4, reps: "5-8", rest: 150, notes: "Add weight if possible" },
                        { name: "Barbell Curl", sets: 3, reps: "6-8", rest: 90, notes: "Heavy weight" },
                        { name: "Skull Crushers", sets: 3, reps: "6-8", rest: 90, notes: "Control eccentric" }
                    ]
                },
                lower_power: {
                    name: "Lower Body Power Day",
                    exercises: [
                        { name: "Barbell Squat", sets: 5, reps: "3-5", rest: 300, notes: "Max strength" },
                        { name: "Deadlift", sets: 5, reps: "3-5", rest: 300, notes: "Alternate with squat intensity" },
                        { name: "Leg Press", sets: 4, reps: "6-8", rest: 150, notes: "Heavy load" },
                        { name: "Leg Curl", sets: 3, reps: "8-10", rest: 120, notes: "Hamstring strength" },
                        { name: "Standing Calf Raise", sets: 4, reps: "6-8", rest: 90, notes: "Heavy weight" }
                    ]
                },
                upper_hypertrophy: {
                    name: "Upper Body Hypertrophy Day",
                    exercises: [
                        { name: "Incline Dumbbell Press", sets: 4, reps: "8-12", rest: 90, notes: "Muscle building" },
                        { name: "Cable Row", sets: 4, reps: "8-12", rest: 90, notes: "Squeeze contraction" },
                        { name: "Dumbbell Shoulder Press", sets: 3, reps: "10-12", rest: 90, notes: "Full ROM" },
                        { name: "Lat Pulldown", sets: 3, reps: "10-12", rest: 90, notes: "Wide grip" },
                        { name: "Dumbbell Flyes", sets: 3, reps: "12-15", rest: 60, notes: "Chest stretch" },
                        { name: "Face Pulls", sets: 3, reps: "15-20", rest: 60, notes: "Rear delts" },
                        { name: "Hammer Curl", sets: 3, reps: "10-12", rest: 60, notes: "Brachialis" },
                        { name: "Tricep Pushdown", sets: 3, reps: "12-15", rest: 60, notes: "Pump work" }
                    ]
                },
                lower_hypertrophy: {
                    name: "Lower Body Hypertrophy Day",
                    exercises: [
                        { name: "Front Squat", sets: 4, reps: "8-10", rest: 120, notes: "Quad focus" },
                        { name: "Romanian Deadlift", sets: 4, reps: "8-10", rest: 120, notes: "Hamstring stretch" },
                        { name: "Bulgarian Split Squat", sets: 3, reps: "10-12", rest: 90, notes: "Each leg" },
                        { name: "Leg Extension", sets: 3, reps: "12-15", rest: 60, notes: "Quad isolation" },
                        { name: "Hip Thrust", sets: 4, reps: "10-12", rest: 90, notes: "Glute focus" },
                        { name: "Leg Curl", sets: 3, reps: "12-15", rest: 60, notes: "Hamstring pump" },
                        { name: "Seated Calf Raise", sets: 4, reps: "15-20", rest: 60, notes: "Time under tension" }
                    ]
                }
            }
        }
    };

    // ==========================================================================
    // EXTENSIVE NUTRITION DATABASE
    // ==========================================================================

    const NUTRITION_DATABASE = {
        proteins: {
            meats: [
                { name: "Chicken Breast (grilled, 100g)", cal: 165, p: 31, c: 0, f: 3.6, fiber: 0, prep: "Grill or bake" },
                { name: "Turkey Breast (roasted, 100g)", cal: 135, p: 30, c: 0, f: 0.7, fiber: 0, prep: "Roast or grill" },
                { name: "Lean Ground Beef 90/10 (100g)", cal: 176, p: 20, c: 0, f: 10, fiber: 0, prep: "Pan fry or grill" },
                { name: "Pork Tenderloin (100g)", cal: 143, p: 26, c: 0, f: 3.5, fiber: 0, prep: "Roast or grill" },
                { name: "Sirloin Steak (100g)", cal: 271, p: 27, c: 0, f: 18, fiber: 0, prep: "Grill medium-rare" },
                { name: "Lamb Chop (100g)", cal: 282, p: 25, c: 0, f: 20, fiber: 0, prep: "Grill or pan sear" }
            ],
            seafood: [
                { name: "Salmon (wild, grilled, 100g)", cal: 206, p: 22, c: 0, f: 12, fiber: 0, omega3: "High", prep: "Bake or grill" },
                { name: "Tuna (canned in water, 100g)", cal: 116, p: 26, c: 0, f: 0.8, fiber: 0, prep: "Ready to eat" },
                { name: "Cod (baked, 100g)", cal: 105, p: 23, c: 0, f: 0.9, fiber: 0, prep: "Bake with lemon" },
                { name: "Prawns/Shrimp (100g)", cal: 99, p: 24, c: 0, f: 0.3, fiber: 0, prep: "Boil or grill" },
                { name: "Tilapia (100g)", cal: 128, p: 26, c: 0, f: 2.7, fiber: 0, prep: "Pan fry or bake" },
                { name: "Mackerel (100g)", cal: 262, p: 24, c: 0, f: 18, fiber: 0, omega3: "Very High", prep: "Grill" }
            ],
            dairy: [
                { name: "Greek Yogurt 0% (170g)", cal: 100, p: 17, c: 6, f: 0, fiber: 0, calcium: "High", prep: "Ready to eat" },
                { name: "Cottage Cheese Low-Fat (100g)", cal: 72, p: 12, c: 2.7, f: 1, fiber: 0, prep: "Ready to eat" },
                { name: "Eggs (2 large)", cal: 140, p: 12, c: 1, f: 10, fiber: 0, cholesterol: "Medium", prep: "Boil or scramble" },
                { name: "Egg Whites (100g)", cal: 52, p: 11, c: 0.7, f: 0.2, fiber: 0, prep: "Cook or use liquid" },
                { name: "Milk Whole (250ml)", cal: 150, p: 8, c: 12, f: 8, fiber: 0, calcium: "High", prep: "Drink" },
                { name: "Whey Protein Isolate (30g scoop)", cal: 110, p: 25, c: 1, f: 0.5, fiber: 0, prep: "Mix with water" }
            ],
            plantBased: [
                { name: "Tofu Firm (100g)", cal: 144, p: 17, c: 3, f: 9, fiber: 2, prep: "Stir fry or bake" },
                { name: "Tempeh (100g)", cal: 193, p: 20, c: 9, f: 11, fiber: 5, prep: "Steam then fry" },
                { name: "Lentils Cooked (100g)", cal: 116, p: 9, c: 20, f: 0.4, fiber: 8, iron: "High", prep: "Boil 20-25 min" },
                { name: "Chickpeas Cooked (100g)", cal: 164, p: 9, c: 27, f: 2.6, fiber: 8, prep: "Boil or roast" },
                { name: "Black Beans Cooked (100g)", cal: 132, p: 9, c: 24, f: 0.5, fiber: 9, prep: "Boil 60-90 min" },
                { name: "Edamame (100g)", cal: 122, p: 11, c: 10, f: 5, fiber: 5, prep: "Boil 5 min" }
            ]
        },
        carbs: {
            grains: [
                { name: "Brown Rice Cooked (100g)", cal: 112, p: 2.6, c: 24, f: 0.9, fiber: 1.8, gi: "Medium", prep: "Boil 40 min" },
                { name: "White Rice Cooked (100g)", cal: 130, p: 2.7, c: 28, f: 0.3, fiber: 0.4, gi: "High", prep: "Boil 15-20 min" },
                { name: "Quinoa Cooked (100g)", cal: 120, p: 4.4, c: 21, f: 1.9, fiber: 2.8, complete_protein: true, prep: "Boil 15 min" },
                { name: "Oats Dry (40g)", cal: 152, p: 5.3, c: 27, f: 2.8, fiber: 4, gi: "Low", prep: "Cook with milk" },
                { name: "Whole Wheat Pasta Cooked (100g)", cal: 124, p: 5, c: 26, f: 0.5, fiber: 3.5, prep: "Boil 8-10 min" },
                { name: "Couscous Cooked (100g)", cal: 112, p: 3.8, c: 23, f: 0.2, fiber: 1.4, prep: "Pour boiling water" }
            ],
            tubers: [
                { name: "Sweet Potato Baked (100g)", cal: 90, p: 2, c: 21, f: 0.2, fiber: 3.3, vitaminA: "Very High", prep: "Bake 45 min" },
                { name: "White Potato Baked (medium)", cal: 161, p: 4.3, c: 37, f: 0.2, fiber: 3.8, potassium: "High", prep: "Bake 50 min" },
                { name: "Yam Cooked (100g)", cal: 116, p: 1.5, c: 27.5, f: 0.1, fiber: 3.9, prep: "Boil or bake" }
            ],
            fruits: [
                { name: "Banana Medium", cal: 105, p: 1.3, c: 27, f: 0.4, fiber: 3.1, potassium: "High", prep: "Eat raw" },
                { name: "Apple Medium", cal: 95, p: 0.5, c: 25, f: 0.3, fiber: 4.4, prep: "Eat raw" },
                { name: "Blueberries (100g)", cal: 57, p: 0.7, c: 14, f: 0.3, fiber: 2.4, antioxidants: "Very High", prep: "Eat raw" },
                { name: "Strawberries (100g)", cal: 32, p: 0.7, c: 8, f: 0.3, fiber: 2, vitaminC: "High", prep: "Eat raw" },
                { name: "Orange Medium", cal: 62, p: 1.2, c: 15, f: 0.2, fiber: 3.1, vitaminC: "Very High", prep: "Peel and eat" },
                { name: "Mango (100g)", cal: 60, p: 0.8, c: 15, f: 0.4, fiber: 1.6, vitaminA: "High", prep: "Slice and eat" }
            ],
            bread: [
                { name: "Whole Wheat Bread (2 slices)", cal: 160, p: 8, c: 28, f: 2, fiber: 4, prep: "Toast if desired" },
                { name: "Sourdough (2 slices)", cal: 180, p: 6, c: 36, f: 1, fiber: 2, easier_digest: true, prep: "Toast" },
                { name: "Rye Bread (2 slices)", cal: 166, p: 6, c: 32, f: 1.2, fiber: 3.8, prep: "Toast" }
            ]
        },
        fats: {
            nuts: [
                { name: "Almonds (28g, ~23 nuts)", cal: 164, p: 6, c: 6, f: 14, fiber: 3.5, vitaminE: "High", prep: "Eat raw or roasted" },
                { name: "Walnuts (28g, ~14 halves)", cal: 185, p: 4.3, c: 4, f: 18, fiber: 1.9, omega3: "High", prep: "Eat raw" },
                { name: "Cashews (28g, ~18 nuts)", cal: 157, p: 5, c: 9, f: 12, fiber: 0.9, prep: "Eat roasted" },
                { name: "Peanuts (28g)", cal: 161, p: 7, c: 5, f: 14, fiber: 2.4, prep: "Eat roasted" },
                { name: "Pistachios (28g, ~49 nuts)", cal: 159, p: 6, c: 8, f: 13, fiber: 3, prep: "Shell and eat" }
            ],
            seeds: [
                { name: "Chia Seeds (28g)", cal: 138, p: 4.7, c: 12, f: 8.7, fiber: 10, omega3: "Very High", prep: "Soak or sprinkle" },
                { name: "Flaxseeds (28g)", cal: 150, p: 5, c: 8, f: 12, fiber: 8, omega3: "High", prep: "Grind before eating" },
                { name: "Pumpkin Seeds (28g)", cal: 151, p: 7, c: 5, f: 13, fiber: 1.7, zinc: "High", prep: "Roast" }
            ],
            oils: [
                { name: "Olive Oil Extra Virgin (1 tbsp)", cal: 119, p: 0, c: 0, f: 14, fiber: 0, antioxidants: "High", prep: "Use for cooking" },
                { name: "Coconut Oil (1 tbsp)", cal: 121, p: 0, c: 0, f: 14, fiber: 0, mct: "Medium", prep: "High heat cooking" },
                { name: "Avocado Oil (1 tbsp)", cal: 124, p: 0, c: 0, f: 14, fiber: 0, smoke_point: "High", prep: "Cooking or salads" }
            ],
            spreads: [
                { name: "Peanut Butter Natural (2 tbsp)", cal: 188, p: 8, c: 7, f: 16, fiber: 2, prep: "Spread or eat with spoon" },
                { name: "Almond Butter (2 tbsp)", cal: 196, p: 7, c: 7, f: 18, fiber: 3, prep: "Spread or eat" },
                { name: "Avocado Half Medium", cal: 120, p: 1.5, c: 6, f: 11, fiber: 5, potassium: "High", prep: "Slice and eat" }
            ],
            other: [
                { name: "Dark Chocolate 70-85% (28g)", cal: 170, p: 2, c: 13, f: 12, fiber: 3, antioxidants: "High", prep: "Eat as is" },
                { name: "Cheese Cheddar (28g)", cal: 114, p: 7, c: 0.4, f: 9, fiber: 0, calcium: "High", prep: "Slice or grate" }
            ]
        },
        vegetables: {
            leafy: [
                { name: "Spinach Raw (100g)", cal: 23, p: 2.9, c: 3.6, f: 0.4, fiber: 2.2, iron: "High", prep: "Salad or cook" },
                { name: "Kale Raw (100g)", cal: 35, p: 2.9, c: 4.4, f: 1.5, fiber: 4.1, vitaminK: "Very High", prep: "Salad or saut√©" },
                { name: "Lettuce Romaine (100g)", cal: 17, p: 1.2, c: 3.3, f: 0.3, fiber: 2.1, prep: "Salad" },
                { name: "Arugula (100g)", cal: 25, p: 2.6, c: 3.7, f: 0.7, fiber: 1.6, prep: "Salad" }
            ],
            cruciferous: [
                { name: "Broccoli Cooked (100g)", cal: 35, p: 2.4, c: 7, f: 0.4, fiber: 3.3, vitaminC: "High", prep: "Steam 5 min" },
                { name: "Cauliflower Cooked (100g)", cal: 23, p: 1.8, c: 4.7, f: 0.5, fiber: 2.3, prep: "Steam or roast" },
                { name: "Brussels Sprouts (100g)", cal: 43, p: 3.4, c: 9, f: 0.3, fiber: 3.8, prep: "Roast or steam" },
                { name: "Cabbage Cooked (100g)", cal: 23, p: 1.3, c: 5.5, f: 0.1, fiber: 2.5, prep: "Boil or stir fry" }
            ],
            colorful: [
                { name: "Bell Peppers Raw (100g)", cal: 31, p: 1, c: 6, f: 0.3, fiber: 2.1, vitaminC: "Very High", prep: "Slice raw or cook" },
                { name: "Carrots Raw (100g)", cal: 41, p: 0.9, c: 10, f: 0.2, fiber: 2.8, vitaminA: "Very High", prep: "Raw or steam" },
                { name: "Tomatoes Raw (100g)", cal: 18, p: 0.9, c: 3.9, f: 0.2, fiber: 1.2, lycopene: "High", prep: "Slice raw or cook" },
                { name: "Cucumber (100g)", cal: 16, p: 0.7, c: 3.6, f: 0.1, fiber: 0.5, hydration: "High", prep: "Slice raw" },
                { name: "Zucchini (100g)", cal: 17, p: 1.2, c: 3.1, f: 0.3, fiber: 1, prep: "Grill or saut√©" }
            ],
            other: [
                { name: "Asparagus (100g)", cal: 20, p: 2.2, c: 3.9, f: 0.1, fiber: 2.1, folate: "High", prep: "Steam or grill" },
                { name: "Green Beans (100g)", cal: 31, p: 1.8, c: 7, f: 0.1, fiber: 3.4, prep: "Steam 5 min" },
                { name: "Mushrooms (100g)", cal: 22, p: 3.1, c: 3.3, f: 0.3, fiber: 1, vitaminD: "Medium", prep: "Saut√©" }
            ]
        }
    };

    // ==========================================================================
    // RECOVERY & ADAPTATION TRACKING
    // ==========================================================================

    /**
     * Calculate training stress score for a workout
     * @param {object} workout
     * @returns {number}
     */
    function calculateTrainingStress(workout) {
        let stress = 0;
        const duration = workout.duration || 60;
        const intensity = getAverageWorkoutIntensity(1);
        
        // Base stress from duration
        stress += duration * 0.5;
        
        // Add stress from volume
        const volume = calculateWorkoutVolume(workout);
        stress += volume / 100;
        
        // Multiply by intensity factor
        stress *= (intensity / 100);
        
        return Math.round(stress);
    }

    /**
     * Get weekly training load
     * @returns {number}
     */
    function getWeeklyTrainingLoad() {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        return (state.workoutHistory || [])
            .filter(w => new Date(w.date) > weekAgo)
            .reduce((sum, w) => sum + calculateTrainingStress(w), 0);
    }

    /**
     * Recommend training adjustments based on load
     * @returns {string}
     */
    function getTrainingLoadRecommendation() {
        const load = getWeeklyTrainingLoad();
        
        if (load < 100) return "Training load is low. Consider adding volume.";
        if (load < 250) return "Training load is moderate. Good balance for progression.";
        if (load < 400) return "Training load is high. Ensure adequate recovery.";
        return "Training load is very high. Consider a deload or rest day.";
    }

    // ==========================================================================
    // MEAL PREP SUGGESTIONS
    // ==========================================================================

    const MEAL_PREP_IDEAS = {
        protein_batch: [
            { name: "Grilled Chicken Breast", portions: 6, prep_time: 40, storage: "5 days fridge" },
            { name: "Baked Salmon Fillets", portions: 4, prep_time: 25, storage: "3 days fridge" },
            { name: "Ground Turkey Patties", portions: 8, prep_time: 30, storage: "4 days fridge" },
            { name: "Hard Boiled Eggs", portions: 12, prep_time: 15, storage: "7 days fridge" }
        ],
        carb_batch: [
            { name: "Brown Rice", portions: 8, prep_time: 45, storage: "5 days fridge" },
            { name: "Sweet Potato Cubes", portions: 6, prep_time: 35, storage: "5 days fridge" },
            { name: "Quinoa", portions: 6, prep_time: 20, storage: "5 days fridge" },
            { name: "Overnight Oats", portions: 5, prep_time: 10, storage: "5 days fridge" }
        ],
        veggie_batch: [
            { name: "Roasted Vegetables Mix", portions: 6, prep_time: 30, storage: "4 days fridge" },
            { name: "Steamed Broccoli", portions: 5, prep_time: 15, storage: "4 days fridge" },
            { name: "Mixed Salad Containers", portions: 4, prep_time: 20, storage: "3 days fridge" }
        ]
    };

    // ==========================================================================
    // HYDRATION TRACKING ENHANCEMENTS
    // ==========================================================================

    /**
     * Calculate recommended daily water intake
     * @param {number} weightKg
     * @param {string} activityLevel
     * @returns {number} ml per day
     */
    function calculateWaterIntake(weightKg, activityLevel = 'moderate') {
        let base = weightKg * 35; // 35ml per kg baseline
        
        const multipliers = {
            sedentary: 1.0,
            light: 1.1,
            moderate: 1.2,
            active: 1.3,
            very_active: 1.5
        };
        
        return Math.round(base * (multipliers[activityLevel] || 1.2));
    }

    /**
     * Get hydration status based on intake
     * @param {number} consumed - ml consumed today
     * @param {number} goal - ml goal
     * @returns {object}
     */
    function getHydrationStatus(consumed, goal) {
        const percentage = (consumed / goal) * 100;
        
        if (percentage < 50) return { status: 'Dehydrated', color: 'red', message: 'Drink more water!' };
        if (percentage < 75) return { status: 'Under-hydrated', color: 'orange', message: 'Keep drinking' };
        if (percentage < 100) return { status: 'Good', color: 'yellow', message: 'Almost there!' };
        return { status: 'Hydrated', color: 'green', message: 'Well done!' };
    }

    // ==========================================================================
    // SUPPLEMENT TRACKING & RECOMMENDATIONS
    // ==========================================================================

    const COMMON_SUPPLEMENTS = {
        essentials: [
            { 
                name: "Whey Protein", 
                purpose: "Muscle recovery and growth",
                timing: "Post-workout or between meals",
                dose: "20-40g per serving",
                benefits: ["Muscle protein synthesis", "Convenient protein source", "Fast absorption"]
            },
            {
                name: "Creatine Monohydrate",
                purpose: "Strength and power output",
                timing: "Daily, any time",
                dose: "5g per day",
                benefits: ["Increased strength", "Better work capacity", "Muscle fullness", "Cognitive benefits"]
            },
            {
                name: "Omega-3 Fish Oil",
                purpose: "Heart health and inflammation",
                timing: "With meals",
                dose: "1-3g EPA+DHA per day",
                benefits: ["Joint health", "Cardiovascular support", "Anti-inflammatory", "Brain function"]
            },
            {
                name: "Vitamin D3",
                purpose: "Bone health and immunity",
                timing: "With fat-containing meal",
                dose: "1000-4000 IU per day",
                benefits: ["Bone density", "Immune function", "Mood support", "Testosterone health"]
            },
            {
                name: "Multivitamin",
                purpose: "Micronutrient insurance",
                timing: "With breakfast",
                dose: "As directed on label",
                benefits: ["Fill dietary gaps", "General health support", "Convenience"]
            }
        ],
        performance: [
            {
                name: "Caffeine",
                purpose: "Energy and focus",
                timing: "30-60 min pre-workout",
                dose: "200-400mg",
                benefits: ["Increased alertness", "Better endurance", "Fat oxidation", "Focus"]
            },
            {
                name: "Beta-Alanine",
                purpose: "Muscular endurance",
                timing: "Daily, any time",
                dose: "3-5g per day",
                benefits: ["Reduced fatigue", "Better high-rep performance", "Muscle buffering"]
            },
            {
                name: "Citrulline Malate",
                purpose: "Pump and endurance",
                timing: "30 min pre-workout",
                dose: "6-8g",
                benefits: ["Increased nitric oxide", "Better pumps", "Reduced fatigue", "Recovery"]
            }
        ],
        recovery: [
            {
                name: "Magnesium",
                purpose: "Sleep and recovery",
                timing: "Before bed",
                dose: "200-400mg",
                benefits: ["Better sleep quality", "Muscle relaxation", "Recovery support", "Stress reduction"]
            },
            {
                name: "Zinc",
                purpose: "Immune and hormone health",
                timing: "Before bed",
                dose: "15-30mg",
                benefits: ["Immune function", "Testosterone support", "Recovery", "Protein synthesis"]
            },
            {
                name: "L-Glutamine",
                purpose: "Gut health and recovery",
                timing: "Post-workout or before bed",
                dose: "5-10g",
                benefits: ["Gut health", "Immune support", "Muscle recovery", "Glycogen synthesis"]
            }
        ]
    };

    /**
     * Get supplement recommendations based on goals
     * @param {string} goal - 'muscle_gain', 'fat_loss', 'performance', 'general_health'
     * @returns {Array}
     */
    function getSupplementRecommendations(goal) {
        const base = COMMON_SUPPLEMENTS.essentials.slice(0, 3); // Protein, Creatine, Omega-3
        
        const recommendations = {
            muscle_gain: [...base, 
                COMMON_SUPPLEMENTS.essentials.find(s => s.name === "Vitamin D3"),
                COMMON_SUPPLEMENTS.recovery.find(s => s.name === "Zinc")
            ],
            fat_loss: [
                COMMON_SUPPLEMENTS.essentials.find(s => s.name === "Whey Protein"),
                COMMON_SUPPLEMENTS.essentials.find(s => s.name === "Omega-3 Fish Oil"),
                COMMON_SUPPLEMENTS.performance.find(s => s.name === "Caffeine"),
                COMMON_SUPPLEMENTS.essentials.find(s => s.name === "Multivitamin")
            ],
            performance: [...base,
                ...COMMON_SUPPLEMENTS.performance
            ],
            general_health: COMMON_SUPPLEMENTS.essentials
        };
        
        return recommendations[goal] || COMMON_SUPPLEMENTS.essentials;
    }

    // ==========================================================================
    // WORKOUT PERIODIZATION HELPERS
    // ==========================================================================

    /**
     * Generate a periodized training plan
     * @param {number} weeks - total weeks
     * @param {string} goal - 'strength', 'hypertrophy', 'endurance'
     * @returns {Array}
     */
    function generatePeriodization(weeks, goal = 'hypertrophy') {
        const phases = [];
        
        if (goal === 'strength') {
            // Strength periodization: Hypertrophy -> Strength -> Peaking
            const hypWeeks = Math.floor(weeks * 0.4);
            const strWeeks = Math.floor(weeks * 0.4);
            const peakWeeks = weeks - hypWeeks - strWeeks;
            
            phases.push({
                name: "Hypertrophy Phase",
                weeks: hypWeeks,
                sets: "3-4",
                reps: "8-12",
                intensity: "65-75% 1RM",
                rest: "60-90s",
                focus: "Building muscle mass foundation"
            });
            
            phases.push({
                name: "Strength Phase",
                weeks: strWeeks,
                sets: "4-5",
                reps: "4-6",
                intensity: "80-90% 1RM",
                rest: "3-5 min",
                focus: "Increasing maximal strength"
            });
            
            if (peakWeeks > 0) {
                phases.push({
                    name: "Peaking Phase",
                    weeks: peakWeeks,
                    sets: "3-5",
                    reps: "1-3",
                    intensity: "90-100% 1RM",
                    rest: "5+ min",
                    focus: "Testing and achieving new PRs"
                });
            }
        } else if (goal === 'hypertrophy') {
            // Hypertrophy periodization: Volume accumulation -> Intensification
            const volWeeks = Math.ceil(weeks * 0.7);
            const intWeeks = weeks - volWeeks;
            
            phases.push({
                name: "Volume Accumulation",
                weeks: volWeeks,
                sets: "4-5",
                reps: "10-15",
                intensity: "60-70% 1RM",
                rest: "60-90s",
                focus: "Maximizing training volume"
            });
            
            phases.push({
                name: "Intensification",
                weeks: intWeeks,
                sets: "3-4",
                reps: "6-10",
                intensity: "75-85% 1RM",
                rest: "90-120s",
                focus: "Higher intensity, lower volume"
            });
        }
        
        return phases;
    }

    /**
     * Determine which phase user is in based on workout history
     * @returns {string}
     */
    function getCurrentTrainingPhase() {
        const last4Workouts = (state.workoutHistory || []).slice(-4);
        if (last4Workouts.length < 3) return "Building Base";
        
        let avgReps = 0;
        let setCount = 0;
        
        last4Workouts.forEach(workout => {
            (workout.exercises || []).forEach(ex => {
                (ex.sets || []).forEach(set => {
                    avgReps += parseFloat(set.reps) || 0;
                    setCount++;
                });
            });
        });
        
        avgReps = setCount > 0 ? avgReps / setCount : 0;
        
        if (avgReps >= 12) return "Hypertrophy/Endurance Phase";
        if (avgReps >= 6) return "Hypertrophy Phase";
        if (avgReps >= 4) return "Strength Phase";
        return "Power/Peaking Phase";
    }

    // ==========================================================================
    // INJURY PREVENTION & MOBILITY
    // ==========================================================================

    const MOBILITY_ROUTINES = {
        upper_body: [
            { name: "Cat-Cow Stretch", duration: "60s", muscles: ["Spine", "Core"] },
            { name: "Thread the Needle", duration: "30s each", muscles: ["Thoracic Spine", "Shoulders"] },
            { name: "Shoulder Dislocations", duration: "10 reps", muscles: ["Shoulders", "Chest"] },
            { name: "Wall Slides", duration: "15 reps", muscles: ["Shoulders", "Upper Back"] },
            { name: "Doorway Pec Stretch", duration: "30s each", muscles: ["Chest", "Shoulders"] }
        ],
        lower_body: [
            { name: "90/90 Hip Stretch", duration: "60s each", muscles: ["Hips", "Glutes"] },
            { name: "Couch Stretch", duration: "60s each", muscles: ["Hip Flexors", "Quads"] },
            { name: "Pigeon Pose", duration: "60s each", muscles: ["Glutes", "Hips"] },
            { name: "Standing Hamstring Stretch", duration: "30s each", muscles: ["Hamstrings"] },
            { name: "Calf Stretch", duration: "30s each", muscles: ["Calves", "Achilles"] }
        ],
        full_body: [
            { name: "World's Greatest Stretch", duration: "5 reps each", muscles: ["Full Body"] },
            { name: "Deep Squat Hold", duration: "60s", muscles: ["Ankles", "Hips", "Lower Back"] },
            { name: "Spinal Twist", duration: "30s each", muscles: ["Spine", "Core"] },
            { name: "Child's Pose", duration: "60s", muscles: ["Back", "Shoulders"] },
            { name: "Down Dog to Cobra", duration: "10 reps", muscles: ["Spine", "Hips", "Shoulders"] }
        ]
    };

    /**
     * Recommend mobility work based on workout focus
     * @param {string} workoutFocus
     * @returns {Array}
     */
    function getMobilityRecommendation(workoutFocus) {
        const lower = workoutFocus.toLowerCase();
        
        if (lower.includes('chest') || lower.includes('push') || lower.includes('shoulder')) {
            return MOBILITY_ROUTINES.upper_body;
        }
        if (lower.includes('leg') || lower.includes('squat') || lower.includes('deadlift')) {
            return MOBILITY_ROUTINES.lower_body;
        }
        return MOBILITY_ROUTINES.full_body;
    }

    // ==========================================================================
    // CARDIO & CONDITIONING TEMPLATES
    // ==========================================================================

    const CARDIO_WORKOUTS = {
        hiit: [
            {
                name: "Sprint Intervals",
                duration: "20 min",
                protocol: "30s sprint / 90s walk x 10 rounds",
                intensity: "Very High",
                calories: "~250-350"
            },
            {
                name: "Bike Tabata",
                duration: "20 min",
                protocol: "20s max effort / 10s rest x 8 rounds, 4 sets",
                intensity: "Maximum",
                calories: "~200-300"
            },
            {
                name: "Rowing Intervals",
                duration: "25 min",
                protocol: "2 min hard / 1 min easy x 8 rounds",
                intensity: "High",
                calories: "~300-400"
            }
        ],
        liss: [
            {
                name: "Steady State Treadmill",
                duration: "45 min",
                protocol: "Maintain 60-70% max HR",
                intensity: "Low-Moderate",
                calories: "~350-450"
            },
            {
                name: "Incline Walk",
                duration: "30 min",
                protocol: "3-4% incline, conversational pace",
                intensity: "Low",
                calories: "~250-350"
            },
            {
                name: "Easy Cycling",
                duration: "60 min",
                protocol: "Comfortable pace, minimal resistance",
                intensity: "Low",
                calories: "~400-550"
            }
        ],
        conditioning: [
            {
                name: "Battle Ropes Circuit",
                duration: "15 min",
                protocol: "30s work / 30s rest, various patterns",
                intensity: "High",
                calories: "~200-280"
            },
            {
                name: "Sled Push/Pull",
                duration: "20 min",
                protocol: "40m push, 40m pull, 2 min rest x 6",
                intensity: "Very High",
                calories: "~250-350"
            },
            {
                name: "Farmers Walks",
                duration: "15 min",
                protocol: "40m walk, 90s rest x 8",
                intensity: "Moderate-High",
                calories: "~180-250"
            }
        ]
    };

    /**
     * Recommend cardio based on training goals
     * @param {string} goal
     * @returns {object}
     */
    function getCardioRecommendation(goal) {
        if (goal === 'fat_loss') {
            return {
                primary: CARDIO_WORKOUTS.liss[1], // Incline walk
                secondary: CARDIO_WORKOUTS.hiit[0], // Sprint intervals
                frequency: "4-5x per week",
                notes: "LISS for steady fat burn, HIIT 1-2x for metabolic boost"
            };
        }
        if (goal === 'muscle_gain') {
            return {
                primary: CARDIO_WORKOUTS.liss[2], // Easy cycling
                secondary: null,
                frequency: "2-3x per week",
                notes: "Keep cardio minimal and low-intensity to preserve recovery"
            };
        }
        if (goal === 'endurance') {
            return {
                primary: CARDIO_WORKOUTS.liss[0], // Steady state
                secondary: CARDIO_WORKOUTS.hiit[2], // Rowing intervals
                frequency: "5-6x per week",
                notes: "Mix of LISS and HIIT for cardiovascular adaptation"
            };
        }
        return {
            primary: CARDIO_WORKOUTS.liss[1],
            frequency: "3-4x per week",
            notes: "General cardiovascular health maintenance"
        };
    }

    // ==========================================================================
    // SLEEP & RECOVERY TRACKING
    // ==========================================================================

    /**
     * Calculate sleep quality score
     * @param {number} hours - hours slept
     * @param {number} interruptions - number of wake-ups
     * @param {string} feeling - 'refreshed', 'okay', 'tired'
     * @returns {object}
     */
    function calculateSleepQuality(hours, interruptions, feeling) {
        let score = 50;
        
        // Hours component (0-40 points)
        if (hours >= 7 && hours <= 9) score += 40;
        else if (hours >= 6) score += 25;
        else if (hours >= 5) score += 10;
        
        // Interruptions component (0-30 points)
        if (interruptions === 0) score += 30;
        else if (interruptions === 1) score += 20;
        else if (interruptions === 2) score += 10;
        
        // Feeling component (0-30 points)
        const feelingScores = { refreshed: 30, okay: 15, tired: 0 };
        score += feelingScores[feeling] || 0;
        
        let grade = 'Poor';
        if (score >= 90) grade = 'Excellent';
        else if (score >= 75) grade = 'Good';
        else if (score >= 60) grade = 'Fair';
        
        return { score, grade, hours, interruptions, feeling };
    }

    /**
     * Get recovery recommendations
     * @param {object} sleepData
     * @param {number} trainingLoad
     * @returns {Array}
     */
    function getRecoveryRecommendations(sleepData, trainingLoad) {
        const recommendations = [];
        
        if (sleepData && sleepData.hours < 7) {
            recommendations.push("Prioritize 7-9 hours of sleep for optimal recovery");
        }
        
        if (trainingLoad > 350) {
            recommendations.push("High training load detected - consider active recovery or rest day");
        }
        
        if (sleepData && sleepData.interruptions > 2) {
            recommendations.push("Poor sleep quality - focus on sleep hygiene and bedtime routine");
        }
        
        const deload = shouldDeload();
        if (deload.should) {
            recommendations.push(deload.reason);
        }
        
        if (recommendations.length === 0) {
            recommendations.push("Recovery status looks good! Keep up the great work.");
        }
        
        return recommendations;
    }

    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================

    window.addEventListener('DOMContentLoaded', () => {
        // Init date pickers to today
        const today = new Date().toISOString().split('T')[0];
        ['workout-date-picker','nutrition-date-picker','metrics-date-picker'].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.value = today;
        });
        lucide.createIcons();
    });

    </script>
</body>
</html>
