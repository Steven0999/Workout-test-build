<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Integrated Fitness Dashboard (Local Storage)</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js for History Graphs -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');

body {

font-family: 'Inter', sans-serif;

background-color: #f0f4f8;

transition: all 0.3s ease;

}

/* Custom scrollbar for better aesthetics */

.custom-scroll::-webkit-scrollbar {

width: 6px;

}

.custom-scroll::-webkit-scrollbar-thumb {

background-color: #9ca3af;

border-radius: 3px;

}

.custom-scroll::-webkit-scrollbar-track {

background-color: #e5e7eb;

}

.view-container {

min-height: calc(100vh - 4rem);

}

/* Modal transitions */

.modal-metrics { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }

.fade-in { opacity: 1; transform: translateY(0); }

.fade-out { opacity: 0; transform: translateY(-10px); }

</style>

<script>

// Tailwind config to ensure Inter font is used

tailwind.config = {

theme: {

extend: {

fontFamily: {

sans: ['Inter', 'sans-serif'],

},

}

}

}

</script>

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</head>

<body class="bg-gray-100 text-gray-800">



<div class="max-w-5xl mx-auto space-y-6 p-4 md:space-y-8 md:p-6">


<div id="message-box" class="fixed top-4 right-4 left-4 md:left-auto md:w-96 z-50 p-4 bg-green-100 text-green-800 border-l-4 border-green-500 rounded-lg shadow-xl font-medium hidden transition-opacity duration-300 ease-in-out opacity-0">

<p id="message-text"></p>

</div>


<div id="status-message" class="hidden mb-6"></div>



<!-- MAIN DASHBOARD -->

<div id="view-dashboard" class="view-container space-y-6">

<header class="bg-white p-6 rounded-2xl shadow-xl transition-all hover:shadow-2xl">

<h1 class="text-2xl md:text-4xl font-black text-gray-900 mb-4 text-center md:text-left">Fitness Dashboard</h1>

<div class="flex flex-col md:flex-row md:space-x-8 space-y-2 md:space-y-0 text-sm md:text-lg items-center md:items-start text-center md:text-left">

<p class="text-gray-600">

<span class="font-bold text-indigo-600">Mode:</span> <span class="font-mono text-xs md:text-sm bg-indigo-100 text-indigo-700 p-1 rounded">Local Storage</span>

</p>

<p class="text-gray-600">

<span class="font-bold text-indigo-600">Name:</span> <span id="user-name">Guest User</span>

</p>

<p class="text-gray-600">

<span class="font-bold text-indigo-600">Goal:</span> <span id="user-goal">Set Goal in Config</span>

</p>

</div>

</header>



<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">


<button type="button" onclick="showView('gym-config')" class="bg-indigo-500 text-white font-bold py-6 px-6 rounded-xl text-xl shadow-lg hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.02] flex flex-col items-center justify-center min-h-[140px]">

<i class="fas fa-dumbbell text-3xl mb-2"></i>

<span>Configure Gym</span>

<span id="current-gym-status" class="mt-1 text-xs opacity-80 italic font-normal"></span>

</button>


<button type="button" onclick="showView('plan-workout')" class="bg-green-500 text-white font-bold py-6 px-6 rounded-xl text-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-[1.02] flex flex-col items-center justify-center min-h-[140px]">

<i class="fas fa-running text-3xl mb-2"></i>

<span>Plan Workout</span>

</button>


<button type="button" onclick="showView('meal-log')" class="bg-yellow-500 text-white font-bold py-6 px-6 rounded-xl text-xl shadow-lg hover:bg-yellow-600 transition duration-150 transform hover:scale-[1.02] flex flex-col items-center justify-center min-h-[140px]">

<i class="fas fa-utensils text-3xl mb-2"></i>

<span>Nutrition Tracker</span>

</button>


<button type="button" onclick="showView('body-metrics')" class="bg-purple-500 text-white font-bold py-6 px-6 rounded-xl text-xl shadow-lg hover:bg-purple-600 transition duration-150 transform hover:scale-[1.02] flex flex-col items-center justify-center min-h-[140px]">

<i class="fas fa-ruler-combined text-3xl mb-2"></i>

<span>Body Metrics</span>

</button>


<button type="button" id="view-history-btn" class="bg-gray-500 text-white font-bold py-6 px-6 rounded-xl text-xl shadow-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02] flex flex-col items-center justify-center min-h-[140px]">

<i class="fas fa-chart-line text-3xl mb-2"></i>

<span>View History</span>

</button>


</div>


<div class="text-center mt-8 pb-8">

<button onclick="resetApp()" class="text-xs text-red-400 hover:text-red-600 underline p-4">Reset App Data (Deletes all local data)</button>

</div>

</div>



<!-- GYM CONFIG -->

<div id="view-gym-config" class="view-container p-4 md:p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">

<div class="flex justify-between items-center border-b pb-4">

<h2 class="text-xl md:text-3xl font-bold text-indigo-700 truncate"><i class="fas fa-cogs mr-2"></i> Gym Setup</h2>

<button type="button" onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition whitespace-nowrap">

&larr; <span class="hidden sm:inline">Dashboard</span>

</button>

</div>


<form id="gym-setup-form" class="space-y-6">

<div class="space-y-2">

<label for="gym-name" class="block text-sm font-medium text-gray-700">Gym Profile Name</label>

<input type="text" id="gym-name" name="gym-name" value="My Home Gym" required

class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-base">

</div>



<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

<div class="bg-gray-50 p-4 rounded-xl border border-gray-200">

<h3 class="font-semibold text-lg text-gray-800 mb-2 flex items-center"><i class="fas fa-weight-hanging mr-2 text-indigo-500"></i> Weights</h3>

<div id="weights-options" class="space-y-2 text-sm"></div>

</div>

<div class="bg-gray-50 p-4 rounded-xl border border-gray-200">

<h3 class="font-semibold text-lg text-gray-800 mb-2 flex items-center"><i class="fas fa-heartbeat mr-2 text-red-500"></i> Cardio</h3>

<div id="cardio-options" class="space-y-2 text-sm"></div>

</div>

<div class="bg-gray-50 p-4 rounded-xl border border-gray-200">

<h3 class="font-semibold text-lg text-gray-800 mb-2 flex items-center"><i class="fas fa-expand-alt mr-2 text-green-500"></i> Functional</h3>

<div id="floor-options" class="space-y-2 text-sm"></div>

</div>

</div>



<button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg text-lg sticky bottom-4">

<i class="fas fa-save mr-2"></i> Save Setup

</button>

</form>

</div>


<!-- MEAL LOG -->

<div id="view-meal-log" class="view-container p-4 md:p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">

<div class="flex justify-between items-center border-b pb-4">

<h2 class="text-xl md:text-3xl font-bold text-yellow-600 truncate"><i class="fas fa-apple-alt mr-2"></i> Log Meal</h2>

<button type="button" onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition whitespace-nowrap">

&larr; <span class="hidden sm:inline">Dashboard</span>

</button>

</div>


<form id="add-meal-form" class="space-y-4">

<input type="text" placeholder="Meal Name (e.g., Chicken & Rice)" required name="meal-name"

class="w-full p-4 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500 text-base">

<textarea placeholder="Nutritional Details / Ingredients" rows="4" name="meal-details"

class="w-full p-4 border border-gray-300 rounded-xl focus:ring-yellow-500 focus:border-yellow-500 text-base"></textarea>

<button type="submit" class="w-full py-4 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 shadow-lg text-lg">

<i class="fas fa-plus-circle mr-2"></i> Log Meal

</button>

</form>


<div id="logged-meals-summary" class="mt-6 space-y-3 p-4 bg-gray-50 rounded-xl border">

<h3 class="text-xl font-bold text-gray-700">Today's Meals</h3>

<p class="text-gray-500 italic" id="meal-list-placeholder">No meals logged today.</p>

</div>

</div>


<!-- PLAN WORKOUT -->

<div id="view-plan-workout" class="view-container p-4 md:p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">

<div class="flex justify-between items-center border-b pb-4">

<h2 class="text-xl md:text-3xl font-bold text-green-600 truncate"><i class="fas fa-hand-rock mr-2"></i> Plan Workout</h2>

<div class="space-x-2">

<button type="button" onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition whitespace-nowrap">

&larr; <span class="hidden sm:inline">Dashboard</span>

</button>

</div>

</div>


<form id="workout-planning-form" class="space-y-4">

<div>

<label for="workout-focus" class="block text-sm font-medium text-gray-700 mb-2">What are you training?</label>

<select id="workout-focus"

class="w-full p-4 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150 text-base h-14">

</select>

</div>



<div id="muscle-checkboxes" class="hidden">

<p class="text-sm font-medium text-gray-700 mb-2">Select Target Muscles:</p>

<div id="muscle-options" class="grid grid-cols-2 sm:grid-cols-3 gap-3 p-3 bg-gray-50 rounded-xl border border-gray-200">

</div>

</div>


<button type="submit" class="w-full py-4 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg text-lg mt-4">

<i class="fas fa-forward mr-2"></i> Start Workout

</button>

</form>

</div>



<!-- TRACK WORKOUT -->

<div id="view-track-workout" class="view-container p-4 md:p-6 bg-white rounded-2xl shadow-2xl border-2 border-green-500 space-y-6 hidden">

<div class="flex justify-between items-center border-b pb-4">

<h2 class="text-lg md:text-3xl font-extrabold text-green-700 truncate"><span id="active-workout-title">Workout</span></h2>

<div class="flex space-x-2">

<button type="button" id="open-equipment-modal-btn" class="text-xs md:text-sm py-2 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-md whitespace-nowrap">

<i class="fas fa-tools"></i> <span class="hidden sm:inline">Equip</span>

</button>

<button type="button" onclick="saveWorkout(true); showView('dashboard')" class="text-xs md:text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition shadow-md whitespace-nowrap">

<i class="fas fa-check"></i> <span class="hidden sm:inline">Finish</span>

</button>

</div>

</div>


<form id="add-exercise-form" class="space-y-4 p-4 bg-green-50 rounded-xl border border-green-200">

<h3 class="text-xl font-bold text-green-800"><i class="fas fa-plus mr-2"></i> Add Exercise</h3>


<div>

<label for="exercise-select" class="block text-sm font-medium text-gray-700 mb-1">Choose Exercise</label>

<select id="exercise-select" required

class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-green-500 focus:border-green-500 transition duration-150 h-12 text-base">

<option value="">-- Select an Exercise --</option>

</select>

</div>


<div class="grid grid-cols-2 gap-4">

<div>

<label for="sets-input" class="block text-sm font-medium text-gray-700 mb-1">Sets</label>

<input type="number" id="sets-input" value="3" min="1" max="10" required

class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-center text-lg h-12">

</div>

<div>

<label for="target-reps-input" class="block text-sm font-medium text-gray-700 mb-1">Target Reps</label>

<input type="number" id="target-reps-input" value="10" min="1" max="50" required

class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-center text-lg h-12">

</div>

</div>



<button type="button" id="start-sets-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150 shadow-md text-lg">

<i class="fas fa-cog mr-2"></i> Configure Sets

</button>

</form>



<div id="sets-tracking-container" class="space-y-4">

</div>


<div id="logged-exercises-summary" class="mt-8 space-y-4">

<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises</h3>

</div>


<button type="button" id="finish-workout-btn" class="mt-8 w-full py-4 bg-indigo-600 text-white font-extrabold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-2xl text-lg">

<i class="fas fa-flag-checkered mr-2"></i> Finish & Save Workout

</button>

</div>



<!-- BODY METRICS VIEW -->

<div id="view-body-metrics" class="view-container p-4 md:p-6 bg-white rounded-2xl shadow-xl space-y-6 hidden">

<div class="flex justify-between items-center border-b pb-4">

<h2 class="text-xl md:text-3xl font-bold text-purple-700 truncate"><i class="fas fa-ruler-combined mr-2"></i> Metrics & Pics</h2>

<button type="button" onclick="showView('dashboard')" class="text-sm py-2 px-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition whitespace-nowrap">

&larr; <span class="hidden sm:inline">Dashboard</span>

</button>

</div>


<button type="button" id="add-measurement-btn-metrics"

class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center text-lg mb-6"

onclick="openSnapshotModal()">

<i class="fas fa-camera-retro mr-2"></i> Take Daily Snapshot

</button>



<div id="measurements-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">

<p class="text-gray-500 italic text-center p-8 bg-gray-50 rounded-xl col-span-full">Loading progress history...</p>

</div>



</div>



<!-- HISTORY MODAL (WITH CHART) -->

<div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-2 hidden">

<div class="bg-white w-full max-w-2xl max-h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">

<div class="p-4 border-b flex justify-between items-center bg-gray-50">

<h2 class="text-xl font-bold text-indigo-700"><i class="fas fa-medal mr-2"></i> Exercise History</h2>

<button type="button" id="close-history-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition px-2">&times;</button>

</div>


<!-- CHART CONTAINER -->

<div class="p-4 bg-white border-b border-gray-200 hidden" id="chart-container">

<h3 id="chart-title" class="text-lg font-bold text-gray-700 mb-2 text-center"></h3>

<div class="relative h-48 sm:h-64 w-full">

<canvas id="exerciseChart"></canvas>

</div>

<button type="button" onclick="closeChart()" class="mt-3 w-full py-2 bg-indigo-50 text-indigo-600 text-sm rounded-lg hover:bg-indigo-100 transition">Close Chart</button>

</div>



<div id="history-content" class="p-4 overflow-y-auto custom-scroll space-y-3 flex-grow bg-gray-50">

<p class="text-gray-500 italic text-center">No history yet.</p>

</div>

</div>

</div>


<!-- EQUIPMENT MODAL -->

<div id="equipment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-2 hidden">

<div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">

<div class="p-4 border-b flex justify-between items-center bg-blue-100">

<h2 class="text-xl font-bold text-blue-700"><i class="fas fa-sliders-h mr-2"></i> Adjust Equipment</h2>

<button type="button" id="close-equipment-modal-btn" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none transition px-2">&times;</button>

</div>

<div class="p-4 overflow-y-auto custom-scroll flex-grow">

<form id="active-gym-setup-form" class="space-y-6">

<p class="text-sm text-gray-600 mb-4">Temporarily adjust what equipment is available.</p>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">

<div class="bg-gray-50 p-3 rounded-xl border border-gray-200">

<h3 class="font-semibold text-gray-800 mb-2">Weights</h3>

<div id="active-weights-options" class="space-y-2 text-sm"></div>

</div>

<div class="bg-gray-50 p-3 rounded-xl border border-gray-200">

<h3 class="font-semibold text-gray-800 mb-2">Cardio</h3>

<div id="active-cardio-options" class="space-y-2 text-sm"></div>

</div>

<div class="bg-gray-50 p-3 rounded-xl border border-gray-200">

<h3 class="font-semibold text-gray-800 mb-2">Functional</h3>

<div id="active-floor-options" class="space-y-2 text-sm"></div>

</div>

</div>

<button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-150 shadow-lg mt-4">

<i class="fas fa-check-circle mr-2"></i> Apply & Close

</button>

</form>

</div>

</div>

</div>



<!-- SNAPSHOT MODAL -->

<div id="snapshot-modal" class="modal-metrics fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-2 opacity-0 pointer-events-none">

<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[95vh] transform fade-out transition-all flex flex-col">

<div class="p-4 md:p-6 overflow-y-auto flex-grow custom-scroll">

<h2 class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">Daily Snapshot</h2>

<form id="snapshot-form" class="space-y-4 md:space-y-6">


<!-- 1. Weight Input -->

<div class="p-3 bg-purple-50 rounded-lg border border-purple-200">

<h3 class="font-semibold text-purple-700 mb-2"><i class="fas fa-scale-balanced mr-2"></i> Weight</h3>

<div class="flex space-x-2">

<input id="weight-input" type="number" step="0.1" placeholder="80.5" required

class="w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm text-lg"

/>

<select id="weight-unit-select" class="w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm text-base">

<option value="kg">kg</option>

<option value="lbs">lbs</option>

</select>

</div>

</div>



<!-- 2. Picture Upload -->

<div class="p-3 bg-purple-50 rounded-lg border border-purple-200">

<h3 class="font-semibold text-purple-700 mb-2"><i class="fas fa-camera mr-2"></i> Photo (Optional)</h3>

<input type="file" id="photo-file-input" accept="image/jpeg, image/png"

class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-100 file:text-purple-700 hover:file:bg-purple-200"

/>

<div id="photo-preview-container" class="mt-3 hidden">

<img id="photo-preview" class="max-w-full max-h-48 rounded-lg shadow-md border border-gray-300 object-contain mx-auto" alt="Photo Preview"/>

</div>

</div>



<!-- 3. Circumference Measurements -->

<div class="p-3 bg-purple-50 rounded-lg border border-purple-200">

<h3 class="font-semibold text-purple-700 mb-2 flex justify-between items-center">

<span><i class="fas fa-tape mr-2"></i> Measurements</span>

<button type="button" onclick="addMeasurementGroup()" class="text-xs bg-purple-200 text-purple-800 px-3 py-1.5 rounded-full hover:bg-purple-300 transition">

<i class="fas fa-plus mr-1"></i> Add

</button>

</h3>

<div id="circumference-groups-container" class="space-y-3">

<!-- Measurement groups will be added here -->

</div>

</div>



<button type="submit" id="save-snapshot-btn" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50 flex items-center justify-center text-lg">

<i class="fas fa-save mr-2"></i> Save Snapshot

</button>

</form>

</div>

<button type="button"

onclick="closeSnapshotModal()"

class="w-full py-3 bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition duration-150 rounded-b-xl"

>

Cancel

</button>

</div>

</div>



</div>



<script>

// --- LOCAL STORAGE KEYS ---

const LS_KEY_STATE = 'FT_GLOBAL_STATE';

const LS_KEY_WORKOUTS = 'FT_WORKOUT_LOG';

const LS_KEY_MEALS = 'FT_MEAL_LOG';

const LS_KEY_METRICS = 'FT_DAILY_SNAPSHOTS';



// --- GLOBAL STATE ---

let state = {

currentView: 'dashboard',

userName: "Guest User",

goal: "Set Goal in Config",

gymName: "My Home Gym",

gymSetup: { weights: ["dumbbell", "bench", "barbell", "cables", "weighted machines"], cardio: ["treadmill", "rower"], floor: ["TRX", "sandbag"] },

exerciseHistory: {},

currentWorkout: null,

workoutLog: [],

mealLog: [],

previousView: 'dashboard',

};



let historyChartInstance = null;



// --- DATA CONSTANTS ---

const EQUIPMENT_MAP = {
weights: ["barbell", "dumbbell", "pinstack machines", "weighted machines", "cables machine", "smith machine", "back extension"],
cardio: ["treadmill", "bike", "rower", "cross trainer", "assault bike", "ski erg", "step machine"],
floor: ["TRX", "Ropes", "sandbag", "medicine ball", "slam ball", "floor"],
};



const FOCUS_OPTIONS = [
"Full Body", "Upper Body", "Lower Body", "Press", "Pull", "Squat", "Hinge", "Specific Muscles", "Cardio"
];


const MUSCLE_GROUPS = [
"biceps", "triceps", "shoulders", "quads", "hamstrings", "abs", "chest", "lats", "upper back", "glutes", "calves"
];


const CIRCUMFERENCE_AREAS = [
'Chest', 'Waist', 'Hips', 'Right Bicep', 'Left Bicep', 'Right Thigh', 'Left Thigh','Right Calf', 'Left Calf', 'Shoulders',
];



const EXERCISE_LIBRARY = [

{ name: "Barbell Clean & Press", equipment: ["barbell"], focus: ["Full Body", "Press", "shoulders", "quads", "glutes"] },
{ name: "Dumbbell Thrusters", equipment: ["dumbbell"], focus: ["Full Body", "Squat", "Press", "shoulders", "quads"] },
{ name: "Sandbag Get-Ups", equipment: ["sandbag", "floor"], focus: ["Full Body", "abs", "shoulders"] },
{ name: "Medicine Ball Slams", equipment: ["medicine ball", "slam ball"], focus: ["Full Body", "abs"] },
{ name: "Barbell Bench Press", equipment: ["bench", "barbell"], focus: ["Upper Body", "Press", "chest", "triceps", "shoulders"] },
{ name: "Dumbbell Overhead Press", equipment: ["dumbbell"], focus: ["Upper Body", "Press", "shoulders", "triceps"] },
{ name: "Machine Chest Press", equipment: ["weighted machines", "pinstack machines"], focus: ["Upper Body", "Press", "chest", "triceps"] },
{ name: "Cable Crossover (High)", equipment: ["cables machine"], focus: ["Upper Body", "Press", "chest"] },
{ name: "Dumbbell Incline Press", equipment: ["bench", "dumbbell"], focus: ["Upper Body", "Press", "chest", "shoulders"] },
{ name: "Pinstack Shoulder Press", equipment: ["pinstack machines"], focus: ["Press", "shoulders", "triceps"] },
{ name: "Barbell Bent-Over Row", equipment: ["barbell"], focus: ["Upper Body", "Pull", "lats", "upper back", "biceps"] },
{ name: "Dumbbell Single-Arm Row", equipment: ["dumbbell", "bench"], focus: ["Upper Body", "Pull", "lats", "upper back"] },
{ name: "Cable Face Pulls", equipment: ["cables machine"], focus: ["Upper Body", "Pull", "upper back", "shoulders"] },
{ name: "Lat Pulldown (Machine)", equipment: ["pinstack machines"], focus: ["Upper Body", "Pull", "lats", "biceps"] },
{ name: "TRX Inverted Row", equipment: ["TRX"], focus: ["Upper Body", "Pull", "upper back", "biceps"] },
{ name: "Seated Cable Row", equipment: ["cables machine"], focus: ["Pull", "upper back", "lats", "biceps"] },
{ name: "Barbell Back Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes", "hamstrings"] },
{ name: "Barbell Front Squat", equipment: ["barbell"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
{ name: "Dumbbell Split Squat", equipment: ["dumbbell"], focus: ["Lower Body", "Squat", "quads"] },
{ name: "Dumbbell Goblet Squat", equipment: ["dumbbell", "floor"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
{ name: "Leg Extension (Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Squat", "quads"] },
{ name: "Leg Press (Machine)", equipment: ["weighted machines"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
{ name: "Dumbbell Bulgarian Split Squat", equipment: ["dumbbell", "bench"], focus: ["Lower Body", "Squat", "quads", "glutes"] },
{ name: "Dumbbell B stance Squat", equipment: ["dumbbell"], focus: ["Lower Body", "Squat", "glutes"] },
{ name: "Barbell Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes", "Full Body", "lats"] },
{ name: "Dumbbell Romanian Deadlift", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
{ name: "Barbell Romanian Deadlift", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "Cable Pull-Through", equipment: ["cables machine"], focus: ["Lower Body", "Hinge", "glutes", "hamstrings"] },
{ name: "Leg Curl (Machine)", equipment: ["pinstack machines", "weighted machines"], focus: ["Lower Body", "hamstrings"] },
{ name: "Glute-Ham Raise (Floor)", equipment: ["floor"], focus: ["Lower Body", "Hinge", "hamstrings", "glutes"] },
{ name: "Barbell Hip Thrusts", equipment: ["barbell"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "Smith Machine Reverse Lunges", equipment: ["smith machine"], focus: ["Lower Body", "Hinge", "glutes","quads"] },
{ name: "Dumbbell Reverse Lunges", equipment: ["dumbbell"], focus: ["Lower Body","Hinge", "glutes", "quads"] },
{ name: "Hip Thrusts (Plate Machine) ", equipment: ["weighted machines"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "Hip Thrusts (Pin Machine)", equipment: ["pinstack machines"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "Single Leg Hip Thrusts (Dumbbell)", equipment: ["dumbbell"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "45 degree hip extenstions", equipment: ["back extension"], focus: ["Hinge", "glutes"] },
{ name: "Dumbbell Hammer Curl", equipment: ["dumbbell"], focus: ["biceps"] },
{ name: "Barbell Bicep Curl", equipment: ["barbell"], focus: ["biceps"] },
{ name: "Cable Rope Tricep Pushdown", equipment: ["cables machine"], focus: ["triceps"] },
{ name: "Dumbbell Skullcrushers", equipment: ["dumbbell", "bench"], focus: ["triceps"] },
{ name: "Dumbbell Lateral Raise", equipment: ["dumbbell"], focus: ["shoulders"] },
{ name: "Cable Rear Delt Fly", equipment: ["cables machine"], focus: ["shoulders", "upper back"] },
{ name: "Seated Machine Hip Abduction", equipment: ["weighted machines"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "Cable Machine Single Leg Abduction", equipment: ["cables machine"], focus: ["Lower Body", "Hinge", "glutes"] },
{ name: "Hanging Leg Raise", equipment: ["floor"], focus: ["abs"] },
{ name: "Weighted Machine Crunch", equipment: ["weighted machines"], focus: ["abs"] },
{ name: "Dumbbell Calf Raise", equipment: ["dumbbell"], focus: ["calves"] },
{ name: "Hyperextension (Floor)", equipment: ["floor"], focus: ["hamstrings", "glutes"] },
{ name: "Treadmill 5K Run", equipment: ["treadmill"], focus: ["Cardio", "Full Body"] },
{ name: "Rower 2000m Sprint", equipment: ["rower"], focus: ["Cardio", "Full Body"] },
{ name: "Assault Bike Interval", equipment: ["assault bike"], focus: ["Cardio", "Full Body"] },
{ name: "Cross Trainer Endurance", equipment: ["cross trainer"], focus: ["Cardio", "Full Body"] },
{ name: "Ski Erg 10 Minute Challenge", equipment: ["ski erg"], focus: ["Cardio", "Full Body", "Upper Body", "Pull"] },
{ name: "Step Machine Climb", equipment: ["step machine"], focus: ["Cardio", "Lower Body"] },

];



// --- DOM ELEMENTS ---

const views = ['dashboard', 'gym-config', 'meal-log', 'plan-workout', 'track-workout', 'body-metrics'];

const viewElements = views.reduce((acc, id) => { acc[id] = document.getElementById(`view-${id}`); return acc; }, {});


const gymSetupForm = document.getElementById('gym-setup-form');

const currentGymStatus = document.getElementById('current-gym-status');

const workoutPlanningForm = document.getElementById('workout-planning-form');

const workoutFocusSelect = document.getElementById('workout-focus');

const muscleCheckboxesDiv = document.getElementById('muscle-checkboxes');

const muscleOptionsDiv = document.getElementById('muscle-options');

const activeWorkoutTitle = document.getElementById('active-workout-title');

const exerciseSelect = document.getElementById('exercise-select');

const setsInput = document.getElementById('sets-input');

const targetRepsInput = document.getElementById('target-reps-input');

const setsTrackingContainer = document.getElementById('sets-tracking-container');

const loggedExercisesSummary = document.getElementById('logged-exercises-summary');

const historyModal = document.getElementById('history-modal');

const historyContent = document.getElementById('history-content');

const chartContainer = document.getElementById('chart-container');

const chartTitle = document.getElementById('chart-title');

const equipmentModal = document.getElementById('equipment-modal');

const activeGymSetupForm = document.getElementById('active-gym-setup-form');

const messageBox = document.getElementById('message-box');

const messageText = document.getElementById('message-text');

const loggedMealsSummary = document.getElementById('logged-meals-summary');

const mealListPlaceholder = document.getElementById('meal-list-placeholder');

const measurementsContainer = document.getElementById('measurements-container');

const snapshotModalEl = document.getElementById('snapshot-modal');

const snapshotModalContentEl = snapshotModalEl.querySelector('.transform');

const snapshotForm = document.getElementById('snapshot-form');

const circumferenceGroupsContainer = document.getElementById('circumference-groups-container');

const photoFileInput = document.getElementById('photo-file-input');

const photoPreview = document.getElementById('photo-preview');

const photoPreviewContainer = document.getElementById('photo-preview-container');



// --- LOCAL STORAGE FUNCTIONS ---

function saveCoreState() { localStorage.setItem(LS_KEY_STATE, JSON.stringify({ gymName: state.gymName, gymSetup: state.gymSetup, exerciseHistory: state.exerciseHistory, userName: state.userName, goal: state.goal })); }


function loadCoreState() {

try {

const data = JSON.parse(localStorage.getItem(LS_KEY_STATE));

if (data) {

state.gymName = data.gymName || state.gymName;

state.gymSetup.weights = (data.gymSetup && data.gymSetup.weights) ? data.gymSetup.weights : state.gymSetup.weights;

state.gymSetup.cardio = (data.gymSetup && data.gymSetup.cardio) ? data.gymSetup.cardio : state.gymSetup.cardio;

state.gymSetup.floor = (data.gymSetup && data.gymSetup.floor) ? data.gymSetup.floor : state.gymSetup.floor;

state.exerciseHistory = data.exerciseHistory || state.exerciseHistory;

state.userName = data.userName || state.userName;

state.goal = data.goal || state.goal;

}

} catch (e) { console.error("Error loading core state", e); }

}



function saveMealLog() { localStorage.setItem(LS_KEY_MEALS, JSON.stringify(state.mealLog)); }

function loadMealLog() { try { state.mealLog = JSON.parse(localStorage.getItem(LS_KEY_MEALS)) || []; } catch(e) { console.error(e); } }

function saveWorkoutLog() { localStorage.setItem(LS_KEY_WORKOUTS, JSON.stringify(state.workoutLog)); }

function loadWorkoutLog() { try { state.workoutLog = JSON.parse(localStorage.getItem(LS_KEY_WORKOUTS)) || []; } catch(e) { console.error(e); } }

function saveMetrics(m) { localStorage.setItem(LS_KEY_METRICS, JSON.stringify(m)); }

function loadMetrics() { try { const d = JSON.parse(localStorage.getItem(LS_KEY_METRICS)); return d ? d.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)) : []; } catch(e){ return []; } }


window.resetApp = function() {

if(confirm("Are you sure? This deletes ALL data.")) {

localStorage.clear();

location.reload();

}

}



// --- UTILITY ---

window.showView = function(viewName, updateHistory = true) {

if (state.currentWorkout && state.currentWorkout.currentExercise && viewName !== 'track-workout') { if (!confirmExit()) return; }

if (updateHistory && state.currentView !== viewName) state.previousView = state.currentView;

views.forEach(id => { if(viewElements[id]) { viewElements[id].classList.add('hidden'); viewElements[id].classList.remove('block'); } });

if(viewElements[viewName]) { viewElements[viewName].classList.remove('hidden'); viewElements[viewName].classList.add('block'); state.currentView = viewName; }

if (viewName === 'gym-config') { renderGymSetupCheckboxes(document.getElementById('weights-options'), document.getElementById('cardio-options'), document.getElementById('floor-options')); document.getElementById('gym-name').value = state.gymName; }

else if (viewName === 'plan-workout') { renderWorkoutFocus(); renderMuscleCheckboxes(); }

else if (viewName === 'track-workout') {

activeWorkoutTitle.textContent = state.currentWorkout ? state.currentWorkout.title : 'No Active Workout';

populateTrackingExerciseDropdown();

renderActiveEquipmentModal();

updateLoggedExercisesSummary();

}

else if (viewName === 'meal-log') renderMealLogSummary();

else if (viewName === 'body-metrics') loadAndRenderMetrics();

updateDashboardStatus();

}



function confirmExit() { showMessage("Unsaved exercise cleared. Workout session remains active.", 'info', 5000); setsTrackingContainer.innerHTML = ''; state.currentWorkout.currentExercise = null; return true; }

function showMessage(msg, type='success', duration=3000) {

let cls = type==='success' ? ['bg-green-100','border-green-500','text-green-800'] : (type==='error'?['bg-red-100','border-red-500','text-red-800']:['bg-blue-100','border-blue-500','text-blue-800']);

messageBox.className = `fixed top-4 right-4 left-4 md:left-auto md:w-96 z-50 p-4 border-l-4 rounded-lg shadow-xl font-medium transition-opacity duration-300 ease-in-out opacity-0 ${cls.join(' ')}`;

messageText.textContent = msg;

messageBox.classList.remove('hidden');

setTimeout(() => messageBox.classList.add('opacity-100'), 10);

setTimeout(() => { messageBox.classList.remove('opacity-100'); setTimeout(() => messageBox.classList.add('hidden'), 300); }, duration);

}


const formatWeight = w => Number.isInteger(w) ? w : w.toFixed(1);

const calculateVolume = s => s.reduce((t, x) => t + (x.reps * x.weight), 0);

const updateDashboardStatus = () => currentGymStatus.textContent = `${state.gymName} | ${state.gymSetup.weights.length + state.gymSetup.cardio.length + state.gymSetup.floor.length} items available.`;

const formatDate = d => { const x = new Date(d); return x.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})+', '+x.toLocaleDateString('en-US',{month:'short',day:'numeric'}); };

const formatDateMetrics = d => d ? new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'N/A';

const getBase64 = file => new Promise((resolve, reject) => { if(file.size>204800){reject("File too large (>200KB)");return;} const r=new FileReader(); r.readAsDataURL(file); r.onload=()=>resolve(r.result); r.onerror=e=>reject(e); });



// --- HANDLERS ---


function handleGymSetupSave(e) {

e.preventDefault();

const form = e.target.id === 'gym-setup-form' ? document.getElementById('gym-setup-form') : document.getElementById('active-gym-setup-form');


state.gymName = document.getElementById('gym-name')?.value || state.gymName;



const weights = Array.from(form.querySelectorAll('[name="weights"]:checked')).map(c => c.value);

const cardio = Array.from(form.querySelectorAll('[name="cardio"]:checked')).map(c => c.value);

const floor = Array.from(form.querySelectorAll('[name="floor"]:checked')).map(c => c.value);


state.gymSetup = { weights, cardio, floor };

saveCoreState();

updateDashboardStatus();


if (form.id === 'gym-setup-form') {

showMessage("Gym setup saved successfully!", 'success');

} else {

populateTrackingExerciseDropdown();

equipmentModal.classList.add('hidden');

showMessage("Active equipment updated!", 'info');

}

}
<div class="container">

<!-- Tabs Navigation -->

<div class="tabs">

<button class="tab-btn active" onclick="switchTab(event, 'trackerTab')" data-tab="trackerTab">Tracker</button>

<button class="tab-btn" onclick="switchTab(event, 'createTab')" data-tab="createTab">Add Food</button>

<button class="tab-btn" onclick="switchTab(event, 'databaseTab')" data-tab="databaseTab">Food Database</button>

<button class="tab-btn" onclick="switchTab(event, 'goalsTab')" data-tab="goalsTab">Set Goals</button>

<button class="tab-btn" onclick="switchTab(event, 'historyTab')" data-tab="historyTab">History</button>

</div>

  <!-- Tracker Tab -->

<div id="trackerTab" class="tab-content active">

<h2>Log Food</h2>


<div style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">

<p style="font-weight: bold; margin-bottom: 5px;">Scan Barcode</p>

<div id="reader"></div>

<button onclick="startScanner()">Start Camera Scanner</button>

</div>

  <input type="text" id="searchInput" placeholder="Search food..." oninput="searchFood()">

<div id="searchResults"></div>



<select id="mealType">

<option value="Breakfast">Breakfast</option>

<option value="Lunch">Lunch</option>

<option value="Dinner">Dinner</option>

<option value="Snack">Snack</option>

</select>

  <input type="number" id="quantity" placeholder="Quantity">


<select id="servingType" onchange="toggleCustomWeight()">

<option value="default">Per 100g (Quantity * 100g)</option>

<option value="custom">Custom Weight (Specify grams)</option>

</select>

<input type="number" id="customWeight" placeholder="Enter weight in grams (g)">



<button onclick="addEntry()">Add Entry</button>

<button onclick="resetLog()">Reset Log</button>

<button onclick="saveDay()">Save Day</button>

  <h3>Daily Log</h3>

<div style="overflow-x: auto;">

<table>

<thead>

<tr>

<th>Food</th>

<th>Meal</th>

<th>Calories</th>

<th>Protein</th>

<th>Qty</th>

<th>Prot%</th>

<th>Remove</th>

</tr>

</thead>

<tbody id="logBody"></tbody>

</table>

</div>

<div class="total-section">

<strong>Total Calories:</strong> <span id="totalCalories">0</span> kcal<br>

<strong>Total Protein:</strong> <span id="totalProtein">0</span> g<br>

<strong>Goal Calories:</strong> <span id="goalCalories">0</span> kcal<br>

<strong>Goal Protein:</strong> <span id="goalProtein">0</span> g<br>

<hr style="margin: 0.5rem 0; border: 0; border-top: 1px solid #ccc;">

<strong>Remaining Calories:</strong> <span id="remainingCalories">0</span> kcal<br>

<strong>Remaining Protein:</strong> <span id="remainingProtein">0</span> g

</div>

</div>

  
<!-- Create Food Tab -->

<div id="createTab" class="tab-content">

<h2>Add New Food</h2>

<p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Values are per 100g</p>

<input type="text" id="newFoodName" placeholder="Food name">

<input type="number" id="newCalories" placeholder="Calories per 100g">

<input type="number" id="newProtein" placeholder="Protein per 100g">

<button onclick="addFoodAndReturn()">Add Food</button>

</div>

<!-- Food Database Tab -->

<div id="databaseTab" class="tab-content">

<h2>Food Database</h2>

<input type="text" id="dbSearch" placeholder="Search database..." oninput="searchDatabase()">

<div id="databaseResults"></div>


<div style="overflow-x: auto; margin-top: 1rem;">

<table>

<thead>

<tr>

<th>Name</th>

<th>Cals/100g</th>
<th>Prot/100g</th>

<th>Action</th>

</tr>

</thead>

<tbody id="foodDatabaseBody"></tbody>

</table>

</div>

  </div>



<!-- Goals Tab -->

<div id="goalsTab" class="tab-content">

<h2>Set Daily Goals</h2>

<label>Daily Calorie Goal:</label>

<input type="number" id="goalCaloriesInput" placeholder="e.g. 2000">

<label>Daily Protein Goal (g):</label>

<input type="number" id="goalProteinInput" placeholder="e.g. 150">

<button onclick="saveGoals()">Save Goals</button>

</div>

  <!-- History Tab -->

<div id="historyTab" class="tab-content">

<h2>History</h2>

<div class="history-tabs">

<button id="btnDaily" onclick="switchHistoryView('daily')" class="active">Daily</button>

<button id="btnWeekly" onclick="switchHistoryView('weekly')">Weekly</button>

<button id="btnMonthly" onclick="switchHistoryView('monthly')">Monthly</button>

</div>
<div id="dailyView" class="history-view active">

<p>Your saved daily summaries will appear here.</p>

</div>

<div id="weeklyView" class="history-view">

<p>Weekly trends and summaries.</p>

</div>

<div id="monthlyView" class="history-view">

<p>Monthly overview.</p>

</div>

</div>

</div>
  <footer>&copy; 2025 Nutrition Tracker</footer>



<script>

// Global Data

let foodDatabase = [

{ name: "Chicken Breast", calories: 165, protein: 31 },

{ name: "White Rice", calories: 130, protein: 2.7 },

{ name: "Egg", calories: 155, protein: 13 },

{ name: "Peanut Butter", calories: 588, protein: 25 }

];

let log = [];
  let goals = { calories: 0, protein: 0 };

let history = [];

let scanner;



// Tab switching

function switchTab(evt, tabName) {

document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));

document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));


const targetTab = document.getElementById(tabName);

if (targetTab) {

targetTab.classList.add("active");
if (evt && evt.currentTarget) {

evt.currentTarget.classList.add("active");

} else {

const btn = document.querySelector(`[data-tab="${tabName}"]`);

if (btn) btn.classList.add("active");

}

}

// Stop scanner if switching away from Tracker

if (tabName !== 'trackerTab' && scanner) {

scanner.stop().catch(err => console.warn("Scanner stop error", err));

}
  }



// Scanner logic

function startScanner() {

const readerDiv = document.getElementById("reader");

readerDiv.innerHTML = "";

scanner = new Html5Qrcode("reader");


Html5Qrcode.getCameras().then(devices => {

if (devices && devices.length > 0) {

// Prefer back camera

const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
scanner.start(

backCam.id,

{ fps: 10, qrbox: 250 },

(decodedText) => {

scanner.stop();

fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`)

.then(res => res.json())

.then(data => {

const prod = data.product;

if (!prod) return alert("Product not found in Open Food Facts database.");
  const name = prod.product_name || "Unknown Scanned Item";

const cal = prod.nutriments["energy-kcal_100g"] || prod.nutriments["energy-kcal_serving"];

const prot = prod.nutriments["proteins_100g"] || prod.nutriments["proteins_serving"];


if (!cal || !prot) {

alert(`Found "${name}" but nutritional data is incomplete.`);

}


// Populate create tab or database automatically

document.getElementById("newFoodName").value = name;

document.getElementById("newCalories").value = cal || 0;

document.getElementById("newProtein").value = prot || 0;
  alert(`Scanned: ${name}. Please review and add to database.`);

switchTab(null, "createTab");

})

.catch(err => alert("Error fetching product data."));

},

(errorMessage) => { /* scanning */ }

).catch(err => alert("Camera permission or access error."));

} else {

alert("No cameras found.");

}

});

}
  // Custom weight toggle

function toggleCustomWeight() {

const type = document.getElementById("servingType").value;

const customInput = document.getElementById("customWeight");

customInput.style.display = (type === "custom") ? "block" : "none";

}



// Save food to database

function addFoodAndReturn() {

const name = document.getElementById("newFoodName").value;

const calories = parseFloat(document.getElementById("newCalories").value);
  const protein = parseFloat(document.getElementById("newProtein").value);


if (!name || isNaN(calories) || isNaN(protein)) {

return alert("Please fill out all fields with valid numbers.");

}



foodDatabase.push({ name, calories, protein });

updateFoodDatabaseTable();


document.getElementById("newFoodName").value = "";

document.getElementById("newCalories").value = "";

document.getElementById("newProtein").value = "";
  alert("Food saved to database!");

switchTab(null, "trackerTab");

}



// Update database table

function updateFoodDatabaseTable() {

const tbody = document.getElementById("foodDatabaseBody");

tbody.innerHTML = "";

foodDatabase.forEach((f, i) => {

const row = tbody.insertRow();

row.insertCell(0).innerText = f.name;

  row.insertCell(1).innerText = f.calories;

row.insertCell(2).innerText = f.protein;

const delBtn = document.createElement("button");

delBtn.textContent = "Remove";

delBtn.style.padding = "2px 5px";

delBtn.style.fontSize = "0.8rem";

delBtn.style.backgroundColor = "#dc3545";

delBtn.onclick = () => {

foodDatabase.splice(i, 1);

updateFoodDatabaseTable();

};
  row.insertCell(3).appendChild(delBtn);

});

}



// Add entry to daily log

function addEntry() {

const foodName = document.getElementById("searchInput").value;

const qtyInput = parseFloat(document.getElementById("quantity").value);

const meal = document.getElementById("mealType").value;

const servingType = document.getElementById("servingType").value;

const customW = parseFloat(document.getElementById("customWeight").value);
  const food = foodDatabase.find(f => f.name.toLowerCase() === foodName.toLowerCase());



if (!food) return alert("Select a valid food from the database search.");

if (isNaN(qtyInput)) return alert("Please enter a valid quantity.");



let multiplier;

if (servingType === "custom") {

if (isNaN(customW)) return alert("Enter custom weight in grams.");

multiplier = (customW * qtyInput) / 100;

} else {

multiplier = qtyInput;
  }



const calculatedCals = food.calories * multiplier;

const calculatedProt = food.protein * multiplier;



const entry = {

name: food.name,

calories: calculatedCals,

protein: calculatedProt,

qty: qtyInput + (servingType === "custom" ? ` (${customW}g)` : " (100g units)"),

meal: meal,

proteinPct: calculatedCals > 0 ? ((calculatedProt * 4) / calculatedCals * 100).toFixed(1) : 0

};



log.push(entry);

updateLogTable();


document.getElementById("searchInput").value = "";

document.getElementById("quantity").value = "";

document.getElementById("customWeight").value = "";
}



// Reset log

function resetLog() {

if (confirm("Clear all current entries for today?")) {

log = [];

updateLogTable();

}

}
  // Update log UI

function updateLogTable() {

const tbody = document.getElementById("logBody");

tbody.innerHTML = "";

let totalCals = 0, totalProt = 0;



log.forEach((e, i) => {

totalCals += e.calories;

totalProt += e.protein;

const row = tbody.insertRow();

row.insertCell(0).innerText = e.name;
  row.insertCell(1).innerText = e.meal;

row.insertCell(2).innerText = e.calories.toFixed(1);

row.insertCell(3).innerText = e.protein.toFixed(1);

row.insertCell(4).innerText = e.qty;

row.insertCell(5).innerText = `${e.proteinPct}%`;


const removeCell = row.insertCell(6);

const btn = document.createElement("button");

btn.textContent = "X";

btn.style.width = "auto";

btn.style.padding = "2px 8px";

btn.style.backgroundColor = "#dc3545";
  btn.onclick = () => { log.splice(i, 1); updateLogTable(); };

removeCell.appendChild(btn);

});



document.getElementById("totalCalories").innerText = totalCals.toFixed(1);

document.getElementById("totalProtein").innerText = totalProt.toFixed(1);

document.getElementById("goalCalories").innerText = goals.calories;

document.getElementById("goalProtein").innerText = goals.protein;

document.getElementById("remainingCalories").innerText = (goals.calories - totalCals).toFixed(1);

document.getElementById("remainingProtein").innerText = (goals.protein - totalProt).toFixed(1);

}
  // Save goals

function saveGoals() {

goals.calories = parseFloat(document.getElementById("goalCaloriesInput").value) || 0;

goals.protein = parseFloat(document.getElementById("goalProteinInput").value) || 0;

alert("Daily goals updated!");

updateLogTable();

}
  // Search logic for logging

function searchFood() {

const query = document.getElementById("searchInput").value.toLowerCase();

const container = document.getElementById("searchResults");

container.innerHTML = "";


if (query.length < 1) return;



const results = foodDatabase.filter(f => f.name.toLowerCase().includes(query));


results.forEach(food => {
  const div = document.createElement("div");

div.textContent = `${food.name} (${food.calories} cal, ${food.protein}g protein per 100g)`;

div.onclick = () => {

document.getElementById("searchInput").value = food.name;

container.innerHTML = "";

};

container.appendChild(div);

});



if (!results.length && query.length > 2) {

const div = document.createElement("div");
  div.innerHTML = `<em>"${query}"</em> not found. <strong>Click to create.</strong>`;

div.onclick = () => {

document.getElementById("newFoodName").value = query;

switchTab(null, "createTab");

};

container.appendChild(div);

}

}
  // Database Search

function searchDatabase() {

const query = document.getElementById("dbSearch").value.toLowerCase();

const rows = document.querySelectorAll("#foodDatabaseBody tr");

rows.forEach(row => {

const name = row.cells[0].innerText.toLowerCase();

row.style.display = name.includes(query) ? "" : "none";

});

}

  // History functionality

function saveDay() {

if (log.length === 0) return alert("Log is empty.");

const date = new Date().toLocaleDateString();

const totalCals = log.reduce((sum, e) => sum + e.calories, 0);

const totalProt = log.reduce((sum, e) => sum + e.protein, 0);


const daySummary = {

date,

calories: totalCals.toFixed(1),

protein: totalProt.toFixed(1),
  entries: [...log]

};


history.push(daySummary);

alert(`Day saved for ${date}!`);

renderHistory();

}



function switchHistoryView(view) {

document.querySelectorAll(".history-view").forEach(v => v.classList.remove("active"));

document.querySelectorAll(".history-tabs button").forEach(b => b.classList.remove("active"));

  document.getElementById(view + "View").classList.add("active");

document.getElementById("btn" + view.charAt(0).toUpperCase() + view.slice(1)).classList.add("active");

}



function renderHistory() {

const dailyView = document.getElementById("dailyView");

if (history.length === 0) {

dailyView.innerHTML = "<p>No history records yet.</p>";

return;

}
  let html = "<table><thead><tr><th>Date</th><th>Calories</th><th>Protein</th></tr></thead><tbody>";

history.forEach(day => {

html += `<tr><td>${day.date}</td><td>${day.calories}</td><td>${day.protein}</td></tr>`;

});

html += "</tbody></table>";

dailyView.innerHTML = html;

}



window.onload = () => {

updateFoodDatabaseTable();

updateLogTable();

  };
  
function handleMealLogSave(e) {

e.preventDefault();

const name = e.target.querySelector('[name="meal-name"]').value;

const details = e.target.querySelector('[name="meal-details"]').value;

state.mealLog.push({ id: Date.now(), name, details, date: new Date().toISOString() });

saveMealLog();

renderMealLogSummary();

e.target.reset();

showMessage(`Logged meal: ${name}`, 'success');

}



function handleStartWorkout(e) {

e.preventDefault();


const focus = workoutFocusSelect.value;

const muscles = Array.from(document.querySelectorAll('#muscle-options input:checked')).map(c => c.value);



if (!focus) {

showMessage("Please select a workout focus.", 'error');

return;

}



let workoutTitle = focus === 'specific-muscles' ? `Muscle Focus: ${muscles.join(', ')}` : FOCUS_OPTIONS.find(f => f.toLowerCase().replace(/\s/g, '-') === focus);



state.currentWorkout = {

title: workoutTitle || 'Custom Workout',

date: new Date().toISOString(),

exercises: [],

focus: focus,

muscles: muscles,

currentExercise: null

};


showMessage(`Starting new workout: ${state.currentWorkout.title}`, 'success');

showView('track-workout');

}



function handleSetRepWeightChange(e) {

const setRow = e.target.closest('.set-row');

const index = parseInt(setRow.dataset.setIndex);

const field = e.target.dataset.field;

const delta = parseFloat(e.target.dataset.delta);


let currentValue = parseFloat(setRow.querySelector(`input[data-field="${field}"]`).value);

if (isNaN(currentValue)) currentValue = 0;


const newValue = Math.max(0, currentValue + delta);

setRow.querySelector(`input[data-field="${field}"]`).value = field === 'weight' ? newValue.toFixed(1) : Math.round(newValue);

handleSetInputUpdate({ target: setRow.querySelector(`input[data-field="${field}"]`) });

}



function handleSetInputUpdate(e) {

const input = e.target;

const field = input.dataset.field;

let value = parseFloat(input.value);



if (isNaN(value)) {

value = 0;

input.value = field === 'weight' ? '0.0' : '0';

}


const index = parseInt(input.closest('.set-row').dataset.setIndex);



if (state.currentWorkout?.currentExercise?.setsData[index]) {

state.currentWorkout.currentExercise.setsData[index][field] = value;

}

}


function saveExercise() {

if (!state.currentWorkout || !state.currentWorkout.currentExercise) return;


const exercise = state.currentWorkout.currentExercise;

if (exercise.setsData.every(s => s.reps === 0 || s.weight === 0.0)) {

showMessage("Please enter reps/weight for at least one set.", 'error');

return;

}



state.currentWorkout.exercises.push(exercise);


const maxWeight = exercise.setsData.reduce((max, s) => Math.max(max, s.weight), 0);

const maxSet = exercise.setsData.find(s => s.weight === maxWeight) || { reps: 0 };


const historyItem = state.exerciseHistory[exercise.name] || { bestWeight: 0, bestReps: 0 };

if (maxWeight > historyItem.bestWeight) {

historyItem.bestWeight = maxWeight;

historyItem.bestReps = maxSet.reps;

historyItem.lastDate = formatDate(state.currentWorkout.date);

showMessage(`New Personal Best for ${exercise.name}: ${maxWeight}kg!`, 'success', 5000);

} else if (!state.exerciseHistory[exercise.name]) {

historyItem.bestWeight = maxWeight;

historyItem.bestReps = maxSet.reps;

historyItem.lastDate = formatDate(state.currentWorkout.date);

} else {

showMessage(`Logged ${exercise.name}.`, 'info');

}

state.exerciseHistory[exercise.name] = historyItem;

saveCoreState();



state.currentWorkout.currentExercise = null;

setsTrackingContainer.innerHTML = '';

updateLoggedExercisesSummary();

document.getElementById('add-exercise-form').reset();

populateTrackingExerciseDropdown();

}



window.saveWorkout = function(finalize = false) {

if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {

state.currentWorkout = null;

showMessage("No exercises logged. Workout discarded.", 'info');

return;

}



if (finalize) {

state.currentWorkout.status = 'completed';

state.workoutLog.push(state.currentWorkout);

saveWorkoutLog();

showMessage(`Workout '${state.currentWorkout.title}' saved! Total exercises: ${state.currentWorkout.exercises.length}`, 'success', 5000);

state.currentWorkout = null;

}

}



// --- RENDER LOGIC (Sets/Reps) ---

function renderSetsTracking() {

const exerciseName = exerciseSelect.value;

const setsCount = parseInt(setsInput.value);

const targetReps = parseInt(targetRepsInput.value);



if (!exerciseName || isNaN(setsCount) || setsCount <= 0 || isNaN(targetReps) || targetReps <= 0) {

showMessage("Please select an exercise and enter valid sets/reps.", 'error');

return;

}


state.currentWorkout.currentExercise = {

name: exerciseName,

setsData: Array(setsCount).fill(null).map(() => ({ reps: targetReps, weight: 0.0 })),

targetReps: targetReps,

targetSets: setsCount

};



const setRowsHtml = state.currentWorkout.currentExercise.setsData.map((set, index) => {

return `

<div class="set-row flex flex-col md:grid md:grid-cols-12 gap-3 items-start md:items-center p-4 bg-white rounded-lg border shadow-sm" data-set-index="${index}">

<div class="md:col-span-1 text-lg font-bold text-gray-700 w-full border-b md:border-b-0 pb-1 md:pb-0 mb-1 md:mb-0">Set ${index + 1}</div>


<div class="md:col-span-5 flex items-center justify-between w-full md:w-auto space-x-2">

<button type="button" data-field="reps" data-delta="-1" onclick="handleSetRepWeightChange(event)" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-full hover:bg-gray-300 transition text-lg font-bold">-</button>

<div class="flex-grow flex items-center justify-center space-x-2 bg-gray-50 px-2 rounded">

<input type="number" data-field="reps" value="${set.reps}" min="0" onchange="handleSetInputUpdate(event)" class="set-input-field text-center w-16 p-2 bg-transparent font-semibold focus:outline-none" />

<span class="text-sm text-gray-500 uppercase tracking-wide font-bold">Reps</span>

</div>

<button type="button" data-field="reps" data-delta="1" onclick="handleSetRepWeightChange(event)" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-full hover:bg-gray-300 transition text-lg font-bold">+</button>

</div>



<div class="md:col-span-6 flex items-center justify-between w-full md:w-auto space-x-2">

<button type="button" data-field="weight" data-delta="-2.5" onclick="handleSetRepWeightChange(event)" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-full hover:bg-gray-300 transition text-lg font-bold">-</button>

<div class="flex-grow flex items-center justify-center space-x-2 bg-gray-50 px-2 rounded">

<input type="number" step="0.1" data-field="weight" value="${set.weight.toFixed(1)}" min="0" onchange="handleSetInputUpdate(event)" class="set-input-field text-center w-20 p-2 bg-transparent font-semibold focus:outline-none" />

<span class="text-sm text-gray-500 uppercase tracking-wide font-bold">kg</span>

</div>

<button type="button" data-field="weight" data-delta="2.5" onclick="handleSetRepWeightChange(event)" class="bg-gray-200 text-gray-700 w-10 h-10 rounded-full hover:bg-gray-300 transition text-lg font-bold">+</button>

</div>

</div>

`;

}).join('');



setsTrackingContainer.innerHTML = `

<div class="p-4 bg-green-100 rounded-xl border border-green-300 shadow-lg">

<h3 class="text-lg md:text-xl font-bold text-green-800 mb-4 truncate">Tracking Sets: ${exerciseName}</h3>

<div class="space-y-3">

${setRowsHtml}

</div>

<div class="mt-4 pt-4 border-t border-green-300">

<button type="button" onclick="saveExercise()" class="w-full py-4 bg-indigo-500 text-white font-bold rounded-xl hover:bg-indigo-600 transition duration-150 shadow-md text-lg">

<i class="fas fa-check-circle mr-2"></i> Log Sets

</button>

</div>

</div>

`;

showMessage(`Ready to track ${setsCount} sets!`, 'info');

}



function populateTrackingExerciseDropdown() {

if (!state.currentWorkout) {

exerciseSelect.innerHTML = `<option value="" disabled selected>-- Start a workout first --</option>`;

return;

}


const sFocus = state.currentWorkout.focus;

const sMuscles = state.currentWorkout.muscles;



const avail = [...(state.gymSetup.weights||[]), ...(state.gymSetup.cardio||[]), ...(state.gymSetup.floor||[])];


const filtered = EXERCISE_LIBRARY.filter(e => {

if (!e.equipment.some(i => avail.includes(i))) return false;

const normFocus = e.focus.map(f => f.toLowerCase().replace(/\s/g, '-'));

if (sFocus === 'specific-muscles') {

return sMuscles.length > 0 && sMuscles.some(m => normFocus.includes(m));

}

return normFocus.includes(sFocus);

});



exerciseSelect.innerHTML = `<option value="" disabled selected>-- Select an Exercise --</option>` + filtered.map(e => `<option value="${e.name}">${e.name}</option>`).join('');

}



function renderMealLogSummary() {

const today = new Date().toISOString().split('T')[0];

const todaysMeals = state.mealLog.filter(m => m.date.startsWith(today));


if (todaysMeals.length === 0) {

loggedMealsSummary.innerHTML = `<h3 class="text-xl font-bold text-gray-700">Today's Meals</h3><p class="text-gray-500 italic" id="meal-list-placeholder">No meals logged today.</p>`;

return;

}



const mealHtml = todaysMeals.map(m =>

`<div class="p-3 bg-white rounded-lg border flex justify-between items-center shadow-sm">

<div class="flex-grow pr-2">

<p class="font-semibold text-gray-800 break-words">${m.name}</p>

<p class="text-xs text-gray-500 italic break-words">${m.details.substring(0, 50)}${m.details.length > 50 ? '...' : ''}</p>

</div>

<span class="text-xs text-yellow-600 whitespace-nowrap">${new Date(m.date).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</span>

</div>`

).join('');



loggedMealsSummary.innerHTML = `<h3 class="text-xl font-bold text-gray-700 mb-2">Today's Meals (${todaysMeals.length})</h3><div class="space-y-2">${mealHtml}</div>`;

}



function updateLoggedExercisesSummary() {

loggedExercisesSummary.innerHTML = '';

if (!state.currentWorkout || state.currentWorkout.exercises.length === 0) {

loggedExercisesSummary.innerHTML = `<p class="text-gray-500 italic">No exercises logged in this session yet.</p>`;

return;

}



const summaryHtml = state.currentWorkout.exercises.map(ex => {

const totalVolume = calculateVolume(ex.setsData);

const totalSets = ex.setsData.length;

const setsDetail = ex.setsData.map(s => `${s.reps}r x ${formatWeight(s.weight)}kg`).join(', ');


return `<div class="p-4 bg-green-100 rounded-xl border border-green-300 shadow-md">

<h4 class="text-lg font-bold text-green-800 break-words">${ex.name} (${totalSets} sets)</h4>

<p class="text-sm text-gray-700 mt-1"><span class="font-semibold">Volume:</span> ${formatWeight(totalVolume)} kg</p>

<p class="text-xs text-gray-500 mt-1">${setsDetail}</p>

</div>`;

}).join('');

loggedExercisesSummary.innerHTML = `<h3 class="text-xl font-bold text-green-800 border-t pt-4"><i class="fas fa-list-alt mr-2"></i> Logged Exercises</h3><div class="space-y-3 mt-3">${summaryHtml}</div>`;

}


function renderGymSetupCheckboxes(w, c, f) {

const weights = state.gymSetup.weights || [];

const cardio = state.gymSetup.cardio || [];

const floor = state.gymSetup.floor || [];


w.innerHTML = EQUIPMENT_MAP['weights'].map(i => `<div class="flex items-center"><input id="weights-${i}" name="weights" type="checkbox" value="${i}" ${weights.includes(i)?'checked':''} class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="weights-${i}" class="ml-3 text-gray-700 capitalize text-sm">${i}</label></div>`).join('');

c.innerHTML = EQUIPMENT_MAP['cardio'].map(i => `<div class="flex items-center"><input id="cardio-${i}" name="cardio" type="checkbox" value="${i}" ${cardio.includes(i)?'checked':''} class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="cardio-${i}" class="ml-3 text-gray-700 capitalize text-sm">${i}</label></div>`).join('');

f.innerHTML = EQUIPMENT_MAP['floor'].map(i => `<div class="flex items-center"><input id="floor-${i}" name="floor" type="checkbox" value="${i}" ${floor.includes(i)?'checked':''} class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="floor-${i}" class="ml-3 text-gray-700 capitalize text-sm">${i}</label></div>`).join('');

}



function renderActiveEquipmentModal() {

const w = document.getElementById('active-weights-options');

const c = document.getElementById('active-cardio-options');

const f = document.getElementById('active-floor-options');

renderGymSetupCheckboxes(w, c, f);

}


function renderMuscleCheckboxes() { muscleOptionsDiv.innerHTML = MUSCLE_GROUPS.map(m => `<div class="flex items-center"><input id="muscle-${m}" type="checkbox" name="muscle" value="${m}" class="h-5 w-5 text-green-600 rounded focus:ring-green-500"><label for="muscle-${m}" class="ml-3 text-gray-700 text-sm capitalize">${m}</label></div>`).join(''); }

function renderWorkoutFocus() { workoutFocusSelect.innerHTML = `<option value="" disabled selected>-- Choose Focus --</option>` + FOCUS_OPTIONS.map(f => `<option value="${f.toLowerCase().replace(/\s/g, '-')}">${f}</option>`).join(''); }



function handleFocusChange() {

const focus = workoutFocusSelect.value;

if (focus === 'specific-muscles') {

muscleCheckboxesDiv.classList.remove('hidden');

} else {

muscleCheckboxesDiv.classList.add('hidden');

}

}





// --- BODY METRICS ---

window.openSnapshotModal = function() {

snapshotForm.reset();

circumferenceGroupsContainer.innerHTML = '';

photoPreviewContainer.classList.add('hidden');

photoPreview.src = '';

addMeasurementGroup();

document.getElementById('weight-input').value = '';

document.getElementById('weight-unit-select').value = 'kg';

snapshotModalEl.classList.remove('pointer-events-none', 'opacity-0');

snapshotModalContentEl.classList.remove('fade-out');

snapshotModalContentEl.classList.add('fade-in');

}

window.closeSnapshotModal = function() { snapshotModalContentEl.classList.remove('fade-in'); snapshotModalContentEl.classList.add('fade-out'); setTimeout(() => { snapshotModalEl.classList.add('pointer-events-none', 'opacity-0'); }, 300); }

window.addMeasurementGroup = function() {

const uid = `meas-${Date.now()}`;

circumferenceGroupsContainer.insertAdjacentHTML('beforeend', `<div id="${uid}" class="grid grid-cols-4 gap-3 items-end p-3 bg-white rounded-lg border border-gray-200 shadow-sm"><div class="col-span-4"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Area</label><select name="area" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-purple-500 h-10">${CIRCUMFERENCE_AREAS.map(a=>`<option value="${a}">${a}</option>`).join('')}</select></div><div class="col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Value</label><input name="value" type="number" step="0.1" placeholder="0.0" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-purple-500 h-10" /></div><div class="col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Unit</label><select name="unit" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-purple-500 h-10"><option value="inches">in</option><option value="cm">cm</option></select></div><div class="col-span-1 flex justify-center items-end pb-1"><button type="button" onclick="removeMeasurementGroup('${uid}')" class="p-2 text-red-500 hover:text-red-700 transition bg-red-50 rounded-lg"><i class="fas fa-trash-alt"></i></button></div></div>`);

}

window.removeMeasurementGroup = function(id) { document.getElementById(id).remove(); }


function handlePhotoFileChange() {

const file = photoFileInput.files[0];

if (file) {

if (file.size > 204800) { showMessage("Photo too large (>200KB).", 'metrics-error'); photoFileInput.value = ''; photoPreviewContainer.classList.add('hidden'); return; }

const r = new FileReader(); r.onload = e => { photoPreview.src = e.target.result; photoPreviewContainer.classList.remove('hidden'); }; r.readAsDataURL(file);

} else { photoPreviewContainer.classList.add('hidden'); photoPreview.src = ''; }

}

function loadAndRenderMetrics() { renderMeasurements(loadMetrics()); }

async function handleSaveSnapshot(e) {

e.preventDefault();

const weight = parseFloat(document.getElementById('weight-input').value);

const weightUnit = document.getElementById('weight-unit-select').value;

const file = photoFileInput.files[0];

if (isNaN(weight) || weight <= 0) { showMessage("Enter valid weight.", 'metrics-error'); return; }


const saveBtn = document.getElementById('save-snapshot-btn');

saveBtn.disabled = true; saveBtn.innerHTML = 'Saving...';


let photoBase64 = null;

if (file) { try { photoBase64 = await getBase64(file); } catch(err) { showMessage(`Photo error: ${err}`, 'metrics-error'); saveBtn.disabled = false; return; } }



const measurements = [];

circumferenceGroupsContainer.querySelectorAll('.grid.gap-3').forEach(g => {

const area = g.querySelector('[name="area"]').value;

const val = parseFloat(g.querySelector('[name="value"]').value);

const unit = g.querySelector('[name="unit"]').value;

if(!isNaN(val) && val > 0) measurements.push({ area, value: val, unit });

});



try {

const snaps = loadMetrics();

snaps.push({ id: Date.now().toString(), timestamp: new Date().toISOString(), weight, weightUnit, photoBase64, measurements });

snaps.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

saveMetrics(snaps); loadAndRenderMetrics(); closeSnapshotModal(); showMessage(`Snapshot recorded!`, 'success');

} catch(e) { showMessage("Failed to save.", 'metrics-error'); }

finally { saveBtn.disabled = false; saveBtn.innerHTML = 'Add Daily Measurement Snapshot'; }

}

function renderMeasurements(snaps) {

measurementsContainer.innerHTML = '';

if (snaps.length === 0) { measurementsContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-md border-dashed border-purple-200 col-span-full"><p class="text-gray-600">No snapshots yet.</p></div>`; return; }

snaps.forEach((s, i) => {

const prev = snaps[i+1];

let diffHtml = '';

if (prev && prev.weight && prev.weightUnit === s.weightUnit) {

const diff = s.weight - prev.weight;

const color = diff < 0 ? 'text-green-600' : (diff > 0 ? 'text-red-600' : 'text-gray-500');

diffHtml = `<p class="text-sm font-medium flex items-center ${color} mt-1">${diff >= 0 ? '+' : ''}${Math.abs(diff).toFixed(1)} ${s.weightUnit}</p>`;

}

const circHtml = s.measurements.length > 0 ? `<div class="mt-4 pt-3 border-t border-gray-100"><div class="grid grid-cols-2 gap-2 text-xs max-h-24 overflow-y-auto custom-scroll">${s.measurements.map(m=>`<p class="truncate"><span class="font-medium text-purple-600">${m.area}:</span> ${m.value.toFixed(1)} ${m.unit}</p>`).join('')}</div></div>` : '';

const photoHtml = s.photoBase64 ? `<div class="mb-4"><img src="${s.photoBase64}" class="w-full h-48 object-contain rounded-lg shadow-md border border-gray-300" /></div>` : '';

const card = `<div class="bg-white p-4 md:p-6 rounded-2xl shadow-xl border-t-4 border-purple-500 hover:shadow-2xl transition duration-200 break-words"><div class="flex justify-between items-start mb-4"><h3 class="text-lg font-bold text-gray-800">Snapshot</h3><span class="text-xs md:text-sm text-purple-500 font-medium">${formatDateMetrics(s.timestamp)}</span></div>${photoHtml}<div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-300 shadow-inner"><p class="text-xl font-bold text-purple-700 mb-1 flex items-center"><i class="fas fa-weight-hanging mr-2"></i> Weight</p><p class="text-3xl md:text-4xl font-extrabold text-gray-900 leading-none">${s.weight.toFixed(1)} <span class="text-base font-medium text-purple-500">${s.weightUnit}</span></p>${diffHtml}</div>${circHtml}</div>`;

measurementsContainer.insertAdjacentHTML('beforeend', card);

});

}



// --- CHARTS ---

window.renderExerciseChart = function(exerciseName) {

const chartData = [];

state.workoutLog.forEach(workout => {

if (workout.exercises) {

const ex = workout.exercises.find(e => e.name === exerciseName);

if (ex) {

const maxWeight = ex.setsData.reduce((max, s) => Math.max(max, s.weight), 0);

if (maxWeight > 0) chartData.push({ date: new Date(workout.date), weight: maxWeight });

}

}

});

chartData.sort((a, b) => a.date - b.date);



if (chartData.length < 2) { showMessage("Not enough data to chart (need 2+ sessions).", "info"); return; }



chartContainer.classList.remove('hidden');

chartTitle.textContent = `${exerciseName} Progress (Max Weight)`;

const ctx = document.getElementById('exerciseChart').getContext('2d');

if (historyChartInstance) historyChartInstance.destroy();



historyChartInstance = new Chart(ctx, {

type: 'line',

data: {

labels: chartData.map(d => d.date.toLocaleDateString()),

datasets: [{

label: 'Max Weight (kg)',

data: chartData.map(d => d.weight),

borderColor: 'rgb(79, 70, 229)',

backgroundColor: 'rgba(79, 70, 229, 0.1)',

tension: 0.3, fill: true, pointBackgroundColor: '#fff', pointBorderColor: 'rgb(79, 70, 229)', pointRadius: 5

}]

},

options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, title: { display: true, text: 'Weight (kg)' } } } }

});

}

window.closeChart = function() { chartContainer.classList.add('hidden'); if(historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } }



function renderHistory() {

historyContent.innerHTML = '';

const keys = Object.keys(state.exerciseHistory).sort((a, b) => state.exerciseHistory[b].bestWeight - state.exerciseHistory[a].bestWeight);

if (keys.length === 0) { historyContent.innerHTML = '<p class="text-gray-500 italic text-center">No history yet.</p>'; return; }


const items = keys.map(name => {

const item = state.exerciseHistory[name];

return `

<div class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">

<div>

<h4 class="text-lg md:text-xl font-bold text-gray-800 break-words">${name}</h4>

<p class="text-gray-600 mt-1"><span class="font-semibold">Best:</span> ${formatWeight(item.bestWeight)}kg (${item.bestReps} reps)</p>

<p class="text-xs text-gray-400">Last: ${item.lastDate}</p>

</div>

<button onclick="renderExerciseChart('${name}')" class="w-full sm:w-auto bg-white border border-indigo-300 text-indigo-600 px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-50 transition text-sm font-semibold">

<i class="fas fa-chart-line mr-1"></i> Chart

</button>

</div>

`;

}).join('');

historyContent.innerHTML = `<div class="space-y-4">${items}</div>`;

}



// --- INIT ---

function initApp() {

loadCoreState(); loadMealLog(); loadWorkoutLog();

document.getElementById('user-name').textContent = state.userName;

document.getElementById('user-goal').textContent = state.goal;

updateDashboardStatus();



gymSetupForm.addEventListener('submit', handleGymSetupSave);

activeGymSetupForm.addEventListener('submit', handleGymSetupSave);

workoutFocusSelect.addEventListener('change', handleFocusChange);

workoutPlanningForm.addEventListener('submit', handleStartWorkout);

document.getElementById('add-meal-form').addEventListener('submit', handleMealLogSave);

snapshotForm.addEventListener('submit', handleSaveSnapshot);

photoFileInput.addEventListener('change', handlePhotoFileChange);


document.getElementById('start-sets-btn').addEventListener('click', renderSetsTracking);


document.getElementById('finish-workout-btn').addEventListener('click', () => { saveWorkout(true); showView('dashboard'); });


document.getElementById('view-history-btn').addEventListener('click', () => { renderHistory(); historyModal.classList.remove('hidden'); });

document.getElementById('close-history-btn').addEventListener('click', () => { historyModal.classList.add('hidden'); closeChart(); });

document.getElementById('open-equipment-modal-btn').addEventListener('click', () => { renderActiveEquipmentModal(); equipmentModal.classList.remove('hidden'); });

document.getElementById('close-equipment-modal-btn').addEventListener('click', () => equipmentModal.classList.add('hidden'));



document.querySelectorAll('.set-input-field').forEach(i => i.addEventListener('change', handleSetInputUpdate));


showView('dashboard', false);

}


window.onload = initApp;

</script>

</body>

</html>
