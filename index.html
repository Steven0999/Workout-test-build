<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTrack Pro - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #f43f5e;
            --bg-main: #f8fafc;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .photo-slot {
            aspect-ratio: 3/4; background: #f1f5f9; border-radius: 1.5rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; border: 2px dashed #e2e8f0; position: relative;
            transition: all 0.2s;
        }
        .photo-slot:hover { border-color: var(--brand-primary); transform: scale(1.02); }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px;
        }

        .muscle-chip.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .store-dropdown { animation: dropdownPop 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropdownPop {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px;
            font-size: 14px; font-weight: 600; z-index: 1000; opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        button { 
            transition: all 0.2s ease;
            min-height: 44px; /* Better touch target */
        }
        button:active { 
            transform: scale(0.97); 
        }
        button:focus-visible { 
            outline: 2px solid var(--brand-primary); 
            outline-offset: 2px; 
        }

        /* Better touch targets for inputs */
        input, select {
            min-height: 48px;
            font-size: 16px; /* Prevent zoom on iOS */
        }

        /* Larger tap areas for navigation */
        /* Smoother photo slot interactions */
        .photo-slot {
            min-height: 200px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .photo-slot:active {
            transform: scale(0.98);
        }

        /* Better modal transitions */
        .modal-overlay {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ============================================ */
        /* MOBILE RESPONSIVE IMPROVEMENTS */
        /* ============================================ */
        
        /* Ensure proper spacing on all screens */
        * {
            box-sizing: border-box;
        }

        main {
            width: 100%;
            max-width: 42rem;
        }

        /* Better mobile padding and spacing */
        @media (max-width: 640px) {
            main {
                padding: 0.75rem !important;
            }
            
            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }

            .glass-card {
                padding: 1rem !important;
            }

            .rounded-\[2\.5rem\], .rounded-\[3rem\], .rounded-\[32px\], .rounded-\[40px\] {
                border-radius: 1.5rem !important;
            }
        }

        /* Responsive grid spacing */
        .grid {
            display: grid;
            width: 100%;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.75rem;
        }

        @media (max-width: 640px) {
            .grid-cols-2, .grid-cols-3 {
                gap: 0.5rem;
            }
        }

        /* Exercise cards - full width and proper spacing */
        #exercise-list > div {
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Set rows - responsive and equal spacing */
        .flex.gap-2 {
            display: flex;
            gap: 0.5rem;
            width: 100%;
        }

        @media (max-width: 640px) {
            .flex.gap-2 {
                gap: 0.375rem;
            }
        }

        /* Ensure flex items take equal space */
        .flex-1 {
            flex: 1 1 0%;
            min-width: 0;
        }

        /* Input fields responsive */
        input[type="number"],
        input[type="text"] {
            width: 100%;
            touch-action: manipulation;
        }

        /* Better touch targets on touch devices */
        @media (hover: none) {
            button {
                min-height: 48px !important;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }

            input, select {
                min-height: 52px !important;
                font-size: 16px !important;
            }
        }

        /* Responsive typography */
        @media (max-width: 640px) {
            h1 { font-size: 1.125rem; }
            h2 { font-size: 1rem; }
            h3 { font-size: 0.9375rem; }
            h4 { font-size: 0.875rem; }
            
            .text-5xl { font-size: 2.25rem !important; line-height: 1.2; }
            .text-4xl { font-size: 1.875rem !important; line-height: 1.2; }
            .text-3xl { font-size: 1.5rem !important; line-height: 1.3; }
            .text-2xl { font-size: 1.25rem !important; }
            .text-xl { font-size: 1.125rem !important; }
            .text-lg { font-size: 1rem !important; }
        }

        /* Modal responsive */
        .modal-overlay {
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-overlay > div {
            width: 100%;
            max-width: 32rem;
            margin: auto;
        }

        @media (max-width: 640px) {
            .modal-overlay {
                padding: 0.75rem;
                align-items: flex-start;
            }

            .modal-overlay > div {
                max-width: 100%;
                border-radius: 1.5rem !important;
                padding: 1.25rem !important;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
        }

        /* Toast responsive */
        .toast {
            max-width: 90%;
            text-align: center;
            word-wrap: break-word;
        }

        @media (max-width: 640px) {
            .toast {
                bottom: 20px;
                font-size: 0.8125rem;
                padding: 0.625rem 1rem;
            }
        }

        /* Sets container responsive */
        #exercise-list .bg-slate-50 {
            padding: 0.75rem;
        }

        @media (max-width: 640px) {
            #exercise-list .bg-slate-50 {
                padding: 0.5rem;
            }
        }

        /* Header responsive */
        header {
            padding: 1rem 1.25rem;
        }

        @media (max-width: 640px) {
            header {
                padding: 0.875rem 1rem;
            }
        }

        /* Photo slots responsive */
        .photo-slot {
            min-height: 120px;
        }

        @media (min-width: 640px) {
            .photo-slot {
                min-height: 180px;
            }
        }

        /* Better spacing for workout timer and controls */
        @media (max-width: 640px) {
            #workout-active .flex.justify-between {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            #workout-active .flex.justify-between > button {
                align-self: flex-end;
            }
        }

        /* Ensure all cards are full width */
        .glass-card,
        .bg-white {
            width: 100%;
        }

        /* Better spacing in nutrition search */
        @media (max-width: 640px) {
            .flex.gap-2.mb-4 {
                gap: 0.5rem;
            }
        }

        /* Sidebar animations */
        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .translate-x-0 {
            transform: translateX(0);
        }
        
        .-translate-x-full {
            transform: translateX(-100%);
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-4 sm:px-6 py-4 sm:py-5 sticky top-0 z-40 flex justify-between items-center">
        <button onclick="toggleSidebar()" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Menu">
            <i data-lucide="menu" class="w-6 h-6 text-slate-700"></i>
        </button>
        <div class="text-center">
            <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">FitTrack<span class="text-slate-600">Pro</span></h1>
            <div class="flex items-center gap-2 justify-center">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <p id="status-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Loading...</p>
            </div>
        </div>
        <button onclick="switchTab('settings')" class="w-12 h-12 flex items-center justify-center bg-slate-100 rounded-2xl hover:bg-slate-200 transition-colors" aria-label="Settings">
            <i data-lucide="settings" class="w-6 h-6 text-slate-700"></i>
        </button>
    </header>

    <main class="max-w-xl mx-auto p-4 sm:p-6 space-y-6">
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="tab-content active space-y-6">
            <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center relative overflow-hidden">
                <div class="relative w-48 h-48 flex items-center justify-center">
                    <svg class="w-full h-full" viewBox="0 0 192 192">
                        <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                        <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96" />
                    </svg>
                    <div class="absolute text-center">
                        <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Eaten</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                    <div class="text-center"><div id="dash-protein" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Protein</div></div>
                    <div class="text-center border-x"><div id="dash-carbs" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Carbs</div></div>
                    <div class="text-center"><div id="dash-fat" class="font-bold">0g</div><div class="text-[9px] uppercase text-slate-400">Fats</div></div>
                </div>
            </div>

            <div class="glass-card rounded-[2.5rem] p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-cyan-50 rounded-2xl flex items-center justify-center"><i data-lucide="droplet" class="text-cyan-500"></i></div>
                    <div><h4 class="font-bold">Hydration</h4><p id="water-count" class="text-xs text-slate-500">0 / 2.5L</p></div>
                </div>
                <div class="flex gap-3">
                    <button onclick="updateWater(-250)" class="w-14 h-14 rounded-2xl bg-slate-50 text-xl font-bold hover:bg-slate-100 active:bg-slate-200">-</button>
                    <button onclick="updateWater(250)" class="w-14 h-14 rounded-2xl bg-cyan-500 text-white shadow-lg text-2xl font-bold hover:bg-cyan-600 active:bg-cyan-700">+</button>
                </div>
            </div>

            <div class="glass-card rounded-[2.5rem] p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center"><i data-lucide="footprints" class="text-amber-500"></i></div>
                        <div><h4 class="font-bold">Steps</h4><p id="steps-count" class="text-xs text-slate-500">0 / 10,000</p></div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="updateSteps(-500)" class="flex-1 h-14 rounded-2xl bg-slate-50 text-slate-600 font-bold text-lg hover:bg-slate-100 active:bg-slate-200">-500</button>
                    <button onclick="updateSteps(500)" class="flex-1 h-14 rounded-2xl bg-amber-500 text-white font-bold text-lg hover:bg-amber-600 active:bg-amber-700">+500</button>
                </div>
            </div>

            <div id="habits-tracker" class="hidden glass-card rounded-[2.5rem] p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-purple-50 rounded-2xl flex items-center justify-center"><i data-lucide="check-circle" class="text-purple-500"></i></div>
                        <h3 class="font-bold text-lg">Daily Habits</h3>
                    </div>
                </div>
                <div id="dashboard-habits-list" class="space-y-3"></div>
            </div>

            <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white relative overflow-hidden shadow-xl">
                <h3 class="text-lg font-bold mb-1">Weekly Overview</h3>
                <div id="muscle-volume-stats" class="grid grid-cols-2 gap-y-3 gap-x-6 mb-6"></div>
                <button onclick="switchTab('training')" class="bg-indigo-600 px-6 py-3 rounded-2xl font-bold text-xs uppercase">Log Workout</button>
            </div>
        </section>

        <!-- TRAINING -->
        <section id="training" class="tab-content space-y-6">
            <!-- DATE SELECTOR -->
            <div class="glass-card p-4 rounded-2xl">
                <div class="flex items-center justify-between gap-3">
                    <button onclick="changeWorkoutDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex-1">
                        <input type="date" id="workout-date-picker" onchange="selectWorkoutDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                    </div>
                    <button onclick="changeWorkoutDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="workout-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                    <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Save Workout" to confirm</p>
                </div>
            </div>

            <div id="workout-setup" class="glass-card p-6 rounded-[2.5rem] space-y-4">
                <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                    <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Gym</button>
                    <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-slate-400">Home</button>
                </div>
                
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Exercise Focus</label>
                    <select id="workout-focus" onchange="toggleSpecificMuscle()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                        <option>Full Body</option>
                        <option>Upper</option>
                        <option>Lower</option>
                        <option>Push</option>
                        <option>Pull</option>
                        <option>Legs</option>
                        <option>Specific Muscle</option>
                    </select>
                </div>

                <div id="specific-muscle-container" class="hidden">
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Muscle</label>
                    <select id="specific-muscle" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                        <option>Chest</option>
                        <option>Back</option>
                        <option>Shoulders</option>
                        <option>Biceps</option>
                        <option>Triceps</option>
                        <option>Quads</option>
                        <option>Hamstrings</option>
                        <option>Glutes</option>
                        <option>Calves</option>
                    </select>
                </div>

                <div class="bg-slate-50 p-4 rounded-2xl space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-black uppercase text-slate-600">Add Cardio</span>
                        <input type="checkbox" id="add-cardio-check" class="w-5 h-5 accent-indigo-600">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-black uppercase text-slate-600">Add Core</span>
                        <input type="checkbox" id="add-core-check" class="w-5 h-5 accent-indigo-600">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="startWorkout('manual')" class="p-5 bg-slate-900 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-slate-800 active:bg-slate-700">Manual Entry</button>
                    <button onclick="startWorkout('ai')" class="p-5 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-base min-h-[60px] hover:bg-indigo-700 active:bg-indigo-800">AI Generate</button>
                </div>
                
                <button onclick="openCardioModal()" class="w-full mt-3 p-5 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-[1.5rem] font-bold text-base flex items-center justify-center gap-2 hover:from-cyan-600 hover:to-blue-600">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                    Log Outdoor Cardio
                </button>
            </div>

            <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div>
                        <h3 id="active-workout-title" class="text-xl font-black">Workout</h3>
                        <p id="workout-timer" class="text-indigo-600 font-bold">00:00:00</p>
                    </div>
                    <button onclick="cancelWorkout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl">√ó</button>
                </div>
                <div id="exercise-list" class="space-y-4 mb-6"></div>
                <button onclick="addExercise()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs mb-4">+ Add Exercise</button>
                <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold">Finish Workout</button>
            </div>
        </section>

        <!-- NUTRITION -->
        <section id="nutrition" class="tab-content space-y-6">
            <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                <button onclick="setNutritionTab('diary')" id="nut-tab-diary" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Diary</button>
                <button onclick="setNutritionTab('search')" id="nut-tab-search" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Search</button>
            </div>

            <!-- DIARY TAB -->
            <div id="nut-view-diary" class="space-y-6">
                <!-- DATE SELECTOR -->
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex items-center justify-between gap-3">
                        <button onclick="changeNutritionDate(-1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <input type="date" id="nutrition-date-picker" onchange="selectNutritionDate(this.value)" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none">
                        </div>
                        <button onclick="changeNutritionDate(1)" class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center hover:bg-slate-200">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="nutrition-date-warning" class="hidden mt-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                        <p class="text-xs text-amber-800 font-bold text-center">‚ö†Ô∏è Editing past date - Click "Save Changes" to confirm</p>
                    </div>
                </div>

                <!-- SAVE/CANCEL BUTTONS (hidden for today) -->
                <div id="nutrition-save-buttons" class="hidden flex gap-3">
                    <button onclick="saveNutritionChanges()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold hover:bg-emerald-700">
                        Save Changes
                    </button>
                    <button onclick="cancelNutritionChanges()" class="flex-1 py-4 bg-slate-200 text-slate-700 rounded-2xl font-bold hover:bg-slate-300">
                        Cancel
                    </button>
                </div>

                <div class="bg-white rounded-[32px] p-8 border border-slate-100 shadow-xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <div id="total-kcal" class="text-5xl font-black text-slate-900 mb-1">0</div>
                            <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Calories Today</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-black text-blue-600 flex items-center gap-1 justify-end">
                                <i data-lucide="zap" class="w-5 h-5 fill-current"></i> <span id="total-protein">0.0</span>g
                            </div>
                            <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Protein</div>
                        </div>
                    </div>
                </div>

                <div id="meal-sections"></div>

                <div class="text-center py-4 px-6 bg-indigo-50 rounded-2xl border border-indigo-100 mt-6">
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <i data-lucide="clock" class="w-4 h-4 text-indigo-600"></i>
                        <p class="text-sm font-bold text-indigo-900">Auto-Save Enabled</p>
                    </div>
                    <p class="text-xs text-indigo-600">Your daily meals are automatically saved at midnight</p>
                </div>
            </div>

            <!-- SEARCH TAB -->
            <div id="nut-view-search" class="hidden space-y-6">
                <div>
                    <label class="text-xs font-semibold text-slate-400 ml-1 mb-2 block">Store / Restaurant</label>
                    <div class="relative">
                        <input 
                            id="store-search-input" 
                            type="text" 
                            placeholder="Search stores or restaurants..." 
                            class="w-full p-4 bg-white rounded-3xl border border-slate-100 font-medium outline-none"
                            onfocus="showStoreDropdown()"
                            oninput="filterStoreDropdown(this.value)"
                            autocomplete="off">
                        <div id="store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto">
                            <!-- Dropdown populated by JS -->
                        </div>
                    </div>
                    <input type="hidden" id="store-select" value="all">
                </div>

                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                        <input id="food-search-input" type="text" placeholder="Search food..." 
                            class="w-full bg-slate-100 border-2 border-transparent rounded-[20px] py-4 pl-12 pr-4 focus:bg-white focus:border-emerald-500 outline-none font-semibold">
                    </div>
                    <button onclick="openBarcodeScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center">
                        <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                    </button>
                </div>

                <button onclick="openCreateMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold">
                    Create Meal
                </button>

                <div id="created-meals-list" class="space-y-3"></div>

                <div id="search-loading" class="hidden py-20 text-center">
                    <i data-lucide="loader-2" class="animate-spin text-emerald-500 mx-auto"></i>
                </div>
                <div id="search-results-list" class="space-y-3"></div>
                
                <!-- MANUAL FOOD ENTRY -->
                <div class="text-center py-4">
                    <p class="text-xs text-slate-400 mb-3">Can't find what you're looking for?</p>
                    <button onclick="openManualFoodEntry()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-slate-800 transition-all">
                        + Add Food Manually
                    </button>
                </div>
            </div>
        </section>

        <!-- LOGS -->
        <section id="logs" class="tab-content space-y-6">
            <div class="flex bg-slate-100 p-2 rounded-2xl gap-2">
                <button onclick="setLogsTab('training')" id="logs-tab-training" class="flex-1 py-4 text-xs font-black uppercase rounded-xl bg-white text-indigo-600 shadow-sm">Training</button>
                <button onclick="setLogsTab('nutrition')" id="logs-tab-nutrition" class="flex-1 py-4 text-xs font-black uppercase rounded-xl text-slate-400">Nutrition</button>
            </div>
            
            <div id="logs-training-view" class="space-y-4">
                <!-- WORKOUT TYPE FILTERS -->
                <div class="glass-card p-4 rounded-2xl">
                    <p class="text-xs font-black uppercase text-slate-400 mb-3">Filter Workouts</p>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" id="filter-weights" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                            <span class="text-sm font-bold">üí™ Weights</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" id="filter-cardio" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                            <span class="text-sm font-bold">üèÉ Cardio</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" id="filter-core" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                            <span class="text-sm font-bold">üéØ Core</span>
                        </label>
                        <label class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" id="filter-walking" checked onchange="filterWorkouts()" class="w-4 h-4 accent-indigo-600">
                            <span class="text-sm font-bold">üö∂ Walking</span>
                        </label>
                    </div>
                </div>
                
                <div id="training-logs-list"></div>
            </div>

            <div id="logs-nutrition-view" class="hidden space-y-4">
                <!-- HYDRATION LOGS -->
                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                        <i data-lucide="droplet" class="w-5 h-5 text-cyan-500"></i>
                        Hydration History
                    </h3>
                    <div id="hydration-logs-list" class="space-y-2"></div>
                </div>
                
                <div id="nutrition-logs-list"></div>
            </div>
        </section>

        <!-- BODY METRICS -->
        <section id="metrics" class="tab-content space-y-6">
            <div class="glass-card p-8 rounded-[3rem] space-y-8">
                <div class="bg-slate-50 p-6 rounded-3xl text-center border">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2">Weight (kg)</span>
                    <input id="metric-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-transparent text-center text-5xl font-black outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Chest (cm)</label>
                        <input id="metric-chest" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Shoulders (cm)</label>
                        <input id="metric-shoulders" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Arms (cm)</label>
                        <input id="metric-arms" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Waist (cm)</label>
                        <input id="metric-waist" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Legs (cm)</label>
                        <input id="metric-legs" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="text-[9px] font-black text-slate-400 block uppercase">Glutes (cm)</label>
                        <input id="metric-glutes" type="number" class="w-full bg-transparent font-bold outline-none">
                    </div>
                </div>

                <!-- PROGRESS PHOTOS -->
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black uppercase text-slate-400 text-center">Progress Photos</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="photo-slot" onclick="triggerPhotoUpload('front')">
                            <img id="photo-front-preview" class="hidden" alt="Front">
                            <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                            <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Front</span>
                        </div>
                        <div class="photo-slot" onclick="triggerPhotoUpload('side')">
                            <img id="photo-side-preview" class="hidden" alt="Side">
                            <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                            <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Side</span>
                        </div>
                        <div class="photo-slot" onclick="triggerPhotoUpload('back')">
                            <img id="photo-back-preview" class="hidden" alt="Back">
                            <i data-lucide="camera" class="text-slate-300 w-6 h-6"></i>
                            <span class="text-[8px] font-bold uppercase mt-2 text-slate-400">Back</span>
                        </div>
                    </div>
                    <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                </div>

                <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase">
                    Save Metrics
                </button>
            </div>

            <!-- VIEW OPTIONS BUTTONS -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openMetricsChart()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                    <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="line-chart" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                    <h4 class="font-bold text-sm mb-1">Progress Charts</h4>
                    <p class="text-xs text-slate-400">View trends</p>
                </button>

                <button onclick="openPhotoComparison()" class="glass-card p-6 rounded-2xl text-center hover:shadow-lg transition-all active:scale-95">
                    <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="images" class="w-6 h-6 text-emerald-600"></i>
                    </div>
                    <h4 class="font-bold text-sm mb-1">Compare Photos</h4>
                    <p class="text-xs text-slate-400">Side by side</p>
                </button>
            </div>
        </section>

        <!-- SETTINGS -->
        <section id="settings" class="tab-content space-y-6">
            <div class="glass-card p-6 rounded-[2.5rem] space-y-8">
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Daily Calorie Goal</label>
                    <input id="calorie-goal-input" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-bold" onchange="updateCalorieGoal(this.value)">
                </div>

                <div>
                    <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Gym Equipment</h3>
                    <div id="gym-equipment-list" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div>
                    <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Home Equipment</h3>
                    <div id="home-equipment-list" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-[11px] font-black uppercase text-slate-400">Daily Habits</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="habits-enabled" onchange="toggleHabits()" class="w-5 h-5 accent-indigo-600">
                            <span class="text-xs font-bold text-slate-600">Enable</span>
                        </label>
                    </div>
                    <div id="habits-section" class="hidden space-y-3">
                        <div class="flex gap-2">
                            <input id="new-habit-input" type="text" placeholder="Add a new habit..." class="flex-1 p-3 bg-slate-50 rounded-xl outline-none">
                            <button onclick="addHabit()" class="px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Add</button>
                        </div>
                        <div id="habits-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- TRACKING OPTIONS -->
                <div class="border-t border-slate-200 pt-6">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4">Tracking Options</h3>
                    
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                            <div>
                                <p class="font-bold text-sm">Track Hydration</p>
                                <p class="text-xs text-slate-500">Log daily water intake</p>
                            </div>
                            <input type="checkbox" id="track-hydration" onchange="toggleTracking('hydration')" class="w-5 h-5 accent-indigo-600" checked>
                        </label>
                        
                        <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                            <div>
                                <p class="font-bold text-sm">Track Steps</p>
                                <p class="text-xs text-slate-500">Count daily steps</p>
                            </div>
                            <input type="checkbox" id="track-steps" onchange="toggleTracking('steps')" class="w-5 h-5 accent-indigo-600" checked>
                        </label>
                    </div>
                </div>

                <!-- GOAL SETTING -->
                <div class="border-t border-slate-200 pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-[11px] font-black uppercase text-slate-400">Goals</h3>
                        <button onclick="openGoalSetting()" class="text-xs font-bold text-indigo-600 hover:text-indigo-700">+ Add Goal</button>
                    </div>
                    <div id="goals-list" class="space-y-2"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- MANUAL FOOD ENTRY MODAL -->
    <div id="manual-food-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Add Food Manually</h3>
                <button onclick="closeManualFoodEntry()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>

            <!-- FOOD IMAGE (Optional) -->
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Image (Optional)</label>
                <div class="flex items-center gap-4">
                    <div id="manual-food-preview" class="w-24 h-24 bg-slate-100 rounded-2xl flex items-center justify-center overflow-hidden">
                        <i data-lucide="image" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <div class="flex-1">
                        <input type="file" id="manual-food-image" accept="image/*" class="hidden" onchange="previewManualFoodImage(event)">
                        <button onclick="document.getElementById('manual-food-image').click()" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100">
                            Choose Image
                        </button>
                        <button onclick="clearManualFoodImage()" class="w-full mt-2 py-2 text-xs text-slate-400 hover:text-red-600">
                            Clear Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- FOOD NAME -->
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Food Name</label>
                <input type="text" id="manual-food-name" placeholder="e.g., Chicken Sandwich" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500">
            </div>

            <!-- STORE/RESTAURANT -->
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Store / Restaurant</label>
                <div class="relative">
                    <input 
                        id="manual-food-store-input" 
                        type="text" 
                        placeholder="Search stores or restaurants..." 
                        class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-500"
                        onfocus="showManualStoreDropdown()"
                        oninput="filterManualStoreDropdown(this.value)"
                        autocomplete="off">
                    <div id="manual-store-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white rounded-2xl shadow-2xl border-2 border-indigo-100 max-h-48 overflow-y-auto">
                        <!-- Dropdown populated by JS -->
                    </div>
                </div>
            </div>

            <!-- NUTRITION INFO -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories (kcal)</label>
                    <input type="number" id="manual-food-calories" min="0" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Protein (g)</label>
                    <input type="number" id="manual-food-protein" min="0" step="0.1" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none border-2 border-transparent focus:border-indigo-500">
                </div>
            </div>

            <!-- OPTIONAL MACROS (Collapsible) -->
            <div class="mb-6">
                <button onclick="toggleManualFoodMacros()" class="w-full text-left text-xs font-bold text-indigo-600 hover:text-indigo-700 mb-3">
                    <span id="manual-macros-toggle">+ Add More Details (Optional)</span>
                </button>
                <div id="manual-food-macros" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Carbs (g)</label>
                        <input type="number" id="manual-food-carbs" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fat (g)</label>
                        <input type="number" id="manual-food-fat" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fiber (g)</label>
                        <input type="number" id="manual-food-fiber" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Sugar (g)</label>
                        <input type="number" id="manual-food-sugar" min="0" step="0.1" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-center outline-none text-sm">
                    </div>
                </div>
            </div>

            <!-- SERVING SIZE -->
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Serving Size</label>
                <input type="text" id="manual-food-serving" placeholder="e.g., 1 sandwich, 100g" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>

            <!-- BUTTONS -->
            <button onclick="saveManualFood()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:bg-emerald-700 mb-3">
                Save to My Foods
            </button>
            <button onclick="closeManualFoodEntry()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600">
                Cancel
            </button>
        </div>
    </div>

    <!-- SIDEBAR MENU -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100]" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-80 bg-white shadow-2xl z-[101] transform -translate-x-full transition-transform duration-300">
        <div class="p-6">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-black text-indigo-600">Menu</h2>
                <button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <nav class="space-y-2">
                <button onclick="switchTab('dashboard'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Dashboard</span>
                </button>
                
                <button onclick="switchTab('training'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="dumbbell" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Training</span>
                </button>
                
                <button onclick="switchTab('nutrition'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="apple" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Nutrition</span>
                </button>
                
                <button onclick="switchTab('logs'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="clipboard-list" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Logs</span>
                </button>
                
                <button onclick="switchTab('metrics'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Metrics</span>
                </button>
                
                <button onclick="switchTab('photos'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="camera" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Progress Photos</span>
                </button>
                
                <button onclick="switchTab('settings'); toggleSidebar();" class="w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-indigo-50 transition-colors group">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200">
                        <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i>
                    </div>
                    <span class="font-bold text-slate-700">Settings</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- GOAL SETTING MODAL -->
    <div id="goal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Set Goal</h3>
                <button onclick="closeGoalModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Type</label>
                <select id="goal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="short">Short-term (1-4 weeks)</option>
                    <option value="medium">Medium-term (1-3 months)</option>
                    <option value="long">Long-term (3+ months)</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Goal Description</label>
                <input type="text" id="goal-description" placeholder="e.g., Lose 5kg, Run 5k" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>

            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Target Date</label>
                <input type="date" id="goal-deadline" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>

            <button onclick="saveGoal()" class="w-full bg-indigo-600 text-white py-5 rounded-[24px] font-black hover:bg-indigo-700 mb-3">
                Save Goal
            </button>
            <button onclick="closeGoalModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- CARDIO LOGGING MODAL -->
    <div id="cardio-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Log Cardio Activity</h3>
                <button onclick="closeCardioModal()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl">√ó</button>
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Activity Type</label>
                <select id="cardio-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                    <option value="running">üèÉ Running</option>
                    <option value="cycling">üö¥ Cycling</option>
                    <option value="swimming">üèä Swimming</option>
                    <option value="walking">üö∂ Walking</option>
                    <option value="hiking">‚õ∞Ô∏è Hiking</option>
                    <option value="rowing">üö£ Rowing</option>
                    <option value="elliptical">‚ö° Elliptical</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Duration (min)</label>
                    <input type="number" id="cardio-duration" min="1" placeholder="30" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Distance (km)</label>
                    <input type="number" id="cardio-distance" min="0" step="0.1" placeholder="5.0" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
                </div>
            </div>

            <div class="mb-4">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Calories Burned (optional)</label>
                <input type="number" id="cardio-calories" min="0" placeholder="300" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-center outline-none">
            </div>

            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Notes (optional)</label>
                <textarea id="cardio-notes" rows="3" placeholder="How did it feel?" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none resize-none"></textarea>
            </div>

            <button onclick="saveCardio()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black hover:bg-emerald-700 mb-3">
                Save Activity
            </button>
            <button onclick="closeCardioModal()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <!-- FOOD ITEM POPUP -->
    <div id="food-popup" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
            <!-- FOOD IMAGE -->
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 h-32 sm:w-40 sm:h-40 bg-slate-50 rounded-3xl overflow-hidden mb-4 p-3 shadow-lg border-2 border-slate-100">
                    <img id="popup-image" src="" class="w-full h-full object-contain" alt="Food image">
                </div>
                <h2 id="popup-name" class="text-xl sm:text-2xl font-black text-center leading-tight mb-2">Product</h2>
            </div>

            <!-- CALORIES & PROTEIN -->
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-5 rounded-3xl mb-6 shadow-sm">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Calories</p>
                        <p id="popup-nutrition-cals" class="font-black text-3xl text-indigo-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">kcal</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-1 tracking-wide">Protein</p>
                        <p id="popup-nutrition-protein" class="font-black text-3xl text-blue-600">0</p>
                        <p class="text-xs text-slate-400 mt-1">grams</p>
                    </div>
                </div>
                
                <!-- ADDITIONAL MACROS -->
                <div class="grid grid-cols-3 gap-3 pt-3 border-t border-indigo-200">
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Carbs</p>
                        <p id="popup-nutrition-carbs" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fat</p>
                        <p id="popup-nutrition-fat" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Fiber</p>
                        <p id="popup-nutrition-fiber" class="font-bold text-sm text-indigo-600">0g</p>
                    </div>
                </div>
                
                <!-- DETAILED NUTRITION (Collapsible) -->
                <div id="detailed-nutrition" class="hidden mt-3 pt-3 border-t border-indigo-200">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sugar</p>
                            <p id="popup-nutrition-sugar" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sat Fat</p>
                            <p id="popup-nutrition-satfat" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Sodium</p>
                            <p id="popup-nutrition-sodium" class="font-bold text-indigo-600">0g</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[8px] text-slate-400 uppercase">Cholest</p>
                            <p id="popup-nutrition-cholesterol" class="font-bold text-indigo-600">0mg</p>
                        </div>
                    </div>
                </div>
                
                <button onclick="toggleDetailedNutrition()" class="w-full mt-2 text-[10px] font-bold text-indigo-600 hover:text-indigo-700">
                    <span id="toggle-text">Show More ‚ñº</span>
                </button>
                
                <p id="popup-nutrition" class="text-xs text-center text-slate-500 mt-3"></p>
            </div>

            <!-- MEAL TYPE -->
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Meal Type</label>
                <select id="popup-meal-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-base">
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch">Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                </select>
            </div>

            <!-- PORTION OR GRAMS -->
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Amount</label>
                <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-4">
                    <button onclick="setAmountType('portion')" id="amount-type-portion" class="flex-1 py-3 rounded-xl text-xs font-black uppercase bg-white shadow text-emerald-600">Portion</button>
                    <button onclick="setAmountType('grams')" id="amount-type-grams" class="flex-1 py-3 rounded-xl text-xs font-black uppercase text-slate-400">Grams</button>
                </div>
                <input id="popup-amount" type="number" value="1" min="1" class="w-full bg-slate-50 border-4 border-slate-200 rounded-[24px] py-5 text-4xl font-black text-center outline-none focus:border-emerald-500 transition-colors">
            </div>

            <!-- TOTAL CALCULATION -->
            <div class="bg-slate-900 text-white p-5 rounded-3xl mb-6 shadow-xl">
                <p class="text-[10px] font-black uppercase text-slate-400 text-center mb-3">Total You're Adding</p>
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <p id="popup-total-kcal" class="font-black text-3xl mb-1">0</p>
                        <p class="text-xs text-slate-400 uppercase">Calories</p>
                    </div>
                    <div class="w-px h-12 bg-slate-700"></div>
                    <div class="text-center">
                        <p id="popup-total-protein" class="font-black text-3xl text-emerald-400 mb-1">0g</p>
                        <p class="text-xs text-slate-400 uppercase">Protein</p>
                    </div>
                </div>
            </div>

            <!-- ADD BUTTON -->
            <button onclick="addFoodItem()" class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-5 rounded-[24px] font-black text-lg shadow-lg hover:shadow-xl transition-all active:scale-95 mb-3">
                Add to Diary
            </button>
            <button onclick="closeFoodPopup()" class="w-full py-3 text-sm font-bold text-slate-400 uppercase hover:text-slate-600 transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- BARCODE SCANNER MODAL -->
    <div id="barcode-scanner-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black">Scan Barcode</h3>
                <button onclick="closeBarcodeScanner()" class="w-10 h-10 bg-slate-100 rounded-full">√ó</button>
            </div>
            <div id="barcode-reader" class="w-full h-64 bg-black rounded-2xl mb-4"></div>
            <div class="flex gap-2">
                <input id="manual-barcode" type="text" placeholder="Or enter barcode manually..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="lookupBarcode()" class="bg-slate-900 text-white px-6 rounded-xl">Search</button>
            </div>
        </div>
    </div>

    <!-- CREATE MEAL MODAL -->
    <div id="create-meal-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Create Meal</h3>
                <button onclick="closeCreateMeal()" class="w-10 h-10 bg-slate-100 rounded-full">√ó</button>
            </div>

            <div class="mb-4">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Meal Name *</label>
                <input id="meal-name-input" type="text" placeholder="e.g. Chicken & Rice Bowl" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            </div>

            <div class="mb-4">
                <label class="text-xs font-semibold text-slate-400 mb-2 block">Store</label>
                <select id="meal-store-select" class="w-full p-3 bg-slate-50 rounded-2xl font-medium outline-none">
                    <option value="all">All Stores</option>
                    <option value="tesco">Tesco</option>
                    <option value="sainsburys">Sainsbury's</option>
                    <option value="asda">ASDA</option>
                    <option value="morrisons">Morrisons</option>
                    <option value="aldi">Aldi</option>
                    <option value="lidl">Lidl</option>
                    <option value="waitrose">Waitrose</option>
                    <option value="coop">Co-op</option>
                    <option value="iceland">Iceland</option>
                    <option value="costco">Costco</option>
                    <option value="marks">M&S Food</option>
                    <option value="ocado">Ocado</option>
                    <option value="farmfoods">Farmfoods</option>
                    <option value="booths">Booths</option>
                    <option value="budgens">Budgens</option>
                </select>
            </div>

            <div class="flex gap-2 mb-4">
                <input id="meal-ingredient-search" type="text" placeholder="Search ingredient..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 outline-none">
                <button onclick="openMealBarcodeScanner()" class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center">
                    <i data-lucide="scan-barcode" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="meal-search-results" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>

            <div class="mb-6">
                <h4 class="text-sm font-black text-slate-400 uppercase mb-2">Ingredients</h4>
                <div id="meal-ingredients-list" class="space-y-2"></div>
            </div>

            <button onclick="saveMeal()" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold">Save Meal</button>
        </div>
    </div>

    <!-- METRICS CHART MODAL -->
    <div id="metrics-chart-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Progress Charts</h3>
                <button onclick="closeMetricsChart()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>

            <div class="mb-6">
                <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Select Metric</label>
                <select id="chart-metric-select" onchange="renderMetricChart()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none text-lg">
                    <option value="weight">Weight (kg)</option>
                    <option value="chest">Chest (cm)</option>
                    <option value="shoulders">Shoulders (cm)</option>
                    <option value="arms">Arms (cm)</option>
                    <option value="waist">Waist (cm)</option>
                    <option value="legs">Legs (cm)</option>
                    <option value="glutes">Glutes (cm)</option>
                </select>
            </div>

            <div class="h-80 relative bg-slate-50 rounded-3xl p-4">
                <canvas id="metrics-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- PHOTO COMPARISON MODAL -->
    <div id="photo-comparison-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black">Compare Photos</h3>
                <button onclick="closePhotoComparison()" class="w-10 h-10 bg-slate-100 rounded-full text-2xl leading-none">√ó</button>
            </div>

            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">First Date</label>
                        <select id="compare-date-1" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Second Date</label>
                        <select id="compare-date-2" onchange="loadComparisonPhotos()" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                            <option value="">Select date...</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400 block mb-2">Photo Angle</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setComparePhotoType('front')" id="compare-type-front" class="p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white">Front</button>
                        <button onclick="setComparePhotoType('side')" id="compare-type-side" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Side</button>
                        <button onclick="setComparePhotoType('back')" id="compare-type-back" class="p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600">Back</button>
                    </div>
                </div>
            </div>

            <div id="comparison-view" class="grid grid-cols-2 gap-6 hidden">
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-1"></div>
                    <img id="compare-img-1" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="Before">
                </div>
                <div class="relative">
                    <div class="absolute top-3 left-3 bg-black/80 text-white px-4 py-2 rounded-xl text-sm font-bold z-10" id="compare-label-2"></div>
                    <img id="compare-img-2" src="" class="w-full aspect-[3/4] object-cover rounded-3xl bg-slate-100 border-4 border-white shadow-xl" alt="After">
                </div>
            </div>

            <div id="no-comparison-message" class="text-center py-12 text-slate-400">
                <i data-lucide="images" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                <p class="font-bold">Select two dates to compare</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        
        const EXERCISE_DB = {
            gym: {
                'Full Body': {
                    compound: ['Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press'],
                    isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl', 'Calf Raise']
                },
                'Upper': {
                    compound: ['Bench Press', 'Pull Ups', 'Dumbbell Row', 'Overhead Press', 'Dips'],
                    isolation: ['Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Face Pulls', 'Cable Flyes']
                },
                'Lower': {
                    compound: ['Barbell Squat', 'Romanian Deadlift', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Abduction', 'Glute Kickback']
                },
                'Push': {
                    compound: ['Bench Press', 'Overhead Press', 'Incline Press', 'Dips'],
                    isolation: ['Tricep Pushdown', 'Lateral Raise', 'Cable Flyes', 'Skull Crushers']
                },
                'Pull': {
                    compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                    isolation: ['Bicep Curl', 'Face Pulls', 'Hammer Curl', 'Cable Row']
                },
                'Legs': {
                    compound: ['Squat', 'Deadlift', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Leg Curl', 'Calf Raise', 'Hip Thrust']
                },
                'Chest': {
                    compound: ['Bench Press', 'Incline Press', 'Dumbbell Press'],
                    isolation: ['Cable Flyes', 'Pec Deck', 'Dumbbell Flyes']
                },
                'Back': {
                    compound: ['Pull Ups', 'Barbell Row', 'Lat Pulldown', 'T-Bar Row'],
                    isolation: ['Cable Row', 'Face Pulls', 'Straight Arm Pulldown']
                },
                'Shoulders': {
                    compound: ['Overhead Press', 'Arnold Press'],
                    isolation: ['Lateral Raise', 'Front Raise', 'Face Pulls', 'Reverse Flyes']
                },
                'Biceps': {
                    compound: ['Chin Ups'],
                    isolation: ['Barbell Curl', 'Hammer Curl', 'Preacher Curl', 'Cable Curl']
                },
                'Triceps': {
                    compound: ['Close Grip Bench Press', 'Dips'],
                    isolation: ['Tricep Pushdown', 'Skull Crushers', 'Overhead Extension']
                },
                'Quads': {
                    compound: ['Squat', 'Leg Press', 'Lunges'],
                    isolation: ['Leg Extension', 'Sissy Squat']
                },
                'Hamstrings': {
                    compound: ['Romanian Deadlift', 'Good Morning'],
                    isolation: ['Leg Curl', 'Nordic Curl']
                },
                'Glutes': {
                    compound: ['Hip Thrust', 'Bulgarian Split Squat'],
                    isolation: ['Cable Kickback', 'Hip Abduction', 'Glute Bridge']
                },
                'Calves': {
                    compound: [],
                    isolation: ['Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise']
                }
            },
            home: {
                'Full Body': {
                    compound: ['Push Ups', 'Bodyweight Squat', 'Burpees'],
                    isolation: ['Plank', 'Crunches', 'Leg Raises']
                },
                'Upper': {
                    compound: ['Push Ups', 'Pike Push Ups', 'Inverted Row'],
                    isolation: ['Tricep Dips', 'Plank to Push Up', 'Superman']
                },
                'Lower': {
                    compound: ['Bodyweight Squat', 'Lunges', 'Step Ups'],
                    isolation: ['Glute Bridge', 'Calf Raise', 'Donkey Kicks']
                },
                'Push': {
                    compound: ['Push Ups', 'Pike Push Ups'],
                    isolation: ['Diamond Push Ups', 'Tricep Dips', 'Shoulder Taps']
                },
                'Pull': {
                    compound: ['Inverted Row', 'Chin Ups'],
                    isolation: ['Superman', 'Reverse Snow Angels', 'Bicep Holds']
                },
                'Legs': {
                    compound: ['Squat', 'Lunges', 'Jump Squat'],
                    isolation: ['Glute Bridge', 'Calf Raise', 'Leg Raises']
                }
            }
        };

        // All exercises list for dropdown
        const ALL_EXERCISES = [
            'Barbell Squat', 'Deadlift', 'Bench Press', 'Pull Ups', 'Overhead Press',
            'Dumbbell Press', 'Incline Press', 'Dips', 'Barbell Row', 'Lat Pulldown',
            'T-Bar Row', 'Romanian Deadlift', 'Leg Press', 'Lunges', 'Good Morning',
            'Hip Thrust', 'Bulgarian Split Squat', 'Arnold Press', 'Close Grip Bench Press',
            'Chin Ups', 'Bicep Curl', 'Tricep Pushdown', 'Lateral Raise', 'Leg Curl',
            'Calf Raise', 'Face Pulls', 'Cable Flyes', 'Leg Extension', 'Hip Abduction',
            'Glute Kickback', 'Cable Row', 'Hammer Curl', 'Skull Crushers', 'Pec Deck',
            'Dumbbell Flyes', 'Front Raise', 'Reverse Flyes', 'Preacher Curl', 'Cable Curl',
            'Overhead Extension', 'Sissy Squat', 'Nordic Curl', 'Cable Kickback', 'Glute Bridge',
            'Standing Calf Raise', 'Seated Calf Raise', 'Donkey Calf Raise', 'Straight Arm Pulldown',
            'Push Ups', 'Bodyweight Squat', 'Burpees', 'Pike Push Ups', 'Inverted Row',
            'Step Ups', 'Donkey Kicks', 'Diamond Push Ups', 'Shoulder Taps', 'Superman',
            'Reverse Snow Angels', 'Bicep Holds', 'Jump Squat', 'Plank', 'Crunches',
            'Leg Raises', 'Tricep Dips', 'Plank to Push Up'
        ].sort();

        const CARDIO_EXERCISES = ['Treadmill', 'Rowing Machine', 'Stationary Bike', 'Elliptical', 'Stair Climber'];
        const CORE_EXERCISES = ['Plank', 'Crunches', 'Russian Twists', 'Leg Raises', 'Mountain Climbers', 'Dead Bug'];

        const UK_STORES_RESTAURANTS = [
            { name: 'All Stores & Restaurants', value: 'all', type: 'all' },
            // Supermarkets
            { name: 'Tesco', value: 'tesco', type: 'supermarket' },
            { name: "Sainsbury's", value: 'sainsburys', type: 'supermarket' },
            { name: 'ASDA', value: 'asda', type: 'supermarket' },
            { name: 'Morrisons', value: 'morrisons', type: 'supermarket' },
            { name: 'Aldi', value: 'aldi', type: 'supermarket' },
            { name: 'Lidl', value: 'lidl', type: 'supermarket' },
            { name: 'Waitrose', value: 'waitrose', type: 'supermarket' },
            { name: 'Co-op', value: 'coop', type: 'supermarket' },
            { name: 'Iceland', value: 'iceland', type: 'supermarket' },
            { name: 'Costco', value: 'costco', type: 'supermarket' },
            { name: 'M&S Food', value: 'marks', type: 'supermarket' },
            { name: 'Ocado', value: 'ocado', type: 'supermarket' },
            { name: 'Farmfoods', value: 'farmfoods', type: 'supermarket' },
            { name: 'Booths', value: 'booths', type: 'supermarket' },
            { name: 'Budgens', value: 'budgens', type: 'supermarket' },
            // Fast Food Chains
            { name: "McDonald's", value: 'mcdonalds', type: 'fastfood' },
            { name: 'KFC', value: 'kfc', type: 'fastfood' },
            { name: 'Burger King', value: 'burgerking', type: 'fastfood' },
            { name: 'Subway', value: 'subway', type: 'fastfood' },
            { name: 'Greggs', value: 'greggs', type: 'fastfood' },
            { name: 'Nando\'s', value: 'nandos', type: 'fastfood' },
            { name: 'Pizza Hut', value: 'pizzahut', type: 'fastfood' },
            { name: 'Domino\'s', value: 'dominos', type: 'fastfood' },
            { name: 'Papa John\'s', value: 'papajohns', type: 'fastfood' },
            { name: 'Five Guys', value: 'fiveguys', type: 'fastfood' },
            { name: 'Wagamama', value: 'wagamama', type: 'fastfood' },
            { name: 'Pret A Manger', value: 'pret', type: 'fastfood' },
            { name: 'Leon', value: 'leon', type: 'fastfood' },
            { name: 'Yo! Sushi', value: 'yosushi', type: 'fastfood' },
            { name: 'Nando\'s', value: 'nandos', type: 'fastfood' },
            { name: 'Gourmet Burger Kitchen', value: 'gbk', type: 'fastfood' },
            { name: "Costa Coffee", value: 'costa', type: 'fastfood' },
            { name: 'Starbucks', value: 'starbucks', type: 'fastfood' },
            { name: 'Caff√® Nero', value: 'nero', type: 'fastfood' }
        ].sort((a, b) => a.name.localeCompare(b.name));

        let state = {
            viewDate: new Date().toISOString().split('T')[0],
            goals: { calories: 2500, water: 2500, steps: 10000 },
            waterLogs: {},
            stepsLogs: {},
            dailyMeals: [],
            workoutHistory: [],
            nutritionHistory: [],
            metricsHistory: [],
            createdMeals: [],
            customFoods: [],
            workoutEnv: 'gym',
            currentPhotos: { front: null, side: null, back: null },
            habits: [],
            habitsEnabled: false,
            habitCompletions: {},
            trackHydration: true,
            trackSteps: true,
            goals: [],
            cardioLogs: [],
            hydrationLogs: {},
            stepsLogs: {},
            equipment: {
                gym: {
                    'Barbell': true,
                    'Dumbbells': true,
                    'Cable Machine': true,
                    'Leg Press': true,
                    'Pull Up Bar': true,
                    'Bench': true
                },
                home: {
                    'Dumbbells': false,
                    'Resistance Bands': false,
                    'Pull Up Bar': false,
                    'Yoga Mat': true
                }
            }
        };

        let workoutTimer = null;
        let workoutStartTime = null;
        let currentFoodItem = null;
        let currentAmountType = 'portion';
        let searchResults = [];
        let mealIngredients = [];
        let html5QrCode = null;
        let metricsChart = null;
        let currentPhotoType = null;

        // ============================================================================
        // UTILITIES
        // ============================================================================

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function saveState() {
            try {
                localStorage.setItem('fittrack_state', JSON.stringify(state));
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('fittrack_state');
                if (saved) {
                    state = { ...state, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.error('Load error:', e);
            }
        }

        // Auto-save meals at midnight
        function setupMidnightSave() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const msUntilMidnight = tomorrow - now;

            setTimeout(() => {
                saveDailyNutrition();
                setupMidnightSave(); // Set up for next day
            }, msUntilMidnight);
        }

        function saveDailyNutrition() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            if (todayMeals.length > 0) {
                const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
                const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);
                state.nutritionHistory.unshift({
                    date: state.viewDate,
                    calories: totalCals,
                    protein: totalProtein,
                    meals: todayMeals
                });
                saveState();
                showToast('Daily nutrition saved automatically');
            }
        }

        // ============================================================================
        // TAB MANAGEMENT
        // ============================================================================

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');

            if (tabId === 'logs') renderLogs();

            lucide.createIcons();
        }

        // ============================================================================
        // DASHBOARD
        // ============================================================================

        function renderDashboard() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);

            document.getElementById('dash-calories').innerText = Math.round(totalCals);
            document.getElementById('dash-protein').innerText = Math.round(totalProtein) + 'g';
            document.getElementById('dash-carbs').innerText = Math.round(totalCals * 0.4 / 4) + 'g';
            document.getElementById('dash-fat').innerText = Math.round(totalCals * 0.3 / 9) + 'g';

            const progress = Math.min((totalCals / state.goals.calories) * 534, 534);
            document.getElementById('calorie-progress').style.strokeDashoffset = 534 - progress;

            const water = state.waterLogs[state.viewDate] || 0;
            document.getElementById('water-count').innerText = `${(water/1000).toFixed(1)} / ${(state.goals.water/1000).toFixed(1)}L`;

            const steps = state.stepsLogs[state.viewDate] || 0;
            document.getElementById('steps-count').innerText = `${steps.toLocaleString()} / ${state.goals.steps.toLocaleString()}`;

            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekWorkouts = state.workoutHistory.filter(w => new Date(w.date) > weekAgo).length;

            document.getElementById('muscle-volume-stats').innerHTML = `
                <div class="bg-white/10 p-3 rounded-xl">
                    <div class="text-[10px] opacity-70 uppercase">This Week</div>
                    <div class="font-bold text-xl">${weekWorkouts} workouts</div>
                </div>
                <div class="bg-white/10 p-3 rounded-xl">
                    <div class="text-[10px] opacity-70 uppercase">Last Weight</div>
                    <div class="font-bold text-xl">${state.metricsHistory[0]?.weight || '--'} kg</div>
                </div>`;
        }

        function updateWater(ml) {
            state.waterLogs[state.viewDate] = Math.max(0, (state.waterLogs[state.viewDate] || 0) + ml);
            state.hydrationLogs[state.viewDate] = state.waterLogs[state.viewDate];
            saveState();
            renderDashboard();
            showToast(ml > 0 ? 'Water added' : 'Water removed');
        }

        function updateSteps(steps) {
            state.stepsLogs[state.viewDate] = Math.max(0, (state.stepsLogs[state.viewDate] || 0) + steps);
            saveState();
            renderDashboard();
            showToast(steps > 0 ? 'Steps added' : 'Steps removed');
        }

        // ============================================================================
        // TRAINING
        // ============================================================================

        function setWorkoutEnv(env) {
            state.workoutEnv = env;
            document.getElementById('env-tab-gym').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'gym' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('env-tab-home').className = `flex-1 py-2 text-[10px] font-black uppercase rounded-xl ${env === 'home' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
        }

        function toggleSpecificMuscle() {
            const focus = document.getElementById('workout-focus').value;
            document.getElementById('specific-muscle-container').classList.toggle('hidden', focus !== 'Specific Muscle');
        }

        function startWorkout(mode) {
            const focus = document.getElementById('workout-focus').value;
            const muscle = focus === 'Specific Muscle' ? document.getElementById('specific-muscle').value : focus;
            
            document.getElementById('workout-setup').classList.add('hidden');
            document.getElementById('workout-active').classList.remove('hidden');
            document.getElementById('active-workout-title').innerText = muscle;
            document.getElementById('exercise-list').innerHTML = '';

            if (mode === 'ai') {
                const exercises = EXERCISE_DB[state.workoutEnv][muscle];
                const addCardio = document.getElementById('add-cardio-check').checked;
                const addCore = document.getElementById('add-core-check').checked;
                
                if (exercises) {
                    // Get 2 compound exercises
                    const compounds = exercises.compound || [];
                    const selectedCompounds = compounds.sort(() => 0.5 - Math.random()).slice(0, 2);
                    
                    // Get 3 isolation exercises
                    const isolations = exercises.isolation || [];
                    const selectedIsolations = isolations.sort(() => 0.5 - Math.random()).slice(0, 3);
                    
                    // Add weight training exercises (compounds first, then isolations)
                    // Use setTimeout to stagger the additions slightly so each gets a unique ID
                    let delay = 0;
                    [...selectedCompounds, ...selectedIsolations].forEach(ex => {
                        setTimeout(() => addExercise(ex), delay);
                        delay += 10;
                    });
                    
                    // Add cardio after weight training if selected
                    if (addCardio) {
                        const cardio = CARDIO_EXERCISES[Math.floor(Math.random() * CARDIO_EXERCISES.length)];
                        setTimeout(() => addExercise(cardio), delay);
                        delay += 10;
                    }
                    
                    // Add core at the end if selected
                    if (addCore) {
                        const core1 = CORE_EXERCISES[Math.floor(Math.random() * CORE_EXERCISES.length)];
                        const core2 = CORE_EXERCISES.filter(c => c !== core1)[Math.floor(Math.random() * (CORE_EXERCISES.length - 1))];
                        setTimeout(() => addExercise(core1), delay);
                        delay += 10;
                        setTimeout(() => addExercise(core2), delay);
                    }
                    
                    showToast('AI workout generated: 2 compound + 3 isolation');
                } else {
                    showToast('No exercises found for this selection');
                }
            }

            workoutStartTime = Date.now();
            workoutTimer = setInterval(updateWorkoutTimer, 1000);
        }

        function updateWorkoutTimer() {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('workout-timer').innerText = `${h}:${m}:${s}`;
        }

        function addExercise(name = '') {
            const id = 'ex-' + Date.now() + Math.random().toString(36).substr(2, 9);
            const pr = name ? getPersonalRecord(name) : null;
            
            const card = document.createElement('div');
            card.className = "bg-white p-4 sm:p-5 rounded-2xl shadow-md border-2 border-indigo-100 mb-3 sm:mb-4 w-full";
            
            // Exercise name with dropdown
            const nameContainer = document.createElement('div');
            nameContainer.className = "relative mb-3 sm:mb-4";
            
            const nameInput = document.createElement('input');
            nameInput.type = "text";
            nameInput.value = name;
            nameInput.placeholder = "Search or type exercise name...";
            nameInput.className = "w-full p-3 sm:p-3.5 border-2 border-slate-200 rounded-xl font-bold text-base sm:text-lg";
            nameInput.id = `ex-name-${id}`;
            nameInput.autocomplete = "off";
            
            // Dropdown for exercise search
            const dropdown = document.createElement('div');
            dropdown.id = `dropdown-${id}`;
            dropdown.className = "hidden absolute z-50 mt-1 w-full bg-white rounded-xl shadow-2xl border-2 border-indigo-100 max-h-60 overflow-y-auto";
            
            // Add event listeners for search
            nameInput.addEventListener('focus', () => {
                showExerciseDropdown(id);
            });
            
            nameInput.addEventListener('input', (e) => {
                filterExerciseDropdown(id, e.target.value);
            });
            
            nameContainer.appendChild(nameInput);
            nameContainer.appendChild(dropdown);
            
            // Sets container with header
            const setsContainer = document.createElement('div');
            setsContainer.id = `sets-${id}`;
            setsContainer.className = "bg-slate-50 p-3 sm:p-4 rounded-xl mb-3 sm:mb-4 min-h-[100px] w-full";
            
            const header = document.createElement('div');
            header.className = "flex gap-2 sm:gap-3 mb-2 sm:mb-3";
            header.innerHTML = `
                <div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Reps</span></div>
                <div class="flex-1 text-center"><span class="text-xs sm:text-sm font-black text-slate-600 uppercase">Weight (kg)</span></div>
                <div class="w-9 sm:w-10"></div>
            `;
            setsContainer.appendChild(header);
            
            // Add set button
            const addSetBtn = document.createElement('button');
            addSetBtn.type = "button";
            addSetBtn.className = "w-full py-3 sm:py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-sm sm:text-base hover:bg-indigo-700 active:bg-indigo-800";
            addSetBtn.textContent = "+ Add Set";
            addSetBtn.addEventListener('click', () => addSetToExercise(id, pr));
            
            // Delete exercise button
            const deleteExBtn = document.createElement('button');
            deleteExBtn.type = "button";
            deleteExBtn.className = "w-full py-2 sm:py-2.5 mt-2 bg-red-50 text-red-600 rounded-xl font-bold text-xs sm:text-sm hover:bg-red-100";
            deleteExBtn.textContent = "Delete Exercise";
            deleteExBtn.addEventListener('click', () => card.remove());
            
            card.appendChild(nameContainer);
            card.appendChild(setsContainer);
            card.appendChild(addSetBtn);
            card.appendChild(deleteExBtn);
            
            document.getElementById('exercise-list').appendChild(card);
            
            // Auto-add first set
            setTimeout(() => addSetToExercise(id, pr), 50);
        }

        function showExerciseDropdown(id) {
            const dropdown = document.getElementById(`dropdown-${id}`);
            if (!dropdown) return;
            
            const html = ALL_EXERCISES.map(ex => {
                const pr = getPersonalRecord(ex);
                return `<div onclick="selectExerciseFromDropdown('${id}', '${ex}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center transition-colors">
                    <span class="font-medium text-sm">${ex}</span>
                    ${pr ? `<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>` : ''}
                </div>`;
            }).join('');
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function filterExerciseDropdown(id, query) {
            const dropdown = document.getElementById(`dropdown-${id}`);
            if (!dropdown) return;
            
            const filtered = ALL_EXERCISES.filter(ex => 
                ex.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0 && query.length > 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No exercises found - keep typing to use custom name</div>';
                dropdown.classList.remove('hidden');
            } else if (filtered.length > 0) {
                const html = filtered.map(ex => {
                    const pr = getPersonalRecord(ex);
                    return `<div onclick="selectExerciseFromDropdown('${id}', '${ex}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex justify-between items-center transition-colors">
                        <span class="font-medium text-sm">${ex}</span>
                        ${pr ? `<span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">PR: ${pr}kg</span>` : ''}
                    </div>`;
                }).join('');
                dropdown.innerHTML = html;
                dropdown.classList.remove('hidden');
            } else if (query.length === 0) {
                showExerciseDropdown(id);
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function selectExerciseFromDropdown(id, exerciseName) {
            const input = document.getElementById(`ex-name-${id}`);
            const dropdown = document.getElementById(`dropdown-${id}`);
            
            if (input) {
                input.value = exerciseName;
            }
            
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            // Get updated PR and refresh the set inputs
            const pr = getPersonalRecord(exerciseName);
            if (pr) {
                showToast(`PR: ${pr}kg`);
                // Update existing sets with new PR
                const container = document.getElementById(`sets-${id}`);
                if (container) {
                    const setRows = container.querySelectorAll('.flex.gap-2');
                    setRows.forEach(row => {
                        const weightDiv = row.querySelector('.relative');
                        if (weightDiv) {
                            // Remove old PB badge
                            const oldBadge = weightDiv.querySelector('.absolute');
                            if (oldBadge) oldBadge.remove();
                            
                            // Add new PB badge
                            const pbBadge = document.createElement('span');
                            pbBadge.className = "absolute right-1.5 sm:right-2 top-1/2 -translate-y-1/2 text-[9px] sm:text-[10px] font-black text-emerald-600 bg-emerald-50 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded whitespace-nowrap";
                            pbBadge.textContent = `PB: ${pr}kg`;
                            weightDiv.appendChild(pbBadge);
                        }
                    });
                }
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('[id^="ex-name-"]') && !e.target.closest('[id^="dropdown-"]')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    d.classList.add('hidden');
                });
            }
            if (!e.target.matches('#store-search-input') && !e.target.closest('#store-dropdown')) {
                const storeDropdown = document.getElementById('store-dropdown');
                if (storeDropdown) storeDropdown.classList.add('hidden');
            }
        });

        function showStoreDropdown() {
            const dropdown = document.getElementById('store-dropdown');
            if (!dropdown) return;
            
            const html = UK_STORES_RESTAURANTS.map(store => {
                const typeLabel = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : '';
                return `<div onclick="selectStore('${store.value}', '${store.name}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                    <span>${typeLabel}</span>
                    <span class="font-medium text-sm flex-1">${store.name}</span>
                </div>`;
            }).join('');
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function filterStoreDropdown(query) {
            const dropdown = document.getElementById('store-dropdown');
            if (!dropdown) return;
            
            const filtered = UK_STORES_RESTAURANTS.filter(store => 
                store.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>';
            } else {
                const html = filtered.map(store => {
                    const typeLabel = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : '';
                    return `<div onclick="selectStore('${store.value}', '${store.name}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                        <span>${typeLabel}</span>
                        <span class="font-medium text-sm flex-1">${store.name}</span>
                    </div>`;
                }).join('');
                dropdown.innerHTML = html;
            }
            
            dropdown.classList.remove('hidden');
        }

        function selectStore(value, name) {
            document.getElementById('store-search-input').value = name;
            document.getElementById('store-select').value = value;
            document.getElementById('store-dropdown').classList.add('hidden');
            
            // Show confirmation toast
            showToast(`Filter: ${name}`);
            
            // If there's an active food search, re-run it with the new filter
            const foodSearchInput = document.getElementById('food-search-input');
            if (foodSearchInput && foodSearchInput.value.trim().length >= 2) {
                searchFood(foodSearchInput.value.trim());
            }
        }

        function addSetToExercise(exerciseId, pr) {
            const container = document.getElementById(`sets-${exerciseId}`);
            if (!container) {
                console.error('Container not found:', exerciseId);
                return;
            }
            
            const setRow = document.createElement('div');
            setRow.className = "flex gap-2 sm:gap-3 items-center mb-2 bg-white p-2 sm:p-3 rounded-lg border border-slate-200";
            
            // Reps input
            const repsInput = document.createElement('input');
            repsInput.type = "number";
            repsInput.placeholder = "Reps";
            repsInput.min = "0";
            repsInput.className = "flex-1 p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
            
            // Weight container
            const weightDiv = document.createElement('div');
            weightDiv.className = "flex-1 relative";
            
            const weightInput = document.createElement('input');
            weightInput.type = "number";
            weightInput.placeholder = "Weight";
            weightInput.min = "0";
            weightInput.step = "0.5";
            weightInput.className = "w-full p-3 sm:p-4 bg-slate-50 rounded-lg text-center font-bold text-base sm:text-lg border-2 border-transparent focus:border-indigo-500";
            
            weightDiv.appendChild(weightInput);
            
            // Add PB badge if exists - positioned at top right corner, slightly outside
            if (pr) {
                const pbBadge = document.createElement('span');
                pbBadge.className = "absolute -top-2 -right-2 text-[9px] sm:text-[10px] font-black text-white bg-emerald-500 px-2 py-1 rounded-full shadow-md whitespace-nowrap z-10";
                pbBadge.textContent = `PB ${pr}kg`;
                weightDiv.appendChild(pbBadge);
            }
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.type = "button";
            deleteBtn.className = "w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold text-lg sm:text-xl flex-shrink-0";
            deleteBtn.textContent = "√ó";
            deleteBtn.addEventListener('click', () => setRow.remove());
            
            setRow.appendChild(repsInput);
            setRow.appendChild(weightDiv);
            setRow.appendChild(deleteBtn);
            
            container.appendChild(setRow);
        }

        function getPersonalRecord(exerciseName) {
            let maxWeight = 0;
            state.workoutHistory.forEach(workout => {
                workout.exercises.forEach(ex => {
                    if (ex.name === exerciseName) {
                        ex.sets.forEach(set => {
                            const weight = parseFloat(set.weight) || parseFloat(set.kg) || 0;
                            if (weight > maxWeight) maxWeight = weight;
                        });
                    }
                });
            });
            return maxWeight > 0 ? maxWeight : null;
        }

        function saveWorkout() {
            clearInterval(workoutTimer);
            
            const exercises = [];
            document.querySelectorAll('#exercise-list > div').forEach(card => {
                const nameInput = card.querySelector('input[type="text"]');
                const name = nameInput ? nameInput.value.trim() : '';
                if (!name) return;
                
                const sets = [];
                const setRows = card.querySelectorAll('.flex.gap-2.items-center.mb-2');
                setRows.forEach(row => {
                    const inputs = row.querySelectorAll('input[type="number"]');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        sets.push({ 
                            reps: inputs[0].value, 
                            weight: inputs[1].value 
                        });
                    }
                });
                
                if (sets.length > 0) {
                    exercises.push({ name, sets });
                }
            });

            if (exercises.length === 0) {
                showToast('Add at least one exercise with sets');
                return;
            }

            // Use selected date from date picker or current date
            const workoutDate = window.selectedWorkoutDate || document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];

            state.workoutHistory.unshift({
                id: Date.now(),
                date: workoutDate,
                focus: document.getElementById('active-workout-title').innerText,
                duration: document.getElementById('workout-timer').innerText,
                exercises
            });

            saveState();
            document.getElementById('workout-setup').classList.remove('hidden');
            document.getElementById('workout-active').classList.add('hidden');
            renderDashboard();
            showToast('Workout saved!');
        }

        function cancelWorkout() {
            if (confirm('Discard workout?')) {
                clearInterval(workoutTimer);
                document.getElementById('workout-setup').classList.remove('hidden');
                document.getElementById('workout-active').classList.add('hidden');
            }
        }

        // ============================================================================
        // NUTRITION
        // ============================================================================

        function setNutritionTab(tab) {
            document.getElementById('nut-tab-diary').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'diary' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('nut-tab-search').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'search' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            
            document.getElementById('nut-view-diary').classList.toggle('hidden', tab !== 'diary');
            document.getElementById('nut-view-search').classList.toggle('hidden', tab !== 'search');

            if (tab === 'diary') renderDiary();
            if (tab === 'search') renderCreatedMeals();
        }

        function renderDiary() {
            const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
            const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
            const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);

            document.getElementById('total-kcal').innerText = Math.round(totalCals);
            document.getElementById('total-protein').innerText = totalProtein.toFixed(1);

            const sections = ['breakfast', 'lunch', 'dinner', 'snack'];
            let html = '';
            
            sections.forEach(section => {
                const meals = todayMeals.filter(m => m.mealType === section);
                const icon = { breakfast: 'coffee', lunch: 'utensils', dinner: 'moon', snack: 'cookie' }[section];
                
                html += `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="${icon}" class="w-4 h-4 text-slate-400"></i>
                            <h3 class="text-[11px] font-black text-slate-400 uppercase">${section}</h3>
                        </div>
                        ${meals.length === 0 ? '<p class="text-xs text-slate-300 italic px-4">Nothing logged</p>' : ''}
                        ${meals.map(m => `
                            <div class="bg-white p-4 rounded-[24px] mb-2 border border-slate-100 flex items-center gap-4">
                                <img src="${m.image}" class="w-12 h-12 object-contain bg-slate-50 rounded-lg p-1" onerror="this.src='https://via.placeholder.com/100'">
                                <div class="flex-1">
                                    <p class="font-bold text-sm">${m.name}</p>
                                    <p class="text-xs text-slate-400">${m.amount} ‚Ä¢ ${m.calories}kcal ‚Ä¢ ${m.protein}g protein</p>
                                </div>
                                <button onclick="removeMeal(${m.id})" class="text-slate-300 hover:text-red-500">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>`;
            });

            document.getElementById('meal-sections').innerHTML = html;
            lucide.createIcons();
        }

        function removeMeal(id) {
            state.dailyMeals = state.dailyMeals.filter(m => m.id !== id);
            saveState();
            renderDiary();
            renderDashboard();
            showToast('Item removed');
        }

        // Food Search
        let searchDebounce;
        document.getElementById('food-search-input')?.addEventListener('input', (e) => {
            clearTimeout(searchDebounce);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('search-results-list').innerHTML = '';
                return;
            }
            searchDebounce = setTimeout(() => searchFood(query), 500);
        });

        async function searchFood(query) {
            document.getElementById('search-loading').classList.remove('hidden');
            document.getElementById('search-results-list').innerHTML = '';

            try {
                const storeValue = document.getElementById('store-select').value;
                const selectedStore = UK_STORES_RESTAURANTS.find(s => s.value === storeValue);
                
                let searchResults_temp = [];
                const isFastFood = selectedStore && selectedStore.type === 'fastfood';
                
                if (storeValue && storeValue !== 'all' && selectedStore) {
                    const storeName = selectedStore.name;
                    const combinedQuery = `${query} ${storeName}`;
                    
                    // 1. OpenFoodFacts - Best for UK supermarket products
                    try {
                        const offUrl = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(combinedQuery)}&search_simple=1&json=1&page_size=50&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                        const offResponse = await fetch(offUrl);
                        const offData = await offResponse.json();
                        
                        const offResults = (offData.products || []).map(p => ({
                            name: p.product_name || 'Unknown',
                            image: p.image_small_url || 'https://via.placeholder.com/100',
                            calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                            protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1),
                            carbs: parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                            fat: parseFloat(p.nutriments?.fat_100g || 0).toFixed(1),
                            fiber: parseFloat(p.nutriments?.fiber_100g || 0).toFixed(1),
                            sugar: parseFloat(p.nutriments?.sugars_100g || 0).toFixed(1),
                            sodium: parseFloat(p.nutriments?.sodium_100g || 0).toFixed(3),
                            saturated_fat: parseFloat(p.nutriments?.['saturated-fat_100g'] || 0).toFixed(1),
                            cholesterol: parseFloat(p.nutriments?.cholesterol_100g || 0).toFixed(1),
                            serving: p.serving_size || '100g',
                            brand: p.brands || '',
                            categories: p.categories || '',
                            source: 'OpenFoodFacts'
                        }));
                        
                        const storeNameLower = storeName.toLowerCase();
                        searchResults_temp = offResults.filter(item => {
                            const brandLower = (item.brand || '').toLowerCase();
                            const nameLower = (item.name || '').toLowerCase();
                            const categoriesLower = (item.categories || '').toLowerCase();
                            
                            return brandLower.includes(storeNameLower) || 
                                   nameLower.includes(storeNameLower) ||
                                   categoriesLower.includes(storeNameLower);
                        });
                    } catch (error) {
                        console.error('OpenFoodFacts error:', error);
                    }
                    
                    // 2. USDA FoodData Central - Excellent for fast food chains
                    if ((searchResults_temp.length < 10 && isFastFood) || searchResults_temp.length === 0) {
                        try {
                            const usdaUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(combinedQuery)}&dataType=Branded,Survey%20(FNDDS)&pageSize=50&api_key=DEMO_KEY`;
                            const usdaResponse = await fetch(usdaUrl);
                            const usdaData = await usdaResponse.json();
                            
                            const usdaResults = (usdaData.foods || [])
                                .filter(f => {
                                    const desc = (f.description || '').toLowerCase();
                                    const brand = (f.brandName || '').toLowerCase();
                                    const storeNameLower = storeName.toLowerCase();
                                    return desc.includes(storeNameLower) || brand.includes(storeNameLower);
                                })
                                .map(f => {
                                    const nutrients = f.foodNutrients || [];
                                    const getNutrient = (names) => {
                                        for (let name of names) {
                                            const nutrient = nutrients.find(n => 
                                                n.nutrientName?.toLowerCase().includes(name.toLowerCase())
                                            );
                                            if (nutrient) return parseFloat(nutrient.value || 0);
                                        }
                                        return 0;
                                    };
                                    
                                    return {
                                        name: f.description || 'Unknown',
                                        image: 'https://via.placeholder.com/100',
                                        calories: Math.round(getNutrient(['energy', 'calories'])),
                                        protein: getNutrient(['protein']).toFixed(1),
                                        carbs: getNutrient(['carbohydrate', 'carbs']).toFixed(1),
                                        fat: getNutrient(['total lipid', 'total fat']).toFixed(1),
                                        fiber: getNutrient(['fiber', 'dietary fiber']).toFixed(1),
                                        sugar: getNutrient(['sugars', 'total sugars']).toFixed(1),
                                        sodium: (getNutrient(['sodium']) / 1000).toFixed(3),
                                        saturated_fat: getNutrient(['saturated', 'fatty acids, total saturated']).toFixed(1),
                                        cholesterol: getNutrient(['cholesterol']).toFixed(1),
                                        serving: f.servingSize ? `${f.servingSize}${f.servingSizeUnit || 'g'}` : '100g',
                                        brand: f.brandName || f.brandOwner || storeName,
                                        categories: f.foodCategory || '',
                                        source: 'USDA'
                                    };
                                });
                            
                            searchResults_temp = [...searchResults_temp, ...usdaResults];
                        } catch (error) {
                            console.error('USDA error:', error);
                        }
                    }
                    
                    // 3. Nutritionix API (public endpoint) - Great for restaurant/fast food data
                    if (searchResults_temp.length < 10 && isFastFood) {
                        try {
                            // Using Nutritionix's common foods endpoint (public access)
                            const nutritionixUrl = `https://trackapi.nutritionix.com/v2/search/instant?query=${encodeURIComponent(combinedQuery)}`;
                            const nutritionixResponse = await fetch(nutritionixUrl, {
                                headers: {
                                    'x-app-id': '0', // Public demo access
                                    'x-app-key': 'demo'
                                }
                            });
                            
                            if (nutritionixResponse.ok) {
                                const nutritionixData = await nutritionixResponse.json();
                                const branded = nutritionixData.branded || [];
                                
                                const nutritionixResults = branded
                                    .filter(item => {
                                        const brandName = (item.brand_name || '').toLowerCase();
                                        const foodName = (item.food_name || '').toLowerCase();
                                        const storeNameLower = storeName.toLowerCase();
                                        return brandName.includes(storeNameLower) || foodName.includes(storeNameLower);
                                    })
                                    .slice(0, 10)
                                    .map(item => ({
                                        name: item.food_name || 'Unknown',
                                        image: item.photo?.thumb || 'https://via.placeholder.com/100',
                                        calories: Math.round(item.nf_calories || 0),
                                        protein: parseFloat(item.nf_protein || 0).toFixed(1),
                                        carbs: parseFloat(item.nf_total_carbohydrate || 0).toFixed(1),
                                        fat: parseFloat(item.nf_total_fat || 0).toFixed(1),
                                        fiber: parseFloat(item.nf_dietary_fiber || 0).toFixed(1),
                                        sugar: parseFloat(item.nf_sugars || 0).toFixed(1),
                                        sodium: (parseFloat(item.nf_sodium || 0) / 1000).toFixed(3),
                                        saturated_fat: parseFloat(item.nf_saturated_fat || 0).toFixed(1),
                                        cholesterol: parseFloat(item.nf_cholesterol || 0).toFixed(1),
                                        serving: item.serving_qty ? `${item.serving_qty} ${item.serving_unit}` : '100g',
                                        brand: item.brand_name || storeName,
                                        categories: item.brand_type || '',
                                        source: 'Nutritionix'
                                    }));
                                
                                searchResults_temp = [...searchResults_temp, ...nutritionixResults];
                            }
                        } catch (error) {
                            console.error('Nutritionix error:', error);
                        }
                    }
                    
                } else {
                    // General search - use OpenFoodFacts and USDA
                    
                    // OpenFoodFacts
                    try {
                        const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=20&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        searchResults_temp = (data.products || []).map(p => ({
                            name: p.product_name || 'Unknown',
                            image: p.image_small_url || 'https://via.placeholder.com/100',
                            calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                            protein: parseFloat(p.nutriments?.proteins_100g || 0).toFixed(1),
                            carbs: parseFloat(p.nutriments?.carbohydrates_100g || 0).toFixed(1),
                            fat: parseFloat(p.nutriments?.fat_100g || 0).toFixed(1),
                            fiber: parseFloat(p.nutriments?.fiber_100g || 0).toFixed(1),
                            sugar: parseFloat(p.nutriments?.sugars_100g || 0).toFixed(1),
                            sodium: parseFloat(p.nutriments?.sodium_100g || 0).toFixed(3),
                            saturated_fat: parseFloat(p.nutriments?.['saturated-fat_100g'] || 0).toFixed(1),
                            cholesterol: parseFloat(p.nutriments?.cholesterol_100g || 0).toFixed(1),
                            serving: p.serving_size || '100g',
                            brand: p.brands || '',
                            categories: p.categories || '',
                            source: 'OpenFoodFacts'
                        }));
                    } catch (error) {
                        console.error('OpenFoodFacts general search error:', error);
                    }
                    
                    // Add USDA results
                    try {
                        const usdaUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&pageSize=10&api_key=DEMO_KEY`;
                        const usdaResponse = await fetch(usdaUrl);
                        const usdaData = await usdaResponse.json();
                        
                        const usdaResults = (usdaData.foods || []).slice(0, 10).map(f => {
                            const nutrients = f.foodNutrients || [];
                            const getNutrient = (names) => {
                                for (let name of names) {
                                    const nutrient = nutrients.find(n => 
                                        n.nutrientName?.toLowerCase().includes(name.toLowerCase())
                                    );
                                    if (nutrient) return parseFloat(nutrient.value || 0);
                                }
                                return 0;
                            };
                            
                            return {
                                name: f.description || 'Unknown',
                                image: 'https://via.placeholder.com/100',
                                calories: Math.round(getNutrient(['energy', 'calories'])),
                                protein: getNutrient(['protein']).toFixed(1),
                                carbs: getNutrient(['carbohydrate']).toFixed(1),
                                fat: getNutrient(['total lipid', 'total fat']).toFixed(1),
                                fiber: getNutrient(['fiber']).toFixed(1),
                                sugar: getNutrient(['sugars']).toFixed(1),
                                sodium: (getNutrient(['sodium']) / 1000).toFixed(3),
                                saturated_fat: getNutrient(['saturated']).toFixed(1),
                                cholesterol: getNutrient(['cholesterol']).toFixed(1),
                                serving: '100g',
                                brand: f.brandName || '',
                                categories: f.foodCategory || '',
                                source: 'USDA'
                            };
                        });
                        
                        searchResults_temp = [...searchResults_temp, ...usdaResults];
                    } catch (error) {
                        console.error('USDA general error:', error);
                    }
                }
                
                // Remove duplicates based on name similarity
                const uniqueResults = [];
                const seenNames = new Set();
                
                for (const item of searchResults_temp) {
                    const normalizedName = item.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    if (!seenNames.has(normalizedName)) {
                        seenNames.add(normalizedName);
                        uniqueResults.push(item);
                    }
                }
                
                searchResults = uniqueResults;
                
                // Add custom foods matching the query
                const customMatches = state.customFoods.filter(food => {
                    const foodName = food.name.toLowerCase();
                    const foodBrand = (food.brand || '').toLowerCase();
                    const queryLower = query.toLowerCase();
                    const storeMatch = selectedStore ? foodBrand.includes(selectedStore.name.toLowerCase()) : true;
                    
                    return (foodName.includes(queryLower) || foodBrand.includes(queryLower)) && storeMatch;
                });
                
                // Add custom foods to the beginning
                searchResults = [...customMatches, ...searchResults];
                
                renderSearchResults();
                
            } catch (error) {
                console.error('Search error:', error);
                showToast('Search failed');
            } finally {
                document.getElementById('search-loading').classList.add('hidden');
            }
        }

        function renderSearchResults() {
            const storeValue = document.getElementById('store-select').value;
            const selectedStoreName = storeValue !== 'all' ? 
                UK_STORES_RESTAURANTS.find(s => s.value === storeValue)?.name : null;
            
            let filterMessage = '';
            if (selectedStoreName) {
                filterMessage = `
                    <div class="flex items-center justify-between py-3 mb-3 bg-indigo-50 rounded-2xl px-4">
                        <span class="inline-flex items-center gap-2 text-indigo-700 text-xs font-bold">
                            <i data-lucide="filter" class="w-3 h-3"></i>
                            Filtering by ${selectedStoreName}
                        </span>
                        <button onclick="clearStoreFilter()" class="text-xs font-bold text-red-600 hover:text-red-700 flex items-center gap-1">
                            <i data-lucide="x" class="w-3 h-3"></i>
                            Clear
                        </button>
                    </div>`;
            }
            
            if (searchResults.length === 0) {
                const emptyMessage = selectedStoreName ? 
                    `<div class="text-center py-12">
                        <i data-lucide="package-x" class="w-16 h-16 mx-auto text-slate-300 mb-4"></i>
                        <p class="text-slate-600 font-bold mb-2">No products found from ${selectedStoreName}</p>
                        <p class="text-xs text-slate-400 mb-4">Try searching for a different item or change your store filter</p>
                        <button onclick="clearStoreFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-700">
                            Search All Stores
                        </button>
                    </div>` :
                    `<p class="text-center text-slate-400 py-8">No results found</p>`;
                
                document.getElementById('search-results-list').innerHTML = filterMessage + emptyMessage;
                lucide.createIcons();
                return;
            }
            
            const html = searchResults.map((item, idx) => `
                <div onclick="openFoodPopup(${idx})" class="bg-white p-4 rounded-[28px] border ${item.source === 'Custom' ? 'border-purple-200 bg-purple-50' : ''} flex items-center gap-4 cursor-pointer hover:shadow-lg transition-all">
                    <img src="${item.image}" class="w-14 h-14 object-contain bg-slate-50 rounded-xl p-1" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <p class="font-bold text-sm">${item.name}</p>
                            ${item.source === 'Custom' ? `<span class="text-[8px] font-black px-1.5 py-0.5 rounded bg-purple-500 text-white">MY FOOD</span>` : ''}
                            ${item.source && item.source !== 'Custom' ? `<span class="text-[8px] font-black px-1.5 py-0.5 rounded ${item.source === 'USDA' ? 'bg-green-100 text-green-700' : item.source === 'Nutritionix' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${item.source}</span>` : ''}
                        </div>
                        ${item.brand ? `<p class="text-[10px] text-indigo-600 font-semibold mb-1">${item.brand}</p>` : ''}
                        <p class="text-xs text-slate-400">${item.calories}kcal ‚Ä¢ ${item.protein}g protein${item.carbs ? ` ‚Ä¢ ${item.carbs}g carbs` : ''} ‚Ä¢ ${item.serving}</p>
                    </div>
                    <i data-lucide="plus" class="text-emerald-600"></i>
                </div>
            `).join('');
            
            document.getElementById('search-results-list').innerHTML = filterMessage + html;
            lucide.createIcons();
        }

        function clearStoreFilter() {
            document.getElementById('store-search-input').value = 'All Stores & Restaurants';
            document.getElementById('store-select').value = 'all';
            showToast('Filter cleared');
            
            // Re-run search if there's an active query
            const foodSearchInput = document.getElementById('food-search-input');
            if (foodSearchInput && foodSearchInput.value.trim().length >= 2) {
                searchFood(foodSearchInput.value.trim());
            }
        }

        // ============================================================================
        // MANUAL FOOD ENTRY
        // ============================================================================

        let manualFoodImageData = null;

        function openManualFoodEntry() {
            document.getElementById('manual-food-modal').style.display = 'flex';
            // Reset form
            document.getElementById('manual-food-name').value = '';
            document.getElementById('manual-food-store-input').value = '';
            document.getElementById('manual-food-calories').value = '';
            document.getElementById('manual-food-protein').value = '';
            document.getElementById('manual-food-carbs').value = '';
            document.getElementById('manual-food-fat').value = '';
            document.getElementById('manual-food-fiber').value = '';
            document.getElementById('manual-food-sugar').value = '';
            document.getElementById('manual-food-serving').value = '100g';
            clearManualFoodImage();
            lucide.createIcons();
        }

        function closeManualFoodEntry() {
            document.getElementById('manual-food-modal').style.display = 'none';
            manualFoodImageData = null;
        }

        function previewManualFoodImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    manualFoodImageData = e.target.result;
                    const preview = document.getElementById('manual-food-preview');
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function clearManualFoodImage() {
            manualFoodImageData = null;
            document.getElementById('manual-food-preview').innerHTML = '<i data-lucide="image" class="w-10 h-10 text-slate-300"></i>';
            document.getElementById('manual-food-image').value = '';
            lucide.createIcons();
        }

        function toggleManualFoodMacros() {
            const macrosDiv = document.getElementById('manual-food-macros');
            const toggleText = document.getElementById('manual-macros-toggle');
            const isHidden = macrosDiv.classList.contains('hidden');
            
            if (isHidden) {
                macrosDiv.classList.remove('hidden');
                toggleText.innerText = '- Hide Extra Details';
            } else {
                macrosDiv.classList.add('hidden');
                toggleText.innerText = '+ Add More Details (Optional)';
            }
        }

        function showManualStoreDropdown() {
            const dropdown = document.getElementById('manual-store-dropdown');
            if (!dropdown) return;
            
            const html = UK_STORES_RESTAURANTS.map(store => {
                const typeLabel = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : '';
                return `<div onclick="selectManualStore('${store.name}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                    <span>${typeLabel}</span>
                    <span class="font-medium text-sm flex-1">${store.name}</span>
                </div>`;
            }).join('');
            
            dropdown.innerHTML = html;
            dropdown.classList.remove('hidden');
        }

        function filterManualStoreDropdown(query) {
            const dropdown = document.getElementById('manual-store-dropdown');
            if (!dropdown) return;
            
            const filtered = UK_STORES_RESTAURANTS.filter(store => 
                store.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-400 text-sm italic text-center">No stores found</div>';
            } else {
                const html = filtered.map(store => {
                    const typeLabel = store.type === 'fastfood' ? 'üçî' : store.type === 'supermarket' ? 'üõí' : '';
                    return `<div onclick="selectManualStore('${store.name}')" class="p-3 hover:bg-indigo-50 cursor-pointer border-b last:border-0 flex items-center gap-2 transition-colors">
                        <span>${typeLabel}</span>
                        <span class="font-medium text-sm flex-1">${store.name}</span>
                    </div>`;
                }).join('');
                dropdown.innerHTML = html;
            }
            
            dropdown.classList.remove('hidden');
        }

        function selectManualStore(storeName) {
            document.getElementById('manual-food-store-input').value = storeName;
            document.getElementById('manual-store-dropdown').classList.add('hidden');
        }

        function saveManualFood() {
            const name = document.getElementById('manual-food-name').value.trim();
            const store = document.getElementById('manual-food-store-input').value.trim();
            const calories = parseFloat(document.getElementById('manual-food-calories').value) || 0;
            const protein = parseFloat(document.getElementById('manual-food-protein').value) || 0;
            const carbs = parseFloat(document.getElementById('manual-food-carbs').value) || 0;
            const fat = parseFloat(document.getElementById('manual-food-fat').value) || 0;
            const fiber = parseFloat(document.getElementById('manual-food-fiber').value) || 0;
            const sugar = parseFloat(document.getElementById('manual-food-sugar').value) || 0;
            const serving = document.getElementById('manual-food-serving').value.trim() || '100g';

            if (!name) {
                showToast('Please enter food name');
                return;
            }
            if (calories === 0 && protein === 0) {
                showToast('Please enter at least calories or protein');
                return;
            }

            const customFood = {
                id: Date.now(),
                name,
                brand: store || 'Custom',
                image: manualFoodImageData || 'https://via.placeholder.com/100',
                calories,
                protein: protein.toFixed(1),
                carbs: carbs.toFixed(1),
                fat: fat.toFixed(1),
                fiber: fiber.toFixed(1),
                sugar: sugar.toFixed(1),
                sodium: '0',
                saturated_fat: '0',
                cholesterol: '0',
                serving,
                source: 'Custom',
                categories: 'user-added'
            };

            state.customFoods.push(customFood);
            saveState();
            closeManualFoodEntry();
            showToast(`${name} saved to your foods!`);
            
            // Add to search results for immediate use
            searchResults.unshift(customFood);
            renderSearchResults();
        }

        // Close manual store dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('#manual-food-store-input') && !e.target.closest('#manual-store-dropdown')) {
                const dropdown = document.getElementById('manual-store-dropdown');
                if (dropdown) dropdown.classList.add('hidden');
            }
        });

        function openFoodPopup(idx) {
            currentFoodItem = searchResults[idx];
            document.getElementById('popup-image').src = currentFoodItem.image;
            document.getElementById('popup-name').innerText = currentFoodItem.name;
            document.getElementById('popup-nutrition').innerText = `Per ${currentFoodItem.serving}${currentFoodItem.source ? ' ‚Ä¢ ' + currentFoodItem.source : ''}`;
            
            // Main macros
            document.getElementById('popup-nutrition-cals').innerText = currentFoodItem.calories;
            document.getElementById('popup-nutrition-protein').innerText = currentFoodItem.protein;
            
            // Additional macros
            document.getElementById('popup-nutrition-carbs').innerText = (currentFoodItem.carbs || 0) + 'g';
            document.getElementById('popup-nutrition-fat').innerText = (currentFoodItem.fat || 0) + 'g';
            document.getElementById('popup-nutrition-fiber').innerText = (currentFoodItem.fiber || 0) + 'g';
            
            // Detailed nutrition
            document.getElementById('popup-nutrition-sugar').innerText = (currentFoodItem.sugar || 0) + 'g';
            document.getElementById('popup-nutrition-satfat').innerText = (currentFoodItem.saturated_fat || 0) + 'g';
            document.getElementById('popup-nutrition-sodium').innerText = (currentFoodItem.sodium || 0) + 'g';
            document.getElementById('popup-nutrition-cholesterol').innerText = Math.round(currentFoodItem.cholesterol || 0) + 'mg';
            
            // Reset detailed view
            document.getElementById('detailed-nutrition').classList.add('hidden');
            document.getElementById('toggle-text').innerText = 'Show More ‚ñº';
            
            document.getElementById('popup-amount').value = 1;
            currentAmountType = 'portion';
            updateFoodPopup();
            document.getElementById('food-popup').style.display = 'flex';
            lucide.createIcons();
        }

        function toggleDetailedNutrition() {
            const detailedDiv = document.getElementById('detailed-nutrition');
            const toggleText = document.getElementById('toggle-text');
            const isHidden = detailedDiv.classList.contains('hidden');
            
            if (isHidden) {
                detailedDiv.classList.remove('hidden');
                toggleText.innerText = 'Show Less ‚ñ≤';
            } else {
                detailedDiv.classList.add('hidden');
                toggleText.innerText = 'Show More ‚ñº';
            }
        }

        function closeFoodPopup() {
            document.getElementById('food-popup').style.display = 'none';
        }

        function setAmountType(type) {
            currentAmountType = type;
            document.getElementById('amount-type-portion').className = `flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${type === 'portion' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
            document.getElementById('amount-type-grams').className = `flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${type === 'grams' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`;
            updateFoodPopup();
        }

        document.getElementById('popup-amount')?.addEventListener('input', updateFoodPopup);

        function updateFoodPopup() {
            if (!currentFoodItem) return;
            const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
            const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
            
            const totalCals = Math.round(currentFoodItem.calories * multiplier);
            const totalProtein = (currentFoodItem.protein * multiplier).toFixed(1);
            
            document.getElementById('popup-total-kcal').innerText = totalCals;
            document.getElementById('popup-total-protein').innerText = totalProtein + 'g';
        }

        function addFoodItem() {
            if (!currentFoodItem) return;
            
            const amount = parseFloat(document.getElementById('popup-amount').value) || 0;
            const multiplier = currentAmountType === 'portion' ? amount : amount / 100;
            const mealType = document.getElementById('popup-meal-type').value;

            state.dailyMeals.push({
                id: Date.now(),
                date: state.viewDate,
                name: currentFoodItem.name,
                image: currentFoodItem.image,
                amount: currentAmountType === 'portion' ? `${amount} portion(s)` : `${amount}g`,
                calories: Math.round(currentFoodItem.calories * multiplier),
                protein: parseFloat((currentFoodItem.protein * multiplier).toFixed(1)),
                carbs: parseFloat(((currentFoodItem.carbs || 0) * multiplier).toFixed(1)),
                fat: parseFloat(((currentFoodItem.fat || 0) * multiplier).toFixed(1)),
                fiber: parseFloat(((currentFoodItem.fiber || 0) * multiplier).toFixed(1)),
                sugar: parseFloat(((currentFoodItem.sugar || 0) * multiplier).toFixed(1)),
                sodium: parseFloat(((currentFoodItem.sodium || 0) * multiplier).toFixed(3)),
                saturated_fat: parseFloat(((currentFoodItem.saturated_fat || 0) * multiplier).toFixed(1)),
                cholesterol: parseFloat(((currentFoodItem.cholesterol || 0) * multiplier).toFixed(1)),
                mealType,
                source: currentFoodItem.source || 'Manual'
            });

            saveState();
            closeFoodPopup();
            setNutritionTab('diary');
            renderDashboard();
            showToast('Added to diary!');
        }

        // Barcode Scanner
        function openBarcodeScanner() {
            document.getElementById('barcode-scanner-modal').style.display = 'flex';
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("barcode-reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    (code) => {
                        document.getElementById('manual-barcode').value = code;
                        lookupBarcode();
                    }
                ).catch(err => console.error('Scanner error:', err));
            }
        }

        function closeBarcodeScanner() {
            if (html5QrCode) {
                html5QrCode.stop();
                html5QrCode = null;
            }
            document.getElementById('barcode-scanner-modal').style.display = 'none';
        }

        async function lookupBarcode() {
            const code = document.getElementById('manual-barcode').value.trim();
            if (!code) return;

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const p = data.product;
                    searchResults = [{
                        name: p.product_name || 'Unknown',
                        image: p.image_small_url || 'https://via.placeholder.com/100',
                        calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                        protein: (p.nutriments?.proteins_100g || 0).toFixed(1),
                        serving: p.serving_size || '100g'
                    }];
                    closeBarcodeScanner();
                    openFoodPopup(0);
                } else {
                    showToast('Product not found');
                }
            } catch (error) {
                showToast('Barcode lookup failed');
            }
        }

        // Created Meals
        function renderCreatedMeals() {
            const html = state.createdMeals.map((meal, idx) => `
                <div class="bg-white p-4 rounded-[28px] border flex items-center gap-4 transition-all">
                    <div class="w-14 h-14 bg-emerald-50 rounded-xl flex items-center justify-center flex-shrink-0">
                        <i data-lucide="chef-hat" class="text-emerald-600"></i>
                    </div>
                    <div class="flex-1 min-w-0" onclick="addCreatedMeal(${idx})" class="cursor-pointer">
                        <p class="font-bold text-sm">${meal.name}</p>
                        <p class="text-xs text-slate-400">${meal.calories}kcal ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.ingredients.length} ingredients</p>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="addCreatedMeal(${idx}); event.stopPropagation();" class="w-9 h-9 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 flex items-center justify-center">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                        <button onclick="editCreatedMeal(${idx}); event.stopPropagation();" class="w-9 h-9 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 flex items-center justify-center">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteCreatedMeal(${idx}); event.stopPropagation();" class="w-9 h-9 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('created-meals-list').innerHTML = html || '<p class="text-center text-slate-400 py-8 text-sm">No custom meals created yet</p>';
            lucide.createIcons();
        }

        function addCreatedMeal(idx) {
            const meal = state.createdMeals[idx];
            state.dailyMeals.push({
                id: Date.now(),
                date: state.viewDate,
                name: meal.name,
                image: 'https://via.placeholder.com/100',
                amount: '1 meal',
                calories: meal.calories,
                protein: meal.protein,
                mealType: 'dinner'
            });
            saveState();
            setNutritionTab('diary');
            renderDashboard();
            showToast('Meal added!');
        }

        // Create Meal
        function openCreateMeal() {
            mealIngredients = [];
            document.getElementById('meal-name-input').value = '';
            document.getElementById('meal-ingredients-list').innerHTML = '';
            document.getElementById('create-meal-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeCreateMeal() {
            document.getElementById('create-meal-modal').style.display = 'none';
            window.editingMealIndex = null;
            
            // Reset modal title
            const modalTitle = document.querySelector('#create-meal-modal h3');
            if (modalTitle) modalTitle.textContent = 'Create Meal';
        }

        let mealSearchDebounce;
        document.getElementById('meal-ingredient-search')?.addEventListener('input', (e) => {
            clearTimeout(mealSearchDebounce);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('meal-search-results').innerHTML = '';
                return;
            }
            mealSearchDebounce = setTimeout(() => searchMealIngredient(query), 500);
        });

        async function searchMealIngredient(query) {
            try {
                const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&json=1&page_size=10&tagtype_0=countries&tag_contains_0=contains&tag_0=united-kingdom`;
                const response = await fetch(url);
                const data = await response.json();
                
                const results = (data.products || []).map(p => ({
                    name: p.product_name || 'Unknown',
                    image: p.image_small_url || 'https://via.placeholder.com/100',
                    calories: Math.round(p.nutriments?.['energy-kcal_100g'] || 0),
                    protein: (p.nutriments?.proteins_100g || 0).toFixed(1)
                }));

                const html = results.map((item, idx) => `
                    <div onclick="addMealIngredient(${idx}, ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-slate-100">
                        <img src="${item.image}" class="w-10 h-10 object-contain rounded" onerror="this.src='https://via.placeholder.com/100'">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-xs truncate">${item.name}</p>
                            <p class="text-[10px] text-slate-400">${item.calories}kcal, ${item.protein}g protein</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('meal-search-results').innerHTML = html;
            } catch (error) {
                console.error('Ingredient search error:', error);
            }
        }

        function addMealIngredient(idx, item) {
            const amount = prompt('Enter amount (in grams):', '100');
            if (!amount) return;

            const multiplier = parseFloat(amount) / 100;
            mealIngredients.push({
                name: item.name,
                amount: `${amount}g`,
                calories: Math.round(item.calories * multiplier),
                protein: parseFloat((item.protein * multiplier).toFixed(1))
            });

            renderMealIngredients();
            document.getElementById('meal-ingredient-search').value = '';
            document.getElementById('meal-search-results').innerHTML = '';
        }

        function renderMealIngredients() {
            const html = mealIngredients.map((ing, idx) => `
                <div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between">
                    <div>
                        <p class="font-bold text-xs">${ing.name}</p>
                        <p class="text-[10px] text-slate-400">${ing.amount} ‚Ä¢ ${ing.calories}kcal ‚Ä¢ ${ing.protein}g protein</p>
                    </div>
                    <button onclick="mealIngredients.splice(${idx}, 1); renderMealIngredients();" class="text-slate-300">√ó</button>
                </div>
            `).join('');
            document.getElementById('meal-ingredients-list').innerHTML = html || '<p class="text-xs text-slate-300 italic">No ingredients yet</p>';
        }

        function openMealBarcodeScanner() {
            // Similar to main barcode scanner but for meal creation
            showToast('Barcode scanner for meals - coming soon!');
        }

        function saveMeal() {
            const name = document.getElementById('meal-name-input').value.trim();
            if (!name) {
                showToast('Please enter meal name');
                return;
            }
            if (mealIngredients.length === 0) {
                showToast('Add at least one ingredient');
                return;
            }

            const totalCals = mealIngredients.reduce((sum, ing) => sum + ing.calories, 0);
            const totalProtein = mealIngredients.reduce((sum, ing) => sum + ing.protein, 0);

            const mealData = {
                id: Date.now(),
                name,
                calories: totalCals,
                protein: totalProtein,
                ingredients: [...mealIngredients]
            };

            if (window.editingMealIndex !== null && window.editingMealIndex !== undefined) {
                // Update existing meal
                mealData.id = state.createdMeals[window.editingMealIndex].id;
                state.createdMeals[window.editingMealIndex] = mealData;
                showToast('Meal updated!');
            } else {
                // Create new meal
                state.createdMeals.push(mealData);
                showToast('Meal saved!');
            }

            saveState();
            closeCreateMeal();
            renderCreatedMeals();
        }

        function editCreatedMeal(idx) {
            const meal = state.createdMeals[idx];
            
            // Open create meal modal
            document.getElementById('meal-name-input').value = meal.name;
            mealIngredients = [...meal.ingredients];
            renderMealIngredients();
            document.getElementById('create-meal-modal').style.display = 'flex';
            
            // Store the index for updating
            window.editingMealIndex = idx;
            
            // Change save button to update
            const modalTitle = document.querySelector('#create-meal-modal h3');
            if (modalTitle) modalTitle.textContent = 'Edit Meal';
            
            lucide.createIcons();
        }

        function deleteCreatedMeal(idx) {
            const meal = state.createdMeals[idx];
            if (confirm(`Delete "${meal.name}"?`)) {
                state.createdMeals.splice(idx, 1);
                saveState();
                renderCreatedMeals();
                showToast('Meal deleted');
            }
        }

        // ============================================================================
        // DATE MANAGEMENT - NUTRITION
        // ============================================================================

        function changeNutritionDate(days) {
            const currentDate = new Date(state.viewDate);
            currentDate.setDate(currentDate.getDate() + days);
            const newDate = currentDate.toISOString().split('T')[0];
            selectNutritionDate(newDate);
        }

        function selectNutritionDate(dateStr) {
            state.viewDate = dateStr;
            document.getElementById('nutrition-date-picker').value = dateStr;
            
            const today = new Date().toISOString().split('T')[0];
            const isToday = dateStr === today;
            
            // Show/hide warning and save buttons
            document.getElementById('nutrition-date-warning').classList.toggle('hidden', isToday);
            document.getElementById('nutrition-save-buttons').classList.toggle('hidden', isToday);
            
            renderDiary();
            renderDashboard();
            lucide.createIcons();
        }

        function saveNutritionChanges() {
            // Save current meals to history if not today
            const today = new Date().toISOString().split('T')[0];
            if (state.viewDate !== today) {
                const todayMeals = state.dailyMeals.filter(m => m.date === state.viewDate);
                if (todayMeals.length > 0) {
                    const totalCals = todayMeals.reduce((sum, m) => sum + m.calories, 0);
                    const totalProtein = todayMeals.reduce((sum, m) => sum + m.protein, 0);
                    
                    // Remove old entry for this date
                    state.nutritionHistory = state.nutritionHistory.filter(h => h.date !== state.viewDate);
                    
                    // Add updated entry
                    state.nutritionHistory.unshift({
                        date: state.viewDate,
                        calories: totalCals,
                        protein: totalProtein,
                        meals: todayMeals
                    });
                }
            }
            
            saveState();
            showToast('Changes saved!');
            
            // Return to today
            selectNutritionDate(new Date().toISOString().split('T')[0]);
        }

        function cancelNutritionChanges() {
            // Reload data from saved state
            loadState();
            
            // Return to today
            selectNutritionDate(new Date().toISOString().split('T')[0]);
            showToast('Changes cancelled');
        }

        // ============================================================================
        // DATE MANAGEMENT - TRAINING
        // ============================================================================

        function changeWorkoutDate(days) {
            const currentDate = document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
            const date = new Date(currentDate);
            date.setDate(date.getDate() + days);
            const newDate = date.toISOString().split('T')[0];
            selectWorkoutDate(newDate);
        }

        function selectWorkoutDate(dateStr) {
            document.getElementById('workout-date-picker').value = dateStr;
            window.selectedWorkoutDate = dateStr;
            
            const today = new Date().toISOString().split('T')[0];
            const isToday = dateStr === today;
            
            // Show/hide warning
            document.getElementById('workout-date-warning').classList.toggle('hidden', isToday);
            
            // Check if there's a workout for this date
            const existingWorkout = state.workoutHistory.find(w => w.date === dateStr);
            if (existingWorkout && !document.getElementById('workout-active').classList.contains('hidden')) {
                // Load existing workout
                loadExistingWorkout(existingWorkout);
            }
            
            lucide.createIcons();
        }

        function loadExistingWorkout(workout) {
            // This would populate the workout form with existing data
            // For now, just show a message
            showToast(`Workout found for this date (${workout.exercises.length} exercises)`);
        }

        // ============================================================================
        // LOGS
        // ============================================================================

        function setLogsTab(tab) {
            document.getElementById('logs-tab-training').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'training' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('logs-tab-nutrition').className = `flex-1 py-4 text-xs font-black uppercase rounded-xl ${tab === 'nutrition' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'}`;
            
            document.getElementById('logs-training-view').classList.toggle('hidden', tab !== 'training');
            document.getElementById('logs-nutrition-view').classList.toggle('hidden', tab !== 'nutrition');
            
            if (tab === 'nutrition') {
                renderHydrationLogs();
            } else {
                filterWorkouts();
            }
            
            renderLogs();
        }

        function renderLogs() {
            // Training logs
            const trainingHtml = state.workoutHistory.length === 0 ? 
                '<p class="text-center text-slate-400 py-10">No workouts logged yet</p>' :
                state.workoutHistory.map(w => `
                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold">${w.focus}</h4>
                                <p class="text-xs text-slate-400">${w.date} ‚Ä¢ ${w.duration}</p>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500">
                            ${w.exercises.length} exercises ‚Ä¢ ${w.exercises.reduce((sum, e) => sum + e.sets.length, 0)} total sets
                        </div>
                    </div>
                `).join('');
            document.getElementById('training-logs-list').innerHTML = trainingHtml;

            // Nutrition logs
            const nutritionHtml = state.nutritionHistory.length === 0 ?
                '<p class="text-center text-slate-400 py-10">No nutrition logs yet</p>' :
                state.nutritionHistory.map(n => `
                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold">${n.date}</h4>
                                <p class="text-xs text-slate-400">${n.meals?.length || 0} items logged</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">${Math.round(n.calories)} kcal</p>
                                <p class="text-xs text-blue-600">${n.protein.toFixed(1)}g protein</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            document.getElementById('nutrition-logs-list').innerHTML = nutritionHtml;
        }

        // ============================================================================
        // BODY METRICS
        // ============================================================================

        function triggerPhotoUpload(type) {
            currentPhotoType = type;
            document.getElementById('photo-upload-input').click();
        }

        document.getElementById('photo-upload-input')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                    state.currentPhotos[currentPhotoType] = compressedImage;

                    // Show preview
                    const preview = document.getElementById(`photo-${currentPhotoType}-preview`);
                    preview.src = compressedImage;
                    preview.classList.remove('hidden');

                    showToast(`${currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1)} photo added`);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function saveMetrics() {
            const weight = parseFloat(document.getElementById('metric-weight').value);
            if (!weight) {
                showToast('Please enter weight');
                return;
            }

            state.metricsHistory.unshift({
                id: Date.now(),
                date: state.viewDate,
                weight,
                chest: parseFloat(document.getElementById('metric-chest').value) || 0,
                shoulders: parseFloat(document.getElementById('metric-shoulders').value) || 0,
                arms: parseFloat(document.getElementById('metric-arms').value) || 0,
                waist: parseFloat(document.getElementById('metric-waist').value) || 0,
                legs: parseFloat(document.getElementById('metric-legs').value) || 0,
                glutes: parseFloat(document.getElementById('metric-glutes').value) || 0,
                photos: {
                    front: state.currentPhotos.front,
                    side: state.currentPhotos.side,
                    back: state.currentPhotos.back
                }
            });

            saveState();
            renderDashboard();
            renderMetricChart();
            populateComparisonDates();
            showToast('Metrics saved!');
            
            // Clear inputs and photos
            ['weight', 'chest', 'shoulders', 'arms', 'waist', 'legs', 'glutes'].forEach(m => {
                document.getElementById(`metric-${m}`).value = '';
            });
            
            state.currentPhotos = { front: null, side: null, back: null };
            ['front', 'side', 'back'].forEach(type => {
                document.getElementById(`photo-${type}-preview`).classList.add('hidden');
            });
        }

        function populateComparisonDates() {
            const dates = state.metricsHistory
                .filter(m => m.photos && (m.photos.front || m.photos.side || m.photos.back))
                .map(m => ({ date: m.date, id: m.id }));

            const html = '<option value="">Select date...</option>' + dates.map(d => 
                `<option value="${d.id}">${d.date}</option>`
            ).join('');

            document.getElementById('compare-date-1').innerHTML = html;
            document.getElementById('compare-date-2').innerHTML = html;
        }

        let currentComparePhotoType = 'front';

        function setComparePhotoType(type) {
            currentComparePhotoType = type;
            ['front', 'side', 'back'].forEach(t => {
                const btn = document.getElementById(`compare-type-${t}`);
                if (t === type) {
                    btn.className = 'p-4 rounded-2xl font-bold text-sm bg-indigo-600 text-white';
                } else {
                    btn.className = 'p-4 rounded-2xl font-bold text-sm bg-slate-100 text-slate-600';
                }
            });
            loadComparisonPhotos();
        }

        function loadComparisonPhotos() {
            const id1 = document.getElementById('compare-date-1').value;
            const id2 = document.getElementById('compare-date-2').value;

            if (!id1 || !id2) {
                document.getElementById('comparison-view').classList.add('hidden');
                document.getElementById('no-comparison-message').classList.remove('hidden');
                return;
            }

            const metric1 = state.metricsHistory.find(m => m.id == id1);
            const metric2 = state.metricsHistory.find(m => m.id == id2);

            if (!metric1 || !metric2) return;

            const photo1 = metric1.photos?.[currentComparePhotoType];
            const photo2 = metric2.photos?.[currentComparePhotoType];

            if (photo1 && photo2) {
                document.getElementById('compare-img-1').src = photo1;
                document.getElementById('compare-img-2').src = photo2;
                document.getElementById('compare-label-1').textContent = metric1.date;
                document.getElementById('compare-label-2').textContent = metric2.date;
                document.getElementById('comparison-view').classList.remove('hidden');
                document.getElementById('no-comparison-message').classList.add('hidden');
                lucide.createIcons();
            } else {
                document.getElementById('comparison-view').classList.add('hidden');
                document.getElementById('no-comparison-message').classList.remove('hidden');
                showToast('Photos not available for selected dates');
            }
        }

        function openMetricsChart() {
            document.getElementById('metrics-chart-modal').style.display = 'flex';
            setTimeout(() => renderMetricChart(), 100); // Ensure canvas is visible
            lucide.createIcons();
        }

        function closeMetricsChart() {
            document.getElementById('metrics-chart-modal').style.display = 'none';
        }

        function openPhotoComparison() {
            populateComparisonDates();
            currentComparePhotoType = 'front';
            setComparePhotoType('front');
            document.getElementById('photo-comparison-modal').style.display = 'flex';
            document.getElementById('comparison-view').classList.add('hidden');
            document.getElementById('no-comparison-message').classList.remove('hidden');
            lucide.createIcons();
        }

        function closePhotoComparison() {
            document.getElementById('photo-comparison-modal').style.display = 'none';
        }

        function renderMetricChart() {
            const metric = document.getElementById('chart-metric-select')?.value || 'weight';
            const history = [...state.metricsHistory].reverse();
            
            const labels = history.map(m => new Date(m.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }));
            const data = history.map(m => m[metric]);

            if (metricsChart) metricsChart.destroy();

            const ctx = document.getElementById('metrics-chart');
            if (!ctx) return;

            metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: metric.charAt(0).toUpperCase() + metric.slice(1),
                        data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // ============================================================================
        // SETTINGS
        // ============================================================================

        function updateCalorieGoal(value) {
            state.goals.calories = Number(value);
            saveState();
            renderDashboard();
            showToast('Goal updated');
        }

        function renderSettings() {
            document.getElementById('calorie-goal-input').value = state.goals.calories;

            // Gym equipment
            const gymHtml = Object.keys(state.equipment.gym).map(eq => `
                <button onclick="toggleEquipment('gym', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase ${state.equipment.gym[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}">
                    ${eq}
                </button>
            `).join('');
            document.getElementById('gym-equipment-list').innerHTML = gymHtml;

            // Home equipment
            const homeHtml = Object.keys(state.equipment.home).map(eq => `
                <button onclick="toggleEquipment('home', '${eq}')" class="p-3 rounded-xl text-[10px] font-bold uppercase ${state.equipment.home[eq] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600'}">
                    ${eq}
                </button>
            `).join('');
            document.getElementById('home-equipment-list').innerHTML = homeHtml;

            // Habits
            document.getElementById('habits-enabled').checked = state.habitsEnabled;
            document.getElementById('habits-section').classList.toggle('hidden', !state.habitsEnabled);
            document.getElementById('habits-tracker').classList.toggle('hidden', !state.habitsEnabled);
            if (state.habitsEnabled) {
                renderHabitsSettings();
                renderDashboardHabits();
            }
            
            // Tracking toggles
            document.getElementById('track-hydration').checked = state.trackHydration !== false;
            document.getElementById('track-steps').checked = state.trackSteps !== false;
            
            // Goals
            renderGoals();
        }

        function toggleEquipment(env, equipment) {
            state.equipment[env][equipment] = !state.equipment[env][equipment];
            saveState();
            renderSettings();
        }

        // ============================================================================
        // HABITS
        // ============================================================================

        function toggleHabits() {
            state.habitsEnabled = document.getElementById('habits-enabled').checked;
            document.getElementById('habits-section').classList.toggle('hidden', !state.habitsEnabled);
            document.getElementById('habits-tracker').classList.toggle('hidden', !state.habitsEnabled);
            saveState();
            if (state.habitsEnabled) {
                renderHabitsSettings();
                renderDashboardHabits();
            }
        }

        function addHabit() {
            const input = document.getElementById('new-habit-input');
            const habitName = input.value.trim();
            if (!habitName) return;
            
            state.habits.push({
                id: Date.now(),
                name: habitName
            });
            
            input.value = '';
            saveState();
            renderHabitsSettings();
            renderDashboardHabits();
            showToast('Habit added!');
        }

        function removeHabit(id) {
            state.habits = state.habits.filter(h => h.id !== id);
            saveState();
            renderHabitsSettings();
            renderDashboardHabits();
        }

        function renderHabitsSettings() {
            const html = state.habits.map(habit => `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                    <span class="font-medium text-sm">${habit.name}</span>
                    <button onclick="removeHabit(${habit.id})" class="text-red-500 hover:bg-red-50 rounded-lg p-2">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            document.getElementById('habits-list').innerHTML = html || '<p class="text-xs text-slate-400 italic text-center py-4">No habits added yet</p>';
            lucide.createIcons();
        }

        function toggleHabitCompletion(habitId) {
            const today = state.viewDate;
            if (!state.habitCompletions[today]) {
                state.habitCompletions[today] = {};
            }
            state.habitCompletions[today][habitId] = !state.habitCompletions[today][habitId];
            saveState();
            renderDashboardHabits();
        }

        function renderDashboardHabits() {
            const today = state.viewDate;
            const completions = state.habitCompletions[today] || {};
            
            const html = state.habits.map(habit => {
                const isComplete = completions[habit.id] || false;
                return `
                    <div class="flex items-center gap-3 p-4 bg-white rounded-xl border-2 ${isComplete ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100'} transition-all">
                        <button onclick="toggleHabitCompletion(${habit.id})" class="w-7 h-7 rounded-lg ${isComplete ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-300'} flex items-center justify-center transition-all">
                            <i data-lucide="${isComplete ? 'check' : 'circle'}" class="w-4 h-4"></i>
                        </button>
                        <span class="flex-1 font-medium text-sm ${isComplete ? 'text-emerald-900 line-through' : 'text-slate-900'}">${habit.name}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dashboard-habits-list').innerHTML = html || '<p class="text-xs text-slate-400 italic text-center py-4">No habits to track today</p>';
            lucide.createIcons();
        }

        // ============================================================================
        // SIDEBAR MENU
        // ============================================================================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('translate-x-0');
            
            if (isOpen) {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.add('translate-x-0');
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        // ============================================================================
        // GOAL SETTING
        // ============================================================================

        function openGoalSetting() {
            document.getElementById('goal-modal').style.display = 'flex';
            document.getElementById('goal-description').value = '';
            document.getElementById('goal-deadline').value = '';
            lucide.createIcons();
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').style.display = 'none';
        }

        function saveGoal() {
            const type = document.getElementById('goal-type').value;
            const description = document.getElementById('goal-description').value.trim();
            const deadline = document.getElementById('goal-deadline').value;
            
            if (!description || !deadline) {
                showToast('Please fill all fields');
                return;
            }
            
            state.goals.push({
                id: Date.now(),
                type,
                description,
                deadline,
                completed: false,
                createdAt: new Date().toISOString()
            });
            
            saveState();
            closeGoalModal();
            renderGoals();
            showToast('Goal added!');
        }

        function renderGoals() {
            const html = state.goals.filter(g => !g.completed).map(goal => {
                const typeColors = {
                    short: 'bg-green-100 text-green-700',
                    medium: 'bg-yellow-100 text-yellow-700',
                    long: 'bg-purple-100 text-purple-700'
                };
                const typeLabels = {
                    short: 'Short-term',
                    medium: 'Medium-term',
                    long: 'Long-term'
                };
                
                return `
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                        <div class="flex-1">
                            <span class="text-[9px] font-black ${typeColors[goal.type]} px-2 py-1 rounded uppercase">${typeLabels[goal.type]}</span>
                            <p class="font-bold text-sm mt-2">${goal.description}</p>
                            <p class="text-xs text-slate-400 mt-1">Due: ${new Date(goal.deadline).toLocaleDateString()}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="completeGoal(${goal.id})" class="w-8 h-8 bg-green-50 text-green-600 rounded-lg hover:bg-green-100">
                                <i data-lucide="check" class="w-4 h-4 mx-auto"></i>
                            </button>
                            <button onclick="deleteGoal(${goal.id})" class="w-8 h-8 bg-red-50 text-red-600 rounded-lg hover:bg-red-100">
                                <i data-lucide="x" class="w-4 h-4 mx-auto"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('goals-list').innerHTML = html || '<p class="text-xs text-slate-400 text-center py-4">No active goals</p>';
            lucide.createIcons();
        }

        function completeGoal(id) {
            const goal = state.goals.find(g => g.id === id);
            if (goal) {
                goal.completed = true;
                saveState();
                renderGoals();
                showToast('Goal completed! üéâ');
            }
        }

        function deleteGoal(id) {
            state.goals = state.goals.filter(g => g.id !== id);
            saveState();
            renderGoals();
        }

        // ============================================================================
        // CARDIO LOGGING
        // ============================================================================

        function openCardioModal() {
            document.getElementById('cardio-modal').style.display = 'flex';
            document.getElementById('cardio-duration').value = '';
            document.getElementById('cardio-distance').value = '';
            document.getElementById('cardio-calories').value = '';
            document.getElementById('cardio-notes').value = '';
            lucide.createIcons();
        }

        function closeCardioModal() {
            document.getElementById('cardio-modal').style.display = 'none';
        }

        function saveCardio() {
            const type = document.getElementById('cardio-type').value;
            const duration = parseFloat(document.getElementById('cardio-duration').value);
            const distance = parseFloat(document.getElementById('cardio-distance').value) || 0;
            const calories = parseFloat(document.getElementById('cardio-calories').value) || 0;
            const notes = document.getElementById('cardio-notes').value.trim();
            const workoutDate = window.selectedWorkoutDate || document.getElementById('workout-date-picker').value || new Date().toISOString().split('T')[0];
            
            if (!duration) {
                showToast('Please enter duration');
                return;
            }
            
            const cardioActivity = {
                id: Date.now(),
                date: workoutDate,
                type,
                duration,
                distance,
                calories,
                notes,
                category: 'cardio'
            };
            
            state.cardioLogs.push(cardioActivity);
            
            // Also add to workout history
            state.workoutHistory.unshift({
                id: Date.now(),
                date: workoutDate,
                focus: `${type.charAt(0).toUpperCase() + type.slice(1)} Cardio`,
                duration: `${duration} min`,
                exercises: [{
                    name: `${type.charAt(0).toUpperCase() + type.slice(1)}`,
                    sets: [{reps: duration, weight: distance}]
                }],
                category: 'cardio',
                cardioData: cardioActivity
            });
            
            saveState();
            closeCardioModal();
            renderDashboard();
            showToast('Cardio activity logged!');
        }

        // ============================================================================
        // TRACKING TOGGLES
        // ============================================================================

        function toggleTracking(type) {
            if (type === 'hydration') {
                state.trackHydration = document.getElementById('track-hydration').checked;
                document.getElementById('hydration-tracker')?.classList.toggle('hidden', !state.trackHydration);
            } else if (type === 'steps') {
                state.trackSteps = document.getElementById('track-steps').checked;
                document.getElementById('steps-tracker')?.classList.toggle('hidden', !state.trackSteps);
            }
            saveState();
            renderDashboard();
        }

        // ============================================================================
        // WORKOUT FILTERING
        // ============================================================================

        function filterWorkouts() {
            const showWeights = document.getElementById('filter-weights').checked;
            const showCardio = document.getElementById('filter-cardio').checked;
            const showCore = document.getElementById('filter-core').checked;
            const showWalking = document.getElementById('filter-walking').checked;
            
            renderTrainingLogs(showWeights, showCardio, showCore, showWalking);
        }

        function renderTrainingLogs(showWeights = true, showCardio = true, showCore = true, showWalking = true) {
            const filteredWorkouts = state.workoutHistory.filter(workout => {
                const category = workout.category || 'weights';
                const focus = (workout.focus || '').toLowerCase();
                
                if (category === 'cardio') {
                    const isWalking = (workout.cardioData?.type || focus).includes('walk');
                    return isWalking ? showWalking : showCardio;
                }
                if (focus.includes('core')) return showCore;
                return showWeights;
            });
            
            const html = filteredWorkouts.map(w => `
                <div class="glass-card p-6 rounded-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs text-slate-400">${w.date}</p>
                            <h4 class="font-black text-lg">${w.focus}</h4>
                            ${w.cardioData ? `
                                <p class="text-sm text-indigo-600 mt-1">
                                    ${w.cardioData.distance}km ‚Ä¢ ${w.cardioData.duration}min
                                    ${w.cardioData.calories ? ` ‚Ä¢ ${w.cardioData.calories}kcal` : ''}
                                </p>
                            ` : `<p class="text-sm text-slate-500">${w.exercises.length} exercises ‚Ä¢ ${w.duration}</p>`}
                        </div>
                    </div>
                    ${w.cardioData && w.cardioData.notes ? `<p class="text-xs text-slate-500 mt-2">${w.cardioData.notes}</p>` : ''}
                </div>
            `).join('');
            
            document.getElementById('training-logs-list').innerHTML = html || '<p class="text-center text-slate-400 py-8">No workouts logged</p>';
            lucide.createIcons();
        }

        // ============================================================================
        // HYDRATION & STEPS LOGGING
        // ============================================================================

        function logWaterToHistory() {
            const date = state.viewDate;
            const amount = state.waterLogs[date] || 0;
            
            if (!state.hydrationLogs[date]) {
                state.hydrationLogs[date] = amount;
                saveState();
            }
        }

        function logStepsToHistory() {
            const date = state.viewDate;
            const steps = state.stepsLogs[date] || 0;
            
            if (steps > 0) {
                saveState();
            }
        }

        function renderHydrationLogs() {
            const logs = Object.entries(state.hydrationLogs)
                .sort(([a], [b]) => b.localeCompare(a))
                .slice(0, 30);
            
            const html = logs.map(([date, ml]) => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                    <span class="text-sm font-bold">${new Date(date).toLocaleDateString()}</span>
                    <span class="text-sm text-cyan-600 font-bold">${ml}ml</span>
                </div>
            `).join('');
            
            document.getElementById('hydration-logs-list').innerHTML = html || '<p class="text-xs text-slate-400 text-center py-4">No hydration logs</p>';
        }

        // ============================================================================
        // EXERCISE CHECKBOXES FOR SPECIFIC MUSCLES
        // ============================================================================

        function toggleSpecificMuscle() {
            const focus = document.getElementById('workout-focus').value;
            const container = document.getElementById('specific-muscle-container');
            
            if (focus === 'Specific Muscle') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // Update AI workout generation to use muscle-specific exercises with checkboxes
        const MUSCLE_EXERCISES = {
            'Chest': ['Barbell Bench Press', 'Incline Dumbbell Press', 'Cable Flyes', 'Push-ups', 'Dips', 'Decline Press'],
            'Back': ['Pull-ups', 'Barbell Rows', 'Lat Pulldown', 'T-Bar Rows', 'Cable Rows', 'Deadlifts'],
            'Shoulders': ['Overhead Press', 'Lateral Raises', 'Front Raises', 'Face Pulls', 'Arnold Press', 'Upright Rows'],
            'Biceps': ['Barbell Curls', 'Hammer Curls', 'Preacher Curls', 'Cable Curls', 'Concentration Curls'],
            'Triceps': ['Tricep Dips', 'Skull Crushers', 'Cable Pushdowns', 'Overhead Extension', 'Close Grip Press'],
            'Quads': ['Squats', 'Leg Press', 'Lunges', 'Leg Extensions', 'Bulgarian Split Squats'],
            'Hamstrings': ['Romanian Deadlifts', 'Leg Curls', 'Nordic Curls', 'Good Mornings'],
            'Glutes': ['Hip Thrusts', 'Glute Bridges', 'Cable Kickbacks', 'Bulgarian Split Squats'],
            'Calves': ['Standing Calf Raises', 'Seated Calf Raises', 'Jump Rope']
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            
            document.getElementById('status-date').innerText = new Date().toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });

            // Set default store value
            const storeInput = document.getElementById('store-search-input');
            if (storeInput) storeInput.value = 'All Stores & Restaurants';

            // Initialize date pickers to today
            const today = new Date().toISOString().split('T')[0];
            const nutritionDatePicker = document.getElementById('nutrition-date-picker');
            const workoutDatePicker = document.getElementById('workout-date-picker');
            if (nutritionDatePicker) nutritionDatePicker.value = today;
            if (workoutDatePicker) workoutDatePicker.value = today;
            window.selectedWorkoutDate = today;

            renderDashboard();
            renderDiary();
            renderSettings();
            setupMidnightSave();
            
            lucide.createIcons();
            showToast('Welcome to FitTrack Pro! üí™');
        });
    </script>
</body>
</html>

